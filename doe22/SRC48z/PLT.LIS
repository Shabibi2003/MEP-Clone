c ####################### SPLIT PLT INTO PLT1&2 HERE ###########################Split0   2
      SUBROUTINE PLANT                                                          PLANT    2
c                                                                               PLANT    3
c                                                                               PLANT    4
c              ***************************************************              PLANT    5
c              *                                                 *              PLANT    6
c              *                  PLANT PROGRAM                  *              PLANT    7
c              *                                                 *              PLANT    8
c              ***************************************************              PLANT    9
c                                                                               PLANT   10
c                 DOE-2.2 Program for Building Energy Analysis                  PLANT   11
c                                                                               PLANT   12
c              Determines the loads on all the loops at the                     PLANT   13
c              end of the hour, and simulates the primary                       PLANT   14
c              plant equipment.                                                 PLANT   15
c                                                                               PLANT   16
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /COGENn/ CogenMode, CogenIterateIndex, TrackMode,                 /COGEN/  2
     &                 QCogenWaste                                              /COGEN/  3
      INTEGER          CogenMode, CogenIterateIndex, TrackMode                  /COGEN/  4
      COMMON  /DESHRQ/ NDESDY, IDDTYP(2), DESHRQ(360)                           Time     1
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /LOOP  / Nloop(16,2), NextType(40), NLP2,                         -41a     1
     &                 WLHPoff, RealCall, RegenFlag, Sim2x, LoopSimCount        ChlrHP   2
      LOGICAL          WLHPoff, RealCall, RegenFlag, Sim2x                      ChlrHP   3
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PTRSYS/ nzone , iz    , nczd  , zp2 ,         mtw  ,             -045a    1
     $                 nsys  , is    , nss   , nsp ,  ns   , icode,             HR      11
     $                 nsz   , isz   , nzd   , zp1 ,  nz   ,                    HR      12
     $                 nspace, lpr   ,                                          HR      13
     $                 nattch, iatt  ,                                          HR      14
     $                 P2, IDAYHR, IDBWBT,                                      HR      15
     $                 IRPPLT, IRPSUM, IRPSYS, IRPZON, MR1, MR2                 HR      16
      INTEGER          ZP1, ZP2, P2                                             /PTRSYS/14
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
      COMMON  /ZEROP/  LpmHR,LlpHR,LchHR,LblHR,LdwHR,LtwHR,LpvHR,LgnHR,         PV       5
     &                 LtkHR,LhxHR,LecHR,LlmHR,LemHR,LfmHR,LsmHR,LcmHR,         /ZEROP/  3
     &                 LglHR,LpeHR,                                             /ZEROP/  4
     &                 LpmMO,LlpMO,LchMO,LblMO,LdwMO,LtwMO,LpvMO,LgnMO,         PV       6
     &                 LtkMO,LhxMO,LecMO,LlmMO,LemMO,LfmMO,LsmMO,LcmMO,         /ZEROP/  6
     &                 LglMO,LpeMO,                                             /ZEROP/  7
     &                 LpmYR,LlpYR,LchYR,LblYR,LdwYR,LtwYR,LpvYR,LgnYR,         PV       7
     &                 LtkYR,LhxYR,LecYR,LlmYR,LemYR,LfmYR,LsmYR,LcmYR,         /ZEROP/  9
     &                 LglYR,LpeYR                                              /ZEROP/ 10
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
c                                                                               PLANT   32
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /SimAlg/ Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/ 2
     &                 Electrical,                                              /SIMALG/ 3
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/ 4
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/ 5
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   2
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/ 7
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/ 8
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/ 9
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/10
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    3
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    4
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    5
     &                 Ground_LoopVert_H2,Ground_LoopHoriz_H,                   -044d    6
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/14
      INTEGER          Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/15
     &                 Electrical,                                              /SIMALG/16
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/17
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/18
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   3
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/20
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/21
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/22
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/23
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    7
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    8
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    9
     &                 Ground_LoopVert_H2, Ground_LoopHoriz_H,                  -044d   10
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/27
c                                                                               PLANT   35
c              The air-side SYSTEMS module interfaces with this water-side      PLANT   36
c              PLANT module as follows:                                         PLANT   37
c              1.  READSS calls ReadPlant twice, once to read the               PLANT   38
c                  standard file, and a second time to set up the               PLANT   39
c                  attachment pointers.                                         PLANT   40
c              2.  DESIGN calls PLANTdes to do the design calculations          PLANT   41
c                  for all loops and associated primary equipment.              PLANT   42
c              3.  READSS calls PlantReports to set up the reports and          PLANT   43
c                  write the initial records, including design information.     PLANT   44
c              4.  DAYCLS calls PLANTi at the beginning of each hour            PLANT   45
c                  to set up the loop operating schedules.                      PLANT   46
c                  PLANTi may in turn set variables to restrict the             PLANT   47
c                  airside coil capacities if it determines a loop              PLANT   48
c                  is overloaded.                                               PLANT   49
c              5.  DAYCLS calls PLANT (this routine) at the end of the          PLANT   50
c                  hour to simulate all loops.                                  PLANT   51
c              6.  DAYCLS calls PlantStatistics at the end of the hour          PLANT   52
c                  to compile hourly data into monthly statistics.              PLANT   53
c              7.  SYSTEM calls PlantStatistics at the end of each month to     PLANT   54
c                  compile monthly data into yearly data.  PlantStatistics      PLANT   55
c                  then calls PlantReports to write the monthly records.        PLANT   56
c              8.  SYSTEM calls PlantStatistics at the end of the run to        PLANT   57
c                  finalize the yearly data.  PlantStatistics then calls        PLANT   58
c                  PlantReports to write the yearly records and to close        PLANT   59
c                  each report.                                                 PLANT   60
c                                                                               PLANT   61
c                                                                               PLANT   62
c              The hourly loop calculations are as follows:                     PLANT   63
c              1.  Zero hourly variables for all loops and pumps                PLANT   64
c                  and initialize temperature limits for resets                 PLANT   65
c              2.  Get all coil loads for all loops, as well as worst case      PLANT   66
c                  coil temperature requirement for reset (LoopCoilLoad)        PLANT   67
c              3.  Get all process and auxiliary loads for all loops            PLANT   68
c              4.  Simulate each primary loop and its attached                  PLANT   69
c                  secondary loops (LoopSim) to determine whether the           PLANT   70
c                  loop is running, the temperature setpoint, the coil          PLANT   71
c                  flows (LoopCoilFlow), pumping energy (secondary loops),      PLANT   72
c                  thermal losses, and net loop loads.                          PLANT   73
c              5.  Simulate primary equipment and pump(s) for each primary      PLANT   74
c                  loop (PrimaryEquip).                                         PLANT   75
c                                                                               PLANT   76
c              Loop thermal gains and losses are calculated in TEMDEV for all   PLANT   77
c              zones containing loop piping.  Since loop temperatures and flows PLANT   78
c              are not known at the beginning of the hour, and TEMDEV is called PLANT   79
c              prior to simulating the loops, the previous hours loop values    PLANT   80
c              are used.  For the startup hour, the temperature and flow        PLANT   81
c              calculated for the previous startup hour are used.               PLANT   82
c                                                                               PLANT   83
c              The calculation sequence requires that multiple passes be made   PLANT   84
c              thru all loops, and HOURLY-REPORT variables calculated at        PLANT   85
c              one point may not be known later on.  For this reason, the       PLANT   86
c              hourly report buffer routine (HourRepPlt) is called multiple     PLANT   87
c              times, but, in calls subsequent to the first, will only replace  PLANT   88
c              non-zero variables.  Non-zero variables are presumed to have     PLANT   89
c              just been calculated for the first time, or have been            PLANT   90
c              recalculated since the last pass.  Note that the common          PLANT   91
c              blocks which feed the HOURLY-REPORTs are always zeroed           PLANT   92
c              using the length specified in the IVTLIM(2,x) variable.          PLANT   93
c              If additional variables are added to a common block, the         PLANT   94
c              length must be changed in ReadPlant.  Note also that the         PLANT   95
c              pointer to the hourly report buffer IVTLIM(3,x) is               PLANT   96
c              automatically detected by the program so that it is no           PLANT   97
c              longer position dependent.  (This is not currently true          PLANT   98
c              in the other modules.)                                           PLANT   99
c                                                                               PLANT  100
c              The PLANT module is designed to store all hourly data in         PLANT  101
c              EDTT variables so that multiple hourly iterations can be         PLANT  102
c              made without having to adjust any report variables.  The         PLANT  103
c              PlantStatistics routine is called at the very end of the         PLANT  104
c              hour once the simulation is complete, and compiles the EDTT      PLANT  105
c              variables into the reports.  For this reason, no report          PLANT  106
c              variables should be compiled anywhere else in this module,       PLANT  107
c              or else iterations will not be possible.                         PLANT  108
c                                                                               PLANT  109
c              The EDTT variables for each component are arranged in the        PLANT  110
c              following order.  When adding new variables, the                 PLANT  111
c              variables MUST be grouped with variables of the same type,       PLANT  112
c              or the EDTT table will become a mess and the hourly/monthly      PLANT  113
c              zeroing will not work as designed:                               PLANT  114
c              1.  Keyword variables                                            PLANT  115
c              2.  Design variables - the start and end of these variables      PLANT  116
c                  is clearly marked in the table.                              PLANT  117
c              3.  Hourly variables that must be zeroed hourly.  The start      PLANT  118
c                  and end of these variables is clearly marked.  As long as    PLANT  119
c                  new variables which must be zeroed hourly are placed         PLANT  120
c                  within these markers, the program will automatically         PLANT  121
c                  adjust to accommodate them.                                  PLANT  122
c              4.  Hourly variables that should not be zeroed hourly            PLANT  123
c              5.  Monthly variables that must be zeroed monthly.  As           PLANT  124
c                  with hourly variables, the program will automatically        PLANT  125
c                  detect new variables added within the monthly markers.       PLANT  126
c                  Currently, all monthly variables are zeroed monthly          PLANT  127
c              6.  Monthly variables that should not be zeroed monthly.         PLANT  128
c                  Curently unused.                                             PLANT  129
c              7.  Yearly variables that should be zeroed yearly.               PLANT  130
c              8.  Yearly variables that should not be zeroed.                  PLANT  131
c                  Currently unused.                                            PLANT  132
c                                                                               PLANT  133
c              Please follow the following conventions when naming EDTT         PLANT  134
c              variables:                                                       PLANT  135
c              1.  Use the same prefix as the rest of the variables in          PLANT  136
c                  the same component (lp:, ch:, etc).  This allows every       PLANT  137
c                  component variable to be readily identified.                 PLANT  138
c              2.  KEYWORDS have a colon after the component identifier,        PLANT  139
c                  whereas simulation variables use a semi-colon                PLANT  140
c                  (lp:XXXXX is a loop keyword, whereas lp;XXXXX is a           PLANT  141
c                  loop simulation variable)  Also, words in KEYWORDS           PLANT  142
c                  are usually separated by dashes, whereas words in            PLANT  143
c                  SIMULATION variables are separated by underlines.  For       PLANT  144
c                  example, lp:HT-SETPT-T is a keyword whose value never        PLANT  145
c                  changes, while lp;HT_SETPT is an hourly simulation           PLANT  146
c                  variable whose value may change hourly.                      PLANT  147
c                                                                               PLANT  148
c              SimCtrl =  0  Beginning of run attachment calculations           PLANT  149
c                         1  Design calculations                                PLANT  150
c                        10  Hourly initialization                              PLANT  151
c                        11  Hourly equipment operating capacities              PLANT  152
c                     12-18  Hourly simulation                                  PLANT  153
c                        19  Hourly statistics                                  PLANT  154
c                        20  Monthly initialization                             PLANT  155
c                        29  Monthly statistics                                 PLANT  156
c                        30  Yearly initialization                              PLANT  157
c                        39  Yearly statistics                                  PLANT  158
c                                                                               PLANT  159
c                                                                               ChlrHP   6
c              Re-entry point if loops must be simulated twice                  ChlrHP   7
      LoopSimCount = 0                                                          ChlrHP   8
 100  LoopSimCount = LoopSimCount + 1                                           ChlrHP   9
c              Beginning of hour zeroing of hourly EDTT data for loops          PLANT  160
c              and pumps                                                        PLANT  161
      SimCtrl = 10                                                              PLANT  162
      DO  NL=1,Nlp                                                              PLANT  163
        Jlp = Ilp + (NL-1)*Llp                                                  PLANT  164
        LoopType = <lp:TYPE>                                                    PLANT  165
c              skip if this loop not used                                       PLANT  166
        IF (LoopType .EQ. Deleted)  CYCLE                                       PLANT  167
        CALL FILLN(0., <=HRBJlp>, LlpHR)                                        PLANT  168
c              Reset the control mode to be as originally set in PLANTi         ChlrHP  10
        <lp;CTRL_MODE> = <lp;SCH_MODE>                                          ChlrHP  11
c              initial hot water loop temperature                               PLANT  169
        IF (<lp;CTRL_MODE> .EQ. HEATMODE)  THEN                                 PLANT  170
          <lp;COIL_EWT> = <lp:MIN-RESET-T>                                      PLANT  171
c              initial chilled water loop temperature                           PLANT  172
        ELSEIF (<lp;CTRL_MODE> .EQ. COOLMODE  .AND.                             PLANT  173
     &          LoopType .NE. CW  .AND.  LoopType .NE. WLHP)  THEN              PLANT  174
          <lp;COIL_EWT> = <lp:MAX-RESET-T>                                      PLANT  175
        ENDIF                                                                   PLANT  176
      ENDDO                                                                     PLANT  177
      WLHPoff = .FALSE.                                                         PLANT  178
c                                                                               PLANT  179
c              Initialize all pumps                                             PLANT  180
      DO  Neq=1,Npm                                                             PLANT  181
        Jpm = Ipm + (Neq-1)*Lpm                                                 PLANT  182
        CALL FILLN(0., <=HRBJpm>, LpmHR)                                        PLANT  183
        IF (IRSCH .NE. 0  .AND.  <pm;HREP> .NE. 0)                              PLANT  184
     &    CALL FILLN(0., AA(<pm;HREP>), IVTLIM(2,15))                           PLANT  185
      ENDDO                                                                     PLANT  186
c                                                                               PLANT  187
c              if desiccant regeneration loads                                  PLANT  188
      IF (RegenFlag)  THEN                                                      PLANT  189
        DO  Neq=1,Nch                                                           PLANT  190
          Jch = Ich + (Neq-1)*Lch                                               PLANT  191
c              average regeneration temperature for all desiccant systems       PLANT  192
c              attached to this chiller/heater                                  PLANT  193
          IF (<ch;DESC_CFM> .GT. 0.)                                            PLANT  194
     &      <ch;DESC_T> = <ch;DESC_T> / <ch;DESC_CFM>                           PLANT  195
        ENDDO                                                                   PLANT  196
      ENDIF                                                                     PLANT  197
c                                                                               PLANT  198
c                                                                               PLANT  199
c============= GET COIL LOADS ON ALL LOOPS ==================================== PLANT  200
c              Loop through systems and zones and get loop loads, and           PLANT  201
c              determine temperature required by worst case hot and             PLANT  202
c              chilled water coils                                              PLANT  203
      Call LoopCoilLoad                                                         PLANT  204
c                                                                               PLANT  205
c                                                                               PLANT  206
c============= GET THERMAL LOSSES, PROCESS AND AUXILIARY LOADS ================ PLANT  207
      DO  NL=1,Nlp                                                              PLANT  208
c              pointer to loop data                                             PLANT  209
        Jlp = Ilp + (NL-1)*Llp                                                  PLANT  210
        LoopType = <lp:TYPE>                                                    PLANT  211
        IF (LoopType .EQ. Deleted)  CYCLE                                       PLANT  212
        LoopCtrl = <lp;CTRL_MODE>                                               PLANT  213
c                                                                               PLANT  214
c              Retrieve loop losses from the Xface blocks.  Note that           PLANT  215
c              these losses were calculated using last hour's fluid flow        PLANT  216
c              and temperatures.  Zonal losses were already calc'd in           PLANT  217
c              TEMDEV.  Note that, if the loop does not run this hour,          PLANT  218
c              the losses will remain in the loop EDTT variables and            PLANT  219
c              will be used during the next start-up hour.                      PLANT  220
        IF (<lp:LOCN> .GT. 0)  THEN                                             PLANT  221
          IF (<lp:LOCN> .EQ. INDOORS)  THEN                                     PLANT  222
            CALL GetVars4(<lp;SupplyLossPtr>,                                   PLANT  223
     &                 <lp;SUPPLY_LOSS>, xxx, xxx, <lp;SUPPLY_DT>)              PLANT  224
            CALL GetVars4(<lp;ReturnLossPtr>,                                   PLANT  225
     &                 <lp;RETURN_LOSS>, xxx, xxx, <lp;RETURN_DT>)              PLANT  226
          ELSE                                                                  PLANT  227
c              Calculate thermal losses for piping located outdoors             PLANT  228
c              or in a tunnel                                                   PLANT  229
            CALL PipeDT(<lp;SupplyLossPtr>,-77777.,-77777.,-77777., 1,          -035     1
     &                  <lp;SUPPLY_DT>, <lp;SUPPLY_LOSS>, xxx)                  -035     2
            CALL PipeDT(<lp;ReturnLossPtr>,-77777.,-77777.,-77777., 1,          -035     3
     &                  <lp;RETURN_DT>, <lp;RETURN_LOSS>, xxx)                  -035     4
          ENDIF                                                                 PLANT  236
        ENDIF                                                                   PLANT  237
c                                                                               PLANT  238
c              Loop process loads - dhw process was calcd in PLANTi             PLANT  239
        IF (<lp;NumProcess> .GT. 0  .AND.  LoopCtrl .GT. FLOATING)  THEN        Proces   1
          IF (LoopType .NE. DHW)  THEN                                          Proces   2
            <lp;PROCESS_Q>   = 0.                                               Proces   3
            <lp;PROCESS_GPM> = 0.                                               Proces   4
            NumProcess       = <lp;NumProcess>                                  Proces   5
            DO  II=1,NumProcess                                                 Proces   6
              SchV     = SchVal(<lp:PROC-LOAD-SCH>, 1.)                         Proces   7
              IF (SchV .EQ. 0.)  CYCLE                                          Proces   8
              <lp;RUNNING> = <lp;RUNNING> + 1               ! run flag          Proces   9
              Qprocess     = <lp:PROCESS-LOAD> * SchV       ! load              Proces  10
c                 limit process load by available capacity                      Proces  11
              IF (Qprocess .LT. 0.)  THEN                                       Proces  12
                Qprocess = Qprocess * <lp;HCAP_RATIO>                           Proces  13
              ELSE                                                              Proces  14
                Qprocess = Qprocess * <lp;CCAP_RATIO>                           Proces  15
              ENDIF                                                             Proces  16
              <lp;PROCESS_Q>   = <lp;PROCESS_Q> + Qprocess                      Proces  17
              <lp;PROCESS_GPM> = <lp;PROCESS_GPM>           ! flow              Proces  18
     &                         + <lp:PROCESS-GPM>*SchV                          Proces  19
c                 no temperature reset when process load                        Proces  20
              IF (LoopCtrl .EQ. HEATMODE)  THEN                                 Proces  21
                <lp;COIL_EWT> = MAX(<lp;COIL_EWT>, <lp:DESIGN-HEAT-T>)          Chlr1    2
              ELSE                                                              Proces  23
                <lp;COIL_EWT> = MIN(<lp;COIL_EWT>, <lp:DESIGN-COOL-T>)          Chlr1    3
              ENDIF                                                             Proces  25
            ENDDO  ! NumProcess                                                 Proces  26
          ENDIF  ! LoopType                                                     Proces  34
        ENDIF  ! lp;NumProcess                                                  Proces  35
c                                                                               PLANT  275
c              Loop auxiliary electrical loads - note that these do not         PLANT  276
c              show up as a load on the loop                                    PLANT  277
        IF (<lp:AUX-KW> .GT. 0.)                                                Time     9
     &    <lp;AUX_KW> = <lp:AUX-KW> * SchVal(<lp:AUX-SCH>, 1.)                  Time    10
c                                                                               PLANT  287
      ENDDO    ! process, auxiliary, losses                                     PLANT  288
c                                                                               PLANT  289
c                                                                               PLANT  290
c============= GET THERMAL STORAGE LOADS ====================================== PLANT  291
      DO  Neq=1,Ntk                                                             PLANT  292
        Jtk = Itk + (Neq-1)*Ltk                                                 PLANT  293
        Jpe = <tk;Jpe>                                                          PLANT  294
        SELECT CASE (<tk:ALGORITHM>)                                            PLANT  295
        CASE (181)               ! Cold Btu bucket                              PLANT  296
          CALL TES_ColdTank_1(1)                                                PLANT  297
        CASE (281)               ! Hot Btu bucket                               PLANT  298
          CALL TES_HotTank_1(1)                                                 PLANT  299
        END SELECT                                                              PLANT  300
      ENDDO                                                                     PLANT  301
c                                                                               PLANT  302
c                                                                               PLANT  303
c============= SIMULATE EACH PRIMARY LOOP AND ATTACHED SECONDARIES ============ PLANT  304
c              Main loop calcs for temperature and flow - condenser             PLANT  305
c              loops will be simulated after chillers are done                  PLANT  306
      DO NL=1,Nlp                                                               PLANT  307
c              pointer to loop data                                             PLANT  308
        Jlp = Ilp + (NL-1)*Llp                                                  PLANT  309
        IF (<lp:SUBTYPE> .EQ. PRIMARY  .AND.  <lp:TYPE> .NE. Deleted            PLANT  310
     &                         .AND.  <lp:TYPE> .NE. CW)  THEN                  PLANT  311
          CALL LoopSim                                                          PLANT  312
c              save design day load profiles                                    PLANT  313
          IF (IDDFLG .GT. 0)  THEN                                              PLANT  314
            JJ = IDDFLG                                                         PLANT  315
            <lp;DesDayNumbers> = FLOAT(IDOY)                                    PLANT  316
            II = (IDDFLG-1)*24 + IHR                                            PLANT  317
            <lp;DesDayProfile> = <lp;Q_NET>                                     PLANT  318
          ENDIF                                                                 PLANT  319
        ENDIF                                                                   PLANT  320
      ENDDO                                                                     PLANT  321
c                                                                               PLANT  322
c                                                                               PLANT  323
c============= SIMULATE PRIMARY EQUIPMENT ATTACHED TO EACH LOOP =============== PLANT  324
c              Primary plant equipment is simulated in the following order:     PLANT  325
c                 CHW            to satisfy cooling loads, and pass on the      PLANT  326
c                                electric reqt. and recoverable heat            PLANT  327
c                 PIPE2          in cooling mode                                PLANT  328
c                 WLHP           in heat rejection mode                         PLANT  329
c                                  Cogeneration will cause program to           PLANT  330
c                                    make a second pass through starting        PLANT  331
c                                    at this point                              PLANT  332
c                 CW             for heat rejection                             PLANT  333
c                 Cogeneration   to satisfy the electrical loads and            PLANT  334
c                                pass on the recoverable heat                   PLANT  335
c                 HW             to satisfy heating loads, adjusted             PLANT  336
c                                for recovered heat from chillers and cogen     PLANT  337
c                 PIPE2          in heating mode, adjusted for htrec            PLANT  338
c                 WLHP           in heating mode, adjusted for htrec            PLANT  339
c                 DHW            in heating mode, adjusted for htrec            PLANT  340
c                 Cogeneration   to reconcile elec/thermal tracking, and        PLANT  341
c                                  to initiate second pass                      PLANT  342
c                                                                               PLANT  343
c              LoopLoadCheck checks to see if any additional loads have         PLANT  344
c              been placed on a loop since the last call to LoopSim.            PLANT  345
c              For example, an absorption chiller satisfying a cooling          PLANT  346
c              load will place a heating load on a HW loop.  If so, the         PLANT  347
c              HW loop must be resimulated to establish the correct             PLANT  348
c              temperatures and flows.                                          PLANT  349
c                                                                               PLANT  350
c                                                                               PLANT  351
c              Set the EQUIP-CTRL sequences                                     PLANT  352
      CALL LoadManagement(2)                                                    PLANT  353
c                                                                               PLANT  354
c              Initialize the loop type index and cogeneration mode             PLANT  355
      LoopTypeIndex = 0                                                         PLANT  356
      CogenMode     = 0                                                         PLANT  357
c              get next loop type to be simulated                               PLANT  358
  300 LoopTypeIndex = LoopTypeIndex + 1                                         PLANT  359
      IF (IwinReturn .ne. 0)  Return                                            -047k    1
      LoopType      = NextType(LoopTypeIndex)                                   PLANT  360
      SELECT CASE (LoopType)                                                    PLANT  361
        CASE (1,8)             ! CHW and DHW loops                              PLANT  362
          DO NL=1,Nlp                                                           PLANT  363
            Jlp = Ilp + (NL-1)*Llp                                              PLANT  364
            IF (<lp:TYPE> .EQ. LoopType                                         PLANT  365
     &          .AND.  <lp:SUBTYPE> .EQ. PRIMARY)  THEN                         PLANT  366
              CALL FILLN(0., LOOPDAT(1), IVTLIM(2,14))                          PLANT  367
              CALL PrimaryEquip                                                 PLANT  368
            ENDIF                                                               PLANT  369
          ENDDO                                                                 PLANT  370
          GOTO 300                                                              PLANT  371
        CASE (2)             ! 2-pipe loops in cooling mode                     PLANT  372
          DO NL=1,Nlp                                                           PLANT  373
            Jlp = Ilp + (NL-1)*Llp                                              PLANT  374
            IF (<lp:TYPE> .EQ. LoopType                                         PLANT  375
     &                        .AND.  <lp;CTRL_MODE> .NE. HEATMODE               PLANT  376
     &                        .AND.  <lp:SUBTYPE> .EQ. PRIMARY)  THEN           PLANT  377
              CALL FILLN(0., LOOPDAT(1), IVTLIM(2,14))                          PLANT  378
              CALL PrimaryEquip                                                 PLANT  379
            ENDIF                                                               PLANT  380
          ENDDO                                                                 PLANT  381
          GOTO 300                                                              PLANT  382
        CASE (4,6)           ! HW, STM loops                                    PLANT  383
          DO NL=1,Nlp                                                           PLANT  384
            Jlp = Ilp + (NL-1)*Llp                                              PLANT  385
            IF (<lp:TYPE> .EQ. LoopType                                         PLANT  386
     &          .AND.  <lp:SUBTYPE> .EQ. PRIMARY)  THEN                         PLANT  387
              IF (LoopLoadCheck(Jlp) .EQ. 1)  THEN                              PLANT  388
                CALL LoopSim                                                    PLANT  389
              ENDIF                                                             PLANT  390
              CALL FILLN(0., LOOPDAT(1), IVTLIM(2,14))                          PLANT  391
              CALL PrimaryEquip                                                 PLANT  392
            ENDIF                                                               PLANT  393
          ENDDO                                                                 PLANT  394
          GOTO 300                                                              PLANT  395
        CASE (7)             ! WLHP loops in heat rejection mode                PLANT  396
          DO NL=1,Nlp                                                           PLANT  397
            Jlp = Ilp + (NL-1)*Llp                                              PLANT  398
            IF (<lp:TYPE> .EQ. LoopType                                         PLANT  399
     &                        .AND.  <lp:SUBTYPE> .EQ. PRIMARY)  THEN           PLANT  401
              CALL LoopPrimLoads                                                ChlrHP  12
              IF (LoopLoadCheck(Jlp) .EQ. 1)  CALL LoopSim                      PLANT  402
              CALL FILLN(0., LOOPDAT(1), IVTLIM(2,14))                          PLANT  403
              CALL PrimaryEquip                                                 PLANT  404
            ENDIF                                                               PLANT  405
          ENDDO                                                                 PLANT  406
          GOTO 300                                                              PLANT  407
        CASE (9)             ! CW loops                                         PLANT  408
          DO NL=1,Nlp                                                           PLANT  409
            Jlp = Ilp + (NL-1)*Llp                                              PLANT  410
            IF (<lp:TYPE> .EQ. LoopType                                         PLANT  411
     &                        .AND.  <lp:SUBTYPE> .EQ. PRIMARY)  THEN           PLANT  412
              CALL LoopPrimLoads                                                ChlrHP  13
              CALL LoopSim                                                      PLANT  413
              CALL FILLN(0., LOOPDAT(1), IVTLIM(2,14))                          PLANT  414
              CALL PrimaryEquip                                                 PLANT  415
            ENDIF                                                               PLANT  416
          ENDDO                                                                 PLANT  417
          GOTO 300                                                              PLANT  418
        CASE (17)            ! 2-pipe loops in heating mode                     PLANT  419
          DO NL=1,Nlp                                                           PLANT  420
            LoopType = PIPE2                                                    PLANT  421
            Jlp = Ilp + (NL-1)*Llp                                              PLANT  422
            IF (<lp:TYPE> .EQ. LoopType                                         PLANT  423
     &                        .AND.  <lp;CTRL_MODE> .EQ. HEATMODE               PLANT  424
     &                        .AND.  <lp:SUBTYPE> .EQ. PRIMARY)  THEN           PLANT  425
              IF (LoopLoadCheck(Jlp) .EQ. 1)  CALL LoopSim                      PLANT  426
              CALL FILLN(0., LOOPDAT(1), IVTLIM(2,14))                          PLANT  427
              CALL PrimaryEquip                                                 PLANT  428
            ENDIF                                                               PLANT  429
          ENDDO                                                                 PLANT  430
          GOTO 300                                                              PLANT  431
        CASE (18)            ! WLHP loops in heating mode                       PLANT  432
          DO NL=1,Nlp                                                           PLANT  433
            LoopType = WLHP                                                     PLANT  434
            Jlp = Ilp + (NL-1)*Llp                                              PLANT  435
            IF (<lp:TYPE> .EQ. LoopType                                         PLANT  436
     &                        .AND.  <lp:SUBTYPE> .EQ. PRIMARY)  THEN           PLANT  438
              CALL LoopPrimLoads                                                ChlrHP  14
              IF (LoopLoadCheck(Jlp) .EQ. 1)  CALL LoopSim                      PLANT  439
              CALL FILLN(0., LOOPDAT(1), IVTLIM(2,14))                          PLANT  440
              CALL PrimaryEquip                                                 PLANT  441
            ENDIF                                                               PLANT  442
          ENDDO                                                                 PLANT  443
          GOTO 300                                                              PLANT  444
        CASE (19)            ! Cogeneration equipment                           PLANT  445
          CogenMode = CogenMode + 1                                             PLANT  446
          Call Cogeneration(CogenMode)                                          PLANT  447
c              reset the loop type index to iterate again if this               PLANT  448
c              is only the first pass thru all the loops                        PLANT  449
          IF (CogenMode .EQ. 2)  LoopTypeIndex = CogenIterateIndex              PLANT  450
          GOTO 300                                                              PLANT  451
        CASE (20)                                                               -047k    2
c              No more types to be simulated                                    -047k    3
      END SELECT                                                                PLANT  454
c                                                                               ChlrHP  15
c              Check if loops must be simulated twice                           ChlrHP  16
      IF (Sim2x  .AND.  LoopSimCount .LT. 2)  GOTO 100                          ChlrHP  17
c                                                                               PLANT  455
c                                                                               PLANT  456
c============= END OF HOUR RECONCILIATION ===================================== PLANT  457
c              Simulation is finished for all components.  Update               PLANT  458
c              various components with end-of-hour values                       PLANT  459
c                                                                               PLANT  460
c              Thermal storage                                                  PLANT  461
      DO  Neq=1,Ntk                                                             PLANT  462
        Jtk = Itk + (Neq-1)*Ltk                                                 PLANT  463
        Jpe = <tk;Jpe>                                                          PLANT  464
        IF     (<tk:ALGORITHM> .EQ. TES_ColdTank1)  THEN                        PLANT  465
          CALL TES_ColdTank_1(4)                                                PLANT  466
        ELSEIF (<tk:ALGORITHM> .EQ. TES_HotTank1)  THEN                         PLANT  467
          CALL TES_HotTank_1(4)                                                 PLANT  468
        ENDIF                                                                   PLANT  469
      ENDDO                                                                     PLANT  470
c                                                                               PLANT  471
c              Ground-loop heat-exchangers - skip if design day or              PLANT  472
c              run initialization                                               PLANT  473
      DO  Neq=1,Ngl                                                             PLANT  474
        IF (InitialFlg .EQ. 0  .AND.  iDDFlg .EQ. 0)  THEN                      Time    11
          Jgl = Igl + (Neq-1)*Lgl                                               PLANT  476
          Jpe = <gl;Jpe>                                                        PLANT  477
          SELECT CASE (<gl:ALGORITHM>)                                          PLANT  478
            CASE (491)         ! Ground-loop HX - Lake/well                     ChlrHP  18
            CASE (492,494)     ! Ground-loop HX - Vertical well field           -044d   11
              CALL GLHX_Vertical(2,3)                                           PLANT  481
            CASE (493)         ! Ground-loop HX - Horizontal trenches           PLANT  482
              CALL GLHX_Horizontal(2,3)                                         PLANT  483
          END SELECT                                                            PLANT  484
        ENDIF                                                                   PLANT  485
      ENDDO                                                                     PLANT  486
c                                                                               PLANT  487
      RETURN                                                                    PLANT  488
      END                                                                       PLANT  489
      SUBROUTINE Boiler_Design_1                                                BLDES1   2
c                                                                               BLDES1   3
c              Sets up the design parameters for most boiler types              BLDES1   4
c                                                                               BLDES1   5
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /DESDAT/ ZCFM,ICFM,ZVENT,C1,IFLAG                                 /DESDAT/ 2
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               BLDES1  13
      COMMON  /BLRKY / HWBLR                                                    /BLRKY/  2
      INTEGER          HWBLR                                                    /BLRKY/  3
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
      COMMON  /SimAlg/ Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/ 2
     &                 Electrical,                                              /SIMALG/ 3
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/ 4
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/ 5
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   2
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/ 7
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/ 8
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/ 9
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/10
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    3
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    4
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    5
     &                 Ground_LoopVert_H2,Ground_LoopHoriz_H,                   -044d    6
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/14
      INTEGER          Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/15
     &                 Electrical,                                              /SIMALG/16
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/17
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/18
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   3
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/20
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/21
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/22
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/23
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    7
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    8
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    9
     &                 Ground_LoopVert_H2, Ground_LoopHoriz_H,                  -044d   10
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/27
c                                                                               BLDES1  19
c                                                                               BLDES1  25
c              pointer to hw loop                                               BLDES1  26
      Jlp = <bl:HW-LOOP>                                                        BLDES1  27
c              boiler size                                                      BLDES1  28
      IF (<bl:CAP> .EQ. 0.)  THEN                                               BLDES1  29
c              default boiler size                                              BLDES1  30
        IF (<bl:CAP-RATIO> .EQ. 0.)  THEN                                       -042L2   1
c              no capcity ratio specified - size equipment equally              BLDES1  32
          CAP = <lp;DES_HCAP> / FLOAT(<lp;HT_NUM_EQUIP>)                        BLDES1  33
        ELSE                                                                    BLDES1  34
          CAP = <lp;DES_HCAP> * <bl:CAP-RATIO>                                  BLDES1  35
        ENDIF                                                                   BLDES1  36
        RatedHWRT = <lp:DESIGN-HEAT-T> + <lp:DESIGN-DT>  ! dT negative          -045k    1
      ELSE                                                                      BLDES1  37
        CAP = <bl:CAP>                                                          BLDES1  38
        RatedHWRT = <bl:RATED-HWR-T>                                            -045k    2
      ENDIF                                                                     BLDES1  39
c              pick up boiler dT from loop if not specd.                        BLDES1  40
      IF (<bl:HW-DT> .EQ. 0.)  <bl:HW-DT> = <lp:DESIGN-DT>                      BLDES1  41
c              temperature change is negative for consistency with load         BLDES1  42
      <bl:HW-DT> = -ABS(<bl:HW-DT>)                                             BLDES1  43
c              hot water flow - greater of load or flow requirement             -034     3
      GPMload = CAP/(<lp;BTUH/GPM-F>*<bl:HW-DT>)                                -034     4
      GPMflow = <lp;DES_GPM> * CAP/<lp;DES_HCAP>                                -034     5
      GPM     = MAX(GPMload, GPMflow)                                           -034     6
c              convert minimum flow from fraction to gpm                        BLDES1  46
      <bl:HW-MIN-GPM> = GPM * <bl:HW-MIN-GPM>                                   BLDES1  47
c              convert maximum flow from fraction to gpm                        BLDES1  48
      <bl:HW-MAX-GPM> = GPM * <bl:HW-MAX-GPM>                                   -035     5
      IF (<bl:HW-MAX-GPM> .LT. <lp:RECIRC-GPM>  .OR.                            -035     6
     &    <bl:HW-MAX-GPM> .LT. <lp:MIN-GPM>)    THEN                            -035     7
        CALL MSGSIM(-3,II,II,II,II)                                             -035     8
        WRITE (IOUTPT, 9001)  (<bl:NAME>,II=1,8)                                -035     9
      ENDIF                                                                     -035    10
c              design the boiler pump                                           BLDES1  50
      IF (<bl:HW-PUMP> .GT. 0)  THEN                                            BLDES1  51
        Jpm  = <bl:HW-PUMP>                                                     BLDES1  52
        CALL PUMPdes(GPM)                                                       BLDES1  53
c              decrease default size by pump heat                               BLDES1  54
        IF (<bl:CAP> .EQ. 0.)  CAP = CAP + Qpump                                BLDES1  55
c              store pump heat as parasitic load for hourly OpCap calc          BLDES1  56
        <pe;Q_PARASITIC> = Qpump                                                BLDES1  57
c              store design variables for use in pump calcs                     BLDES1  58
        <pm;MIN_GPM>     = <bl:HW-MIN-GPM>                                      BLDES1  59
      ELSE                                                                      BLDES1  60
c              error if no attached or loop pump                                BLDES1  61
        IF (<lp:PUMP> .EQ. 0)  THEN                                             BLDES1  62
          CALL MSGSIM(-1,II,II,II,II)                                           BLDES1  63
          WRITE (IOUTPT,9104) (<bl:NAME>,II=1,8),                               BLDES1  64
     &                        (<lp:NAME>,II=1,8)                                BLDES1  65
          IFLAG = 1                                                             BLDES1  66
        ENDIF                                                                   BLDES1  67
c              warn if loop pressure drop different than others                 BLDES1  68
        IF (ABS(<bl:HW-HEAD>+<bl:HW-STATIC>                                     BLDES1  69
     &         - (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>))                       BLDES1  70
     &        / (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>) .GT. 0.05               BLDES1  71
     &        .AND.  <lp:TYPE> .NE. WLHP)  THEN                                 BLDES1  72
          CALL MSGSIM(-3,II,II,II,II)                                           BLDES1  73
          WRITE (IOUTPT,9107) (<bl:NAME>,II=1,8),                               BLDES1  74
     &                        (<lp:NAME>,II=1,8)                                BLDES1  75
        ENDIF                                                                   BLDES1  76
      ENDIF                                                                     BLDES1  77
c              design boiler capacity and flow                                  BLDES1  78
      <bl:CAP>     = CAP                                                        BLDES1  79
c              set up the start up loads                                        BLDES1  80
      CALL StartUpLoad_Design(Jpe, CAP, <bl:START-TIME>)                        BLDES1  81
c              design power and fuel consumption                                BLDES1  82
      <pe;DES_KW>   = -CAP * <bl:EIR>                                           BLDES1  83
      <pe;DES_KW>   = <pe;DES_KW> + <bl:AUX-KW>                                 BLDES1  84
      <pe;DES_FUEL> = -CAP * <bl:HIR>                                           BLDES1  85
c              total primary loop equipment capacity                            BLDES1  86
      <lp;PRIMARY_HCAP> = <lp;PRIMARY_HCAP> + CAP                               BLDES1  87
c              save design variables for use in PrimaryEquip                    BLDES1  88
      <pe:MIN-RATIO>  = <bl:MIN-RATIO>                                          BLDES1  89
      <pe;DES_AUX_KW> = <bl:AUX-KW>                                             BLDES1  90
      <pe:ISOLATION>  = 1                                                       BLDES1  91
      <pe;Jpm>        = <bl:HW-PUMP>                                            BLDES1  92
      <pe;DES_GPM>    = GPM                                                     BLDES1  93
      <pe;MAX_GPM>    = <bl:HW-MAX-GPM>                                         BLDES1  94
      <pe;DES_HEAD>   = <bl:HW-HEAD>                                            BLDES1  95
      <pe;DES_STATIC> = <bl:HW-STATIC>                                          BLDES1  96
c              normalized capacity and HIR (condensing)                         -045k    3
      IF (<bl:ALGORITHM> .eq. 202) THEN  ! condensing                           -045k    4
        <bl;NormalHIR> = <bl:HIR>                                               -045k    7
     &                 / CVAL(<bl:HIR-FPLR>,1.,<bl:RATED-HWR-T>)                -045k    8
        <bl;RatedFuel> = -<bl:CAP> * <bl;NormalHIR>                             -045m    1
     &                             * CVAL(<bl:HIR-FPLR>,1.,RatedHWRT)           -045m    2
        <bl;RatedCap>  = -<bl;RatedFuel>                                        -045m    3
     &      / (<bl;NormalHIR> * CVAL(<bl:HIR-FPLR>,1.,<bl:RATED-HWR-T>))        -045m    4
      ENDIF                                                                     -045k    9
c                                                                               BLDES1  97
      RETURN                                                                    BLDES1  98
c                                                                               BLDES1  99
c              message formats                                                  BLDES1 100
 9001 FORMAT(14X,8A4,' has a maximum flow smaller'                     /        -035    11
     &       14X,'than the loops minimum flow, and will never be used' /        -035    12
     &       14X,'by itself.'                                          )        -035    13
 9104 FORMAT(14X,8A4,' must have a pump if'                            /        BLDES1 101
     &       14X,'loop: ',8A4,' does not.'                             )        BLDES1 102
 9107 FORMAT(14X,'Plant equipment: ',8A4,' has a different'            /        BLDES1 103
     &       14X,'pressure drop on loop: ',8A4,' than the'             /        BLDES1 104
     &       14X,'other equipment.  This is unusual unless the loop'   /        BLDES1 105
     &       14X,'uses flow meters or other dynamic flow control'      /        BLDES1 106
     &       14X,'devices to allocate the flow on an hourly basis to'  /        BLDES1 107
     &       14X,'the active equipment.'                               )        BLDES1 108
c                                                                               BLDES1 109
      END                                                                       BLDES1 110
      SUBROUTINE Boiler_HW_1                                                    BLHW1    2
c                                                                               BLHW1    3
c                                                                               BLHW1    4
c              Simulates hot water boilers, both fuel-fired                     BLHW1    5
c              and electric                                                     BLHW1    6
c                                                                               BLHW1    7
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /EQUIPD/ EQload, EQrun, EQhgb, OperCap, Frac,                     /EQUIPD/ 2
     &                 PLR, EQsupplyT, Tcond,                                   Chlr1    1
     &                 EIRPLR, EIRFT, EQEIR, EQelec, EQfanKW, EQaux,            /EQUIPD/ 4
     &                 HIRPLR, HIRFT, EQHIR, EQfuel, EQcond, EQrecvr,           /EQUIPD/ 5
     &                 HWflow, HWhead, CHWflow, CHWhead, CWflow, CWhead,        /EQUIPD/ 6
     &                 HTRECflow,HTREChead, Qenvir, EQstart, EQloadH,           -041d    1
     &                 EQstartH, PLRh, FracH, EQfuelH, EQelecH                  /EQUIPD/ 8
      REAL             EQUIPDAT(36)                                             /EQUIPD/10
      EQUIVALENCE      (EQUIPDAT(1), EQload), (Tambient, Tcond)                 FreeCl   1
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /LOOP  / Nloop(16,2), NextType(40), NLP2,                         -41a     1
     &                 WLHPoff, RealCall, RegenFlag, Sim2x, LoopSimCount        ChlrHP   2
      LOGICAL          WLHPoff, RealCall, RegenFlag, Sim2x                      ChlrHP   3
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               BLHW1   22
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
c                                                                               BLHW1   26
      INTEGER ZP1                                                               BLHW1   27
c                                                                               BLHW1   28
c              zero hourly boiler data                                          BLHW1   29
      CALL FILLN(0., EQUIPDAT(1), IVTLIM(2,17))                                 BLHW1   30
c                                                                               BLHW1   31
c              required supply temperature - greater of either the loop         BLHW1   32
c              temperature requirement, or the internal aquastat temp           BLHW1   33
      EQsupplyT = MAX(<pe;SUPPLY_T>, <bl:AQUASTAT-T>)                           BLHW1   34
c                                                                               BLHW1   35
c              environmental temperature                                        BLHW1   36
      IF (<bl:ZONE> .EQ. 0)  THEN                                               BLHW1   37
c              Equipment is located outdoors.                                   BLHW1   38
        Tambient = DBT                                                          FreeCl   4
      ELSE                                                                      BLHW1   40
c              Equipment is located indoors                                     BLHW1   41
        ZP1 = <bl:ZONE>                                                         BLHW1   42
        IF (RealCall)  THEN                                                     BLHW1   43
c              use average temperature for end-of-hour calcs                    BLHW1   44
          Tambient = (<TNOW>+<TPAST>)*0.5                                       FreeCl   5
        ELSE                                                                    BLHW1   46
          Tambient = <TNOW>                                                     FreeCl   6
        ENDIF                                                                   BLHW1   48
      ENDIF                                                                     BLHW1   49
c                                                                               BLHW1   50
c ****         run function : Boiler_HW_1-1                                     BLHW1   51
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        BLHW1   52
c                                                                               BLHW1   53
c                                                                               BLHW1   54
c============= ROUTINE CALLED TO GET OPERATING CAPACITY ======================= BLHW1   55
      IF (SimCtrl .EQ. 11)  THEN                                                BLHW1   56
c              Firing rate as a function of environmental temperature           BLHW1   57
        <pe;OPER_CAPACITY> = <bl:CAP>                                           FreeCl   7
     &                     * CVAL(<bl:CAP-FT>,EQsupplyT,Tambient)               FreeCl   8
c              maximum output - adjust by any parasitic load such as            BLHW1   59
c              a pump, and warmup time                                          BLHW1   60
        <pe;MAX_CAPACITY> = <pe;OPER_CAPACITY>*<bl:MAX-RATIO>                   BLHW1   61
     &                    - <pe;Q_PARASITIC>                                    BLHW1   62
     &                    - StartUpLoad(Jpe)                                    -044c4   1
c                                                                               BLHW1   64
c ****         run function : Boiler_HW_1-2                                     BLHW1   65
c       IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                      BLHW1   66
c                                                                               BLHW1   67
c              convert to positive number for load allocation routines          BLHW1   68
        <pe;MAX_CAPACITY>  = -<pe;MAX_CAPACITY>                                 BLHW1   69
        RETURN                                                                  BLHW1   70
      ENDIF                                                                     BLHW1   71
c                                                                               BLHW1   72
c                                                                               BLHW1   73
c============= ROUTINE CALLED TO SIMULATE EQUIPMENT =========================== BLHW1   74
c                                                                               BLHW1   75
c              total equipment pump kW                                          BLHW1   76
      AuxPumpKW = 0.                                                            BLHW1   77
c              hourly load and operating capacity                               BLHW1   78
      EQload    = -<pe;LOAD>                                                    BLHW1   79
      <pe;LOAD> = EQload                                                        BLHW1   80
      OperCap   = <pe;OPER_CAPACITY>                                            -044c4   2
c                                                                               -044c4   3
c ****         run function : Boiler_HW_1-3                                     -044c4   4
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        -044c4   5
c                                                                               -044c4   6
c              Skip if no load                                                  -044c4   7
      IF (<pe;GPM> .EQ. 0.)  GOTO 1000                                          -044c4   8
c              start up load                                                    -044c4   9
      EQstart = StartUpLoad(Jpe)                                                -044c4  10
c                                                                               -044c4  11
c              Boiler hot water pump                                            -044c4  12
      IF (<bl:HW-PUMP> .ne. 0)  THEN                                            -047k    4
        Jpm     = <bl:HW-PUMP>                                                  -044c4  14
        PMPfrac = 1.0                  ! runs full hour                         -044c4  15
        CALL PumpSupply                                                         -044c4  16
c              sum into auxiliary pump kW (equipment only)                      -044c4  17
        IF (<lp:PUMP> .ne. 0)  AuxPumpKW = PMPkW                                -047k    5
c              add pump heat to load                                            -044c4  19
        EQload = Min(0., EQload + PMPQ)                                         -044c4  20
      ENDIF                                                                     -044c4  21
c                                                                               -044c4  22
c              Part load ratio, including startup load                          -044c4  23
      Qnet = EQload + EQstart                                                   -044c4  24
      PLR  = Qnet / OperCap                                                     -044c4  25
      IF (PLR .gt. <bl:MIN-RATIO>)  THEN  ! equipment runs full hour            -044c4  26
        Frac = 1.                                                               -044c4  27
      ELSE  ! fraction of hour operating                                        -044c4  28
        PLR    = <bl:MIN-RATIO>                                                 -044c4  29
        CapMin = OperCap*<bl:MIN-RATIO>                                         -044c4  30
        Frac   = Qnet / CapMin                                                  -044c4  31
c              include standby losses                                           -044c4  32
        Qstandby = Max(<bl:CAP>*<bl:STANDBY-TIME>, CapMin)                      -044c4  33
        Qstandby = Qstandby * (1.0 - Frac)                                      -044c4  34
        Qnet     = Qnet + Qstandby                                              -044c4  35
        Frac     = Qnet / CapMin                                                -044c4  36
      ENDIF                                                                     -044c4  37
c              operating point of machine                                       -044c4  38
      EQrun  = OperCap * PLR                                                    -044c4  39
c                                                                               BLHW1  127
c              elec input ratio as a function of part load                      BLHW1  128
      EIRPLR = CVAL(<bl:EIR-FPLR>,PLR,PLR)                                      BLHW1  129
c              electric input ratio                                             BLHW1  130
      EQEIR  = <bl:EIR> * EIRPLR                                                BLHW1  131
c              electrical consumption                                           BLHW1  132
      EQelec = -OperCap * EQEIR * Frac * KWBTU                                  BLHW1  133
c                                                                               BLHW1  134
c              fuel input ratio as a function of temperature                    BLHW1  135
      HIRFT  = CVAL(<bl:HIR-FT>,EQsupplyT,Tambient)                             FreeCl   9
c              fuel input ratio as a function of part load                      BLHW1  137
      HIRPLR = CVAL(<bl:HIR-FPLR>,PLR,PLR)                                      BLHW1  138
c              fuel input ratio                                                 BLHW1  139
      HIR    = <bl:HIR> * HIRFT * HIRPLR                                        BLHW1  140
c              fuel consumption                                                 BLHW1  141
      EQfuel = -OperCap * HIR * FRAC                                            BLHW1  142
c                                                                               BLHW1  146
c              Auxiliary power                                                  BLHW1  147
 1000 IF (<bl:AUX-KW> .GT. 0.)  THEN                                            BLHW1  148
c              if always on                                                     BLHW1  149
        IF (<bl:AUX-MODE> .EQ. Always)  THEN                                    BLHW1  150
          EQaux = <bl:AUX-KW>                                                   BLHW1  151
        ELSEIF (<bl:AUX-MODE> .EQ. WhenOn)  THEN                                BLHW1  152
          EQaux = <bl:AUX-KW> * Frac                                            BLHW1  153
        ELSEIF (<bl:AUX-MODE> .EQ. WhenOff)  THEN                               BLHW1  154
          EQaux = <bl:AUX-KW> * (1.0 - Frac)                                    BLHW1  155
        ELSE                                                                    Time    12
          EQaux = <bl:AUX-KW> * SchVal(<bl:AUX-SCH>, 1.)                        Time    13
        ENDIF                                                                   BLHW1  158
      ENDIF                                                                     BLHW1  159
c                                                                               BLHW1  160
c ****         run function : Boiler_HW_1-4                                     BLHW1  161
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        BLHW1  162
c                                                                               BLHW1  163
c              report variables                                                 BLHW1  164
      <pe;KW>       = EQelec                                                    BLHW1  165
      <pe;AUX_KW>   = EQaux                                                     BLHW1  166
      <pe;TOTAL_KW> = EQelec + EQaux                                            BLHW1  167
      <pe;FUEL>     = EQfuel                                                    BLHW1  168
c                                                                               BLHW1  169
c              hourly-report variables                                          BLHW1  170
      IF (<bl;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                                BLHW1  171
     &  CALL HourRepPLT(EQUIPDAT(1), <bl;HREP>, 17, 0)                          BLHW1  172
c                                                                               BLHW1  173
c                                                                               BLHW1  174
      RETURN                                                                    BLHW1  175
      END                                                                       BLHW1  176
      SUBROUTINE Boiler_HW_Cond                                                 BLHW2    2
                                                                                BLHW2    3
c              Simulates a condensing boiler                                    BLHW2    4
                                                                                BLHW2    5
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /EQUIPD/ EQload, EQrun, EQhgb, OperCap, Frac,                     /EQUIPD/ 2
     &                 PLR, EQsupplyT, Tcond,                                   Chlr1    1
     &                 EIRPLR, EIRFT, EQEIR, EQelec, EQfanKW, EQaux,            /EQUIPD/ 4
     &                 HIRPLR, HIRFT, EQHIR, EQfuel, EQcond, EQrecvr,           /EQUIPD/ 5
     &                 HWflow, HWhead, CHWflow, CHWhead, CWflow, CWhead,        /EQUIPD/ 6
     &                 HTRECflow,HTREChead, Qenvir, EQstart, EQloadH,           -041d    1
     &                 EQstartH, PLRh, FracH, EQfuelH, EQelecH                  /EQUIPD/ 8
      REAL             EQUIPDAT(36)                                             /EQUIPD/10
      EQUIVALENCE      (EQUIPDAT(1), EQload), (Tambient, Tcond)                 FreeCl   1
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /LOOP  / Nloop(16,2), NextType(40), NLP2,                         -41a     1
     &                 WLHPoff, RealCall, RegenFlag, Sim2x, LoopSimCount        ChlrHP   2
      LOGICAL          WLHPoff, RealCall, RegenFlag, Sim2x                      ChlrHP   3
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
                                                                                BLHW2   20
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
                                                                                BLHW2   24
                                                                                BLHW2   25
c              zero hourly boiler data                                          BLHW2   26
      CALL FILLN(0., EQUIPDAT(1), IVTLIM(2,17))                                 BLHW2   27
                                                                                BLHW2   28
c              required supply temperature - greater of either the loop         BLHW2   29
c              temperature requirement, or the internal aquastat temp           BLHW2   30
      EQsupplyT = MAX(<pe;SUPPLY_T>, <bl:AQUASTAT-T>)                           BLHW2   31
                                                                                BLHW2   32
c ****         run function : Boiler_HW_2-1                                     BLHW2   33
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        BLHW2   34
c                                                                               BLHW2   35
c                                                                               BLHW2   36
c============= ROUTINE CALLED TO GET OPERATING CAPACITY ======================= BLHW2   37
      IF (SimCtrl .EQ. 11)  THEN                                                BLHW2   38
c              Return T with pump at maximum                                    -045m    5
        IF (<lp:PUMP> .ne. 0) THEN                                              -047k    6
          Jpm = <lp:PUMP>                                                       -045m    7
          Treturn = <pe;RETURN_T> + <pm;DESIGN_DT>                              -045m    8
        ELSE                                                                    -045m    9
          Treturn = <pe;RETURN_T>                                               -045m   10
        ENDIF                                                                   -045m   11
c              Check if HIR-fPLR curve inverts, if so limit Treturn             -045m   12
        PLR = 1.                                                                -045m   13
        Call CheckHIRfPLR                                                       -048     7
                                                                                -045m   15
c              Firing rate as a function of environmental temperature           BLHW2   39
        <pe;OPER_CAPACITY> = -<bl;RatedFuel>                                    -045m   16
     &               / (<bl;NormalHIR> * CVAL(<bl:HIR-FPLR>,1.,Treturn))        -045m   17
c              maximum output - adjust by any parasitic load such as            BLHW2   42
c              a pump, and warmup time                                          BLHW2   43
        <pe;MAX_CAPACITY> = <pe;OPER_CAPACITY>*<bl:MAX-RATIO>                   BLHW2   44
     &                    - <pe;Q_PARASITIC>                                    BLHW2   45
     &                    - StartUpLoad(Jpe)                                    BLHW2   46
                                                                                BLHW2   47
c ****         run function : Boiler_HW_2-2                                     BLHW2   48
c       IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                      BLHW2   49
                                                                                BLHW2   50
c              convert to positive number for load allocation routines          BLHW2   51
        <pe;MAX_CAPACITY>  = -<pe;MAX_CAPACITY>                                 BLHW2   52
        RETURN                                                                  BLHW2   53
      ENDIF                                                                     BLHW2   54
c                                                                               BLHW2   55
c                                                                               BLHW2   56
c============= ROUTINE CALLED TO SIMULATE EQUIPMENT =========================== BLHW2   57
                                                                                BLHW2   58
c              total equipment pump kW                                          BLHW2   59
      AuxPumpKW = 0.                                                            BLHW2   60
c              hourly load and operating capacity                               BLHW2   61
      EQload    = -<pe;LOAD>                                                    BLHW2   62
      <pe;LOAD> = EQload                                                        BLHW2   63
                                                                                BLHW2   64
c ****         run function : Boiler_HW_1-3                                     BLHW2   65
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        BLHW2   66
                                                                                BLHW2   67
c              Skip if no load                                                  BLHW2   68
      IF (<pe;GPM> .EQ. 0.)  GOTO 1000                                          BLHW2   69
c              start up load                                                    BLHW2   70
      EQstart = StartUpLoad(Jpe)                                                BLHW2   71
                                                                                BLHW2   72
c              Boiler hot water pump                                            BLHW2   73
      IF (<bl:HW-PUMP> .ne. 0)  THEN                                            -047k    7
        Jpm     = <bl:HW-PUMP>                                                  BLHW2   75
        PMPfrac = 1.0                  ! runs full hour                         BLHW2   76
        CALL PumpSupply                                                         BLHW2   77
c              sum into auxiliary pump kW (equipment only)                      BLHW2   78
        IF (<lp:PUMP> .ne. 0)  AuxPumpKW = PMPkW                                -047k    8
c              add pump heat to load                                            BLHW2   80
        EQload = Min(0., EQload + PMPQ)                                         BLHW2   81
c              return temperature                                               BLHW2   82
        Treturn = EQsupplyT + EQload/(<lp;BTUH/GPM-F>*<pm;GPM>)                 BLHW2   83
      ELSE                                                                      BLHW2   84
        Treturn = EQsupplyT + EQload/(<lp;BTUH/GPM-F>*<pe;GPM>)                 BLHW2   85
      ENDIF                                                                     BLHW2   86
                                                                                BLHW2   87
c              Check if HIR-fPLR curve inverts                                  -045m   18
      PLR = 1.                                                                  -045m   19
      Call CheckHIRfPLR  ! may modify Treturn                                   -048     8
c              Operating capacity based on actual return temperature            BLHW2   88
      <pe;OPER_CAPACITY> = -<bl;RatedFuel>                                      -045m   21
     &               / (<bl;NormalHIR> * CVAL(<bl:HIR-FPLR>,1.,Treturn))        -045m   22
      OperCap            = <pe;OPER_CAPACITY>                                   BLHW2   90
                                                                                BLHW2   91
c              Part load ratio, including startup load                          BLHW2   92
      Qnet = EQload + EQstart                                                   BLHW2   93
      PLR  = Qnet / OperCap                                                     BLHW2   94
      IF (PLR .gt. <bl:MIN-RATIO>)  THEN  ! equipment runs full hour            BLHW2   95
        Frac = 1.                                                               BLHW2   96
      ELSE  ! fraction of hour operating                                        BLHW2   97
        PLR    = <bl:MIN-RATIO>                                                 BLHW2   98
        CapMin = OperCap*<bl:MIN-RATIO>                                         BLHW2   99
        Frac   = Qnet / CapMin                                                  BLHW2  100
c              include standby losses                                           BLHW2  101
        Qstandby = Max(<bl:CAP>*<bl:STANDBY-TIME>, CapMin)                      BLHW2  102
        Qstandby = Qstandby * (1.0 - Frac)                                      BLHW2  103
        Qnet     = Qnet + Qstandby                                              BLHW2  104
        Frac     = Qnet / CapMin                                                BLHW2  105
      ENDIF                                                                     BLHW2  106
c              Operating point of machine                                       BLHW2  107
      EQrun  = OperCap * PLR                                                    BLHW2  108
                                                                                BLHW2  109
c              Elec input ratio as a function of part load                      BLHW2  110
      EIRPLR = CVAL(<bl:EIR-FPLR>,PLR,PLR)                                      BLHW2  111
c              electric input ratio                                             BLHW2  112
      EQEIR  = <bl:EIR> * EIRPLR                                                BLHW2  113
c              electrical consumption (not a function of operating cap)         BLHW2  114
      EQelec = -<bl;RatedCap> * EQEIR * Frac * KWBTU                            -045m   23
                                                                                BLHW2  116
c              Check if HIR-fPLR curve inverts                                  -045m   24
      Call CheckHIRfPLR  ! may modify Treturn                                   -048     9
c              Fuel input ratio as a function of part load and return T         BLHW2  117
      HIRPLR = CVAL(<bl:HIR-FPLR>,PLR,Treturn)                                  BLHW2  118
c              fuel input ratio                                                 BLHW2  119
      HIR    = <bl;NormalHIR> * HIRPLR                                          BLHW2  120
c              fuel consumption                                                 BLHW2  121
      EQfuel = -OperCap * HIR * FRAC                                            BLHW2  122
c              do not let efficiency exceed 99%                                 BLHW2  123
      Fuel99 = -Qnet / 0.99                                                     BLHW2  124
      EQfuel = Max(EQfuel, Fuel99)                                              BLHW2  125
                                                                                BLHW2  126
c              Auxiliary power                                                  BLHW2  127
 1000 IF (<bl:AUX-KW> .GT. 0.)  THEN                                            BLHW2  128
c              if always on                                                     BLHW2  129
        IF (<bl:AUX-MODE> .EQ. Always)  THEN                                    BLHW2  130
          EQaux = <bl:AUX-KW>                                                   BLHW2  131
        ELSEIF (<bl:AUX-MODE> .EQ. WhenOn)  THEN                                BLHW2  132
          EQaux = <bl:AUX-KW> * Frac                                            BLHW2  133
        ELSEIF (<bl:AUX-MODE> .EQ. WhenOff)  THEN                               BLHW2  134
          EQaux = <bl:AUX-KW> * (1.0 - Frac)                                    BLHW2  135
        ELSE                                                                    BLHW2  136
          EQaux = <bl:AUX-KW> * SchVal(<bl:AUX-SCH>, 1.)                        BLHW2  137
        ENDIF                                                                   BLHW2  138
      ENDIF                                                                     BLHW2  139
                                                                                BLHW2  140
c ****         run function : Boiler_HW_1-4                                     BLHW2  141
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        BLHW2  142
                                                                                BLHW2  143
c              report variables                                                 BLHW2  144
      <pe;KW>       = EQelec                                                    BLHW2  145
      <pe;AUX_KW>   = EQaux                                                     BLHW2  146
      <pe;TOTAL_KW> = EQelec + EQaux                                            BLHW2  147
      <pe;FUEL>     = EQfuel                                                    BLHW2  148
      <pe;RETURN_T> = Treturn                                                   -045m   26
                                                                                BLHW2  149
c              hourly-report variables                                          BLHW2  150
      IF (<bl;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                                BLHW2  151
     &  CALL HourRepPLT(EQUIPDAT(1), <bl;HREP>, 17, 0)                          BLHW2  152
                                                                                BLHW2  153
      RETURN                                                                    BLHW2  154
c                                                                               -045m   27
c                                                                               -045m   28
      CONTAINS                                                                  -048    10
c ================ CheckHIRfPLR =============================================== -045m   29
      SUBROUTINE CheckHIRfPLR                                                   -048    11
                                                                                -045m   31
c              The default HIR-f(PLR&HWR) curve based on Aerco may              -045m   32
c              invert at a low PLR and high Treturn.  If so, freeze             -045m   33
c              Treturn at inflection point.                                     -045m   34
                                                                                -045m   35
c              Necessary only if bi-quadratic and second order in PLR           -045m   36
      Jcv = <bl:HIR-FPLR>                                                       -045m   37
      IF (<cv:TYPE> .ne. 4)     Return                                          -048    12
      IF (<cv:COEF-3> .eq. 0.)  Return                                          -048    13
                                                                                -045m   40
c              imbed PLR into coefficients Axx + Bx + C                         -045m   41
      A = <cv:COEF-5>                                                           -045m   42
      B = <cv:COEF-4> + <cv:COEF-6>*PLR                                         -045m   43
c     C = <cv:COEF-1> + <cv:COEF-2>*PLR + <cv:COEF-3>*PLR*PLR                   -045m   44
                                                                                -045m   45
c              take derivative (2Ax + B) and solve for Treturn at               -045m   46
c              inflection point                                                 -045m   47
      Tinflect = -B / (2.*A)                                                    -045m   48
                                                                                -045m   49
c              Check if inflection is in range of curve fit                     -045m   50
      IF (Tinflect .gt. 80.)  Treturn = Min(Treturn, Tinflect)                  -045m   51
                                                                                -045m   52
      End Subroutine CheckHIRfPLR                                               -048    14
      END  ! Boiler_HW_2                                                        BLHW2  155
      SUBROUTINE Chiller_Absor_1                                                CHABS1   2
c                                                                               CHABS1   3
c                                                                               CHABS1   4
c              Simulates absorption chillers, either hot water or steam,        CHABS1   5
c              including low temperature heat recovery                          CHABS1   6
c                                                                               CHABS1   7
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /EQUIPD/ EQload, EQrun, EQhgb, OperCap, Frac,                     /EQUIPD/ 2
     &                 PLR, EQsupplyT, Tcond,                                   Chlr1    1
     &                 EIRPLR, EIRFT, EQEIR, EQelec, EQfanKW, EQaux,            /EQUIPD/ 4
     &                 HIRPLR, HIRFT, EQHIR, EQfuel, EQcond, EQrecvr,           /EQUIPD/ 5
     &                 HWflow, HWhead, CHWflow, CHWhead, CWflow, CWhead,        /EQUIPD/ 6
     &                 HTRECflow,HTREChead, Qenvir, EQstart, EQloadH,           -041d    1
     &                 EQstartH, PLRh, FracH, EQfuelH, EQelecH                  /EQUIPD/ 8
      REAL             EQUIPDAT(36)                                             /EQUIPD/10
      EQUIVALENCE      (EQUIPDAT(1), EQload), (Tambient, Tcond)                 FreeCl   1
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               CHABS1  21
      COMMON  /CHLRKY/ ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 2
     &                 WaterCool, AirCool                                       /CHLRKY/ 3
      INTEGER          ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 4
     &                 WaterCool, AirCool                                       /CHLRKY/ 5
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
c                                                                               CHABS1  26
c              pointer to chiller evaporator loop                               Chlr1    5
      JlpEvap = Jlp                                                             Chlr1    6
c                                                                               Chlr1    7
c              zero hourly chiller data                                         Chlr1    8
      CALL FILLN(0., EQUIPDAT(1), IVTLIM(2,16))                                 Chlr1    9
                                                                                Chlr1   10
c              required leaving evaporator temperature                          Chlr1   11
      EQsupplyT = <pe;SUPPLY_T>                                                 Chlr1   12
c                                                                               Chlr1   13
c ****         run function : Chiller_Absor_1-1                                 Chlr1   14
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        Chlr1   15
c                                                                               Chlr1   16
      IF (SimCtrl .EQ. 11)  THEN                                                Chlr1   17
c              Routine called to get operating capacity                         Chlr1   18
c              initialize leaving condenser temperature                         Chlr1   19
        Jlp       = <ch:CW-LOOP>                                                Chlr1   20
        <ch;ECT>  = <lp;COIL_EWTest>                                            Chlr1   21
        Tcond     = <lp;COIL_EWTest>                                            Chlr1   22
        <ch;Tcond> = MAX(Tcond, <ch:MIN-COND-T>)                                Chlr1   23
c              capacity adjustment factor for HW availability                   Chlr1   24
        Jlp       = <ch:HW-LOOP>                                                Chlr1   25
        HcapRatio = <lp;HCAP_RATIO>                                             Chlr1   26
        Jlp       = JlpEvap                                                     Chlr1   27
      ELSEIF (<pe;GPM> .EQ. 0.)  THEN  ! chiller is off                         -044c4  40
c              go thru dilution cycle if chiller just shut down                 -044c4  41
        IF (<pe;HOURS_OFF> .EQ. 0)                                              -044c4  42
     &    EQelec = <ch:CAP> * <ch:EIR> * <ch:STOP-TIME> * KWBTU                 -044c4  43
        GOTO 1000                                                               -044c4  44
      ENDIF                                                                     -044c4  45
c                                                                               -044c4  46
      EQstart = StartUpLoad(Jpe)       ! start-up load                          -044c4  47
c                                                                               Chlr1   41
c ****         run function : Chiller_Absor_1-2                                 Chlr1   42
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        Chlr1   43
c                                                                               Chlr1   44
c              Start of iterative loop on condenser temperature                 Chlr1   45
      Tcond     = <ch;Tcond>                                                    Chlr1   46
      ErrorLast = 0                                                             -047j    1
      IterT     = 0                                                             Chlr1   47
   20 IterT     = IterT + 1                                                     Chlr1   48
      AuxPumpKW = 0.                   ! local pump kW                          Chlr1   49
      Tlast     = Tcond                                                         Chlr1   50
c              operating capacity                                               Chlr1   51
      Cap_fT  = CVAL(<ch:CAP-FT>, EQsupplyT, Tcond)                             Chlr1   52
      OperCap = <ch;NormalCap> * Cap_fT                                         Chlr1   53
c                                                                               -044c4  48
      IF (SimCtrl .EQ. 11)  THEN       ! getting capacity                       -044c4  49
        EQload = OperCap - EQstart                                              -044c4  50
      ELSE                             ! normal call                            -044c4  51
        EQload = <pe;LOAD>                                                      -044c4  52
c              local chilled water pump                                         -044c4  53
        IF (<ch:CHW-PUMP> .ne. 0)  THEN                                         -047k    9
          Jpm     = <ch:CHW-PUMP>                                               -044c4  55
          PMPfrac = 1.0                ! runs full hour                         -044c4  56
          CALL PumpSupply                                                       -044c4  57
          EQload = EQload + PMPQ       ! add pump heat to load                  -044c4  58
c              sum into auxiliary pump Kw (equipment pumps only)                -044c4  59
          IF (<pm;TYPE> .EQ. EquipmentPump)                                     -044c4  60
     &                                AuxPumpKW = AuxPumpKW + PMPkW             -044c4  61
        ENDIF                                                                   -044c4  62
      ENDIF                                                                     -044c4  63
c                                                                               -044c4  64
c              Part load ratio, including startup load                          -044c4  65
      Qnet = EQload + EQstart                                                   -044c4  66
      PLR  = Qnet / OperCap                                                     -044c4  67
      IF (PLR .gt. <ch:MIN-RATIO>)  THEN  ! equipment runs full hour            -044c4  68
        Frac     = 1.                                                           -044c4  69
        FracElec = 1.                                                           -044c4  70
      ELSE  ! fraction of hour operating                                        -044c4  71
        PLR      = <ch:MIN-RATIO>                                               -044c4  72
        CapMin   = OperCap*<ch:MIN-RATIO>                                       -044c4  73
        Frac     = Qnet / CapMin                                                -044c4  74
c              include standby losses                                           -044c4  75
        Qstandby = Min(<ch:CAP>*<ch:STANDBY-TIME>, CapMin)                      -044c4  76
        Qstandby = Qstandby * (1.0 - Frac)                                      -044c4  77
        Qnet     = Qnet + Qstandby                                              -044c4  78
        Frac     = Qnet / CapMin                                                -044c4  79
c              include dilution cycle elec; assume 2 cycles per hour avg        -044c4  80
        FracElec = Min(1., Frac + <ch:STOP-TIME>*2.)                            -044c4  81
      ENDIF                                                                     -044c4  82
c              operating point of machine                                       Chlr1   93
      EQrun  = OperCap * PLR                                                    Chlr1   94
c                                                                               Chlr1   95
c              Solution pump power - note that elec is function of              Chlr1   96
c              rated cap and EIR, not operating cap                             Chlr1   97
      EIRFT  = CVAL(<ch:EIR-FT>, EQsupplyT, Tcond)                              Chlr1   98
      dT     = Tcond - EQsupplyT                                                Chlr1   99
      EIRPLR = CVAL(<ch:EIR-FPLR>, PLR, dT)                                     Chlr1  100
      EQEIR  = <ch:EIR> * EIRFT * EIRPLR                                        Chlr1  101
      EQelec = <ch:CAP> * EQEIR * FracElec * KWBTU                              -044c4  83
c                                                                               Chlr1  103
c              Heat consumption                                                 Chlr1  104
      HIRFT  = CVAL(<ch:HIR-FT>, EQsupplyT, Tcond)                              Chlr1  105
      HIRPLR = CVAL(<ch:HIR-FPLR>, PLR, dT)                                     Chlr1  106
      EQHIR  = <ch;NormalHIR> * HIRFT * HIRPLR                                  Chlr1  107
      EQfuel = -OperCap * EQHIR * Frac                                          Chlr1  108
                                                                                Chlr1  109
c              Rejected heat                                                    Chlr1  110
      EQcond = EQload + EQelec*<ch:ELEC-TO-COND>*BTUKW                          -044c4  84
     &                - EQfuel*<ch:HEAT-TO-COND>                                -044c4  85
c                                                                               Chlr1  113
c              Check for heat recovery                                          Chlr1  114
      IF (<ch:HTREC-LOOP> .EQ. 0.)  THEN                                        Chlr1  115
        HtRecMaxT = -88888.                                                     Chlr1  116
      ELSE                                                                      Chlr1  117
        Jlp       = <ch:HTREC-LOOP>                                             Chlr1  118
        HtrecMaxT = MIN(<ch:RECOVER-T>, <lp;SUPPLY_T>)                          Chlr1  119
        IF (<lp;CTRL_MODE> .NE. HEATMODE                                        Chlr1  120
     &                      .OR.  HtrecMaxT .LE. <lp;RETURN_T>)  THEN           Chlr1  121
          HtRecMaxT = -88888.                                                   Chlr1  122
        ELSE                                                                    Chlr1  123
c              htrec flow cannot be greater than the loop flow, adjusted        Chlr1  124
c              for the flow which goes thru other htrec devices                 Chlr1  125
          HTRECflow = MIN(<ch;DES_HTR_GPM>, <lp;HTREC_GPM>)                     Chlr1  126
c              maximum recoverable heat based on temperature and flow           Chlr1  127
          EQrecvr = <lp;BTUH/GPM-F> * HTRECflow                                 Chlr1  128
     &                              * (HtrecMaxT - <lp;RETURN_T>)               Chlr1  129
     &                              * Frac                                      Chlr1  130
c              limit by the amount the chiller can produce, and change sign     Chlr1  131
c              for heating                                                      Chlr1  132
          EQrecvr = -MIN(EQcond, EQrecvr)                                       Chlr1  133
          EQcond  = EQcond + EQrecvr                                            Chlr1  134
c              if chiller has a heat reclaim pump                               Chlr1  135
          IF (<ch:HTREC-PUMP> .GT. 0  .AND.  SimCtrl .NE. 11)  THEN             Chlr1  136
            Jpm = <ch:HTREC-PUMP>                                               Chlr1  137
            IF (<ch:HTREC-CTRL> .EQ. ConstantFlow)  THEN                        Chlr1  138
c              constant flow                                                    Chlr1  139
              HTREChead = <ch:HTREC-HEAD> + <ch:HTREC-STATI>                    Chlr1  140
            ELSE                                                                Chlr1  141
c              variable flow - matches prorated loop flow                       Chlr1  142
              HTRECflow = MAX(HTRECflow, <ch:HTREC-MIN-G>)                      Chlr1  143
              PLRflow   = HTRECflow / <ch;DES_HTR_GPM>                          Chlr1  144
              HTREChead = <ch:HTREC-HEAD> * PLRflow**1.8                        Chlr1  145
     &                  + <ch:HTREC-STATI>                                      Chlr1  146
            ENDIF                                                               Chlr1  147
            PMPgpm    = HTRECflow                                               Chlr1  148
            PMPfric   = HTREChead                                               Chlr1  149
            PMPstatic = <ch:HTREC-STATI>                                        Chlr1  150
            PMPset    = HTREChead + <ch:HTREC-STATI>                            Chlr1  151
            PMPfrac   = Frac                                                    Chlr1  152
            CALL PUMP                                                           Chlr1  153
c              add pump heat into heat reclaim                                  Chlr1  154
            EQrecvr   = EQrecvr - PMPQ                                          Chlr1  155
c              sum into auxiliary pump kW                                       Chlr1  156
            AuxPumpKW = AuxPumpKW + PMPkW                                       Chlr1  157
          ELSE                                                                  Chlr1  158
c              no heat reclaim pump - pass reclaim head onto reclaim loop       Chlr1  159
c              note that this head is not assumed to vary hourly, and is        Chlr1  160
c              accounted for in a design variable                               Chlr1  161
          ENDIF                                                                 Chlr1  162
        ENDIF                                                                   Chlr1  163
        Jlp = JlpEvap                                                           Chlr1  164
      ENDIF  ! heat recovery                                                    Chlr1  165
c                                                                               Chlr1  166
c              Condenser performance                                            Chlr1  167
      Jlp = <ch:CW-LOOP>                                                        Chlr1  168
c              condenser flow & head                                            Chlr1  169
      IF (<ch:CW-CTRL> .EQ. ConstantFlow)  THEN                                 Chlr1  170
c              constant flow                                                    Chlr1  171
        CWflow = <ch;DES_CW_GPM>                                                Chlr1  172
        CWhead = <ch:CW-HEAD>                                                   Chlr1  173
      ELSE                                                                      Chlr1  174
c              variable flow                                                    Chlr1  175
        PLRflow = (PLR-<ch:CW-MIN-PLR>) / (1.-<ch:CW-MIN-PLR>)                  Chlr1  176
        PLRflow = MAX(0., MIN(1., PLRflow))                                     Chlr1  177
        CWflow  = <ch:CW-MIN-GPM>                                               Chlr1  178
     &          + (<ch;DES_CW_GPM>-<ch:CW-MIN-GPM>)*PLRflow                     Chlr1  179
c              leaving condenser temperature                                    Chlr1  180
        dT      = EQcond/(<lp;BTUH/GPM-F>*CWflow*Frac)                          Chlr1  181
        Tcwr    = <ch;ECT> + dT                                                 Chlr1  182
        IF (PLRflow         .LT. 1.0     .AND.                                  Chlr1  183
     &      <ch:MAX-COND-T> .NE. UNFILD  .AND.                                  Chlr1  184
     &      Tcwr            .GT. <ch:MAX-COND-T>)  THEN                         Chlr1  185
          IF (<ch;ECT> .LT. <ch:MAX-COND-T>)  THEN                              Chlr1  186
            dT     = <ch:MAX-COND-T> - <ch;ECT>                                 Chlr1  187
            CWflow = EQcond / (<lp;BTUH/GPM-F>*dT*Frac)                         Chlr1  188
            CWflow = MIN(<ch;DES_CW_GPM>, CWflow)                               Chlr1  189
          ELSE                                                                  Chlr1  190
            CWflow = <ch;DES_CW_GPM>                                            Chlr1  191
          ENDIF                                                                 Chlr1  192
        ENDIF                                                                   Chlr1  193
        PLRflow = CWflow / <ch;DES_CW_GPM>                                      Chlr1  194
        CWhead  = <ch:CW-HEAD> * PLRflow**1.8                                   Chlr1  195
      ENDIF                                                                     Chlr1  196
c              Leaving condenser temperature                                    Chlr1  197
      dT    = EQcond/(<lp;BTUH/GPM-F>*CWflow*Frac)                              Chlr1  198
      Tcwr  = <ch;ECT> + dT                                                     Chlr1  199
      IF (EQrecvr .EQ. 0.)  THEN                                                Chlr1  200
c              Effective entering condenser temperature, adjusted for           Chlr1  201
c              reduced flow                                                     Chlr1  202
        Tcond  = Tcwr - dT*MIN(1.,CWflow/<ch;RatedCWgpm>)                       Chlr1  203
      ELSE                                                                      Chlr1  204
c              Effective entering condenser temperature, adjusted for           Chlr1  205
c              heat recovery                                                    Chlr1  206
        Tcwr   = MAX(HtrecMaxT, Tcwr)                                           Chlr1  207
        dT     = Tcwr - <ch;ECT>                                                Chlr1  208
        CWflow = EQcond / (<lp;BTUH/GPM-F>*dT*Frac)                             Chlr1  209
        dT     = (EQcond-EQrecvr)                                               Chlr1  210
     &                       / (<lp;BTUH/GPM-F>*(HTRECflow+CWflow)*Frac)        Chlr1  211
        Tcond  = Tcwr - dT                                                      Chlr1  212
        IF (<ch:CW-CTRL> .EQ. ConstantFlow)  THEN                               Chlr1  213
          CWflow = <ch;DES_CW_GPM>                                              Chlr1  214
        ELSE                                                                    Chlr1  215
          PLRflow = (HTRECflow+CWflow) / <ch;DES_CW_GPM>                        Chlr1  216
          PLRflow = MIN(1., PLRflow)                                            Chlr1  217
          CWhead  = <ch:CW-HEAD> * PLRflow**1.8                                 Chlr1  218
        ENDIF                                                                   Chlr1  219
      ENDIF                                                                     Chlr1  220
      Tcond = MAX(<ch:MIN-COND-T>, Tcond)                                       Chlr1  221
c              if chiller has an attached condenser pump                        Chlr1  222
      IF (<ch:CW-PUMP> .GT. 0)  THEN                                            Chlr1  223
        Jpm = <ch:CW-PUMP>                                                      Chlr1  224
c              if the loop has its own pump, then this condenser pump           Chlr1  225
c              is an equipment pump and can be simulated now.  If the           Chlr1  226
c              loop does not have its own pump, then this pump powers           Chlr1  227
c              the loop and must be simulated later when more is known          Chlr1  228
c              about the total loop flow and head.                              Chlr1  229
        IF (<pm;TYPE> .EQ. EquipmentPump)  THEN                                 Chlr1  230
c                 equipment pump                                                Chlr1  231
          PMPgpm    = CWflow                                                    Chlr1  232
          PMPset    = CWhead + <ch:CW-STATIC>                                   Chlr1  233
          PMPfric   = CWhead                                                    Chlr1  234
          PMPstatic = <ch:CW-STATIC>                                            Chlr1  235
          PMPfrac   = 1.     ! runs continuously                                -047e    1
          CALL PUMP                                                             Chlr1  237
          AuxPumpKW = AuxPumpKW + PMPkW                                         Chlr1  238
c                 add condenser pump heat into condenser water                  Chlr1  239
          EQcond    = EQcond + PMPQ                                             Chlr1  240
        ELSEIF (SimCtrl .NE. 11)  THEN                                          -041g    1
c                 condenser pump powers the loop - save for later               Chlr1  242
          <pm;GPM>        = CWflow                                              Chlr1  243
          <pm;EQUIP_HEAD> = CWhead                                              Chlr1  244
        ENDIF                                                                   Chlr1  245
      ENDIF                                                                     Chlr1  246
      Jlp = JlpEvap                                                             Chlr1  247
c                                                                               Chlr1  248
c              Check if Tcond converged                                         Chlr1  249
      Error = Tcond - Tlast                                                     -047j    2
      IF (Abs(Error) .lt. 0.1) THEN             ! converged                     -047j    3
      ELSEIF (IterT .eq. 20) THEN               ! convergence failure           -047j    4
        Call MsgSim(-2,II,II,II,II)                                             -047j    5
        Write (iOutpt,9101)  (<ch:NAME>,II=1,8)                                 -047j    6
      ELSE                                       ! iterate again                -047j    7
        IF (ErrorLast/Error .lt. 0.)  Tcond = (Tcond+Tlast)*0.5                 -047j    8
        ErrorLast = Error                                                       -047j    9
        GoTo 20                                                                 -047j   10
      ENDIF                                                                     -047j   11
c                                                                               Chlr1  260
c ****         run function : Chiller_Absor_1-3                                 Chlr1  261
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        Chlr1  262
c                                                                               Chlr1  263
      <pe;OPER_CAPACITY> = OperCap                                              Chlr1  264
      IF (SimCtrl .EQ. 11)  THEN                                                Chlr1  265
c              maximum output - adjust by any parasitic load such as            Chlr1  266
c              a pump, and reduce capacity if the HW loop is overloaded         Chlr1  267
        <pe;MAX_CAPACITY> = OperCap*HcapRatio                                   Chlr1  268
     &                    - <pe;Q_PARASITIC> - EQstart                          Chlr1  269
        <pe;MAX_CAPACITY> = MAX(0., <pe;MAX_CAPACITY>)                          Chlr1  270
        RETURN                                                                  Chlr1  271
      ENDIF                                                                     Chlr1  272
c                                                                               Chlr1  273
c              Hot water consumption                                            Chlr1  274
      Jlp = <ch:HW-LOOP>                                                        Chlr1  275
c              hot water flow & head                                            Chlr1  276
      IF (<ch:HW-CTRL> .EQ. ConstantFlow)  THEN                                 Chlr1  277
c              constant flow                                                    Chlr1  278
        HWflow = <ch;DES_HW_GPM>                                                Chlr1  279
        HWhead = <ch:HW-HEAD>                                                   Chlr1  280
      ELSE                                                                      Chlr1  281
c              variable flow - linear with load                                 Chlr1  282
        PLRflow = MIN(1., PLR)                                                  Chlr1  283
        HWflow  = MAX(<ch;DES_HW_GPM>*PLRflow, <ch:HW-MIN-GPM>)                 Chlr1  284
        PLRflow = HWflow / <ch;DES_HW_GPM>                                      Chlr1  285
        HWhead  = <ch:HW-HEAD> * PLRflow**1.8                                   Chlr1  286
      ENDIF                                                                     Chlr1  287
c              if chiller has an attached hot water pump                        Chlr1  288
      IF (<ch:HW-PUMP> .GT. 0)  THEN                                            Chlr1  289
        Jpm = <ch:HW-PUMP>                                                      Chlr1  290
c              this hot water pump is an equipment pump and can be              Chlr1  291
c              simulated now.                                                   Chlr1  292
        PMPgpm    = HWflow                                                      Chlr1  293
        PMPset    = HWhead + <ch:HW-STATIC>                                     Chlr1  294
        PMPfric   = HWhead                                                      Chlr1  295
        PMPstatic = <ch:HW-STATIC>                                              Chlr1  296
        PMPfrac   = Frac                                                        Chlr1  297
        CALL PUMP                                                               Chlr1  298
c              add hot water pump heat into hot water                           Chlr1  299
        EQfuel = MIN(0., EQfuel+PMPQ)                                           Chlr1  300
c              sum into auxiliary pump kW                                       Chlr1  301
        AuxPumpKW = AuxPumpKW + PMPkW                                           Chlr1  302
      ELSE                                                                      Chlr1  303
c              no hot water pump - pass head onto hot water loop                Chlr1  304
        <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>, HWhead)                    Chlr1  305
        <lp;DEM-SIDE_STAT> = MAX(<lp;DEM-SIDE_STAT>, <ch:HW-STATIC>)            Chlr1  306
      ENDIF                                                                     Chlr1  307
c              pass hot water load onto loop                                    Chlr1  308
      <lp;PRIM_HEAT> = <lp;PRIM_HEAT> + EQfuel                                  Chlr1  309
      <lp;PRIM_GPM>  = <lp;PRIM_GPM>  + HWflow*Frac                             Chlr1  310
c                                                                               Chlr1  311
c              Deduct htrec flow from available                                 Chlr1  312
      IF (EQrecvr .LT. 0.)  THEN                                                Chlr1  313
        Jlp            = <ch:HTREC-LOOP>                                        Chlr1  314
        <lp;HTREC_GPM> = <lp;HTREC_GPM> - HTRECflow*Frac                        Chlr1  315
        <lp;Q_HTREC>   = <lp;Q_HTREC> + EQrecvr                                 Chlr1  316
      ENDIF                                                                     Chlr1  317
      Jlp = JlpEvap                                                             Chlr1  318
c                                                                               CHABS1 348
c              Auxiliary power                                                  CHABS1 349
 1000 IF (<ch:AUX-KW> .GT. 0.)  THEN                                            CHABS1 350
c              if always on                                                     CHABS1 351
        IF (<ch:AUX-MODE> .EQ. Always)  THEN                                    CHABS1 352
          EQaux = <ch:AUX-KW>                                                   CHABS1 353
        ELSEIF (<ch:AUX-MODE> .EQ. WhenOn)  THEN                                CHABS1 354
          EQaux = <ch:AUX-KW> * Frac                                            CHABS1 355
        ELSEIF (<ch:AUX-MODE> .EQ. WhenOff)  THEN                               CHABS1 356
          EQaux = <ch:AUX-KW> * (1.0 - Frac)                                    CHABS1 357
        ELSE                                                                    Time    14
          EQaux = <ch:AUX-KW> * SchVal(<ch:AUX-SCH>, 1.)                        Time    15
        ENDIF                                                                   CHABS1 360
      ENDIF                                                                     CHABS1 361
c                                                                               CHABS1 362
c ****         run function : Chiller_Absor_1-4                                 CHABS1 363
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        CHABS1 364
c                                                                               CHABS1 365
c                                                                               CHABS1 366
c              report variables                                                 CHABS1 367
      <ch;KW>      = EQelec                                                     CHABS1 368
      <ch;HtRejKW> = EQfanKW                                                    -033     1
      <ch;FUEL>    = EQfuel                                                     CHABS1 369
      <ch;Q_RECVR> = EQrecvr                                                    CHABS1 370
      <ch;AUX>     = EQaux                                                      CHABS1 371
      <ch;CWload>  = EQcond                                                     ChlrHP  21
      <ch;CWflow>  = CWflow  ! no adjustment for cycling                        -047e    2
      <ch;CWhead>  = CWhead                                                     ChlrHP  23
      <ch;Tcond>   = Tcond                                                      -041h    1
c                                                                               CHABS1 372
c              hourly-report variables                                          CHABS1 373
      IF (<ch;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                                CHABS1 374
     &  CALL HourRepPLT(EQUIPDAT(1), <ch;HREP>, 16, 0)                          CHABS1 375
c                                                                               CHABS1 376
      RETURN                                                                    CHABS1 377
c                                                                               Chlr1  320
 9101 FORMAT(                                                                   Chlr1  321
     &14x,'Chiller Tcond convergence failure: ',8A4                    )        Chlr1  322
      END                                                                       CHABS1 378
      SUBROUTINE Chiller_Design_1                                               ChlrHP  24
c                                                                               CHDES1   3
c              Sets up the design parameters for most chiller types             CHDES1   4
c                                                                               CHDES1   5
c              Mode = 1  Cooling design calcs                                   CHDES1   6
c                     2  Heating design calcs for chiller/heater                CHDES1   7
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /DESDAT/ ZCFM,ICFM,ZVENT,C1,IFLAG                                 /DESDAT/ 2
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
c                                                                               CHDES1  15
      COMMON  /CHLRKY/ ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 2
     &                 WaterCool, AirCool                                       /CHLRKY/ 3
      INTEGER          ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 4
     &                 WaterCool, AirCool                                       /CHLRKY/ 5
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
      COMMON  /SimAlg/ Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/ 2
     &                 Electrical,                                              /SIMALG/ 3
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/ 4
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/ 5
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   2
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/ 7
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/ 8
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/ 9
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/10
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    3
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    4
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    5
     &                 Ground_LoopVert_H2,Ground_LoopHoriz_H,                   -044d    6
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/14
      INTEGER          Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/15
     &                 Electrical,                                              /SIMALG/16
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/17
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/18
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   3
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/20
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/21
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/22
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/23
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    7
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    8
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    9
     &                 Ground_LoopVert_H2, Ground_LoopHoriz_H,                  -044d   10
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/27
c                                                                               CHDES1  21
c                                                                               CHDES1  27
c                                                                               Chlr1  323
c              Ensure dTs have right sign                                       Chlr1  324
      <ch:CHW-DT>   =  ABS(<ch:CHW-DT>)                                         Chlr1  325
      <ch:CW-DT>    =  ABS(<ch:CW-DT>)                                          Chlr1  326
      <ch:CW-DT-HT> = -ABS(<ch:CW-DT-HT>)                                       Chlr1  327
      <ch:HW-DT>    = -ABS(<ch:HW-DT>)                                          Chlr1  328
      <ch:HTREC-DT> = -ABS(<ch:HTREC-DT>)                                       Chlr1  329
c              Initial checks by chiller type                                   Chlr1  330
      SELECT CASE (<ch:TYPE>)                                                   Chlr1  331
        CASE (11)  ! Loop-to-loop HP                                            Chlr1  332
          <ch:COND-TYPE> = -1                                                   Chlr1  333
c              CHW and HW loops must all have their own pumps -                 Chlr1  334
c              as the local pumps must recirculate                              Chlr1  335
          Jlp = <ch:CHW-LOOP>                                                   Chlr1  336
          IF (<lp:PUMP> .EQ. 0)  Call NoLoopPump                                -048    15
          Jlp = <ch:HW-LOOP>                                                    Chlr1  338
          IF (<lp:PUMP> .EQ. 0)  Call NoLoopPump                                -048    16
c              Check HW loop setpoint                                           Chlr1  340
          IF (<lp:HT-SETPT-T> .GT. 130.)  THEN                                  Chlr1  341
            CALL MSGSIM(-1,II,II,II,II)                                         -044c4  86
            WRITE (IOUTPT,9003) (<ch:NAME>,II=1,8)                              Chlr1  342
            CALL MessageBox( NULL,                                              Chlr1  343
     &        'HW loop setpoint too high for'//char(10)//char(13)//             Chlr1  344
     &        ' loop-to-loop heat-pump'//char(0),                               Chlr1  345
     &        'DESIGN Errors'//char(0),                                         Chlr1  346
     &        MB_OK + MB_ICONSTOP + MB_TASKMODAL )                              Chlr1  347
              IwinReturn = 1                                                    Chlr1  348
          ENDIF                                                                 Chlr1  349
c              Check loop design T                                              Chlr1  350
          IF (<lp:DESIGN-HEAT-T> .GT. 130.)  THEN                               Chlr1  351
            CALL MSGSIM(-1,II,II,II,II)                                         -044c4  87
            WRITE (IOUTPT,9004) (<ch:NAME>,II=1,8)                              Chlr1  352
            CALL MessageBox( NULL,                                              Chlr1  353
     &        'HW design temperature too high for'//char(10)//char(13)//        Chlr1  354
     &        ' loop-to-loop heat-pump'//char(0),                               Chlr1  355
     &        'DESIGN Errors'//char(0),                                         Chlr1  356
     &        MB_OK + MB_ICONSTOP + MB_TASKMODAL )                              Chlr1  357
              IwinReturn = 1                                                    Chlr1  358
          ENDIF                                                                 Chlr1  359
          IF (IwinReturn .EQ. 1)  RETURN                                        Chlr1  360
        CASE (13)  ! Waterside econo                                            -044c2   6
          <ch:COND-TYPE>     = 1                                                FreeCl  11
          <ch:SPECIFIED-AT>  = 2                                                MeterEU  1
          Jlp                = <ch:CW-LOOP>                                     FreeCl  14
          IQ                 = 1                                                FreeCl  15
          Jpe                = <lp;Jpe>                                         FreeCl  16
          <ch;FreeCoolTwr>   = <pe;Jparent>                                     FreeCl  17
          <ch:CW-DT>         = Abs(<lp:DESIGN-DT>)                              -044c2   7
          <ch:RATED-CW-FLOW> = 12000 / (<lp;BTUH/GPM-F> * <ch:CW-DT>)           FreeCl  19
          Jlp                = <ch:CHW-LOOP>                                    FreeCl  20
      END SELECT                                                                Chlr1  361
c              Centrifugal chillers may be rated at less than maximum           Chlr1  362
c              capacity; all others at 1.0                                      Chlr1  363
      IF (<ch:DESIGN-PLR> .EQ. 0.)  <ch:DESIGN-PLR> = 1.0                       Chlr1  364
c                                                                               Chlr1  365
c              Start of iterative loop on design condensing temperature         Chlr1  366
      Tlast  = -888.                                                            Chlr1  367
      RatEIR = <ch:EIR>                                                         Chlr1  368
      RatHIR = <ch:HIR>                                                         Chlr1  369
   10 SELECT CASE (<ch:COND-TYPE>)                                              Chlr1  370
        CASE (1)  ! water-cooled                                                Chlr1  371
c              rated condenser temperature rise                                 Chlr1  372
          Jlp = <ch:CW-LOOP>                                                    Chlr1  373
          QcwTon  = 12000 * (1. + RatEIR*<ch:ELEC-TO-COND>                      Chlr1  374
     &                          + RatHIR*<ch:HEAT-TO-COND>)                     Chlr1  375
          RatCWdT = QcwTon / (<lp;BTUH/GPM-F> * <ch:RATED-CW-FLOW>)             Chlr1  376
c              adjust for off-rated flow                                        Chlr1  377
          Tcond = <ch:DESIGN-COND-T> + MAX(0., <ch:CW-DT>-RatCWdT)              Chlr1  378
          Tcond = MIN(95., Tcond)                                               Chlr1  379
        CASE (2)  ! air-cooled, integral                                        Chlr1  380
          IF (<ch:DESIGN-COND-T> .NE. UNFILD)  THEN                             Chlr1  381
            Tcond = <ch:DESIGN-COND-T>                                          Chlr1  382
          ELSE                                                                  Chlr1  383
            Tcond = DBTmax                                                      Chlr1  384
          ENDIF                                                                 Chlr1  385
          Tcond = MIN(110., Tcond)                                              Chlr1  386
        CASE (3)  ! evaporative, integral                                       Chlr1  387
          Tcond = MIN(80., <ch:DESIGN-COND-T>)                                  Chlr1  388
        CASE (4)  ! air-cooled, remote                                          Chlr1  389
          Tcond = MIN(130., <ch:DESIGN-COND-T>)                                 Chlr1  390
        CASE (5)  ! evaporative, remote                                         Chlr1  391
          Tcond = MIN(130., <ch:DESIGN-COND-T>)                                 Chlr1  392
        CASE (-1) ! well serving loop-to-loop heat-pump                         Chlr1  393
c              rated condenser temperature rise                                 Chlr1  394
          Jlp = <ch:CW-LOOP>                                                    Chlr1  395
          RatCWdT = 12000 * (1. + RatEIR*<ch:ELEC-TO-COND>                      Chlr1  396
     &                          + RatHIR*<ch:HEAT-TO-COND>)                     Chlr1  397
     &                          / (<lp;BTUH/GPM-F> * <ch:RATED-CW-FLOW>)        Chlr1  398
c              adjust for off-rated flow                                        Chlr1  399
          Tcond = <ch:DESIGN-COND-T> + MAX(0., <ch:CW-DT>-RatCWdT)              Chlr1  400
          Tcond = MIN(95., Tcond)                                               Chlr1  401
      END SELECT                                                                Chlr1  402
      Tcond = MAX(<ch:MIN-COND-T>, Tcond)                                       Chlr1  403
      Jlp   = <ch:CHW-LOOP>                                                     Chlr1  404
c                                                                               Chlr1  405
c              Performance correction factors at design conditions              Chlr1  406
c              capacity, elec input ratio, heat input ratio                     Chlr1  407
      Cap_fDes = CVAL(<ch:CAP-FT>, <ch:DESIGN-CHW-T>, Tcond)                    Chlr1  408
      EIR_fDes = CVAL(<ch:EIR-FT>, <ch:DESIGN-CHW-T>, Tcond)                    Chlr1  409
      dT       = Tcond - <ch:DESIGN-CHW-T>                                      Chlr1  410
      fPLR     = CVAL(<ch:EIR-FPLR>, <ch:DESIGN-PLR>, dT)                       Chlr1  411
      EIR_fDes = EIR_fDes * fPLR                                                Chlr1  412
      HIR_fDes = CVAL(<ch:HIR-FT>, <ch:DESIGN-CHW-T>, Tcond)                    Chlr1  413
      fPLR     = CVAL(<ch:HIR-FPLR>, <ch:DESIGN-PLR>, dT)                       Chlr1  414
      HIR_fDes = HIR_fDes * fPLR                                                Chlr1  415
c              Performance correction factors at rated conditions (ARI)         Chlr1  416
c              normally, these should be 1.0 if curves fit correctly,           Chlr1  417
c              except EIR_fRat should be at the DESIGN-PLR                      Chlr1  418
      Cap_fRat = CVAL(<ch:CAP-FT>,<ch:RATED-CHW-T>,<ch:RATED-COND-T>)           Chlr1  419
      EIR_fRat = CVAL(<ch:EIR-FT>,<ch:RATED-CHW-T>,<ch:RATED-COND-T>)           Chlr1  420
      dT       = <ch:RATED-COND-T> - <ch:RATED-CHW-T>                           Chlr1  421
      fPLR     = CVAL(<ch:EIR-FPLR>, <ch:DESIGN-PLR>, dT)                       Chlr1  422
      EIR_fRat = EIR_fRat * fPLR                                                Chlr1  423
      HIR_fRat = CVAL(<ch:HIR-FT>,<ch:RATED-CHW-T>,<ch:RATED-COND-T>)           Chlr1  424
      fPLR     = CVAL(<ch:HIR-FPLR>, <ch:DESIGN-PLR>, dT)                       Chlr1  425
      HIR_fRat = HIR_fRat * fPLR                                                Chlr1  426
c              Translate the EIRs                                               Chlr1  427
      SELECT CASE (<ch:SPECIFIED-AT>)                                           MeterEU  2
        CASE (1)  ! Rated conditions                                            Chlr1  429
          RatEIR = <ch:EIR>                                                     Chlr1  430
          RatHIR = <ch:HIR>                                                     Chlr1  431
          DesEIR = <ch:EIR> * EIR_fDes/EIR_fRat                                 Chlr1  432
          DesHIR = <ch:HIR> * HIR_fDes/HIR_fRat                                 Chlr1  433
        CASE (2)  ! Design conditions                                           Chlr1  434
          DesEIR = <ch:EIR>                                                     Chlr1  435
          DesHIR = <ch:HIR>                                                     -045h    3
          RatEIR = <ch:EIR> * EIR_fRat/EIR_fDes                                 Chlr1  437
          RatHIR = <ch:HIR> * HIR_fRat/HIR_fDes                                 Chlr1  438
      END SELECT                                                                Chlr1  439
c              Check if converged on condenser temperature                      Chlr1  440
      IF (ABS(Tcond-Tlast) .GT. 0.01)  THEN                                     Chlr1  441
        Tlast = Tcond                                                           Chlr1  442
        GOTO 10                                                                 Chlr1  443
      ENDIF                                                                     Chlr1  444
c              Set power ratios to be at rated condition                        Chlr1  445
      <ch:EIR> = RatEIR                                                         Chlr1  446
      <ch:HIR> = RatHIR                                                         Chlr1  447
c                                                                               Chlr1  448
c              design condenser water flow, gpm/ton                             Chlr1  449
      SELECT CASE (<ch:COND-TYPE>)                                              Chlr1  450
        CASE (1,-1)  ! water-cooled                                             Chlr1  451
          Jlp = <ch:CW-LOOP>                                                    Chlr1  452
          QcwTon = 12000 * (1. + DesEIR*<ch:ELEC-TO-COND>                       Chlr1  453
     &                         + DesHIR*<ch:HEAT-TO-COND>)                      Chlr1  454
          CWgpmTon = QcwTon / (<lp;BTUH/GPM-F> * <ch:CW-DT>)                    Chlr1  455
          IF (<ch:COND-TYPE> .EQ. -1)  THEN                                     Chlr1  456
            Jlp      = <ch:HW-LOOP>                                             Chlr1  457
            HWgpmTon = QcwTon / (<lp;BTUH/GPM-F> * <ch:CW-DT>)                  Chlr1  458
          ENDIF                                                                 Chlr1  459
          Jlp = <ch:CHW-LOOP>                                                   Chlr1  460
      END SELECT                                                                Chlr1  461
c                                                                               Chlr1  462
c              Performance factors for chillers that can provide heat           Chlr1  463
      SELECT CASE (<ch:ALGORITHM>)                                              Chlr1  464
        CASE (104)   ! Chiller/heater                                           Chlr1  465
          Cap_fDesH = 1.                                                        Chlr1  466
          Cap_fRatH = 1.                                                        -041     1
        CASE (106)  ! Heat-pump chiller                                         Chlr1  467
c              Note that condenser references here are actually the             Chlr1  468
c              evaporator when in heating mode                                  Chlr1  469
          SELECT CASE (<ch:COND-TYPE>)                                          Chlr1  470
            CASE (1)  ! water-cooled                                            Chlr1  471
              Jlp     = <ch:CW-LOOP>                                            Chlr1  472
              Tlast   = -888.                                                   Chlr1  473
              RatEIRh = <ch:HEAT-EIR>                                           Chlr1  474
              DesEIRh = <ch:HEAT-EIR>                                           Chlr1  475
c                 Start of iterative loop on design condensing temperature      Chlr1  476
   20         RatCWdT = 12000 * <ch:HEAT/COOL-CAP>                              Chlr1  477
     &                * (1. - RatEIRh*<ch:ELEC-TO-COND>)                        Chlr1  478
     &                / (<lp;BTUH/GPM-F>                                        Chlr1  479
     &                       * <ch:RATED-CW-FLOW>*<ch:RATED-HT/CL-F>)           Chlr1  480
c                 adjust for off-rated flow                                     Chlr1  481
              TcondH = <ch:DESIGN-COND-H>+MIN(0., <ch:CW-DT-HT>+RatCWdT)        Chlr1  482
              Jlp    = <ch:CHW-LOOP>                                            Chlr1  483
c                                                                               Chlr1  484
c                 Performance correction factors at design conditions           Chlr1  485
c                 capacity, elec input ratio, heat input ratio                  Chlr1  486
              Cap_fDesH = CVAL(<ch:HEAT-CAP-FT>,<ch:DESIGN-HW-T>,TcondH)        Chlr1  487
              EIR_fDesH = CVAL(<ch:HEAT-EIR-FT>,<ch:DESIGN-HW-T>,TcondH)        Chlr1  488
              dT        = <ch:DESIGN-HW-T> - TcondH                             Chlr1  489
              fPLR      = CVAL(<ch:HEAT-EIR-FPLR>, <ch:DESIGN-PLR>, dT)         Chlr1  490
              EIR_fDesH = EIR_fDesH * fPLR                                      Chlr1  491
c                 Performance correction factors at rated conditions (ARI)      Chlr1  492
c                 normally, these should be 1.0 if curves fit correctly,        Chlr1  493
c                 except EIR_fRat should be at the DESIGN-PLR                   Chlr1  494
              Cap_fRatH = CVAL(<ch:HEAT-CAP-FT>,<ch:RATED-HW-T>,                Chlr1  495
     &                                          <ch:RATED-COND-TH>)             Chlr1  496
              EIR_fRatH = CVAL(<ch:HEAT-EIR-FT>,<ch:RATED-HW-T>,                Chlr1  497
     &                                          <ch:RATED-COND-TH>)             Chlr1  498
              dT        = <ch:RATED-HW-T> - <ch:RATED-COND-TH>                  Chlr1  499
              fPLR      = CVAL(<ch:HEAT-EIR-FPLR>, <ch:DESIGN-PLR>, dT)         Chlr1  500
              EIR_fRatH = EIR_fRatH * fPLR                                      Chlr1  501
c                 Translate the EIRs                                            Chlr1  502
              SELECT CASE (<ch:SPECIFIED-AT>)                                   MeterEU  3
                CASE (1)  ! Rated conditions                                    Chlr1  504
                  RatEIRh = <ch:HEAT-EIR>                                       Chlr1  505
                  DesEIRh = <ch:HEAT-EIR> * EIR_fDesH/EIR_fRatH                 Chlr1  506
                CASE (2)  ! Design conditions                                   Chlr1  507
                  DesEIRh = <ch:HEAT-EIR>                                       Chlr1  508
                  RatEIRh = <ch:HEAT-EIR> * EIR_fRatH/EIR_fDesH                 Chlr1  509
              END SELECT                                                        Chlr1  510
c                 Check if converged on condenser temperature                   Chlr1  511
              IF (ABS(TcondH-Tlast) .GT. 0.01)  THEN                            Chlr1  512
                Tlast = TcondH                                                  Chlr1  513
                GOTO 20                                                         Chlr1  514
              ENDIF                                                             Chlr1  515
            CASE (2)  ! air-cooled, integral                                    Chlr1  516
c                 Design conditions                                             Chlr1  517
              IF (<ch:DESIGN-COND-H> .NE. UNFILD)  THEN                         Chlr1  518
                TcondH = <ch:DESIGN-COND-H>                                     Chlr1  519
              ELSE                                                              Chlr1  520
                TcondH = DBTmin                                                 Chlr1  521
              ENDIF                                                             Chlr1  522
              dT   = <ch:DESIGN-HW-T> - TcondH                                  Chlr1  523
              fPLR = CVAL(<ch:HEAT-EIR-FPLR>, <ch:DESIGN-PLR>, dT)              Chlr1  524
              IF (TcondH .GT. 39.)  THEN                                        Chlr1  525
                Cap_fDesH = CVAL(<ch:HEAT-CAP-FT>,<ch:DESIGN-HW-T>,             Chlr1  526
     &                                                           TcondH)        Chlr1  527
                EIR_fDesH = CVAL(<ch:HEAT-EIR-FT>,<ch:DESIGN-HW-T>,             Chlr1  528
     &                                                           TcondH)        Chlr1  529
                EIR_fDesH = EIR_fDesH * fPLR                                    Chlr1  530
              ELSE                                                              Chlr1  531
                Cap_fDesH = CVAL(<ch:HEAT-CAP-FRST>,<ch:DESIGN-HW-T>,           Chlr1  532
     &                                                           TcondH)        Chlr1  533
                EIR_fDesH = CVAL(<ch:HEAT-EIR-FRST>,<ch:DESIGN-HW-T>,           Chlr1  534
     &                                                           TcondH)        Chlr1  535
                EIR_fDesH = EIR_fDesH * fPLR                                    Chlr1  536
              ENDIF                                                             Chlr1  537
c                 Rated conditions                                              Chlr1  538
              dT   = <ch:RATED-HW-T> - <ch:RATED-COND-TH>                       Chlr1  539
              fPLR = CVAL(<ch:HEAT-EIR-FPLR>, <ch:DESIGN-PLR>, dT)              Chlr1  540
              IF (TcondH .GT. 39.)  THEN                                        Chlr1  541
                Cap_fRatH = CVAL(<ch:HEAT-CAP-FT>,<ch:RATED-HW-T>,              Chlr1  542
     &                                            <ch:RATED-COND-TH>)           Chlr1  543
                EIR_fRatH = CVAL(<ch:HEAT-EIR-FT>,<ch:RATED-HW-T>,              Chlr1  544
     &                                            <ch:RATED-COND-TH>)           Chlr1  545
                EIR_fRatH = EIR_fRatH * fPLR                                    Chlr1  546
              ELSE                                                              Chlr1  547
                Cap_fRatH = CVAL(<ch:HEAT-CAP-FRST>,<ch:RATED-HW-T>,            Chlr1  548
     &                                              <ch:RATED-COND-TH>)         Chlr1  549
                EIR_fRatH = CVAL(<ch:HEAT-EIR-FRST>,<ch:RATED-HW-T>,            Chlr1  550
     &                                              <ch:RATED-COND-TH>)         Chlr1  551
                EIR_fRatH = EIR_fRatH * fPLR                                    Chlr1  552
              ENDIF                                                             Chlr1  553
c                 Translate the EIRs                                            Chlr1  554
              SELECT CASE (<ch:SPECIFIED-AT>)                                   MeterEU  4
                CASE (1)  ! Rated conditions                                    Chlr1  556
                  RatEIRh = <ch:HEAT-EIR>                                       Chlr1  557
                  DesEIRh = <ch:HEAT-EIR> * EIR_fDesH/EIR_fRatH                 Chlr1  558
                CASE (2)  ! Design conditions                                   Chlr1  559
                  DesEIRh = <ch:HEAT-EIR>                                       Chlr1  560
                  RatEIRh = <ch:HEAT-EIR> * EIR_fRatH/EIR_fDesH                 Chlr1  561
              END SELECT                                                        Chlr1  562
          END SELECT                                                            Chlr1  563
c              Set power ratios to be at rated condition                        Chlr1  564
          <ch:HEAT-EIR> = RatEIRh                                               Chlr1  565
        CASE (107)  ! Loop-to-loop heat-pump chiller                            Chlr1  566
          Tchwr       = <ch:EVAP-HX-DES-T>                                      Chlr1  567
          Tchws       = Tchwr - <ch:CHW-DT>                                     Chlr1  568
          TcondH      = <ch:DESIGN-HW-T> + <ch:HW-DT>                           Chlr1  569
          Tlast       = -888.                                                   Chlr1  570
          TlastH      = -888.                                                   Chlr1  571
          DO                                                                    Chlr1  572
            Cap_fDesH = CVAL(<ch:CAP-FT>, Tchws, TcondH)                        Chlr1  573
            EIR_fDesH = CVAL(<ch:EIR-FT>, Tchws, TcondH)                        Chlr1  574
            dT        = TcondH - Tchws                                          Chlr1  575
            fPLR      = CVAL(<ch:EIR-FPLR>, <ch:DESIGN-PLR>, dT)                Chlr1  576
            EIR_fDesH = EIR_fDesH * fPLR                                        Chlr1  577
            DesEIRh   = <ch:EIR> * EIR_fDesH                                    Chlr1  578
            DesHWdT   = 12000 * Cap_fDesH                                       Chlr1  579
     &                        * (1. + DesEIRh*<ch:ELEC-TO-COND>)                Chlr1  580
     &                        / (<lp;BTUH/GPM-F> * CWgpmTon)                    Chlr1  581
            RatHWdT   = DesHWdT * CWgpmTon/<ch:RATED-CW-FLOW>                   Chlr1  582
            TcondH    = <ch:DESIGN-HW-T> - RatHWdT                              Chlr1  583
            Tchws     = Tchwr - <ch:CHW-DT>*Cap_fDesH/Cap_fDes                  Chlr1  584
            IF (ABS(Tchws-Tlast) .LT. 0.01  .AND.                               Chlr1  585
     &                              ABS(TcondH-TlastH) .LT. 0.01)  EXIT         Chlr1  586
            Tlast  = Tchws                                                      Chlr1  587
            TlastH = TcondH                                                     Chlr1  588
          ENDDO                                                                 Chlr1  589
c              translate from cooling to heat rejection                         Chlr1  590
          Cap_fDesH = Cap_fDesH * (1. + DesEIRh*<ch:ELEC-TO-COND>)              Chlr1  591
      END SELECT                                                                Chlr1  592
c                                                                               Chlr1  593
c              Chiller size                                                     Chlr1  594
      DefaultCap = 0.                                                           Chlr1  595
      IF (<ch:CAP> .GT. 0.)  THEN                                               MeterEU  5
        SELECT CASE (<ch:SPECIFIED-AT>)                                         MeterEU  6
          CASE (1)                                                              MeterEU  7
c              Capacity specified at rated conditions, translate to             MeterEU  8
c              design conditions                                                MeterEU  9
            DesignCap  = <ch:CAP> * Cap_fDes/Cap_fRat                           MeterEU 10
c              chillers that can provide heat                                   MeterEU 11
            SELECT CASE (<ch:ALGORITHM>)                                        MeterEU 12
              CASE (104,106)  ! gas-fired, 2-pipe heat-pump                     MeterEU 13
                RatedCapH  = -<ch:CAP> * <ch:HEAT/COOL-CAP>                     MeterEU 14
                DesignCapH = RatedCapH * Cap_fDesH/Cap_fRatH                    MeterEU 15
              CASE (107)  ! loop-to-loop heat-pump                              MeterEU 16
                RatedCapH  = -<ch:CAP>                                          MeterEU 17
     &                           * (1.+RatEIR*<ch:ELEC-TO-COND>)                MeterEU 18
                DesignCapH = -<ch:CAP> * Cap_fDesH                              MeterEU 19
              CASE DEFAULT                                                      MeterEU 20
                RatedCapH  = 0.                                                 MeterEU 21
                DesignCapH = 0.                                                 MeterEU 22
            END SELECT                                                          MeterEU 23
c                                                                               MeterEU 24
          CASE (2)                                                              MeterEU 25
c              Capacity specified at design conditions, translate to            MeterEU 26
c              rated conditions                                                 MeterEU 27
            DesignCap = <ch:CAP>                                                MeterEU 28
            <ch:CAP>  = <ch:CAP> * Cap_fRat/Cap_fDes                            MeterEU 29
c              chillers that can provide heat                                   MeterEU 30
            SELECT CASE (<ch:ALGORITHM>)                                        MeterEU 31
              CASE (104,106)  ! gas-fired, 2-pipe heat-pump                     MeterEU 32
                RatedCapH  = -<ch:CAP> * <ch:HEAT/COOL-CAP>                     MeterEU 33
                DesignCapH = RatedCapH * Cap_fDesH/Cap_fRatH                    MeterEU 34
              CASE (107)  ! loop-to-loop heat-pump                              MeterEU 35
                RatedCapH  = -<ch:CAP>                                          MeterEU 36
     &                           * (1.+RatEIR*<ch:ELEC-TO-COND>)                MeterEU 37
                DesignCapH = -<ch:CAP> * Cap_fDesH                              MeterEU 38
              CASE DEFAULT                                                      MeterEU 39
                RatedCapH  = 0.                                                 MeterEU 40
                DesignCapH = 0.                                                 MeterEU 41
            END SELECT                                                          MeterEU 42
        END SELECT  ! ch:SPECIFIED-AT                                           MeterEU 43
      ELSE                                                                      MeterEU 44
c              Auto-size chillers                                               MeterEU 45
        Jlp = <ch:CHW-LOOP>                                                     MeterEU 46
        IF (<ch:CAP-RATIO> .EQ. 0.)  THEN                                       -042L2   2
c              no capacity ratio specified - size equipment equally             MeterEU 48
          DefaultCap = <lp;DES_CCAP> / FLOAT(<lp;CL_NUM_EQUIP>)                 MeterEU 49
        ELSE                                                                    MeterEU 50
          DefaultCap = <lp;DES_CCAP> * <ch:CAP-RATIO>                           MeterEU 51
        ENDIF                                                                   MeterEU 52
c              design and rated capacity                                        MeterEU 53
        DesignCap = DefaultCap                                                  MeterEU 54
        <ch:CAP>  = DefaultCap * Cap_fRat/Cap_fDes                              MeterEU 55
c              chillers that can heat                                           MeterEU 56
        SELECT CASE (<ch:ALGORITHM>)                                            MeterEU 57
          CASE (104)  ! Chiller/heater                                          MeterEU 58
            IF (<ch:HW-LOOP> .EQ. 0)  THEN                                      MeterEU 59
              DesignCapH = 0.                                                   MeterEU 60
            ELSE                                                                MeterEU 61
              Jlp = <ch:HW-LOOP>                                                MeterEU 62
              IF (<ch:CAP-RATIO> .EQ. 0.)  THEN                                 -042L2   3
                DesignCapH = <lp;DES_HCAP> / FLOAT(<lp;HT_NUM_EQUIP>)           MeterEU 64
              ELSE                                                              MeterEU 65
                DesignCapH = <lp;DES_HCAP> * <ch:CAP-RATIO>                     MeterEU 66
              ENDIF                                                             MeterEU 67
            ENDIF                                                               MeterEU 68
            RatedCapH  = DesignCapH / Cap_fDesH                                 MeterEU 69
            <ch:CAP>   = MAX(<ch:CAP>, -RatedCapH/<ch:HEAT/COOL-CAP>)           MeterEU 70
            DesignCap  = <ch:CAP>  * Cap_fDes/Cap_fRat                          MeterEU 71
            RatedCapH  = -<ch:CAP> * <ch:HEAT/COOL-CAP>                         MeterEU 72
            DesignCapH = RatedCapH * Cap_fDesH                                  MeterEU 73
          CASE (106)  ! 2-pipe heat-pump                                        MeterEU 74
            Jlp = <ch:CHW-LOOP>                                                 MeterEU 75
            IF (<ch:CAP-RATIO> .EQ. 0.)  THEN                                   -042L2   4
              DesignCapH = <lp;DES_HCAP> / FLOAT(<lp;HT_NUM_EQUIP>)             MeterEU 77
            ELSE                                                                MeterEU 78
              DesignCapH = <lp;DES_HCAP> * <ch:CAP-RATIO>                       MeterEU 79
            ENDIF                                                               MeterEU 80
            RatedCapH  = DesignCapH * Cap_fRatH/Cap_fDesH                       MeterEU 81
            <ch:CAP>   = MAX(<ch:CAP>, -RatedCapH/<ch:HEAT/COOL-CAP>)           MeterEU 82
            DesignCap  = <ch:CAP>  * Cap_fDes/Cap_fRat                          MeterEU 83
            RatedCapH  = -<ch:CAP> * <ch:HEAT/COOL-CAP>                         MeterEU 84
            DesignCapH = RatedCapH * Cap_fDesH/Cap_fRatH                        MeterEU 85
          CASE (107)  ! loop-to-loop heat-pump                                  MeterEU 86
            Jlp = <ch:HW-LOOP>                                                  MeterEU 87
            IF (<ch:CAP-RATIO> .EQ. 0.)  THEN                                   -042L2   5
              DesignCapH = <lp;DES_HCAP> / FLOAT(<lp;HT_NUM_EQUIP>)             MeterEU 89
            ELSE                                                                MeterEU 90
              DesignCapH = <lp;DES_HCAP> * <ch:CAP-RATIO>                       MeterEU 91
            ENDIF                                                               MeterEU 92
            <ch:CAP>   = MAX(<ch:CAP>, -DesignCapH/Cap_fDesH)                   MeterEU 93
            DesignCap  = <ch:CAP> * Cap_fDes/Cap_fRat                           MeterEU 94
            DesignCapH = -<ch:CAP> * Cap_fDesH                                  MeterEU 95
            RatedCapH  = -<ch:CAP> * (1.+RatEIR*<ch:ELEC-TO-COND>)              MeterEU 96
        END SELECT  ! ch:ALGORITHM                                              MeterEU 97
      ENDIF  ! ch:CAP .gt. 0                                                    MeterEU 98
      Jlp = <ch:CHW-LOOP>                                                       Chlr1  689
c              for absorption chillers, recalculate EIR if solution pump        Chlr1  690
c              and/or combustion fan kw specified                               Chlr1  691
      IF (<ch:SOLN-PMP-KW>+<ch:FAN-KW> .GT. 0)  THEN                            -044c4  88
        <ch:EIR> = (<ch:SOLN-PMP-KW>+<ch:FAN-KW>)*BTUKW / <ch:CAP>              -044c4  89
        <ch;Pump/TotalKW> = <ch:SOLN-PMP-KW>                                    -044c4  90
     &                              / (<ch:SOLN-PMP-KW>+<ch:FAN-KW>)            -044c4  91
      ELSE  ! assume for chiller/heater pumps are 70% of total kW               -044c4  92
        <ch;Pump/TotalKW> = 0.7                                                 -044c4  93
      ENDIF                                                                     -044c4  94
c                                                                               Chlr1  694
c              Evaporator interactions                                          Chlr1  695
      Jlp  = <ch:CHW-LOOP>                                                      Chlr1  696
c              evaporator flow - greater of load or flow requirement            Chlr1  697
      GPMload = DesignCap / (<lp;BTUH/GPM-F>*<ch:CHW-DT>)                       Chlr1  698
      GPMflow = <lp;DES_GPM> * MIN(1., DesignCap/<lp;DES_CCAP>)                 Chlr1  699
      GPM     = MAX(GPMload, GPMflow)                                           Chlr1  700
c              convert min/max flows from fraction to gpm                       Chlr1  701
      <ch:CHW-MIN-GPM> = GPM * <ch:CHW-MIN-GPM>                                 Chlr1  702
      <ch:CHW-MAX-GPM> = GPM * <ch:CHW-MAX-GPM>                                 Chlr1  703
      IF (<ch:CHW-MAX-GPM> .LT. <lp:RECIRC-GPM>  .OR.                           Chlr1  704
     &    <ch:CHW-MAX-GPM> .LT. <lp:MIN-GPM>)    THEN                           Chlr1  705
        CALL MSGSIM(-3,II,II,II,II)                                             Chlr1  706
        WRITE (IOUTPT, 9001)  (<ch:NAME>,II=1,8)                                Chlr1  707
      ENDIF                                                                     Chlr1  708
      IF (<ch:CHW-PUMP> .GT. 0)  THEN                                           Chlr1  709
c              design the attached chw pump                                     Chlr1  710
        Jpm     = <ch:CHW-PUMP>                                                 Chlr1  711
        GPMpump = MIN(GPM, <lp;DES_GPM>)                                        Chlr1  712
        CALL PUMPdes(GPMpump)                                                   Chlr1  713
c              increase default size by pump heat                               Chlr1  714
        IF (DefaultCap .GT. 0.)  THEN                                           Chlr1  715
          IF (ABS(1.-DefaultCap/DesignCap) .LT. 0.001)  THEN                    Chlr1  716
c              capacity set by cooling mode of chiller                          Chlr1  717
            DesignCap = DefaultCap + Qpump                                      Chlr1  718
            <ch:CAP>  = DesignCap * Cap_fRat/Cap_fDes                           Chlr1  719
            SELECT CASE (<ch:ALGORITHM>)                                        Chlr1  720
              CASE (104,106)                                                    Chlr1  721
                RatedCapH  = -<ch:CAP> * <ch:HEAT/COOL-CAP>                     Chlr1  722
                DesignCapH = RatedCapH * Cap_fDesH/Cap_fRatH                    Chlr1  723
              CASE (107)                                                        Chlr1  724
                DesignCapH = -<ch:CAP> * Cap_fDesH                              Chlr1  725
                RatedCapH  = -<ch:CAP> * (1.+RatEIR*<ch:ELEC-TO-COND>)          Chlr1  726
            END SELECT                                                          Chlr1  727
          ELSE                                                                  Chlr1  728
c              capacity set by heating mode of chiller                          Chlr1  729
            DesignCapH  = DesignCapH + Qpump                                    Chlr1  730
            SELECT CASE (<ch:ALGORITHM>)                                        Chlr1  731
              CASE (104,106)  ! gas-fired and HP chillers                       Chlr1  732
                RatedCapH = DesignCapH *Cap_fRatH/Cap_fDesH                     Chlr1  733
                <ch:CAP>  = -RatedCapH / <ch:HEAT/COOL-CAP>                     Chlr1  734
                DesignCap = <ch:CAP> * Cap_fDes/Cap_fRat                        Chlr1  735
              CASE (107)  ! Loop-to-loop HP                                     Chlr1  736
                <ch:CAP>  = -DesignCapH / Cap_fDesH                             Chlr1  737
                DesignCap = <ch:CAP> * Cap_fDes/Cap_fRat                        Chlr1  738
                RatedCapH = -<ch:CAP> * (1.+RatEIR*<ch:ELEC-TO-COND>)           Chlr1  739
            END SELECT                                                          Chlr1  740
          ENDIF                                                                 Chlr1  741
        ENDIF                                                                   Chlr1  742
c              store pump heat as parasitic load for hourly OpCap calc          Chlr1  743
        Jpe = <ch;Jpe>                                                          Chlr1  744
        <pe;Q_PARASITIC> = Qpump                                                Chlr1  745
        <pm;MIN_GPM>     = <ch:CHW-MIN-GPM>                                     Chlr1  746
      ELSE                                                                      Chlr1  747
        Qpump = 0.                                                              Chlr1  748
c              error if not attached or loop pump                               Chlr1  749
        IF (<lp:PUMP> .EQ. 0)  THEN                                             Chlr1  750
          CALL MSGSIM(-1,II,II,II,II)                                           Chlr1  751
          WRITE (IOUTPT,9104) (<ch:NAME>,II=1,8),                               Chlr1  752
     &                        (<lp:NAME>,II=1,8)                                Chlr1  753
        ENDIF                                                                   Chlr1  755
c              warn if loop pressure drop different than others                 Chlr1  756
        IF (ABS(<ch:CHW-HEAD>+<ch:CHW-STATIC>                                   Chlr1  757
     &     - (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>))                           Chlr1  758
     &      / (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>) .GT. 0.05)  THEN          Chlr1  759
          CALL MSGSIM(-3,II,II,II,II)                                           Chlr1  760
          WRITE (IOUTPT,9107)  (<ch:NAME>,II=1,8),                              Chlr1  761
     &                         (<lp:NAME>,II=1,8)                               Chlr1  762
        ENDIF                                                                   Chlr1  763
      ENDIF                                                                     Chlr1  764
c              loop equipment capacity                                          Chlr1  765
      IF (<ch:TYPE> .NE. 13)                                                    FreeCl  21
     &  <lp;PRIMARY_CCAP> = <lp;PRIMARY_CCAP> + DesignCap                       FreeCl  22
c              chillers that can heat                                           Chlr1  767
      <ch;HEAT_CAP> = RatedCapH                                                 Chlr1  768
      SELECT CASE (<ch:ALGORITHM>)                                              Chlr1  769
        CASE (106) ! 2-pipe heat-pump                                           Chlr1  770
          <lp;PRIMARY_HCAP> = <lp;PRIMARY_HCAP> + DesignCapH                    Chlr1  771
        CASE (104,107)  ! gas-fired, loop-to-loop heat-pump                     Chlr1  772
          IF (<ch:HW-LOOP> .GT. 0)  THEN                                        Chlr1  773
            Jlp               = <ch:HW-LOOP>                                    Chlr1  774
            <lp;PRIMARY_HCAP> = <lp;PRIMARY_HCAP> + DesignCapH                  Chlr1  775
          ENDIF                                                                 Chlr1  776
      END SELECT                                                                Chlr1  777
c                                                                               Chlr1  778
c              Capacity and power at MAX-RATIO                                  Chlr1  779
      <ch;NormalCap> = <ch:CAP> * 1./<ch:DESIGN-PLR> / Cap_fRat                 Chlr1  780
      <ch;NormalEIR> = <ch:EIR> * <ch:DESIGN-PLR> / EIR_fRat                    -041k    1
      <ch;NormalHIR> = <ch:HIR> / HIR_fRat                                      Chlr1  782
c              Chillers that can heat                                           Chlr1  783
      SELECT CASE (<ch:ALGORITHM>)                                              Chlr1  784
        CASE (106)  ! 2-pipe heat-pump                                          Chlr1  785
          <ch;NormalCapHt>  = RatedCapH * 1./<ch:DESIGN-PLR> / Cap_fRatH        Chlr1  786
          <ch;NormalEIR Ht> = <ch:HEAT-EIR> / EIR_fRatH                         Chlr1  787
        CASE (107)  ! loop-to-loop heat-pump                                    Chlr1  788
      END SELECT                                                                Chlr1  789
c                                                                               Chlr1  790
c              set up the start up loads                                        Chlr1  791
      Jpe = <ch;Jpe>                                                            Chlr1  792
      CALL StartUpLoad_Design(Jpe, <ch:CAP>, <ch:START-TIME>)                   Chlr1  793
c              design power and fuel consumption                                Chlr1  794
      <ch;DES_KW>   = DesignCap * DesEIR * KWBTU                                Chlr1  795
      <ch;DES_KW>   = <ch;DES_KW> + <ch:AUX-KW>                                 Chlr1  796
      <ch;DES_FUEL> = DesignCap * DesHIR                                        Chlr1  797
      IF (<ch:ALGORITHM> .EQ. Chiller_Absor1)                                   Chlr1  798
     &  <ch;DES_FUEL> = -<ch;DES_FUEL>                                          Chlr1  799
c              save design variables for use in PrimaryEquip                    Chlr1  800
      <pe:MIN-RATIO>   = <ch:MIN-RATIO>                                         Chlr1  801
      <pe;DES_AUX_KW>  = <ch:AUX-KW>                                            Chlr1  802
      <pe:ISOLATION>   = 1                                                      Chlr1  803
      <pe;Jpm>         = <ch:CHW-PUMP>                                          Chlr1  804
      <pe;DES_GPM>     = GPM                                                    Chlr1  805
      <ch;DES_CHW_GPM> = GPM                                                    Chlr1  806
      <pe;MAX_GPM>     = <ch:CHW-MAX-GPM>                                       Chlr1  807
      <pe;DES_HEAD>    = <ch:CHW-HEAD>                                          Chlr1  808
      <pe;DES_STATIC>  = <ch:CHW-STATIC>                                        Chlr1  809
c              condenser energy                                                 Chlr1  810
      Qcond = DesignCap                                                         Chlr1  811
     &      * (1. + (DesEIR*<ch:ELEC-TO-COND> +                                 Chlr1  812
     &               DesHIR*<ch:HEAT-TO-COND>) )                                Chlr1  813
c              include jacket heat in condenser energy for engine chiller       Chlr1  814
      IF (<ch:ALGORITHM> .EQ. Chiller_Engine1)  THEN                            Chlr1  815
        Qjacket = DesignCap * DesHIR * <ch:HEAT-TO-JAC>                         Chlr1  816
        Qcond   = Qcond + Qjacket                                               Chlr1  817
      ENDIF                                                                     Chlr1  818
      <ch;DES_QCOND> = Qcond                                                    Chlr1  819
c                                                                               Chlr1  820
c              Hot-water loop interactions                                      Chlr1  821
      IF (<ch:ALGORITHM> .EQ. Chiller_Absor1)  THEN                             Chlr1  822
c              Hot-water absorption chillers                                    Chlr1  823
        Jlp = <ch:HW-LOOP>                                                      Chlr1  824
c              hw loop load                                                     Chlr1  825
        QHW = -DesignCap * DesHIR                                               Chlr1  826
c              hw flow                                                          Chlr1  827
        GPM = QHW / (<lp;BTUH/GPM-F>*<ch:HW-DT>)                                Chlr1  828
c              convert minimum flow from fraction to gpm                        Chlr1  829
        <ch:HW-MIN-GPM> = GPM * <ch:HW-MIN-GPM>                                 Chlr1  830
c              design the hw equipment pump                                     Chlr1  831
        IF (<ch:HW-PUMP> .GT. 0)  THEN                                          Chlr1  832
          Jpm  = <ch:HW-PUMP>                                                   Chlr1  833
          CALL PUMPdes(GPM)                                                     Chlr1  834
c              adjust hw load by pump heat                                      Chlr1  835
          QHW = QHW - Qpump                                                     Chlr1  836
c              store design variables for use in pump calcs                     Chlr1  837
          <pm;MIN_GPM> = <ch:HW-MIN-GPM>                                        Chlr1  838
        ELSE                                                                    Chlr1  839
c              error if no attached or loop pump                                Chlr1  840
          IF (<lp:PUMP> .EQ. 0)  THEN                                           Chlr1  841
            CALL MSGSIM(-1,II,II,II,II)                                         Chlr1  842
            WRITE (IOUTPT,9104) (<ch:NAME>,II=1,8),                             Chlr1  843
     &                          (<lp:NAME>,II=1,8)                              Chlr1  844
          ENDIF                                                                 Chlr1  846
c              warn if loop pressure drop different than others                 Chlr1  847
          IF (ABS(<ch:HW-HEAD>+<ch:HW-STATIC>                                   Chlr1  848
     &       - (<lp;DEM-SIDE_HEAD>+<lp;DEM-SIDE_STAT>))                         Chlr1  849
     &      / (<lp;DEM-SIDE_HEAD>+<lp;DEM-SIDE_STAT>) .GT. 0.05)  THEN          Chlr1  850
            CALL MSGSIM(-3,II,II,II,II)                                         Chlr1  851
            WRITE (IOUTPT,9107) (<ch:NAME>,II=1,8),                             Chlr1  852
     &                          (<lp:NAME>,II=1,8)                              Chlr1  853
          ENDIF                                                                 Chlr1  854
          <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                          Chlr1  855
     &                             <ch:HW-HEAD>)                                Chlr1  856
        ENDIF                                                                   Chlr1  857
c              pass hw load and flow onto hw loop                               Chlr1  858
        <lp;COIL_HEAT>  = <lp;COIL_HEAT> + QHW                                  Chlr1  859
        <lp;GPM>        = <lp;GPM>  + GPM                                       Chlr1  860
        <ch;DES_FUEL>   = QHW                                                   Chlr1  861
        <ch;DES_HW_GPM> = GPM                                                   Chlr1  862
      ELSEIF (<ch:ALGORITHM> .EQ. Chiller_Gas1  .AND.                           Chlr1  863
     &                                      <ch:HW-LOOP> .GT. 0)  THEN          Chlr1  864
c              Gas-fired absorption chillers                                    Chlr1  865
        Jlp = <ch:HW-LOOP>                                                      Chlr1  866
c              hw flow                                                          Chlr1  867
        GPM = DesignCapH / (<lp;BTUH/GPM-F>*<ch:HW-DT>)                         Chlr1  868
c              convert min/max flows from fraction to gpm                       Chlr1  869
        <ch:HW-MIN-GPM> = GPM * <ch:HW-MIN-GPM>                                 Chlr1  870
        <ch:HW-MAX-GPM> = GPM * <ch:HW-MAX-GPM>                                 Chlr1  871
c              design the hw equipment pump                                     Chlr1  872
        IF (<ch:HW-PUMP> .GT. 0)  THEN                                          Chlr1  873
          Jpm = <ch:HW-PUMP>                                                    Chlr1  874
          Jpe = <ch;Jpe_HEAT>                                                   Chlr1  875
          CALL PUMPdes(GPM)                                                     Chlr1  876
c              store pump heat as parasitic load for hourly OpCap calc          Chlr1  877
          <pe;Q_PARASITIC> = Qpump                                              Chlr1  878
c              store design variables for use in pump calcs                     Chlr1  879
          <pm;MIN_GPM> = <ch:HW-MIN-GPM>                                        Chlr1  880
        ELSE                                                                    Chlr1  881
c              error if no attached or loop pump                                Chlr1  882
          IF (<lp:PUMP> .EQ. 0)  THEN                                           Chlr1  883
            CALL MSGSIM(-1,II,II,II,II)                                         Chlr1  884
            WRITE (IOUTPT,9104) (<ch:NAME>,II=1,8),                             Chlr1  885
     &                          (<lp:NAME>,II=1,8)                              Chlr1  886
          ENDIF                                                                 Chlr1  888
c              warn if loop pressure drop different than others                 Chlr1  889
          IF (ABS(<ch:HW-HEAD>+<ch:HW-STATIC>                                   Chlr1  890
     &       - (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>))                         Chlr1  891
     &      / (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>) .GT. 0.05)  THEN          Chlr1  892
            CALL MSGSIM(-3,II,II,II,II)                                         Chlr1  893
            WRITE (IOUTPT,9107) (<ch:NAME>,II=1,8),                             Chlr1  894
     &                          (<lp:NAME>,II=1,8)                              Chlr1  895
          ENDIF                                                                 Chlr1  896
        ENDIF                                                                   Chlr1  897
        <ch;DES_FUEL>   = MAX(<ch;DES_FUEL>,-DesignCapH/<ch:HW-XEFF>)           Chlr1  898
        <ch;DES_HW_GPM> = GPM                                                   Chlr1  899
c              set up the heating start up loads - assume that heating          Chlr1  900
c              mode only takes half as much time as cooling mode                Chlr1  901
        StartTime = <ch:START-TIME> * 0.5                                       Chlr1  902
        CALL StartUpLoad_Design(<ch;Jpe_HEAT>, RatedCapH, StartTime)            Chlr1  903
c              Save design variables for use in PrimaryEquip.  Jpe points       Chlr1  904
c              to a ghost array created to store the supply-side heating        Chlr1  905
c              variables.                                                       Chlr1  906
        Jpe             = <ch;Jpe_HEAT>                                         Chlr1  907
        <pe;DES_GPM>    = GPM                                                   Chlr1  908
        <pe;MAX_GPM>    = <ch:HW-MAX-GPM>                                       Chlr1  909
        <pe;DES_HEAD>   = <ch:HW-HEAD>                                          Chlr1  910
        <pe;DES_STATIC> = <ch:HW-STATIC>                                        Chlr1  911
        <pe:ISOLATION>  = 1                                                     Chlr1  912
        <pe;Jpm>        = <ch:HW-PUMP>                                          Chlr1  913
      ELSEIF (<ch:ALGORITHM> .EQ. Chiller_LoopHP1)  THEN                        Chlr1  914
        Jlp = <ch:HW-LOOP>                                                      Chlr1  915
c              hw flow                                                          Chlr1  916
        GPM = DesignCap/12000. * HWgpmTon                                       Chlr1  917
c              convert min/max flows from fraction to gpm                       Chlr1  918
        <ch:HW-MIN-GPM> = GPM * <ch:HW-MIN-GPM>                                 Chlr1  919
        <ch:HW-MAX-GPM> = GPM * <ch:HW-MAX-GPM>                                 Chlr1  920
c              design the hw equipment pump                                     Chlr1  921
        IF (<ch:HW-PUMP> .GT. 0)  THEN                                          Chlr1  922
          Jpm = <ch:HW-PUMP>                                                    Chlr1  923
          Jpe = <ch;Jpe_HEAT>                                                   Chlr1  924
          CALL PUMPdes(GPM)                                                     Chlr1  925
c              store pump heat as parasitic load for hourly OpCap calc          Chlr1  926
          <pe;Q_PARASITIC> = Qpump                                              Chlr1  927
c              store design variables for use in pump calcs                     Chlr1  928
          <pm;MIN_GPM> = <ch:HW-MIN-GPM>                                        Chlr1  929
        ELSE                                                                    Chlr1  930
c              error if no attached or loop pump                                Chlr1  931
          IF (<lp:PUMP> .EQ. 0)  THEN                                           Chlr1  932
            CALL MSGSIM(-1,II,II,II,II)                                         Chlr1  933
            WRITE (IOUTPT,9104) (<ch:NAME>,II=1,8),                             Chlr1  934
     &                          (<lp:NAME>,II=1,8)                              Chlr1  935
          ENDIF                                                                 Chlr1  937
c              warn if loop pressure drop different than others                 Chlr1  938
          IF (ABS(<ch:HW-HEAD>+<ch:HW-STATIC>                                   Chlr1  939
     &       - (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>))                         Chlr1  940
     &      / (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>) .GT. 0.05)  THEN          Chlr1  941
            CALL MSGSIM(-3,II,II,II,II)                                         Chlr1  942
            WRITE (IOUTPT,9107) (<ch:NAME>,II=1,8),                             Chlr1  943
     &                          (<lp:NAME>,II=1,8)                              Chlr1  944
          ENDIF                                                                 Chlr1  945
        ENDIF                                                                   Chlr1  946
        <ch;DES_HW_GPM> = GPM                                                   Chlr1  947
c              Jpe points to a ghost array created to store the                 Chlr1  948
c              supply-side heating variables.                                   Chlr1  949
        Jpe             = <ch;Jpe_HEAT>                                         Chlr1  950
        CALL StartUpLoad_Design(Jpe, RatedCapH, <ch:START-TIME>)                Chlr1  951
c              Save design variables for use in PrimaryEquip.                   Chlr1  952
        <pe:MIN-RATIO>  = <ch:MIN-RATIO>                                        Chlr1  953
        <pe;DES_AUX_KW> = <ch:AUX-KW>                                           Chlr1  954
        <pe;DES_GPM>    = GPM                                                   Chlr1  955
        <pe;MAX_GPM>    = <ch:HW-MAX-GPM>                                       Chlr1  956
        <pe;DES_HEAD>   = <ch:HW-HEAD>                                          Chlr1  957
        <pe;DES_STATIC> = <ch:HW-STATIC>                                        Chlr1  958
        <pe:ISOLATION>  = 1                                                     Chlr1  959
        <pe;Jpm>        = <ch:HW-PUMP>                                          Chlr1  960
      ELSE                                                                      Chlr1  961
c              zero out unused loop pointer                                     Chlr1  962
        <ch:HW-LOOP> = 0                                                        Chlr1  963
c              end of chiller hw calcs                                          Chlr1  964
      ENDIF                                                                     Chlr1  965
c                                                                               Chlr1  966
c              Heat recovery                                                    Chlr1  967
      IF (<ch:HTREC-LOOP> .GT. 0  .AND.                                         Chlr1  968
     &    (<ch:MAX-HTREC> .GT. 0.                                               Chlr1  969
     &               .OR.  <ch:ALGORITHM> .EQ. Chiller_Engine1))  THEN          Chlr1  970
c              pointer to htrec water loop                                      Chlr1  971
        Jlp = <ch:HTREC-LOOP>                                                   Chlr1  972
c              loop must be a primary loop                                      Chlr1  973
        IF (<lp:SUBTYPE> .NE. PRIMARY)  THEN                                    Chlr1  974
          CALL MSGSIM(-1,II,II,II,II)                                           Chlr1  975
          WRITE (IOUTPT,9109) (<ch:NAME>,II=1,8),                               Chlr1  976
     &                        (<lp:NAME>,II=1,8)                                Chlr1  977
          call MessageBox( NULL, 'Heat recovery to 2nd loop -'                  Chlr1  978
     &      //' ABORTING'//char(0),'PLANTdes Errors'//char(0), MB_OK            Chlr1  979
     &      + MB_ICONSTOP + MB_TASKMODAL )                                      Chlr1  980
        ENDIF                                                                   Chlr1  982
c              recoverable heat                                                 Chlr1  983
        IF (<ch:ALGORITHM> .EQ. Chiller_Engine1)  THEN                          Chlr1  984
          Qexhaust = DesignCap * DesHIR * <ch:HEAT-TO-EXH>                      Chlr1  985
          QHTREC   = -(Qjacket + Qexhaust)                                      Chlr1  986
        ELSE                                                                    Chlr1  987
          QHTREC = -Qcond * <ch:MAX-HTREC>                                      Chlr1  988
        ENDIF                                                                   Chlr1  989
c              htrec flow                                                       Chlr1  990
        GPM = QHTREC / (<lp;BTUH/GPM-F>*<ch:HTREC-DT>)                          Chlr1  991
c              convert minimum flow from fraction to gpm                        Chlr1  992
        <ch:HTREC-MIN-G> = GPM * <ch:HTREC-MIN-G>                               Chlr1  993
c              design the htrec equipment pump                                  Chlr1  994
        IF (<ch:HTREC-PUMP> .GT. 0)  THEN                                       Chlr1  995
          Jpm = <ch:HTREC-PUMP>                                                 Chlr1  996
          CALL PUMPdes(GPM)                                                     Chlr1  997
c              adjust htrec load by pump heat                                   Chlr1  998
          QHTREC = QHTREC - Qpump                                               Chlr1  999
c              store design variables for use in pump calcs                     Chlr1 1000
          <pm;MIN_GPM>     = <ch:HTREC-MIN-G>                                   Chlr1 1001
        ELSE                                                                    Chlr1 1002
c              warn if loop pressure drop different than others                 Chlr1 1003
          IF (ABS(<ch:HTREC-HEAD>+<ch:HTREC-STATI>                              Chlr1 1004
     &         - (<lp;HTREC_HEAD>+<lp;HTREC_STATIC>))                           Chlr1 1005
     &        / (<lp;HTREC_HEAD>+<lp;HTREC_STATIC>) .GT. 0.05)  THEN            Chlr1 1006
            CALL MSGSIM(-3,II,II,II,II)                                         Chlr1 1007
            WRITE (IOUTPT,9107) (<ch:NAME>,II=1,8),                             Chlr1 1008
     &                          (<lp:NAME>,II=1,8)                              Chlr1 1009
          ENDIF                                                                 Chlr1 1010
        ENDIF                                                                   Chlr1 1011
c              pass htrec load and flow onto htrec loop                         Chlr1 1012
c              note that the chiller is a supplier to the loop,                 Chlr1 1013
c              not a demander                                                   Chlr1 1014
        <lp;PRIMARY_HCAP> = <lp;PRIMARY_HCAP> + QHTREC                          Chlr1 1015
        <ch;DES_QHTREC>   = QHTREC                                              Chlr1 1016
        <ch;DES_HTR_GPM>  = GPM                                                 Chlr1 1017
      ELSE                                                                      Chlr1 1018
c              zero out unused loop pointer                                     Chlr1 1019
        <ch:HTREC-LOOP> = 0                                                     Chlr1 1020
c              end of chiller htrec calcs                                       Chlr1 1021
      ENDIF                                                                     Chlr1 1022
c                                                                               Chlr1 1023
c              Condenser                                                        Chlr1 1024
      SELECT CASE (<ch:COND-TYPE>)                                              Chlr1 1025
        CASE (1,-1)  ! Water-cooled                                             Chlr1 1026
          Jlp = <ch:CW-LOOP>                                                    Chlr1 1027
c              flow at rated conditions                                         Chlr1 1028
          <ch;RatedCWgpm> = <ch:CAP>/12000. * <ch:RATED-CW-FLOW>                Chlr1 1029
c              flow at design conditions                                        Chlr1 1030
          SELECT CASE (<ch:ALGORITHM>)                                          Chlr1 1031
            CASE (105)  ! Engine                                                Chlr1 1032
              GPM = (Qcond-Qjacket) / (<lp;BTUH/GPM-F>*<ch:CW-DT>)              Chlr1 1033
              <ch;DES_CW_GPM> = GPM                                             Chlr1 1034
            CASE (106)  ! 2-pipe heat-pump                                      Chlr1 1035
c                 cooling mode                                                  Chlr1 1036
              GPMc = Qcond / (<lp;BTUH/GPM-F>*<ch:CW-DT>)                       Chlr1 1037
              <ch;DES_CW_GPM> = GPMc                                            Chlr1 1038
c                 heating mode                                                  Chlr1 1039
              QcondH = DesignCapH * (1.-DesEIRh*<ch:ELEC-TO-COND>)              Chlr1 1040
              <ch;DesignCWgpmHt> =QcondH/(<lp;BTUH/GPM-F>*<ch:CW-DT-HT>)        Chlr1 1041
              GPM                = MAX(GPMc, <ch;DesignCWgpmHt>)                Chlr1 1042
c                 rated heating flow                                            Chlr1 1043
              <ch;RatedCWgpmHt> = <ch;RatedCWgpm> * <ch:RATED-HT/CL-F>          Chlr1 1044
            CASE DEFAULT                                                        Chlr1 1045
              GPM = Qcond / (<lp;BTUH/GPM-F>*<ch:CW-DT>)                        Chlr1 1046
              <ch;DES_CW_GPM> = GPM                                             Chlr1 1047
          END SELECT                                                            Chlr1 1048
          IF (<ch:CW-CTRL> .ne. ConstantFlow  .and.                             -042L2   6
     &       (<ch:CW-MIN-GPM> .eq. 1.  .or.                                     -042L2   7
     &        <ch:CW-MIN-PLR> .eq. 1.))  <ch:CW-CTRL> = ConstantFlow            -042L2   8
c              convert minimum flow from fraction to gpm                        Chlr1 1049
          <ch:CW-MIN-GPM> = GPM * <ch:CW-MIN-GPM>                               Chlr1 1050
c              condenser pump                                                   Chlr1 1051
          IF (<ch:CW-PUMP> .GT. 0)  THEN                                        Chlr1 1052
            Jpm = <ch:CW-PUMP>                                                  Chlr1 1053
c              design pump here only if run-around pump.  Otherwise             Chlr1 1054
c              design when more is known about the loop                         Chlr1 1055
            IF (<pm;TYPE> .EQ. EquipmentPump)  THEN                             Chlr1 1056
              CALL PumpDes(GPM)                                                 Chlr1 1057
c              add pump heat to design heat rejection load                      Chlr1 1058
              Qcond = Qcond + Qpump                                             Chlr1 1059
            ENDIF                                                               Chlr1 1060
          ELSE                                                                  Chlr1 1061
c              warn if loop pressure drop different than others                 Chlr1 1062
            IF (ABS(<ch:CW-HEAD>+<ch:CW-STATIC>                                 Chlr1 1063
     &         - (<lp;DEM-SIDE_HEAD>+<lp;DEM-SIDE_STAT>))                       Chlr1 1064
     &        / (<lp;DEM-SIDE_HEAD>+<lp;DEM-SIDE_STAT>) .GT. 0.05)  THEN        Chlr1 1065
              CALL MSGSIM(-3,II,II,II,II)                                       Chlr1 1066
              WRITE (IOUTPT,9107) (<ch:NAME>,II=1,8),                           Chlr1 1067
     &                            (<lp:NAME>,II=1,8)                            Chlr1 1068
            ENDIF                                                               Chlr1 1069
          ENDIF                                                                 Chlr1 1070
c              pass cw load, flow and head onto cw or wlhp loop,                FreeCl  23
c              do not count free cooling load                                   FreeCl  24
          IF (<ch:TYPE> .NE. 13)  THEN                                          FreeCl  25
            <lp;COIL_COOL> = <lp;COIL_COOL> + Qcond                             FreeCl  26
            <lp;GPM>       = <lp;GPM>       + GPM                               FreeCl  27
          ENDIF                                                                 FreeCl  28
          <ch;DES_QCOND>  = Qcond                                               Chlr1 1074
c              heat-pump chillers                                               Chlr1 1075
          SELECT CASE (<ch:ALGORITHM>)                                          Chlr1 1076
            CASE (106)  ! 2-pipe heat-pump                                      Chlr1 1077
              IF (<ch:CW-PUMP> .GT. 0) QcondH = MIN(-1., QcondH + Qpump)        Chlr1 1078
              <lp;COIL_HEAT> = <lp;COIL_HEAT> + QcondH                          Chlr1 1079
            CASE (107)  !                                                       Chlr1 1080
              QevapH = DesignCapH                                               Chlr1 1081
     &               * (1.-DesEIRh*<ch:ELEC-TO-COND>)                           Chlr1 1082
              IF (<ch:CW-PUMP> .GT. 0) QevapH = MIN(-1., QevapH + Qpump)        Chlr1 1083
              <lp;COIL_HEAT> = <lp;COIL_HEAT> + QevapH                          Chlr1 1084
          END SELECT                                                            Chlr1 1085
        CASE (4)  ! Air-cooled, remote condenser                                Chlr1 1086
          IF (<ch:COND-CAP> .GT. 0.)  THEN                                      Chlr1 1087
            <ch;RatedCondCap> = <ch:COND-CAP> * 1.E6                            Chlr1 1088
          ELSE                                                                  Chlr1 1089
            <ch;RatedCondCap> = Qcond                                           Chlr1 1090
            IF (<ch:SCT-AMB-DT> .EQ. UNFILD)                                    Chlr1 1091
     &        <ch:SCT-AMB-DT> = MAX(5., <ch:DESIGN-COND-T>-DBTMAX)              Chlr1 1092
          ENDIF                                                                 Chlr1 1093
          <ch;CondCap/F> = <ch;RatedCondCap> / <ch:SCT-AMB-DT>                  Chlr1 1094
          <ch;CondFanKW> = <ch;CondCap/F> * <ch:FAN-EIR-TD> * KWBTU             Chlr1 1095
        CASE (5)  ! Evap-cooled, remote condenser                               Chlr1 1096
          CondCap_fT = CVAL(<ch:COND-CAP-FT>,<ch:DESIGN-COND-T>,                Chlr1 1097
     &                                       <ch:DESIGN-WETBUL>)                Chlr1 1098
          IF (<ch:COND-CAP> .GT. 0.)  THEN                                      Chlr1 1099
            <ch;RatedCondCap> = <ch:COND-CAP> * 1.E6                            Chlr1 1100
c              if design, convert to rated                                      Chlr1 1101
            IF (<ch:SPECIFIED-AT> .EQ. 2)                                       MeterEU 99
     &        <ch;RatedCondCap> = <ch;RatedCondCap> / CondCap_fT                Chlr1 1103
          ELSE                                                                  Chlr1 1104
            <ch;RatedCondCap> = Qcond / CondCap_fT                              Chlr1 1105
          ENDIF                                                                 Chlr1 1106
c              power consumption                                                Chlr1 1107
          <ch;CondFanKW>  = <ch;RatedCondCap>*<ch:COND-FAN-EIR>  * KWBTU        Chlr1 1108
          <ch;CondPumpKW> = <ch;RatedCondCap>*<ch:COND-PUMP-EIR> * KWBTU        Chlr1 1109
          IF (<ch:SPECIFIED-AT> .EQ. 2)  THEN                                   MeterEU100
            <ch;CondFanKW>  = <ch;CondFanKW> * CondCap_fT                       Chlr1 1111
            <ch;CondPumpKW> = <ch;CondPumpKW> * CondCap_fT                      Chlr1 1112
          ENDIF                                                                 Chlr1 1113
      END SELECT                                                                Chlr1 1114
c                                                                               Chlr1 1115
      IF (<ch:ALGORITHM> .EQ. Chiller_LoopHP1)  THEN                            Chlr1 1116
c              Design the heat exchangers for loop-to-loop heat-pump            Chlr1 1117
c              Well water                                                       Chlr1 1118
        Jlp     = <ch:CW-LOOP>                                                  Chlr1 1119
        CpCW    = <lp;BTUH/GPM-F>                                               Chlr1 1120
c              Condenser HX, sized for cooling-only mode                        Chlr1 1121
        Jlp     = <ch:HW-LOOP>                                                  Chlr1 1122
        CpHW    = <lp;BTUH/GPM-F>                                               Chlr1 1123
        Jlp     = <ch:CHW-LOOP>                                                 Chlr1 1124
        CpCHW   = <lp;BTUH/GPM-F>                                               Chlr1 1125
        ThwInHX = <ch:DESIGN-COND-T> + <ch:CW-DT>                               Chlr1 1126
        Twell   = ThwInHX - <ch:COND-HX-TD>                                     Chlr1 1127
        <ch;CondHX> = NewHX(Jch, 1, 0., 0.005,                                  Chlr1 1128
     &                      0.4, 0.52, 0.4, 0.52)                               Chlr1 1129
        CALL HeatExchanger_Design(<ch;CondHX>, <ch:CW-LOOP>, Jch, Qcond,        Chlr1 1130
     &                   <ch;DES_CW_GPM>, CpCW,   Twell, <tw:CW-HEAD>,          Chlr1 1131
     &                   <ch;DES_HW_GPM>, CpHW, ThwInHX,           0.)          Chlr1 1132
c              Evaporator HX, sized for heating-only mode                       Chlr1 1133
        TchwInHX = <ch:EVAP-HX-DES-T> + QevapH/(CpCHW*<ch;DES_CHW_GPM>)         Chlr1 1134
        Twell    = TchwInHX + <ch:EVAP-HX-TD>                                   Chlr1 1135
        <ch;EvapHX> = NewHX(Jch, 1, 0., 0.005,                                  Chlr1 1136
     &                      0.4, 0.52, 0.4, 0.52)                               Chlr1 1137
        CALL HeatExchanger_Design(<ch;EvapHX>, <ch:CW-LOOP>, Jch,QevapH,        Chlr1 1138
     &                  <ch;DES_CW_GPM>,  CpCW,    Twell, <tw:CW-HEAD>,         Chlr1 1139
     &                 <ch;DES_CHW_GPM>, CpCHW, TchwInHX,           0.)         Chlr1 1140
      ENDIF                                                                     Chlr1 1141
c                                                                               Chlr1 1142
      RETURN                                                                    Chlr1 1143
c                                                                               ChlrHP 611
c              Message formats                                                  -048    17
 9001 FORMAT(14X,8A4,' has a maximum flow smaller'                     /        -048    18
     &       14X,'than the loops minimum flow, and will never be used' /        -048    19
     &       14X,'by itself.'                                          )        -048    20
 9003 FORMAT(14X,8A4,' has a temperature setpoint'                     /        -048    21
     &       14X,'too high for a loop-to-loop heat-pump (max 130F).'   )        -048    22
 9004 FORMAT(14X,8A4,' has a design HW temperature'                    /        -048    23
     &       14X,'too high for a loop-to-loop heat-pump (max 130F).'   )        -048    24
 9104 FORMAT(14X,8A4,' must have a pump if'                            /        -048    25
     &       14X,'loop: ',8A4,' does not.'                             )        -048    26
 9107 FORMAT(14X,'Plant equipment: ',8A4,' has a different'            /        -048    27
     &       14X,'pressure drop on loop: ',8A4,' than the'             /        -048    28
     &       14X,'other equipment.  This is unusual unless the loop'   /        -048    29
     &       14X,'uses flow meters or other dynamic flow control'      /        -048    30
     &       14X,'devices to allocate the flow on an hourly basis to'  /        -048    31
     &       14X,'the active equipment.'                               )        -048    32
 9109 FORMAT(14X,'Chiller: ',8a4,' has heat recovery attached'         /        -048    33
     &       14X,'to loop: ',8a4,' which is not a primary loop.'       )        -048    34
                                                                                -048    35
                                                                                -048    36
      CONTAINS                                                                  -048    37
c ============== NoLoopPump =================================================== -048    38
      Subroutine NoLoopPump                                                     -048    39
                                                                                -048    40
      Call MSGSIM(-1,II,II,II,II)                                               -048    41
      Write (IOUTPT,9002) (<lp:NAME>,II=1,8), (<ch:NAME>,II=1,8)                -048    42
      Call MessageBox( NULL, 'Missing PRIMARY LOOP pumps -'                     -048    43
     &  //' ABORTING'//char(0),'Design Errors'//char(0), MB_OK                  -048    44
     &  + MB_ICONSTOP + MB_TASKMODAL )                                          -048    45
                                                                                -048    46
 9002 Format(14X,8A4,' must have a pump when used'                     /        -048    47
     &       14X,'with',8A4                                            )        -048    48
                                                                                -048    49
      End Subroutine NoLoopPump                                                 -048    50
                                                                                -048    51
      END                                                                       CHDES1 358
      SUBROUTINE Chiller_Elec_1                                                 CHELC1   2
c                                                                               CHELC1   3
c                                                                               CHELC1   4
c              Simulates electric compression chillers, both conventional       CHELC1   5
c              and heat-recovery.                                               CHELC1   6
c                                                                               CHELC1   7
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /EQUIPD/ EQload, EQrun, EQhgb, OperCap, Frac,                     /EQUIPD/ 2
     &                 PLR, EQsupplyT, Tcond,                                   Chlr1    1
     &                 EIRPLR, EIRFT, EQEIR, EQelec, EQfanKW, EQaux,            /EQUIPD/ 4
     &                 HIRPLR, HIRFT, EQHIR, EQfuel, EQcond, EQrecvr,           /EQUIPD/ 5
     &                 HWflow, HWhead, CHWflow, CHWhead, CWflow, CWhead,        /EQUIPD/ 6
     &                 HTRECflow,HTREChead, Qenvir, EQstart, EQloadH,           -041d    1
     &                 EQstartH, PLRh, FracH, EQfuelH, EQelecH                  /EQUIPD/ 8
      REAL             EQUIPDAT(36)                                             /EQUIPD/10
      EQUIVALENCE      (EQUIPDAT(1), EQload), (Tambient, Tcond)                 FreeCl   1
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               CHELC1  21
      COMMON  /CHLRKY/ ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 2
     &                 WaterCool, AirCool                                       /CHLRKY/ 3
      INTEGER          ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 4
     &                 WaterCool, AirCool                                       /CHLRKY/ 5
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
c                                                                               CHELC1  26
        REAL Limits(2)                                                          IcRink 200
c                                                                               IcRink 201
c              pointer to chiller evaporator loop                               Chlr1 1147
      JlpEvap = Jlp                                                             Chlr1 1148
c                                                                               Chlr1 1149
c              zero hourly chiller data                                         Chlr1 1150
      CALL FILLN(0., EQUIPDAT(1), IVTLIM(2,16))                                 Chlr1 1151
                                                                                Chlr1 1152
c              required leaving evaporator temperature                          Chlr1 1153
      EQsupplyT = <pe;SUPPLY_T>                                                 Chlr1 1154
c                                                                               Chlr1 1155
c ****         run function : Chiller_Elec_1-1                                  Chlr1 1156
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        Chlr1 1157
c                                                                               Chlr1 1158
      IF (SimCtrl .EQ. 11)  THEN                                                Chlr1 1159
c              Routine called to get operating capacity                         Chlr1 1160
c              Initialize entering condenser temperature                        Chlr1 1161
        SELECT CASE (<ch:COND-TYPE>)                                            Chlr1 1162
          CASE (1)  ! Water-cooled                                              Chlr1 1163
            Jlp      = <ch:CW-LOOP>                                             Chlr1 1164
            <ch;ECT> = <lp;COIL_EWTest>                                         Chlr1 1165
            Tcond    = <lp;COIL_EWTest>                                         Chlr1 1166
            Jlp      = JlpEvap                                                  Chlr1 1167
          CASE (2)  ! Air-cooled                                                Chlr1 1168
            <ch;ECT> = DBT                                                      Chlr1 1169
            Tcond    = DBT                                                      Chlr1 1170
          CASE (3)  ! Evap-cooled                                               Chlr1 1171
            <ch;ECT> = WBT                                                      Chlr1 1172
            Tcond    = WBT                                                      Chlr1 1173
          CASE (4)  ! Air-cooled, remote                                        Chlr1 1174
            <ch;ECT> = DBT                                                      Chlr1 1175
            SELECT CASE (<ch:COND-SETPT-CT>)                                    Chlr1 1176
              CASE (0)  ! Fixed                                                 Chlr1 1177
                Tcond = <ch:COND-SETPT-T>                                       Chlr1 1178
              CASE (1)  ! Variable setpoint                                     Chlr1 1179
                Tcond = <ch;ECT> + <ch:COND-SETPT-DT>                           Chlr1 1180
              CASE (2)  ! Ambient control                                       Chlr1 1181
                PLRcond = CVAL(<ch:AMB-FRAC-FT>, <ch;ECT>, <ch;ECT>)            Chlr1 1182
                Tcond   = <ch;ECT> + <ch:CW-DT>/PLRcond                         Chlr1 1183
            END SELECT                                                          Chlr1 1184
          CASE (5)  ! Evap-cooled, remote                                       Chlr1 1185
            <ch;ECT> = WBT                                                      Chlr1 1186
            SELECT CASE (<ch:COND-SETPT-CT>)                                    Chlr1 1187
              CASE (0)  ! Fixed                                                 Chlr1 1188
                Tcond = <ch:COND-SETPT-T>                                       Chlr1 1189
              CASE (1)  ! Variable setpoint                                     Chlr1 1190
                Tcond = <ch;ECT> + <ch:COND-SETPT-DT>                           Chlr1 1191
              CASE (2)  ! Ambient control                                       Chlr1 1192
                PLRcond   = CVAL(<ch:AMB-FRAC-FT>, <ch;ECT>, <ch;ECT>)          Chlr1 1193
                Limits(2) = AMAX1(<ch;ECT>, <ch:MIN-COND-T>)                    Chlr1 1194
                Limits(1) = 130.                                                Chlr1 1195
                Jcv       = <ch:COND-CAP-FT>                                    -045b    1
                CALL CURINV(<cv:COEF-1>,<cv:TYPE>,                              -045b    2
     &                      1,Tcond,<ch;ECT>, PLRcond, Limits(1),IERR)          -045b    3
                Tcond = AMIN1(AMAX1(Tcond, Limits(2)), Limits(1))               Chlr1 1199
            END SELECT                                                          Chlr1 1200
        END SELECT  ! ch:COND-TYPE                                              Chlr1 1201
        <ch;Tcond> = MAX(Tcond, <ch;ECT>, <ch:MIN-COND-T>)                      Chlr1 1202
      ELSEIF (<pe;GPM> .EQ. 0.)  THEN  ! chiller is off                         -044c4  95
        GOTO 1000                                                               -044c4  96
      ENDIF                                                                     -044c4  97
c                                                                               -044c4  98
      EQstart = StartUpLoad(Jpe)       ! start-up load                          -044c4  99
c                                                                               Chlr1 1211
c ****         run function : Chiller_Elec_1-2                                  Chlr1 1212
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        Chlr1 1213
c                                                                               Chlr1 1214
c              Start of iterative loop on condenser temperature                 Chlr1 1215
      Tcond     = <ch;Tcond>                                                    Chlr1 1216
      ErrorLast = 0                                                             -047j   12
      IterT     = 0                                                             Chlr1 1217
   20 IterT     = IterT + 1                                                     Chlr1 1218
      AuxPumpKW = 0.                   ! local pump kW                          Chlr1 1219
      Tlast     = Tcond                                                         Chlr1 1220
c              operating capacity                                               Chlr1 1221
      Cap_fT  = CVAL(<ch:CAP-FT>, EQsupplyT, Tcond)                             Chlr1 1222
      OperCap = <ch;NormalCap> * Cap_fT                                         Chlr1 1223
c                                                                               -044c4 100
      IF (SimCtrl .EQ. 11)  THEN       ! getting capacity                       -044c4 101
        EQload = OperCap - EQstart                                              -044c4 102
      ELSE                             ! normal call                            -044c4 103
        EQload = <pe;LOAD>                                                      -044c4 104
c              local chilled water pump                                         -044c4 105
        IF (<ch:CHW-PUMP> .ne. 0)  THEN                                         -047k   10
          Jpm     = <ch:CHW-PUMP>                                               -044c4 107
          PMPfrac = 1.0                ! runs full hour                         -044c4 108
          CALL PumpSupply                                                       -044c4 109
          EQload = EQload + PMPQ       ! add pump heat to load                  -044c4 110
c              sum into auxiliary pump Kw (equipment pumps only)                -044c4 111
          IF (<pm;TYPE> .EQ. EquipmentPump)                                     -044c4 112
     &                                AuxPumpKW = AuxPumpKW + PMPkW             -044c4 113
        ENDIF                                                                   -044c4 114
      ENDIF                                                                     -044c4 115
c                                                                               -044c4 116
c              Part load ratio, including startup load                          -044c4 117
      Qnet = EQload + EQstart                                                   -044c4 118
      PLR  = Qnet / OperCap                                                     -044c4 119
      IF (PLR .gt. <ch:MIN-RATIO>)  THEN  ! equipment runs full hour            -044c4 120
        Frac     = 1.                                                           -044c4 121
      ELSE  ! fraction of hour operating                                        -044c4 122
        PLR      = <ch:MIN-RATIO>                                               -044c4 123
        CapMin   = OperCap*<ch:MIN-RATIO>                                       -044c4 124
        Frac     = Qnet / CapMin                                                -044c4 125
c              include standby losses                                           -044c4 126
        Qstandby = Min(<ch:CAP>*<ch:STANDBY-TIME>, CapMin)                      -044c4 127
        Qstandby = Qstandby * (1.0 - Frac)                                      -044c4 128
        Qnet     = Qnet + Qstandby                                              -044c4 129
        Frac     = Qnet / CapMin                                                -044c4 130
      ENDIF                                                                     -044c4 131
c                                                                               -044c4 132
c              Hot-gas-bypass ratio; may be higher during heat recovery         -044c4 133
      HGBratio = <ch:HGB-RATIO>                                                 -044c4 134
      IF (<ch:HTREC-LOOP> .GT. 0  .AND.  <ch:HGB-HTREC> .GT. 0.)  THEN          Chlr1 1263
        Jlp = <ch:HTREC-LOOP>                                                   Chlr1 1264
        IF (<lp;CTRL_MODE> .EQ. HEATMODE)  HGBratio = <ch:HGB-HTREC>            Chlr1 1265
        Jlp = JlpEvap                                                           Chlr1 1266
      ENDIF                                                                     Chlr1 1267
c              When running, the machine must operate at or above the           Chlr1 1268
c              greater of the min-ratio, or hot-gas-bypass ratio                Chlr1 1269
      PLR   = MAX(PLR, <ch:MIN-RATIO>, HGBratio)                                Chlr1 1270
      EQrun = OperCap * PLR                    ! operating point                Chlr1 1271
      EQhgb = DIM(EQrun*FRAC,Qnet)             ! hot-gas bypass                 Chlr1 1272
c                                                                               Chlr1 1273
c              Compressor power                                                 Chlr1 1274
      EIRFT  = CVAL(<ch:EIR-FT>, EQsupplyT, Tcond)                              Chlr1 1275
      dT     = Tcond - EQsupplyT                                                Chlr1 1276
      EIRPLR = CVAL(<ch:EIR-FPLR>, PLR, dT)                                     Chlr1 1277
      EQEIR  = <ch;NormalEIR> * EIRFT * EIRPLR                                  Chlr1 1278
      EQelec = OperCap * EQEIR * Frac * KWBTU                                   Chlr1 1279
c                                                                               Chlr1 1280
c              Rejected heat                                                    Chlr1 1281
      EQcond = EQload + EQelec*<ch:ELEC-TO-COND>*BTUKW                          -044c4 135
c                                                                               Chlr1 1283
c              Check for heat recovery; available only if water-cooled          Chlr1 1284
      IF (<ch:HTREC-LOOP> .EQ. 0.)  THEN                                        Chlr1 1285
        HtRecMaxT = -88888.                                                     Chlr1 1286
      ELSE                                                                      Chlr1 1287
        Jlp       = <ch:HTREC-LOOP>                                             Chlr1 1288
        HtrecMaxT = MIN(<ch:RECOVER-T>, <lp;SUPPLY_T>)                          Chlr1 1289
        IF (<lp;CTRL_MODE> .NE. HEATMODE                                        Chlr1 1290
     &                      .OR.  HtrecMaxT .LE. <lp;RETURN_T>)  THEN           Chlr1 1291
          HtRecMaxT = -88888.                                                   Chlr1 1292
        ELSE                                                                    Chlr1 1293
c              htrec flow cannot be greater than the loop flow, adjusted        Chlr1 1294
c              for the flow which goes thru other htrec devices                 Chlr1 1295
          HTRECflow = MIN(<ch;DES_HTR_GPM>, <lp;HTREC_GPM>)                     Chlr1 1296
c              maximum recoverable heat based on temperature and flow           Chlr1 1297
          EQrecvr = <lp;BTUH/GPM-F> * HTRECflow                                 Chlr1 1298
     &                              * (HtrecMaxT - <lp;RETURN_T>)               Chlr1 1299
     &                              * Frac                                      Chlr1 1300
c              limit by the amount the chiller can produce, and change sign     Chlr1 1301
c              for heating                                                      Chlr1 1302
          EQrecvr = -MIN(EQcond, EQrecvr)                                       Chlr1 1303
          EQcond  = EQcond + EQrecvr                                            Chlr1 1304
c              if chiller has a heat reclaim pump                               Chlr1 1305
          IF (<ch:HTREC-PUMP> .GT. 0  .AND.  SimCtrl .NE. 11)  THEN             Chlr1 1306
            Jpm = <ch:HTREC-PUMP>                                               Chlr1 1307
            IF (<ch:HTREC-CTRL> .EQ. ConstantFlow)  THEN                        Chlr1 1308
c              constant flow                                                    Chlr1 1309
              HTREChead = <ch:HTREC-HEAD> + <ch:HTREC-STATI>                    Chlr1 1310
            ELSE                                                                Chlr1 1311
c              variable flow - matches prorated loop flow                       Chlr1 1312
              HTRECflow = MAX(HTRECflow, <ch:HTREC-MIN-G>)                      Chlr1 1313
              PLRflow   = HTRECflow / <ch;DES_HTR_GPM>                          Chlr1 1314
              HTREChead = <ch:HTREC-HEAD> * PLRflow**1.8                        Chlr1 1315
     &                  + <ch:HTREC-STATI>                                      Chlr1 1316
            ENDIF                                                               Chlr1 1317
            PMPgpm    = HTRECflow                                               Chlr1 1318
            PMPfric   = HTREChead                                               Chlr1 1319
            PMPstatic = <ch:HTREC-STATI>                                        Chlr1 1320
            PMPset    = HTREChead + <ch:HTREC-STATI>                            Chlr1 1321
            PMPfrac   = Frac                                                    Chlr1 1322
            CALL PUMP                                                           Chlr1 1323
c              add pump heat into heat reclaim                                  Chlr1 1324
            EQrecvr   = EQrecvr - PMPQ                                          Chlr1 1325
c              sum into auxiliary pump kW                                       Chlr1 1326
            AuxPumpKW = AuxPumpKW + PMPkW                                       Chlr1 1327
          ELSE                                                                  Chlr1 1328
c              no heat reclaim pump - pass reclaim head onto reclaim loop       Chlr1 1329
c              note that this head is not assumed to vary hourly, and is        Chlr1 1330
c              accounted for in a design variable                               Chlr1 1331
          ENDIF                                                                 Chlr1 1332
        ENDIF                                                                   Chlr1 1333
        Jlp = JlpEvap                                                           Chlr1 1334
      ENDIF  ! heat recovery                                                    Chlr1 1335
c                                                                               Chlr1 1336
c              Condenser performance                                            Chlr1 1337
      SELECT CASE (<ch:COND-TYPE>)                                              Chlr1 1338
        CASE (1)  ! Water-cooled                                                Chlr1 1339
          Jlp = <ch:CW-LOOP>                                                    Chlr1 1340
c              condenser flow & head                                            Chlr1 1341
          IF (<ch:CW-CTRL> .EQ. ConstantFlow)  THEN                             Chlr1 1342
c              constant flow                                                    Chlr1 1343
            CWflow = <ch;DES_CW_GPM>                                            Chlr1 1344
            CWhead = <ch:CW-HEAD>                                               Chlr1 1345
          ELSE                                                                  Chlr1 1346
c              variable flow                                                    Chlr1 1347
            PLRflow = (PLR-<ch:CW-MIN-PLR>) / (1.-<ch:CW-MIN-PLR>)              Chlr1 1348
            PLRflow = MAX(0., MIN(1., PLRflow))                                 Chlr1 1349
            CWflow  = <ch:CW-MIN-GPM>                                           Chlr1 1350
     &              + (<ch;DES_CW_GPM>-<ch:CW-MIN-GPM>)*PLRflow                 Chlr1 1351
c              leaving condenser temperature                                    Chlr1 1352
            dT      = EQcond/(<lp;BTUH/GPM-F>*CWflow*Frac)                      Chlr1 1353
            Tcwr    = <ch;ECT> + dT                                             Chlr1 1354
            IF (PLRflow         .LT. 1.0     .AND.                              Chlr1 1355
     &          <ch:MAX-COND-T> .NE. UNFILD  .AND.                              Chlr1 1356
     &          Tcwr            .GT. <ch:MAX-COND-T>)  THEN                     Chlr1 1357
              IF (<ch;ECT> .LT. <ch:MAX-COND-T>)  THEN                          Chlr1 1358
                dT     = <ch:MAX-COND-T> - <ch;ECT>                             Chlr1 1359
                CWflow = EQcond / (<lp;BTUH/GPM-F>*dT*Frac)                     Chlr1 1360
                CWflow = MIN(<ch;DES_CW_GPM>, CWflow)                           Chlr1 1361
              ELSE                                                              Chlr1 1362
                CWflow = <ch;DES_CW_GPM>                                        Chlr1 1363
              ENDIF                                                             Chlr1 1364
            ENDIF                                                               Chlr1 1365
            PLRflow = CWflow / <ch;DES_CW_GPM>                                  Chlr1 1366
            CWhead  = <ch:CW-HEAD> * PLRflow**1.8                               Chlr1 1367
          ENDIF                                                                 Chlr1 1368
c              Leaving condenser temperature                                    Chlr1 1369
          dT    = EQcond/(<lp;BTUH/GPM-F>*CWflow*Frac)                          Chlr1 1370
          Tcwr  = <ch;ECT> + dT                                                 Chlr1 1371
          IF (EQrecvr .EQ. 0.)  THEN                                            Chlr1 1372
c              Effective entering condenser temperature, adjusted for           Chlr1 1373
c              reduced flow                                                     Chlr1 1374
            Tcond  = Tcwr - dT*MIN(1., CWflow/<ch;RatedCWgpm>)                  Chlr1 1375
          ELSE                                                                  Chlr1 1376
c              Effective entering condenser temperature, adjusted for           Chlr1 1377
c              heat recovery                                                    Chlr1 1378
            Tcwr   = MAX(HtrecMaxT, Tcwr)                                       Chlr1 1379
            dT     = Tcwr - <ch;ECT>                                            Chlr1 1380
            CWflow = EQcond / (<lp;BTUH/GPM-F>*dT*Frac)                         Chlr1 1381
            dT     = (EQcond-EQrecvr)                                           Chlr1 1382
     &                       / (<lp;BTUH/GPM-F>*(HTRECflow+CWflow)*Frac)        Chlr1 1383
            Tcond  = Tcwr - dT                                                  Chlr1 1384
            IF (<ch:CW-CTRL> .EQ. ConstantFlow)  THEN                           Chlr1 1385
              CWflow = <ch;DES_CW_GPM>                                          Chlr1 1386
            ELSE                                                                Chlr1 1387
              PLRflow = (HTRECflow+CWflow) / <ch;DES_CW_GPM>                    Chlr1 1388
              PLRflow = MIN(1., PLRflow)                                        Chlr1 1389
              CWhead  = <ch:CW-HEAD> * PLRflow**1.8                             Chlr1 1390
            ENDIF                                                               Chlr1 1391
          ENDIF                                                                 Chlr1 1392
          Tcond = MAX(<ch:MIN-COND-T>, Tcond)                                   Chlr1 1393
c              if chiller has an attached condenser pump                        Chlr1 1394
          IF (<ch:CW-PUMP> .GT. 0)  THEN                                        Chlr1 1395
            Jpm = <ch:CW-PUMP>                                                  Chlr1 1396
c              if the loop has its own pump, then this condenser pump           Chlr1 1397
c              is an equipment pump and can be simulated now.  If the           Chlr1 1398
c              loop does not have its own pump, then this pump powers           Chlr1 1399
c              the loop and must be simulated later when more is known          Chlr1 1400
c              about the total loop flow and head.                              Chlr1 1401
            IF (<pm;TYPE> .EQ. EquipmentPump)  THEN                             Chlr1 1402
c                 equipment pump                                                Chlr1 1403
              PMPgpm    = CWflow                                                Chlr1 1404
              PMPset    = CWhead + <ch:CW-STATIC>                               Chlr1 1405
              PMPfric   = CWhead                                                Chlr1 1406
              PMPstatic = <ch:CW-STATIC>                                        Chlr1 1407
              PMPfrac   = 1.  ! runs continuously                               -047e    3
              CALL PUMP                                                         Chlr1 1409
              AuxPumpKW = AuxPumpKW + PMPkW                                     Chlr1 1410
c                 add condenser pump heat into condenser water                  Chlr1 1411
              EQcond    = EQcond + PMPQ                                         Chlr1 1412
            ELSEIF (SimCtrl .NE. 11)  THEN                                      -041g    2
c                 condenser pump powers the loop - save for later               Chlr1 1414
              <pm;GPM>        = CWflow                                          Chlr1 1415
              <pm;EQUIP_HEAD> = CWhead                                          Chlr1 1416
            ENDIF                                                               Chlr1 1417
          ENDIF                                                                 Chlr1 1418
          Jlp = JlpEvap                                                         Chlr1 1419
        CASE (2)  ! Air-cooled                                                  Chlr1 1420
        CASE (3)  ! Evap-cooled                                                 Chlr1 1421
        CASE (4)  ! Air-cooled, remote                                          Chlr1 1422
          IF (<ch:COND-SETPT-CT> .NE. 2)  THEN                                  Chlr1 1423
c              fixed and variable control                                       Chlr1 1424
            Cap = <ch;CondCap/F> * (Tcond-<ch;ECT>)                             Chlr1 1425
            IF (Cap .GE. EQcond)  THEN                                          Chlr1 1426
c              can maintain setpoint - calc plr                                 Chlr1 1427
              PLRcond = EQcond/Cap                                              Chlr1 1428
            ELSE                                                                Chlr1 1429
c              cannot maintain setpoint - float temperature                     Chlr1 1430
              PLRcond = 1.0                                                     Chlr1 1431
              Tcond   = <ch;ECT> + EQcond/<ch;CondCap/F>                        Chlr1 1432
            ENDIF                                                               Chlr1 1433
            PLRcond = CVAL(<ch:COND-PWR-FPLR>, PLRcond, PLRcond)                Chlr1 1434
          ELSE                                                                  Chlr1 1435
c              ambient control - calc fraction of cond active                   Chlr1 1436
            PLRcond = CVAL(<ch:AMB-FRAC-FT>, <ch;ECT>, <ch;ECT>)                Chlr1 1437
            Tcond   = <ch;ECT> + EQcond/(<ch;CondCap/F>*PLRcond)                Chlr1 1438
            IF (Tcond .LT. <ch:MIN-COND-T>)  THEN                               Chlr1 1439
              Ratio   = (<ch:MIN-COND-T>-<ch;ECT>) / (Tcond-<ch;ECT>)           Chlr1 1440
              PLRcond = PLRcond * Ratio                                         Chlr1 1441
              Tcond   = <ch:MIN-COND-T>                                         Chlr1 1442
            ENDIF                                                               Chlr1 1443
          ENDIF                                                                 Chlr1 1444
c              condenser fan energy                                             Chlr1 1445
          EQfanKW = <ch;CondFanKW> * PLRcond * Frac                             Chlr1 1446
        CASE (5)  ! Evap-cooled, remote                                         Chlr1 1447
          IF (<ch:COND-SETPT-CT> .NE. 2)  THEN                                  Chlr1 1448
c              fixed and variable control                                       Chlr1 1449
            Cap =<ch;RatedCondCap>*CVAL(<ch:COND-CAP-FT>,Tcond,<ch;ECT>)        Chlr1 1450
            IF (Cap .GE. EQcond)  THEN                                          Chlr1 1451
c              can maintain setpoint - calc plr                                 Chlr1 1452
              PLRcond = EQcond/Cap                                              Chlr1 1453
            ELSE                                                                Chlr1 1454
c              cannot maintain setpoint - float temperature                     Chlr1 1455
              PLRcond   = 1.0                                                   Chlr1 1456
              Limits(2) = AMAX1(<ch;ECT>, <ch:MIN-COND-T>)                      Chlr1 1457
              Limits(1) = 130.                                                  Chlr1 1458
              Jcv       = <ch:COND-CAP-FT>                                      -045b    4
              CALL CURINV(<cv:COEF-1>,<cv:TYPE>,                                -045b    5
     &          1,Tcond,<ch;ECT>, EQcond/<ch;RatedCondCap>,                     Chlr1 1460
     &                                              Limits(1),IERR)             Chlr1 1461
              Tcond = AMIN1(AMAX1(Tcond, Limits(2)), Limits(1))                 Chlr1 1462
            ENDIF                                                               Chlr1 1463
            PLRcond = CVAL(<ch:COND-PWR-FPLR>, PLRcond, PLRcond)                Chlr1 1464
          ELSE                                                                  Chlr1 1465
c              ambient control - calc fraction of cond active                   Chlr1 1466
            PLRcond   = CVAL(<ch:AMB-FRAC-FT>, <ch;ECT>, <ch;ECT>)              Chlr1 1467
            Cap       = <ch;RatedCondCap> * PLRcond                             Chlr1 1468
            Limits(2) = <ch;ECT>                                                Chlr1 1469
            Limits(1) = 130.                                                    Chlr1 1470
            Jcv       = <ch:COND-CAP-FT>                                        -045b    6
            CALL CURINV(<cv:COEF-1>,<cv:TYPE>,                                  -045b    7
     &           1,Tcond,<ch;ECT>, EQcond/Cap, Limits(1),IERR)                  Chlr1 1472
            Tcond = AMIN1(Tcond, Limits(1))                                     Chlr1 1473
            IF (Tcond .LT. <ch:MIN-COND-T>)  THEN                               Chlr1 1474
              Tcond = <ch:MIN-COND-T>                                           Chlr1 1475
              Cap   = <ch;RatedCondCap>                                         Chlr1 1476
     &                         * CVAL(<ch:COND-CAP-FT>, Tcond, <ch;ECT>)        Chlr1 1477
              PLRcond = EQcond / Cap                                            Chlr1 1478
            ENDIF                                                               Chlr1 1479
          ENDIF                                                                 Chlr1 1480
c              condenser fan and pump energy                                    Chlr1 1481
          EQfanKW = (<ch;CondFanKW>*PLRcond + <ch;CondPumpKW>)                  Chlr1 1482
     &            * Frac                                                        Chlr1 1483
      END SELECT  ! ch:COND-TYPE                                                Chlr1 1484
c                                                                               Chlr1 1485
c              Check if Tcond converged                                         Chlr1 1486
      Error = Tcond - Tlast                                                     -047j   13
      IF (Abs(Error) .lt. 0.1) THEN             ! converged                     -047j   14
      ELSEIF (IterT .eq. 20) THEN               ! convergence failure           -047j   15
        Call MsgSim(-2,II,II,II,II)                                             -047j   16
        Write (iOutpt,9101)  (<ch:NAME>,II=1,8)                                 -047j   17
      ELSE                                       ! iterate again                -047j   18
        IF (ErrorLast/Error .lt. 0.)  Tcond = (Tcond+Tlast)*0.5                 -047j   19
        ErrorLast = Error                                                       -047j   20
        GoTo 20                                                                 -047j   21
      ENDIF                                                                     -047j   22
c                                                                               Chlr1 1497
c ****         run function : Chiller_Elec_1-3                                  Chlr1 1498
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        Chlr1 1499
c                                                                               Chlr1 1500
      <pe;OPER_CAPACITY> = OperCap                                              Chlr1 1501
      IF (SimCtrl .EQ. 11)  THEN                                                Chlr1 1502
c              maximum output - adjust by any parasitic load such as            Chlr1 1503
c              a pump, and warm-up time                                         Chlr1 1504
        <pe;MAX_CAPACITY> = OperCap - <pe;Q_PARASITIC> - EQstart                Chlr1 1505
        RETURN                                                                  Chlr1 1506
      ENDIF                                                                     Chlr1 1507
c                                                                               Chlr1 1508
c              Deduct htrec flow from available                                 Chlr1 1509
      IF (EQrecvr .LT. 0.)  THEN                                                Chlr1 1510
        Jlp            = <ch:HTREC-LOOP>                                        Chlr1 1511
        <lp;HTREC_GPM> = <lp;HTREC_GPM> - HTRECflow*Frac                        Chlr1 1512
        <lp;Q_HTREC>   = <lp;Q_HTREC> + EQrecvr                                 Chlr1 1513
        Jlp            = JlpEvap                                                Chlr1 1514
      ENDIF                                                                     Chlr1 1515
c                                                                               CHELC1 302
c              Auxiliary power                                                  CHELC1 303
 1000 IF (<ch:AUX-KW> .GT. 0.)  THEN                                            CHELC1 304
c              if always on                                                     CHELC1 305
        IF (<ch:AUX-MODE> .EQ. Always)  THEN                                    CHELC1 306
          EQaux = <ch:AUX-KW>                                                   CHELC1 307
        ELSEIF (<ch:AUX-MODE> .EQ. WhenOn)  THEN                                CHELC1 308
          EQaux = <ch:AUX-KW> * Frac                                            CHELC1 309
        ELSEIF (<ch:AUX-MODE> .EQ. WhenOff)  THEN                               CHELC1 310
          EQaux = <ch:AUX-KW> * (1.0 - Frac)                                    CHELC1 311
        ELSE                                                                    Time    16
          EQaux = <ch:AUX-KW> * SchVal(<ch:AUX-SCH>, 1.)                        Time    17
        ENDIF                                                                   CHELC1 314
      ENDIF                                                                     CHELC1 315
c                                                                               CHELC1 316
c ****         run function : Chiller_Elec_1-4                                  CHELC1 317
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        CHELC1 318
c                                                                               CHELC1 319
c                                                                               CHELC1 320
c              report variables                                                 CHELC1 321
      <ch;KW>      = EQelec                                                     CHELC1 322
      <ch;HtRejKW> = EQfanKW                                                    -033     3
      <ch;Q_RECVR> = EQrecvr                                                    CHELC1 323
      <ch;AUX>     = EQaux                                                      CHELC1 324
      <ch;CWload>  = EQcond                                                     ChlrHP 634
      <ch;CWflow>  = CWflow  ! no adjustment for cycling                        -047e    4
      <ch;CWhead>  = CWhead                                                     ChlrHP 636
      <ch;Tcond>   = Tcond                                                      -041h    2
c                                                                               CHELC1 325
c              hourly-report variables                                          CHELC1 326
      IF (<ch;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                                CHELC1 327
     &  CALL HourRepPLT(EQUIPDAT(1), <ch;HREP>, 16, 0)                          CHELC1 328
c                                                                               CHELC1 329
      RETURN                                                                    CHELC1 330
c                                                                               Chlr1 1517
 9101 FORMAT(                                                                   Chlr1 1518
     &14x,'Chiller Tcond convergence failure: ',8A4                    )        Chlr1 1519
      END                                                                       CHELC1 331
      SUBROUTINE Chiller_Engine_1                                               CHENG1   2
c                                                                               CHENG1   3
c                                                                               CHENG1   4
c              Simulates engine driven chillers                                 CHENG1   5
c                                                                               CHENG1   6
c              Heat recovery on this type of packaged chiller                   CHENG1   7
c              is from the engine jacket only.  This is different               CHENG1   8
c              from the other chiller types where the heat recovery             CHENG1   9
c              is from the condenser.                                           CHENG1  10
c                                                                               CHENG1  11
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /EQUIPD/ EQload, EQrun, EQhgb, OperCap, Frac,                     /EQUIPD/ 2
     &                 PLR, EQsupplyT, Tcond,                                   Chlr1    1
     &                 EIRPLR, EIRFT, EQEIR, EQelec, EQfanKW, EQaux,            /EQUIPD/ 4
     &                 HIRPLR, HIRFT, EQHIR, EQfuel, EQcond, EQrecvr,           /EQUIPD/ 5
     &                 HWflow, HWhead, CHWflow, CHWhead, CWflow, CWhead,        /EQUIPD/ 6
     &                 HTRECflow,HTREChead, Qenvir, EQstart, EQloadH,           -041d    1
     &                 EQstartH, PLRh, FracH, EQfuelH, EQelecH                  /EQUIPD/ 8
      REAL             EQUIPDAT(36)                                             /EQUIPD/10
      EQUIVALENCE      (EQUIPDAT(1), EQload), (Tambient, Tcond)                 FreeCl   1
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               CHENG1  25
      COMMON  /CHLRKY/ ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 2
     &                 WaterCool, AirCool                                       /CHLRKY/ 3
      INTEGER          ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 4
     &                 WaterCool, AirCool                                       /CHLRKY/ 5
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
c                                                                               CHENG1  30
c              pointer to chiller evaporator loop                               Chlr1 1521
      JlpEvap = Jlp                                                             Chlr1 1522
      Qjacket = 0.                                                              Chlr1 1523
c                                                                               Chlr1 1524
c              zero hourly chiller data                                         Chlr1 1525
      CALL FILLN(0., EQUIPDAT(1), IVTLIM(2,16))                                 Chlr1 1526
                                                                                Chlr1 1527
c              required leaving evaporator temperature                          Chlr1 1528
      EQsupplyT = <pe;SUPPLY_T>                                                 Chlr1 1529
c                                                                               Chlr1 1530
c ****         run function : Chiller_Engine_1-1                                Chlr1 1531
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        Chlr1 1532
c                                                                               Chlr1 1533
      IF (SimCtrl .EQ. 11)  THEN                                                Chlr1 1534
c              Routine called to get operating capacity                         Chlr1 1535
c              initialize leaving condenser temperature                         Chlr1 1536
        Jlp       = <ch:CW-LOOP>                                                Chlr1 1537
        <ch;ECT>  = <lp;COIL_EWTest>                                            Chlr1 1538
        Tcond     = <lp;COIL_EWTest>                                            Chlr1 1539
        <ch;Tcond> = MAX(Tcond, <ch:MIN-COND-T>)                                Chlr1 1540
      ELSEIF (<pe;GPM> .EQ. 0.)  THEN  ! chiller is off                         -044c4 136
        GOTO 1000                                                               -044c4 137
      ENDIF                                                                     -044c4 138
c                                                                               -044c4 139
      EQstart = StartUpLoad(Jpe)       ! start-up load                          -044c4 140
c                                                                               Chlr1 1549
c ****         run function : Chiller_Engine_1-2                                Chlr1 1550
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        Chlr1 1551
c                                                                               Chlr1 1552
c              Start of iterative loop on condenser temperature                 Chlr1 1553
      Tcond     = <ch;Tcond>                                                    Chlr1 1554
      ErrorLast = 0                                                             -047j   23
      IterT     = 0                                                             Chlr1 1555
   20 IterT     = IterT + 1                                                     Chlr1 1556
      AuxPumpKW = 0.                   ! local pump kW                          Chlr1 1557
      Tlast     = Tcond                                                         Chlr1 1558
c              operating capacity                                               Chlr1 1559
      Cap_fT  = CVAL(<ch:CAP-FT>, EQsupplyT, Tcond)                             Chlr1 1560
      OperCap = <ch;NormalCap> * Cap_fT                                         Chlr1 1561
c                                                                               -044c4 141
      IF (SimCtrl .EQ. 11)  THEN       ! getting capacity                       -044c4 142
        EQload = OperCap - EQstart                                              -044c4 143
      ELSE                             ! normal call                            -044c4 144
        EQload = <pe;LOAD>                                                      -044c4 145
c              local chilled water pump                                         -044c4 146
        IF (<ch:CHW-PUMP> .ne. 0)  THEN                                         -047k   11
          Jpm     = <ch:CHW-PUMP>                                               -044c4 148
          PMPfrac = 1.0                ! runs full hour                         -044c4 149
          CALL PumpSupply                                                       -044c4 150
          EQload = EQload + PMPQ       ! add pump heat to load                  -044c4 151
c              sum into auxiliary pump Kw (equipment pumps only)                -044c4 152
          IF (<pm;TYPE> .EQ. EquipmentPump)                                     -044c4 153
     &                                AuxPumpKW = AuxPumpKW + PMPkW             -044c4 154
        ENDIF                                                                   -044c4 155
      ENDIF                                                                     -044c4 156
c                                                                               -044c4 157
c              Part load ratio, including startup load                          -044c4 158
      Qnet = EQload + EQstart                                                   -044c4 159
      PLR  = Qnet / OperCap                                                     -044c4 160
      IF (PLR .gt. <ch:MIN-RATIO>)  THEN  ! equipment runs full hour            -044c4 161
        Frac     = 1.                                                           -044c4 162
        Qstandby = 0.                                                           -044c4 163
      ELSE  ! fraction of hour operating                                        -044c4 164
        PLR      = <ch:MIN-RATIO>                                               -044c4 165
        CapMin   = OperCap*<ch:MIN-RATIO>                                       -044c4 166
        Frac     = Qnet / CapMin                                                -044c4 167
c              include standby losses                                           -044c4 168
        Qstandby = Min(<ch:CAP>*<ch:STANDBY-TIME>, CapMin)                      -044c4 169
        Qstandby = Qstandby * (1.0 - Frac)                                      -044c4 170
        Qnet     = Qnet + Qstandby                                              -044c4 171
        Frac     = Qnet / CapMin                                                -044c4 172
      ENDIF                                                                     -044c4 173
      EQrun  = OperCap * PLR                   ! operating point                Chlr1 1599
c                                                                               Chlr1 1600
c              Electrical consumption  - note that elec is function of          Chlr1 1601
c              rated cap and EIR, not operating cap                             Chlr1 1602
      EIRFT  = CVAL(<ch:EIR-FT>, EQsupplyT, Tcond)                              Chlr1 1603
      dT     = Tcond - EQsupplyT                                                Chlr1 1604
      EIRPLR = CVAL(<ch:EIR-FPLR>, PLR, dT)                                     Chlr1 1605
      EQEIR  = <ch:EIR> * EIRFT * EIRPLR                                        Chlr1 1606
      EQelec = <ch:CAP> * EQEIR * Frac * KWBTU                                  Chlr1 1607
c                                                                               Chlr1 1608
c              Fuel consumption                                                 Chlr1 1609
      HIRFT  = CVAL(<ch:HIR-FT>, EQsupplyT, Tcond)                              Chlr1 1610
      HIRPLR = CVAL(<ch:HIR-FPLR>, PLR, dT)                                     Chlr1 1611
      EQHIR  = <ch;NormalHIR> * HIRFT * HIRPLR                                  Chlr1 1612
      EQfuel = OperCap * EQHIR * Frac                                           Chlr1 1613
                                                                                Chlr1 1614
c              Rejected heat                                                    Chlr1 1615
      EQcond = EQload + EQelec*<ch:ELEC-TO-COND>*BTUKW                          -044c4 174
     &                + EQfuel*<ch:HEAT-TO-COND>                                -044c4 175
c                                                                               Chlr1 1618
c              engine jacket heat - reduce by warmup load                       Chlr1 1619
      QengFT    = CVAL(<ch:HTREJ-FT>, Tcond, Tcond)                             Chlr1 1620
      QengFPLR  = CVAL(<ch:HTREJ-FPLR>, PLR, PLR)                               Chlr1 1621
      StartFrac = (EQstart+Qstandby) / Qnet                                     -044c4 176
      Qjacket   = EQfuel * <ch:HEAT-TO-JAC> * QengFT*QengFPLR * Frac            Chlr1 1623
     &                                      * (1.0 - StartFrac)                 Chlr1 1624
c                                                                               Chlr1 1625
c              Check for heat recovery - Note that only                         Chlr1 1626
c              engine heat is assumed recoverable, no condenser heat.           Chlr1 1627
      IF (<ch:HTREC-LOOP> .EQ. 0.)  THEN                                        Chlr1 1628
        HtRecMaxT = -88888.                                                     Chlr1 1629
      ELSE                                                                      Chlr1 1630
        Jlp       = <ch:HTREC-LOOP>                                             Chlr1 1631
        HtrecMaxT = MIN(<ch:RECOVER-T>, <lp;SUPPLY_T>)                          Chlr1 1632
        IF (<lp;CTRL_MODE> .NE. HEATMODE                                        Chlr1 1633
     &                      .OR.  HtrecMaxT .LE. <lp;RETURN_T>)  THEN           Chlr1 1634
          HtRecMaxT = -88888.                                                   Chlr1 1635
        ELSE                                                                    Chlr1 1636
c              for this type of chiller, assume that heat recovery acts         Chlr1 1637
c              like a boiler                                                    Chlr1 1638
          HTRECflow = MIN(<ch;DES_HTR_GPM>, <lp;GPM>)                           Chlr1 1639
c              temperature entering this device is the return temperature       Chlr1 1640
c              adjusted for upstream heat recovery devices                      Chlr1 1641
          Tent = <lp;RETURN_T>                                                  Chlr1 1642
     &         - <lp;Q_HTREC>/(<lp;BTUH/GPM-F>*<lp;GPM>)                        Chlr1 1643
c              maximum recoverable heat based on temperature and flow           Chlr1 1644
          EQrecvr = <lp;BTUH/GPM-F> * HTRECflow                                 Chlr1 1645
     &                              * (HtrecMaxT - Tent)                        Chlr1 1646
     &                              * Frac                                      Chlr1 1647
c              Recoverable heat the engine can produce.  Note that only         Chlr1 1648
c              engine heat is assumed recoverable, no condenser heat.           Chlr1 1649
          Qexhaust = EQfuel * <ch:HEAT-TO-EXH> * QengFT*QengFPLR                Chlr1 1650
     &                                         * Frac                           Chlr1 1651
          Qeng     = Qjacket + Qexhaust                                         Chlr1 1652
c              recoverable heat is the lesser of the two, and change sign       Chlr1 1653
c              for heating                                                      Chlr1 1654
          EQrecvr  = -MIN(Qeng, EQrecvr)                                        Chlr1 1655
c              assume jacket heat is used before exhaust heat                   Chlr1 1656
          Qjacket  = MAX(0., Qjacket+EQrecvr)                                   Chlr1 1657
c              if chiller has a heat reclaim pump                               Chlr1 1658
          IF (<ch:HTREC-PUMP> .GT. 0  .AND.  SimCtrl .NE. 11)  THEN             Chlr1 1659
            Jpm = <ch:HTREC-PUMP>                                               Chlr1 1660
            IF (<ch:HTREC-CTRL> .EQ. ConstantFlow)  THEN                        Chlr1 1661
c              constant flow                                                    Chlr1 1662
              HTREChead = <ch:HTREC-HEAD> + <ch:HTREC-STATI>                    Chlr1 1663
            ELSE                                                                Chlr1 1664
c              variable flow - matches prorated loop flow                       Chlr1 1665
              HTRECflow = MAX(HTRECflow, <ch:HTREC-MIN-G>)                      Chlr1 1666
              PLRflow   = HTRECflow / <ch;DES_HTR_GPM>                          Chlr1 1667
              HTREChead = <ch:HTREC-HEAD> * PLRflow**1.8                        Chlr1 1668
     &                  + <ch:HTREC-STATI>                                      Chlr1 1669
            ENDIF                                                               Chlr1 1670
            PMPgpm    = HTRECflow                                               Chlr1 1671
            PMPfric   = HTREChead                                               Chlr1 1672
            PMPstatic = <ch:HTREC-STATI>                                        Chlr1 1673
            PMPset    = HTREChead + <ch:HTREC-STATI>                            Chlr1 1674
            PMPfrac   = Frac                                                    Chlr1 1675
            CALL PUMP                                                           Chlr1 1676
c              add pump heat into heat reclaim                                  Chlr1 1677
            EQrecvr   = EQrecvr - PMPQ                                          Chlr1 1678
c              sum into auxiliary pump kW                                       Chlr1 1679
            AuxPumpKW = AuxPumpKW + PMPkW                                       Chlr1 1680
          ELSE                                                                  Chlr1 1681
c              no heat reclaim pump - pass reclaim head onto reclaim loop       Chlr1 1682
c              note that this head is not assumed to vary hourly, and is        Chlr1 1683
c              accounted for in a design variable                               Chlr1 1684
          ENDIF                                                                 Chlr1 1685
        ENDIF                                                                   Chlr1 1686
        Jlp = JlpEvap                                                           Chlr1 1687
      ENDIF  ! heat recovery                                                    Chlr1 1688
c                                                                               Chlr1 1689
c              Condenser performance - note that jacket heat is assumed         Chlr1 1690
c              to be added downstream of the condenser, and is not              Chlr1 1691
c              included in the condenser temperature calcs                      Chlr1 1692
      Jlp = <ch:CW-LOOP>                                                        Chlr1 1693
c              condenser flow & head                                            Chlr1 1694
      IF (<ch:CW-CTRL> .EQ. ConstantFlow)  THEN                                 Chlr1 1695
c              constant flow                                                    Chlr1 1696
        CWflow = <ch;DES_CW_GPM>                                                Chlr1 1697
        CWhead = <ch:CW-HEAD>                                                   Chlr1 1698
      ELSE                                                                      Chlr1 1699
c              variable flow                                                    Chlr1 1700
        PLRflow = (PLR-<ch:CW-MIN-PLR>) / (1.-<ch:CW-MIN-PLR>)                  Chlr1 1701
        PLRflow = MAX(0., MIN(1., PLRflow))                                     Chlr1 1702
        CWflow  = <ch:CW-MIN-GPM>                                               Chlr1 1703
     &          + (<ch;DES_CW_GPM>-<ch:CW-MIN-GPM>)*PLRflow                     Chlr1 1704
c              leaving condenser temperature                                    Chlr1 1705
        dT      = EQcond/(<lp;BTUH/GPM-F>*CWflow*Frac)                          Chlr1 1706
        Tcwr    = <ch;ECT> + dT                                                 Chlr1 1707
        IF (PLRflow         .LT. 1.0     .AND.                                  Chlr1 1708
     &      <ch:MAX-COND-T> .NE. UNFILD  .AND.                                  Chlr1 1709
     &      Tcwr            .GT. <ch:MAX-COND-T>)  THEN                         Chlr1 1710
          IF (<ch;ECT> .LT. <ch:MAX-COND-T>)  THEN                              Chlr1 1711
            dT     = <ch:MAX-COND-T> - <ch;ECT>                                 Chlr1 1712
            CWflow = EQcond / (<lp;BTUH/GPM-F>*dT*Frac)                         Chlr1 1713
            CWflow = MIN(<ch;DES_CW_GPM>, CWflow)                               Chlr1 1714
          ELSE                                                                  Chlr1 1715
            CWflow = <ch;DES_CW_GPM>                                            Chlr1 1716
          ENDIF                                                                 Chlr1 1717
        ENDIF                                                                   Chlr1 1718
        PLRflow = CWflow / <ch;DES_CW_GPM>                                      Chlr1 1719
        CWhead  = <ch:CW-HEAD> * PLRflow**1.8                                   Chlr1 1720
      ENDIF                                                                     Chlr1 1721
c              Leaving condenser temperature                                    Chlr1 1722
      dT    = EQcond/(<lp;BTUH/GPM-F>*CWflow*Frac)                              Chlr1 1723
      Tcwr  = <ch;ECT> + dT                                                     Chlr1 1724
c              Effective entering condenser temperature, adjusted for           Chlr1 1725
c              reduced flow                                                     Chlr1 1726
      Tcond = Tcwr - dT*MIN(1.,CWflow/<ch;RatedCWgpm>)                          Chlr1 1727
      Tcond = MAX(<ch:MIN-COND-T>, Tcond)                                       Chlr1 1728
c              if chiller has an attached condenser pump                        Chlr1 1729
      IF (<ch:CW-PUMP> .GT. 0)  THEN                                            Chlr1 1730
        Jpm = <ch:CW-PUMP>                                                      Chlr1 1731
c              if the loop has its own pump, then this condenser pump           Chlr1 1732
c              is an equipment pump and can be simulated now.  If the           Chlr1 1733
c              loop does not have its own pump, then this pump powers           Chlr1 1734
c              the loop and must be simulated later when more is known          Chlr1 1735
c              about the total loop flow and head.                              Chlr1 1736
        IF (<pm;TYPE> .EQ. EquipmentPump)  THEN                                 Chlr1 1737
c                 equipment pump                                                Chlr1 1738
          PMPgpm    = CWflow                                                    Chlr1 1739
          PMPset    = CWhead + <ch:CW-STATIC>                                   Chlr1 1740
          PMPfric   = CWhead                                                    Chlr1 1741
          PMPstatic = <ch:CW-STATIC>                                            Chlr1 1742
          PMPfrac   = 1.    ! runs continuously                                 -047e    5
          CALL PUMP                                                             Chlr1 1744
          AuxPumpKW = AuxPumpKW + PMPkW                                         Chlr1 1745
c                 add condenser pump heat into condenser water                  Chlr1 1746
          EQcond    = EQcond + PMPQ                                             Chlr1 1747
        ELSEIF (SimCtrl .NE. 11)  THEN                                          -041g    3
c                 condenser pump powers the loop - save for later               Chlr1 1749
          <pm;GPM>        = CWflow                                              Chlr1 1750
          <pm;EQUIP_HEAD> = CWhead                                              Chlr1 1751
        ENDIF                                                                   Chlr1 1752
      ENDIF                                                                     Chlr1 1753
      Jlp   = JlpEvap                                                           Chlr1 1754
c                                                                               Chlr1 1755
c              Check if Tcond converged                                         Chlr1 1756
      Error = Tcond - Tlast                                                     -047j   24
      IF (Abs(Error) .lt. 0.1) THEN             ! converged                     -047j   25
      ELSEIF (IterT .eq. 20) THEN               ! convergence failure           -047j   26
        Call MsgSim(-2,II,II,II,II)                                             -047j   27
        Write (iOutpt,9101)  (<ch:NAME>,II=1,8)                                 -047j   28
      ELSE                                       ! iterate again                -047j   29
        IF (ErrorLast/Error .lt. 0.)  Tcond = (Tcond+Tlast)*0.5                 -047j   30
        ErrorLast = Error                                                       -047j   31
        GoTo 20                                                                 -047j   32
      ENDIF                                                                     -047j   33
c                                                                               Chlr1 1767
c ****         run function : Chiller_Engine_1-3                                Chlr1 1768
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        Chlr1 1769
c                                                                               Chlr1 1770
      <pe;OPER_CAPACITY> = OperCap                                              Chlr1 1771
      IF (SimCtrl .EQ. 11)  THEN                                                Chlr1 1772
c              maximum output - adjust by any parasitic load such as            Chlr1 1773
c              a pump, and reduce capacity if the HW loop is overloaded         Chlr1 1774
        <pe;MAX_CAPACITY> = OperCap - <pe;Q_PARASITIC> - EQstart                Chlr1 1775
        RETURN                                                                  Chlr1 1776
      ENDIF                                                                     Chlr1 1777
c                                                                               Chlr1 1778
c              Deduct htrec flow from available                                 Chlr1 1779
      IF (EQrecvr .LT. 0.)  THEN                                                Chlr1 1780
        Jlp            = <ch:HTREC-LOOP>                                        Chlr1 1781
        <lp;HTREC_GPM> = <lp;HTREC_GPM> - HTRECflow*Frac                        Chlr1 1782
        <lp;Q_HTREC>   = <lp;Q_HTREC> + EQrecvr                                 Chlr1 1783
      ENDIF                                                                     Chlr1 1784
      Jlp = JlpEvap                                                             Chlr1 1785
c                                                                               CHENG1 299
c              Auxiliary power                                                  CHENG1 300
 1000 IF (<ch:AUX-KW> .GT. 0.)  THEN                                            CHENG1 301
c              if always on                                                     CHENG1 302
        IF (<ch:AUX-MODE> .EQ. Always)  THEN                                    CHENG1 303
          EQaux = <ch:AUX-KW>                                                   CHENG1 304
        ELSEIF (<ch:AUX-MODE> .EQ. WhenOn)  THEN                                CHENG1 305
          EQaux = <ch:AUX-KW> * Frac                                            CHENG1 306
        ELSEIF (<ch:AUX-MODE> .EQ. WhenOff)  THEN                               CHENG1 307
          EQaux = <ch:AUX-KW> * (1.0 - Frac)                                    CHENG1 308
        ELSE                                                                    Time    18
          EQaux = <ch:AUX-KW> * SchVal(<ch:AUX-SCH>, 1.)                        Time    19
        ENDIF                                                                   CHENG1 311
      ENDIF                                                                     CHENG1 312
c                                                                               CHENG1 313
c ****         run function : Chiller_Engine_1-4                                CHENG1 314
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        CHENG1 315
c                                                                               CHENG1 316
c                                                                               CHENG1 317
c              report variables                                                 CHENG1 318
      <ch;KW>      = EQelec                                                     CHENG1 319
      <ch;HtRejKW> = EQfanKW                                                    -033     4
      <ch;FUEL>    = EQfuel                                                     CHENG1 320
      <ch;Q_RECVR> = EQrecvr                                                    CHENG1 321
      <ch;AUX>     = EQaux                                                      CHENG1 322
      <ch;CWload>  = EQcond + Qjacket                                           Chlr1 1786
      <ch;CWflow>  = CWflow  ! no adjustment for cycling                        -047e    6
      <ch;CWhead>  = CWhead                                                     ChlrHP 639
      <ch;Tcond>   = Tcond                                                      -041h    3
c                                                                               CHENG1 323
c              hourly-report variables                                          CHENG1 324
      IF (<ch;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                                CHENG1 325
     &  CALL HourRepPLT(EQUIPDAT(1), <ch;HREP>, 16, 0)                          CHENG1 326
c                                                                               CHENG1 327
      RETURN                                                                    CHENG1 328
c                                                                               Chlr1 1788
 9101 FORMAT(                                                                   Chlr1 1789
     &14x,'Chiller Tcond convergence failure: ',8A4                    )        Chlr1 1790
      END                                                                       CHENG1 329
      SUBROUTINE Chiller_FreeCool                                               CHFREE   2
c                                                                               CHFREE   3
c              Simulates a waterside economizer                                 -042j2   1
c                                                                               -042j2   2
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /EQUIPD/ EQload, EQrun, EQhgb, OperCap, Frac,                     /EQUIPD/ 2
     &                 PLR, EQsupplyT, Tcond,                                   Chlr1    1
     &                 EIRPLR, EIRFT, EQEIR, EQelec, EQfanKW, EQaux,            /EQUIPD/ 4
     &                 HIRPLR, HIRFT, EQHIR, EQfuel, EQcond, EQrecvr,           /EQUIPD/ 5
     &                 HWflow, HWhead, CHWflow, CHWhead, CWflow, CWhead,        /EQUIPD/ 6
     &                 HTRECflow,HTREChead, Qenvir, EQstart, EQloadH,           -041d    1
     &                 EQstartH, PLRh, FracH, EQfuelH, EQelecH                  /EQUIPD/ 8
      REAL             EQUIPDAT(36)                                             /EQUIPD/10
      EQUIVALENCE      (EQUIPDAT(1), EQload), (Tambient, Tcond)                 FreeCl   1
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               -042j2  16
      COMMON  /CHLRKY/ ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 2
     &                 WaterCool, AirCool                                       /CHLRKY/ 3
      INTEGER          ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 4
     &                 WaterCool, AirCool                                       /CHLRKY/ 5
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
c                                                                               -042j2  21
c                                                                               -042j2  22
c              pointer to chiller condenser loop                                -042j2  23
      JlpEvap = Jlp                                                             -042j2  24
c                                                                               -042j2  25
c              zero hourly chiller data                                         -042j2  26
      CALL FILLN(0., EQUIPDAT(1), IVTLIM(2,16))                                 -042j2  27
c                                                                               -042j2  28
c              required leaving evaporator temperature                          -042j2  29
      EQsupplyT = <pe;SUPPLY_T>                                                 -042j2  30
c                                                                               -042j2  31
c ****         run function : Chiller_FreeCool_1-1                              -042j2  32
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        -042j2  33
c                                                                               -042j2  34
c============= ROUTINE CALLED TO GET OPERATING CAPACITY ======================= -042j2  35
      IF (SimCtrl .EQ. 11)  THEN                                                -042j2  36
c              Initialize CW loop variables                                     -042j2  37
        Jlp              = <ch:CW-LOOP>                                         -042j2  38
        Setpt1           = <lp:CL-SETPT-T>                                      -042j2  39
        <lp:CL-SETPT-T>  = 32.                                                  -042j2  40
        Setpt2           = <lp;COOL_SETPT>                                      -042j2  41
        <lp;COOL_SETPT>  = 32.                                                  -042j2  42
        SetptMin         = <lp:MIN-RESET-T>                                     -042j2  43
        <lp:MIN-RESET-T> = 32.                                                  -042j2  44
        SetptRng         = <lp:SETPT-RNG>                                       -042j2  45
        <lp:SETPT-RNG>   = 1.                                                   -042j2  46
        Qfree            = QloopNet + <pe;Q_PARASITIC>                          -042j2  47
c                                                                               -042j2  48
c              Initialize tower variables                                       -042j2  49
        Jtw = <ch;FreeCoolTwr>                                                  -042j2  50
        Jpe = <tw;Jpe>                                                          -042j2  51
        IF (<ch:CW-CTRL> .EQ. ConstantFlow)  THEN                               -042j2  52
c              constant flow                                                    -042j2  53
          <pe;GPM> = <ch;DES_CW_GPM>                                            -042j2  54
        ELSE                                                                    -042j2  55
c              variable flow - linear with load                                 -042j2  56
          <pe;GPM> = GPMs                                                       -042j2  57
        ENDIF                                                                   -042j2  58
        Cmin      = MIN(<pe;GPM>, GPMs) * <lp;BTUH/GPM-F>                       -042j2  59
        <pe;LOAD> = Qfree                                                       -042j2  60
c              see what temperature heat-rejection can produce                  -042j2  61
        SimCtrl = 12                                                            -042j2  62
        SELECT CASE (<pe:ALGORITHM>)                                            -042j2  63
          CASE (401)     ! Open towers                                          -042j2  64
            CALL CoolingTwr_1                                                   -042j2  65
          CASE (402)     ! Fluid Coolers                                        -042j2  66
            Call FluidCooler_1                                                  -042j2  67
          CASE (403)     ! Dry Coolers                                          -042j2  68
            Call DryCooler_1                                                    -042j2  69
        END SELECT                                                              -042j2  70
        <ch;Tcond> = <pe;SUPPLY_T>                                              -042j2  71
c                                                                               -042j2  72
c              restore variables                                                -042j2  73
        <lp:CL-SETPT-T>  = Setpt1                                               -042j2  74
        <lp;COOL_SETPT>  = Setpt2                                               -042j2  75
        <lp:MIN-RESET-T> = SetptMin                                             -042j2  76
        <lp:SETPT-RNG>   = SetptRng                                             -042j2  77
        Jpe              = <ch;Jpe>                                             -042j2  78
        Jlp              = JlpEvap                                              -042j2  79
        SimCtrl          = 11                                                   -042j2  80
c                                                                               -042j2  81
c              Check if temperature sufficient                                  -042j2  82
        Treqd = <lp;RETURN_T> - Qfree/(Cmin * <ch:ECONO-EFF>)                   -042j2  83
        IF (<ch;Tcond> .LE. Treqd)  THEN                                        -042j2  84
c              free cooling active                                              -042j2  85
          <pe;LOAD>          = Qfree - <pe;Q_PARASITIC>                         -042j2  86
          <pe;OPER_CAPACITY> = Cmin * <ch:ECONO-EFF>                            -042j2  87
     &                              * (<lp;RETURN_T>-<ch;Tcond>)                -042j2  88
          <pe;MAX_CAPACITY>  = <pe;OPER_CAPACITY> - <pe;Q_PARASITIC>            -042j2  89
          <ch;ECTsetpt>      = Treqd                                            -042j2  90
          <ch;Tcond>         = Treqd                                            -042j2  91
        ENDIF                                                                   -042j2  92
c                                                                               -042j2  93
c ****         run function : Chiller_FreeCool_1-2                              -042j2  94
c       IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                      -042j2  95
c                                                                               -042j2  96
        RETURN                                                                  -042j2  97
      ENDIF                                                                     -042j2  98
c                                                                               -042j2  99
c============= ROUTINE CALLED TO SIMULATE EQUIPMENT =========================== -042j2 100
c                                                                               -042j2 101
c              initialize free cooling flag on CW side                          -042j2 102
      Jlp               = <ch:CW-LOOP>                                          -042j2 103
      <lp;FreeCoolChlr> = 0                                                     -042j2 104
      Jlp               = JlpEvap                                               -042j2 105
      AuxPumpKW         = 0.                 ! total equipment pump kW          -042j2 106
      EQload            = <pe;LOAD>          ! hourly load                      -042j2 107
c                                                                               -042j2 108
c ****         run function : Chiller_FreeCool_1-3                              -042j2 109
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        -042j2 110
c                                                                               -042j2 111
c              skip if no load                                                  -042j2 112
      IF (<pe;GPM> .EQ. 0.)  GOTO 1000                                          -042j2 113
c                                                                               -042j2 114
c              chilled water pump attached to this chiller                      -042j2 115
      IF (<ch:CHW-PUMP> .GT. 0)  THEN                                           -042j2 116
        Jpm = <ch:CHW-PUMP>                                                     -042j2 117
c              fraction of the hour the pump operates                           -042j2 118
        PMPfrac = 1.0                                                           -042j2 119
c              do the pump simulation                                           -042j2 120
        CALL PumpSupply                                                         -042j2 121
c              skip if pump was forced to run when no load on unit              -042j2 122
        IF (EQload .EQ. 0.)  GOTO 1000                                          -042j2 123
c              add pump heat to load                                            -042j2 124
        EQload = EQload + PMPQ                                                  -042j2 125
c              sum into auxiliary pump Kw (equipment pumps only)                -042j2 126
        IF (<pm;TYPE> .EQ. EquipmentPump)                                       -042j2 127
     &                                AuxPumpKW = AuxPumpKW + PMPkW             -042j2 128
      ENDIF                                                                     -042j2 129
c                                                                               -042j2 130
c              Water-cooled condenser                                           -042j2 131
      EQcond = EQload                                                           -042j2 132
      Tcond  = <ch;Tcond>                                                       -042j2 133
c              set free cooling flag in CW loop                                 -042j2 134
      Jlp               = <ch:CW-LOOP>                                          -042j2 135
      <lp;FreeCoolChlr> = -Jch                                                  -042j2 136
c              condenser flow & head                                            -042j2 137
      IF (<ch:CW-CTRL> .EQ. ConstantFlow)  THEN                                 -042j2 138
c              constant flow                                                    -042j2 139
        CWflow = <ch;DES_CW_GPM>                                                -042j2 140
        CWhead = <ch:CW-HEAD>                                                   -042j2 141
      ELSE                                                                      -042j2 142
c              variable flow - linear with load                                 -042j2 143
        CWflow  = <pe;GPM>                                                      -042j2 144
        PLRflow = CWflow / <ch;DES_CW_GPM>                                      -042j2 145
        CWhead  = <ch:CW-HEAD> * PLRflow**1.8                                   -042j2 146
      ENDIF                                                                     -042j2 147
c              if chiller has an attached condenser pump                        -042j2 148
      IF (<ch:CW-PUMP> .GT. 0)  THEN                                            -042j2 149
        Jpm = <ch:CW-PUMP>                                                      -042j2 150
c              if the loop has its own pump, then this condenser pump           -042j2 151
c              is an equipment pump and can be simulated now.  If the           -042j2 152
c              loop does not have its own pump, then this pump powers           -042j2 153
c              the loop and must be simulated later when more is known          -042j2 154
c              about the total loop flow and head.                              -042j2 155
        IF (<pm;TYPE> .EQ. EquipmentPump)  THEN                                 -042j2 156
c                 equipment pump                                                -042j2 157
          PMPgpm    = CWflow                                                    -042j2 158
          PMPset    = CWhead + <ch:CW-STATIC>                                   -042j2 159
          PMPfric   = CWhead                                                    -042j2 160
          PMPstatic = <ch:CW-STATIC>                                            -042j2 161
          PMPfrac   = 1.    ! runs continuously                                 -047e    7
          CALL PUMP                                                             -042j2 163
c                 add condenser pump heat into condenser water                  -042j2 164
          Qcwp      = PMPQ                                                      -042j2 165
c                 sum into auxiliary pump kW                                    -042j2 166
          AuxPumpKW = AuxPumpKW + PMPkW                                         -042j2 167
        ELSE                                                                    -042j2 168
c              condenser pump powers the loop - save for later                  -042j2 169
          <pm;GPM>        = CWflow                                              -042j2 170
          <pm;EQUIP_HEAD> = CWhead                                              -042j2 171
        ENDIF                                                                   -042j2 172
        EQcond = EQload + Qcwp                                                  -042j2 173
      ENDIF                                                                     -042j2 174
c                                                                               -042j2 175
c              point back at evaporator loop                                    -042j2 176
 1000 Jlp = JlpEvap                                                             -042j2 177
c                                                                               -042j2 178
c              Auxiliary power                                                  -042j2 179
      IF (<ch:AUX-KW> .GT. 0.)  THEN                                            -042j2 180
c              if always on                                                     -042j2 181
        IF (<ch:AUX-MODE> .EQ. Always)  THEN                                    -042j2 182
          EQaux = <ch:AUX-KW>                                                   -042j2 183
        ELSEIF (<ch:AUX-MODE> .EQ. WhenOn)  THEN                                -042j2 184
          IF (EQload .GT. 0.)  EQaux = <ch:AUX-KW>                              -042j2 185
        ELSEIF (<ch:AUX-MODE> .EQ. WhenOff)  THEN                               -042j2 186
          IF (EQload .GT. 0.)  EQaux = <ch:AUX-KW>                              -042j2 187
        ELSE                                                                    -042j2 188
          EQaux = <ch:AUX-KW> * SchVal(<ch:AUX-SCH>, 1.)                        -042j2 189
        ENDIF                                                                   -042j2 190
      ENDIF                                                                     -042j2 191
c                                                                               -042j2 192
c ****         run function : Chiller_FreeCool_1-4                              -042j2 193
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        -042j2 194
c                                                                               -042j2 195
c              report variables                                                 -042j2 196
      <ch;AUX>     = EQaux                                                      -042j2 197
      <ch;CWload>  = EQcond                                                     -042j2 198
      <ch;CWflow>  = CWflow                                                     -042j2 199
      <ch;CWhead>  = CWhead                                                     -042j2 200
c                                                                               -042j2 201
c              hourly-report variables                                          -042j2 202
      IF (<ch;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                                -042j2 203
     &  CALL HourRepPLT(EQUIPDAT(1), <ch;HREP>, 16, 0)                          -042j2 204
c                                                                               CHFREE 204
      RETURN                                                                    CHFREE 205
      END                                                                       CHFREE 206
      SUBROUTINE Chiller_Gas_1(Mode)                                            CHGAS1   2
c                                                                               CHGAS1   3
c                                                                               CHGAS1   4
c              Simulates gas-fired absorption chillers, including               CHGAS1   5
c              low temperature heat recovery and direct-fired heating           CHGAS1   6
c                                                                               CHGAS1   7
c              Mode = 1  Heating                                                CHGAS1   8
c                     2  Cooling                                                CHGAS1   9
c                                                                               CHGAS1  10
c              This device provides both heating and cooling, and appears       CHGAS1  11
c              to the outside world as both a chiller and heater.  This         CHGAS1  12
c              is accomplished by creating a "ghost" of the actual              CHGAS1  13
c              chiller that stores the heating variables.  The LOOP and         CHGAS1  14
c              EQUIP-CTRL sequences to which the heating side is attached       CHGAS1  15
c              point to the ghost rather than the actual component.             CHGAS1  16
c                  Jch always points to the real component                      CHGAS1  17
c                  Jpe points to the real component during cooling, and         CHGAS1  18
c                             to the ghost component during heating             CHGAS1  19
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /EQUIPD/ EQload, EQrun, EQhgb, OperCap, Frac,                     /EQUIPD/ 2
     &                 PLR, EQsupplyT, Tcond,                                   Chlr1    1
     &                 EIRPLR, EIRFT, EQEIR, EQelec, EQfanKW, EQaux,            /EQUIPD/ 4
     &                 HIRPLR, HIRFT, EQHIR, EQfuel, EQcond, EQrecvr,           /EQUIPD/ 5
     &                 HWflow, HWhead, CHWflow, CHWhead, CWflow, CWhead,        /EQUIPD/ 6
     &                 HTRECflow,HTREChead, Qenvir, EQstart, EQloadH,           -041d    1
     &                 EQstartH, PLRh, FracH, EQfuelH, EQelecH                  /EQUIPD/ 8
      REAL             EQUIPDAT(36)                                             /EQUIPD/10
      EQUIVALENCE      (EQUIPDAT(1), EQload), (Tambient, Tcond)                 FreeCl   1
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               CHGAS1  33
      COMMON  /CHLRKY/ ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 2
     &                 WaterCool, AirCool                                       /CHLRKY/ 3
      INTEGER          ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 4
     &                 WaterCool, AirCool                                       /CHLRKY/ 5
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
c                                                                               CHGAS1  38
      LOGICAL DescRegen                                                         Chlr1 1792
c                                                                               Chlr1 1793
c              pointer to chiller evaporator loop                               Chlr1 1794
      JlpEvap = Jlp                                                             Chlr1 1795
c                                                                               Chlr1 1796
c              zero hourly chiller data                                         Chlr1 1797
      CALL FILLN(0., EQUIPDAT(1), IVTLIM(2,16))                                 Chlr1 1798
                                                                                Chlr1 1799
c              required leaving evaporator temperature                          Chlr1 1800
      EQsupplyT = <pe;SUPPLY_T>                                                 Chlr1 1801
c                                                                               Chlr1 1802
c ****         run function : Chiller_Gas_1-1                                   Chlr1 1803
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        Chlr1 1804
c                                                                               Chlr1 1805
      IF (Mode .EQ. HEATMODE)  GOTO 2000                                        Chlr1 1806
c                                                                               Chlr1 1807
c============= COOLING MODE =================================================== Chlr1 1808
c                                                                               Chlr1 1809
c              Flag to indicate dessicant regeneration active                   Chlr1 1810
      IF (<ch;DESC_Q> .LT. 0.  .AND.  <ch;DESC_T> .LT. 140.)  THEN              Chlr1 1811
        DescRegen = .TRUE.                                                      Chlr1 1812
      ELSE                                                                      Chlr1 1813
        DescRegen = .FALSE.                                                     Chlr1 1814
      ENDIF                                                                     Chlr1 1815
c                                                                               Chlr1 1816
      IF (SimCtrl .EQ. 11)  THEN                                                Chlr1 1817
c              Routine called to get operating capacity                         Chlr1 1818
c              initialize leaving condenser temperature                         Chlr1 1819
        IF (DescRegen)  THEN                                                    Chlr1 1820
          <ch;ECT> = <ch:RATED-COND-T>                                          Chlr1 1821
        ELSE                                                                    Chlr1 1822
          Jlp      = <ch:CW-LOOP>                                               Chlr1 1823
          <ch;ECT> = <lp;COIL_EWTest>                                           Chlr1 1824
        ENDIF                                                                   Chlr1 1825
        Tcond           = <ch;ECT>                                              Chlr1 1826
        <ch;Tcond> = MAX(Tcond, <ch:MIN-COND-T>)                                Chlr1 1827
      ELSEIF (<pe;GPM> .EQ. 0.)  THEN   ! chiller is off                        -044c4 177
c              go thru dilution cycle if chiller just shut down                 -044c4 178
        IF (<pe;HOURS_OFF> .EQ. 0)                                              -044c4 179
     &    EQelec = <ch:CAP> * <ch:EIR> * <ch:STOP-TIME> * KWBTU                 -044c4 180
     &                                 * <ch;Pump/TotalKW>                      -044c4 181
        GOTO 1000                                                               -044c4 182
      ENDIF                                                                     -044c4 183
c                                                                               -044c4 184
c              Start-up load - assume warm-up time is reduced if chiller        -044c4 185
c              has been running in heat mode                                    -044c4 186
      EQstart = StartUpLoad(Jpe)                                                -044c4 187
      Jpe     = <ch;Jpe_HEAT>                                                   -044c4 188
      IF (<pe;HOURS_OFF> .EQ. 0)  EQstart = EQstart * 0.5                       -044c4 189
      Jpe     = <ch;Jpe>                                                        -044c4 190
c                                                                               Chlr1 1845
c ****         run function : Chiller_Gas_1-2                                   Chlr1 1846
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        Chlr1 1847
c                                                                               Chlr1 1848
c              Start of iterative loop on condenser temperature                 Chlr1 1849
      Tcond     = <ch;Tcond>                                                    Chlr1 1850
      ErrorLast = 0                                                             -047j   34
      IterT     = 0                                                             Chlr1 1851
   20 IterT     = IterT + 1                                                     Chlr1 1852
      AuxPumpKW = 0.                   ! local pump kW                          Chlr1 1853
      Tlast     = Tcond                                                         Chlr1 1854
c              operating capacity                                               Chlr1 1855
      Cap_fT  = CVAL(<ch:CAP-FT>, EQsupplyT, Tcond)                             Chlr1 1856
      OperCap = <ch;NormalCap> * Cap_fT                                         Chlr1 1857
c                                                                               -044c4 191
      IF (SimCtrl .EQ. 11)  THEN       ! getting capacity                       -044c4 192
        EQload = OperCap - EQstart                                              -044c4 193
      ELSE                             ! normal call                            -044c4 194
        EQload = <pe;LOAD>                                                      -044c4 195
c              local chilled water pump                                         -044c4 196
        IF (<ch:CHW-PUMP> .ne. 0)  THEN                                         -047k   12
          Jpm     = <ch:CHW-PUMP>                                               -044c4 198
          PMPfrac = 1.0                ! runs full hour                         -044c4 199
          CALL PumpSupply                                                       -044c4 200
          EQload = EQload + PMPQ       ! add pump heat to load                  -044c4 201
c              sum into auxiliary pump Kw (equipment pumps only)                -044c4 202
          IF (<pm;TYPE> .EQ. EquipmentPump)                                     -044c4 203
     &                                AuxPumpKW = AuxPumpKW + PMPkW             -044c4 204
        ENDIF                                                                   -044c4 205
      ENDIF                                                                     -044c4 206
c                                                                               -044c4 207
c              Part load ratio, including startup load                          -044c4 208
      Qnet = EQload + EQstart                                                   -044c4 209
      PLR  = Qnet / OperCap                                                     -044c4 210
      IF (PLR .gt. <ch:MIN-RATIO>)  THEN  ! equipment runs full hour            -044c4 211
        Frac     = 1.                                                           -044c4 212
        FracElec = 1.                                                           -044c4 213
      ELSE  ! fraction of hour operating                                        -044c4 214
        PLR      = <ch:MIN-RATIO>                                               -044c4 215
        CapMin   = OperCap*<ch:MIN-RATIO>                                       -044c4 216
        Frac     = Qnet / CapMin                                                -044c4 217
c              include standby losses                                           -044c4 218
        Qstandby = Min(<ch:CAP>*<ch:STANDBY-TIME>, CapMin)                      -044c4 219
        Qstandby = Qstandby * (1.0 - Frac)                                      -044c4 220
        Qnet     = Qnet + Qstandby                                              -044c4 221
        Frac     = Qnet / CapMin                                                -044c4 222
c              include dilution cycle elec; assume 2 cycles per hour avg        -044c4 223
        FanFrac  = Frac * (1.- <ch;Pump/TotalKW>)                               -044c4 224
        PumpFrac = Min(1., Frac + <ch:STOP-TIME>*2.) * <ch;Pump/TotalKW>        -044c4 225
        FracElec = FanFrac + PumpFrac                                           -044c4 226
      ENDIF                                                                     -044c4 227
c              operating point of machine                                       Chlr1 1904
      EQrun  = OperCap * PLR                                                    Chlr1 1905
c                                                                               Chlr1 1906
c              Solution pump power - note that elec is function of              Chlr1 1907
c              rated cap and EIR, not operating cap                             Chlr1 1908
      EIRFT  = CVAL(<ch:EIR-FT>, EQsupplyT, Tcond)                              Chlr1 1909
      dT     = Tcond - EQsupplyT                                                Chlr1 1910
      EIRPLR = CVAL(<ch:EIR-FPLR>, PLR, dT)                                     Chlr1 1911
      EQEIR  = <ch:EIR> * EIRFT * EIRPLR                                        Chlr1 1912
      EQelec = <ch:CAP> * EQEIR * FracElec * KWBTU                              -044c4 228
c                                                                               Chlr1 1914
c              Heat consumption                                                 Chlr1 1915
      HIRFT  = CVAL(<ch:HIR-FT>, EQsupplyT, Tcond)                              Chlr1 1916
      HIRPLR = CVAL(<ch:HIR-FPLR>, PLR, dT)                                     Chlr1 1917
      EQHIR  = <ch;NormalHIR> * HIRFT * HIRPLR                                  Chlr1 1918
      IF (DescRegen)  THEN                                                      Chlr1 1919
c              modify HIR as a function of the required desiccant               Chlr1 1920
c              regeneration temperature - temp was set in the airside           Chlr1 1921
        HIRFTd = CVAL(<ch:HIR-FDESCT>,<ch;DESC_T>,<ch;DESC_T>)                  Chlr1 1922
        EQHIR  = EQHIR * HIRFTd                                                 Chlr1 1923
      ENDIF                                                                     Chlr1 1924
      EQfuel = OperCap * EQHIR * Frac                                           Chlr1 1925
                                                                                Chlr1 1926
c              Rejected heat                                                    Chlr1 1927
      EQcond = EQload + EQelec*<ch:ELEC-TO-COND>*BTUKW                          -044c4 229
     &                + EQfuel*<ch:HEAT-TO-COND>                                -044c4 230
c                                                                               Chlr1 1930
c              check for desiccant regeneration heat recovery                   Chlr1 1931
      IF (DescRegen)  THEN                                                      Chlr1 1932
c              condenser heat available for desiccant regeneration              Chlr1 1933
        EQregen  = -EQfuel * CVAL(<ch:QREG-FDESCT>,ECT,ECT)                     Chlr1 1934
c              limit by the amount required                                     Chlr1 1935
        EQregen  = MAX(EQregen, <ch;DESC_Q>)                                    Chlr1 1936
        EQcond   = EQcond + EQregen                                             Chlr1 1937
c              amount of supplemental heating required                          Chlr1 1938
        SuppFuel = -(<ch;DESC_Q> - EQregen) / <ch:DESC-XEFF>                    Chlr1 1939
        EQfuel   = EQfuel + SuppFuel                                            Chlr1 1940
      ENDIF                                                                     Chlr1 1941
c                                                                               Chlr1 1942
c              Check for condenser heat recovery                                Chlr1 1943
      IF (<ch:HTREC-LOOP> .EQ. 0.)  THEN                                        Chlr1 1944
        HtRecMaxT = -88888.                                                     Chlr1 1945
      ELSE                                                                      Chlr1 1946
        Jlp       = <ch:HTREC-LOOP>                                             Chlr1 1947
        HtrecMaxT = MIN(<ch:RECOVER-T>, <lp;SUPPLY_T>)                          Chlr1 1948
        IF (<lp;CTRL_MODE> .NE. HEATMODE                                        Chlr1 1949
     &                      .OR.  HtrecMaxT .LE. <lp;RETURN_T>)  THEN           Chlr1 1950
          HtRecMaxT = -88888.                                                   Chlr1 1951
        ELSE                                                                    Chlr1 1952
c              htrec flow cannot be greater than the loop flow, adjusted        Chlr1 1953
c              for the flow which goes thru other htrec devices                 Chlr1 1954
          HTRECflow = MIN(<ch;DES_HTR_GPM>, <lp;HTREC_GPM>)                     Chlr1 1955
c              maximum recoverable heat based on temperature and flow           Chlr1 1956
          EQrecvr = <lp;BTUH/GPM-F> * HTRECflow                                 Chlr1 1957
     &                              * (HtrecMaxT - <lp;RETURN_T>)               Chlr1 1958
     &                              * Frac                                      Chlr1 1959
c              limit by the amount the chiller can produce, and change sign     Chlr1 1960
c              for heating                                                      Chlr1 1961
          EQrecvr = -MIN(EQcond, EQrecvr)                                       Chlr1 1962
          EQcond  = EQcond + EQrecvr                                            Chlr1 1963
c              if chiller has a heat reclaim pump                               Chlr1 1964
          IF (<ch:HTREC-PUMP> .GT. 0  .AND.  SimCtrl .NE. 11)  THEN             Chlr1 1965
            Jpm = <ch:HTREC-PUMP>                                               Chlr1 1966
            IF (<ch:HTREC-CTRL> .EQ. ConstantFlow)  THEN                        Chlr1 1967
c              constant flow                                                    Chlr1 1968
              HTREChead = <ch:HTREC-HEAD> + <ch:HTREC-STATI>                    Chlr1 1969
            ELSE                                                                Chlr1 1970
c              variable flow - matches prorated loop flow                       Chlr1 1971
              HTRECflow = MAX(HTRECflow, <ch:HTREC-MIN-G>)                      Chlr1 1972
              PLRflow   = HTRECflow / <ch;DES_HTR_GPM>                          Chlr1 1973
              HTREChead = <ch:HTREC-HEAD> * PLRflow**1.8                        Chlr1 1974
     &                  + <ch:HTREC-STATI>                                      Chlr1 1975
            ENDIF                                                               Chlr1 1976
            PMPgpm    = HTRECflow                                               Chlr1 1977
            PMPfric   = HTREChead                                               Chlr1 1978
            PMPstatic = <ch:HTREC-STATI>                                        Chlr1 1979
            PMPset    = HTREChead + <ch:HTREC-STATI>                            Chlr1 1980
            PMPfrac   = Frac                                                    Chlr1 1981
            CALL PUMP                                                           Chlr1 1982
c              add pump heat into heat reclaim                                  Chlr1 1983
            EQrecvr   = EQrecvr - PMPQ                                          Chlr1 1984
c              sum into auxiliary pump kW                                       Chlr1 1985
            AuxPumpKW = AuxPumpKW + PMPkW                                       Chlr1 1986
          ELSE                                                                  Chlr1 1987
c              no heat reclaim pump - pass reclaim head onto reclaim loop       Chlr1 1988
c              note that this head is not assumed to vary hourly, and is        Chlr1 1989
c              accounted for in a design variable                               Chlr1 1990
          ENDIF                                                                 Chlr1 1991
        ENDIF                                                                   Chlr1 1992
        Jlp = JlpEvap                                                           Chlr1 1993
      ENDIF  ! heat recovery                                                    Chlr1 1994
c                                                                               Chlr1 1995
c              Condenser performance                                            Chlr1 1996
      Jlp = <ch:CW-LOOP>                                                        Chlr1 1997
c              condenser flow & head                                            Chlr1 1998
      IF (<ch:CW-CTRL> .EQ. ConstantFlow)  THEN                                 Chlr1 1999
c              constant flow                                                    Chlr1 2000
        CWflow = <ch;DES_CW_GPM>                                                Chlr1 2001
        CWhead = <ch:CW-HEAD>                                                   Chlr1 2002
      ELSE                                                                      Chlr1 2003
c              variable flow                                                    Chlr1 2004
        PLRflow = (PLR-<ch:CW-MIN-PLR>) / (1.-<ch:CW-MIN-PLR>)                  Chlr1 2005
        PLRflow = MAX(0., MIN(1., PLRflow))                                     Chlr1 2006
        CWflow  = <ch:CW-MIN-GPM>                                               Chlr1 2007
     &          + (<ch;DES_CW_GPM>-<ch:CW-MIN-GPM>)*PLRflow                     Chlr1 2008
c              leaving condenser temperature                                    Chlr1 2009
        dT      = EQcond/(<lp;BTUH/GPM-F>*CWflow*Frac)                          Chlr1 2010
        Tcwr    = <ch;ECT> + dT                                                 Chlr1 2011
        IF (PLRflow         .LT. 1.0     .AND.                                  Chlr1 2012
     &      <ch:MAX-COND-T> .NE. UNFILD  .AND.                                  Chlr1 2013
     &      Tcwr            .GT. <ch:MAX-COND-T>)  THEN                         Chlr1 2014
          IF (<ch;ECT> .LT. <ch:MAX-COND-T>)  THEN                              Chlr1 2015
            dT     = <ch:MAX-COND-T> - <ch;ECT>                                 Chlr1 2016
            CWflow = EQcond / (<lp;BTUH/GPM-F>*dT*Frac)                         Chlr1 2017
            CWflow = MIN(<ch;DES_CW_GPM>, CWflow)                               Chlr1 2018
          ELSE                                                                  Chlr1 2019
            CWflow = <ch;DES_CW_GPM>                                            Chlr1 2020
          ENDIF                                                                 Chlr1 2021
        ENDIF                                                                   Chlr1 2022
        PLRflow = CWflow / <ch;DES_CW_GPM>                                      Chlr1 2023
        CWhead  = <ch:CW-HEAD> * PLRflow**1.8                                   Chlr1 2024
      ENDIF                                                                     Chlr1 2025
c              Leaving condenser temperature                                    Chlr1 2026
      dT    = EQcond/(<lp;BTUH/GPM-F>*CWflow*Frac)                              Chlr1 2027
      Tcwr  = <ch;ECT> + dT                                                     Chlr1 2028
      IF (EQrecvr .EQ. 0.)  THEN                                                Chlr1 2029
c              Effective entering condenser temperature, adjusted for           Chlr1 2030
c              reduced flow                                                     Chlr1 2031
        Tcond  = Tcwr - dT*MIN(1., CWflow/<ch;RatedCWgpm>)                      Chlr1 2032
      ELSE                                                                      Chlr1 2033
c              Effective entering condenser temperature, adjusted for           Chlr1 2034
c              heat recovery                                                    Chlr1 2035
        Tcwr   = MAX(HtrecMaxT, Tcwr)                                           Chlr1 2036
        dT     = Tcwr - <ch;ECT>                                                Chlr1 2037
        CWflow = EQcond / (<lp;BTUH/GPM-F>*dT*Frac)                             Chlr1 2038
        dT     = (EQcond-EQrecvr)                                               Chlr1 2039
     &                       / (<lp;BTUH/GPM-F>*(HTRECflow+CWflow)*Frac)        Chlr1 2040
        Tcond  = Tcwr - dT                                                      Chlr1 2041
        IF (<ch:CW-CTRL> .EQ. ConstantFlow)  THEN                               Chlr1 2042
          CWflow = <ch;DES_CW_GPM>                                              Chlr1 2043
        ELSE                                                                    Chlr1 2044
          PLRflow = (HTRECflow+CWflow) / <ch;DES_CW_GPM>                        Chlr1 2045
          PLRflow = MIN(1., PLRflow)                                            Chlr1 2046
          CWhead  = <ch:CW-HEAD> * PLRflow**1.8                                 Chlr1 2047
        ENDIF                                                                   Chlr1 2048
      ENDIF                                                                     Chlr1 2049
      Tcond = MAX(<ch:MIN-COND-T>, Tcond)                                       Chlr1 2050
      IF (DescRegen)  Tcond = <ch;Tcond>                                        Chlr1 2051
c              if chiller has an attached condenser pump                        Chlr1 2052
      IF (<ch:CW-PUMP> .GT. 0)  THEN                                            Chlr1 2053
        Jpm = <ch:CW-PUMP>                                                      Chlr1 2054
c              if the loop has its own pump, then this condenser pump           Chlr1 2055
c              is an equipment pump and can be simulated now.  If the           Chlr1 2056
c              loop does not have its own pump, then this pump powers           Chlr1 2057
c              the loop and must be simulated later when more is known          Chlr1 2058
c              about the total loop flow and head.                              Chlr1 2059
        IF (<pm;TYPE> .EQ. EquipmentPump)  THEN                                 Chlr1 2060
c                 equipment pump                                                Chlr1 2061
          PMPgpm    = CWflow                                                    Chlr1 2062
          PMPset    = CWhead + <ch:CW-STATIC>                                   Chlr1 2063
          PMPfric   = CWhead                                                    Chlr1 2064
          PMPstatic = <ch:CW-STATIC>                                            Chlr1 2065
          PMPfrac   = 1.    ! runs continuously                                 -047e    8
          CALL PUMP                                                             Chlr1 2067
          AuxPumpKW = AuxPumpKW + PMPkW                                         Chlr1 2068
c                 add condenser pump heat into condenser water                  Chlr1 2069
          EQcond    = EQcond + PMPQ                                             Chlr1 2070
        ELSEIF (SimCtrl .NE. 11)  THEN                                          -041g    5
c                 condenser pump powers the loop - save for later               Chlr1 2072
          <pm;GPM>        = CWflow                                              Chlr1 2073
          <pm;EQUIP_HEAD> = CWhead                                              Chlr1 2074
        ENDIF                                                                   Chlr1 2075
      ENDIF                                                                     Chlr1 2076
      Jlp = JlpEvap                                                             Chlr1 2077
c                                                                               Chlr1 2078
c              Check if Tcond converged                                         Chlr1 2079
      Error = Tcond - Tlast                                                     -047j   35
      IF (Abs(Error) .lt. 0.1) THEN             ! converged                     -047j   36
      ELSEIF (IterT .eq. 20) THEN               ! convergence failure           -047j   37
        Call MsgSim(-2,II,II,II,II)                                             -047j   38
        Write (iOutpt,9101)  (<ch:NAME>,II=1,8)                                 -047j   39
      ELSE                                       ! iterate again                -047j   40
        IF (ErrorLast/Error .lt. 0.)  Tcond = (Tcond+Tlast)*0.5                 -047j   41
        ErrorLast = Error                                                       -047j   42
        GoTo 20                                                                 -047j   43
      ENDIF                                                                     -047j   44
c                                                                               Chlr1 2090
c ****         run function : Chiller_Gas_1-3                                   Chlr1 2091
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        Chlr1 2092
c                                                                               Chlr1 2093
      <pe;OPER_CAPACITY> = OperCap                                              Chlr1 2094
      IF (SimCtrl .EQ. 11)  THEN                                                Chlr1 2095
c              maximum output - adjust by any parasitic load such as            Chlr1 2096
c              a pump                                                           Chlr1 2097
        <pe;MAX_CAPACITY> = OperCap - <pe;Q_PARASITIC> - EQstart                Chlr1 2098
        <pe;MAX_CAPACITY> = MAX(0., <pe;MAX_CAPACITY>)                          Chlr1 2099
        RETURN                                                                  Chlr1 2100
      ENDIF                                                                     Chlr1 2101
c                                                                               Chlr1 2102
c              Deduct htrec flow from available                                 Chlr1 2103
      IF (EQrecvr .LT. 0.)  THEN                                                Chlr1 2104
        Jlp            = <ch:HTREC-LOOP>                                        Chlr1 2105
        <lp;HTREC_GPM> = <lp;HTREC_GPM> - HTRECflow*Frac                        Chlr1 2106
        <lp;Q_HTREC>   = <lp;Q_HTREC> + EQrecvr                                 Chlr1 2107
      ENDIF                                                                     Chlr1 2108
      Jlp = JlpEvap                                                             Chlr1 2109
c                                                                               Chlr1 2110
c              Auxiliary power                                                  Chlr1 2111
 1000 IF (<ch:AUX-KW> .GT. 0.)  THEN                                            Chlr1 2112
c              if always on                                                     Chlr1 2113
        IF (<ch:AUX-MODE> .EQ. Always)  THEN                                    Chlr1 2114
          EQaux = <ch:AUX-KW>                                                   Chlr1 2115
        ELSEIF (<ch:AUX-MODE> .EQ. WhenOn)  THEN                                Chlr1 2116
          EQaux = <ch:AUX-KW> * Frac                                            Chlr1 2117
        ELSEIF (<ch:AUX-MODE> .EQ. WhenOff)  THEN                               Chlr1 2118
          EQaux = <ch:AUX-KW> * (1.0 - Frac)                                    Chlr1 2119
        ELSE                                                                    Chlr1 2120
          EQaux = <ch:AUX-KW> * SchVal(<ch:AUX-SCH>, 1.)                        Chlr1 2121
        ENDIF                                                                   Chlr1 2122
      ENDIF                                                                     Chlr1 2123
c                                                                               Chlr1 2124
c ****         run function : Chiller_Gas_1-4                                   Chlr1 2125
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        Chlr1 2126
c                                                                               Chlr1 2127
c                                                                               Chlr1 2128
c              report variables                                                 Chlr1 2129
      <pe;LOAD>    = EQload                                                     Chlr1 2130
      <ch;KW>      = EQelec                                                     Chlr1 2131
      <ch;HtRejKW> = EQfanKW                                                    Chlr1 2132
      <ch;FUEL>    = EQfuel                                                     Chlr1 2133
      <ch;Q_RECVR> = EQrecvr + EQregen                                          Chlr1 2134
      <ch;AUX>     = EQaux                                                      Chlr1 2135
      <ch;PLR>     = PLR                                                        Chlr1 2136
      <ch;FRAC>    = Frac                                                       Chlr1 2137
      <ch;CWload>  = EQcond                                                     Chlr1 2138
      <ch;CWflow>  = CWflow  ! no adjustment for cycling                        -047e    9
      <ch;CWhead>  = CWhead                                                     Chlr1 2140
      <ch;Tcond>   = Tcond                                                      -041h    4
c                                                                               Chlr1 2141
c              hourly-report variables                                          Chlr1 2142
      IF (<ch;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                                Chlr1 2143
     &  CALL HourRepPLT(EQUIPDAT(1), <ch;HREP>, 16, 0)                          Chlr1 2144
c                                                                               Chlr1 2145
      RETURN                                                                    Chlr1 2146
c                                                                               Chlr1 2147
c============= HEATING MODE =================================================== Chlr1 2148
 2000 CONTINUE                                                                  Chlr1 2149
c                                                                               Chlr1 2150
      AuxPumpKW = 0.                                                            Chlr1 2151
c                                                                               Chlr1 2152
c              Start-up load                                                    -044c4 231
      IF (<pe;HOURS_OFF> .GT. 0)  THEN                                          -044c4 232
c              assume no warm-up time if chiller is already running             -044c4 233
c              in cooling mode this hour                                        -044c4 234
        Jpe        = <ch;Jpe>                                                   -044c4 235
        NumCoolOff = <pe;HOURS_OFF>                                             -044c4 236
        Jpe        = <ch;Jpe_HEAT>                                              -044c4 237
        IF (NumCoolOff .GT. 0)  EQstartH = StartUpLoad(Jpe)                     -044c4 238
      ENDIF                                                                     -044c4 239
c                                                                               -044c4 240
      IF (SimCtrl .EQ. 11)  THEN                                                Chlr1 2153
c              Routine called to get operating capacity                         Chlr1 2154
c              chiller capacity in heating mode (make positive)                 Chlr1 2155
        Jpe   = <ch;Jpe>                                                        Chlr1 2156
        Qcool = <pe;LOAD>                                                       Chlr1 2157
        Jpe   = <ch;Jpe_HEAT>                                                   Chlr1 2158
        IF (Qcool .EQ. 0.)  THEN                                                Chlr1 2159
c              heating only                                                     Chlr1 2160
          <pe;MAX_CAPACITY> = -<ch;HEAT_CAP> - EQstartH                         -044c4 241
        ELSE                                                                    Chlr1 2162
c              Simultaneous heating and cooling - note that the chiller         Chlr1 2163
c              has already been simulated in the cooling mode, so that          Chlr1 2164
c              the cooling part load ratio is known                             Chlr1 2165
          PLR     = <ch;PLR>                                                    Chlr1 2166
          HcapPLR = MAX(0., CVAL(<ch:HCAP-FPLRC>,PLR,PLR))                      Chlr1 2167
          <pe;MAX_CAPACITY> = -<ch;HEAT_CAP> * HcapPLR                          Chlr1 2168
c                                                                               Chlr1 2169
c ****         run function : Chiller_Gas_1-5                                   Chlr1 2170
c           IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                  Chlr1 2171
        ENDIF                                                                   Chlr1 2172
        RETURN                                                                  Chlr1 2173
      ENDIF                                                                     Chlr1 2174
c                                                                               Chlr1 2175
c              Routine called to simulate equipment                             Chlr1 2176
      EQloadH   = -<pe;LOAD>                                                    CHGAS1 430
      <pe;LOAD> = EQloadH                                                       CHGAS1 431
      IF (EQloadH .EQ. 0.)  <pe;MAX_CAPACITY> = <ch;HEAT_CAP>                   ERV     28
c                                                                               CHGAS1 432
c ****         run function : Chiller_Gas_1-6                                   CHGAS1 433
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        CHGAS1 434
c                                                                               CHGAS1 435
c              skip if no load                                                  CHGAS1 436
      IF (<pe;GPM> .EQ. 0)  GOTO 3000                                           BUGS    43
c                                                                               -044c4 242
c              Chiller hot water pump                                           -044c4 243
      IF (<ch:HW-PUMP> .ne. 0)  THEN                                            -047k   13
        Jpm     = <ch:HW-PUMP>                                                  -044c4 245
        PMPfrac = 1.0                  ! runs full hour                         -044c4 246
        CALL PumpSupply                                                         -044c4 247
c              sum into auxiliary pump Kw (equipment pumps only)                -044c4 248
        IF (<pm;TYPE> .EQ. EquipmentPump)                                       -044c4 249
     &                                AuxPumpKW = AuxPumpKW + PMPkW             -044c4 250
c              add pump heat to load                                            -044c4 251
        EQloadH = Min(0., EQloadH + PMPQ)                                       -044c4 252
      ENDIF                                                                     -044c4 253
c                                                                               -044c4 254
c              Part load ratio, including startup load                          -044c4 255
      Qnet = EQloadH + EQstartH                                                 -044c4 256
      PLRh  = Qnet / (-<pe;MAX_CAPACITY>)                                       -044c4 257
      IF (PLRh .gt. <ch:MIN-RATIO>)  THEN  ! equipment runs full hour           -044c4 258
        FracH  = 1.                                                             -044c4 259
      ELSE  ! fraction of hour operating                                        -044c4 260
        PLRh     = <ch:MIN-RATIO>                                               -044c4 261
        CapMin   = -<pe;MAX_CAPACITY>*<ch:MIN-RATIO>                            -044c4 262
        FracH    = Qnet / CapMin                                                -044c4 263
c              include standby losses                                           -044c4 264
        Qstandby = Max(<ch;HEAT_CAP>*<ch:STANDBY-TIME>, CapMin)                 -044c4 265
        Qstandby = Qstandby * (1.0 - FracH)                                     -044c4 266
        Qnet     = Qnet + Qstandby                                              -044c4 267
        FracH    = Qnet / CapMin                                                -044c4 268
      ENDIF                                                                     -044c4 269
c              fuel consumption for heating                                     CHGAS1 470
      EQfuelH = -Qnet / <ch:HW-XEFF>                                            -044c4 270
c              electrical consumption - count only if heating fraction          CHGAS1 472
c              greater than cooling fraction                                    CHGAS1 473
      EQelecH = <ch:CAP> * <ch:EIR> * MAX(0., FracH-<ch;FRAC>)                  CHGAS1 474
     &                              * KWBTU                                     CHGAS1 475
c                                                                               CHGAS1 479
c                                                                               CHGAS1 480
c ****         run function : Chiller_Gas_1-7                                   CHGAS1 481
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        CHGAS1 482
c                                                                               CHGAS1 483
c                                                                               CHGAS1 484
c              report variables                                                 CHGAS1 485
 3000 <ch;Q_RECVR> = <ch;Q_RECVR> + EQloadH                                     CHGAS1 486
      <ch;KWh>     = EQelecH                                                    CHGAS1 487
      <ch;FUELh>   = EQfuelH                                                    CHGAS1 488
c                                                                               CHGAS1 489
c              hourly-report variables - note that this is the                  CHGAS1 490
c              second call                                                      CHGAS1 491
      IF (<ch;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                                CHGAS1 492
     &  CALL HourRepPLT(EQUIPDAT(1), <ch;HREP>, 16, 1)                          CHGAS1 493
c                                                                               CHGAS1 494
      RETURN                                                                    CHGAS1 495
c                                                                               Chlr1 2177
 9101 FORMAT(                                                                   Chlr1 2178
     &14x,'Chiller Tcond convergence failure: ',8A4                    )        Chlr1 2179
      END                                                                       CHGAS1 496
      SUBROUTINE Chiller_HP_1(Mode)                                             CHHP1    2
c                                                                               CHHP1    3
c                                                                               CHHP1    4
c              Simulates air-to-water and water-to-water heat pumps             CHHP1    5
c                                                                               CHHP1    6
c              Mode = 1  Heating                                                CHHP1    7
c                     2  Cooling                                                CHHP1    8
c                                                                               CHHP1    9
c              This device provides either heating or cooling, and              CHHP1   10
c              appears to the outside world as both a chiller and boiler.       CHHP1   11
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /EQUIPD/ EQload, EQrun, EQhgb, OperCap, Frac,                     /EQUIPD/ 2
     &                 PLR, EQsupplyT, Tcond,                                   Chlr1    1
     &                 EIRPLR, EIRFT, EQEIR, EQelec, EQfanKW, EQaux,            /EQUIPD/ 4
     &                 HIRPLR, HIRFT, EQHIR, EQfuel, EQcond, EQrecvr,           /EQUIPD/ 5
     &                 HWflow, HWhead, CHWflow, CHWhead, CWflow, CWhead,        /EQUIPD/ 6
     &                 HTRECflow,HTREChead, Qenvir, EQstart, EQloadH,           -041d    1
     &                 EQstartH, PLRh, FracH, EQfuelH, EQelecH                  /EQUIPD/ 8
      REAL             EQUIPDAT(36)                                             /EQUIPD/10
      EQUIVALENCE      (EQUIPDAT(1), EQload), (Tambient, Tcond)                 FreeCl   1
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
c                                                                               CHHP1   26
      COMMON  /CHLRKY/ ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 2
     &                 WaterCool, AirCool                                       /CHLRKY/ 3
      INTEGER          ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 4
     &                 WaterCool, AirCool                                       /CHLRKY/ 5
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
c                                                                               Chlr1 2181
c              initialize hourly chiller data                                   Chlr1 2182
      CALL FILLN(0., EQUIPDAT(1), IVTLIM(2,16))                                 Chlr1 2183
      <ch;KW>      = 0.                  ! kW, cooling mode                     Chlr1 2184
      <ch;KWh>     = 0.                  ! kW, heating mode                     Chlr1 2185
      <ch;AUX>     = 0.                  ! kW, auxiliary                        Chlr1 2186
      <ch;Q_RECVR> = 0.                  ! heating output                       Chlr1 2187
      <ch;FRAC>    = 0.                  ! fraction cycled on                   Chlr1 2188
      <ch;Mode>    = OFFMODE                                                    Chlr1 2189
      EQsupplyT    = <pe;SUPPLY_T>       ! Required supply T                    Chlr1 2190
      JlpCHW       = Jlp                 ! CHW loop                             Chlr1 2191
c                                                                               Chlr1 2192
c ****         run function : Chiller_HeatPump_1-1                              Chlr1 2193
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        Chlr1 2194
c                                                                               Chlr1 2195
      IF (Mode .EQ. HEATMODE)  GOTO 2000                                        Chlr1 2196
c                                                                               Chlr1 2197
c============= COOLING MODE =================================================== Chlr1 2198
c                                                                               Chlr1 2199
      IF (SimCtrl .EQ. 11)  THEN                                                Chlr1 2200
c              Routine called to get operating capacity                         Chlr1 2201
c              Initialize entering condenser temperature                        Chlr1 2202
        SELECT CASE (<ch:COND-TYPE>)                                            Chlr1 2203
          CASE (1)  ! Water-cooled                                              Chlr1 2204
            Jlp      = <ch:CW-LOOP>                                             Chlr1 2205
            <ch;ECT> = <lp;COIL_EWTest>                                         Chlr1 2206
            Tcond    = <lp;COIL_EWTest>                                         Chlr1 2207
            Jlp      = JlpCHW                                                   Chlr1 2208
          CASE (2)  ! Air-cooled                                                Chlr1 2209
            <ch;ECT> = DBT                                                      Chlr1 2210
            Tcond    = DBT                                                      Chlr1 2211
        END SELECT  ! ch:COND-TYPE                                              Chlr1 2212
        <ch;Tcond> = MAX(Tcond, <ch;ECT>, <ch:MIN-COND-T>)                      Chlr1 2213
      ELSEIF (<pe;GPM> .EQ. 0.)  THEN  ! chiller is off                         -044c4 271
        GOTO 3000                                                               -044c4 272
      ENDIF                                                                     -044c4 273
c                                                                               -044c4 274
c              Start-up load                                                    -044c4 275
      IF (<ch;LastMode> .NE. HEATMODE)  THEN                                    -044c4 276
        EQstart = StartUpLoad(Jpe)                                              -044c4 277
      ELSE                                                                      -044c4 278
c              assume warm-up time is increased if chiller has                  -044c4 279
c              been running in heat mode                                        -044c4 280
        II = 3                                                                  -044c4 281
        EQstart = <pe;Q_STARTUP> * 2.                                           -044c4 282
      ENDIF                                                                     -044c4 283
c                                                                               Chlr1 2229
c ****         run function : Chiller_HeatPump_1-2                              Chlr1 2230
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        Chlr1 2231
c                                                                               Chlr1 2232
c              Start of iterative loop on condenser temperature                 Chlr1 2233
      Tcond     = <ch;Tcond>                                                    Chlr1 2234
      ErrorLast = 0                                                             -047j   45
      IterT     = 0                                                             Chlr1 2235
   20 IterT     = IterT + 1                                                     Chlr1 2236
      AuxPumpKW = 0.                   ! local pump kW                          Chlr1 2237
      Tlast     = Tcond                                                         Chlr1 2238
c              operating capacity                                               Chlr1 2239
      Cap_fT  = CVAL(<ch:CAP-FT>, EQsupplyT, Tcond)                             Chlr1 2240
      OperCap = <ch;NormalCap> * Cap_fT                                         Chlr1 2241
c                                                                               -044c4 284
      IF (SimCtrl .EQ. 11)  THEN       ! getting capacity                       -044c4 285
        EQload = OperCap - EQstart                                              -044c4 286
      ELSE                             ! normal call                            -044c4 287
        EQload = <pe;LOAD>                                                      -044c4 288
c              local chilled water pump                                         -044c4 289
        IF (<ch:CHW-PUMP> .ne. 0)  THEN                                         -047k   14
          Jpm     = <ch:CHW-PUMP>                                               -044c4 291
          PMPfrac = 1.0                ! runs full hour                         -044c4 292
          CALL PumpSupply                                                       -044c4 293
          EQload = EQload + PMPQ       ! add pump heat to load                  -044c4 294
c              sum into auxiliary pump Kw (equipment pumps only)                -044c4 295
          IF (<pm;TYPE> .EQ. EquipmentPump)                                     -044c4 296
     &                                AuxPumpKW = AuxPumpKW + PMPkW             -044c4 297
        ENDIF                                                                   -044c4 298
c              chiller is running                                               -044c4 299
        <ch;Mode> = COOLMODE                                                    -044c4 300
      ENDIF                                                                     -044c4 301
c                                                                               -044c4 302
c              Part load ratio, including startup load                          -044c4 303
      Qnet = EQload + EQstart                                                   -044c4 304
      PLR  = Qnet / OperCap                                                     -044c4 305
      IF (PLR .gt. <ch:MIN-RATIO>)  THEN  ! equipment runs full hour            -044c4 306
        Frac     = 1.                                                           -044c4 307
      ELSE  ! fraction of hour operating                                        -044c4 308
        PLR      = <ch:MIN-RATIO>                                               -044c4 309
        CapMin   = OperCap*<ch:MIN-RATIO>                                       -044c4 310
        Frac     = Qnet / CapMin                                                -044c4 311
c              include standby losses                                           -044c4 312
        Qstandby = Min(<ch:CAP>*<ch:STANDBY-TIME>, CapMin)                      -044c4 313
        Qstandby = Qstandby * (1.0 - Frac)                                      -044c4 314
        Qnet     = Qnet + Qstandby                                              -044c4 315
        Frac     = Qnet / CapMin                                                -044c4 316
      ENDIF                                                                     -044c4 317
c                                                                               -044c4 318
c              When running, the machine must operate at or above the           Chlr1 2292
c              greater of the min-ratio, or hot-gas-bypass ratio                Chlr1 2293
      HGBratio  = <ch:HGB-RATIO>                ! hot-gas bypass ratio          -044c4 319
      PLR   = MAX(PLR, <ch:MIN-RATIO>, HGBratio)                                Chlr1 2294
      EQrun = OperCap * PLR                     ! operating point               Chlr1 2295
      EQhgb = DIM(EQrun*FRAC,Qnet)              ! hot-gas bypass                Chlr1 2296
c                                                                               Chlr1 2297
c              Compressor power                                                 Chlr1 2298
      EIRFT  = CVAL(<ch:EIR-FT>, EQsupplyT, Tcond)                              Chlr1 2299
      dT     = Tcond - EQsupplyT                                                Chlr1 2300
      EIRPLR = CVAL(<ch:EIR-FPLR>, PLR, dT)                                     Chlr1 2301
      EQEIR  = <ch;NormalEIR> * EIRFT * EIRPLR                                  Chlr1 2302
      EQelec = OperCap * EQEIR * Frac * KWBTU                                   Chlr1 2303
c                                                                               Chlr1 2304
c              Rejected heat                                                    Chlr1 2305
      EQcond = EQload + EQelec*<ch:ELEC-TO-COND>*BTUKW                          -044c4 320
c                                                                               -044c4 321
c              Water-cooled condenser performance                               Chlr1 2307
      IF (<ch:COND-TYPE> .EQ. 1)  THEN                                          Chlr1 2308
        Jlp = <ch:CW-LOOP>                                                      Chlr1 2309
c              condenser flow & head - flow always constant                     Chlr1 2310
        CWflow = <ch;DES_CW_GPM>                                                Chlr1 2311
        CWhead = <ch:CW-HEAD>                                                   Chlr1 2312
c              Leaving condenser temperature                                    Chlr1 2313
        dT    = EQcond/(<lp;BTUH/GPM-F>*CWflow*Frac)                            Chlr1 2314
        Tcwr  = <ch;ECT> + dT                                                   Chlr1 2315
c              Effective entering condenser temperature, adjusted for           Chlr1 2316
c              off-rated flow                                                   Chlr1 2317
        Tcond = Tcwr - dT*MIN(1., CWflow/<ch;RatedCWgpm>)                       Chlr1 2318
        Tcond = MAX(<ch:MIN-COND-T>, Tcond)                                     Chlr1 2319
c              if chiller has an attached condenser pump                        Chlr1 2320
        IF (<ch:CW-PUMP> .GT. 0)  THEN                                          Chlr1 2321
          Jpm = <ch:CW-PUMP>                                                    Chlr1 2322
c              if the loop has its own pump, then this condenser pump           Chlr1 2323
c              is an equipment pump and can be simulated now.  If the           Chlr1 2324
c              loop does not have its own pump, then this pump powers           Chlr1 2325
c              the loop and must be simulated later when more is known          Chlr1 2326
c              about the total loop flow and head.                              Chlr1 2327
          IF (<pm;TYPE> .EQ. EquipmentPump)  THEN                               Chlr1 2328
c                 equipment pump                                                Chlr1 2329
            PMPgpm    = CWflow                                                  Chlr1 2330
            PMPset    = CWhead + <ch:CW-STATIC>                                 Chlr1 2331
            PMPfric   = CWhead                                                  Chlr1 2332
            PMPstatic = <ch:CW-STATIC>                                          Chlr1 2333
            PMPfrac   = 1.    ! runs continuously                               -047e   10
            CALL PUMP                                                           Chlr1 2335
            AuxPumpKW = AuxPumpKW + PMPkW                                       Chlr1 2336
c                 add condenser pump heat into condenser water                  Chlr1 2337
            EQcond    = EQcond + PMPQ                                           Chlr1 2338
          ELSEIF (SimCtrl .NE. 11)  THEN                                        -041g    6
c                 condenser pump powers the loop - save for later               Chlr1 2340
            <pm;GPM>        = CWflow                                            Chlr1 2341
            <pm;EQUIP_HEAD> = CWhead                                            Chlr1 2342
          ENDIF                                                                 Chlr1 2343
        ENDIF                                                                   Chlr1 2344
        Jlp = JlpCHW                                                            Chlr1 2345
      ENDIF  ! Water-cooled condenser, ch:COND-TYPE .eq. 1                      Chlr1 2346
c                                                                               Chlr1 2347
c              Check if Tcond converged                                         Chlr1 2348
      Error = Tcond - Tlast                                                     -047j   46
      IF (Abs(Error) .lt. 0.1) THEN             ! converged                     -047j   47
      ELSEIF (IterT .eq. 20) THEN               ! convergence failure           -047j   48
        Call MsgSim(-2,II,II,II,II)                                             -047j   49
        Write (iOutpt,9101)  (<ch:NAME>,II=1,8)                                 -047j   50
      ELSE                                       ! iterate again                -047j   51
        IF (ErrorLast/Error .lt. 0.)  Tcond = (Tcond+Tlast)*0.5                 -047j   52
        ErrorLast = Error                                                       -047j   53
        GoTo 20                                                                 -047j   54
      ENDIF                                                                     -047j   55
c                                                                               Chlr1 2359
c ****         run function : Chiller_HeatPump_1-3                              Chlr1 2360
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        Chlr1 2361
c                                                                               Chlr1 2362
      <pe;OPER_CAPACITY> = OperCap                                              Chlr1 2363
      IF (SimCtrl .EQ. 11)  THEN                                                Chlr1 2364
c              maximum output - adjust by any parasitic load such as            Chlr1 2365
c              a pump                                                           Chlr1 2366
        <pe;MAX_CAPACITY> = OperCap - <pe;Q_PARASITIC> - EQstart                Chlr1 2367
        <pe;MAX_CAPACITY> = MAX(0., <pe;MAX_CAPACITY>)                          Chlr1 2368
        RETURN                                                                  Chlr1 2369
      ENDIF                                                                     Chlr1 2370
c                                                                               Chlr1 2371
c              report variables                                                 Chlr1 2372
      <ch;KW>   = EQelec                                                        Chlr1 2373
      <ch;FRAC> = Frac                                                          Chlr1 2374
      <ch;Tcond> = Tcond                                                        -041h    5
c                                                                               Chlr1 2375
      GOTO 3000                                                                 Chlr1 2376
c                                                                               Chlr1 2377
c============= HEATING MODE =================================================== Chlr1 2378
 2000 CONTINUE                                                                  Chlr1 2379
c                                                                               Chlr1 2380
c              During heating the reversing valve switches the operation        Chlr1 2381
c              of the evaporator and condenser.  Variables in this              Chlr1 2382
c              section referencing the condenser (Tcond, etc.) actually         Chlr1 2383
c              reference the evaporator                                         Chlr1 2384
c                                                                               Chlr1 2385
      IF (SimCtrl .EQ. 11)  THEN                                                Chlr1 2386
c              Routine called to get operating capacity                         Chlr1 2387
c              Initialize entering condenser temperature                        Chlr1 2388
        SELECT CASE (<ch:COND-TYPE>)                                            Chlr1 2389
          CASE (1)  ! Water-cooled                                              Chlr1 2390
            Jlp      = <ch:CW-LOOP>                                             Chlr1 2391
            <ch;ECT> = <lp;COIL_EWTest>                                         Chlr1 2392
            Tcond    = <lp;COIL_EWTest>                                         Chlr1 2393
            Jlp      = JlpCHW                                                   Chlr1 2394
          CASE (2)  ! Air-cooled                                                Chlr1 2395
            <ch;ECT> = DBT                                                      Chlr1 2396
            Tcond    = DBT                                                      Chlr1 2397
        END SELECT  ! ch:COND-TYPE                                              Chlr1 2398
        <ch;Tcond> = Tcond                                                      Chlr1 2399
      ELSEIF (<pe;GPM> .EQ. 0.)  THEN  ! chiller is off                         -044c4 322
        GOTO 3000                                                               -044c4 323
      ELSE                                                                      -044c4 324
        <pe;LOAD> = -<pe;LOAD>                                                  -044c4 325
      ENDIF                                                                     -044c4 326
c                                                                               -044c4 327
c              Start-up load                                                    -044c4 328
      IF (<ch;LastMode> .NE. COOLMODE)  THEN                                    -044c4 329
        EQstartH = -StartUpLoad(Jpe)                                            -044c4 330
      ELSE                                                                      -044c4 331
c              assume warm-up time is increased if chiller has                  -044c4 332
c              been running in cool mode                                        -044c4 333
        II = 3                                                                  -044c4 334
        EQstartH = -<pe;Q_STARTUP> * 2.                                         -044c4 335
      ENDIF                                                                     -044c4 336
c                                                                               Chlr1 2416
c ****         run function : Chiller_HeatPump_1-4                              Chlr1 2417
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        Chlr1 2418
c                                                                               Chlr1 2419
c              Start of iterative loop on condenser temperature                 Chlr1 2420
      Tcond     = <ch;Tcond>                                                    Chlr1 2421
      IterT     = 0                                                             Chlr1 2422
 2020 IterT     = IterT + 1                                                     Chlr1 2423
      AuxPumpKW = 0.                   ! local pump kW                          Chlr1 2424
      Tlast     = Tcond                                                         Chlr1 2425
c              operating capacity                                               Chlr1 2426
      IF (<ch:COND-TYPE> .EQ. 1  .OR.  Tcond .GT. 39.)  THEN                    Chlr1 2427
        Cap_fT = CVAL(<ch:HEAT-CAP-FT>, EQsupplyT, Tcond)                       Chlr1 2428
      ELSE                                                                      Chlr1 2429
c                 air-cooled chiller encountering frost                         Chlr1 2430
        Cap_fT = CVAL(<ch:HEAT-CAP-FRST>, EQsupplyT, Tcond)                     Chlr1 2431
      ENDIF                                                                     Chlr1 2432
      OperCap = <ch;HEAT_CAP> * Cap_fT                                          Chlr1 2433
c                                                                               -044c4 337
      IF (SimCtrl .EQ. 11)  THEN       ! getting capacity                       -044c4 338
        EQloadH = OperCap - EQstartH                                            -044c4 339
      ELSE                             ! normal call                            -044c4 340
        EQloadH = <pe;LOAD>            ! equipment load                         -044c4 341
c              local chilled water pump                                         -044c4 342
        IF (<ch:CHW-PUMP> .ne. 0)  THEN                                         -047k   15
          Jpm     = <ch:CHW-PUMP>                                               -044c4 344
          PMPfrac = 1.0                ! runs full hour                         -044c4 345
          CALL PumpSupply                                                       -044c4 346
          EQloadH = Min(0., EQloadH + PMPQ)  ! add pump heat to load            -044c4 347
c              sum into auxiliary pump Kw (equipment pumps only)                -044c4 348
          IF (<pm;TYPE> .EQ. EquipmentPump)                                     -044c4 349
     &                                AuxPumpKW = AuxPumpKW + PMPkW             -044c4 350
        ENDIF                                                                   -044c4 351
c              chiller is running                                               -044c4 352
        <ch;Mode> = HEATMODE                                                    -044c4 353
      ENDIF                                                                     -044c4 354
c                                                                               -044c4 355
c              Part load ratio, including startup load                          -044c4 356
      Qnet = EQloadH + EQstartH                                                 -044c4 357
      PLRh = Qnet / OperCap                                                     -044c4 358
      IF (PLRh .gt. <ch:MIN-RATIO>)  THEN  ! equipment runs full hour           -044c4 359
        FracH    = 1.                                                           -044c4 360
      ELSE  ! fraction of hour operating                                        -044c4 361
        PLRh     = <ch:MIN-RATIO>                                               -044c4 362
        CapMin   = OperCap*<ch:MIN-RATIO>                                       -044c4 363
        FracH    = Qnet / CapMin                                                -044c4 364
c              include standby losses                                           -044c4 365
        Qstandby = Max(<ch;HEAT_CAP>*<ch:STANDBY-TIME>, CapMin)                 -044c4 366
        Qstandby = Qstandby * (1.0 - FracH)                                     -044c4 367
        Qnet     = Qnet + Qstandby                                              -044c4 368
        FracH    = Qnet / CapMin                                                -044c4 369
      ENDIF                                                                     -044c4 370
c              When running, the machine must operate at or above the           Chlr1 2484
c              greater of the min-ratio, or hot-gas-bypass ratio                Chlr1 2485
      HGBratio = <ch:HGB-RATIO>                     ! hot-gas bypass            -044c4 371
      PLRh  = MAX(PLRh, <ch:MIN-RATIO>, HGBratio)                               Chlr1 2486
      EQrun = OperCap * PLRh                    ! operating point               Chlr1 2487
      EQhgb = MIN(0., Qnet-EQrun*FracH)         ! hot-gas bypass load           Chlr1 2488
c                                                                               Chlr1 2489
c              Compressor power                                                 Chlr1 2490
      IF (<ch:COND-TYPE> .EQ. 1  .OR.  Tcond .GT. 39.)  THEN                    Chlr1 2491
        EIRFT = CVAL(<ch:HEAT-EIR-FT>, EQsupplyT, Tcond)                        Chlr1 2492
      ELSE                                                                      Chlr1 2493
c             air-cooled chiller encountering frost                             Chlr1 2494
        EIRFT = CVAL(<ch:HEAT-EIR-FRST>, EQsupplyT, Tcond)                      Chlr1 2495
      ENDIF                                                                     Chlr1 2496
      dT      = EQsupplyT - Tcond                                               Chlr1 2497
      EIRPLR  = CVAL(<ch:HEAT-EIR-FPLR>,PLRh,dT)                                Chlr1 2498
      EQEIR   = <ch:HEAT-EIR> * EIRFT * EIRPLR                                  Chlr1 2499
      EQelecH = -OperCap * EQEIR * FracH * KWBTU                                Chlr1 2500
c                                                                               Chlr1 2501
c              Absorbed heat (negative)                                         Chlr1 2502
      EQcond = EQloadH + EQelecH*<ch:ELEC-TO-COND>*BTUKW                        -044c4 372
c              Water-cooled condenser performance                               Chlr1 2504
      IF (<ch:COND-TYPE> .EQ. 1)  THEN                                          Chlr1 2505
        Jlp = <ch:CW-LOOP>                                                      Chlr1 2506
c              condenser flow & head - always constant flow                     Chlr1 2507
        CWflow = <ch;DesignCWgpmHt>                                             Chlr1 2508
        CWhead = <ch:CW-HEAD>                                                   Chlr1 2509
c              Leaving condenser temperature                                    Chlr1 2510
        dT     = EQcond/(<lp;BTUH/GPM-F>*CWflow*FracH)                          Chlr1 2511
        Tcwr   = <ch;ECT> + dT                                                  Chlr1 2512
c              Effective entering condenser temperature, adjusted for           Chlr1 2513
c              off-rated flow                                                   Chlr1 2514
        Tcond  = Tcwr - dT*MIN(1., CWflow/<ch;RatedCWgpmHt>)                    Chlr1 2515
c              if chiller has an attached condenser pump                        Chlr1 2516
        IF (<ch:CW-PUMP> .GT. 0)  THEN                                          Chlr1 2517
          Jpm = <ch:CW-PUMP>                                                    Chlr1 2518
c              if the loop has its own pump, then this condenser pump           Chlr1 2519
c              is an equipment pump and can be simulated now.  If the           Chlr1 2520
c              loop does not have its own pump, then this pump powers           Chlr1 2521
c              the loop and must be simulated later when more is known          Chlr1 2522
c              about the total loop flow and head.                              Chlr1 2523
          IF (<pm;TYPE> .EQ. EquipmentPump)  THEN                               Chlr1 2524
c                 equipment pump                                                Chlr1 2525
            PMPgpm    = CWflow                                                  Chlr1 2526
            PMPset    = CWhead + <ch:CW-STATIC>                                 Chlr1 2527
            PMPfric   = CWhead                                                  Chlr1 2528
            PMPstatic = <ch:CW-STATIC>                                          Chlr1 2529
            PMPfrac   = 1.    ! runs continuously                               -047e   11
            CALL PUMP                                                           Chlr1 2531
            AuxPumpKW = AuxPumpKW + PMPkW                                       Chlr1 2532
c                 add condenser pump heat into condenser water                  Chlr1 2533
            EQcond    = EQcond + PMPQ                                           Chlr1 2534
          ELSEIF (SimCtrl .NE. 11)  THEN                                        -041g    7
c                 condenser pump powers the loop - save for later               Chlr1 2536
            <pm;GPM>        = CWflow                                            Chlr1 2537
            <pm;EQUIP_HEAD> = CWhead                                            Chlr1 2538
          ENDIF                                                                 Chlr1 2539
        ENDIF                                                                   Chlr1 2540
        Jlp = JlpCHW                                                            Chlr1 2541
      ENDIF  ! Water-cooled condenser, ch:COND-TYPE .eq. 1                      Chlr1 2542
c                                                                               Chlr1 2543
c              Check if Tcond converged                                         Chlr1 2544
      IF (ABS(Tcond-Tlast) .LT. 0.1)  THEN                                      Chlr1 2545
c              converged                                                        Chlr1 2546
      ELSEIF (IterT .EQ. 20)  THEN                                              Chlr1 2547
c              convergence failure                                              Chlr1 2548
        CALL MSGSIM(-2,II,II,II,II)                                             Chlr1 2549
        WRITE (IOUTPT,9101)  (<ch:NAME>,II=1,8)                                 Chlr1 2550
      ELSE                                                                      Chlr1 2551
c              iterate again                                                    Chlr1 2552
        GOTO 2020                                                               Chlr1 2553
      ENDIF                                                                     Chlr1 2554
c                                                                               Chlr1 2555
c ****         run function : Chiller_HeatPump_1-3                              Chlr1 2556
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        Chlr1 2557
c                                                                               Chlr1 2558
      <pe;OPER_CAPACITY> = OperCap                                              Chlr1 2559
      IF (SimCtrl .EQ. 11)  THEN                                                Chlr1 2560
c              maximum output - adjust by any parasitic load such as            Chlr1 2561
c              a pump                                                           Chlr1 2562
        <pe;MAX_CAPACITY> = OperCap - <pe;Q_PARASITIC> - EQstartH               -044c4 373
        <pe;MAX_CAPACITY> = -MIN(0., <pe;MAX_CAPACITY>)                         Chlr1 2564
        RETURN                                                                  Chlr1 2565
      ENDIF                                                                     Chlr1 2566
c                                                                               Chlr1 2567
c              report variables                                                 Chlr1 2568
      <ch;KWh>     = EQelecH                                                    Chlr1 2569
      <ch;Q_RECVR> = EQloadH                                                    Chlr1 2570
      <ch;FRAC>    = FracH                                                      Chlr1 2571
c                                                                               CHHP1  417
c              Re-entry point for cooling mode or no load                       CHHP1  418
 3000 CONTINUE                                                                  CHHP1  419
                                                                                CHHP1  420
c              Auxiliary power                                                  CHHP1  421
      IF (<ch:AUX-KW> .GT. 0.)  THEN                                            CHHP1  422
c              if always on                                                     CHHP1  423
        IF (<ch:AUX-MODE> .EQ. Always)  THEN                                    CHHP1  424
          EQaux = <ch:AUX-KW>                                                   CHHP1  425
        ELSEIF (<ch:AUX-MODE> .EQ. WhenOn)  THEN                                CHHP1  426
          EQaux = <ch:AUX-KW> * <ch;FRAC>                                       CHHP1  427
        ELSEIF (<ch:AUX-MODE> .EQ. WhenOff)  THEN                               CHHP1  428
          EQaux = <ch:AUX-KW> * (1.0 - <ch;FRAC>)                               CHHP1  429
        ELSE                                                                    CHHP1  430
          EQaux = <ch:AUX-KW> * SchVal(<ch:AUX-SCH>, 1.)                        CHHP1  431
        ENDIF                                                                   CHHP1  432
      ENDIF                                                                     CHHP1  433
c                                                                               CHHP1  434
      <ch;CWload>  = EQcond                                                     CHHP1  435
      <ch;CWflow>  = CWflow  ! no adjustment for cycling                        -047e   12
      <ch;CWhead>  = CWhead                                                     CHHP1  437
      <ch;AUX>     = EQaux                                                      CHHP1  438
c                                                                               CHHP1  439
      IF (<ch;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                                CHHP1  440
     &  CALL HourRepPLT(EQUIPDAT(1), <ch;HREP>, 16, 0)                          CHHP1  441
c                                                                               CHHP1  442
      RETURN                                                                    CHHP1  443
c                                                                               Chlr1 2573
 9101 FORMAT(                                                                   Chlr1 2574
     &14x,'Chiller Tcond convergence failure: ',8A4                    )        Chlr1 2575
      END                                                                       CHHP1  444
      SUBROUTINE Chiller_LoopHP_1(Mode)                                         CHLpHP   2
c                                                                               CHLpHP   3
c              Simulates a loop-to-loop heat-pump, with the thermal             CHLpHP   4
c              balance provided by lake/well water                              CHLpHP   5
c                                                                               CHLpHP   6
c              Mode = 1  Heating                                                CHLpHP   7
c                     2  Cooling                                                CHLpHP   8
c                                                                               CHLpHP   9
c              This chiller requires both CHW and HW equipment pumps,           CHLpHP  10
c              and requires that the attached CHW and HW loops have             CHLpHP  11
c              their own circulation pumps.                                     CHLpHP  12
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /EQUIPD/ EQload, EQrun, EQhgb, OperCap, Frac,                     /EQUIPD/ 2
     &                 PLR, EQsupplyT, Tcond,                                   Chlr1    1
     &                 EIRPLR, EIRFT, EQEIR, EQelec, EQfanKW, EQaux,            /EQUIPD/ 4
     &                 HIRPLR, HIRFT, EQHIR, EQfuel, EQcond, EQrecvr,           /EQUIPD/ 5
     &                 HWflow, HWhead, CHWflow, CHWhead, CWflow, CWhead,        /EQUIPD/ 6
     &                 HTRECflow,HTREChead, Qenvir, EQstart, EQloadH,           -041d    1
     &                 EQstartH, PLRh, FracH, EQfuelH, EQelecH                  /EQUIPD/ 8
      REAL             EQUIPDAT(36)                                             /EQUIPD/10
      EQUIVALENCE      (EQUIPDAT(1), EQload), (Tambient, Tcond)                 FreeCl   1
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
c                                                                               CHLpHP  27
      COMMON  /CHLRKY/ ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 2
     &                 WaterCool, AirCool                                       /CHLRKY/ 3
      INTEGER          ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 4
     &                 WaterCool, AirCool                                       /CHLRKY/ 5
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
c                                                                               CHLpHP  32
      LOGICAL Warmup                                                            CHLpHP  33
c                                                                               CHLpHP  34
c              Save original pointers to loop and Jpe block                     CHLpHP  35
      JlpSave  = Jlp                                                            CHLpHP  36
      JpeSave  = Jpe                                                            CHLpHP  37
c              zero hourly chiller data                                         CHLpHP  38
      CALL FILLN(0., EQUIPDAT(1), IVTLIM(2,16))                                 CHLpHP  39
c              required supply temperature, heating or cooling                  CHLpHP  40
      EQsupplyT = <pe;SUPPLY_T>                                                 CHLpHP  41
c              Flag to indicate warmup required                                 CHLpHP  42
      Warmup = .TRUE.                                                           CHLpHP  43
c              existing cooling and heating loads                               CHLpHP  44
      Jpe       = <ch;Jpe>                                                      CHLpHP  45
      EQload    = <pe;LOAD>                                                     CHLpHP  46
      IF (<pe;HOURS_OFF> .EQ. 0)  WarmUp = .FALSE.                              CHLpHP  47
      Jpe       = <ch;Jpe_HEAT>                                                 CHLpHP  48
      EQloadH   = -ABS(<pe;LOAD>)                                               CHLpHP  49
      <pe;LOAD> = EQloadH                                                       CHLpHP  50
      IF (<pe;HOURS_OFF> .EQ. 0)  WarmUp = .FALSE.                              CHLpHP  51
c                                                                               CHLpHP  52
c ****         run function : Chiller_LoopHP_1-1                                CHLpHP  53
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        CHLpHP  54
c                                                                               CHLpHP  55
c============= ROUTINE CALLED TO GET OPERATING CAPACITY ======================= CHLpHP  56
      IF (SimCtrl .EQ. 11)  THEN                                                CHLpHP  57
c                                                                               CHLpHP  58
c              Calculate operating capacities.                                  CHLpHP  59
c                                                                               CHLpHP  60
        IF ((Mode .EQ. COOLMODE  .AND.  EQloadH .NE. 0.)  .OR.                  CHLpHP  61
     &      (Mode .EQ. HEATMODE  .AND.  EQload  .NE. 0.))  THEN                 CHLpHP  62
c              Simultaneous heating and cooling                                 CHLpHP  63
c              hot-water loop                                                   Chlr1 2576
          Jlp   = <ch:HW-LOOP>                                                  Chlr1 2577
          Thws  = <lp;SUPPLY_T>                                                 Chlr1 2578
          Thwr  = <lp;RETURN_T>                                                 Chlr1 2579
          dThw  = MAX(2., <lp;SUPPLY_T> - <lp;RETURN_T>  )                      Chlr1 2580
c              chilled-water loop                                               Chlr1 2581
          Jlp   = <ch:CHW-LOOP>                                                 Chlr1 2582
          Tchws = <lp;SUPPLY_T>                                                 Chlr1 2583
c              iterate to solve for balance                                     Chlr1 2584
          Tcond   = Thwr                                                        Chlr1 2585
          CapLast = 0.                                                          Chlr1 2586
          DO  Iter=1,30                                                         Chlr1 2587
            Cap_fT  = CVAL(<ch:CAP-FT>, Tchws, Tcond)                           Chlr1 2588
            EIR_fT  = CVAL(<ch:EIR-FT>, Tchws, Tcond)                           Chlr1 2589
            OperCap = <ch:CAP> * Cap_fT                                         Chlr1 2590
            IF (Iter .GT. 15)  THEN                                             Chlr1 2591
              OperCap = (OperCap+CapLast)/2.                                    Chlr1 2592
            ENDIF                                                               Chlr1 2593
            IF (ABS(1.-CapLast/OperCap) .LT. 0.01)  EXIT                        Chlr1 2594
            CapLast = OperCap                                                   Chlr1 2595
c                 condenser load and flow                                       Chlr1 2596
            EQcond  = OperCap * (1.+<ch:EIR>*EIR_fT*<ch:ELEC-TO-COND>)          Chlr1 2597
            GPMhw   = EQcond / (<lp;BTUH/GPM-F> * dThw)                         Chlr1 2598
            GPMhw   = MIN(<ch;RatedCWgpm>, GPMhw)                               Chlr1 2599
c                 Tcond, adjusted for off-rated flow                            Chlr1 2600
            Tcond = Thws - dThw*MIN(1., GPMhw/<ch;RatedCWgpm>)                  Chlr1 2601
            Tcond = MAX(<ch:MIN-COND-T>, Tcond)                                 Chlr1 2602
          ENDDO                                                                 Chlr1 2603
c              cooling operating capacity                                       Chlr1 2604
          Jpe = <ch;Jpe>                                                        Chlr1 2605
          <pe;OPER_CAPACITY> = OperCap                                          Chlr1 2606
c              heating operating capacity                                       Chlr1 2607
          Jpe = <ch;Jpe_HEAT>                                                   Chlr1 2608
          <pe;OPER_CAPACITY> = EQcond                                           Chlr1 2609
        ELSEIF (Mode .EQ. COOLMODE)  THEN                                       CHLpHP  78
c              Cooling only                                                     CHLpHP  79
          Jlp   = <ch:CHW-LOOP>                                                 CHLpHP  80
          Tchws = <lp;SUPPLY_T>                                                 CHLpHP  82
c              well and entering condenser temperature                          CHLpHP  83
          Jlp   = <ch:CW-LOOP>                                                  CHLpHP  84
          Twell = <lp;COIL_EWTest>                                              CHLpHP  85
          Tcond   = <ch:COND-HX-SETPT>                                          Chlr1 2610
c              iterate to solve for balance between chiller and HX              Chlr1 2611
          CapLast = 0.                                                          Chlr1 2612
          DO  Iter=1,30                                                         Chlr1 2613
            Cap_fT  = CVAL(<ch:CAP-FT>, Tchws, Tcond)                           Chlr1 2614
            EIR_fT  = CVAL(<ch:EIR-FT>, Tchws, Tcond)                           Chlr1 2615
            OperCap = <ch:CAP> * Cap_fT                                         Chlr1 2616
            IF (Iter .GT. 15)  THEN                                             Chlr1 2617
              OperCap = (OperCap+CapLast)/2.                                    Chlr1 2618
            ENDIF                                                               Chlr1 2619
            IF (ABS(1.-CapLast/OperCap) .LT. 0.01)  EXIT                        Chlr1 2620
            CapLast = OperCap                                                   Chlr1 2621
            EQcond  = OperCap * (1.+<ch:EIR>*EIR_fT*<ch:ELEC-TO-COND>)          Chlr1 2622
c              see what condenser temperature the HX can produce                Chlr1 2623
            CALL HeatExchanger(<ch;CondHX>, 4, MaxFlag, EQcond,                 Chlr1 2624
     &                         <ch;DES_CW_GPM>, Twell, xSupTo,                  Chlr1 2625
     &                         <ch;DES_HW_GPM>,  Thws,   Thwr)                  Chlr1 2626
c              HX may throttle to maintain setpoint                             Chlr1 2627
            dThw = Thws - Thwr                                                  Chlr1 2628
            Thwr = MAX(<ch:COND-HX-SETPT>, Thwr)                                Chlr1 2629
            Thws = Thwr + dThw                                                  Chlr1 2630
c              Tcond, adjusted for off-rated flow                               Chlr1 2631
            Tcond = Thws - dThw*MIN(1., <ch;DES_HW_GPM>/<ch;RatedCWgpm>)        Chlr1 2632
          ENDDO                                                                 Chlr1 2633
c              cooling capacity                                                 Chlr1 2634
          Jpe   = <ch;Jpe>                                                      Chlr1 2635
          <pe;OPER_CAPACITY> = OperCap                                          CHLpHP 107
        ELSE                                                                    CHLpHP 108
c              Heating only                                                     CHLpHP 109
c              well and chilled supply temperature                              CHLpHP 112
          Jlp   = <ch:CW-LOOP>                                                  CHLpHP 113
          Twell = <lp;COIL_EWTest>                                              CHLpHP 114
          Tchws = <ch:EVAP-HX-SETPT> - <ch:CHW-DT>                              CHLpHP 115
c              required temperature rise thru condenser                         Chlr1 2636
          Jlp   = <ch:HW-LOOP>                                                  Chlr1 2637
          dThw  = <lp;SUPPLY_T> - <lp;RETURN_T>                                 Chlr1 2638
          Tcond = <lp;RETURN_T>                                                 Chlr1 2639
c              iterate to solve for balance between chiller and HX              Chlr1 2640
          CapLast = 0.                                                          Chlr1 2641
          DO  Iter=1,30                                                         Chlr1 2642
            Cap_fT  = CVAL(<ch:CAP-FT>, Tchws, Tcond)                           Chlr1 2643
            EIR_fT  = CVAL(<ch:EIR-FT>, Tchws, Tcond)                           Chlr1 2644
            OperCap = <ch:CAP> * Cap_fT                                         Chlr1 2645
            IF (Iter .GT. 15)  THEN                                             Chlr1 2646
              OperCap = (OperCap+CapLast)/2.                                    Chlr1 2647
            ENDIF                                                               Chlr1 2648
            IF (ABS(1.-CapLast/OperCap) .LT. 0.01)  EXIT                        Chlr1 2649
            CapLast = OperCap                                                   Chlr1 2650
c                 heat rejected and maximum condenser flow                      Chlr1 2651
            EQcond = OperCap * (1.+<ch:EIR>*EIR_fT*<ch:ELEC-TO-COND>)           Chlr1 2652
            GPMhw  = EQcond / (<lp;BTUH/GPM-F> * dThw)                          Chlr1 2653
            GPMhw  = MIN(<ch;RatedCWgpm>, GPMhw)                                Chlr1 2654
c                 Tcond, adjusted for off-rated flow                            Chlr1 2655
            Tcond  = <lp;SUPPLY_T> - dThw*MIN(1., GPMhw/<ch;RatedCWgpm>)        Chlr1 2656
            Tcond  = MAX(<ch:MIN-COND-T>, Tcond)                                Chlr1 2657
c                 see what evaporator temperature the HX can produce            Chlr1 2658
            CALL HeatExchanger(<ch;EvapHX>, 4, MaxFlag, -OperCap,               Chlr1 2659
     &                         <ch;DES_CW_GPM>, Twell, xSupTo,                  Chlr1 2660
     &                        <ch;DES_CHW_GPM>, Tchws,  Tchwr)                  Chlr1 2661
c                 HX may throttle to maintain setpoint                          Chlr1 2662
            dTchw = Tchws - Tchwr                                               Chlr1 2663
            Tchwr = MIN(<ch:EVAP-HX-SETPT>, Tchwr)                              Chlr1 2664
            Tchws = Tchwr + dTchw                                               Chlr1 2665
          ENDDO                                                                 Chlr1 2666
c              heating capacity                                                 Chlr1 2667
          Jpe = <ch;Jpe_HEAT>                                                   Chlr1 2668
          <pe;OPER_CAPACITY> = EQcond                                           Chlr1 2669
        ENDIF  ! EQload, EQloadH                                                CHLpHP 137
c                                                                               CHLpHP 138
c              Maximum output, adjusted for parasitic loads such as             CHLpHP 139
c              a pump                                                           CHLpHP 140
        IF (Mode .EQ. COOLMODE)  THEN                                           CHLpHP 141
          Jpe = <ch;Jpe>                                                        CHLpHP 142
          <pe;MAX_CAPACITY> = <pe;OPER_CAPACITY> - <pe;Q_PARASITIC>             Chlr1 2670
c              adjust for warm-up time                                          CHLpHP 145
          IF (WarmUp)  <pe;MAX_CAPACITY> = MAX(0., <pe;MAX_CAPACITY>            CHLpHP 146
     &                                   - StartUpLoad(Jpe))                    -044c4 374
        ELSE                                                                    CHLpHP 148
          Jpe = <ch;Jpe_HEAT>                                                   CHLpHP 149
          <pe;MAX_CAPACITY> = <pe;OPER_CAPACITY> + <pe;Q_PARASITIC>             Chlr1 2671
c              adjust for warm-up time                                          CHLpHP 152
          IF (WarmUp)  <pe;MAX_CAPACITY> = MAX(0., <pe;MAX_CAPACITY>            CHLpHP 153
     &                                   - StartUpLoad(Jpe)/3.)                 -044c4 375
        ENDIF                                                                   CHLpHP 155
c                                                                               CHLpHP 156
c ****         run function : Chiller_LoopHP_1-2                                CHLpHP 157
c       IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                      CHLpHP 158
c                                                                               CHLpHP 159
        Jlp = JlpSave                                                           CHLpHP 160
        Jpe = JpeSave                                                           CHLpHP 161
        RETURN                                                                  CHLpHP 162
      ENDIF                                                                     CHLpHP 163
c                                                                               CHLpHP 164
c============= ROUTINE CALLED TO SIMULATE EQUIPMENT =========================== CHLpHP 165
c                                                                               CHLpHP 166
c              Chilled water pump; if on runs full hour                         CHLpHP 167
      Jpe = <ch;Jpe>                                                            CHLpHP 168
      IF (<pe;GPM> .GT. 0.  .OR.  EQloadH .NE. 0.)  THEN                        CHLpHP 169
        IF (Jlp .EQ. <ch:CHW-LOOP>)  THEN                                       CHLpHP 170
          Jpm        = <ch:CHW-PUMP>                                            CHLpHP 171
          PMPfrac    = 1.0                                                      CHLpHP 172
          CALL PumpSupply                                                       CHLpHP 173
          <ch;Qchwp> = PMPQ                                                     CHLpHP 174
        ENDIF                                                                   CHLpHP 175
c              adjust load for warm-up time                                     CHLpHP 176
        IF (WarmUp  .AND.  EQload .NE. 0.)                                      CHLpHP 177
     &    EQstart = StartUpLoad(Jpe)                                            -044c4 376
        EQload = EQload + EQstart                                               CHLpHP 179
      ELSE                                                                      CHLpHP 180
        <ch;Qchwp> = 0.                                                         CHLpHP 181
      ENDIF                                                                     CHLpHP 182
c              hot water pump; if on runs full hour                             CHLpHP 183
      Jpe = <ch;Jpe_HEAT>                                                       CHLpHP 184
      IF (<pe;GPM> .GT. 0.  .OR.  EQload .NE. 0.)  THEN                         CHLpHP 185
        IF (Jlp .EQ. <ch:HW-LOOP>)  THEN                                        CHLpHP 186
          Jpm       = <ch:HW-PUMP>                                              CHLpHP 187
          PMPfrac   = 1.0                                                       CHLpHP 188
          CALL PumpSupply                                                       CHLpHP 189
          <ch;Qhwp> = PMPQ                                                      CHLpHP 190
        ENDIF                                                                   CHLpHP 191
c              adjust load for warm-up time                                     CHLpHP 192
        IF (WarmUp  .AND.  EQloadH .NE. 0.)                                     CHLpHP 193
     &    EQstartH = StartUpLoad(Jpe)                                           -044c4 377
        EQloadH = EQloadH + EQstartH                                            CHLpHP 195
      ELSE                                                                      CHLpHP 196
        <ch;Qhwp> = 0.                                                          CHLpHP 197
      ENDIF                                                                     CHLpHP 198
c                                                                               CHLpHP 199
c              Well water temperature                                           CHLpHP 200
      Jlp   = <ch:CW-LOOP>                                                      CHLpHP 201
      Twell = <lp;COIL_EWTest>                                                  CHLpHP 202
c              initialize evaporator and heating load                           CHLpHP 203
      Qevap = EQload + <ch;Qchwp>                                               CHLpHP 204
      Qcond = MIN(0., EQloadH+<ch;Qhwp>)                                        CHLpHP 205
c              initialize heat-exchanger setpoints                              Chlr1 2672
      TsetEvapHX = <ch:EVAP-HX-SETPT>                                           Chlr1 2673
      TsetCondHX = <ch:COND-HX-SETPT>                                           Chlr1 2674
c                                                                               CHLpHP 206
c              Performance varies depending on loading                          CHLpHP 207
c              Initialize mode                                                  Chlr1 2675
      IF (EQload .NE. 0.  .AND.  EQloadH .NE. 0.)  THEN                         Chlr1 2676
        ModeOper = 0                       ! simultaneous heat/cool             Chlr1 2677
      ELSEIF (EQload .NE. 0.)  THEN                                             Chlr1 2678
        ModeOper = COOLMODE                ! cooling only                       Chlr1 2679
      ELSEIF (EQloadH .NE. 0.)  THEN                                            Chlr1 2680
        ModeOper = HEATMODE                ! heating only                       Chlr1 2681
      ELSE                                                                      Chlr1 2682
        GOTO 1000                          ! not running                        Chlr1 2683
      ENDIF                                                                     Chlr1 2684
c                                                                               Chlr1 2685
   10 SELECT CASE (ModeOper)                                                    Chlr1 2686
        CASE (0)  ! Simultaneous heating/cooling                                Chlr1 2687
          Jlp   = <ch:HW-LOOP>                                                  Chlr1 2688
          Jpe   = <ch;Jpe_HEAT>                                                 Chlr1 2689
c              Bypass condenser flow                                            Chlr1 2690
          GPMbp = MAX(0., <ch;DES_HW_GPM>-<pe;GPM>)                             Chlr1 2691
c              mixed temperature entering condenser                             Chlr1 2692
          Tmix = (<lp;RETURN_T>*<pe;GPM>                                        Chlr1 2693
     &                 + <pe;SUPPLY_T>*GPMbp) / (<pe;GPM>+GPMbp)                Chlr1 2694
c              adjust for off-rated flow                                        Chlr1 2695
          dThw  = <pe;SUPPLY_T> - Tmix                                          Chlr1 2696
          Tcond = <pe;SUPPLY_T>                                                 Chlr1 2697
     &              - dThw*MIN(1., (<pe;GPM>+GPMbp)/<ch;RatedCWgpm>)            Chlr1 2698
          Tcond = MAX(<ch:MIN-COND-T>, Tcond)                                   Chlr1 2699
c              Determine cooling performance                                    Chlr1 2700
          Jlp   = <ch:CHW-LOOP>                                                 Chlr1 2701
          Tchws = <lp;SUPPLY_T>                       ! chw supply T            Chlr1 2702
          Cap_fT  = CVAL(<ch:CAP-FT>, Tchws, Tcond)   ! capacity as f(T)        Chlr1 2703
          EIR_fT  = CVAL(<ch:EIR-FT>, Tchws, Tcond)   ! EIR as f(T)             Chlr1 2704
          OperCap = <ch:CAP> * Cap_fT                 ! operating cap           Chlr1 2705
c              iterate to solve for heat balance                                Chlr1 2706
          ModeOper = COOLMODE                                                   Chlr1 2707
          DO  Iter=1,30                                                         Chlr1 2708
            PLR      = Qevap / OperCap                ! part load ratio         Chlr1 2709
            IF (<ch:MIN-RATIO> .EQ. 0.)  THEN                                   Bug40   76
              Frac = 1.                                                         Bug40   77
            ELSE                                                                Bug40   78
              Frac = MIN(1.0, PLR/<ch:MIN-RATIO>)                               Bug40   79
            ENDIF                                                               Bug40   80
            HGBratio = <ch:HGB-RATIO>                 ! hot gas bypass ratio    Chlr1 2711
c              when running, the machine must operate at or above the           Chlr1 2712
c              greater of the min-ratio, or hot-gas-bypass ratio                Chlr1 2713
            PLR      = MAX(PLR, <ch:MIN-RATIO>, HGBratio)                       Chlr1 2714
            EQrun    = OperCap * PLR                  ! operating point         Chlr1 2715
            EQhgb    = DIM(EQrun*FRAC, Qevap)         ! hot gas bypass          Chlr1 2716
            dT       = Tcond - Tchws                                            Chlr1 2717
            EIR_fPLR = CVAL(<ch:EIR-FPLR>, PLR, dT)   ! EIR as f(PLR)           Chlr1 2718
            EQEIR    = <ch:EIR> * EIR_fT * EIR_fPLR   ! adjusted EIR            Chlr1 2719
            EQelec   = OperCap * EQEIR * Frac * KWBTU ! compressor kW           Chlr1 2720
            EQcond   = Qevap                          ! heat rejection          Chlr1 2721
     &               + EQelec*<ch:ELEC-TO-COND>*BTUKW                           Chlr1 2722
c              Now look at cool/heat balance                                    Chlr1 2723
            IF (EQcond .GE. -Qcond  .AND.  ModeOper .EQ. COOLMODE)  THEN        Chlr1 2724
c              cooling dominated                                                Chlr1 2725
              EXIT                                                              Chlr1 2726
            ELSE                                                                Chlr1 2727
c              heating dominated - step up load on machine                      Chlr1 2728
              ModeOper = HEATMODE                                               Chlr1 2729
              IF (ABS(1.+EQcond/Qcond) .LT. 0.005)  EXIT                        Chlr1 2730
              IF (Iter .LT. 15)  THEN                                           Chlr1 2731
                Qevap = -Qcond/EQcond * Qevap                                   Chlr1 2732
              ELSE                                                              Chlr1 2733
                Qevap = (1.-Qcond/EQcond) * Qevap * 0.5                         Chlr1 2734
              ENDIF                                                             Chlr1 2735
            ENDIF                                                               Chlr1 2736
          ENDDO                                                                 Chlr1 2737
          EQcond = EQcond + <ch;Qhwp>                                           Chlr1 2738
c               check to see if hx capacity sufficient                          Chlr1 2739
          SELECT CASE (ModeOper)                                                Chlr1 2740
            CASE (1)  ! Heating dominated                                       Chlr1 2741
c                 required temperature entering evaporator                      Chlr1 2742
              Jlp   = <ch:CHW-LOOP>                                             Chlr1 2743
              Jpe   = <ch;Jpe>                                                  Chlr1 2744
              Tchwr = Tchws + Qevap/(<lp;BTUH/GPM-F> * <pe;GPM>)                Chlr1 2745
c                 bypass evaporator flow and mixed temperature                  Chlr1 2746
              GPMbp = MAX(0., <ch;DES_CHW_GPM>-<pe;GPM>)                        Chlr1 2747
              Tmix  = (<lp;RETURN_T>*<pe;GPM> + Tchws*GPMbp)                    Chlr1 2748
     &                                               / (<pe;GPM>+GPMbp)         Chlr1 2749
c                 required well temperature                                     Chlr1 2750
              CALL HeatExchanger(<ch;EvapHX>, 5, MaxFlag, -Qevap/Frac,          Chlr1 2751
     &                       <ch;DES_CW_GPM>, Treqd, xSupTo,                    Chlr1 2752
     &                      <ch;DES_CHW_GPM>,  Tmix, Tchwr)                     Chlr1 2753
              IF (Treqd .GT. Twell)  THEN                                       Chlr1 2754
c                 well-water temperature too cold to maintain                   Chlr1 2755
c                 chilled-water supply setpoint - treat as heating only         Chlr1 2756
                TsetEvapHX = Tchwr                                              Chlr1 2757
                GO TO 10                                                        Chlr1 2758
              ENDIF                                                             Chlr1 2759
            CASE (2)  ! Cooling dominated                                       Chlr1 2760
c                 see what heat exchanger can do                                Chlr1 2761
              CALL HeatExchanger(<ch;CondHX>, 4, MaxFlag, EQcond/Frac,          Chlr1 2762
     &                           <ch;DES_CW_GPM>,  Twell,  xSupTo,              Chlr1 2763
     &                           <ch;DES_HW_GPM>, xDemTi,  ThwMin)              Chlr1 2764
              Jpe = <ch;Jpe_HEAT>                                               Chlr1 2765
              IF (ThwMin .GT. <pe;SUPPLY_T>)  THEN                              Chlr1 2766
c                 well-water temperature too hot to maintain                    Chlr1 2767
c                 hot-water supply setpoint - treat as cooling only             Chlr1 2768
                TsetCondHX = <pe;SUPPLY_T>                                      Chlr1 2769
                GO TO 10                                                        Chlr1 2770
              ENDIF                                                             Chlr1 2771
          END SELECT                                                            Chlr1 2772
c                                                                               Chlr1 2773
        CASE (1)  ! Heating only                                                Chlr1 2774
c              initialize chilled supply temperature and cooling load           Chlr1 2775
          Jlp   = <ch:CHW-LOOP>                                                 Chlr1 2776
          Qevap = -Qcond / (1.+<ch:EIR>*<ch:ELEC-TO-COND>)                      Chlr1 2777
c              Bypass condenser flow                                            Chlr1 2778
          Jlp   = <ch:HW-LOOP>                                                  Chlr1 2779
          Jpe   = <ch;Jpe_HEAT>                                                 Chlr1 2780
          GPMbp = MAX(0., <ch;DES_HW_GPM>-<pe;GPM>)                             Chlr1 2781
c              mixed temperature entering condenser                             Chlr1 2782
          Tcond = (<lp;RETURN_T>*<pe;GPM>                                       Chlr1 2783
     &                         + <lp;SUPPLY_T>*GPMbp) / (<pe;GPM>+GPMbp)        Chlr1 2784
c              adjust for off-rated flow                                        Chlr1 2785
          dThw  = <lp;SUPPLY_T> - Tcond                                         Chlr1 2786
          Tcond = <lp;SUPPLY_T>                                                 Chlr1 2787
     &              - dThw*MIN(1., (<pe;GPM>+GPMbp)/<ch;RatedCWgpm>)            Chlr1 2788
          Tcond = MAX(<ch:MIN-COND-T>, Tcond)                                   Chlr1 2789
c                                                                               Chlr1 2790
          IF (Qevap .GT. 1.)  THEN                                              Chlr1 2791
c              iterate to solve chiller and evap HX heat balance                Chlr1 2792
            Tchwr   = <ch:EVAP-HX-SETPT>                                        Chlr1 2793
            CapLast = 0.                                                        Chlr1 2794
            DO  Iter=1,30                                                       Chlr1 2795
              Tchws   = Tchwr - Qevap/(<lp;BTUH/GPM-F>*<ch;DES_CHW_GPM>)        Chlr1 2796
              Cap_fT  = CVAL(<ch:CAP-FT>, Tchws, Tcond)                         Chlr1 2797
              OperCap = <ch:CAP> * Cap_fT                ! hourly cap           Chlr1 2798
              PLR     = Qevap / OperCap                  ! load ratio           Chlr1 2799
              IF (<ch:MIN-RATIO> .EQ. 0.)  THEN                                 Bug40   81
                Frac = 1.                                                       Bug40   82
              ELSE                                                              Bug40   83
                Frac = MIN(1.0, PLR/<ch:MIN-RATIO>)                             Bug40   84
              ENDIF                                                             Bug40   85
              HGBratio = <ch:HGB-RATIO>                  ! hot gas bypass       Chlr1 2801
c              when running, the machine must operate at or above the           Chlr1 2802
c              greater of the min-ratio, or hot-gas-bypass ratio                Chlr1 2803
              PLR      = MAX(PLR, <ch:MIN-RATIO>, HGBratio)                     Chlr1 2804
              EQrun    = OperCap * PLR                                          Chlr1 2805
              EQhgb    = DIM(EQrun*FRAC, Qevap)          ! hot gas bypas        Chlr1 2806
              EIR_fT   = CVAL(<ch:EIR-FT>, Tchws, Tcond) ! EIR as f(T)          Chlr1 2807
              dT       = Tcond - Tchws                                          Chlr1 2808
              EIR_fPLR = CVAL(<ch:EIR-FPLR>, PLR, dT)    ! EIR as f(PLR)        Chlr1 2809
              EQEIR    = <ch:EIR> * EIR_fT * EIR_fPLR    ! hourly EIR           Chlr1 2810
              EQelec   = OperCap * EQEIR * Frac * KWBTU  ! compressor kW        Chlr1 2811
              EQcond   = Qevap                           ! Q rejected           Chlr1 2812
     &                 + EQelec*<ch:ELEC-TO-COND>*BTUKW                         Chlr1 2813
c              check if converged                                               Chlr1 2814
              IF (ABS(1.+EQcond/Qcond)  .LT. 0.005  .AND.                       Chlr1 2815
     &            ABS(1.-CapLast/OperCap) .LT. 0.005)  EXIT                     Chlr1 2816
              CapLast = OperCap                                                 Chlr1 2817
c              adjust evaporator load                                           Chlr1 2818
              IF (Iter .LT. 15)  THEN                                           Chlr1 2819
                Qevap = -Qcond/EQcond * Qevap                                   Chlr1 2820
              ELSE                                                              Chlr1 2821
                Qevap = (1.-Qcond/EQcond) * Qevap * 0.5                         Chlr1 2822
              ENDIF                                                             Chlr1 2823
c              see what evaporator temperature the HX can produce               Chlr1 2824
              CALL HeatExchanger(<ch;EvapHX>, 4, MaxFlag, -Qevap/Frac,          Chlr1 2825
     &                             <ch;DES_CW_GPM>, Twell, xSupTo,              Chlr1 2826
     &                            <ch;DES_CHW_GPM>, Tchws,  Tchwr)              Chlr1 2827
c              control the return temperature to setpoint if possible           Chlr1 2828
              Tchwr = MIN(Tchwr, TsetEvapHX)                                    Chlr1 2829
            ENDDO                                                               Chlr1 2830
            EQcond = EQcond + <ch;Qhwp>                                         Chlr1 2831
          ENDIF  ! Qevap .gt. 1                                                 Chlr1 2832
c                                                                               Chlr1 2833
        CASE (2)  ! Cooling only                                                Chlr1 2834
          ModeOper = COOLMODE                                                   Chlr1 2835
          Jlp      = <ch:CHW-LOOP>                                              Chlr1 2836
          Tchws    = <lp;SUPPLY_T>                                              Chlr1 2837
c              initialize entering condenser temperature                        Chlr1 2838
          Tcond    = <ch:COND-HX-SETPT>                                         Chlr1 2839
c              Iterate to solve chiller and cond HX heat balance                Chlr1 2840
          CapLast  = 0.                                                         Chlr1 2841
          DO  Iter=1,30                                                         Chlr1 2842
            Cap_fT   = CVAL(<ch:CAP-FT>, Tchws, Tcond) ! capacity f(T)          Chlr1 2843
            OperCap  = <ch:CAP> * Cap_fT               ! operating cap          Chlr1 2844
            IF (Iter .GT. 15)  THEN                                             Chlr1 2845
              OperCap = (OperCap+CapLast)/2.                                    Chlr1 2846
            ENDIF                                                               Chlr1 2847
            PLR      = Qevap / OperCap                 ! part load ratio        Chlr1 2848
            IF (<ch:MIN-RATIO> .EQ. 0.)  THEN                                   Bug40   86
              Frac = 1.                                                         Bug40   87
            ELSE                                                                Bug40   88
              Frac = MIN(1.0, PLR/<ch:MIN-RATIO>)                               Bug40   89
            ENDIF                                                               Bug40   90
            HGBratio = <ch:HGB-RATIO>                  ! hot gas bypass         Chlr1 2850
c              when running, the machine must operate at or above the           Chlr1 2851
c              greater of the min-ratio, or hot-gas-bypass ratio                Chlr1 2852
            PLR      = MAX(PLR, <ch:MIN-RATIO>, HGBratio)                       Chlr1 2853
            EQrun    = OperCap * PLR                   ! operating point        Chlr1 2854
            EQhgb    = DIM(EQrun*FRAC, Qevap)          ! hot gas bypass         Chlr1 2855
            EIR_fT   = CVAL(<ch:EIR-FT>, Tchws, Tcond) ! EIR as f(T)            Chlr1 2856
            dT       = Tcond - Tchws                                            Chlr1 2857
            EIR_fPLR = CVAL(<ch:EIR-FPLR>, PLR, dT)    ! EIR as f(PLR)          Chlr1 2858
            EQEIR    = <ch:EIR> * EIR_fT * EIR_fPLR    ! adjusted EIR           Chlr1 2859
            EQelec   = OperCap * EQEIR * Frac * KWBTU  ! compressor kW          Chlr1 2860
            EQcond   = <ch;Qhwp> + Qevap               ! heat rejected          Chlr1 2861
     &               + EQelec*<ch:ELEC-TO-COND>*BTUKW                           Chlr1 2862
            IF (ABS(1.-CapLast/OperCap) .LT. 0.01)  EXIT                        Chlr1 2863
            CapLast = OperCap                                                   Chlr1 2864
c              see what condenser temperature the HX can produce                Chlr1 2865
            CALL HeatExchanger(<ch;CondHX>, 4, MaxFlag, EQcond/Frac,            Chlr1 2866
     &                         <ch;DES_CW_GPM>, Twell, xSupTo,                  Chlr1 2867
     &                         <ch;DES_HW_GPM>,  Thws,  Thwr)                   Chlr1 2868
c              HX may throttle to maintain setpoint                             Chlr1 2869
            dThw = Thws - Thwr                                                  Chlr1 2870
            Thwr = MAX(TsetCondHX, Thwr)                                        Chlr1 2871
            Thws = Thwr + dThw                                                  Chlr1 2872
c              Tcond, adjusted for off-rated flow                               Chlr1 2873
            Tcond = Thws - dThw*MIN(1., <ch;DES_HW_GPM>/<ch;RatedCWgpm>)        Chlr1 2874
          ENDDO                                                                 Chlr1 2875
      END SELECT  ! ModeOper                                                    Chlr1 2876
c                                                                               CHLpHP 344
c              Well load and flow                                               CHLpHP 345
      IF (ModeOper .EQ. COOLMODE)  THEN                                         CHLpHP 346
c              Cooling dominated                                                CHLpHP 347
c              condenser HX load, during run time                               CHLpHP 348
        EQcond = (EQcond + EQloadH) / Frac                                      CHLpHP 349
        IF (<ch:CW-CTRL> .EQ. ConstantFlow)  THEN                               CHLpHP 350
c              constant flow                                                    CHLpHP 351
          CWflow = <ch;DES_CW_GPM>                                              CHLpHP 352
        ELSE                                                                    CHLpHP 353
c              variable flow                                                    CHLpHP 354
          Jlp  = <ch:HW-LOOP>                                                   CHLpHP 355
c              temperature rise thru condenser                                  CHLpHP 356
          dThw = EQcond / (<ch;DES_HW_GPM>*<lp;BTUH/GPM-F>)                     CHLpHP 357
c              HW T entering the HX                                             CHLpHP 358
          IF (EQloadH .NE. 0.)  THEN  ! simultaneous heat/cool                  CHLpHP 359
            ThwInHX = <lp;RETURN_T> + dThw                                      CHLpHP 360
          ELSE  ! cooling only - control to HX setpoint                         CHLpHP 361
            ThwInHX = <ch:COND-HX-SETPT> + dThw                                 CHLpHP 362
          ENDIF                                                                 CHLpHP 363
c              see if HX can handle load at given conditions                    CHLpHP 364
          CALL HeatExchanger(<ch;CondHX>, 1, MaxFlag, Qmax,                     CHLpHP 365
     &                        <ch;DES_CW_GPM>,   Twell, xSupTo,                 CHLpHP 366
     &                        <ch;DES_HW_GPM>, ThwInHX, xDemTo)                 CHLpHP 367
          IF (Qmax .LE. EQcond)  THEN                                           CHLpHP 368
c              HX at full well flow                                             CHLpHP 369
            CWflow = <ch;DES_CW_GPM>                                            CHLpHP 370
            CWhead = <ch:CW-HEAD>                                               CHLpHP 371
          ELSE                                                                  CHLpHP 372
c              get the well flow                                                CHLpHP 373
            CALL HeatExchanger(<ch;CondHX>, 2, MaxFlag, EQcond,                 CHLpHP 374
     &                                   CWflow,   Twell, xSupTo,               CHLpHP 375
     &                          <ch;DES_HW_GPM>, ThwInHX,   Thws)               CHLpHP 376
          ENDIF  ! Qmax                                                         CHLpHP 377
        ENDIF  ! ch:CW-CTRL                                                     CHLpHP 378
      ELSE                                                                      CHLpHP 379
c              Heating dominated                                                CHLpHP 380
c              evaporator HX load, pump heat excluded                           CHLpHP 381
        IF (Frac .GT. 0.)  THEN                                                 CHLpHP 382
          EQcond = -MAX(0., Qevap/Frac-<ch;Qchwp>)                              CHLpHP 383
        ELSE                                                                    CHLpHP 384
          EQcond = 0.                                                           CHLpHP 385
        ENDIF                                                                   CHLpHP 386
        IF (<ch:CW-CTRL> .EQ. ConstantFlow)  THEN                               CHLpHP 387
c              constant flow                                                    CHLpHP 388
          CWflow = <ch;DES_CW_GPM>                                              CHLpHP 389
        ELSE                                                                    CHLpHP 390
c              variable flow                                                    CHLpHP 391
          Jlp   = <ch:CHW-LOOP>                                                 CHLpHP 392
c              temperature rise thru evaporator                                 CHLpHP 393
          dTchw = EQcond / (<ch;DES_CHW_GPM>*<lp;BTUH/GPM-F>)                   CHLpHP 394
c              CHW T entering the HX                                            CHLpHP 395
          IF (EQload .NE. 0.)  THEN  ! simultaneous heat/cool                   CHLpHP 396
            TchwInHX = <lp;RETURN_T>                                            CHLpHP 397
          ELSE  ! heating only - control to HX setpoint                         CHLpHP 398
            TchwInHX = <ch:EVAP-HX-SETPT> + dTchw                               CHLpHP 399
          ENDIF                                                                 CHLpHP 400
c              see if HX can handle load at given conditions                    CHLpHP 401
          CALL HeatExchanger(<ch;EvapHX>, 1, MaxFlag, Qmax,                     CHLpHP 402
     &                        <ch;DES_CW_GPM>,    Twell, xSupTo,                CHLpHP 403
     &                        <ch;DES_HW_GPM>, TchwInHX, xDemTo)                CHLpHP 404
          IF (Qmax .GE. EQcond)  THEN                                           CHLpHP 405
c              HX at full well flow                                             CHLpHP 406
            CWflow = <ch;DES_CW_GPM>                                            CHLpHP 407
            CWhead = <ch:CW-HEAD>                                               CHLpHP 408
          ELSE                                                                  CHLpHP 409
c              get the well flow                                                CHLpHP 410
            CALL HeatExchanger(<ch;EvapHX>, 2, MaxFlag, EQcond,                 CHLpHP 411
     &                                  CWflow,    Twell, xSupTo,               CHLpHP 412
     &                         <ch;DES_HW_GPM>, TchwInHX,   Thws)               CHLpHP 413
          ENDIF  ! Qmax                                                         CHLpHP 414
        ENDIF  ! ch:CW-CTRL                                                     CHLpHP 415
      ENDIF  ! ModeOper                                                         CHLpHP 416
c              maintain minimum flow                                            CHLpHP 417
      CWflow  = MAX(CWflow, <ch:CW-MIN-GPM>)                                    CHLpHP 418
c              CW head                                                          CHLpHP 419
      PLRflow = CWflow / <ch;DES_CW_GPM>                                        CHLpHP 420
      CWhead  = <ch:CW-HEAD> * PLRflow**1.8                                     CHLpHP 421
c              adjust condenser load for runtime                                CHLpHP 422
      EQcond  = EQcond * Frac                                                   CHLpHP 423
      CWflow  = CWflow * Frac                                                   CHLpHP 424
c                                                                               CHLpHP 425
c              If chiller has an attached condenser pump                        CHLpHP 426
      Jlp = <ch:CW-LOOP>                                                        CHLpHP 427
      IF (<ch:CW-PUMP> .GT. 0)  THEN                                            CHLpHP 428
        Jpm = <ch:CW-PUMP>                                                      CHLpHP 429
c              if the loop has its own pump, then this condenser pump           CHLpHP 430
c              is an equipment pump and can be simulated now.  If the           CHLpHP 431
c              loop does not have its own pump, then this pump powers           CHLpHP 432
c              the loop and must be simulated later when more is known          CHLpHP 433
c              about the total loop flow and head.                              CHLpHP 434
        IF (<pm;TYPE> .EQ. EquipmentPump)  THEN                                 CHLpHP 435
c                 equipment pump                                                CHLpHP 436
          PMPgpm    = CWflow                                                    CHLpHP 437
          PMPset    = CWhead + <ch:CW-STATIC>                                   CHLpHP 438
          PMPfric   = CWhead                                                    CHLpHP 439
          PMPstatic = <ch:CW-STATIC>                                            CHLpHP 440
          PMPfrac   = 1.    ! runs continuously                                 -047e   13
          CALL PUMP                                                             CHLpHP 442
c                 add condenser pump heat into condenser water                  CHLpHP 443
          EQcond    = EQcond + PMPQ                                             CHLpHP 444
c                 sum into auxiliary pump kW                                    CHLpHP 445
          AuxPumpKW = AuxPumpKW + PMPkW                                         CHLpHP 446
        ELSEIF (SimCtrl .NE. 11)  THEN                                          -041g    8
c              condenser pump powers the loop - save for later                  CHLpHP 448
          <pm;GPM>        = CWflow                                              CHLpHP 449
          <pm;EQUIP_HEAD> = CWhead                                              CHLpHP 450
        ENDIF                                                                   CHLpHP 451
      ENDIF                                                                     CHLpHP 452
c                                                                               CHLpHP 453
c              separate out start-up load                                       CHLpHP 454
      EQload  = EQload  - EQstart                                               CHLpHP 455
      EQloadH = EQloadH - EQstartH                                              CHLpHP 456
c                                                                               CHLpHP 457
c              Auxiliary power                                                  CHLpHP 458
 1000 IF (<ch:AUX-KW> .GT. 0.)  THEN                                            CHLpHP 459
c              if always on                                                     CHLpHP 460
        IF (<ch:AUX-MODE> .EQ. Always)  THEN                                    CHLpHP 461
          EQaux = <ch:AUX-KW>                                                   CHLpHP 462
        ELSEIF (<ch:AUX-MODE> .EQ. WhenOn)  THEN                                CHLpHP 463
          EQaux = <ch:AUX-KW> * Frac                                            CHLpHP 464
        ELSEIF (<ch:AUX-MODE> .EQ. WhenOff)  THEN                               CHLpHP 465
          EQaux = <ch:AUX-KW> * (1.0 - Frac)                                    CHLpHP 466
        ELSE                                                                    CHLpHP 467
          EQaux = <ch:AUX-KW> * SchVal(<ch:AUX-SCH>, 1.)                        CHLpHP 468
        ENDIF                                                                   CHLpHP 469
      ENDIF                                                                     CHLpHP 470
c                                                                               CHLpHP 471
c ****         run function : Chiller_LoopHP_1-5                                CHLpHP 472
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        CHLpHP 473
c                                                                               CHLpHP 474
c              report variables                                                 CHLpHP 475
      IF (ModeOper .EQ. COOLMODE)  THEN                                         CHLpHP 476
        <ch;KW>  = EQelec                                                       CHLpHP 477
        <ch;KWh> = 0.                                                           CHLpHP 478
      ELSE                                                                      CHLpHP 479
        <ch;KW>  = 0.                                                           CHLpHP 480
        <ch;KWh> = EQelec                                                       CHLpHP 481
        EQelecH  = EQelec                                                       CHLpHP 482
        EQelec   = 0.                                                           CHLpHP 483
      ENDIF                                                                     CHLpHP 484
      IF (JlpSave .EQ. <ch:HW-LOOP>)  THEN                                      CHLpHP 485
        IF (EQload .GT. 0.)  THEN                                               CHLpHP 486
          Jpe        = <ch;Jpe>                                                 CHLpHP 487
          <pe;LOAD>  = EQload + <ch;Qchwp>                                      CHLpHP 488
        ENDIF                                                                   CHLpHP 489
        <ch;Q_RECVR> = MIN(0., EQloadH+<ch;Qhwp>)                               CHLpHP 490
        <ch;AUX>     = EQaux                                                    CHLpHP 491
        IF (OperCap .NE. 0.)  THEN                                              CHLpHP 492
          <ch;PLR> = Qevap / OperCap                                            CHLpHP 493
        ELSE                                                                    CHLpHP 494
          <ch;PLR> = 0.                                                         CHLpHP 495
        ENDIF                                                                   CHLpHP 496
        <ch;FRAC> = Frac                                                        CHLpHP 497
      ENDIF                                                                     CHLpHP 498
      <ch;CWload> = EQcond                                                      CHLpHP 499
      <ch;CWflow>  = CWflow  ! no adjustment for cycling                        -047e   14
      <ch;CWhead> = CWhead                                                      CHLpHP 501
      <ch;Tcond>  = Tcond                                                       -041h    6
c              restore original pointers                                        CHLpHP 502
      Jlp = JlpSave                                                             CHLpHP 503
      Jpe = JpeSave                                                             CHLpHP 504
c                                                                               CHLpHP 505
c              hourly-report variables                                          CHLpHP 506
      IF (<ch;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                                CHLpHP 507
     &  CALL HourRepPLT(EQUIPDAT(1), <ch;HREP>, 16, 0)                          CHLpHP 508
c                                                                               CHLpHP 509
      RETURN                                                                    CHLpHP 510
      END                                                                       CHLpHP 511
      SUBROUTINE CoolingTwr_1                                                   CT1      2
c                                                                               CT1      3
c                                                                               CT1      4
c              Simulates an open cross-flow cooling tower.  The tower           CT1      5
c              may have a heat exchanger between the tower and the loop         CT1      6
c                                                                               CT1      7
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /LOOP  / Nloop(16,2), NextType(40), NLP2,                         -41a     1
     &                 WLHPoff, RealCall, RegenFlag, Sim2x, LoopSimCount        ChlrHP   2
      LOGICAL          WLHPoff, RealCall, RegenFlag, Sim2x                      ChlrHP   3
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /REPORT/ IREPRT(4,37),IPRG,IUNIQV(100),IUNIQS(100),IUNIQL         /REPORT/ 2
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /TWRDAT/ TWRload,TCAP,TWRrej,CWgpm,TWRgpm,TWRsupply,              /TWRDAT/ 2
     &                 TWRset,Ttower,RANGE,APP,twr1FRA,GPMra,GPMcap,            /TWRDAT/ 3
     &                 GPMcell,NumCells,MinCells,MaxCells,Ttop,GPMtop,          /TWRDAT/ 4
     &                 Tbot,GPMbot,CFMra,FankWr,FankW,TWRaux,QpanLoss,          -034     2
     &                 QcoilLoss, SpraykW, Twet1, Tstart                        /TWRDAT/ 6
      DIMENSION        TWRSAV(25)                                               /TWRDAT/ 7
      EQUIVALENCE     (TWRSAV(1),TWRload)                                       /TWRDAT/ 8
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               CT1     24
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
      COMMON  /TWRKY / Open, OpenHX, FluidCool,                                 /TWRKY/  2
     &                 Bypass, Speed1, Speed2, SpeedV, Damper,                  /TWRKY/  3
     &                 RunMinCells, RunMaxCells,                                /TWRKY/  4
     &                 ElecPanHtr, NoPanHtr, HWPanHtr,                          /TWRKY/  5
     &                 CycleWithFan, StayOn                                     /TWRKY/  6
      INTEGER          Open, OpenHX, FluidCool,                                 /TWRKY/  7
     &                 Bypass, Speed1, Speed2, SpeedV, Damper,                  /TWRKY/  8
     &                 RunMinCells, RunMaxCells,                                /TWRKY/  9
     &                 ElecPanHtr, NoPanHtr, HWPanHtr,                          /TWRKY/ 10
     &                 CycleWithFan, StayOn                                     /TWRKY/ 11
c                                                                               CT1     29
c              limits for performance curves                                    CT1     30
      DIMENSION TWRLIM(2)                                                       CT1     31
      DATA TWRLIM /120.,  0./                                                   CT1     32
c              curve for dynamic PLR curve 'constants'                          CT1     33
      DIMENSION CURVE(6)                                                        CT1     34
      DATA CURVE /6*0.0/                                                        CT1     35
c                                                                               CT1     36
c              zero hourly tower data                                           CT1     37
      CALL FILLN(0., TWRSAV(1), IVTLIM(2,19))                                   CT1     38
c              tower type                                                       CT1     39
      ITYPE = <tw:TYPE>                                                         CT1     40
c                                                                               CT1     41
c ****         run function : CoolingTwr_1-1                                    CT1     42
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        CT1     43
c                                                                               CT1     44
c                                                                               CT1     45
c============= ROUTINE CALLED TO GET OPERATING CAPACITY ======================= CT1     46
c              Unlike other equipment, capacity is in gpm, not energy           CT1     47
      IF (SimCtrl .EQ. 11)  THEN                                                CT1     48
c              temperature drop                                                 CT1     49
        CWrange = MAX(1., QloopNet / (GPMs * <lp;BTUH/GPM-F>))                  CT1     50
c              wetbulb is limited to 0-90F                                      CT1     51
        Twet1 = MIN(MAX(WBT, 0.), 90.)                                          CT1     52
c              leaving temperature setpoint                                     CT1     53
        TWRset = <lp;COOL_SETPT>                                                CT1     54
c              setpoint must be greater than wetbulb                            CT1     55
        TWRset = MAX(Twet1+2., TWRset)                                          CT1     56
c              get the capacity                                                 CT1     57
        IF (ITYPE .NE. OpenHX)  THEN                                            CT1     58
c              approach to wetbulb                                              CT1     59
          APP   = TWRset - Twet1                                                CT1     60
c              assume drop thru tower same as loop                              CT1     61
          RANGE = CWrange                                                       CT1     62
c              tower capacity, gpm                                              CT1     63
          IF (QloopNet .GT. 0.)  THEN                                           HVAC29   2
            CWgpm = TwrGPMCap(CWrange, APP, Twet1)                              HVAC29   3
          ELSE                                                                  HVAC29   4
c              no load                                                          HVAC29   5
            CWgpm = <tw:CELL-MAX-GPM>                                           HVAC29   6
          ENDIF                                                                 HVAC29   7
          CWgpm = MIN(CWgpm, <tw:CELL-MAX-GPM>) * <tw:NUM-CELLS>                CT1     65
        ELSE                                                                    CT1     66
c              OPEN-TWR&HX                                                      CT1     67
          Jhx      = <tw:CW-HX>                                                 CT1     68
          Jpm      = <tw:CW-PUMP>                                               CT1     69
          IF (QloopNet .GT. 0.)  THEN                                           HVAC29   8
            CWgpm = TwrHxGPMCap(TWRset,CWrange,                                 HVAC29   9
     &              <pe;DES_GPM>,<tw:NUM-CELLS>,<pm;DESIGN_HEAT>, Twet1)        HVAC29  10
          ELSE                                                                  HVAC29  11
c              no load                                                          HVAC29  12
            CWgpm = <hx:MAX-DEM-FLOW>                                           HVAC29  13
          ENDIF                                                                 HVAC29  14
          CWgpm = MIN(CWgpm, <hx:MAX-DEM-FLOW>)                                 CT1     72
        ENDIF                                                                   CT1     73
c                                                                               CT1     74
c ****         run function : CoolingTwr_1-2                                    CT1     75
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        CT1     76
c                                                                               CT1     77
        <pe;OPER_CAPACITY> = CWgpm                                              CT1     78
        <pe;MAX_CAPACITY>  = CWgpm                                              CT1     79
c                                                                               CT1     80
        RETURN                                                                  CT1     81
      ENDIF                                                                     CT1     82
c                                                                               CT1     83
c                                                                               CT1     84
c============= ROUTINE CALLED TO SIMULATE EQUIPMENT =========================== CT1     85
c              total equipment pump kW                                          CT1     86
      AuxPumpKW  = 0.                                                           CT1     87
c              condenser loop flow thru this tower                              CT1     88
      CWgpm = <pe;GPM>                                                          CT1     89
c                                                                               CT1     90
c ****         run function : CoolingTwr_1-3                                    CT1     91
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        CT1     92
c                                                                               CT1     93
c              Auxiliary power                                                  CT1     94
      IF (<tw:AUX-KW> .GT. 0.  .AND.  RealCall)  THEN                           CT1     95
c              if always on                                                     CT1     96
        IF (<tw:AUX-MODE> .EQ. Always  .OR.                                     CT1     97
c              if on when equipment on                                          CT1     98
     1      (<tw:AUX-MODE> .EQ. WhenOn  .AND. CWgpm .GT. 0.)  .OR.              CT1     99
c              if off when equipment on                                         CT1    100
     2      (<tw:AUX-MODE> .EQ. WhenOff .AND. CWgpm .EQ. 0.) )  THEN            CT1    101
          TWRaux = <tw:AUX-KW>                                                  CT1    102
        ELSE                                                                    Time    22
          TWRaux = <tw:AUX-KW> * SchVal(<tw:AUX-SCH>, 1.)                       Time    23
        ENDIF                                                                   CT1    105
      ENDIF                                                                     CT1    106
c              skip if no load                                                  CT1    107
      IF (CWgpm .LT. 0.01  .OR.  <pe;LOAD> .LT. 0.00001)  THEN                  HVAC29  15
        TWRload   = 0.                                                          CT1    109
        <pe;LOAD> = 0.                                                          CT1    110
c              check for pan heater                                             CT1    111
        IF (<tw;PAN_UA> .GT. 0.  .AND.  DBT .LT. <tw:PAN-FLUID-T>)  THEN        CT1    112
          Tpan     = <tw:PAN-FLUID-T>                                           CT1    113
          UA       = <tw;PAN_UA> * SurfaceFilmAdj(Tpan, DBT, WNDSPD)            CT1    114
          QpanLoss = UA * (DBT - Tpan)                                          CT1    115
          IF (<tw:PAN-HTR-TYPE> .EQ. ElecPanHtr)  THEN                          CT1    116
c              electric pan heater - pass on to auxiliary                       CT1    117
            TWRaux = TWRaux - QpanLoss * KWBTU                                  CT1    118
          ELSE                                                                  CT1    119
c              hot water pan heater                                             CT1    120
            JlpSave = Jlp                                                       CT1    121
            Jlp = <tw:PAN-HTR-LOOP>                                             CT1    122
            <lp;AUX_HEAT> = <lp;AUX_HEAT> + QpanLoss*<lp;HCAP_RATIO>            CT1    123
            IF (<tw:PAN-VALVE-TYP> .EQ. 3)  THEN                                CT1    124
c              3-way valve                                                      CT1    125
              <lp;PRIM_GPM>      = <lp;PRIM_GPM> + <tw;PAN_DES_GPM>             CT1    126
              <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                      CT1    127
     &                                   <tw:PAN-HTR-HEAD>)                     CT1    128
            ELSE                                                                CT1    129
c              2-way valve - assume linear with load                            CT1    130
              PLR = MIN(1., QpanLoss/<tw:PAN-LOSS>)                             CT1    131
              <lp;PRIM_GPM> = <lp;PRIM_GPM>                                     CT1    132
     &                      + <tw;PAN_DES_GPM> * PLR                            CT1    133
              <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                      CT1    134
     &                                   <tw:PAN-HTR-HEAD>*PLR**1.8)            CT1    135
            ENDIF                                                               CT1    136
            Jlp = JlpSave                                                       CT1    137
          ENDIF                                                                 CT1    138
        ENDIF  !pan losses                                                      CT1    139
        GOTO 1000                                                               CT1    140
      ELSE                                                                      CT1    141
        TWRload   = <pe;LOAD>                                                   CT1    142
      ENDIF                                                                     CT1    143
c                                                                               CT1    144
      NumCellsAvail = INT(<tw:NUM-CELLS>)                                       CT1    145
c                                                                               CT1    146
c              minimum and maximum number of cells                              CT1    147
c              that can operate with the loop GPM                               CT1    148
      MinCells = MAX(1, MIN(INT(CWgpm/<tw:CELL-MAX-GPM> + .999999),             CT1    149
     &                                                  NumCellsAvail) )        CT1    150
      MaxCells = MAX(1, MIN(INT(CWgpm/<tw:CELL-MIN-GPM> + .999999),             CT1    151
     &                                                  NumCellsAvail) )        CT1    152
c                                                                               CT1    153
c              flow thru the tower                                              CT1    154
   12 IF (ITYPE .NE. OpenHX)  THEN                                              CT1    155
c              open tower                                                       CT1    156
        IF (<tw:CW-PUMP> .GT. 0)  THEN                                          CT1    157
          Jpm = <tw:CW-PUMP>                                                    CT1    158
          IF (<pm;TYPE> .EQ. EquipmentPump)  THEN                               CT1    159
c              pump recirculates thru the tower only                            CT1    160
            IF (<pm;EQUIP_CTRL> .EQ. ConstantFlow)  THEN                        CT1    161
c              constant flow                                                    CT1    162
              TWRgpm  = <pm;EQUIP_GPM>                                          CT1    163
            ELSE                                                                CT1    164
c              not constant flow, flow is loop flow                             CT1    165
              TWRgpm = MAX(CWgpm, <tw:CW-MIN-GPM>)                              CT1    166
            ENDIF                                                               CT1    167
          ELSE                                                                  CT1    168
c              pump powers the loop, flow is loop flow                          CT1    169
            TWRgpm  = CWgpm                                                     CT1    170
          ENDIF                                                                 CT1    171
        ELSE                                                                    CT1    172
c              no recirculation pump, flow is loop flow                         CT1    173
          TWRgpm  = CWgpm                                                       CT1    174
        ENDIF                                                                   CT1    175
      ELSE                                                                      CT1    176
c              open tower with HX - flow is dependent                           CT1    177
c              on number of cells operating                                     CT1    178
        IF (<tw:CELL-CTRL> .EQ. RunMinCells)  THEN                              CT1    179
c              use minimum number of cells                                      CT1    180
          NumCells = MinCells                                                   CT1    181
        ELSE                                                                    CT1    182
c              use maximum number of cells                                      CT1    183
          NumCells = MaxCells                                                   CT1    184
        ENDIF                                                                   CT1    185
        CellNum = FLOAT(NumCells)                                               CT1    186
c              tower flow steps with the number of cells operating              CT1    187
        TWRgpm = <tw;GPM/CELL> * CellNum                                        CT1    188
c              set pointer to hx for following calcs                            CT1    189
        Jhx    = <tw:CW-HX>                                                     CT1    190
      ENDIF                                                                     CT1    191
c                                                                               CT1    192
c              initialize tower heat rejected to be the loop load               CT1    193
      TWRrej = TWRload                                                          CT1    194
c                                                                               CT1    195
c              Simulate pump attached directly to tower.  This pump may         CT1    196
c              be either a recirculation (equipment pump), or may also          CT1    197
c              power the condenser loop.  Note that the pump is assumed         CT1    198
c              to run the entire hour.  In the future this should be            CT1    199
c              modified to allow cycling.                                       CT1    200
      IF (<tw:CW-PUMP> .GT. 0)  THEN                                            CT1    201
        PMPfrac = 1.0                                                           CT1    202
c              do the pump simulation                                           CT1    203
        Jpm = <tw:CW-PUMP>                                                      CT1    204
        CALL PumpSupply                                                         CT1    205
c              add pump heat to load                                            CT1    206
        TWRrej = TWRrej + PMPQ                                                  CT1    207
        IF (<lp:PUMP> .NE. 0)  AuxPumpKW = PMPkW                                CT1    208
      ELSE                                                                      CT1    209
        PMPQ  = 0.                                                              CT1    210
        PMPdT = 0.                                                              CT1    211
      ENDIF                                                                     CT1    212
c                                                                               CT1    213
c              wetbulb is limited to 0-90F                                      CT1    214
      Twet1  = MIN(MAX(WBT, 0.), 90.)                                           CT1    215
c                                                                               CT1    216
c              required leaving supply temperature                              CT1    217
      TWRset = <lp;COOL_SETPT>                                                  CT1    218
c              Adjust tower setpoint for pump heat (pump is assumed to be       CT1    219
c              on leaving side of tower)                                        CT1    220
      IF (ITYPE .NE. OpenHX)  TWRset = TWRset - PMPdT                           CT1    221
c              beginning of hour loop temperature                               CT1    222
      Tstart = <lp;SUPPLY_T>                                                    CT1    223
c              estimate of tower range (temp in minus temp out)                 CT1    224
      RANGE  = TWRrej / (TWRgpm * <lp;BTUH/GPM-F>)                              CT1    225
c              range must be at least 1F                                        CT1    226
      RANGE  = MAX(RANGE, 1.0)                                                  CT1    227
c              range on loop side                                               CT1    228
      CWrange = MAX(0., TWRrej/(CWgpm * <lp;BTUH/GPM-F>))                       CT1    229
c                                                                               CT1    230
c              skip if tower fan speed is controlled directly on load           CT1    231
      IF (<lp:CL-SETPT-CTRL> .EQ. LOAD)  GOTO 300                               CT1    232
c                                                                               CT1    233
c============= TEMPERATURE SETPOINT CALCULATIONS ============================== CT1    234
c              Adjust actual setpoint for the controller's throttling           CT1    235
c              range.  To do this, capacity must be known at top and            CT1    236
c              bottom of throttling range.                                      CT1    237
  150 THRTL  = <lp:SETPT-RNG>                                                   CT1    238
c              temperatures at top and bottom of range                          CT1    239
      Ttop   = TWRset + THRTL * .5                                              CT1    240
      Tbot   = Ttop - THRTL                                                     CT1    241
c              skip to floating calculations if Ttop is close to wetbulb        CT1    242
      IF (Ttop .LE. (Twet1+2.1))  GOTO 200                                      CT1    243
      IF (ITYPE .NE. OpenHX)  THEN                                              CT1    244
c              Approach at top of throttling range.                             CT1    245
        APP    = Ttop - Twet1                                                   CT1    246
c              Capacity at top of throttling range                              CT1    247
        GPMtop = TwrGPMCap(RANGE, APP, Twet1)                                   CT1    248
     &         * FLOAT(MaxCells)                                                CT1    249
c              skip to floating calcs if GPMtop insufficient for load           CT1    250
        IF (GPMtop .LT. TWRgpm)  GOTO 200                                       CT1    251
      ELSE                                                                      CT1    252
c              OPEN-TWR&HX - capacity is on condenser side of hx                CT1    253
        GPMtop = TwrHxGPMCap(Ttop,CWrange, TWRgpm,CellNum,PMPQ, Twet1)          CT1    254
c              if GPMtop insufficient for load                                  CT1    255
        IF (GPMtop .LT. CWgpm)  THEN                                            CT1    256
c              turn on another cell if possible                                 CT1    257
          IF (NumCells .LT. MaxCells)  THEN                                     CT1    258
            MinCells = MinCells + 1                                             CT1    259
c              start over at heat exchanger calcs                               CT1    260
            GOTO 12                                                             CT1    261
          ELSE                                                                  CT1    262
            GOTO 200                                                            CT1    263
          ENDIF                                                                 CT1    264
        ENDIF                                                                   CT1    265
      ENDIF                                                                     CT1    266
c              Repeat for approach and tower capacity at bottom of              CT1    267
c              throttling range. Capacity is zero if Tbot is less than          CT1    268
c              wetbulb, and the effective throttling range is reduced.          CT1    269
      IF (Tbot .LT. (Twet1+2.0))  THEN                                          CT1    270
        GPMbot = 0.                                                             CT1    271
        Tbot   = Twet1 + 2.0                                                    CT1    272
        THRTL  = Ttop - Tbot                                                    CT1    273
      ELSE                                                                      CT1    274
        IF (ITYPE .NE. OpenHX)  THEN                                            CT1    275
c              Approach at bottom of throttling range.                          CT1    276
          APP    = Tbot - Twet1                                                 CT1    277
c              Capacity at top of throttling range                              CT1    278
          GPMbot = TwrGPMCap(RANGE, APP, Twet1)                                 CT1    279
     &           * FLOAT(MaxCells)                                              CT1    280
        ELSE                                                                    CT1    281
c              OPEN-TWR&HX                                                      CT1    282
          GPMbot = TwrHxGPMCap(Tbot,CWrange, TWRgpm,CellNum,PMPQ, Twet1)        CT1    283
        ENDIF                                                                   CT1    284
      ENDIF                                                                     CT1    285
c              Now determine the tower temperature based on throttling range,   CT1    286
c              and capacity variation over throttling range                     CT1    287
      CAPtop   = GPMtop * RANGE*<lp;BTUH/GPM-F>                                 CT1    288
      CAPbot   = GPMbot * RANGE*<lp;BTUH/GPM-F>                                 CT1    289
      DCAP     = CAPtop - CAPbot                                                CT1    290
      Cp       = <lp;BTU/F>                                                     CT1    291
      CURVE(3) = DCAP                                                           CT1    292
      CURVE(2) = Cp*THRTL*THRTL + CAPbot*THRTL - 2.0*Tbot*DCAP                  CT1    293
      CURVE(1) = -(TWRrej + Tstart*Cp)*THRTL*THRTL                              CT1    294
     &                  -CAPbot*Tbot*THRTL + DCAP*Tbot*Tbot                     CT1    295
c              Ttower is either:  Temp leaving tower (not OpenHX)               CT1    296
c                                 Temp leaving hx    (OpenHX)                   CT1    297
      CALL CURINV(CURVE(1), 3, 1, Ttower, Ttower, 0.0, TWRLIM(1), IERR)         CT1    298
      IF (ITYPE .NE. OpenHX)  Ttower = Ttower + PMPdT                           CT1    299
c              Skip rest if only an estimation call                             CT1    300
      IF (.NOT. RealCall)  THEN                                                 CT1    301
        TWRsupply = Ttower                                                      CT1    302
        GOTO 401                                                                CT1    303
      ENDIF                                                                     CT1    304
c                                                                               CT1    305
c============= CONTROL TO HOLD SETPOINT ======================================= CT1    306
c              Desired approach                                                 CT1    307
  160 APP    = Ttower - Twet1                                                   CT1    308
c              Skip to floating calcs if approach .lt. 2F                       CT1    309
      IF (APP .LT. 2.0)  GOTO 200                                               CT1    310
c              Adjust TWRrej and range for loop temperature change              CT1    311
c              from last hour.                                                  CT1    312
      TWRrej = TWRload + (Tstart-Ttower)*<lp;BTU/F> + PMPQ                      CT1    313
      RANGE  = MAX(1.0, TWRrej / (TWRgpm*<lp;BTUH/GPM-F>) )                     CT1    314
c              Actual GPM capacity per cell                                     CT1    315
      IF (ITYPE .NE. OpenHX)  THEN                                              CT1    316
        GPMcap = TwrGPMCAP(RANGE, APP, Twet1)                                   CT1    317
        GPMcap = MIN(GPMcap, <tw:CELL-MAX-GPM>)                                 CT1    318
c              Determine if tower has sufficient capacity to meet setpoint      CT1    319
        IF (GPMcap*FLOAT(MaxCells) .LT. TWRgpm)  GO TO 200                      CT1    320
c              setpoint can be met.  determine how many cells are required.     CT1    321
        NumCells = INT(TWRgpm/GPMcap +.99999)                                   CT1    322
c              use maximum number of cells if user specified.                   CT1    323
        IF (<tw:CELL-CTRL> .EQ. RunMaxCells)  THEN                              CT1    324
          NumCells = MAX(NumCells, MaxCells)                                    CT1    325
        ELSE                                                                    CT1    326
c              otherwise, use minimum number of cells                           CT1    327
          NumCells = MAX(NumCells, MinCells)                                    CT1    328
        ENDIF                                                                   CT1    329
        CellNum = FLOAT(NumCells)                                               CT1    330
      ELSE                                                                      CT1    331
c              OpenHX already has number of cells established                   CT1    332
c              Note that GPMcap is what the loop sees, demand-side of hx        CT1    333
        CWrange = MAX(1.0, TWRrej / (CWgpm*<lp;BTUH/GPM-F>) )                   CT1    334
        GPMcap  = TwrHxGPMCap(Ttower,CWrange, TWRgpm,CellNum,PMPQ,Twet1)        CT1    335
        GPMcap  = MIN(GPMcap, <hx:MAX-DEM-FLOW>)                                CT1    336
c              Check if load can be met using current number of cells           CT1    337
        IF (GPMcap .LT. CWgpm)  THEN                                            CT1    338
c              turn on another cell if possible                                 CT1    339
          IF (NumCells .LT. MaxCells)  THEN                                     CT1    340
            MinCells = MinCells + 1                                             CT1    341
c              start over at heat exchanger calcs                               CT1    342
            GOTO 12                                                             CT1    343
          ELSE                                                                  CT1    344
c              all cells are already on - skip to floating calcs.               CT1    345
            GOTO 200                                                            CT1    346
          ENDIF                                                                 CT1    347
        ENDIF                                                                   CT1    348
      ENDIF                                                                     CT1    349
c              GPM per cell                                                     CT1    350
      GPMcell = TWRgpm / CellNum                                                CT1    351
c                                                                               CT1    352
c              Fan output required to hold setpoint                             CT1    353
c              First, determine how much heat rejection convective              CT1    354
c              cooling can provide (fan off)                                    CT1    355
      IF (ITYPE .NE. OpenHX)  THEN                                              CT1    356
c              Temperature entering tower                                       CT1    357
        Tenter  = Ttower + RANGE                                                CT1    358
        QtwrOff = TwrQrej(GPMcell,<tw:FAN-OFF-CFM>,Tenter,Twet1)*CellNum        CT1    359
      ELSE                                                                      CT1    360
c              open-twr&hx - loop temperature entering the hx                   CT1    361
        Tenter  = Ttower + CWrange                                              CT1    362
        QtwrOff = TwrHxQrej(Tenter,CWgpm,                                       CT1    363
     &                     TWRgpm,CellNum,<tw:FAN-OFF-CFM>, Twet1)              CT1    364
      ENDIF                                                                     CT1    365
      IF (QtwrOff .GE. TWRrej)  THEN                                            CT1    366
        FankWr = 0.0                                                            CT1    367
        IF (<tw:CAP-CTRL> .EQ. Bypass)  THEN                                    CT1    368
          GOTO 400                                                              CT1    369
        ELSE                                                                    CT1    370
c              get floating temperature using natural convection                CT1    371
          CFMra = <tw:FAN-OFF-CFM>                                              CT1    372
          GOTO 201                                                              CT1    373
        ENDIF                                                                   CT1    374
      ENDIF                                                                     CT1    375
c                                                                               CT1    376
c              Fan must run - select capacity control mechanism                 CT1    377
      SELECT CASE (<tw:CAP-CTRL>)                                               CT1    378
      CASE (1)                                                                  CT1    379
c              fluid bypass                                                     CT1    380
        FankWr = 1.0                                                            CT1    381
        GOTO 400                                                                CT1    382
      CASE (2)                                                                  CT1    383
c              single-speed fan                                                 CT1    384
        QtwrLo = QtwrOff                                                        CT1    385
        EfanLo = 0.0                                                            CT1    386
        IF (ITYPE .NE. OpenHX)  THEN                                            CT1    387
          QtwrHi = TwrQrej(GPMcell, 1.0, Tenter, Twet1) * CellNum               CT1    388
        ELSE                                                                    CT1    389
          QtwrHi = TwrHxQrej(Tenter,CWgpm, TWRgpm,CellNum,1.0, Twet1)           CT1    390
        ENDIF                                                                   CT1    391
        EfanHi = 1.0                                                            CT1    392
      CASE (3)                                                                  CT1    393
c              2-speed fan - low speed first                                    CT1    394
        IF (ITYPE .NE. OpenHX)  THEN                                            CT1    395
          QtwrLo = TwrQrej(GPMcell,<tw:FAN-LOW-CFM>,Tenter,Twet1)               CT1    396
     &             * CellNum                                                    CT1    397
        ELSE                                                                    CT1    398
          QtwrLo = TwrHxQrej(Tenter,CWgpm,                                      CT1    399
     &                     TWRgpm,CellNum,<tw:FAN-LOW-CFM>, Twet1)              CT1    400
        ENDIF                                                                   CT1    401
        EfanLo = <tw:FAN-LOW-ELEC>                                              CT1    402
        IF (QtwrLo .GE. TWRrej)  THEN                                           CT1    403
c              will cycle Off/Lo                                                CT1    404
          QtwrHi = QtwrLo                                                       CT1    405
          EfanHi = EfanLo                                                       CT1    406
          QtwrLo = QtwrOff                                                      CT1    407
          EfanLo = 0.0                                                          CT1    408
        ELSE                                                                    CT1    409
c              will cycle Lo/Hi                                                 CT1    410
          IF (ITYPE .NE. OpenHX)  THEN                                          CT1    411
            QtwrHi = TwrQrej(GPMcell, 1.0, Tenter, Twet1) * CellNum             CT1    412
          ELSE                                                                  CT1    413
            QtwrHi = TwrHxQrej(Tenter,CWgpm, TWRgpm,CellNum,1.0,Twet1)          CT1    414
          ENDIF                                                                 CT1    415
          EfanHi = 1.0                                                          CT1    416
        ENDIF                                                                   CT1    417
      CASE (4,5)                                                                CT1    418
c              Variable cfm - get the required airflow                          CT1    419
        IF (ITYPE .NE. OpenHX)  THEN                                            CT1    420
          CFMra = TwrCFMr(GPMcell, RANGE, APP, Twet1)                           CT1    421
        ELSE                                                                    CT1    422
c              heat transferred thru HX is exclusive of tower pump heat         CT1    423
          Qhx   = TWRrej - PMPQ                                                 CT1    424
          CFMra = TwrHxCFMr(Tenter,CWgpm, Qhx, TWRgpm,CellNum,                  CT1    425
     &                                                   RANGE,Twet1)           CT1    426
        ENDIF                                                                   CT1    427
        SELECT CASE (<tw:CAP-CTRL>)                                             CT1    428
        CASE (4)                                                                CT1    429
c              Variable speed airflow must be above that associated with        CT1    430
c              fan's critical speed - must cycle below                          CT1    431
          VFDmin = <tw:MIN-FAN-SPD>                                             CT1    432
          IF (CFMra .GT. VFDmin)  THEN                                          CT1    433
            FankWr = CVAL(<tw:KW-fSPEED>, CFMra, CFMra)                         CT1    434
            GOTO 400                                                            CT1    435
          ELSE                                                                  CT1    436
c              cycle fan between off and minimum                                CT1    437
            QtwrLo = QtwrOff                                                    CT1    438
            EfanLo = 0.0                                                        CT1    439
            IF (ITYPE .NE. OpenHX)  THEN                                        CT1    440
              QtwrHi = TwrQrej(GPMcell, VFDmin, Tenter, Twet1) * CellNum        CT1    441
            ELSE                                                                CT1    442
              QtwrHi = TwrHxQrej(Tenter,CWgpm,                                  CT1    443
     &                               TWRgpm,CellNum,VFDmin, Twet1)              CT1    444
            ENDIF                                                               CT1    445
            EfanHi = CVAL(<tw:KW-fSPEED>, VFDmin, VFDmin)                       CT1    446
          ENDIF                                                                 CT1    447
        CASE (5)                                                                CT1    448
c              Discharge damper                                                 CT1    449
          FankWr = CVAL(<tw:KW-fDAMPER>, CFMra, CFMra)                          CT1    450
          GOTO 400                                                              CT1    451
        END SELECT                                                              CT1    452
      END SELECT                                                                CT1    453
c              cycling fan energy                                               CT1    454
      IF (QtwrHi .gt. QtwrLo) THEN                                              -044c9   1
        FracHi = Max(0., Min(1., (TWRrej-QtwrLo) / (QtwrHi-QtwrLo) ))           -044c9   2
      ELSE                                                                      -044c9   3
        FracHi = 1.                                                             -044c9   4
      ENDIF                                                                     -044c9   5
      FankWr = EfanLo*(1.0-FracHi) + EfanHi*FracHi                              CT1    456
      GO TO 400                                                                 CT1    457
c                                                                               CT1    458
c============= FLOATING TEMPERATURE CALCULATIONS ============================== CT1    459
c              Temperature is floating above or below setpoint.                 CT1    460
c              When above setpoint, turn on as many cells as possible.          CT1    461
  200 NumCells = MaxCells                                                       CT1    462
      CellNum  = FLOAT(NumCells)                                                CT1    463
      CFMra    = 1.0                                                            CT1    464
      FracHi   = 1.0                                                            CT1    465
      FankWr   = 1.0                                                            CT1    466
c              If jumped to 201, tower can handle load using natural            CT1    467
c              convection only, and will be floating below the setpoint         CT1    468
c              (CFMra is set to the natural convective flow)                    CT1    469
  201 IF (ITYPE .NE. OpenHX)  THEN                                              CT1    470
c              Ttower is leaving the tower                                      CT1    471
        Ttower = TwrTexit(TWRload, TWRgpm, CellNum, CFMra, Twet1)               CT1    472
      ELSE                                                                      CT1    473
c              Ttower is leaving the hx                                         CT1    474
        Ttower = TwrHxTexit(CWgpm, TWRload,TWRgpm,CellNum,CFMra, Twet1)         CT1    475
      ENDIF                                                                     CT1    476
c              when floating below setpoint, do not let temperature drop        CT1    477
c              below the minimum                                                CT1    478
      IF (Ttower .LT. <lp:MIN-RESET-T>)  THEN                                   CT1    479
        APP = <lp:MIN-RESET-T> - Twet1                                          CT1    480
        Ttower = <lp:MIN-RESET-T>                                               CT1    481
      ENDIF                                                                     CT1    482
c              end of floating temperature calcs                                CT1    483
      GOTO 400                                                                  CT1    484
c                                                                               CT1    485
c============= LOAD RESET CALCULATIONS ======================================== CT1    486
c              Control tower fan speed directly on chiller load and let         CT1    487
c              leaving temperature float as the load and wetbulb vary.          CT1    488
c              First, number of cells operating.                                CT1    489
  300 IF (<tw:CELL-CTRL> .EQ. RunMaxCells)  THEN                                CT1    490
        NumCells = MaxCells                                                     CT1    491
      ELSE                                                                      CT1    492
c              otherwise, use minimum number of cells                           CT1    493
        NumCells = MinCells                                                     CT1    494
      ENDIF                                                                     CT1    495
      CellNum = FLOAT(NumCells)                                                 CT1    496
c              water flow per cell                                              CT1    497
      GPMcell = TWRgpm / CellNum                                                CT1    498
c              fraction of design heat rejection load                           CT1    499
      PLR = (RANGE * GPMcell) / (<tw:DESIGN-RANGE> * <tw;GPM/CELL>)             CT1    500
c              fraction of airflow and fan speed requested                      CT1    501
c              at this part load ratio                                          CT1    502
      IF (<tw:CAP-CTRL> .EQ. SpeedV)  THEN                                      CT1    503
c              variable speed fan(s)                                            CT1    504
        CFMra = <tw:MIN-FAN-SPD>                                                CT1    505
     &          + (<tw:MAX-FAN-SPD> - <tw:MIN-FAN-SPD>)                         CT1    506
     &                 * (PLR-<tw:MIN-FAN-PLR>)/(1.0-<tw:MIN-FAN-PLR>)          CT1    507
        CFMra = MAX(<tw:MIN-FAN-SPD>,                                           CT1    508
     &                  MIN(CFMra , <tw:MAX-FAN-SPD>))                          CT1    509
      ELSE                                                                      CT1    510
c              2-speed fan - let float on low speed                             CT1    511
        CFMra = <tw:FAN-LOW-CFM>                                                CT1    512
      ENDIF                                                                     CT1    513
c              get tower temperature                                            CT1    514
      IF (ITYPE .NE. OpenHX)  THEN                                              CT1    515
c              Ttower is leaving the tower                                      CT1    516
        Ttower = TwrTexit(TWRload, TWRgpm, CellNum, CFMra, Twet1)               CT1    517
      ELSE                                                                      CT1    518
c              Ttower is leaving the hx                                         CT1    519
        Ttower = TwrHxTexit(CWgpm, TWRload,TWRgpm,CellNum,CFMra, Twet1)         CT1    520
      ENDIF                                                                     CT1    521
c              check if temp is within the acceptable range                     CT1    522
      IF (Ttower .GT. <lp:CL-SETPT-T>)  THEN                                    CT1    523
c              floating temperature is TOO HOT - control to max temp            CT1    524
        TWRset = <lp:CL-SETPT-T>                                                CT1    525
        GOTO 150                                                                CT1    526
      ELSEIF (Ttower .LT. <lp:MIN-RESET-T>)  THEN                               CT1    527
c              floating temperature is TOO COLD - control to min temp           CT1    528
        TWRset = <lp:MIN-RESET-T>                                               CT1    529
        Ttower = <lp:MIN-RESET-T>                                               CT1    530
        IF (RealCall)  THEN                                                     CT1    531
          GOTO 160                                                              CT1    532
        ELSE                                                                    CT1    533
          TWRsupply = Ttower                                                    CT1    534
          GOTO 401                                                              CT1    535
        ENDIF                                                                   CT1    536
      ELSE                                                                      CT1    537
c              floating temperature is JUUSST RIGHT.  Get the fan energy        CT1    538
        IF (RealCall)  THEN                                                     CT1    539
          IF (<tw:CAP-CTRL> .EQ. SpeedV)  THEN                                  CT1    540
c              variable speed                                                   CT1    541
            FankWr  = CVAL(<tw:KW-fSPEED>, CFMra, CFMra)                        CT1    542
          ELSE                                                                  CT1    543
c              2-speed fan running on low speed                                 CT1    544
            FankWr = <tw:FAN-LOW-ELEC>                                          CT1    545
          ENDIF                                                                 CT1    546
        ELSE                                                                    CT1    547
          TWRsupply = Ttower                                                    CT1    548
          GOTO 401                                                              CT1    549
        ENDIF                                                                   CT1    550
      ENDIF                                                                     CT1    551
c              end of fan control on chiller load                               CT1    552
c                                                                               CT1    553
c============= MISCELLANEOUS ================================================== CT1    554
c              Load is now satisfied.                                           CT1    555
  400 TWRsupply     = Ttower                                                    CT1    556
  401 <pe;SUPPLY_T> = TWRsupply                                                 CT1    557
c                                                                               CT1    558
c                                                                               CT1    559
c ****         run function : CoolingTwr_1-4                                    CT1    560
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        CT1    561
c                                                                               CT1    562
c              Skip rest if an estimation call                                  CT1    563
  410 IF (.NOT. RealCall)  RETURN                                               CT1    564
c                                                                               CT1    565
c              power consumption of fans                                        CT1    566
      FankW = <tw:FAN-KW/CELL> * FLOAT(NumCells) * FankWr                       CT1    567
c                                                                               CT1    568
c                                                                               CT1    569
c ****         run function : CoolingTwr_1-5                                    CT1    570
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        CT1    571
c                                                                               CT1    572
c              report variables                                                 CT1    573
 1000 <tw;KW>  = FankW                                                          CT1    574
      <tw;AUX> = TWRaux                                                         CT1    575
      IF (<tw:PAN-HTR-TYPE> .EQ. HWPanHtr)  <tw;AUX_HEAT> = QpanLoss            CT1    576
c                                                                               CT1    577
c              hourly-report variables                                          CT1    578
      IF (<tw;HREP> .NE. 0  .AND.  IRSCH .NE. 0)  THEN                          CT1    579
c              full output maximum CAP                                          CT1    580
        TCAP = <pe;OPER_CAPACITY> * RANGE * <lp;BTUH/GPM-F>                     CT1    581
        CALL HourRepPLT(TWRSAV(1), <tw;HREP>, 19, 0)                            CT1    582
      ENDIF                                                                     CT1    583
c                                                                               CT1    584
      RETURN                                                                    CT1    585
      END                                                                       CT1    586
      SUBROUTINE CoolingTwr_1_Design                                            CT1d     2
c                                                                               CT1d     3
c                                                                               CT1d     4
c              Calculates the design data for an open tower,                    CT1d     5
c              with or without a heat-exchanger                                 CT1d     6
c                                                                               CT1d     7
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /DESDAT/ ZCFM,ICFM,ZVENT,C1,IFLAG                                 /DESDAT/ 2
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /REPORT/ IREPRT(4,37),IPRG,IUNIQV(100),IUNIQS(100),IUNIQL         /REPORT/ 2
      COMMON  /TWRDAT/ TWRload,TCAP,TWRrej,CWgpm,TWRgpm,TWRsupply,              /TWRDAT/ 2
     &                 TWRset,Ttower,RANGE,APP,twr1FRA,GPMra,GPMcap,            /TWRDAT/ 3
     &                 GPMcell,NumCells,MinCells,MaxCells,Ttop,GPMtop,          /TWRDAT/ 4
     &                 Tbot,GPMbot,CFMra,FankWr,FankW,TWRaux,QpanLoss,          -034     2
     &                 QcoilLoss, SpraykW, Twet1, Tstart                        /TWRDAT/ 6
      DIMENSION        TWRSAV(25)                                               /TWRDAT/ 7
      EQUIVALENCE     (TWRSAV(1),TWRload)                                       /TWRDAT/ 8
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               CT1d    20
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
      COMMON  /TWRKY / Open, OpenHX, FluidCool,                                 /TWRKY/  2
     &                 Bypass, Speed1, Speed2, SpeedV, Damper,                  /TWRKY/  3
     &                 RunMinCells, RunMaxCells,                                /TWRKY/  4
     &                 ElecPanHtr, NoPanHtr, HWPanHtr,                          /TWRKY/  5
     &                 CycleWithFan, StayOn                                     /TWRKY/  6
      INTEGER          Open, OpenHX, FluidCool,                                 /TWRKY/  7
     &                 Bypass, Speed1, Speed2, SpeedV, Damper,                  /TWRKY/  8
     &                 RunMinCells, RunMaxCells,                                /TWRKY/  9
     &                 ElecPanHtr, NoPanHtr, HWPanHtr,                          /TWRKY/ 10
     &                 CycleWithFan, StayOn                                     /TWRKY/ 11
c                                                                               CT1d    25
c                                                                               CT1d    31
c              For an open tower, the condenser water flow will be the same     CT1d    32
c              as the tower flow.  For OPEN-TWR&HX, the two flows may be        CT1d    33
c              different, and must be kept track of separately.                 CT1d    34
c                                                                               CT1d    35
c              pointer to cw loop                                               CT1d    36
        Jlp = <tw:CW-LOOP>                                                      CT1d    37
c              tower size                                                       CT1d    38
        IF (<tw:CAPACITY> .EQ. 0.)  THEN                                        CT1d    39
c              default tower size                                               CT1d    40
          IF (<tw:CAP-RATIO> .EQ. 0.)  THEN                                     -042L2   9
c              no capcity ratio specified - size equipment equally              CT1d    42
            TCAP = <lp;DES_CCAP> / FLOAT(<lp;CL_NUM_EQUIP>)                     CT1d    43
          ELSE                                                                  CT1d    44
            TCAP = <lp;DES_CCAP> * <tw:CAP-RATIO>                               CT1d    45
          ENDIF                                                                 CT1d    46
        ELSE                                                                    CT1d    47
          TCAP = <tw:CAPACITY>                                                  CT1d    48
        ENDIF                                                                   CT1d    49
c              number of cells - if not specified, do not allow to              CT1d    50
c              exceed 15MMBTU each when autosizing                              CT1d    51
        IF (<tw:NUM-CELLS> .EQ. 0.)                                             CT1d    52
     &     <tw:NUM-CELLS> = FLOAT(INT(TCAP/1.5E7))                              CT1d    53
c              force to be whole real number                                    CT1d    54
        <tw:NUM-CELLS> = MAX(1.,FLOAT(INT(<tw:NUM-CELLS>+0.5)))                 CT1d    55
c              pick up temperature rise from loop if not specd.                 CT1d    56
        IF (<tw:CW-DT> .EQ. 0.)  <tw:CW-DT> = <lp:DESIGN-DT>                    CT1d    57
c              temperature change is positive for consistency with load         CT1d    58
        <tw:CW-DT> = ABS(<tw:CW-DT>)                                            CT1d    59
c              cw water flow - greater of load or flow requirement              -034    11
        CWload = TCAP / (<lp;BTUH/GPM-F>*<tw:CW-DT>)                            -034    12
        CWflow = <lp;DES_GPM> * TCAP/<lp;DES_CCAP>                              -034    13
        CWgpm  = MAX(CWload, CWflow)                                            -034    14
c              convert minimum flow from fraction to gpm                        CT1d    62
        <tw:CW-MIN-GPM> = CWgpm * <tw:CW-MIN-GPM>                               -031     1
c              warn if loop pressure drop different than others                 CT1d    64
        IF (<tw:CW-PUMP> .EQ. 0)  THEN                                          CT1d    65
          IF (ABS(<tw:CW-HEAD>+<tw:CW-STATIC>                                   CT1d    66
     &         - (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>))                       CT1d    67
     &        / (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>) .GT. 0.05)  THEN        CT1d    68
            CALL MSGSIM(-3,II,II,II,II)                                         CT1d    69
            WRITE (IOUTPT,9107) (<tw:NAME>,II=1,8),                             CT1d    70
     &                          (<lp:NAME>,II=1,8)                              CT1d    71
          ENDIF                                                                 CT1d    72
        ENDIF                                                                   CT1d    73
c                                                                               CT1d    78
c              adjust design water flowrate to the tower if                     CT1d    79
c              a heat exchanger is present                                      CT1d    80
      IF (<tw:TYPE> .EQ. OpenHX)  THEN                                          CT1d    81
        TWRgpm = TCAP / (<tw:DESIGN-RANGE> * <lp;BTUH/GPM-F>)                   CT1d    82
      ELSE                                                                      CT1d    83
        TWRgpm = CWgpm                                                          CT1d    84
      ENDIF                                                                     CT1d    85
c              no tower if no flow                                              CT1d    86
      IF (TWRgpm .LT. .001)  THEN                                               CT1d    87
        <tw:CAPACITY> = 0.                                                      CT1d    88
        CALL MSGSIM(-3, II,II,II,II)                                            CT1d    89
        WRITE(IOUTPT,9100) (<tw:NAME>,II=1,8),                                  CT1d    90
     &                     (<lp:NAME>,II=1,8)                                   CT1d    91
        RETURN                                                                  CT1d    92
      ENDIF                                                                     CT1d    93
c              design the attached tower pump                                   CT1d    94
      IF (<tw:CW-PUMP> .GT. 0)  THEN                                            CT1d    95
        Jpm = <tw:CW-PUMP>                                                      CT1d    96
c              for open tower w/ HX, tower pump cannot power the                CT1d    97
c              condenser loop                                                   CT1d    98
        IF (<tw:TYPE> .EQ. OpenHX  .AND.                                        CT1d    99
     &                       <pm;TYPE> .NE. EquipmentPump)  THEN                CT1d   100
          CALL MSGSIM(-1,II,II,II,II)                                           CT1d   101
          WRITE (IOUTPT, 9101)  (<tw:NAME>,II=1,8),                             CT1d   102
     &                          (<lp:NAME>,II=1,8)                              CT1d   103
          call MessageBox( NULL, 'TOWER pumping design error -'                 CT1d   104
     &      //' ABORTING'//char(0),'OTWRD Errors'//char(0), MB_OK               CT1d   105
     &      + MB_ICONSTOP + MB_TASKMODAL )                                      CT1d   106
          RETURN                                                                CT1d   108
        ENDIF                                                                   CT1d   109
c                                                                               CT1d   110
        CALL PUMPdes(TWRgpm)                                                    CT1d   111
c              increase default size by pump heat                               CT1d   112
        IF (<tw:CAPACITY> .EQ. 0.)  TCAP = TCAP + PMPQ                          CT1d   113
c              store pump heat as parasitic load for hourly OpCap calc          CT1d   114
        <tw;Q_PARASITIC> = PMPQ                                                 CT1d   115
c              store design variables for use in pump calcs                     CT1d   116
        <pm;MIN_GPM>     = <tw:CW-MIN-GPM>                                      CT1d   117
      ENDIF                                                                     CT1d   118
                                                                                -047i    1
c              Flow capacity at rated conditions                                -047i    2
      IF (<tw:CAPACITY> .gt. 0.) THEN                                           -047i    3
        GPMra = CVAL(<tw:GPM-fAPP&WB>,<tw:DESIGN-APPRO>,                        -047i    4
     &                                             <tw:DESIGN-WETBU>)           -047i    5
     &        / CVAL(<tw:GPM-fRNG&WB>,<tw:DESIGN-RANGE>,                        -047i    6
     &                                             <tw:DESIGN-WETBU>)           -047i    7
        GPMrated          = TCAP / (<tw:DESIGN-RANGE> * <lp;BTUH/GPM-F>)        -047i    8
        <tw;GPM/CELL_CTI> = GPMrated / (GPMra * <tw:NUM-CELLS>)                 -047i    9
      ELSE                                                                      -047i   10
        RANGE = TCAP / (Twrgpm * <lp;BTUH/GPM-F>)                               -047i   11
        GPMra = CVAL(<tw:GPM-fAPP&WB>,<tw:DESIGN-APPRO>,                        -047i   12
     &                                             <tw:DESIGN-WETBU>)           -047i   13
     &         / CVAL(<tw:GPM-fRNG&WB>,RANGE,<tw:DESIGN-WETBU>)                 -047i   14
        <tw;GPM/CELL_CTI> = Twrgpm / (GPMra * <tw:NUM-CELLS>)                   -047i   15
      ENDIF                                                                     -047i   16
c              store tower capacity                                             -047i   17
      <tw:CAPACITY> = TCAP                                                      -047i   18
c              maximum and minimum flowrate per cell - convert from             -047i   19
c              ratio to gpm                                                     -047i   20
      <tw;GPM/CELL>     = Twrgpm / <tw:NUM-CELLS>                               -047i   21
      <tw:CELL-MAX-GPM> = <tw;GPM/CELL_CTI> * <tw:CELL-MAX-GPM>                 -047i   22
      <tw:CELL-MAX-GPM> = Max(<tw:CELL-MAX-GPM>, <tw;GPM/CELL>)                 -047i   23
      <tw:CELL-MIN-GPM> = <tw;GPM/CELL_CTI> * <tw:CELL-MIN-GPM>                 -047i   24
c                                                                               CT1d   138
c              tower fan energy per cell.  If not user-defined, default         CT1d   139
c              is 0.019 HP/GPM @ CTI nominal rating, which is the default       CT1d   140
c              eir                                                              CT1d   141
      IF (<tw:FAN-KW/CELL> .EQ. 0.)                                             CT1d   142
     &  <tw:FAN-KW/CELL> =                                                      CT1d   143
     &        <tw;GPM/CELL_CTI> * 500.4 * 10. * <tw:EIR> * KWBTU                CT1d   144
c              total fan kW for all cells, plus auxiliary                       CT1d   145
      <tw;DES_KW> = <tw:FAN-KW/CELL> * <tw:NUM-CELLS> + <tw:AUX-KW>             CT1d   146
c              Do not let fan speed ranges overlap                              -044c4 378
      <tw:FAN-LOW-CFM> = Min(Max(<tw:FAN-LOW-CFM>,                              -044c4 379
     &                           <tw:FAN-OFF-CFM>+0.02), 0.95)                  -044c4 380
      <tw:MIN-FAN-SPD> = Min(Max(<tw:MIN-FAN-SPD>,                              -044c4 381
     &                           <tw:FAN-OFF-CFM>+0.02), 0.95)                  -044c4 382
c              default low-speed kW according to the speed curve                CT1d   147
      IF (<tw:CAP-CTRL> .EQ. Speed2  .AND.  <tw:FAN-LOW-ELEC> .EQ. 0.)          CT1d   148
     &  <tw:FAN-LOW-ELEC> = CVAL(<tw:KW-fSPEED>, <tw:FAN-LOW-CFM>,              CT1d   149
     &                                           <tw:FAN-LOW-CFM>)              CT1d   150
c                                                                               CT1d   151
c              When the loop temperature control strategy is LOAD-RESET,        CT1d   152
c              the tower fan must be 2-speed or variable-speed.                 CT1d   153
      IF (<lp:CL-SETPT-CTRL> .EQ. LOAD                                          CT1d   154
     &                         .AND.  <tw:CAP-CTRL> .NE. Speed2                 CT1d   155
     &                         .AND.  <tw:CAP-CTRL> .NE. SpeedV)  THEN          CT1d   156
        CALL MSGSIM(-2,II,II,II,II)                                             CT1d   157
        WRITE (IOUTPT,9102)  (<tw:NAME>,II=1,8)                                 CT1d   158
        <lp:CL-SETPT-CTRL> = FIXED                                              CT1d   159
        <lp:CL-SETPT-T>    = <lp:DESIGN-COOL-T>                                 -042b    1
      ENDIF                                                                     CT1d   160
c                                                                               CT1d   161
c              Define heat exchanger for open tower if required.                CT1d   162
      IF (<tw:CW-HX> .GT. 0)  THEN                                              CT1d   163
        Jhx    = <tw:CW-HX>                                                     CT1d   164
c              Design HX capacity                                               CT1d   165
        Qhx    = <tw:CAPACITY> - PMPQ                                           CT1d   166
c              differential between inlet temperatures                          CT1d   167
        IF (<hx:INLETS-DT> .EQ. 0.)  <hx:INLETS-DT> = <tw:HX-DT>                CT1d   168
        CALL HeatExchanger_Design(Jhx, Jtw, Jlp, Qhx,                           CT1d   169
     &                      TWRgpm, <lp;BTUH/GPM-F>, xxx, <tw:CW-HEAD>,         CT1d   170
     &                       CWgpm, <lp;BTUH/GPM-F>, xxx, <tw:CW-HEAD>)         CT1d   171
      ENDIF                                                                     CT1d   172
c                                                                               CT1d   173
c              Set up the pan heater if required                                CT1d   174
      IF (<tw:PAN-HTR-TYPE> .NE. NoPanHtr)  THEN                                CT1d   175
        IF (<tw:PAN-LOSS> .EQ. 0.)  THEN                                        CT1d   176
            <tw:PAN-LOSS> = -<tw:CAPACITY> * <tw:PAN-LOSS-RATI>                 CT1d   177
        ELSE                                                                    CT1d   178
            <tw:PAN-LOSS> = -<tw:PAN-LOSS>                                      CT1d   179
        ENDIF                                                                   CT1d   180
c              effective loss coefficient                                       CT1d   181
        Tair = <tw:PAN-AMBIENT>                                                 CT1d   182
        Tpan = <tw:PAN-FLUID-T>                                                 CT1d   183
        dT   = Tair - Tpan                                                      CT1d   184
        IF (dT .GE. 0.)  THEN                                                   CT1d   185
          CALL MSGSIM(-1,II,II,II,II)                                           CT1d   186
          WRITE (IOUTPT, 9104)  (<tw:NAME>,II=1,8), Tair, Tpan                  CT1d   187
          call MessageBox( NULL, 'TOWER pan loss error -'                       CT1d   188
     &      //' ABORTING'//char(0),'OTWRD Errors'//char(0), MB_OK               CT1d   189
     &      + MB_ICONSTOP + MB_TASKMODAL )                                      CT1d   190
          RETURN                                                                CT1d   192
        ENDIF                                                                   CT1d   193
        <tw;PAN_UA> = <tw:PAN-LOSS>                                             CT1d   194
     &              / (dT * SurfaceFilmAdj(Tpan, Tair, <tw:PAN-WIND>))          CT1d   195
c              design flow                                                      CT1d   196
                                                                                -034    15
        IF (<tw:PAN-HTR-TYPE> .EQ. HWPanHtr)                                    -034    16
     &    <tw;PAN_DES_GPM> = -<tw:PAN-LOSS>                                     -034    17
     &                               / (<lp;BTUH/GPM-F>*<tw:PAN-HTR-DT>)        -034    18
      ENDIF                                                                     CT1d   199
c                                                                               CT1d   200
c              total primary loop equipment capacity                            CT1d   201
      <lp;PRIMARY_CCAP> = <lp;PRIMARY_CCAP> + <tw:CAPACITY>                     CT1d   202
c              save design variables for use in PrimaryEquip                    CT1d   203
      Jpe = <tw;Jpe>                                                            CT1d   204
      <pe;Jpm>        = <tw:CW-PUMP>                                            CT1d   205
      <pe;DES_GPM>    = CWgpm                                                   -031     2
      <pe;MAX_GPM>    = <tw:CELL-MAX-GPM>*<tw:NUM-CELLS>                        CT1d   207
      <pe;DES_HEAD>   = <tw:CW-HEAD>                                            CT1d   208
      <pe;DES_STATIC> = <tw:CW-STATIC>                                          CT1d   209
      <pe:ISOLATION>  = 1                                                       CT1d   210
      IF (<pe;MAX_GPM> .LT. <lp:RECIRC-GPM>  .OR.                               -035    22
     &    <pe;MAX_GPM> .LT. <lp:MIN-GPM>)    THEN                               -035    23
        CALL MSGSIM(-3,II,II,II,II)                                             -035    24
        WRITE (IOUTPT, 9001)  (<tw:NAME>,II=1,8)                                -035    25
      ENDIF                                                                     -035    26
c                                                                               CT1d   211
c              dump tower design variables if needed                            CT1d   212
      IF (IREPRT(3,34) .GT. 0)                                                  CT1d   213
     &  WRITE(IOUTPT,9000) (<tw:NAME>,II=1,8),<tw:CAPACITY>,                    CT1d   214
     &  <tw:NUM-CELLS>,RANGE, GPMra, <tw:CELL-MAX-GPM>,                         CT1d   215
     &  <tw:CELL-MIN-GPM>,<tw;GPM/CELL_CTI>,<tw:FAN-KW/CELL>,                   CT1d   216
     &  TWRgpm, <hx:UA>                                                         CT1d   217
c                                                                               CT1d   218
      RETURN                                                                    CT1d   219
c                                                                               CT1d   220
c              dump formats                                                     CT1d   221
 9000 FORMAT(' ',8A4,                                                           CT1d   222
     &      /    17X,'     SIZE   NumCells     RANGE    GPMra    GPMMAX'        CT1d   223
     &      /    17X,     F10.1,    F10.1,    F10.1,    F10.1,    F10.1         CT1d   224
     &      /    17X,'   GPMMIN    GPMCTI    EFCELL    DESGPM      HXUA'        CT1d   225
     &      /    17X,     F10.1,    F10.1,    F10.1,    F10.1,    F10.1)        CT1d   226
c              message formats                                                  CT1d   227
 9001 FORMAT(14X,8A4,' has a maximum flow smaller'                     /        -035    27
     &       14X,'than the loops minimum flow, and will never be used' /        -035    28
     &       14X,'by itself.'                                          )        -035    29
 9100 FORMAT(14X,'Tower: ',8A4,' on loop ',8A4                         /        CT1d   228
     &       14X,'is not needed.  No simulation will be performed.    ')        CT1d   229
 9101 FORMAT(14X,'The attached condenser pump on tower: ',8A4          /        CT1d   230
     &       14X,'cannot pump the condenser loop because of the heat'  /        CT1d   231
     &       14X,'exchanger, but neither loop: ',8A4,' nor'            /        CT1d   232
     &       14X,'the attached chiller condensers have pumps.'         /        CT1d   233
     &       14X,'You must defined a pump for the loop.'               )        CT1d   234
 9102 FORMAT(14X,'Tower: ',8A4,' must have a 2-speed or'               /        CT1d   235
     &       14X,'variable-speed fan for the condenser loop LOAD-RESET'/        CT1d   236
     &       14X,'temperature control strategy to work.  The control'  /        CT1d   237
     &       14X,'strategy has been changed to FIXED.'                 )        CT1d   238
 9103 FORMAT(14X,'Open-Twr&HX: ',8A4,' must have a',F5.1,'F'           /        CT1d   239
     &       14X,'leaving temperature (upstream of the heat exchanger)'/        CT1d   240
     &       14X,'to meet the',F5.1,'F loop setpoint, but the leaving' /        CT1d   241
     &       14X,'temperature based on the',F5.1,'F design wetbulb '   /        CT1d   242
     &       14X,'and',F5.1,'F design approach will be',F5.1'F'        /        CT1d   243
     &       14X,'The loop may overload during high wetbulb conditions')        CT1d   244
 9104 FORMAT(14X,'Tower: ',8A4,' is specified to have'                 /        CT1d   245
     &       14X,'pan losses, but the design outdoor temperature is '  /        CT1d   246
     &       14X,'higher than the design pan temperature.'             /        CT1d   247
     &       14X,'Outdoor T: ',F5.1,' Pan setpoint: ',F5.1             )        CT1d   248
 9107 FORMAT(14X,'Plant equipment: ',8A4,' has a different'            /        CT1d   249
     &       14X,'pressure drop on loop: ',8A4,' than the'             /        CT1d   250
     &       14X,'other equipment.  This is unusual unless the loop'   /        CT1d   251
     &       14X,'uses flow meters or other dynamic flow control'      /        CT1d   252
     &       14X,'devices to allocate the flow on an hourly basis to'  /        CT1d   253
     &       14X,'the active equipment.'                               )        CT1d   254
c                                                                               CT1d   255
      END                                                                       CT1d   256
      SUBROUTINE CreateJpe(Jparent, Algorithm)                                  JPE      2
c                                                                               JPE      3
c              Creates a common block for each primary equipment                JPE      4
c              component (Jpe).  This block allows different components         JPE      5
c              with different data structures to be handled in a                JPE      6
c              common format by various routines                                JPE      7
c                                                                               JPE      8
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /ZEROP/  LpmHR,LlpHR,LchHR,LblHR,LdwHR,LtwHR,LpvHR,LgnHR,         PV       5
     &                 LtkHR,LhxHR,LecHR,LlmHR,LemHR,LfmHR,LsmHR,LcmHR,         /ZEROP/  3
     &                 LglHR,LpeHR,                                             /ZEROP/  4
     &                 LpmMO,LlpMO,LchMO,LblMO,LdwMO,LtwMO,LpvMO,LgnMO,         PV       6
     &                 LtkMO,LhxMO,LecMO,LlmMO,LemMO,LfmMO,LsmMO,LcmMO,         /ZEROP/  6
     &                 LglMO,LpeMO,                                             /ZEROP/  7
     &                 LpmYR,LlpYR,LchYR,LblYR,LdwYR,LtwYR,LpvYR,LgnYR,         PV       7
     &                 LtkYR,LhxYR,LecYR,LlmYR,LemYR,LfmYR,LsmYR,LcmYR,         /ZEROP/  9
     &                 LglYR,LpeYR                                              /ZEROP/ 10
c                                                                               JPE     13
      Integer Algorithm                                                         JPE     14
c                                                                               JPE     15
c              total number of Jpe blocks                                       JPE     16
      Npe = Npe + 1                                                             JPE     17
c              pointer to Jpe block                                             JPE     18
      Jpe = NewBlockPtr(Lpe)                                                    JPE     19
c              save the pointer to the parent component and simulation          JPE     20
c              algorithm                                                        JPE     21
      <pe;Jparent> = Jparent                                                    JPE     22
      <pe:ALGORITHM> = Algorithm                                                JPE     23
c                                                                               JPE     24
c              set up the lengths for monthly and yearly zero                   JPE     25
      IF (Npe .EQ. 1)  THEN                                                     JPE     26
        Ipe   = Jpe                                                             JPE     27
        LpeMO = IndexPosition(<=MOBJpe>, <=MOEJpe>, 2)                          JPE     28
        LpeYR = IndexPosition(<=YRBJpe>, <=YREJpe>, 2)                          JPE     29
      ENDIF                                                                     JPE     30
c                                                                               JPE     31
      RETURN                                                                    JPE     32
      END                                                                       JPE     33
      INTEGER FUNCTION NewBlockPtr(Length)                                      NewBlk   2
c                                                                               NewBlk   3
c              Allocates space in AA for another block of data                  NewBlk   4
c                                                                               NewBlk   5
c              Length     Length of new block                                   NewBlk   6
c                                                                               NewBlk   7
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /IAX   / IAX, IADIM, IADIMV, IAXMAX, KORE, IAXlds, IAXsys         HR       8
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               NewBlk  12
      IF (IAX+Length .LE. IADIM)  THEN                                          NewBlk  13
        Istart = IAX + 1                                                        NewBlk  14
        Iend   = IAX + Length                                                   NewBlk  15
        DO  I=Istart,Iend                                                       NewBlk  16
          IA(I) = 0                                                             NewBlk  17
        ENDDO                                                                   NewBlk  18
        IAX = Iend                                                              NewBlk  19
      ELSE                                                                      NewBlk  20
        CALL MSGSIM(-1,II,II,II,II)                                             NewBlk  21
        WRITE (IOUTPT,9100)  IADIM                                              NewBlk  22
      ENDIF                                                                     NewBlk  23
c                                                                               NewBlk  24
      NewBlockPtr = Istart                                                      NewBlk  25
c                                                                               NewBlk  26
      RETURN                                                                    NewBlk  27
c                                                                               NewBlk  28
 9100 FORMAT(14X,'Program has exceeded the allocated storage capacity' /        NewBlk  29
     &       14X,'of ',I7,' words for the interface variables.  You'   /        NewBlk  30
     &       14X,'will have to use a larger version of the program to' /        NewBlk  31
     &       14X,'accommodate your input.'                             )        NewBlk  32
c                                                                               NewBlk  33
      END                                                                       NewBlk  34
      BLOCK DATA DATPLT                                                         DATPLT   2
c                                                                               DATPLT   3
c              Plant block data                                                 DATPLT   4
c                                                                               DATPLT   5
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
c                                                                               DATPLT   7
      COMMON  /BLRKY / HWBLR                                                    /BLRKY/  2
      INTEGER          HWBLR                                                    /BLRKY/  3
      COMMON  /CHLRKY/ ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 2
     &                 WaterCool, AirCool                                       /CHLRKY/ 3
      INTEGER          ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 4
     &                 WaterCool, AirCool                                       /CHLRKY/ 5
      COMMON  /DHWKY / DHWgas, DHWelec, DHWhtpump                               /DHWKY/  2
      INTEGER          DHWgas, DHWelec, DHWhtpump                               /DHWKY/  3
      COMMON  /EMKY  / UtilityMeter, BldgMeter, SubMeter, SellMeter,            /EMKY/   2
     &                 NumElecMeterTypes(4)                                     /EMKY/   3
      INTEGER          UtilityMeter, BldgMeter, SubMeter, SellMeter             /EMKY/   4
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /GENKY / DontRun, TrackElec, TrackThermal, TrackLesser,           /GENKY/  2
     &                 TrackGreater, MaxOutput                                  /GENKY/  3
      INTEGER          DontRun, TrackElec, TrackThermal, TrackLesser,           /GENKY/  4
     &                 TrackGreater, MaxOutput                                  /GENKY/  5
      COMMON /GLHXKY/  ScheduleOrWthFile, VertWell, HorizStraight,              /GLHXKY/ 2
     &                 HorizSlinky                                              /GLHXKY/ 3
      INTEGER          ScheduleOrWthFile, VertWell, HorizStraight,              /GLHXKY/ 4
     &                 HorizSlinky                                              /GLHXKY/ 5
      COMMON  /HXKY  / Counterflow, Parallelflow, CrossflowNoMix,               /HXKY/   2
     &                 CrossflowBothMix, CrossflowDemMix,                       /HXKY/   3
     &                 CrossflowSupMix                                          /HXKY/   4
      INTEGER          Counterflow, Parallelflow, CrossflowNoMix,               /HXKY/   5
     &                 CrossflowBothMix, CrossflowDemMix,                       /HXKY/   6
     &                 CrossflowSupMix                                          /HXKY/   7
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /LDMGKY/ ScheduledEC, OATemp, PeakShaving                         /LDMGKY/ 2
      INTEGER          ScheduledEC, OATemp, PeakShaving                         /LDMGKY/ 3
      COMMON  /MTRKY / STANDARD, HIEFF, PREMIUM                                 /MTRKY/  2
      INTEGER          STANDARD, HIEFF, PREMIUM                                 /MTRKY/  3
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
      COMMON  /SimAlg/ Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/ 2
     &                 Electrical,                                              /SIMALG/ 3
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/ 4
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/ 5
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   2
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/ 7
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/ 8
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/ 9
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/10
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    3
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    4
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    5
     &                 Ground_LoopVert_H2,Ground_LoopHoriz_H,                   -044d    6
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/14
      INTEGER          Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/15
     &                 Electrical,                                              /SIMALG/16
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/17
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/18
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   3
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/20
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/21
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/22
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/23
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    7
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    8
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    9
     &                 Ground_LoopVert_H2, Ground_LoopHoriz_H,                  -044d   10
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/27
      COMMON  /TESKY / ColdTank, HotTank                                        /TESKY/  2
      INTEGER          ColdTank, HotTank                                        /TESKY/  3
      COMMON  /TWRKY / Open, OpenHX, FluidCool,                                 /TWRKY/  2
     &                 Bypass, Speed1, Speed2, SpeedV, Damper,                  /TWRKY/  3
     &                 RunMinCells, RunMaxCells,                                /TWRKY/  4
     &                 ElecPanHtr, NoPanHtr, HWPanHtr,                          /TWRKY/  5
     &                 CycleWithFan, StayOn                                     /TWRKY/  6
      INTEGER          Open, OpenHX, FluidCool,                                 /TWRKY/  7
     &                 Bypass, Speed1, Speed2, SpeedV, Damper,                  /TWRKY/  8
     &                 RunMinCells, RunMaxCells,                                /TWRKY/  9
     &                 ElecPanHtr, NoPanHtr, HWPanHtr,                          /TWRKY/ 10
     &                 CycleWithFan, StayOn                                     /TWRKY/ 11
c                                                                               DATPLT  23
c                                                                               DATPLT  24
c              set values for various symbols                                   DATPLT  25
c              /blrky/                                                          DATPLT  26
      DATA  HWBLR                                       /1/                     DATPLT  27
c              /chlrky/                                                         DATPLT  28
      DATA  ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE       /1,2,3,4,5/             DATPLT  29
      DATA  WaterCool, AirCool                          /1,2/                   DATPLT  30
c              /dhwky/                                                          DATPLT  31
      DATA  DHWgas, DHWelec, DHWhtpump                  /1,2,3/                 DATPLT  32
c              /emky/                                                           DATPLT  33
      DATA  UtilityMeter,BldgMeter,SubMeter,SellMeter                           DATPLT  34
     &                                                  /1,2,3,4/               DATPLT  35
      DATA  NumElecMeterTypes                           /4*0/                   DATPLT  36
c              /eqky/                                                           DATPLT  37
      DATA  Always, WhenOn, WhenOff, AuxSched           /1,2,3,4/               DATPLT  38
      DATA  ConstantFlow, VariableFlow                  /1,2/                   DATPLT  39
      DATA  Yes, No                                     /1,0/                   DATPLT  40
c              /genky/                                                          DATPLT  41
      DATA  DontRun, TrackElec, TrackThermal,                                   DATPLT  42
     &      TrackLesser, TrackGreater, MaxOutput        /0,1,2,3,4,5/           DATPLT  43
c              /glhxky/                                                         DATPLT  44
      DATA  ScheduleOrWthFile, VertWell, HorizStraight,                         DATPLT  45
     &      HorizSlinky                                 /1,2,3,4/               DATPLT  46
c              /hxky/                                                           DATPLT  47
      DATA  Counterflow, Parallelflow, CrossflowNoMix,                          DATPLT  48
     &      CrossflowBothMix, CrossflowDemMix,                                  DATPLT  49
     &      CrossflowSupMix                             /1,2,3,4,5,6/           DATPLT  50
c              /ldmgky/                                                         DATPLT  51
      DATA  ScheduledEC, OATemp, PeakShaving            /1,2,3/                 DATPLT  52
c              /loopky/                                                         DATPLT  53
      DATA  CHW, PIPE2, loop3, HW, loop5, STM           /1,2,3,4,5,6/           DATPLT  54
      DATA  WLHP, DHW, CW                               /7,8,9/                 DATPLT  55
      DATA  Deleted, PIPE2h, WLHPh, COGEN, NoType       /0,17,18,19,20/         DATPLT  56
      DATA  FIXED, OA, SCH, LOAD                        /1,2,3,4/               DATPLT  57
      DATA  ZONE, OUTDOOR                               /1,2/                   -041k    2
      DATA  STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand /1,2,3,4,5/         GLHX1    3
      DATA  CONSTANT, VARIABLE                          /1,2/                   DATPLT  60
      DATA  ModeText                                    /4H Off,4HFlot,         DATPLT  61
     &                                                   4HHeat,4HCool/         DATPLT  62
      DATA  OFFMODE, FLOATING, HEATMODE, COOLMODE       /-1,0,1,2/              DATPLT  63
      DATA  AtCoils, EnterLoop, AtPump                  /1,2,3/                 DATPLT  64
      DATA  INDOORS, OUTDOORS, TUNNEL, UNDERGROUND      /1,2,3,4/               DATPLT  65
      DATA  PRIMARY, SECONDARY                          /1,2/                   DATPLT  66
      DATA  DIRECT, HX                                  /1,2/                   DATPLT  67
      DATA  WATER,ETHYLENE,PROPYLENE,BRINE              /1,2,3,4/               DATPLT  68
c              /mtrky/                                                          DATPLT  69
      DATA  STANDARD, HIEFF, PREMIUM                    /1,2,3/                 DATPLT  70
c              /pumpky/                                                         DATPLT  71
      DATA  OneSpeed, TwoSpeed, VarSpeed                /1,2,3/                 DATPLT  72
      DATA  PrimaryPump, SecondaryPump, EquipmentPump   /1,2,3/                 DATPLT  73
c              /SimAlg/                                                         DATPLT  74
      DATA  Cooling, Heating, DHWHeating,                                       DATPLT  75
     &      HeatRejection, Electrical                   /1,2,3,4,5/             DATPLT  76
      DATA  Chiller_Elec1,Chiller_Elec2,Chiller_Absor1  /101,102,103/           DATPLT  77
      DATA  Chiller_Gas1,Chiller_Engine1                /104,105/               DATPLT  78
      DATA  Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1 /106,107,108/         FreeCl  29
      DATA  TES_ColdTank1                               /181/                   DATPLT  79
      DATA  Boiler_HW1,Boiler_HW2                       /201,202/               DATPLT  81
      DATA  TES_HotTank1                                /281/                   DATPLT  82
      DATA  Ground_LoopSch_H,  Ground_LoopVert_H,                               -044d   12
     $      Ground_LoopVert_H2,Ground_LoopHoriz_H /291,292,294,293/             -044d   13
      DATA  DW_Heater1,DW_Heater2                       /301,302/               DATPLT  85
      DATA  CoolingTwr1,FluidCooler1,DryCooler1         /401,402,403/           DATPLT  86
      DATA  Ground_LoopSch,  Ground_LoopVert,                                   -044d   14
     $      Ground_LoopVert2,Ground_LoopHoriz     /491,492,494,493/             -044d   15
      DATA  DieselGen_1,GasTurbineGen_1,StmTurbineGen_1 /501,502,503/           DATPLT  89
c              /tesky/                                                          DATPLT  90
      DATA  ColdTank, HotTank                           /1,2/                   DATPLT  91
c              /twrky/                                                          DATPLT  92
      DATA  Open, OpenHX, FluidCool                     /1,2,3/                 DATPLT  93
      DATA  Bypass, Speed1, Speed2, SpeedV, Damper      /1,2,3,4,5/             DATPLT  94
      DATA  RunMinCells, RunMaxCells                    /0,1/                   DATPLT  95
      DATA  ElecPanHtr, NoPanHtr, HWPanHtr              /1, 0, -1/              DATPLT  96
      DATA  CycleWithFan, StayOn                        /0,1/                   DATPLT  97
c                                                                               DATPLT  98
      END                                                                       DATPLT  99
      SUBROUTINE DryCooler_1                                                    DCLR1    2
c                                                                               DCLR1    3
c              Simulates a dry cooler.                                          DCLR1    4
c                                                                               DCLR1    5
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /LOOP  / Nloop(16,2), NextType(40), NLP2,                         -41a     1
     &                 WLHPoff, RealCall, RegenFlag, Sim2x, LoopSimCount        ChlrHP   2
      LOGICAL          WLHPoff, RealCall, RegenFlag, Sim2x                      ChlrHP   3
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /REPORT/ IREPRT(4,37),IPRG,IUNIQV(100),IUNIQS(100),IUNIQL         /REPORT/ 2
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /TWRDAT/ TWRload,TCAP,TWRrej,CWgpm,TWRgpm,TWRsupply,              /TWRDAT/ 2
     &                 TWRset,Ttower,RANGE,APP,twr1FRA,GPMra,GPMcap,            /TWRDAT/ 3
     &                 GPMcell,NumCells,MinCells,MaxCells,Ttop,GPMtop,          /TWRDAT/ 4
     &                 Tbot,GPMbot,CFMra,FankWr,FankW,TWRaux,QpanLoss,          -034     2
     &                 QcoilLoss, SpraykW, Twet1, Tstart                        /TWRDAT/ 6
      DIMENSION        TWRSAV(25)                                               /TWRDAT/ 7
      EQUIVALENCE     (TWRSAV(1),TWRload)                                       /TWRDAT/ 8
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               DCLR1   22
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
      COMMON  /TWRKY / Open, OpenHX, FluidCool,                                 /TWRKY/  2
     &                 Bypass, Speed1, Speed2, SpeedV, Damper,                  /TWRKY/  3
     &                 RunMinCells, RunMaxCells,                                /TWRKY/  4
     &                 ElecPanHtr, NoPanHtr, HWPanHtr,                          /TWRKY/  5
     &                 CycleWithFan, StayOn                                     /TWRKY/  6
      INTEGER          Open, OpenHX, FluidCool,                                 /TWRKY/  7
     &                 Bypass, Speed1, Speed2, SpeedV, Damper,                  /TWRKY/  8
     &                 RunMinCells, RunMaxCells,                                /TWRKY/  9
     &                 ElecPanHtr, NoPanHtr, HWPanHtr,                          /TWRKY/ 10
     &                 CycleWithFan, StayOn                                     /TWRKY/ 11
c                                                                               DCLR1   27
c              limits for performance curves                                    DCLR1   28
      DIMENSION TWRLIM(2)                                                       DCLR1   29
      DATA TWRLIM /120.,  0./                                                   DCLR1   30
c              curve for dynamic PLR curve 'constants'                          DCLR1   31
      DIMENSION CURVE(6)                                                        DCLR1   32
      DATA CURVE /6*0.0/                                                        DCLR1   33
c                                                                               DCLR1   34
c              zero hourly tower data                                           DCLR1   35
      CALL FILLN(0., TWRSAV(1), IVTLIM(2,19))                                   DCLR1   36
c                                                                               DCLR1   37
c ****         run function : DryCooler_1-1                                     DCLR1   38
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        DCLR1   39
c                                                                               DCLR1   40
c                                                                               DCLR1   41
c============= ROUTINE CALLED TO GET OPERATING CAPACITY ======================= DCLR1   42
c              Unlike other equipment, capacity is in gpm, not energy           DCLR1   43
      IF (SimCtrl .EQ. 11)  THEN                                                DCLR1   44
c              leaving temperature setpoint                                     DCLR1   45
        TWRset = <lp;COOL_SETPT>                                                DCLR1   46
c              temperature drop thru cooler                                     DCLR1   47
        RANGE  = MAX(1., QloopNet / (GPMs * <lp;BTUH/GPM-F>))                   DCLR1   48
        IF (TWRset .LE. DBT)  THEN                                              DCLR1   49
c              setpoint cannot be achieved with dry coil                        DCLR1   50
          TWRgpm = 0.                                                           DCLR1   51
        ELSE                                                                    DCLR1   52
          DemTi   = TWRset + RANGE                                              DCLR1   53
c              mode 3 call to hx will return the maximum GPMcell that           DCLR1   54
c              can be cooled at these conditions                                DCLR1   55
          IF (QloopNet .GT. 0.)  THEN                                           HVAC29  16
            CALL HeatExchanger(<tw:DRY-HX>,3,MaxFlag, xxx,                      HVAC29  17
     &                                  <tw;MAX_DRY_CFM>,  DBT,   xxx ,         HVAC29  18
     &                                           GPMcell,DemTi,TWRset )         HVAC29  19
          ELSE                                                                  HVAC29  20
c              no load                                                          HVAC29  21
            GPMcell = <tw:CELL-MAX-GPM>                                         HVAC29  22
          ENDIF                                                                 HVAC29  23
c              do not let tower handle more than the maximum                    DCLR1   59
          GPMcell = MIN(GPMcell, <tw:CELL-MAX-GPM>)                             DCLR1   60
          TWRgpm  = GPMcell * <tw:NUM-CELLS>                                    DCLR1   61
        ENDIF                                                                   DCLR1   62
c                                                                               DCLR1   63
c ****         run function : DryCooler_1-2                                     DCLR1   64
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        DCLR1   65
c                                                                               DCLR1   66
        <pe;OPER_CAPACITY> = TWRgpm                                             DCLR1   67
        <pe;MAX_CAPACITY>  = TWRgpm                                             DCLR1   68
c                                                                               DCLR1   69
        RETURN                                                                  DCLR1   70
      ENDIF                                                                     DCLR1   71
c                                                                               DCLR1   72
c                                                                               DCLR1   73
c============= ROUTINE CALLED TO SIMULATE EQUIPMENT =========================== DCLR1   74
c              total equipment pump kW                                          DCLR1   75
      AuxPumpKW  = 0.                                                           DCLR1   76
c              condenser loop flow thru this cooler                             DCLR1   77
      CWgpm = <pe;GPM>                                                          DCLR1   78
c                                                                               DCLR1   79
c ****         run function : DryCooler_1-3                                     DCLR1   80
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        DCLR1   81
c                                                                               DCLR1   82
c              Auxiliary power                                                  DCLR1   83
      IF (<tw:AUX-KW> .GT. 0.  .AND.  RealCall)  THEN                           DCLR1   84
c              if always on                                                     DCLR1   85
        IF (<tw:AUX-MODE> .EQ. Always  .OR.                                     DCLR1   86
c              if on when equipment on                                          DCLR1   87
     1      (<tw:AUX-MODE> .EQ. WhenOn  .AND. CWgpm .GT. 0.)  .OR.              DCLR1   88
c              if off when equipment on                                         DCLR1   89
     2      (<tw:AUX-MODE> .EQ. WhenOff .AND. CWgpm .EQ. 0.) )  THEN            DCLR1   90
          TWRaux = <tw:AUX-KW>                                                  DCLR1   91
        ELSE                                                                    Time    24
          TWRaux = <tw:AUX-KW> * SchVal(<tw:AUX-SCH>, 1.)                       Time    25
        ENDIF                                                                   DCLR1   94
      ENDIF                                                                     DCLR1   95
c              skip if no load                                                  DCLR1   96
      IF (CWgpm .LT. 1.  .OR.  <pe;LOAD> .LT. 0.00001)  THEN                    HVAC29  24
        TWRload   = 0.                                                          DCLR1   98
        <pe;LOAD> = 0.                                                          DCLR1   99
        GOTO 1000                                                               DCLR1  100
      ELSE                                                                      DCLR1  101
        TWRload = <pe;LOAD>                                                     DCLR1  102
      ENDIF                                                                     DCLR1  103
c                                                                               DCLR1  104
      NumCellsAvail = INT(<tw:NUM-CELLS>)                                       DCLR1  105
c                                                                               DCLR1  106
c              minimum and maximum number of cells                              DCLR1  107
c              that can operate with the loop GPM                               DCLR1  108
      MinCells = MAX(1, MIN(INT(CWgpm/<tw:CELL-MAX-GPM> + .999999),             DCLR1  109
     &                                                  NumCellsAvail) )        DCLR1  110
      MaxCells = MAX(1, MIN(INT(CWgpm/<tw:CELL-MIN-GPM> + .999999),             DCLR1  111
     &                                                  NumCellsAvail) )        DCLR1  112
c                                                                               DCLR1  113
c              flow thru the cooler                                             DCLR1  114
      IF (<tw:CW-PUMP> .GT. 0)  THEN                                            DCLR1  115
        Jpm = <tw:CW-PUMP>                                                      DCLR1  116
        IF (<pm;TYPE> .EQ. EquipmentPump)  THEN                                 DCLR1  117
c              pump recirculates thru the tower only                            DCLR1  118
          IF (<pm;EQUIP_CTRL> .EQ. ConstantFlow)  THEN                          DCLR1  119
c              constant flow                                                    DCLR1  120
            TWRgpm = <pm;EQUIP_GPM>                                             DCLR1  121
          ELSE                                                                  DCLR1  122
c              not constant flow, flow is loop flow                             DCLR1  123
            TWRgpm = MAX(CWgpm, <tw:CW-MIN-GPM>)                                DCLR1  124
          ENDIF                                                                 DCLR1  125
        ELSE                                                                    DCLR1  126
c              pump powers the loop, flow is loop flow                          DCLR1  127
          TWRgpm = CWgpm                                                        DCLR1  128
        ENDIF                                                                   DCLR1  129
      ELSE                                                                      DCLR1  130
c              no recirculation pump, flow is loop flow                         DCLR1  131
        TWRgpm = CWgpm                                                          DCLR1  132
      ENDIF                                                                     DCLR1  133
c                                                                               DCLR1  134
c              initialize cooler heat rejected to be the loop load              DCLR1  135
      TWRrej = TWRload                                                          DCLR1  136
c              Simulate pump attached directly to tower.  This pump may         DCLR1  137
c              be either a recirculation (equipment pump), or may also          DCLR1  138
c              power the condenser loop.  Note that the pump is assumed         DCLR1  139
c              to run the entire hour.  In the future this should be            DCLR1  140
c              modified to allow cycling.                                       DCLR1  141
      IF (<tw:CW-PUMP> .GT. 0)  THEN                                            DCLR1  142
        PMPfrac = 1.0                                                           DCLR1  143
c              do the pump simulation                                           DCLR1  144
        Jpm = <tw:CW-PUMP>                                                      DCLR1  145
        CALL PumpSupply                                                         DCLR1  146
c              add pump heat to load                                            DCLR1  147
        TWRrej = TWRrej + PMPQ                                                  DCLR1  148
        IF (<lp:PUMP> .NE. 0)  AuxPumpKW = PMPkW                                DCLR1  149
      ELSE                                                                      DCLR1  150
        PMPQ  = 0.                                                              DCLR1  151
        PMPdT = 0.                                                              DCLR1  152
      ENDIF                                                                     DCLR1  153
c                                                                               DCLR1  154
c              required leaving supply temperature                              DCLR1  155
      TWRset = <lp;COOL_SETPT>                                                  DCLR1  156
c              Adjust tower setpoint for pump heat (pump is assumed to be       DCLR1  157
c              on leaving side of cooler)                                       DCLR1  158
      TWRset = TWRset - PMPdT                                                   DCLR1  159
c              beginning of hour loop temperature                               DCLR1  160
      Tstart = <lp;SUPPLY_T>                                                    DCLR1  161
c              estimate of cooler range (temp in minus temp out)                DCLR1  162
      RANGE  = MAX(0.001, TWRrej / (TWRgpm*<lp;BTUH/GPM-F>))                    Sync     5
c              maximum airflow/cell thru the cooler                             DCLR1  164
      CFMmax = <tw;MAX_DRY_CFM>                                                 DCLR1  165
c              pointer to heat exchanger                                        DCLR1  166
      Jhx    = <tw:DRY-HX>                                                      DCLR1  167
c                                                                               DCLR1  168
c              skip if tower fan speed is controlled directly on load           DCLR1  169
      IF (<lp:CL-SETPT-CTRL> .EQ. LOAD)  GOTO 300                               DCLR1  170
c                                                                               DCLR1  171
c============= TEMPERATURE SETPOINT CALCULATIONS ============================== DCLR1  172
c              Adjust actual setpoint for the controller's throttling range.    DCLR1  173
c              To do this, capacity must be known at top of throttling range.   DCLR1  174
c              See working capacity section below for explanation               DCLR1  175
c              of calculations.                                                 DCLR1  176
  150 THRTL  = <lp:SETPT-RNG>                                                   DCLR1  177
c              temperatures at top and bottom of range                          DCLR1  178
      Ttop   = TWRset + THRTL * .5                                              DCLR1  179
      Tbot   = Ttop - THRTL                                                     DCLR1  180
c              Skip to floating calculations if Ttop is close to drybulb        DCLR1  181
      IF (Ttop .LE. (DBT+.1))  GOTO 200                                         DCLR1  182
c              capacity at top of throttling range                              DCLR1  183
      DemTi  = Ttop + RANGE                                                     DCLR1  184
c              mode 3 call returns CAPtop and GPMtop                            DCLR1  185
      CALL HeatExchanger(Jhx,3,MaxFlag, CAPtop, CFMmax,  DBT, xxx,              DCLR1  186
     &                                          GPMtop,DemTi,Ttop )             DCLR1  187
      CAPtop = CAPtop * FLOAT(MaxCells)                                         DCLR1  188
      GPMtop = GPMtop * FLOAT(MaxCells)                                         DCLR1  189
c              Skip to floating calcs if GPMtop insufficient for load           DCLR1  190
      IF (GPMtop .LT. TWRgpm)  GOTO 200                                         DCLR1  191
c              Repeat for approach and cooler capacity at bottom of             DCLR1  192
c              throttling range. Capacity is zero if Tbot is less than          DCLR1  193
c              drybulb, and the effective throttling range is reduced.          DCLR1  194
      IF (Tbot .LE. DBT)  THEN                                                  DCLR1  195
        GPMbot = 0.                                                             DCLR1  196
        Tbot   = DBT                                                            DCLR1  197
        THRTL  = Ttop - Tbot                                                    DCLR1  198
      ELSE                                                                      DCLR1  199
        DemTi  = Tbot + RANGE                                                   DCLR1  200
c              mode 3 call returns CAPbot and GPMbot                            DCLR1  201
        CALL HeatExchanger(Jhx,3,MaxFlag, CAPbot, CFMmax,  DBT, xxx,            DCLR1  202
     &                                            GPMbot,DemTi,Tbot )           DCLR1  203
        CAPbot = CAPbot * FLOAT(MaxCells)                                       DCLR1  204
        GPMbot = GPMbot * FLOAT(MaxCells)                                       DCLR1  205
      ENDIF                                                                     DCLR1  206
c              Now determine the tower temperature based on throttling range,   DCLR1  207
c              and capacity variation over throttling range                     DCLR1  208
      DCAP     = CAPtop - CAPbot                                                DCLR1  209
      Cp       = <lp;BTU/F>                                                     DCLR1  210
      CURVE(3) = DCAP                                                           DCLR1  211
      CURVE(2) = Cp*THRTL*THRTL + CAPbot*THRTL - 2.0*Tbot*DCAP                  DCLR1  212
      CURVE(1) = -(TWRrej + Tstart*Cp)*THRTL*THRTL                              DCLR1  213
     &                  -CAPbot*Tbot*THRTL + DCAP*Tbot*Tbot                     DCLR1  214
      CALL CURINV(CURVE(1), 3, 1, Ttower, Ttower, 0.0, TWRLIM(1), IERR)         DCLR1  215
c              Skip rest if only an estimation call                             DCLR1  216
      Ttower = Ttower + PMPdT                                                   DCLR1  217
      IF (.NOT. RealCall)  THEN                                                 DCLR1  218
        TWRsupply = Ttower                                                      DCLR1  219
        GOTO 401                                                                DCLR1  220
      ENDIF                                                                     DCLR1  221
c                                                                               DCLR1  222
c============= CONTROL TO HOLD SETPOINT ======================================= DCLR1  223
c              Adjust TWRrej and RANGE for loop temperature change              DCLR1  224
c              from last hour.                                                  DCLR1  225
  160 TWRrej = TWRload + PMPQ                                                   -034    19
      RANGE  = TWRrej / (TWRgpm * <lp;BTUH/GPM-F>)                              DCLR1  227
c              temperature entering the cooler hx                               DCLR1  228
      DemTi  = Ttower + RANGE                                                   DCLR1  229
c              Compute the GPM capacity/cell at current load and drybulb        DCLR1  230
c              mode 3 call returns GPMcap per cell                              DCLR1  231
      CALL HeatExchanger(Jhx,3,MaxFlag, xxx, CFMmax,  DBT,   xxx,               DCLR1  232
     &                                       GPMcap,DemTi,Ttower )              DCLR1  233
c              Jump to floating calcs if cooler has insufficient capacity       DCLR1  234
c              to meet setpoint                                                 DCLR1  235
      IF (GPMcap*FLOAT(MaxCells) .LT. TWRgpm)  GO TO 200                        DCLR1  236
c              Setpoint can be met.  Determine how many cells are required.     DCLR1  237
      NumCells = INT(TWRgpm/GPMcap +.99999)                                     DCLR1  238
c              use maximum number of cells if user specified.                   DCLR1  239
      IF (<tw:CELL-CTRL> .EQ. RunMaxCells)  THEN                                DCLR1  240
        NumCells = MAX(NumCells, MaxCells)                                      DCLR1  241
      ELSE                                                                      DCLR1  242
c              otherwise, use minimum number of cells                           DCLR1  243
        NumCells = MAX(NumCells, MinCells)                                      DCLR1  244
      ENDIF                                                                     DCLR1  245
      CellNum = FLOAT(NumCells)                                                 DCLR1  246
c              GPM per cell                                                     DCLR1  247
      GPMcell = TWRgpm / CellNum                                                DCLR1  248
c                                                                               DCLR1  249
c              Fan output required to hold setpoint                             DCLR1  250
c              First, convective cooling (fan off)                              DCLR1  251
      CFMcell = CFMmax * <tw:FAN-OFF-CFM>                                       DCLR1  252
c              mode 1 returns QhxOff                                            DCLR1  253
      CALL HeatExchanger(Jhx,1,MaxFlag, QhxOff, CFMcell,  DBT,xxx,              DCLR1  254
     &                                          GPMcell,DemTi,xxx )             DCLR1  255
      QhxOff = QhxOff * CellNum                                                 DCLR1  256
      IF (QhxOff .GE. TWRrej)  THEN                                             DCLR1  257
        FankWr = 0.0                                                            DCLR1  258
        IF (<tw:CAP-CTRL> .EQ. Bypass)  THEN                                    DCLR1  259
          GOTO 400                                                              DCLR1  260
        ELSE                                                                    DCLR1  261
c              get floating temperature using natural convection                DCLR1  262
          CFMra = <tw:FAN-OFF-CFM>                                              DCLR1  263
          GOTO 201                                                              DCLR1  264
        ENDIF                                                                   DCLR1  265
      ENDIF                                                                     DCLR1  266
c              select capacity control mechanism                                DCLR1  267
      GOTO (161,162,163,164,164), <tw:CAP-CTRL>                                 DCLR1  268
c              fluid bypass                                                     DCLR1  269
  161 FankWr = 1.0                                                              DCLR1  270
      GOTO 400                                                                  DCLR1  271
c              single-speed fan                                                 DCLR1  272
  162 QhxLo  = QhxOff                                                           DCLR1  273
      EfanLo = 0.0                                                              DCLR1  274
      CALL HeatExchanger(Jhx,1,MaxFlag, QhxHi, CFMmax,  DBT,xxx,                DCLR1  275
     &                                        GPMcell,DemTi,xxx )               DCLR1  276
      QhxHi  = QhxHi * CellNum                                                  DCLR1  277
      EfanHi = 1.0                                                              DCLR1  278
      GOTO 170                                                                  DCLR1  279
c              2-speed fan                                                      DCLR1  280
  163 CFMlo = CFMmax * <tw:FAN-LOW-CFM>                                         DCLR1  281
      CALL HeatExchanger(Jhx,1,MaxFlag, QhxLo,  CFMlo,  DBT,xxx,                DCLR1  282
     &                                        GPMcell,DemTi,xxx )               DCLR1  283
      QhxLo  = QhxLo * CellNum                                                  DCLR1  284
      EfanLo = <tw:FAN-LOW-ELEC>                                                DCLR1  285
      IF (QhxLo .GE. TWRrej)  THEN                                              DCLR1  286
c              will cycle Off/Lo                                                DCLR1  287
        QhxHi  = QhxLo                                                          DCLR1  288
        EfanHi = EfanLo                                                         DCLR1  289
        QhxLo  = QhxOff                                                         DCLR1  290
        EfanLo = 0.0                                                            DCLR1  291
      ELSE                                                                      DCLR1  292
c              will cycle Lo/Hi                                                 DCLR1  293
        CALL HeatExchanger(Jhx,1,MaxFlag, QhxHi, CFMmax,  DBT,xxx,              DCLR1  294
     &                                          GPMcell,DemTi,xxx )             DCLR1  295
        QhxHi  = QhxHi * CellNum                                                DCLR1  296
        EfanHi = 1.0                                                            DCLR1  297
      ENDIF                                                                     DCLR1  298
      GOTO 170                                                                  DCLR1  299
c              Variable cfm - get the required airflow (mode 2)                 DCLR1  300
  164 CALL HeatExchanger(Jhx,2,MaxFlag, TWRrej, CFMcell,  DBT,xxx,              DCLR1  301
     &                                          GPMcell,DemTi,xxx )             DCLR1  302
      CFMra = MIN(1., CFMcell/CFMmax)                                           DCLR1  303
      IF (<tw:CAP-CTRL> .EQ. SpeedV)  THEN                                      DCLR1  304
c              Variable speed airflow must be above that associated with        DCLR1  305
c              fan's critical speed - must cycle below                          DCLR1  306
        VFDmin = <tw:MIN-FAN-SPD>                                               DCLR1  307
        IF (CFMra .GT. VFDmin)  THEN                                            DCLR1  308
          FankWr  = CVAL(<tw:KW-fSPEED>, CFMra, CFMra)                          DCLR1  309
          GOTO 400                                                              DCLR1  310
        ELSE                                                                    DCLR1  311
c              cycle fan between off and minimum                                DCLR1  312
          QhxLo  = QhxOff                                                       DCLR1  313
          EfanLo = 0.0                                                          DCLR1  314
          CFMvfd = CFMmax * VFDmin                                              DCLR1  315
          CALL HeatExchanger(Jhx,1,MaxFlag, QhxHi, CFMvfd,  DBT,xxx,            DCLR1  316
     &                                            GPMcell,DemTi,xxx )           DCLR1  317
          QhxHi  = QhxHi * CellNum                                              DCLR1  318
          EfanHi = CVAL(<tw:KW-fSPEED>, VFDmin, VFDmin)                         DCLR1  319
          GOTO 170                                                              DCLR1  320
        ENDIF                                                                   DCLR1  321
      ELSE                                                                      DCLR1  322
c              Discharge damper                                                 DCLR1  323
        FankWr = CVAL(<tw:KW-fDAMPER>, CFMra, CFMra)                            DCLR1  324
        GOTO 400                                                                DCLR1  325
      ENDIF                                                                     DCLR1  326
c              cycling fan energy                                               DCLR1  327
  170 FracHi = MIN(1.0, (TWRrej-QhxLo) / (QhxHi-QhxLo) )                        DCLR1  328
      FankWr = EfanLo*(1.0-FracHi) + EfanHi*FracHi                              DCLR1  329
      GO TO 400                                                                 DCLR1  330
c                                                                               DCLR1  331
c============= FLOATING TEMPERATURE CALCULATIONS ============================== DCLR1  332
c              Temperature is floating above or below setpoint.                 DCLR1  333
c              When above setpoint, turn on as many cells as possible.          DCLR1  334
  200 NumCells = MaxCells                                                       DCLR1  335
      CellNum  = FLOAT(NumCells)                                                DCLR1  336
      CFMra    = 1.0                                                            DCLR1  337
      FracHi   = 1.0                                                            DCLR1  338
      FankWr   = 1.0                                                            DCLR1  339
c              If jumped to 201, tower can handle load using natural            DCLR1  340
c              convection only, and will be floating below the setpoint         DCLR1  341
c              (CFMra is set to the natural convective flow)                    DCLR1  342
  201 CONTINUE                                                                  DCLR1  343
      ITER = 0                                                                  DCLR1  344
      Told = 0.                                                                 DCLR1  345
      CFMcell = CFMmax * CFMra                                                  DCLR1  346
      GPMcell = TWRgpm / CellNum                                                DCLR1  347
  210 Qcell   = TWRrej / CellNum                                                DCLR1  348
c              Mode 4 call returns floating demand-side temperatures            DCLR1  349
      CALL HeatExchanger(Jhx,4,MaxFlag, Qcell, CFMcell,  DBT,   xxx,            DCLR1  350
     &                                         GPMcell,DemTi,Ttower )           DCLR1  351
c              adjust TWRrej and RANGE for new tower temperature and            DCLR1  352
c              iterate until temperature converges to 0.5F                      DCLR1  353
      IF (ABS(Told-Ttower) .GT. 0.5  .AND.  Iter .LT. 10)  THEN                 DCLR1  354
        Told   = Ttower                                                         DCLR1  355
        TWRrej = TWRload + (Tstart-Ttower)* <lp;BTU/F> + PMPQ                   DCLR1  356
        ITER   = ITER + 1                                                       DCLR1  357
        GOTO 210                                                                DCLR1  358
      ENDIF                                                                     DCLR1  359
      Ttower = Ttower + PMPdT                                                   DCLR1  360
c              when floating below setpoint, do not let temperature drop        DCLR1  361
c              below the minimum                                                DCLR1  362
      Ttower = MAX(Ttower, <lp:MIN-RESET-T>)                                    DCLR1  363
c              end of floating temperature calcs                                DCLR1  364
      GOTO 400                                                                  DCLR1  365
c                                                                               DCLR1  366
c============= LOAD RESET CALCULATIONS ======================================== DCLR1  367
c              Control cooler fan speed directly on load and let the            DCLR1  368
c              leaving temperature float as the load and drybulb vary           DCLR1  369
c              First, number of cells operating.                                DCLR1  370
  300 IF (<tw:CELL-CTRL> .EQ. RunMaxCells)  THEN                                DCLR1  371
        NumCells = MaxCells                                                     DCLR1  372
      ELSE                                                                      DCLR1  373
c              otherwise, use minimum number of cells                           DCLR1  374
        NumCells = MinCells                                                     DCLR1  375
      ENDIF                                                                     DCLR1  376
      CellNum = FLOAT(NumCells)                                                 DCLR1  377
c              water flow per cell                                              DCLR1  378
      GPMcell = TWRgpm / CellNum                                                DCLR1  379
c              fraction of design heat rejection load                           DCLR1  380
      PLR = (RANGE * GPMcell) / (<tw:DESIGN-RANGE> * <tw;GPM/CELL>)             DCLR1  381
c              fraction of airflow and fan speed requested                      DCLR1  382
c              at this part load ratio                                          DCLR1  383
      IF (<tw:CAP-CTRL> .EQ. SpeedV)  THEN                                      DCLR1  384
c              variable speed fan(s)                                            DCLR1  385
        CFMra = <tw:MIN-FAN-SPD>                                                DCLR1  386
     &          + (<tw:MAX-FAN-SPD> - <tw:MIN-FAN-SPD>)                         DCLR1  387
     &                 * (PLR-<tw:MIN-FAN-PLR>)/(1.0-<tw:MIN-FAN-PLR>)          DCLR1  388
        CFMra = MAX(<tw:MIN-FAN-SPD>,                                           DCLR1  389
     &                  MIN(CFMra , <tw:MAX-FAN-SPD>))                          DCLR1  390
      ELSE                                                                      DCLR1  391
c              2-speed fan - let float on low speed                             DCLR1  392
        CFMra = <tw:FAN-LOW-CFM>                                                DCLR1  393
      ENDIF                                                                     DCLR1  394
c              simulate the heat exchanger                                      DCLR1  395
      CFMcell = CFMmax * CFMra                                                  DCLR1  396
      Qcell   = TWRrej / CellNum                                                DCLR1  397
c              Mode 4 call returns floating demand-side temperatures            DCLR1  398
      CALL HeatExchanger(Jhx,4,MaxFlag, Qcell, CFMcell,  DBT,  xxx,             DCLR1  399
     &                                         GPMcell,  xxx,Ttower )           DCLR1  400
      Ttower = Ttower + PMPdT                                                   DCLR1  401
c              check if temp is within the acceptable range                     DCLR1  402
      IF (Ttower .GT. <lp:CL-SETPT-T>)  THEN                                    DCLR1  403
c              floating temperature is TOO HOT - control to max temp            DCLR1  404
        TWRset = <lp:CL-SETPT-T>                                                DCLR1  405
        GOTO 150                                                                DCLR1  406
      ELSEIF (Ttower .LT. <lp:MIN-RESET-T>)  THEN                               DCLR1  407
c              floating temperature is TOO COLD - control to min temp           DCLR1  408
        TWRset = <lp:MIN-RESET-T>                                               DCLR1  409
        Ttower = <lp:MIN-RESET-T>                                               DCLR1  410
        IF (RealCall)  THEN                                                     DCLR1  411
          GOTO 160                                                              DCLR1  412
        ELSE                                                                    DCLR1  413
          TWRsupply = Ttower                                                    DCLR1  414
          GOTO 401                                                              DCLR1  415
        ENDIF                                                                   DCLR1  416
      ELSE                                                                      DCLR1  417
c              floating temperature is JUUSST RIGHT.  Get the fan energy        DCLR1  418
        IF (RealCall)  THEN                                                     DCLR1  419
          IF (<tw:CAP-CTRL> .EQ. SpeedV)  THEN                                  DCLR1  420
c              variable speed                                                   DCLR1  421
            FankWr = CVAL(<tw:KW-fSPEED>, CFMra, CFMra)                         DCLR1  422
          ELSE                                                                  DCLR1  423
c              2-speed fan running on low speed                                 DCLR1  424
            FankWr = <tw:FAN-LOW-ELEC>                                          DCLR1  425
          ENDIF                                                                 DCLR1  426
        ELSE                                                                    DCLR1  427
          TWRsupply = Ttower                                                    DCLR1  428
          GOTO 401                                                              DCLR1  429
        ENDIF                                                                   DCLR1  430
      ENDIF                                                                     DCLR1  431
c              end of fan control on loop load                                  DCLR1  432
c                                                                               DCLR1  433
c============= MISCELLANEOUS ================================================== DCLR1  434
c              Load is now satisfied.                                           DCLR1  435
  400 TWRsupply     = Ttower                                                    DCLR1  436
  401 <pe;SUPPLY_T> = TWRsupply                                                 DCLR1  437
c                                                                               DCLR1  438
c                                                                               DCLR1  439
c ****         run function : DryCooler_1-4                                     DCLR1  440
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        DCLR1  441
c                                                                               DCLR1  442
c              Skip rest if an estimation call                                  DCLR1  443
  410 IF (.NOT. RealCall)  RETURN                                               DCLR1  444
c                                                                               DCLR1  445
c                                                                               DCLR1  446
c ****         run function : DryCooler_1-5                                     DCLR1  447
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        DCLR1  448
c                                                                               DCLR1  449
c              power consumption of fans                                        DCLR1  450
      FankW = <tw:FAN-KW/CELL> * CellNum * FankWr                               DCLR1  451
c                                                                               DCLR1  452
c                                                                               DCLR1  453
c              report variables                                                 DCLR1  454
 1000 <tw;KW>  = FankW                                                          DCLR1  455
      <tw;AUX> = TWRaux                                                         DCLR1  456
c                                                                               DCLR1  457
c              hourly-report variables                                          DCLR1  458
      IF (<tw;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                                DCLR1  459
     &  CALL HourRepPLT(TWRSAV(1), <tw;HREP>, 19, 0)                            DCLR1  460
c                                                                               DCLR1  461
      RETURN                                                                    DCLR1  462
      END                                                                       DCLR1  463
      SUBROUTINE DryCooler_1_Design                                             DCLR1d   2
c                                                                               DCLR1d   3
c                                                                               DCLR1d   4
c              Calculates the design data for a dry cooler                      DCLR1d   5
c                                                                               DCLR1d   6
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /DESDAT/ ZCFM,ICFM,ZVENT,C1,IFLAG                                 /DESDAT/ 2
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /REPORT/ IREPRT(4,37),IPRG,IUNIQV(100),IUNIQS(100),IUNIQL         /REPORT/ 2
      COMMON  /TWRDAT/ TWRload,TCAP,TWRrej,CWgpm,TWRgpm,TWRsupply,              /TWRDAT/ 2
     &                 TWRset,Ttower,RANGE,APP,twr1FRA,GPMra,GPMcap,            /TWRDAT/ 3
     &                 GPMcell,NumCells,MinCells,MaxCells,Ttop,GPMtop,          /TWRDAT/ 4
     &                 Tbot,GPMbot,CFMra,FankWr,FankW,TWRaux,QpanLoss,          -034     2
     &                 QcoilLoss, SpraykW, Twet1, Tstart                        /TWRDAT/ 6
      DIMENSION        TWRSAV(25)                                               /TWRDAT/ 7
      EQUIVALENCE     (TWRSAV(1),TWRload)                                       /TWRDAT/ 8
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               DCLR1d  19
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
      COMMON  /TWRKY / Open, OpenHX, FluidCool,                                 /TWRKY/  2
     &                 Bypass, Speed1, Speed2, SpeedV, Damper,                  /TWRKY/  3
     &                 RunMinCells, RunMaxCells,                                /TWRKY/  4
     &                 ElecPanHtr, NoPanHtr, HWPanHtr,                          /TWRKY/  5
     &                 CycleWithFan, StayOn                                     /TWRKY/  6
      INTEGER          Open, OpenHX, FluidCool,                                 /TWRKY/  7
     &                 Bypass, Speed1, Speed2, SpeedV, Damper,                  /TWRKY/  8
     &                 RunMinCells, RunMaxCells,                                /TWRKY/  9
     &                 ElecPanHtr, NoPanHtr, HWPanHtr,                          /TWRKY/ 10
     &                 CycleWithFan, StayOn                                     /TWRKY/ 11
c                                                                               DCLR1d  24
c                                                                               DCLR1d  30
c                                                                               DCLR1d  31
c              pointer to cw loop                                               DCLR1d  32
        Jlp = <tw:CW-LOOP>                                                      DCLR1d  33
c              cooler size                                                      DCLR1d  34
        IF (<tw:CAPACITY> .EQ. 0.)  THEN                                        DCLR1d  35
c              default cooler size                                              DCLR1d  36
          IF (<tw:CAP-RATIO> .EQ. 0.)  THEN                                     -042L2  10
c              no capcity ratio specified - size equipment equally              DCLR1d  38
            TCAP = <lp;DES_CCAP> / FLOAT(<lp;CL_NUM_EQUIP>)                     DCLR1d  39
          ELSE                                                                  DCLR1d  40
            TCAP = <lp;DES_CCAP> * <tw:CAP-RATIO>                               DCLR1d  41
          ENDIF                                                                 DCLR1d  42
        ELSE                                                                    DCLR1d  43
          TCAP = <tw:CAPACITY>                                                  DCLR1d  44
        ENDIF                                                                   DCLR1d  45
c              number of cells - if not specified, do not allow to              DCLR1d  46
c              exceed 0.12MMBTU each when autosizing                            DCLR1d  47
        IF (<tw:NUM-CELLS> .EQ. 0.)                                             DCLR1d  48
     &     <tw:NUM-CELLS> = FLOAT(INT(TCAP/1.2E5))                              DCLR1d  49
c              force to be whole real number                                    DCLR1d  50
        <tw:NUM-CELLS> = MAX(1.,FLOAT(INT(<tw:NUM-CELLS>+0.5)))                 DCLR1d  51
c              pick up temperature rise from loop if not specd.                 DCLR1d  52
        IF (<tw:CW-DT> .EQ. 0.)  <tw:CW-DT> = <lp:DESIGN-DT>                    DCLR1d  53
c              temperature change is positive for consistency with load         DCLR1d  54
        <tw:CW-DT> = ABS(<tw:CW-DT>)                                            DCLR1d  55
c              cw water flow - greater of load or flow requirement              -034    20
        CWload = TCAP / (<lp;BTUH/GPM-F>*<tw:CW-DT>)                            -034    21
        CWflow = <lp;DES_GPM> * TCAP/<lp;DES_CCAP>                              -034    22
        TWRgpm = MAX(CWload, CWflow)                                            -034    23
c              convert minimum flow from fraction to gpm                        DCLR1d  58
        <tw:CW-MIN-GPM> = TWRgpm * <tw:CW-MIN-GPM>                              DCLR1d  59
c              warn if loop pressure drop different than others                 DCLR1d  60
        IF (<tw:CW-PUMP> .EQ. 0)  THEN                                          DCLR1d  61
          IF (ABS(<tw:CW-HEAD>+<tw:CW-STATIC>                                   DCLR1d  62
     &         - (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>))                       DCLR1d  63
     &        / (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>) .GT. 0.05)  THEN        DCLR1d  64
            CALL MSGSIM(-3,II,II,II,II)                                         DCLR1d  65
            WRITE (IOUTPT,9107) (<tw:NAME>,II=1,8),                             DCLR1d  66
     &                          (<lp:NAME>,II=1,8)                              DCLR1d  67
          ENDIF                                                                 DCLR1d  68
        ENDIF                                                                   DCLR1d  69
c                                                                               DCLR1d  70
c              no tower if no flow                                              DCLR1d  71
      IF (TWRgpm .LT. .001)  THEN                                               DCLR1d  72
        <tw:CAPACITY> = 0.                                                      DCLR1d  73
        CALL MSGSIM(-3, II,II,II,II)                                            DCLR1d  74
        WRITE(IOUTPT,9100) (<tw:NAME>,II=1,8),                                  DCLR1d  75
     &                     (<lp:NAME>,II=1,8)                                   DCLR1d  76
        RETURN                                                                  DCLR1d  77
      ENDIF                                                                     DCLR1d  78
c              design the attached cooler pump                                  DCLR1d  79
      IF (<tw:CW-PUMP> .GT. 0)  THEN                                            DCLR1d  80
        Jpm = <tw:CW-PUMP>                                                      DCLR1d  81
        CALL PUMPdes(TWRgpm)                                                    DCLR1d  82
c              increase default size by pump heat                               DCLR1d  83
        IF (<tw:CAPACITY> .EQ. 0.)  TCAP = TCAP + PMPQ                          DCLR1d  84
c              store pump heat as parasitic load for hourly OpCap calc          DCLR1d  85
        <tw;Q_PARASITIC> = PMPQ                                                 DCLR1d  86
c              store design variables for use in pump calcs                     DCLR1d  87
        <pm;MIN_GPM>     = <tw:CW-MIN-GPM>                                      DCLR1d  88
      ENDIF                                                                     DCLR1d  89
c              store cooler capacity                                            DCLR1d  90
      <tw:CAPACITY> = TCAP                                                      DCLR1d  91
c                                                                               DCLR1d  92
c              default range is same as loop temp change                        DCLR1d  93
      IF (<tw:DESIGN-RANGE> .EQ. 0.)                                            DCLR1d  94
     &    <tw:DESIGN-RANGE> = <tw:CW-DT>                                        DCLR1d  95
c              design range                                                     DCLR1d  96
      RANGE = TCAP / (TWRgpm * <lp;BTUH/GPM-F>)                                 DCLR1d  97
c              maximum and minimum flowrate per cell - convert from             DCLR1d  98
c              ratio to gpm                                                     DCLR1d  99
      <tw:CELL-MAX-GPM> = TWRgpm/<tw:NUM-CELLS> * <tw:CELL-MAX-GPM>             DCLR1d 100
      <tw:CELL-MIN-GPM> = TWRgpm/<tw:NUM-CELLS> * <tw:CELL-MIN-GPM>             DCLR1d 101
      <tw;GPM/CELL>     = TWRgpm/<tw:NUM-CELLS>                                 DCLR1d 102
c                                                                               DCLR1d 103
c              Fan energy per cell.                                             DCLR1d 104
      IF (<tw:FAN-KW/CELL> .EQ. 0.)                                             DCLR1d 105
     &  <tw:FAN-KW/CELL> = TCAP/<tw:NUM-CELLS> * <tw:EIR> * KWBTU               DCLR1d 106
c              total fan kW for all cells, plus auxiliary                       DCLR1d 107
      <tw;DES_KW> = <tw:FAN-KW/CELL> * <tw:NUM-CELLS> + <tw:AUX-KW>             DCLR1d 108
c              default low-speed kW according to the speed curve                DCLR1d 109
      IF (<tw:CAP-CTRL> .EQ. Speed2  .AND.  <tw:FAN-LOW-ELEC> .EQ. 0.)          DCLR1d 110
     &  <tw:FAN-LOW-ELEC> = CVAL(<tw:KW-fSPEED>, <tw:FAN-LOW-CFM>,              DCLR1d 111
     &                                           <tw:FAN-LOW-CFM>)              DCLR1d 112
c                                                                               DCLR1d 113
c              Define the dry coil heat exchanger properties.                   DCLR1d 114
c              loop temperature entering the cooler                             DCLR1d 115
      Tloop = <lp:DESIGN-COOL-T> + RANGE                                        Chlr1 2878
c              capacity per cell                                                -045     1
      CapCell = TCAP / <tw:NUM-CELLS>                                           -045     2
c              airflow per cell, cfm                                            DCLR1d 119
      AirCFM = <tw;GPM/CELL> * <tw:CFM/GPM>                                     DCLR1d 120
c              entering air condition                                           DCLR1d 121
      Tair = Tloop - <tw:DRY-INLET-DT>                                          DCLR1d 122
c              humidity ratio at 50% relative humidity                          DCLR1d 123
      Wair = WFUNC(Tair,50.,BLDGP)                                              DCLR1d 124
c              specific volume                                                  DCLR1d 125
      Vair = 0.754*(Tair+459.7)*(1.0+1.605*Wair)/BLDGP                          DCLR1d 126
c              specific heat of air, Btu/CFM-F                                  DCLR1d 127
      AirCp = (0.24 + 0.444*Wair) * 60. / Vair                                  DCLR1d 128
c              design the heat exchanger                                        DCLR1d 129
      CALL HeatExchanger_Design(<tw:DRY-HX>, Jtw, Jlp, CapCell,                 -045     3
     &                   AirCFM,           AirCp,  Tair,          xxx,          -045     4
     &            <tw;GPM/CELL>, <lp;BTUH/GPM-F>, Tloop, <tw:CW-HEAD>)          -045     5
      <tw;MAX_DRY_CFM> = AirCFM                                                 DCLR1d 133
c                                                                               DCLR1d 134
c              total primary loop equipment capacity                            DCLR1d 135
 100  <lp;PRIMARY_CCAP> = <lp;PRIMARY_CCAP> + <tw:CAPACITY>                     DCLR1d 136
c              save design variables for use in PrimaryEquip                    DCLR1d 137
      Jpe = <tw;Jpe>                                                            DCLR1d 138
      <pe;Jpm>        = <tw:CW-PUMP>                                            DCLR1d 139
      <pe;DES_GPM>    = TWRgpm                                                  DCLR1d 140
      <pe;MAX_GPM>    = <tw:CELL-MAX-GPM>*<tw:NUM-CELLS>                        DCLR1d 141
      <pe;DES_HEAD>   = <tw:CW-HEAD>                                            DCLR1d 142
      <pe;DES_STATIC> = <tw:CW-STATIC>                                          DCLR1d 143
      <pe:ISOLATION>  = 1                                                       DCLR1d 144
      IF (<pe;MAX_GPM> .LT. <lp:RECIRC-GPM>  .OR.                               -035    30
     &    <pe;MAX_GPM> .LT. <lp:MIN-GPM>)    THEN                               -035    31
        CALL MSGSIM(-3,II,II,II,II)                                             -035    32
        WRITE (IOUTPT, 9001)  (<tw:NAME>,II=1,8)                                -035    33
      ENDIF                                                                     -035    34
c                                                                               DCLR1d 145
c              dump cooler design variables if needed                           DCLR1d 146
      IF (IREPRT(3,34) .GT. 0)                                                  DCLR1d 147
     &  WRITE(IOUTPT,9000) (<tw:NAME>,II=1,8),<tw:CAPACITY>,                    DCLR1d 148
     &  <tw:NUM-CELLS>,RANGE, <tw:CELL-MAX-GPM>,                                DCLR1d 149
     &  <tw:CELL-MIN-GPM>,<tw;GPM/CELL>,<tw:FAN-KW/CELL>,                       DCLR1d 150
     &  TWRgpm                                                                  DCLR1d 151
c                                                                               DCLR1d 152
      RETURN                                                                    DCLR1d 153
c                                                                               DCLR1d 154
c              dump formats                                                     DCLR1d 155
 9000 FORMAT(' ',8A4,                                                           DCLR1d 156
     &      /    17X,'     SIZE  NumCells     RANGE              GPMMAX'        DCLR1d 157
     &      /    17X,     F10.1,    F10.1,    F10.1,      10x,    F10.1         DCLR1d 158
     &      /    17X,'   GPMMIN       GPM    EFCELL    DESGPM          '        DCLR1d 159
     &      /    17X,     F10.1,      10X,    F10.1,    F10.1          )        DCLR1d 160
c              message formats                                                  DCLR1d 161
 9001 FORMAT(14X,8A4,' has a maximum flow smaller'                     /        -035    35
     &       14X,'than the loops minimum flow, and will never be used' /        -035    36
     &       14X,'by itself.'                                          )        -035    37
 9100 FORMAT(14X,'Dry Cooler: ',8A4,' on loop ',8A4                    /        DCLR1d 162
     &       14X,'is not needed.  No simulation will be performed.    ')        DCLR1d 163
 9101 FORMAT(14X,'unused'                                              )        DCLR1d 164
 9102 FORMAT(14X,'Dry Cooler: ',8A4,' must have a 2-speed or'          /        DCLR1d 165
     &       14X,'variable-speed fan for the condenser loop LOAD-RESET'/        DCLR1d 166
     &       14X,'temperature control strategy to work.  The control'  /        DCLR1d 167
     &       14X,'strategy has been changed to FIXED.'                 )        DCLR1d 168
 9107 FORMAT(14X,'Plant equipment: ',8A4,' has a different'            /        DCLR1d 169
     &       14X,'pressure drop on loop: ',8A4,' than the'             /        DCLR1d 170
     &       14X,'other equipment.  This is unusual unless the loop'   /        DCLR1d 171
     &       14X,'uses flow meters or other dynamic flow control'      /        DCLR1d 172
     &       14X,'devices to allocate the flow on an hourly basis to'  /        DCLR1d 173
     &       14X,'the active equipment.'                               )        DCLR1d 174
c                                                                               DCLR1d 175
      END                                                                       DCLR1d 176
      SUBROUTINE DW_Design_1                                                    DWDES1   2
c                                                                               DWDES1   3
c              Sets up the design parameters for most DW Heater types           DWDES1   4
c                                                                               DWDES1   5
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /DESDAT/ ZCFM,ICFM,ZVENT,C1,IFLAG                                 /DESDAT/ 2
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               DWDES1  13
      COMMON  /DHWKY / DHWgas, DHWelec, DHWhtpump                               /DHWKY/  2
      INTEGER          DHWgas, DHWelec, DHWhtpump                               /DHWKY/  3
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
      COMMON  /SimAlg/ Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/ 2
     &                 Electrical,                                              /SIMALG/ 3
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/ 4
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/ 5
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   2
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/ 7
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/ 8
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/ 9
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/10
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    3
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    4
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    5
     &                 Ground_LoopVert_H2,Ground_LoopHoriz_H,                   -044d    6
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/14
      INTEGER          Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/15
     &                 Electrical,                                              /SIMALG/16
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/17
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/18
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   3
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/20
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/21
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/22
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/23
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    7
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    8
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    9
     &                 Ground_LoopVert_H2, Ground_LoopHoriz_H,                  -044d   10
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/27
c                                                                               DWDES1  19
c                                                                               DWDES1  25
c              pointer to dhw loop                                              DWDES1  26
      Jlp = <dw:DHW-LOOP>                                                       DWDES1  27
c              heater size                                                      DWDES1  28
      IF (<dw:CAP> .EQ. UNFILD)  THEN                                           DWDES1  29
        IF (<dw:CAP-RATIO> .EQ. 0.)  THEN                                       -042L2  11
c              no capcity ratio specified - size equipment equally              DWDES1  31
          CAP = <lp;DES_HCAP> / FLOAT(<lp;HT_NUM_EQUIP>)                        DWDES1  32
        ELSE                                                                    DWDES1  33
          CAP = <lp;DES_HCAP> * <dw:CAP-RATIO>                                  DWDES1  34
        ENDIF                                                                   DWDES1  35
      ELSE                                                                      DWDES1  36
        CAP = <dw:CAP>                                                          DWDES1  37
      ENDIF                                                                     DWDES1  38
c              skip if no capacity                                              DWDES1  39
      IF (CAP .EQ. 0)  GOTO 1000                                                DWDES1  40
c              heat pump supplemental capacity                                  DWDES1  41
      IF (<dw:TYPE> .EQ. DHWhtpump  .AND.  <dw:HP-SUPP-CAP> .EQ. UNFILD)        DWDES1  42
     &  <dw:HP-SUPP-CAP> = CAP                                                  DWDES1  43
c              convert minimum flow from fraction to gpm                        DWDES1  44
      <dw:MIN-GPM> = <lp;DES_GPMr> * CAP/<lp;DES_HCAP> * <dw:MIN-GPM>           DWDES1  45
c              convert maximum flow from fraction to gpm                        DWDES1  46
      <dw:MAX-GPM> = <lp;DES_GPM>  * CAP/<lp;DES_HCAP> * <dw:MAX-GPM>           DWDES1  47
      IF (<dw:MAX-GPM> .LT. <lp:RECIRC-GPM>  .OR.                               -035    38
     &    <dw:MAX-GPM> .LT. <lp:MIN-GPM>)    THEN                               -035    39
        CALL MSGSIM(-3,II,II,II,II)                                             -035    40
        WRITE (IOUTPT, 9001)  (<dw:NAME>,II=1,8)                                -035    41
      ENDIF                                                                     -035    42
c              tank volume                                                      DWDES1  48
      IF (<dw:VOLUME> .EQ. UNFILD)  THEN                                        DWDES1  49
c              default volume is equal to the maximum hourly non-coil flow      DWDES1  50
        Volume = <lp;DES_GPMdhw> * 60. * CAP/<lp;DES_HCAP>                      DWDES1  51
c               Make auto sizes of tank real                                    DWDES1  52
        IF( Volume.LT.30.)                         <dw:VOLUME> = 30.            DWDES1  53
        IF((Volume.GT.30.) .and. (Volume.LE.40.))  <dw:VOLUME> = 40.            DWDES1  54
        IF((Volume.GT.40.) .and. (Volume.LE.50.))  <dw:VOLUME> = 50.            DWDES1  55
        IF((Volume.GT.40.) .and. (Volume.LE.75.))  <dw:VOLUME> = 75.            DWDES1  56
        IF((Volume.GT.75.) .and. (Volume.LE.100.)) <dw:VOLUME>= 100.            DWDES1  57
        IF(Volume.GT.100.) <dw:VOLUME> =FLOAT(INT(Volume/50.)+1)*50.            DWDES1  58
c              if this loop serves coils in addition to dhw,                    DWDES1  59
c              tank must be at least 40 gallons                                 DWDES1  60
        IF(<lp;GPM> .NE. 0.)  <dw:VOLUME> = MAX(<dw:VOLUME>,40.)                DWDES1  61
      ENDIF                                                                     DWDES1  62
c              tank heat capacity                                               DWDES1  63
      <dw;TANK_BTU/F> = <dw:VOLUME> * <lp;BTUH/GPM-F> / 60.                     DWDES1  64
c              default UA for tank losses                                       DWDES1  65
      IF (<dw:TANK-UA> .EQ. UNFILD)  THEN                                       DWDES1  66
        IF (<dw:TYPE> .EQ. DHWgas)  THEN                                        DWDES1  67
c              default UA for gas heaters based on .03 of burner cap            DWDES1  68
c              per hour, assuming 40 gal tank, 33,000 btuh input, 75%           DWDES1  69
c              eff, and 60 degree dT  =  33000*.75*.03/(40gal*60F)              DWDES1  70
          <dw:TANK-UA> = <dw:VOLUME> * 0.3                                      DWDES1  71
        ELSE                                                                    DWDES1  72
c              default for all electric/heat pump heaters assumed to be         DWDES1  73
c              1/3 of gas loss                                                  DWDES1  74
          <dw:TANK-UA> = <dw:VOLUME> * 0.1                                      DWDES1  75
        ENDIF                                                                   DWDES1  76
      ENDIF                                                                     DWDES1  77
c              design the dhw circulation pump (located on return leg)          DWDES1  78
      IF (<dw:PUMP> .GT. 0)  THEN                                               DWDES1  79
        IF (<dw:CAP-RATIO> .GT. 0.)  THEN                                       GLHX1    4
          GPMr = <lp;DES_GPMr> * <dw:CAP-RATIO>                                 GLHX1    5
        ELSE                                                                    GLHX1    6
          GPMr = <lp;DES_GPMr>                                                  GLHX1    7
        ENDIF                                                                   GLHX1    8
        Jpm  = <dw:PUMP>                                                        DWDES1  81
        CALL PUMPdes(GPMr)                                                      DWDES1  82
c              decrease default size by pump heat                               DWDES1  83
        IF (<dw:CAP> .EQ. UNFILD)  CAP = CAP + Qpump                            DWDES1  84
c              store pump heat as parasitic load for hourly OpCap calc          DWDES1  85
        <dw;Q_PARASITIC> = Qpump                                                DWDES1  86
c              store design variables for use in pump calcs                     DWDES1  87
        <pm;MIN_GPM> = <dw:MIN-GPM>                                             DWDES1  88
      ELSE                                                                      DWDES1  89
c              error if no attached or loop pump                                DWDES1  90
        IF (<lp:PUMP> .EQ. 0  .AND.  <lp;DES_GPMr> .GT. 0.)  THEN               DWDES1  91
          CALL MSGSIM(-1,II,II,II,II)                                           DWDES1  92
          WRITE (IOUTPT,9104) (<dw:NAME>,II=1,8),                               DWDES1  93
     &                        (<lp:NAME>,II=1,8)                                DWDES1  94
          IFLAG = 1                                                             DWDES1  95
        ENDIF                                                                   DWDES1  96
c              warn if loop pressure drop different than others                 DWDES1  97
        IF (ABS(<dw:HEAD>+<dw:STATIC>                                           DWDES1  98
     &         - (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>))                       DWDES1  99
     &        / (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>) .GT. 0.05               DWDES1 100
     &                               .AND.  <lp:TYPE> .NE. WLHP)  THEN          DWDES1 101
          CALL MSGSIM(-3,II,II,II,II)                                           DWDES1 102
          WRITE (IOUTPT,9107) (<dw:NAME>,II=1,8),                               DWDES1 103
     &                        (<lp:NAME>,II=1,8)                                DWDES1 104
        ENDIF                                                                   DWDES1 105
      ENDIF                                                                     DWDES1 106
c              design heater capacity                                           DWDES1 107
      <dw:CAP> = CAP                                                            DWDES1 108
c              design electric and fuel consumption                             DWDES1 109
      <dw;DES_KW>   = -CAP * <dw:EIR> * KWBTU                                   DWDES1 110
      <dw;DES_KW>   = <dw;DES_KW> + <dw:AUX-KW>                                 DWDES1 111
      <dw;DES_FUEL> = -CAP * <dw:HIR>                                           DWDES1 112
c              total primary loop equipment capacity                            DWDES1 113
      <lp;PRIMARY_HCAP> = <lp;PRIMARY_HCAP> + CAP                               DWDES1 114
c              initialize tank temperature                                      DWDES1 115
      <dw;TANK_T> = <lp:DESIGN-HEAT-T>                                          Chlr1 2879
c              save design variables for use in PrimaryEquip                    DWDES1 117
      <pe;Jpm>        = <dw:PUMP>                                               DWDES1 118
      <pe;DES_GPM>    = <lp;DES_GPM> * CAP/<lp;DES_HCAP>                        DWDES1 119
      <pe;MAX_GPM>    = <dw:MAX-GPM>                                            DWDES1 120
      <pe;DES_HEAD>   = <dw:HEAD>                                               DWDES1 121
      <pe;DES_STATIC> = <dw:STATIC>                                             DWDES1 122
      <pe:ISOLATION>  = 1                                                       DWDES1 123
c                                                                               DWDES1 124
 1000 RETURN                                                                    DWDES1 125
c                                                                               DWDES1 126
c              message formats                                                  DWDES1 127
 9001 FORMAT(14X,8A4,' has a maximum flow smaller'                     /        -035    43
     &       14X,'than the loops minimum flow, and will never be used' /        -035    44
     &       14X,'by itself.'                                          )        -035    45
 9104 FORMAT(14X,8A4,' must have a pump if'                            /        DWDES1 128
     &       14X,'loop: ',8A4,' does not.'                             )        DWDES1 129
 9107 FORMAT(14X,'Plant equipment: ',8A4,' has a different'            /        DWDES1 130
     &       14X,'pressure drop on loop: ',8A4,' than the'             /        DWDES1 131
     &       14X,'other equipment.  This is unusual unless the loop'   /        DWDES1 132
     &       14X,'uses flow meters or other dynamic flow control'      /        DWDES1 133
     &       14X,'devices to allocate the flow on an hourly basis to'  /        DWDES1 134
     &       14X,'the active equipment.'                               )        DWDES1 135
c                                                                               DWDES1 136
      END                                                                       DWDES1 137
      SUBROUTINE DW_Heater_1                                                    DWHTR1   2
c                                                                               DWHTR1   3
c                                                                               DWHTR1   4
c              Simulates domestic water heaters, both fuel-fired                DWHTR1   5
c              and electric                                                     DWHTR1   6
c                                                                               DWHTR1   7
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /EQUIPD/ EQload, EQrun, EQhgb, OperCap, Frac,                     /EQUIPD/ 2
     &                 PLR, EQsupplyT, Tcond,                                   Chlr1    1
     &                 EIRPLR, EIRFT, EQEIR, EQelec, EQfanKW, EQaux,            /EQUIPD/ 4
     &                 HIRPLR, HIRFT, EQHIR, EQfuel, EQcond, EQrecvr,           /EQUIPD/ 5
     &                 HWflow, HWhead, CHWflow, CHWhead, CWflow, CWhead,        /EQUIPD/ 6
     &                 HTRECflow,HTREChead, Qenvir, EQstart, EQloadH,           -041d    1
     &                 EQstartH, PLRh, FracH, EQfuelH, EQelecH                  /EQUIPD/ 8
      REAL             EQUIPDAT(36)                                             /EQUIPD/10
      EQUIVALENCE      (EQUIPDAT(1), EQload), (Tambient, Tcond)                 FreeCl   1
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /LOOP  / Nloop(16,2), NextType(40), NLP2,                         -41a     1
     &                 WLHPoff, RealCall, RegenFlag, Sim2x, LoopSimCount        ChlrHP   2
      LOGICAL          WLHPoff, RealCall, RegenFlag, Sim2x                      ChlrHP   3
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               DWHTR1  22
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
c                                                                               DWHTR1  25
      INTEGER ZP1                                                               DWHTR1  26
c                                                                               DWHTR1  27
c              zero hourly heater data                                          DWHTR1  28
      CALL FILLN(0., EQUIPDAT(1), IVTLIM(2,18))                                 DWHTR1  29
c                                                                               DWHTR1  30
c              required supply temperature                                      DWHTR1  31
      EQsupplyT = MAX(<pe;SUPPLY_T>, <dw:AQUASTAT-T>)                           -035    46
c                                                                               DWHTR1  33
c              environmental temperature                                        DWHTR1  34
      IF (<dw:ZONE> .EQ. 0)  THEN                                               DWHTR1  35
c              Tank is located outdoors.                                        DWHTR1  36
        Tambient = DBT                                                          FreeCl  30
      ELSE                                                                      DWHTR1  38
c              Tank is located indoors                                          DWHTR1  39
        ZP1 = <dw:ZONE>                                                         DWHTR1  40
        IF (RealCall)  THEN                                                     DWHTR1  41
c              use average temperature for end-of-hour calcs                    DWHTR1  42
          Tambient = (<TNOW>+<TPAST>)*0.5                                       FreeCl  31
        ELSE                                                                    DWHTR1  44
          Tambient = <TNOW>                                                     FreeCl  32
        ENDIF                                                                   DWHTR1  46
      ENDIF                                                                     DWHTR1  47
c                                                                               DWHTR1  48
c              Calc the tank loss if located outdoors or this                   DWHTR1  49
c              is an estimation call - note that, if located                    DWHTR1  50
c              indoors, the actual loss is calc'd in TEMDEV (future)            -041d    2
        IF (<dw:ZONE> .EQ. 0 .OR.  .NOT. RealCall)                              DWHTR1  52
     &    <dw;TANK_LOSS> = <dw:TANK-UA> * (Tambient-<dw;TANK_T>)                FreeCl  33
c                                                                               DWHTR1  54
c ****         run function : DW_Heater_1-1                                     DWHTR1  55
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        DWHTR1  56
c                                                                               DWHTR1  57
c                                                                               DWHTR1  58
c============= ROUTINE CALLED TO GET OPERATING CAPACITY ======================= DWHTR1  59
      IF (SimCtrl .EQ. 11)  THEN                                                DWHTR1  60
c                                                                               DWHTR1  61
c              Firing rate as a function of environmental temperature           DWHTR1  62
        <pe;OPER_CAPACITY> = <dw:CAP>                                           FreeCl  34
     &                     * CVAL(<dw:CAP-FT>,EQsupplyT,Tambient)               FreeCl  35
c              Maximum operating capacity                                       DWHTR1  64
        <pe;MAX_CAPACITY> = <pe;OPER_CAPACITY>                                  DWHTR1  65
c                     assume only 80% of tank volume is actually available      DWHTR1  66
c                     before water temperature drops                            DWHTR1  67
     &                    + <dw;TANK_BTU/F>*0.8                                 DWHTR1  68
     &                                     *(<pe;RETURN_T>-<dw;TANK_T>)         DWHTR1  69
c                     deduct thermal losses                                     DWHTR1  70
     &                    - <dw;TANK_LOSS>                                      DWHTR1  71
c                     parasitic load such as a pump                             DWHTR1  72
     &                    - <dw;Q_PARASITIC>                                    DWHTR1  73
c                                                                               DWHTR1  74
c ****         run function : DW_Heater_1-2                                     DWHTR1  75
c       IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                      DWHTR1  76
c                                                                               DWHTR1  77
c              convert to positive number for load allocation routines          DWHTR1  78
        <pe;MAX_CAPACITY> = -<pe;MAX_CAPACITY>                                  DWHTR1  79
c                                                                               DWHTR1  80
        RETURN                                                                  DWHTR1  81
      ENDIF                                                                     DWHTR1  82
c                                                                               DWHTR1  83
c                                                                               DWHTR1  84
c============= ROUTINE CALLED TO SIMULATE EQUIPMENT =========================== DWHTR1  85
c                                                                               DWHTR1  86
c              total equipment pump kW                                          DWHTR1  87
      AuxPumpKW  = 0.                                                           DWHTR1  88
c                                                                               DWHTR1  89
c ****         run function : DW_Heater_1-3                                     DWHTR1  90
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        DWHTR1  91
c                                                                               DWHTR1  92
c              hourly load                                                      DWHTR1  93
      EQload    = -<pe;LOAD>                                                    DWHTR1  94
      <pe;LOAD> = EQload                                                        DWHTR1  95
c              net load is end-use load, losses, and storage demand             DWHTR1  96
      EQloadNet = EQload + <dw;TANK_LOSS>                                       DWHTR1  97
     &                   + <dw;TANK_BTU/F>*(<dw;TANK_T>-EQsupplyT)              DWHTR1  98
c                                                                               DWHTR1  99
c              hot water pump                                                   DWHTR1 100
      IF (<dw:PUMP> .NE. 0  .AND.  RealCall)  THEN                              DWHTR1 101
        Jpm = <dw:PUMP>                                                         DWHTR1 102
c              fraction of the hour the pump operates                           DWHTR1 103
        IF (<pm;TYPE> .EQ. EquipmentPump)  THEN                                 DWHTR1 104
c              circulation loop has its own pump - heater pump runs             DWHTR1 105
c              with heater                                                      DWHTR1 106
c              part load ratio                                                  DWHTR1 107
          IF (EQload .NE. 0.)  THEN                                             ERV     29
            PLR = MAX(0., MIN(1., EQloadNet / <pe;MAX_CAPACITY>))               ERV     30
          ELSE                                                                  ERV     31
            PLR = 0.                                                            ERV     32
          ENDIF                                                                 ERV     33
c              fraction of the hour the pump operates                           DWHTR1 109
          PMPfrac = PLR                                                         DWHTR1 110
        ELSE                                                                    DWHTR1 111
c              no circulation loop pump - pump runs all hour                    DWHTR1 112
          PMPfrac = 1.0                                                         DWHTR1 113
        ENDIF                                                                   DWHTR1 114
c              do the pump simulation                                           DWHTR1 115
        CALL PumpSupply                                                         DWHTR1 116
c              sum into auxiliary pump kW (equipment only)                      DWHTR1 117
        IF (<lp:PUMP> .NE. 0)  AuxPumpKW = PMPkW                                DWHTR1 118
c              add pump heat to load                                            DWHTR1 119
        EQload    = MIN(0., EQload    + PMPQ)                                   DWHTR1 120
        EQloadNet = EQloadNet + PMPQ                                            -035    47
      ENDIF                                                                     DWHTR1 122
      EQloadNet = MIN(0., EQloadNet)                                            -035    48
c                                                                               DWHTR1 123
      IF (.NOT. RealCall)  THEN                                                 DWHTR1 124
c              this was a call to estimate the load - store for                 DWHTR1 125
c              SYSTEM airside calcs                                             DWHTR1 126
        <dw;Qask> = MIN(EQload, EQloadNet)                                      DWHTR1 127
        IF (<dw:MAX-HTREC> .NE. UNFILD)                                         DWHTR1 128
     &    <dw;Qask> = MAX(EQloadNet, <dw:MAX-HTREC>)                            DWHTR1 129
c              initialize the heat recovery variable for summing                DWHTR1 130
c              by the SYSTEM airside calcs                                      DWHTR1 131
        <dw;Q_RECVR> = 0.                                                       DWHTR1 132
        RETURN                                                                  DWHTR1 133
      ELSE                                                                      DWHTR1 134
c              adjust net load for heat recovered from DX equipment             DWHTR1 135
c              in SYSTEMS                                                       DWHTR1 136
        EQrecvr   = MAX(EQloadNet, <dw;Q_RECVR>)                                DWHTR1 137
        EQloadNet = EQloadNet - EQrecvr                                         DWHTR1 138
c              skip if no net load                                              DWHTR1 139
        IF (EQloadNet .EQ. 0.)  GOTO 1000                                       DWHTR1 140
      ENDIF                                                                     DWHTR1 141
c                                                                               DWHTR1 142
c              Hourly heat input capacity - excludes any heat                   DWHTR1 143
c              provided by tank storage                                         DWHTR1 144
      IF (<pe;OPER_CAPACITY> .NE. 0.)  THEN                                     HVAC28   1
        OperCap = <pe;OPER_CAPACITY>                                            HVAC28   2
      ELSE                                                                      HVAC28   3
        OperCap = <dw:CAP> * CVAL(<dw:CAP-FT>,EQsupplyT,Tambient)               FreeCl  36
      ENDIF                                                                     HVAC28   5
c                                                                               DWHTR1 146
c              limit net load by capacity (difference, if any will come         DWHTR1 147
c              out of tank storage)                                             DWHTR1 148
      EQloadNet = MAX(OperCap, MIN(0., EQloadNet))                              DWHTR1 149
c                                                                               DWHTR1 150
c              recalculate part load ratio including pump heat                  DWHTR1 151
      PLR  = EQloadNet / OperCap                                                DWHTR1 152
c              fraction of the hour the tank is heating                         DWHTR1 153
      Frac = PLR                                                                DWHTR1 154
c                                                                               DWHTR1 155
c              elec input ratio as a function of temperature                    DWHTR1 156
      EIRFT  = CVAL(<dw:EIR-FT>,EQsupplyT,Tambient)                             FreeCl  37
c              elec input ratio as a function of part load                      DWHTR1 158
      EIRPLR = CVAL(<dw:EIR-FPLR>,PLR,PLR)                                      -035    49
c              electric input ratio                                             DWHTR1 160
      EQEIR  = <dw:EIR> * EIRFT * EIRPLR                                        DWHTR1 161
c              electrical consumption                                           DWHTR1 162
      EQelec = -OperCap * EQEIR * KWBTU                                         DWHTR1 163
c                                                                               DWHTR1 164
c              fuel input ratio as a function of temperature                    DWHTR1 165
      HIRFT  = CVAL(<dw:HIR-FT>,EQsupplyT,Tambient)                             FreeCl  38
c              fuel input ratio as a function of part load                      DWHTR1 167
      HIRPLR = CVAL(<dw:HIR-FPLR>,PLR,PLR)                                      -035    50
c              fuel input ratio                                                 DWHTR1 169
      HIR    = <dw:HIR> * HIRFT * HIRPLR                                        DWHTR1 170
c              fuel consumption                                                 DWHTR1 171
      EQfuel = -OperCap * HIR                                                   DWHTR1 172
c                                                                               DWHTR1 173
 1000 CONTINUE                                                                  DWHTR1 174
c              Tank temperature                                                 DWHTR1 175
      dTtank = ((EQload+<dw;TANK_LOSS>) - (EQloadNet+EQrecvr))                  DWHTR1 176
     &                                               / <dw;TANK_BTU/F>          DWHTR1 177
      <dw;TANK_T> = <dw;TANK_T> + dTtank                                        DWHTR1 178
c                                                                               DWHTR1 179
c              Auxiliary power                                                  DWHTR1 180
      IF (<dw:AUX-KW> .GT. 0.)  THEN                                            DWHTR1 181
c              if always on                                                     DWHTR1 182
        IF (<dw:AUX-MODE> .EQ. Always)  THEN                                    DWHTR1 183
          EQaux = <dw:AUX-KW>                                                   DWHTR1 184
        ELSEIF (<dw:AUX-MODE> .EQ. WhenOn)  THEN                                DWHTR1 185
          EQaux = <dw:AUX-KW> * Frac                                            DWHTR1 186
        ELSEIF (<dw:AUX-MODE> .EQ. WhenOff)  THEN                               DWHTR1 187
          EQaux = <dw:AUX-KW> * (1.0 - Frac)                                    DWHTR1 188
        ELSE                                                                    Time    26
          EQaux = <dw:AUX-KW> * SchVal(<dw:AUX-SCH>, 1.)                        Time    27
        ENDIF                                                                   DWHTR1 191
      ENDIF                                                                     DWHTR1 192
c                                                                               DWHTR1 193
c ****         run function : DW_Heater_1-4                                     DWHTR1 194
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        DWHTR1 195
c                                                                               DWHTR1 196
c              report variables                                                 DWHTR1 197
      <dw;Q_RECVR> = EQrecvr                                                    DWHTR1 198
      <dw;KW>      = EQelec                                                     DWHTR1 199
      <dw;FUEL>    = EQfuel                                                     DWHTR1 200
      <dw;AUX>     = EQaux                                                      DWHTR1 201
c                                                                               DWHTR1 202
c              hourly-report variables                                          DWHTR1 203
      IF (<dw;HREP> .NE. 0  .AND.  IRSCH .NE. 0)  THEN                          -041d    3
        Qenvir = <dw;TANK_LOSS>                                                 -041d    4
        CALL HourRepPLT(EQUIPDAT(1), <dw;HREP>, 18, 0)                          -041d    5
      ENDIF                                                                     -041d    6
c                                                                               DWHTR1 206
      RETURN                                                                    DWHTR1 207
      END                                                                       DWHTR1 208
      SUBROUTINE DW_Heater_2                                                    DWHTR2   2
c                                                                               DWHTR2   3
c                                                                               DWHTR2   4
c              Simulates heat pump domestic water heaters                       DWHTR2   5
c                                                                               DWHTR2   6
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /EQUIPD/ EQload, EQrun, EQhgb, OperCap, Frac,                     /EQUIPD/ 2
     &                 PLR, EQsupplyT, Tcond,                                   Chlr1    1
     &                 EIRPLR, EIRFT, EQEIR, EQelec, EQfanKW, EQaux,            /EQUIPD/ 4
     &                 HIRPLR, HIRFT, EQHIR, EQfuel, EQcond, EQrecvr,           /EQUIPD/ 5
     &                 HWflow, HWhead, CHWflow, CHWhead, CWflow, CWhead,        /EQUIPD/ 6
     &                 HTRECflow,HTREChead, Qenvir, EQstart, EQloadH,           -041d    1
     &                 EQstartH, PLRh, FracH, EQfuelH, EQelecH                  /EQUIPD/ 8
      REAL             EQUIPDAT(36)                                             /EQUIPD/10
      EQUIVALENCE      (EQUIPDAT(1), EQload), (Tambient, Tcond)                 FreeCl   1
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /LOOP  / Nloop(16,2), NextType(40), NLP2,                         -41a     1
     &                 WLHPoff, RealCall, RegenFlag, Sim2x, LoopSimCount        ChlrHP   2
      LOGICAL          WLHPoff, RealCall, RegenFlag, Sim2x                      ChlrHP   3
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               DWHTR2  21
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
c                                                                               DWHTR2  24
      INTEGER ZP1                                                               DWHTR2  25
c                                                                               DWHTR2  26
c              zero hourly heater data                                          DWHTR2  27
      CALL FILLN(0., EQUIPDAT(1), IVTLIM(2,18))                                 DWHTR2  28
c                                                                               DWHTR2  29
c              required supply temperature                                      DWHTR2  30
      EQsupplyT = MAX(<pe;SUPPLY_T>, <dw:AQUASTAT-T>)                           -035    51
c                                                                               DWHTR2  32
c              tank environmental temperature                                   Sync     6
      IF (<dw:ZONE> .EQ. 0)  THEN                                               Sync     7
c              Tank is located outdoors.                                        Sync     8
        Tambient = DBT                                                          FreeCl  39
      ELSE                                                                      Sync    10
c              Tank is located indoors                                          Sync    11
        ZP1 = <dw:ZONE>                                                         Sync    12
        IF (RealCall)  THEN                                                     Sync    13
c              use average temperature for end-of-hour calcs                    Sync    14
          Tambient = (<TNOW>+<TPAST>)*0.5                                       FreeCl  40
        ELSE                                                                    Sync    16
          Tambient = <TNOW>                                                     FreeCl  41
        ENDIF                                                                   Sync    18
      ENDIF                                                                     Sync    19
c                                                                               DWHTR2  47
c              Calc the tank loss if located outdoors or this                   DWHTR2  48
c              is an estimation call - note that, if located                    DWHTR2  49
c              indoors, the actual loss is calc'd in TEMDEV (future)            -041d    7
        IF (<dw:ZONE> .EQ. 0 .OR.  .NOT. RealCall)                              DWHTR2  51
     &    <dw;TANK_LOSS> = <dw:TANK-UA> * (Tambient-<dw;TANK_T>)                FreeCl  42
c                                                                               DWHTR2  53
c ****         run function : DW_Heater_2-1                                     DWHTR2  54
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        DWHTR2  55
c                                                                               DWHTR2  56
c                                                                               DWHTR2  57
c============= ROUTINE CALLED TO GET OPERATING CAPACITY ======================= DWHTR2  58
      IF (SimCtrl .EQ. 11)  THEN                                                DWHTR2  59
c                                                                               DWHTR2  60
c              Maximum heat that can be provided by heat pump based on          DWHTR2  61
c              heater temperature                                               DWHTR2  62
        Qhp = MIN(0.,<lp;BTUH/GPM-F> * <dw:MAX-GPM>                             DWHTR2  63
     &               * (<pe;RETURN_T>-MIN(<dw:HP-MAX-T>,EQsupplyT)))            DWHTR2  64
c              Hourly compressor capacity - excludes any heat                   DWHTR2  65
c              provided by tank storage or supplemental heat                    DWHTR2  66
        <pe;OPER_CAPACITY> = <dw:CAP>                                           DWHTR2  67
     &                     * CVAL(<dw:CAP-FT>,<dw:HP-MAX-T>,Tambient)           FreeCl  43
c              limit compressor heat by capacity                                DWHTR2  69
        Qhp = MAX(Qhp, <pe;OPER_CAPACITY>)                                      DWHTR2  70
c              operating capacity - include supplemental heat                   DWHTR2  71
        <pe;MAX_CAPACITY> = Qhp + <dw:HP-SUPP-CAP>                              DWHTR2  72
c                     assume only 80% of tank volume is actually available      DWHTR2  73
c                     before water temperature drops                            DWHTR2  74
     &                     + <dw;TANK_BTU/F>*0.8                                DWHTR2  75
     &                              *(<pe;RETURN_T>-<dw;TANK_T>)                DWHTR2  76
c                     deduct thermal losses                                     DWHTR2  77
     &                     - <dw;TANK_LOSS>                                     DWHTR2  78
c                                                                               DWHTR2  79
c ****         run function : DW_Heater_2-2                                     DWHTR2  80
c       IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                      DWHTR2  81
c                                                                               DWHTR2  82
c              convert to positive number for load allocation routines          DWHTR2  83
        <pe;MAX_CAPACITY> = -<pe;MAX_CAPACITY>                                  DWHTR2  84
c                                                                               DWHTR2  85
        RETURN                                                                  DWHTR2  86
      ENDIF                                                                     DWHTR2  87
c                                                                               DWHTR2  88
c                                                                               DWHTR2  89
c============= ROUTINE CALLED TO SIMULATE EQUIPMENT =========================== DWHTR2  90
c                                                                               DWHTR2  91
c              total equipment pump kW                                          DWHTR2  92
      AuxPumpKW = 0.                                                            DWHTR2  93
c                                                                               DWHTR2  94
c ****         run function : DW_Heater_2-3                                     DWHTR2  95
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        DWHTR2  96
c                                                                               DWHTR2  97
c              hourly load                                                      DWHTR2  98
      EQload    = -<pe;LOAD>                                                    DWHTR2  99
      <pe;LOAD> = EQload                                                        DWHTR2 100
c              net load is end-use load, losses, and storage demand             DWHTR2 101
      EQloadNet = EQload + <dw;TANK_LOSS>                                       DWHTR2 102
     &          + <dw;TANK_BTU/F>*(<dw;TANK_T>-EQsupplyT)                       DWHTR2 103
c                                                                               DWHTR2 104
c              hot water pump                                                   DWHTR2 105
      IF (<dw:PUMP> .NE. 0  .AND.  RealCall)  THEN                              DWHTR2 106
        Jpm = <dw:PUMP>                                                         DWHTR2 107
c              fraction of the hour the pump operates                           DWHTR2 108
        IF (<pm;TYPE> .EQ. EquipmentPump)  THEN                                 DWHTR2 109
c              circulation loop has its own pump - heater pump runs             DWHTR2 110
c              with heater                                                      DWHTR2 111
c              part load ratio                                                  DWHTR2 112
          IF (EQload .NE. 0.)  THEN                                             ERV     34
            PLR = MAX(0., MIN(1., EQloadNet / <pe;MAX_CAPACITY>))               ERV     35
          ELSE                                                                  ERV     36
            PLR = 0.                                                            ERV     37
          ENDIF                                                                 ERV     38
c              fraction of the hour the pump operates                           DWHTR2 114
          PMPfrac = PLR                                                         DWHTR2 115
        ELSE                                                                    DWHTR2 116
c              no circulation loop pump - pump runs all hour                    DWHTR2 117
          PMPfrac = 1.0                                                         DWHTR2 118
        ENDIF                                                                   DWHTR2 119
c              do the pump simulation                                           DWHTR2 120
        CALL PumpSupply                                                         DWHTR2 121
c              sum into auxiliary pump kW (equipment only)                      DWHTR2 122
        IF (<lp:PUMP> .NE. 0)  AuxPumpKW = PMPkW                                DWHTR2 123
c              add pump heat to load                                            DWHTR2 124
        EQload    = MIN(0., EQload    + PMPQ)                                   DWHTR2 125
        EQloadNet = EQloadNet + PMPQ                                            -035    52
      ENDIF                                                                     DWHTR2 127
      EQloadNet = MIN(0., EQloadNet)                                            -035    53
c                                                                               DWHTR2 128
      IF (.NOT. RealCall)  THEN                                                 DWHTR2 129
c              this was a call to estimate the load - store for                 DWHTR2 130
c              SYSTEM airside calcs                                             DWHTR2 131
        <dw;Qask> = MIN(EQload, EQloadNet)                                      DWHTR2 132
        IF (<dw:MAX-HTREC> .NE. UNFILD)                                         DWHTR2 133
     &    <dw;Qask> = MAX(EQloadNet, <dw:MAX-HTREC>)                            DWHTR2 134
c              initialize the heat recovery variable for summing                DWHTR2 135
c              by the SYSTEM airside calcs                                      DWHTR2 136
        <dw;Q_RECVR> = 0.                                                       DWHTR2 137
        RETURN                                                                  DWHTR2 138
      ELSE                                                                      DWHTR2 139
c              adjust net load for heat recovered from DX equipment             DWHTR2 140
c              in SYSTEMS                                                       DWHTR2 141
        EQrecvr   = MAX(EQloadNet, <dw;Q_RECVR>)                                DWHTR2 142
        EQloadNet = EQloadNet - EQrecvr                                         DWHTR2 143
c              skip if no net load                                              DWHTR2 144
        IF (EQloadNet .EQ. 0.)  GOTO 1000                                       DWHTR2 145
      ENDIF                                                                     DWHTR2 146
c                                                                               DWHTR2 147
c              Maximum heat that can be provided by heat pump based on          DWHTR2 148
c              heater temperature                                               DWHTR2 149
      Qhp = MIN(0.,<lp;BTUH/GPM-F>                                              DWHTR2 150
     &                       * <pe;GPM> * (<pe;RETURN_T>-<dw:HP-MAX-T>))        DWHTR2 151
     &    + MIN(0., <dw;TANK_BTU/F> * (<dw;TANK_T>-<dw:HP-MAX-T>))              DWHTR2 152
c              Hourly compressor capacity - excludes any heat                   DWHTR2 153
c              provided by tank storage or supplemental heat                    DWHTR2 154
      IF (<pe;OPER_CAPACITY> .NE. 0.)  THEN                                     HVAC28   6
        OperCap = <pe;OPER_CAPACITY>                                            HVAC28   7
      ELSE                                                                      HVAC28   8
        OperCap = <dw:CAP> * CVAL(<dw:CAP-FT>,<dw:HP-MAX-T>,Tambient)           FreeCl  44
      ENDIF                                                                     HVAC28  10
c              limit compressor heat by capacity                                DWHTR2 156
      Qhp     = MAX(Qhp, OperCap)                                               DWHTR2 157
c              Limit net load by capacity (difference, if any will come         DWHTR2 158
c              out of tank storage).  Include supplemental capacity             DWHTR2 159
      EQloadNet = MAX(Qhp+<dw:HP-SUPP-CAP>, MIN(0., EQloadNet))                 DWHTR2 160
c              actual load on compressor                                        DWHTR2 161
      Qhp     = MAX(Qhp, EQloadNet)                                             DWHTR2 162
c                                                                               DWHTR2 163
      IF (Qhp .EQ. 0.)  THEN                                                    Sync    23
        EQelec = 0.                                                             Sync    24
      ELSE                                                                      Sync    25
c              compressor part load ratio including pump heat                   Sync    26
        PLR   = Qhp / OperCap                                                   Sync    27
c              fraction of the hour the tank is heating                         Sync    28
        Frac  = PLR                                                             Sync    29
c              elec input ratio as a function of temperature                    Sync    30
        EIRFT = CVAL(<dw:EIR-FT>,<dw:HP-MAX-T>,Tambient)                        FreeCl  45
c              elec input ratio as a function of part load                      Sync    32
        EIRPLR = CVAL(<dw:EIR-FPLR>,PLR,PLR)                                    Sync    33
c              electric input ratio                                             Sync    34
        EQEIR  = <dw:EIR> * EIRFT * EIRPLR                                      Sync    35
c              compressor electrical consumption                                Sync    36
        EQelec = -OperCap * EQEIR * KWBTU                                       Sync    37
      ENDIF                                                                     Sync    38
c              supplemental heating                                             DWHTR2 176
      EQaux  = EQaux - (EQloadNet-Qhp)*KWBTU                                    DWHTR2 177
c                                                                               DWHTR2 178
 1000 CONTINUE                                                                  DWHTR2 179
c              Tank temperature                                                 DWHTR2 180
      dTtank = ((EQload+<dw;TANK_LOSS>) - (EQloadNet+EQrecvr))                  DWHTR2 181
     &                                                / <dw;TANK_BTU/F>         DWHTR2 182
      <dw;TANK_T> = <dw;TANK_T> + dTtank                                        DWHTR2 183
c                                                                               DWHTR2 184
c              Auxiliary power                                                  DWHTR2 185
      IF (<dw:AUX-KW> .GT. 0.)  THEN                                            DWHTR2 186
c              if always on                                                     DWHTR2 187
        IF (<dw:AUX-MODE> .EQ. Always)  THEN                                    DWHTR2 188
          EQaux = EQaux + <dw:AUX-KW>                                           DWHTR2 189
        ELSEIF (<dw:AUX-MODE> .EQ. WhenOn)  THEN                                DWHTR2 190
          EQaux = EQaux + <dw:AUX-KW> * Frac                                    DWHTR2 191
        ELSEIF (<dw:AUX-MODE> .EQ. WhenOff)  THEN                               DWHTR2 192
          EQaux = EQaux + <dw:AUX-KW> * (1.0 - Frac)                            DWHTR2 193
        ELSE                                                                    Time    28
          EQaux = EQaux + <dw:AUX-KW> * SchVal(<dw:AUX-SCH>, 1.)                Time    29
        ENDIF                                                                   DWHTR2 196
      ENDIF                                                                     DWHTR2 197
c                                                                               DWHTR2 198
c ****         run function : DW_Heater_2-4                                     DWHTR2 199
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        DWHTR2 200
c                                                                               DWHTR2 201
c              report variables                                                 DWHTR2 202
      <dw;Q_RECVR> = EQrecvr                                                    DWHTR2 203
      <dw;KW>      = EQelec + EQaux                                             Sync    39
      <dw;FUEL>    = EQfuel                                                     DWHTR2 205
c                                                                               DWHTR2 207
c              hourly-report variables                                          DWHTR2 208
      IF (<dw;HREP> .NE. 0  .AND.  IRSCH .NE. 0)  THEN                          -041d    8
        Qenvir = <dw;TANK_LOSS>                                                 -041d    9
        CALL HourRepPLT(EQUIPDAT(1), <dw;HREP>, 18, 0)                          -041d   10
      ENDIF                                                                     -041d   11
c                                                                               DWHTR2 211
      RETURN                                                                    DWHTR2 212
      END                                                                       DWHTR2 213
      FUNCTION EffMotor(HP, Class)                                              EffMtr   2
c                                                                               EffMtr   3
c              Returns a value for motor efficiency based on the size           EffMtr   4
c              of the motor.                                                    EffMtr   5
c                                                                               EffMtr   6
c              Data taken from Table B-13, Appendix B, Non-Residential          EffMtr   7
c              Manual, California Title 24, July 1992.                          EffMtr   8
c                                                                               EffMtr   9
c                                                                               EffMtr  10
c              Class = 1  Standard efficiency                                   EffMtr  11
c                      2  NEMA high efficiency                                  EffMtr  12
c                      3  Premium efficiency                                    EffMtr  13
c                                                                               EffMtr  14
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
c                                                                               EffMtr  16
      INTEGER Class                                                             EffMtr  17
      DIMENSION Eff(4,20)                                                       EffMtr  18
c                                                                               EffMtr  19
c                         Motor     Efficiency Class                            EffMtr  20
c                          HP,    Std.    Hi  Premium                           EffMtr  21
      DATA      Eff  /    .05,   .400,  .400,  .400,                            EffMtr  22
     &                    .083,  .490,  .490,  .490,                            EffMtr  23
     &                    .125,  .550,  .550,  .550,                            EffMtr  24
     &                    .167,  .600,  .600,  .600,                            EffMtr  25
     &                    .250,  .640,  .640,  .640,                            EffMtr  26
     &                    .333,  .660,  .660,  .660,                            EffMtr  27
     &                    .500,  .700,  .760,  .800,                            EffMtr  28
     &                    .750,  .720,  .770,  .840,                            EffMtr  29
     &                   1.0,    .790,  .825,  .855,                            EffMtr  30
     &                   1.5,    .800,  .840,  .855,                            EffMtr  31
     &                   2.5,    .800,  .840,  .855,                            EffMtr  32
     &                   3.9,    .810,  .865,  .875,                            EffMtr  33
     &                   6.9,    .820,  .875,  .902,                            EffMtr  34
     &                  12.9,    .850,  .885,  .917,                            EffMtr  35
     &                  17.9,    .860,  .910,  .910,                            EffMtr  36
     &                  20.9,    .870,  .910,  .924,                            EffMtr  37
     &                  29.9,    .880,  .917,  .930,                            EffMtr  38
     &                  69.9,    .890,  .930,  .941,                            EffMtr  39
     &                 139.9,    .900,  .941,  .950,                            EffMtr  40
     &             1000000.0,    .910,  .950,  .962/                            EffMtr  41
c                                                                               EffMtr  42
      DO  I=1,19                                                                EffMtr  43
        IF (HP .LE. Eff(1,I))  THEN                                             EffMtr  44
          EffMotor = Eff(Class+1,I)                                             EffMtr  45
          RETURN                                                                EffMtr  46
        ENDIF                                                                   EffMtr  47
      ENDDO                                                                     EffMtr  48
      EffMotor = Eff(Class+1,20)                                                EffMtr  49
c                                                                               EffMtr  50
      RETURN                                                                    EffMtr  51
      END                                                                       EffMtr  52
      SUBROUTINE EquipCtrl(TotalLoad, TotalCap, LoadSatisfied)                  EQCTRL   2
c                                                                               EQCTRL   3
c              Allocates a load to a set of primary plant equipment             EQCTRL   4
c              using a user-specified control sequence.                         EQCTRL   5
c                                                                               EQCTRL   6
c              Control can be specified for up to 5 load ranges.  The           EQCTRL   7
c              keywords and EDTT variables for each load range are              EQCTRL   8
c              identical except for the number of the range (1-5); this         EQCTRL   9
c              routine uses the EDTT variables of the first range for           EQCTRL  10
c              all ranges.  It does this by successively shifting the           EQCTRL  11
c              value of the component pointer by the range differential.        EQCTRL  12
c                                                                               EQCTRL  13
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               EQCTRL  19
      COMMON  /SimAlg/ Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/ 2
     &                 Electrical,                                              /SIMALG/ 3
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/ 4
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/ 5
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   2
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/ 7
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/ 8
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/ 9
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/10
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    3
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    4
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    5
     &                 Ground_LoopVert_H2,Ground_LoopHoriz_H,                   -044d    6
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/14
      INTEGER          Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/15
     &                 Electrical,                                              /SIMALG/16
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/17
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/18
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   3
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/20
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/21
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/22
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/23
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    7
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    8
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    9
     &                 Ground_LoopVert_H2, Ground_LoopHoriz_H,                  -044d   10
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/27
c                                                                               EQCTRL  21
      LOGICAL   LoadSatisfied                                                   EQCTRL  22
      DIMENSION CapMax(10)                                                      EQCTRL  23
c                                                                               EQCTRL  24
c              total operating capacity enabled                                 EQCTRL  25
      TotalCap    = 0.                                                          EQCTRL  26
c              load to be prorated to enabled equipment                         EQCTRL  27
      ProrateLoad = TotalLoad                                                   EQCTRL  28
      ProrateCap  = 0.                                                          EQCTRL  29
c              LoadSatisfied is true if the total loop capacity that            EQCTRL  30
c              is enabled is greater than the loop load                         EQCTRL  31
      LoadSatisfied = .FALSE.                                                   EQCTRL  32
c              pointer to meter                                                 EQCTRL  33
      Jme = <ec;METER>                                                          EQCTRL  34
c                                                                               EQCTRL  35
c              find the correct range                                           EQCTRL  36
      NumLoadRanges = <ec;NUM_LOAD_RANG>                                        EQCTRL  37
      DO  Nrange=1,NumLoadRanges                                                EQCTRL  38
        IR = Nrange                                                             EQCTRL  39
        IF (<ec:LOADS-THRU> .NE. 0.)  THEN                                      EQCTRL  40
c              user-specified load range                                        EQCTRL  41
          CapRange = <ec:LOADS-THRU>                                            EQCTRL  42
        ELSE                                                                    EQCTRL  43
c              default range to equipment capacity                              EQCTRL  44
          NumEquipInRange = <ec;NUM_EQUIP>    ! using IR index                  EQCTRL  45
          CapRange = 0.                                                         EQCTRL  46
          IIstart = (IR-1)*LoadRangeLength                                      EQCTRL  47
          DO  Neq=1,NumEquipInRange                                             EQCTRL  48
            II  = IIstart + Neq                                                 EQCTRL  49
            Jpe = <ec:EQUIP>                                                    EQCTRL  50
            CapRange = CapRange + MIN(<pe;MAX_CAPACITY>,                        EQCTRL  51
     &                                <ec:EQUIP-MAX-LD>)                        EQCTRL  52
          ENDDO                                                                 EQCTRL  53
c              include tank output                                              EQCTRL  54
          IF (<ec;STORE-SEQ-NUM> .GT. 0)  THEN                                  EQCTRL  55
            Jpe = <ec;STORAGE>                                                  EQCTRL  56
            CapRange = CapRange + MIN(<pe;MAX_CAPACITY>,                        EQCTRL  57
     &                                  <ec:STORE-MAX-LD>)                      EQCTRL  58
          ENDIF                                                                 EQCTRL  59
c              include meter output                                             EQCTRL  60
          IF (<ec;METER-SEQ-NUM> .GT. 0)                                        EQCTRL  61
     &      CapRange = CapRange + MIN(<me;MAX_CAPACITY>,                        EQCTRL  62
     &                                  <ec:METER-MAX-LD>)                      EQCTRL  63
        ENDIF    ! CapRange calc                                                EQCTRL  64
        IF (TotalLoad .LE. CapRange)  EXIT                                      EQCTRL  65
      ENDDO                                                                     EQCTRL  66
c                                                                               EQCTRL  67
c              correct range has been found - get maximum sequence number       EQCTRL  68
      NumEquipInRange = <ec;NUM_EQUIP>    ! using IR index                      EQCTRL  69
      MaxSequenceNum  = <ec;MAX_SEQ_NUM>  ! using IR index                      EQCTRL  70
      DO  Neq=1,NumEquipInRange                                                 EQCTRL  71
        CapMax(Neq) = 0.                                                        EQCTRL  72
      ENDDO                                                                     EQCTRL  73
c                                                                               EQCTRL  74
c              Loop thru and turn on enough equipment to satisfy load.  If      EQCTRL  75
c              any unit of a given sequence number is activated, all            EQCTRL  76
c              equipment having the same sequence number must be activated,     EQCTRL  77
c              even if the load has already been satisfied.                     EQCTRL  78
      IIstart = (IR-1)*LoadRangeLength                                          EQCTRL  79
      DO  NumSeq=1,MaxSequenceNum                                               EQCTRL  80
c              maximum capacity of all equipment having this sequence number    EQCTRL  81
        CapSeq = 0.                                                             EQCTRL  82
        DO  Neq=1,NumEquipInRange                                               EQCTRL  83
          II = IIstart + Neq                                                    EQCTRL  84
          IF (<ec;EQUIP-SEQ-NUM> .EQ. NumSeq)  THEN                             EQCTRL  85
            Jpe = <ec:EQUIP>                                                    EQCTRL  86
c              limit maximum output                                             EQCTRL  87
            CapMax(Neq) = MIN(<pe;MAX_CAPACITY>, <ec:EQUIP-MAX-LD>)             EQCTRL  88
            CapSeq      = CapSeq + CapMax(Neq)                                  EQCTRL  89
          ENDIF                                                                 EQCTRL  90
        ENDDO                                                                   EQCTRL  91
c                                                                               EQCTRL  92
c              check to see if a tank is at this sequence number                EQCTRL  93
        IF (<ec;STORE-SEQ-NUM> .EQ. NumSeq)  THEN                               EQCTRL  94
          Jpe = <ec;STORAGE>                                                    EQCTRL  95
c              maximum tank output                                              EQCTRL  96
          CapTank = MIN(<pe;MAX_CAPACITY>, <ec:STORE-MAX-LD>)                   EQCTRL  97
          IF (CapSeq .EQ. 0.)  THEN                                             EQCTRL  98
c              tank has its own sequence number - tank will supply as           EQCTRL  99
c              much of the remaining load as it can                             EQCTRL 100
            Qtank       = MIN(CapTank, TotalLoad-ProrateCap)                    EQCTRL 101
            ProrateLoad = ProrateLoad  - Qtank                                  EQCTRL 102
            <pe;LOAD>   = Qtank                                                 EQCTRL 103
            TotalCap    = TotalCap + CapTank                                    EQCTRL 104
          ELSE                                                                  EQCTRL 105
c              tank has same sequence number as other equipment -               EQCTRL 106
c              prorate together                                                 EQCTRL 107
            CapSeq = CapSeq + CapTank                                           EQCTRL 108
            Qtank  = 1.0                                                        EQCTRL 109
          ENDIF                                                                 EQCTRL 110
        ENDIF  ! storage                                                        EQCTRL 111
c                                                                               EQCTRL 112
c              check to see if a meter is at this sequence number               EQCTRL 113
        IF (<ec;METER-SEQ-NUM> .EQ. NumSeq)  THEN                               EQCTRL 114
c              maximum meter output                                             EQCTRL 115
          CapMeter = MIN(<me;MAX_CAPACITY>, <ec:METER-MAX-LD>)                  EQCTRL 116
          IF (CapSeq .EQ. 0.)  THEN                                             EQCTRL 117
c              meter has its own sequence number - meter will supply as         EQCTRL 118
c              much of the remaining load as it can                             EQCTRL 119
            Qmeter      = MIN(CapMeter, TotalLoad-ProrateCap)                   EQCTRL 120
            ProrateLoad = ProrateLoad  - Qmeter                                 EQCTRL 121
            <me;LOAD>   = Qmeter                                                EQCTRL 122
            TotalCap    = TotalCap + CapMeter                                   EQCTRL 123
          ELSE                                                                  EQCTRL 124
c              meter has same sequence number as other equipment -              EQCTRL 125
c              prorate together                                                 EQCTRL 126
            CapSeq = CapSeq + CapMeter                                          EQCTRL 127
            Qmeter = 1.0                                                        EQCTRL 128
          ENDIF                                                                 EQCTRL 129
        ENDIF  ! meters                                                         EQCTRL 130
c              increment total loop capacity and proration capacity by          EQCTRL 131
c              new capacity to be prorated                                      EQCTRL 132
        TotalCap   = TotalCap   + CapSeq                                        EQCTRL 133
        ProrateCap = ProrateCap + CapSeq                                        EQCTRL 134
        MaxSequenceReqd = NumSeq                                                GLHX1    9
c              see if equipment activated so far can handle the load            EQCTRL 135
        IF (TotalCap .GT. TotalLoad)  THEN                                      EQCTRL 136
          LoadSatisfied = .TRUE.                                                EQCTRL 137
          EXIT                                                                  EQCTRL 138
        ENDIF                                                                   EQCTRL 139
      ENDDO    ! NumSeq                                                         EQCTRL 140
c                                                                               EQCTRL 141
c                                                                               EQCTRL 142
c              Now prorate the load to all activated equipment.  Load to        EQCTRL 143
c              be prorated cannot be greater than the proration capacity        EQCTRL 144
      IF (ProrateCap .GT. 0.)  THEN                                             GLHX1   10
c              Prorate the load to the equipment                                GLHX1   11
        IF (<ec:PRORATE-LOAD> .EQ. 1)  THEN                                     GLHX1   12
          Prorate = MIN(1., ProrateLoad/ProrateCap)                             GLHX1   13
          DO  Neq=1,NumEquipInRange                                             GLHX1   14
            II        = IIstart + Neq                                           GLHX1   15
            Jpe       = <ec:EQUIP>                                              GLHX1   16
            <pe;LOAD> = CapMax(Neq) * Prorate                                   GLHX1   17
          ENDDO                                                                 GLHX1   18
c              prorate to storage - if Qtank .gt. 1, then tank                  GLHX1   19
c              has an unprorated load                                           GLHX1   20
          IF (<ec;STORAGE> .GT. 0  .AND.  Qtank .EQ. 1.)  THEN                  GLHX1   21
            Jpe       = <ec;STORAGE>                                            GLHX1   22
            <pe;LOAD> = CapTank * Prorate                                       GLHX1   23
          ENDIF                                                                 GLHX1   24
c              prorate to meter - if Qmeter .gt. 1, then meter                  GLHX1   25
c              has an unprorated load                                           GLHX1   26
          IF (Jme .GT. 0  .AND.  Qmeter .EQ. 1.)                                GLHX1   27
     &      <me;LOAD> = CapMeter * Prorate                                      GLHX1   28
        ELSE                                                                    GLHX1   29
c              Fully allocate load to equipment in the sequence order           GLHX1   30
          DO  NumSeq=1,MaxSequenceReqd                                          GLHX1   31
c              Get capacity of all equipment at this sequence number            GLHX1   32
            CapSeq = 0.                                                         GLHX1   33
            DO  Neq=1,NumEquipInRange                                           GLHX1   34
              II = IIstart + Neq                                                GLHX1   35
              IF (<ec;EQUIP-SEQ-NUM> .EQ. NumSeq)  THEN                         GLHX1   36
                Jpe    = <ec:EQUIP>                                             GLHX1   37
                CapSeq = CapSeq + CapMax(Neq)                                   GLHX1   38
              ENDIF                                                             GLHX1   39
            ENDDO                                                               GLHX1   40
c              check to see if a tank is at this sequence number                GLHX1   41
            IF (<ec;STORE-SEQ-NUM> .EQ. NumSeq)  THEN                           GLHX1   42
              IF (<ec;STORAGE> .GT. 0  .AND.  Qtank .EQ. 1.)  THEN              GLHX1   43
                Jpe    = <ec;STORAGE>                                           GLHX1   44
                CapSeq = CapSeq + CapTank                                       GLHX1   45
              ENDIF                                                             GLHX1   46
            ENDIF                                                               GLHX1   47
            IF (<ec;METER-SEQ-NUM> .EQ. NumSeq)  THEN                           GLHX1   48
              IF (Jme .GT. 0  .AND.  Qmeter .EQ. 1.)                            GLHX1   49
     &          CapSeq = CapSeq + CapMeter                                      GLHX1   50
            ENDIF                                                               GLHX1   51
c              now allocate to all equipment at this sequence number            GLHX1   52
            IF (CapSeq .EQ. 0.)  CYCLE                                          -034    24
            Prorate = MIN(1., ProrateLoad/CapSeq)                               GLHX1   54
            DO  Neq=1,NumEquipInRange                                           GLHX1   55
              II = IIstart + Neq                                                GLHX1   56
              IF (<ec;EQUIP-SEQ-NUM> .EQ. NumSeq)  THEN                         GLHX1   57
                Jpe       = <ec:EQUIP>                                          GLHX1   58
                <pe;LOAD> = CapMax(Neq) * Prorate                               GLHX1   59
              ENDIF                                                             GLHX1   60
            ENDDO                                                               GLHX1   61
c              check to see if a tank is at this sequence number                GLHX1   62
            IF (<ec;STORE-SEQ-NUM> .EQ. NumSeq)  THEN                           GLHX1   63
              IF (<ec;STORAGE> .GT. 0  .AND.  Qtank .EQ. 1.)  THEN              GLHX1   64
                Jpe       = <ec;STORAGE>                                        GLHX1   65
                <pe;LOAD> = CapTank * Prorate                                   GLHX1   66
              ENDIF                                                             GLHX1   67
            ENDIF                                                               GLHX1   68
            IF (<ec;METER-SEQ-NUM> .EQ. NumSeq)  THEN                           GLHX1   69
              IF (Jme .GT. 0  .AND.  Qmeter .EQ. 1.)                            GLHX1   70
     &          <me;LOAD> = CapMeter * Prorate                                  GLHX1   71
            ENDIF                                                               GLHX1   72
            ProrateLoad = ProrateLoad - CapSeq                                  GLHX1   73
          ENDDO                                                                 GLHX1   74
        ENDIF                                                                   GLHX1   75
      ENDIF                                                                     GLHX1   76
c                                                                               EQCTRL 163
      RETURN                                                                    EQCTRL 164
      END                                                                       EQCTRL 165
      SUBROUTINE EquipCtrlDefault(Neq,TotalLoad,TotalCap,LoadSatisfied)         EQCTRD   2
c                                                                               EQCTRD   3
c              Finds the combination of primary plant equipment                 EQCTRD   4
c              that best matches the load with equipment loaded                 EQCTRD   5
c              as fully as possible.  Uses the method of comparing              EQCTRD   6
c              all possibilities                                                EQCTRD   7
c                                                                               EQCTRD   8
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               EQCTRD  14
      LOGICAL LoadSatisfied                                                     EQCTRD  15
      INTEGER BestCode                                                          EQCTRD  16
c                                                                               EQCTRD  17
c              total operating capacity enabled                                 EQCTRD  18
      TotalCap = 0.                                                             EQCTRD  19
c              LoadSatisfied is true if an allowable combination that           EQCTRD  20
c              meets the load has been found                                    EQCTRD  21
      LoadSatisfied = .FALSE.                                                   EQCTRD  22
c              BestCap is the capacity of the combination which is              EQCTRD  23
c              best so far                                                      EQCTRD  24
      BestCap = 0.                                                              EQCTRD  25
c              BestCode is the code number for the best combination             EQCTRD  26
c              so far                                                           EQCTRD  27
      BestCode = 0                                                              EQCTRD  28
c              dPLR is the absolute value of the difference between             EQCTRD  29
c              a 100% load and that of the best combination so far              EQCTRD  30
      dPLR = 1.E25                                                              EQCTRD  31
c                                                                               EQCTRD  32
c              determine the capacity based on last hours equipment mix         EQCTRD  33
      CapLastHour = 0.                                                          EQCTRD  34
      LastHourOn  = 1                                                           EQCTRD  35
      DO  IQ=1,Neq                                                              EQCTRD  36
        Jpe = <lp;Jpe>                                                          EQCTRD  37
        IF (<pe;HOURS_OFF> .EQ. 0)                                              EQCTRD  38
     &    CapLastHour = CapLastHour + <pe;MAX_CAPACITY>                         EQCTRD  39
      ENDDO                                                                     EQCTRD  40
c             go back another hour if no equipment last hour                    EQCTRD  41
      IF (CapLastHour .EQ. 0.)  THEN                                            EQCTRD  42
        LastHourOn = 2                                                          EQCTRD  43
        DO  IQ=1,Neq                                                            EQCTRD  44
          Jpe = <lp;Jpe>                                                        EQCTRD  45
          IF (<pe;HOURS_OFF> .EQ. 1)                                            EQCTRD  46
     &      CapLastHour = CapLastHour + <pe;MAX_CAPACITY>                       EQCTRD  47
        ENDDO                                                                   EQCTRD  48
      ENDIF                                                                     EQCTRD  49
c                                                                               EQCTRD  50
c              loop thru the combinations                                       EQCTRD  51
      Ncombs = <lp;NCOMB_EQUIP>                                                 EQCTRD  52
      DO  M=1,Ncombs                                                            EQCTRD  53
c              calculate the operating ratio for this combination               EQCTRD  54
        MQ     = M                                                              EQCTRD  55
        CapOp  = 0.                                                             EQCTRD  56
        DO  IQ=1,Neq                                                            EQCTRD  57
          MX    = MQ / 2                                                        EQCTRD  58
          Jpe   = <lp;Jpe>                                                      EQCTRD  59
          CapOp = CapOp + FLOAT(MQ - 2*MX) * <pe;MAX_CAPACITY>                  EQCTRD  60
          MQ    = MX                                                            EQCTRD  61
        ENDDO                                                                   EQCTRD  62
c              if this combination cannot be allowed, then skip it              EQCTRD  63
        IF ((CapOp .LT. TotalLoad) .AND.                                        EQCTRD  64
     &             (LoadSatisfied .OR. (CapOp .LE. BestCap)))  CYCLE            EQCTRD  65
c              if this combination is an improvement, then record it            EQCTRD  66
        dPLRnew = ABS(TotalLoad/CapOp - 1.)                                     EQCTRD  67
        IF (LoadSatisfied .AND. (dPLRnew .GE. dPLR))  CYCLE                     EQCTRD  68
        LoadSatisfied = (CapOp .GE. TotalLoad)                                  EQCTRD  69
        BestCap       = CapOp                                                   EQCTRD  70
        dPLR          = dPLRnew                                                 EQCTRD  71
        BestCode      = M                                                       EQCTRD  72
      ENDDO                                                                     EQCTRD  73
c                                                                               EQCTRD  74
c              Now allocate the load to the equipment                           EQCTRD  75
      IF (LoadSatisfied)  THEN                                                  EQCTRD  76
c              Load was satisfied - allocate to the best combination            EQCTRD  77
c              Keep the same mix as operated last hour unless new capacity      EQCTRD  78
c              mix is 20% better.  Otherwise startup loads may become           EQCTRD  79
c              excessive                                                        EQCTRD  80
        IF (CapLastHour .GT. TotalLoad  .AND.                                   EQCTRD  81
     &        ABS(CapLastHour-BestCap)/CapLastHour .LT. 0.2)  THEN              EQCTRD  82
c              retain last hours mix                                            EQCTRD  83
          IF (LastHourOn .EQ. 1)  THEN                                          EQCTRD  84
            DO  IQ=1,Neq                                                        EQCTRD  85
              Jpe = <lp;Jpe>                                                    EQCTRD  86
              IF (<pe;HOURS_OFF> .EQ. 0)  THEN                                  -035    55
                <pe;LOAD> = <pe;MAX_CAPACITY>/CapLastHour * TotalLoad           -035    56
              ELSE                                                              -035    57
                <pe;LOAD> = 0.                                                  -035    58
              ENDIF                                                             -035    59
            ENDDO                                                               EQCTRD  89
          ELSE                                                                  EQCTRD  90
            DO  IQ=1,Neq                                                        EQCTRD  91
              Jpe = <lp;Jpe>                                                    EQCTRD  92
              IF (<pe;HOURS_OFF> .EQ. 1)  THEN                                  -035    60
                <pe;LOAD> = <pe;MAX_CAPACITY>/CapLastHour * TotalLoad           -035    61
              ELSE                                                              -035    62
                <pe;LOAD> = 0.                                                  -035    63
              ENDIF                                                             -035    64
            ENDDO                                                               EQCTRD  95
          ENDIF                                                                 EQCTRD  96
          TotalCap = CapLastHour                                                EQCTRD  97
        ELSE                                                                    EQCTRD  98
c              equipment wasn't running last hour, or this is a much            EQCTRD  99
c              better mix                                                       EQCTRD 100
          DO  IQ=1,Neq                                                          EQCTRD 101
            MX        = BestCode / 2                                            EQCTRD 102
c              note that NumOp is either 0 or 1                                 EQCTRD 103
            NumOp     = BestCode - 2*MX                                         EQCTRD 104
c              prorate the load                                                 EQCTRD 105
            Jpe       = <lp;Jpe>                                                EQCTRD 106
            <pe;LOAD> = FLOAT(NumOp) * <pe;MAX_CAPACITY>/BestCap                EQCTRD 107
     &                               * TotalLoad                                EQCTRD 108
c              if unit is turned on, must have non-zero load                    EQCTRD 109
            IF (NumOp .GT. 0)  THEN                                             EQCTRD 110
              <pe;LOAD> = MAX(1., <pe;LOAD>)                                    EQCTRD 111
              TotalCap  = TotalCap + <pe;MAX_CAPACITY>                          EQCTRD 112
            ENDIF                                                               EQCTRD 113
            BestCode    = MX                                                    EQCTRD 114
          ENDDO                                                                 EQCTRD 115
        ENDIF                                                                   EQCTRD 116
      ELSE                                                                      EQCTRD 117
c              Load was not satisfied - turn on all equipment                   EQCTRD 118
c              first, get maximum capacity of all equipment                     EQCTRD 119
c              load was not satisfied - turn on all equipment                   EQCTRD 120
        DO  IQ=1,Neq                                                            EQCTRD 121
          Jpe       = <lp;Jpe>                                                  EQCTRD 122
          <pe;LOAD> = <pe;MAX_CAPACITY>                                         EQCTRD 123
          TotalCap  = TotalCap + <pe;MAX_CAPACITY>                              EQCTRD 124
        ENDDO                                                                   EQCTRD 125
      ENDIF                                                                     EQCTRD 126
c                                                                               EQCTRD 127
      RETURN                                                                    EQCTRD 128
      END                                                                       EQCTRD 129
      SUBROUTINE EquipCtrlDefaultElec(TotalLoad, TotalCap)                      EqCtrE   2
c                                                                               EqCtrE   3
c              Allocates electric loads to generation                           EqCtrE   4
c              equipment when elec tracking and                                 EqCtrE   5
c              no EQUIP-CTRL is specified.                                      EqCtrE   6
c                                                                               EqCtrE   7
c              Finds the combination of generation equipment                    EqCtrE   8
c              that best matches the load with equipment loaded                 EqCtrE   9
c              as fully as possible.  Uses the method of comparing              EqCtrE  10
c              all possibilities.                                               EqCtrE  11
c                                                                               EqCtrE  12
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               EqCtrE  16
c                                                                               EqCtrE  17
      LOGICAL LoadSatisfied                                                     EqCtrE  18
      INTEGER BestCode                                                          EqCtrE  19
c                                                                               EqCtrE  20
c              total operating capacity enabled                                 EqCtrE  21
      TotalCap = 0.                                                             EqCtrE  22
c              LoadSatisfied is true if an allowable combination that           EqCtrE  23
c              meets the load has been found                                    EqCtrE  24
      LoadSatisfied = .FALSE.                                                   EqCtrE  25
c              BestCap is the capacity of the combination which is              EqCtrE  26
c              best so far                                                      EqCtrE  27
      BestCap = 0.                                                              EqCtrE  28
c              BestCode is the code number for the best combination             EqCtrE  29
c              so far                                                           EqCtrE  30
      BestCode = 0                                                              EqCtrE  31
c              dPLR is the absolute value of the difference between             EqCtrE  32
c              a 100% load and that of the best combination so far              EqCtrE  33
      dPLR = 1.E25                                                              EqCtrE  34
c              Number of attached heat recovery components                      EqCtrE  35
      Neq = <em;NumCogen>                                                       EqCtrE  36
c                                                                               EqCtrE  37
c              determine the capacity based on last hours equipment mix         EqCtrE  38
      CapLastHour = 0.                                                          EqCtrE  39
      LastHourOn  = 1                                                           EqCtrE  40
      DO  IQ=1,Neq                                                              EqCtrE  41
        Jpe = <em;CogenJpePtrs>                                                 EqCtrE  42
        IF (<pe;HOURS_OFF> .EQ. 0)                                              EqCtrE  43
     &    CapLastHour = CapLastHour + <pe;MAX_CAPACITY>                         EqCtrE  44
      ENDDO                                                                     EqCtrE  45
c             go back another hour if no equipment last hour                    EqCtrE  46
      IF (CapLastHour .EQ. 0.)  THEN                                            EqCtrE  47
        LastHourOn = 2                                                          EqCtrE  48
        DO  IQ=1,Neq                                                            EqCtrE  49
          Jpe = <em;CogenJpePtrs>                                               EqCtrE  50
          IF (<pe;HOURS_OFF> .EQ. 1)                                            EqCtrE  51
     &      CapLastHour = CapLastHour + <pe;MAX_CAPACITY>                       EqCtrE  52
        ENDDO                                                                   EqCtrE  53
      ENDIF                                                                     EqCtrE  54
c                                                                               EqCtrE  55
c              loop thru the combinations                                       EqCtrE  56
      Ncombs = <em;NumCogenCombs>                                               EqCtrE  57
      DO  M=1,Ncombs                                                            EqCtrE  58
c              calculate the operating ratio for this combination               EqCtrE  59
        MQ     = M                                                              EqCtrE  60
        CapOp  = 0.                                                             EqCtrE  61
        DO  IQ=1,Neq                                                            EqCtrE  62
          MX    = MQ / 2                                                        EqCtrE  63
          Jpe   = <em;CogenJpePtrs>                                             EqCtrE  64
          CapOp = CapOp + FLOAT(MQ - 2*MX) * <pe;MAX_CAPACITY>                  EqCtrE  65
          MQ    = MX                                                            EqCtrE  66
        ENDDO                                                                   EqCtrE  67
c              if this combination cannot be allowed, then skip it              EqCtrE  68
        IF ((CapOp .LT. TotalLoad) .AND.                                        EqCtrE  69
     &             (LoadSatisfied .OR. (CapOp .LE. BestCap)))  CYCLE            EqCtrE  70
c              if this combination is an improvement, then record it            EqCtrE  71
        dPLRnew = ABS(TotalLoad/CapOp - 1.)                                     EqCtrE  72
        IF (LoadSatisfied .AND. (dPLRnew .GE. dPLR))  CYCLE                     EqCtrE  73
        LoadSatisfied = (CapOp .GE. TotalLoad)                                  EqCtrE  74
        BestCap       = CapOp                                                   EqCtrE  75
        dPLR          = dPLRnew                                                 EqCtrE  76
        BestCode      = M                                                       EqCtrE  77
      ENDDO                                                                     EqCtrE  78
c                                                                               EqCtrE  79
c              Now allocate the load to the equipment                           EqCtrE  80
      IF (LoadSatisfied)  THEN                                                  EqCtrE  81
c              Load was satisfied - allocate to the best combination            EqCtrE  82
c              Keep the same mix as operated last hour unless new capacity      EqCtrE  83
c              mix is 20% better.  Otherwise startup loads may become           EqCtrE  84
c              excessive                                                        EqCtrE  85
        IF (CapLastHour .GT. TotalLoad  .AND.                                   EqCtrE  86
     &        ABS(CapLastHour-BestCap)/CapLastHour .LT. 0.2)  THEN              EqCtrE  87
c              retain last hours mix                                            EqCtrE  88
          IF (LastHourOn .EQ. 1)  THEN                                          EqCtrE  89
            DO  IQ=1,Neq                                                        EqCtrE  90
              Jpe = <em;CogenJpePtrs>                                           EqCtrE  91
              IF (<pe;HOURS_OFF> .EQ. 0)                                        EqCtrE  92
     &          <pe;LOAD> = <pe;MAX_CAPACITY>/CapLastHour * TotalLoad           EqCtrE  93
            ENDDO                                                               EqCtrE  94
          ELSE                                                                  EqCtrE  95
            DO  IQ=1,Neq                                                        EqCtrE  96
              Jpe = <em;CogenJpePtrs>                                           EqCtrE  97
              IF (<pe;HOURS_OFF> .EQ. 1)                                        EqCtrE  98
     &          <pe;LOAD> = <pe;MAX_CAPACITY>/CapLastHour * TotalLoad           EqCtrE  99
            ENDDO                                                               EqCtrE 100
          ENDIF                                                                 EqCtrE 101
          TotalCap = CapLastHour                                                EqCtrE 102
        ELSE                                                                    EqCtrE 103
c              equipment wasn't running last hour, or this is a much            EqCtrE 104
c              better mix                                                       EqCtrE 105
          DO  IQ=1,Neq                                                          EqCtrE 106
            MX        = BestCode / 2                                            EqCtrE 107
c              note that NumOp is either 0 or 1                                 EqCtrE 108
            NumOp     = BestCode - 2*MX                                         EqCtrE 109
c              prorate the load                                                 EqCtrE 110
            Jpe       = <em;CogenJpePtrs>                                       EqCtrE 111
            <pe;LOAD> = FLOAT(NumOp) * <pe;MAX_CAPACITY>/BestCap                EqCtrE 112
     &                               * TotalLoad                                EqCtrE 113
c              if unit is turned on, must have non-zero load                    EqCtrE 114
            IF (NumOp .GT. 0)  THEN                                             EqCtrE 115
              <pe;LOAD> = MAX(0.001, <pe;LOAD>)                                 EqCtrE 116
              TotalCap  = TotalCap + <pe;MAX_CAPACITY>                          EqCtrE 117
            ENDIF                                                               EqCtrE 118
            BestCode    = MX                                                    EqCtrE 119
          ENDDO                                                                 EqCtrE 120
        ENDIF                                                                   EqCtrE 121
      ELSE                                                                      EqCtrE 122
c              Load was not satisfied - turn on all equipment                   EqCtrE 123
c              first, get maximum capacity of all equipment                     EqCtrE 124
c              load was not satisfied - turn on all equipment                   EqCtrE 125
        DO  IQ=1,Neq                                                            EqCtrE 126
          Jpe       = <em;CogenJpePtrs>                                         EqCtrE 127
          <pe;LOAD> = <pe;MAX_CAPACITY>                                         EqCtrE 128
          TotalCap  = TotalCap + <pe;MAX_CAPACITY>                              EqCtrE 129
        ENDDO                                                                   EqCtrE 130
      ENDIF                                                                     EqCtrE 131
c                                                                               EqCtrE 132
      RETURN                                                                    EqCtrE 133
      END                                                                       EqCtrE 134
      SUBROUTINE EquipCtrlDefaultHtrec(TotalLoad, TotalCap)                     EqCtrH   2
c                                                                               EqCtrH   3
c              Allocates heating loads to heat recovery                         EqCtrH   4
c              equipment when thermal tracking and                              EqCtrH   5
c              no EQUIP-CTRL is specified.                                      EqCtrH   6
c                                                                               EqCtrH   7
c              Finds the combination of heat recovery equipment                 EqCtrH   8
c              that best matches the load with equipment loaded                 EqCtrH   9
c              as fully as possible.  Uses the method of comparing              EqCtrH  10
c              all possibilities.                                               EqCtrH  11
c                                                                               EqCtrH  12
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               EqCtrH  16
c                                                                               EqCtrH  17
      LOGICAL LoadSatisfied                                                     EqCtrH  18
      INTEGER BestCode                                                          EqCtrH  19
c                                                                               EqCtrH  20
c              total operating capacity enabled                                 EqCtrH  21
      TotalCap = 0.                                                             EqCtrH  22
c              LoadSatisfied is true if an allowable combination that           EqCtrH  23
c              meets the load has been found                                    EqCtrH  24
      LoadSatisfied = .FALSE.                                                   EqCtrH  25
c              BestCap is the capacity of the combination which is              EqCtrH  26
c              best so far                                                      EqCtrH  27
      BestCap = 0.                                                              EqCtrH  28
c              BestCode is the code number for the best combination             EqCtrH  29
c              so far                                                           EqCtrH  30
      BestCode = 0                                                              EqCtrH  31
c              dPLR is the absolute value of the difference between             EqCtrH  32
c              a 100% load and that of the best combination so far              EqCtrH  33
      dPLR = 1.E25                                                              EqCtrH  34
c              Number of attached heat recovery components                      EqCtrH  35
      Neq = <lp;NumHtRcvr>                                                      EqCtrH  36
c                                                                               EqCtrH  37
c              determine the capacity based on last hours equipment mix         EqCtrH  38
      CapLastHour = 0.                                                          EqCtrH  39
      LastHourOn  = 1                                                           EqCtrH  40
      DO  IQ=1,Neq                                                              EqCtrH  41
        Jpe = <lp;Jpe_HtRcvr>                                                   EqCtrH  42
        IF (<pe;HOURS_OFF> .EQ. 0)                                              EqCtrH  43
     &    CapLastHour = CapLastHour + <pe;MAX_CAPACITY>                         EqCtrH  44
      ENDDO                                                                     EqCtrH  45
c             go back another hour if no equipment last hour                    EqCtrH  46
      IF (CapLastHour .EQ. 0.)  THEN                                            EqCtrH  47
        LastHourOn = 2                                                          EqCtrH  48
        DO  IQ=1,Neq                                                            EqCtrH  49
          Jpe = <lp;Jpe_HtRcvr>                                                 EqCtrH  50
          IF (<pe;HOURS_OFF> .EQ. 1)                                            EqCtrH  51
     &      CapLastHour = CapLastHour + <pe;MAX_CAPACITY>                       EqCtrH  52
        ENDDO                                                                   EqCtrH  53
      ENDIF                                                                     EqCtrH  54
c                                                                               EqCtrH  55
c              loop thru the combinations                                       EqCtrH  56
      Ncombs = <lp;NumHtRcvrComb>                                               EqCtrH  57
      DO  M=1,Ncombs                                                            EqCtrH  58
c              calculate the operating ratio for this combination               EqCtrH  59
        MQ     = M                                                              EqCtrH  60
        CapOp  = 0.                                                             EqCtrH  61
        DO  IQ=1,Neq                                                            EqCtrH  62
          MX    = MQ / 2                                                        EqCtrH  63
          Jpe   = <lp;Jpe_HtRcvr>                                               EqCtrH  64
          CapOp = CapOp + FLOAT(MQ - 2*MX) * <pe;MAX_CAPACITY>                  EqCtrH  65
          MQ    = MX                                                            EqCtrH  66
        ENDDO                                                                   EqCtrH  67
c              if this combination cannot be allowed, then skip it              EqCtrH  68
        IF ((CapOp .LT. TotalLoad) .AND.                                        EqCtrH  69
     &             (LoadSatisfied .OR. (CapOp .LE. BestCap)))  CYCLE            EqCtrH  70
c              if this combination is an improvement, then record it            EqCtrH  71
        dPLRnew = ABS(TotalLoad/CapOp - 1.)                                     EqCtrH  72
        IF (LoadSatisfied .AND. (dPLRnew .GE. dPLR))  CYCLE                     EqCtrH  73
        LoadSatisfied = (CapOp .GE. TotalLoad)                                  EqCtrH  74
        BestCap       = CapOp                                                   EqCtrH  75
        dPLR          = dPLRnew                                                 EqCtrH  76
        BestCode      = M                                                       EqCtrH  77
      ENDDO                                                                     EqCtrH  78
c                                                                               EqCtrH  79
c              Now allocate the load to the equipment                           EqCtrH  80
      IF (LoadSatisfied)  THEN                                                  EqCtrH  81
c              Load was satisfied - allocate to the best combination            EqCtrH  82
c              Keep the same mix as operated last hour unless new capacity      EqCtrH  83
c              mix is 20% better.  Otherwise startup loads may become           EqCtrH  84
c              excessive                                                        EqCtrH  85
        IF (CapLastHour .GT. TotalLoad  .AND.                                   EqCtrH  86
     &        ABS(CapLastHour-BestCap)/CapLastHour .LT. 0.2)  THEN              EqCtrH  87
c              retain last hours mix                                            EqCtrH  88
          IF (LastHourOn .EQ. 1)  THEN                                          EqCtrH  89
            DO  IQ=1,Neq                                                        EqCtrH  90
              Jpe = <lp;Jpe_HtRcvr>                                             EqCtrH  91
              IF (<pe;HOURS_OFF> .EQ. 0)                                        EqCtrH  92
     &          <pe;LOAD> = <pe;MAX_CAPACITY>/CapLastHour * TotalLoad           EqCtrH  93
            ENDDO                                                               EqCtrH  94
          ELSE                                                                  EqCtrH  95
            DO  IQ=1,Neq                                                        EqCtrH  96
              Jpe = <lp;Jpe_HtRcvr>                                             EqCtrH  97
              IF (<pe;HOURS_OFF> .EQ. 1)                                        EqCtrH  98
     &          <pe;LOAD> = <pe;MAX_CAPACITY>/CapLastHour * TotalLoad           EqCtrH  99
            ENDDO                                                               EqCtrH 100
          ENDIF                                                                 EqCtrH 101
          TotalCap = CapLastHour                                                EqCtrH 102
        ELSE                                                                    EqCtrH 103
c              equipment wasn't running last hour, or this is a much            EqCtrH 104
c              better mix                                                       EqCtrH 105
          DO  IQ=1,Neq                                                          EqCtrH 106
            MX        = BestCode / 2                                            EqCtrH 107
c              note that NumOp is either 0 or 1                                 EqCtrH 108
            NumOp     = BestCode - 2*MX                                         EqCtrH 109
c              prorate the load                                                 EqCtrH 110
            Jpe       = <lp;Jpe_HtRcvr>                                         EqCtrH 111
            <pe;LOAD> = FLOAT(NumOp) * <pe;MAX_CAPACITY>/BestCap                EqCtrH 112
     &                               * TotalLoad                                EqCtrH 113
c              if unit is turned on, must have non-zero load                    EqCtrH 114
            IF (NumOp .GT. 0)  THEN                                             EqCtrH 115
              <pe;LOAD> = MAX(1., <pe;LOAD>)                                    EqCtrH 116
              TotalCap  = TotalCap + <pe;MAX_CAPACITY>                          EqCtrH 117
            ENDIF                                                               EqCtrH 118
            BestCode    = MX                                                    EqCtrH 119
          ENDDO                                                                 EqCtrH 120
        ENDIF                                                                   EqCtrH 121
      ELSE                                                                      EqCtrH 122
c              Load was not satisfied - turn on all equipment                   EqCtrH 123
c              first, get maximum capacity of all equipment                     EqCtrH 124
c              load was not satisfied - turn on all equipment                   EqCtrH 125
        DO  IQ=1,Neq                                                            EqCtrH 126
          Jpe       = <lp;Jpe_HtRcvr>                                           EqCtrH 127
          <pe;LOAD> = <pe;MAX_CAPACITY>                                         EqCtrH 128
          TotalCap  = TotalCap + <pe;MAX_CAPACITY>                              EqCtrH 129
        ENDDO                                                                   EqCtrH 130
      ENDIF                                                                     EqCtrH 131
c                                                                               EqCtrH 132
      RETURN                                                                    EqCtrH 133
      END                                                                       EqCtrH 134
      SUBROUTINE EquipCtrlSetup                                                 EQCTRS   2
c                                                                               EQCTRS   3
c              Sets up the parameters for the user-specified                    EQCTRS   4
c              EQUIP-CTRL sequences for primary equipment                       EQCTRS   5
c                                                                               EQCTRS   6
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               EQCTRS  13
      COMMON  /SimAlg/ Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/ 2
     &                 Electrical,                                              /SIMALG/ 3
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/ 4
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/ 5
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   2
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/ 7
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/ 8
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/ 9
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/10
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    3
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    4
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    5
     &                 Ground_LoopVert_H2,Ground_LoopHoriz_H,                   -044d    6
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/14
      INTEGER          Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/15
     &                 Electrical,                                              /SIMALG/16
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/17
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/18
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   3
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/20
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/21
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/22
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/23
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    7
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    8
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    9
     &                 Ground_LoopVert_H2, Ground_LoopHoriz_H,                  -044d   10
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/27
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
c                                                                               EQCTRS  15
      INTEGER ecTYPE                                                            EQCTRS  16
c                                                                               EQCTRS  17
c              find the offset between successive load ranges                   EQCTRS  18
      Jec = Iec                                                                 EQCTRS  19
      LoadRangeLength = IndexPosition(<ec:EQUIP>,                               EQCTRS  20
     &                                <ec:EQUIP2>,2) - 1                        EQCTRS  21
c                                                                               EQCTRS  22
c              set up each EQUIP-CTRL sequence                                  EQCTRS  23
      DO  Nctrl=1,Nec                                                           EQCTRS  24
c              pointer to this sequence's data                                  EQCTRS  25
        Jec     = Iec + (Nctrl-1)*Lec                                           EQCTRS  26
c              type of load                                                     EQCTRS  27
        ecTYPE = <ec:TYPE>                                                      EQCTRS  28
c              identify type of load, and set component indexing variables      EQCTRS  29
        SELECT CASE (ecTYPE)                                                    EQCTRS  30
          CASE (1)  ! Cooling loops                                             EQCTRS  31
            Jlp       = Ilp + (<ec:LOOP>-1)*Llp                                 EQCTRS  32
            <ec:LOOP> = Jlp                                                     EQCTRS  33
c              set pointer to cold storage and CHW-METER                        EQCTRS  34
            <ec;STORAGE> = <lp;COLD_STORAGE>                                    EQCTRS  35
            <ec;METER>   = <lp;CHW_METER>                                       EQCTRS  36
          CASE (2)  ! Heating loops                                             EQCTRS  37
            Jlp       = Ilp + (<ec:LOOP>-1)*Llp                                 EQCTRS  38
            <ec:LOOP> = Jlp                                                     EQCTRS  39
c              set pointer to hot storage and STEAM-METER                       EQCTRS  40
            <ec;STORAGE> = <lp;HOT_STORAGE>                                     EQCTRS  41
            <ec;METER>   = <lp;STEAM_METER>                                     EQCTRS  42
          CASE (3)  ! DHW loops                                                 EQCTRS  43
            Jlp       = Ilp + (<ec:LOOP>-1)*Llp                                 EQCTRS  44
            <ec:LOOP> = Jlp                                                     EQCTRS  45
c              set pointer to STEAM-METER                                       EQCTRS  46
            <ec;METER>   = <lp;STEAM_METER>                                     EQCTRS  47
          CASE (4)  ! Heat rejection                                            EQCTRS  48
            Jlp       = Ilp + (<ec:LOOP>-1)*Llp                                 EQCTRS  49
            <ec:LOOP> = Jlp                                                     EQCTRS  50
          CASE (5)  ! Electrical                                                EQCTRS  51
            Jem = Iem + (<ec:ELEC-METER>-1)*Lem                                 EQCTRS  52
            <ec:ELEC-METER> = Jem                                               EQCTRS  53
            <ec;METER>      = Jem                                               EQCTRS  54
        END SELECT  ! ecTYPE                                                    EQCTRS  55
c                                                                               EQCTRS  56
c              cycle thru each load range (5 maximum)                           EQCTRS  57
        DO  IR=1,5                                                              EQCTRS  58
          IIstart = (IR-1)*LoadRangeLength + 1                                  EQCTRS  59
          IIend   = IIstart + LoadRangeLength-1                                 EQCTRS  60
          II      = IIstart                                                     EQCTRS  61
          IH      = II                                                          EQCTRS  62
c              skip if no equipment or meter in this range                      EQCTRS  63
          IF (<ec:LOADS-THRU> .EQ. 0.  .AND.  <ec:EQUIP>  .EQ. 0                EQCTRS  64
     &                                 .AND.  <ec:CH/HTR> .EQ. 0                EQCTRS  65
     &                                 .AND.  <ec:GEN>    .EQ. 0                EQCTRS  66
     &                           .AND.  <ec;METER-SEQ-NUM> .EQ. 0)  EXIT        EQCTRS  67
c              equipment found                                                  EQCTRS  68
          NumLoadRanges  = IR                                                   EQCTRS  69
c              convert MBtu to Btu (heat rejection is in gpm)                   EQCTRS  70
          IF (ecTYPE .NE. HeatRejection  .AND.  ecTYPE .NE. Electrical)         EQCTRS  71
     &        <ec:LOADS-THRU> = <ec:LOADS-THRU> * 1.E6                          EQCTRS  72
c              largest sequence number in this load range                       EQCTRS  73
          MaxSequenceNum = 0                                                    EQCTRS  74
c              number of equipment units in this load range                     EQCTRS  75
          NumEquipInRange = 0                                                   EQCTRS  76
          DO  II=IIstart,IIend                                                  EQCTRS  77
            IF (<ec:EQUIP> .GT. 0)  THEN                                        EQCTRS  78
              NumEquipInRange = II                                              EQCTRS  79
c              Substitute the Jpe component pointer for the component number    EQCTRS  80
              SELECT CASE (ecTYPE)                                              EQCTRS  81
                CASE (1)  ! Cooling loops                                       EQCTRS  82
                  Jch = Ich + (<ec:EQUIP>-1)*Lch                                EQCTRS  83
                  Jpe = <ch;Jpe>                                                EQCTRS  84
                CASE (2)  ! Heating loops                                       EQCTRS  85
                  Jbl = Ibl + (<ec:EQUIP>-1)*Lbl                                EQCTRS  86
                  Jpe = <bl;Jpe>                                                EQCTRS  87
                CASE (3)  ! DHW loops                                           EQCTRS  88
                  Jdw = Idw + (<ec:EQUIP>-1)*Ldw                                EQCTRS  89
                  Jpe = <dw;Jpe>                                                EQCTRS  90
                CASE (4)  ! Heat rejection                                      EQCTRS  91
                  Jtw = Itw + (<ec:EQUIP>-1)*Ltw                                EQCTRS  92
                  Jpe = <tw;Jpe>                                                EQCTRS  93
                CASE (5)  ! Electrical                                          EQCTRS  94
                  Jgn = Ign + (<ec:EQUIP>-1)*Lgn                                EQCTRS  95
                  Jpe = <gn;Jpe>                                                EQCTRS  96
              END SELECT  ! ecTYPE                                              EQCTRS  97
              <ec:EQUIP> = Jpe                                                  EQCTRS  98
c              convert real start sequence numbers to integer                   EQCTRS  99
              <ec;EQUIP-SEQ-NUM> = INT(<ec:EQUIP-SEQ-R>+.1)                     EQCTRS 100
              MaxSequenceNum     = MAX(MaxSequenceNum,                          EQCTRS 101
     &                                  <ec;EQUIP-SEQ-NUM>)                     EQCTRS 102
c              convert MBtu to Btu                                              EQCTRS 103
              IF (ecTYPE .NE. HeatRejection                                     EQCTRS 104
     &                                    .AND.  ecTYPE .NE. Electrical)        EQCTRS 105
     &            <ec:EQUIP-MAX-LD> = <ec:EQUIP-MAX-LD> * 1.E6                  EQCTRS 106
            ELSE                                                                EQCTRS 107
              NumEquipInRange = NumEquipInRange - (IR-1)*LoadRangeLength        EQCTRS 108
              EXIT                                                              EQCTRS 109
            ENDIF                                                               EQCTRS 110
          ENDDO                                                                 EQCTRS 111
c                                                                               EQCTRS 112
c              set up storage and meter sequence numbers, if any                EQCTRS 113
          <ec;STORE-SEQ-NUM> = INT(<ec:STORE-SEQ-R>+.1)                         EQCTRS 114
c              force storage sequence to zero if no storage                     EQCTRS 115
          IF (<ec;STORE-SEQ-NUM> .GT. 0 .AND. <ec;STORAGE> .EQ. 0)  THEN        EQCTRS 116
            CALL MSGSIM(-2,II,II,II,II)                                         EQCTRS 117
            WRITE (IOUTPT, 9100)  (<ec:NAME>,II=1,8)                            EQCTRS 118
            <ec;STORE-SEQ-NUM> = 0                                              EQCTRS 119
          ENDIF                                                                 EQCTRS 120
          MaxSequenceNum     = MAX(MaxSequenceNum,                              EQCTRS 121
     &                              <ec;STORE-SEQ-NUM>)                         EQCTRS 122
          <ec:STORE-MAX-LD>  = <ec:STORE-MAX-LD> * 1.E6                         EQCTRS 123
          <ec;METER-SEQ-NUM> = INT(<ec:METER-SEQ-R>+.1)                         EQCTRS 124
          MaxSequenceNum     = MAX(MaxSequenceNum,                              EQCTRS 125
     &                              <ec;METER-SEQ-NUM>)                         EQCTRS 126
          IF (ecTYPE .NE. HeatRejection  .AND.  ecTYPE .NE. Electrical)         EQCTRS 127
     &      <ec:METER-MAX-LD>  = <ec:METER-MAX-LD> * 1.E6                       EQCTRS 128
c                                                                               EQCTRS 129
c              Check to see if any chiller/heaters in heating mode attached     EQCTRS 130
          IF (<ec:CH/HTR> .GT. 0  .AND.  ecTYPE .EQ. 2)  THEN                   GLHX1   77
c              Move the chiller/heaters into the unfilled positions             EQCTRS 132
c              of the EQUIP- variables.  Note that EQUIP- variables use         EQCTRS 133
c              the II index, while chiller/heaters use IH                       EQCTRS 134
            JUnFilled = IIstart-1 + NumEquipInRange + 1                         EQCTRS 135
            DO  II=JUnFilled,IIend                                              EQCTRS 136
              IF (<ec:CH/HTR> .GT. 0)  THEN                                     EQCTRS 137
                Jch                = ICH + (<ec:CH/HTR>-1)*Lch                  EQCTRS 138
c              point to ghost containing heating variables                      EQCTRS 139
                Jpe                = <ch;Jpe_HEAT>                              EQCTRS 140
                <ec:EQUIP>         = Jpe                                        EQCTRS 141
                <ec;EQUIP-SEQ-NUM> = INT(<ec:CH/HTR-SEQ-R>+.1)                  EQCTRS 142
                MaxSequenceNum     = MAX(MaxSequenceNum,                        EQCTRS 143
     &                                    <ec;EQUIP-SEQ-NUM>)                   EQCTRS 144
                <ec:EQUIP-MAX-LD>  = <ec:CH/HTR-MAX> * 1.E6                     EQCTRS 145
c              increment chiller/heater index                                   EQCTRS 146
                IH = IH + 1                                                     EQCTRS 147
c              increment the total number of units in this range                EQCTRS 148
                NumEquipInRange = NumEquipInRange + 1                           EQCTRS 149
              ELSE                                                              EQCTRS 150
                EXIT                                                            EQCTRS 151
              ENDIF                                                             EQCTRS 152
            ENDDO                                                               EQCTRS 153
          ENDIF  ! chlr/htrs                                                    EQCTRS 154
c                                                                               GLHX1   78
c              Check to see if any GLHX in heat-rejection mode attached         GLHX1   79
c              These occupy the same keyword positions as chiller/heaters       GLHX1   80
          IF (<ec:CH/HTR> .GT. 0  .AND.  ecTYPE .EQ. 4)  THEN                   GLHX1   81
c              Move the "chiller/heaters" into the unfilled positions           GLHX1   82
c              of the EQUIP- variables.  Note that EQUIP- variables use         GLHX1   83
c              the II index, while "chiller/heaters" use IH                     GLHX1   84
            JUnFilled = IIstart-1 + NumEquipInRange + 1                         GLHX1   85
            DO  II=JUnFilled,IIend                                              GLHX1   86
              IF (<ec:CH/HTR> .GT. 0)  THEN                                     GLHX1   87
                Jgl                = Igl + (<ec:CH/HTR>-1)*Lgl                  GLHX1   88
                Jpe                = <gl;Jpe>                                   GLHX1   89
                <ec:EQUIP>         = Jpe                                        GLHX1   90
                <ec;EQUIP-SEQ-NUM> = INT(<ec:CH/HTR-SEQ-R>+.1)                  GLHX1   91
                MaxSequenceNum     = MAX(MaxSequenceNum,                        GLHX1   92
     &                                    <ec;EQUIP-SEQ-NUM>)                   GLHX1   93
                <ec:EQUIP-MAX-LD>  = <ec:CH/HTR-MAX>                            GLHX1   94
c              increment chiller/heater index                                   GLHX1   95
                IH = IH + 1                                                     GLHX1   96
c              increment the total number of units in this range                GLHX1   97
                NumEquipInRange = NumEquipInRange + 1                           GLHX1   98
              ELSE                                                              GLHX1   99
                EXIT                                                            GLHX1  100
              ENDIF                                                             GLHX1  101
            ENDDO                                                               GLHX1  102
          ENDIF  ! GLHX units                                                   GLHX1  103
c                                                                               EQCTRS 155
c              Check to see if any cogeneration in heat recovery mode           EQCTRS 156
          IF (<ec:GEN> .GT. 0)  THEN                                            EQCTRS 157
c              Move the generators into the unfilled positions                  EQCTRS 158
c              of the EQUIP- variables.  Note that EQUIP- variables use         EQCTRS 159
c              the II index, while generators use IH                            EQCTRS 160
            JUnFilled = IIstart-1 + NumEquipInRange + 1                         EQCTRS 161
            DO  II=JUnFilled,IIend                                              EQCTRS 162
              IF (<ec:GEN> .GT. 0)  THEN                                        EQCTRS 163
                Jgn = Ign + (<ec:GEN>-1)*Lgn                                    EQCTRS 164
c                   either exhaust, jacket, and/or both may be attached         EQCTRS 165
                IF (<gn:EXH-LOOP> .EQ. Jlp)  THEN                               EQCTRS 166
c                   point to ghost containing heat recovery variables           EQCTRS 167
                  Jpe                = <gn;Jpe_Exhaust>                         EQCTRS 168
                  <ec:EQUIP>         = Jpe                                      EQCTRS 169
                  <ec;EQUIP-SEQ-NUM> = INT(<ec:GEN-SEQ-R>+.1)                   EQCTRS 170
                  MaxSequenceNum     = MAX(MaxSequenceNum,                      EQCTRS 171
     &                                     <ec;EQUIP-SEQ-NUM>)                  EQCTRS 172
                  <ec:EQUIP-MAX-LD>  = <ec:GEN-MAX>                             EQCTRS 173
c                     increment cogeneration index                              EQCTRS 174
                  IH = IH + 1                                                   EQCTRS 175
c                     increment the total number of units in this range         EQCTRS 176
                  NumEquipInRange = NumEquipInRange + 1                         EQCTRS 177
                ELSEIF (<gn:JAC-LOOP> .EQ. Jlp)  THEN                           EQCTRS 178
                  Jpe                = <gn;Jpe_Exhaust>                         EQCTRS 179
                  <ec:EQUIP>         = Jpe                                      EQCTRS 180
                  <ec;EQUIP-SEQ-NUM> = INT(<ec:GEN-SEQ-R>+.1)                   EQCTRS 181
                  MaxSequenceNum     = MAX(MaxSequenceNum,                      EQCTRS 182
     &                                     <ec;EQUIP-SEQ-NUM>)                  EQCTRS 183
                  <ec:EQUIP-MAX-LD>  = <ec:GEN-MAX> * 1.E6                      EQCTRS 184
                  IH = IH + 1                                                   EQCTRS 185
                  NumEquipInRange = NumEquipInRange + 1                         EQCTRS 186
                ENDIF                                                           EQCTRS 187
              ELSE                                                              EQCTRS 188
                EXIT                                                            EQCTRS 189
              ENDIF                                                             EQCTRS 190
            ENDDO                                                               EQCTRS 191
          ENDIF  ! cogeneration                                                 EQCTRS 192
c                                                                               EQCTRS 193
c              Save the number of equipment units and maximum sequence          EQCTRS 194
c              number in this load range.  Note that these variables use        EQCTRS 195
c              the IR index                                                     EQCTRS 196
          <ec;NUM_EQUIP>   = NumEquipInRange                                    EQCTRS 197
          <ec;MAX_SEQ_NUM> = MaxSequenceNum                                     EQCTRS 198
        ENDDO  ! load ranges                                                    EQCTRS 199
c                                                                               EQCTRS 200
c              save number of load ranges                                       EQCTRS 201
        IF (NumLoadRanges .eq. 0) THEN                                          -045g    2
          Call MsgSim(-1,ii,ii,ii,ii)                                           -045g    3
          Write (Ioutpt,9101) (<ec:NAME>,II=1,8)                                -045g    4
          Call MessageBox( NULL, 'EQUIP-CTRL has no equipment -'                -045g    5
     &      //' WARNING'//char(0),'Design Errors'//char(0), MB_OK               -045g    6
     &      + MB_ICONSTOP + MB_TASKMODAL )                                      -045g    7
          IwinReturn = 1                                                        -045g    8
        ENDIF                                                                   -045g    9
        <ec;NUM_LOAD_RANG> = NumLoadRanges                                      EQCTRS 202
      ENDDO    ! EQUIP-CTRL sequences                                           EQCTRS 203
c                                                                               EQCTRS 204
      RETURN                                                                    EQCTRS 205
c                                                                               EQCTRS 206
c              message formats                                                  EQCTRS 207
 9100 FORMAT(14X,'EQUIP-CTRL: ',8A4,' has a storage'                   /        EQCTRS 208
     &       14X,'seqence number specified, but no storage device is'  /        EQCTRS 209
     &       14X,'attached.'                                           )        EQCTRS 210
 9101 FORMAT(14X,'EQUIP-CTRL: ',8A4,' has no equipment'                /        -045g   10
     &14X,'listed, and no meter specified. Load cannot be allocated.'  )        -045g   11
c                                                                               EQCTRS 211
      END                                                                       EQCTRS 212
      SUBROUTINE FluidCooler_1                                                  FCLR1    2
c                                                                               FCLR1    3
c                                                                               FCLR1    4
c              Simulates a fluid cooler.                                        FCLR1    5
c                                                                               FCLR1    6
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /LOOP  / Nloop(16,2), NextType(40), NLP2,                         -41a     1
     &                 WLHPoff, RealCall, RegenFlag, Sim2x, LoopSimCount        ChlrHP   2
      LOGICAL          WLHPoff, RealCall, RegenFlag, Sim2x                      ChlrHP   3
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /REPORT/ IREPRT(4,37),IPRG,IUNIQV(100),IUNIQS(100),IUNIQL         /REPORT/ 2
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /TWRDAT/ TWRload,TCAP,TWRrej,CWgpm,TWRgpm,TWRsupply,              /TWRDAT/ 2
     &                 TWRset,Ttower,RANGE,APP,twr1FRA,GPMra,GPMcap,            /TWRDAT/ 3
     &                 GPMcell,NumCells,MinCells,MaxCells,Ttop,GPMtop,          /TWRDAT/ 4
     &                 Tbot,GPMbot,CFMra,FankWr,FankW,TWRaux,QpanLoss,          -034     2
     &                 QcoilLoss, SpraykW, Twet1, Tstart                        /TWRDAT/ 6
      DIMENSION        TWRSAV(25)                                               /TWRDAT/ 7
      EQUIVALENCE     (TWRSAV(1),TWRload)                                       /TWRDAT/ 8
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               FCLR1   23
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
      COMMON  /TWRKY / Open, OpenHX, FluidCool,                                 /TWRKY/  2
     &                 Bypass, Speed1, Speed2, SpeedV, Damper,                  /TWRKY/  3
     &                 RunMinCells, RunMaxCells,                                /TWRKY/  4
     &                 ElecPanHtr, NoPanHtr, HWPanHtr,                          /TWRKY/  5
     &                 CycleWithFan, StayOn                                     /TWRKY/  6
      INTEGER          Open, OpenHX, FluidCool,                                 /TWRKY/  7
     &                 Bypass, Speed1, Speed2, SpeedV, Damper,                  /TWRKY/  8
     &                 RunMinCells, RunMaxCells,                                /TWRKY/  9
     &                 ElecPanHtr, NoPanHtr, HWPanHtr,                          /TWRKY/ 10
     &                 CycleWithFan, StayOn                                     /TWRKY/ 11
c                                                                               FCLR1   28
c              limits for performance curves                                    FCLR1   29
      DIMENSION TWRLIM(2)                                                       FCLR1   30
      DATA TWRLIM /120.,  0./                                                   FCLR1   31
c              curve for dynamic PLR curve 'constants'                          FCLR1   32
      DIMENSION CURVE(6)                                                        FCLR1   33
      DATA CURVE /6*0.0/                                                        FCLR1   34
c                                                                               FCLR1   35
      IF (<tw;WET_COIL_FLAG> .EQ. 0.)  THEN                                     FCLR1   36
c              Fluid cooler is running with a dry coil                          FCLR1   37
        CALL DryCooler_1                                                        FCLR1   38
        RETURN                                                                  FCLR1   39
      ENDIF                                                                     FCLR1   40
c              zero hourly tower data                                           FCLR1   41
      CALL FILLN(0., TWRSAV(1), IVTLIM(2,19))                                   FCLR1   42
c                                                                               FCLR1   43
c ****         run function : FluidCooler_1-1                                   FCLR1   44
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        FCLR1   45
c                                                                               FCLR1   46
c                                                                               FCLR1   47
c============= ROUTINE CALLED TO GET OPERATING CAPACITY ======================= FCLR1   48
      IF (SimCtrl .EQ. 11)  THEN                                                FCLR1   49
c              Unlike other equipment, capacity is in gpm, not energy           FCLR1   50
c              temperature drop thru tower                                      FCLR1   51
        RANGE  = MAX(1., QloopNet / (GPMs * <lp;BTUH/GPM-F>))                   FCLR1   52
c              wetbulb is limited to 20-90F                                     FCLR1   53
        Twet1  = MIN(MAX(WBT, 20.), 90.)                                        FCLR1   54
c              leaving temperature setpoint                                     FCLR1   55
        TWRset = <lp;COOL_SETPT>                                                FCLR1   56
c              setpoint must be greater than wetbulb                            FCLR1   57
        TWRset = MAX(Twet1+2., TWRset)                                          FCLR1   58
c              approach to wetbulb                                              FCLR1   59
        APP    = TWRset - Twet1                                                 FCLR1   60
c              tower capacity, gpm                                              FCLR1   61
        IF (QloopNet .GT. 0)  THEN                                              HVAC29  25
          TWRgpm = TwrGPMCap(RANGE, APP, Twet1)                                 HVAC29  26
        ELSE                                                                    HVAC29  27
c              no load                                                          HVAC29  28
          TWRgpm = <tw:CELL-MAX-GPM>                                            HVAC29  29
        ENDIF                                                                   HVAC29  30
        TWRgpm = MIN(TWRgpm, <tw:CELL-MAX-GPM>) * <tw:NUM-CELLS>                FCLR1   63
c                                                                               FCLR1   64
c                                                                               FCLR1   65
c ****         run function : FluidCooler_1-2                                   FCLR1   66
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        FCLR1   67
c                                                                               FCLR1   68
        <pe;OPER_CAPACITY> = TWRgpm                                             FCLR1   69
        <pe;MAX_CAPACITY>  = TWRgpm                                             FCLR1   70
c                                                                               FCLR1   71
        RETURN                                                                  FCLR1   72
      ENDIF                                                                     FCLR1   73
c                                                                               FCLR1   74
c                                                                               FCLR1   75
c============= ROUTINE CALLED TO SIMULATE EQUIPMENT =========================== FCLR1   76
c              total equipment pump kW                                          FCLR1   77
      AuxPumpKW  = 0.                                                           FCLR1   78
c              condenser loop flow thru this tower                              FCLR1   79
      CWgpm = <pe;GPM>                                                          FCLR1   80
c                                                                               FCLR1   81
c ****         run function : FluidCooler_1-3                                   FCLR1   82
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        FCLR1   83
c                                                                               FCLR1   84
c              Auxiliary power                                                  FCLR1   85
      IF (<tw:AUX-KW> .GT. 0.  .AND.  RealCall)  THEN                           FCLR1   86
c              if always on                                                     FCLR1   87
        IF (<tw:AUX-MODE> .EQ. Always  .OR.                                     FCLR1   88
c              if on when equipment on                                          FCLR1   89
     1      (<tw:AUX-MODE> .EQ. WhenOn  .AND. CWgpm .GT. 0.)  .OR.              FCLR1   90
c              if off when equipment on                                         FCLR1   91
     2      (<tw:AUX-MODE> .EQ. WhenOff .AND. CWgpm .EQ. 0.) )  THEN            FCLR1   92
          TWRaux = <tw:AUX-KW>                                                  FCLR1   93
        ELSE                                                                    Time    30
          TWRaux = <tw:AUX-KW> * SchVal(<tw:AUX-SCH>, 1.)                       Time    31
        ENDIF                                                                   FCLR1   96
      ENDIF                                                                     FCLR1   97
c              skip if no load                                                  FCLR1   98
      IF (CWgpm .LT. 1.  .OR.  <pe;LOAD> .LT. 0.00001)  THEN                    HVAC29  31
        TWRload   = 0.                                                          FCLR1  100
        <pe;LOAD> = 0.                                                          FCLR1  101
c              check for pan heater                                             FCLR1  102
        IF (<tw;PAN_UA> .GT. 0.  .AND.  DBT .LT. <tw:PAN-FLUID-T>)  THEN        FCLR1  103
          Tpan     = <tw:PAN-FLUID-T>                                           FCLR1  104
          UA       = <tw;PAN_UA> * SurfaceFilmAdj(Tpan, DBT, WNDSPD)            FCLR1  105
          QpanLoss = UA * (DBT - Tpan)                                          FCLR1  106
          IF (<tw:PAN-HTR-TYPE> .EQ. ElecPanHtr)  THEN                          FCLR1  107
c              electric pan heater - pass on to auxiliary                       FCLR1  108
            TWRaux = TWRaux - QpanLoss * KWBTU                                  FCLR1  109
          ELSE                                                                  FCLR1  110
c              hot water pan heater                                             FCLR1  111
            JlpSave = Jlp                                                       FCLR1  112
            Jlp = <tw:PAN-HTR-LOOP>                                             FCLR1  113
            <lp;AUX_HEAT> = <lp;AUX_HEAT> + QpanLoss*<lp;HCAP_RATIO>            FCLR1  114
            IF (<tw:PAN-VALVE-TYP> .EQ. 3)  THEN                                FCLR1  115
c              3-way valve                                                      FCLR1  116
              <lp;PRIM_GPM>      = <lp;PRIM_GPM> + <tw;PAN_DES_GPM>             FCLR1  117
              <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                      FCLR1  118
     &                                   <tw:PAN-HTR-HEAD>)                     FCLR1  119
            ELSE                                                                FCLR1  120
c              2-way valve - assume linear with load                            FCLR1  121
              PLR = MIN(1., QpanLoss/<tw:PAN-LOSS>)                             FCLR1  122
              <lp;PRIM_GPM> = <lp;PRIM_GPM>                                     FCLR1  123
     &                      + <tw;PAN_DES_GPM> * PLR                            FCLR1  124
              <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                      FCLR1  125
     &                                   <tw:PAN-HTR-HEAD>*PLR**1.8)            FCLR1  126
            ENDIF                                                               FCLR1  127
            Jlp = JlpSave                                                       FCLR1  128
          ENDIF                                                                 FCLR1  129
        ENDIF  !pan losses                                                      FCLR1  130
        GOTO 1000                                                               FCLR1  131
      ELSE                                                                      FCLR1  132
        TWRload   = <pe;LOAD>                                                   FCLR1  133
      ENDIF                                                                     FCLR1  134
c                                                                               FCLR1  135
      NumCellsAvail = INT(<tw:NUM-CELLS>)                                       FCLR1  136
c                                                                               FCLR1  137
c              minimum and maximum number of cells                              FCLR1  138
c              that can operate with the loop GPM                               FCLR1  139
      MinCells = MAX(1, MIN(INT(CWgpm/<tw:CELL-MAX-GPM> + .999999),             FCLR1  140
     &                                                  NumCellsAvail) )        FCLR1  141
      MaxCells = MAX(1, MIN(INT(CWgpm/<tw:CELL-MIN-GPM> + .999999),             FCLR1  142
     &                                                  NumCellsAvail) )        FCLR1  143
c                                                                               FCLR1  144
c              flow thru the tower                                              FCLR1  145
      IF (<tw:CW-PUMP> .GT. 0)  THEN                                            FCLR1  146
        Jpm = <tw:CW-PUMP>                                                      FCLR1  147
        IF (<pm;TYPE> .EQ. EquipmentPump)  THEN                                 FCLR1  148
c              pump recirculates thru the tower only                            FCLR1  149
          IF (<pm;EQUIP_CTRL> .EQ. ConstantFlow)  THEN                          FCLR1  150
c              constant flow                                                    FCLR1  151
            TWRgpm  = <pm;EQUIP_GPM>                                            FCLR1  152
          ELSE                                                                  FCLR1  153
c              not constant flow, flow is loop flow                             FCLR1  154
            TWRgpm = MAX(CWgpm, <tw:CW-MIN-GPM>)                                FCLR1  155
          ENDIF                                                                 FCLR1  156
        ELSE                                                                    FCLR1  157
c              pump powers the loop, flow is loop flow                          FCLR1  158
          TWRgpm  = CWgpm                                                       FCLR1  159
        ENDIF                                                                   FCLR1  160
      ELSE                                                                      FCLR1  161
c              no recirculation pump, flow is loop flow                         FCLR1  162
        TWRgpm  = CWgpm                                                         FCLR1  163
      ENDIF                                                                     FCLR1  164
c                                                                               FCLR1  165
c              initialize tower heat rejected to be the loop load               FCLR1  166
      TWRrej = TWRload                                                          FCLR1  167
c                                                                               FCLR1  168
c              Simulate pump attached directly to tower.  This pump may         FCLR1  169
c              be either a recirculation (equipment pump), or may also          FCLR1  170
c              power the condenser loop.  Note that the pump is assumed         FCLR1  171
c              to run the entire hour.  In the future this should be            FCLR1  172
c              modified to allow cycling.                                       FCLR1  173
      IF (<tw:CW-PUMP> .GT. 0)  THEN                                            FCLR1  174
        PMPfrac = 1.0                                                           FCLR1  175
c              do the pump simulation                                           FCLR1  176
        Jpm = <tw:CW-PUMP>                                                      FCLR1  177
        CALL PumpSupply                                                         FCLR1  178
c              add pump heat to load                                            FCLR1  179
        TWRrej = TWRrej + PMPQ                                                  FCLR1  180
        IF (<lp:PUMP> .NE. 0)  AuxPumpKW = PMPkW                                FCLR1  181
      ELSE                                                                      FCLR1  182
        PMPQ  = 0.                                                              FCLR1  183
        PMPdT = 0.                                                              FCLR1  184
      ENDIF                                                                     FCLR1  185
c                                                                               FCLR1  186
c              wetbulb is limited to 20-90F                                     FCLR1  187
      Twet1  = MIN(MAX(WBT, 20.), 90.)                                          FCLR1  188
c                                                                               FCLR1  189
c              required leaving supply temperature                              FCLR1  190
      TWRset = <lp;COOL_SETPT>                                                  FCLR1  191
c              Adjust tower setpoint for pump heat (pump is assumed to be       FCLR1  192
c              on leaving side of tower)                                        FCLR1  193
      TWRset = TWRset - PMPdT                                                   FCLR1  194
c              beginning of hour loop temperature                               FCLR1  195
      Tstart = <lp;SUPPLY_T>                                                    FCLR1  196
c              estimate of tower range (temp in minus temp out)                 FCLR1  197
      RANGE  = TWRrej / (TWRgpm * <lp;BTUH/GPM-F>)                              FCLR1  198
c              range must be at least 1F                                        FCLR1  199
      RANGE  = MAX(RANGE, 1.0)                                                  FCLR1  200
c                                                                               FCLR1  201
c              skip if tower fan speed is controlled directly on load           FCLR1  202
      IF (<lp:CL-SETPT-CTRL> .EQ. LOAD)  GOTO 300                               FCLR1  203
c                                                                               FCLR1  204
c============= TEMPERATURE SETPOINT CALCULATIONS ============================== FCLR1  205
c              Adjust actual setpoint for the controller's throttling           FCLR1  206
c              range.  To do this, capacity must be known at top and            FCLR1  207
c              bottom of throttling range.                                      FCLR1  208
  150 THRTL  = <lp:SETPT-RNG>                                                   FCLR1  209
c              temperatures at top and bottom of range                          FCLR1  210
      Ttop   = TWRset + THRTL * .5                                              FCLR1  211
      Tbot   = Ttop - THRTL                                                     FCLR1  212
c              Skip to floating calculations if Ttop is close to wetbulb        FCLR1  213
      IF (Ttop .LE. (Twet1+2.1))  GOTO 200                                      FCLR1  214
c              Approach at top of throttling range.                             FCLR1  215
      APP    = Ttop - Twet1                                                     FCLR1  216
c              Capacity at top of throttling range                              FCLR1  217
      GPMtop = TwrGPMCap(RANGE, APP, Twet1)                                     FCLR1  218
     &       * FLOAT(MaxCells)                                                  FCLR1  219
c              Skip to floating calcs if GPMtop insufficient for load           FCLR1  220
      IF (GPMtop .LT. TWRgpm)  GOTO 200                                         FCLR1  221
c              Repeat for approach and tower capacity at bottom of              FCLR1  222
c              throttling range. Capacity is zero if Tbot is less than          FCLR1  223
c              wetbulb, and the effective throttling range is reduced.          FCLR1  224
      IF (Tbot .LT. (Twet1+2.0))  THEN                                          FCLR1  225
        GPMbot = 0.                                                             FCLR1  226
        Tbot   = Twet1 + 2.0                                                    FCLR1  227
        THRTL  = Ttop - Tbot                                                    FCLR1  228
      ELSE                                                                      FCLR1  229
        APP    = Tbot - Twet1                                                   FCLR1  230
        GPMbot = TwrGPMCap(RANGE, APP, Twet1)                                   FCLR1  231
     &         * FLOAT(MaxCells)                                                FCLR1  232
      ENDIF                                                                     FCLR1  233
c              Now determine the tower temperature based on throttling range,   FCLR1  234
c              and capacity variation over throttling range                     FCLR1  235
      CAPtop   = GPMtop * RANGE*<lp;BTUH/GPM-F>                                 FCLR1  236
      CAPbot   = GPMbot * RANGE*<lp;BTUH/GPM-F>                                 FCLR1  237
      DCAP     = CAPtop - CAPbot                                                FCLR1  238
      Cp       = <lp;BTU/F>                                                     FCLR1  239
      CURVE(3) = DCAP                                                           FCLR1  240
      CURVE(2) = Cp*THRTL*THRTL + CAPbot*THRTL - 2.0*Tbot*DCAP                  FCLR1  241
      CURVE(1) = -(TWRrej + Tstart*Cp)*THRTL*THRTL                              FCLR1  242
     &                  -CAPbot*Tbot*THRTL + DCAP*Tbot*Tbot                     FCLR1  243
      CALL CURINV(CURVE(1), 3, 1, Ttower, Ttower, 0.0, TWRLIM(1), IERR)         FCLR1  244
      Ttower = Ttower + PMPdT                                                   FCLR1  245
c              Skip rest if only an estimation call                             FCLR1  246
      IF (.NOT. RealCall)  THEN                                                 FCLR1  247
        TWRsupply = Ttower                                                      FCLR1  248
        GOTO 401                                                                FCLR1  249
      ENDIF                                                                     FCLR1  250
c                                                                               FCLR1  251
c============= CONTROL TO HOLD SETPOINT ======================================= FCLR1  252
c              Desired approach                                                 FCLR1  253
  160 APP = Ttower - Twet1                                                      FCLR1  254
c              Skip to floating calcs if approach .lt. 2F                       FCLR1  255
      IF (APP .LT. 2.0)  GOTO 200                                               FCLR1  256
c              Adjust TWRrej and RANGE for loop temperature change              FCLR1  257
c              from last hour.                                                  FCLR1  258
      TWRrej = TWRload + (Tstart-Ttower)*<lp;BTU/F> + PMPQ                      FCLR1  259
      RANGE  = MAX(TWRrej / (TWRgpm * <lp;BTUH/GPM-F>), 1.0)                    FCLR1  260
c              Actual GPM capacity per cell                                     FCLR1  261
      GPMcap = TwrGPMCap(RANGE, APP, Twet1)                                     FCLR1  262
      GPMcap = MIN(GPMcap, <tw:CELL-MAX-GPM>)                                   FCLR1  263
c                                                                               FCLR1  264
c              Determine if tower has sufficient capacity to meet setpoint      FCLR1  265
      IF (GPMcap*FLOAT(MaxCells) .LT. TWRgpm)  GO TO 200                        FCLR1  266
c              setpoint can be met.  determine how many cells are required.     FCLR1  267
      NumCells = INT(TWRgpm/GPMcap +.99999)                                     FCLR1  268
c              use maximum number of cells if user specified.                   FCLR1  269
      IF (<tw:CELL-CTRL> .EQ. RunMaxCells)  THEN                                FCLR1  270
        NumCells = MAX(NumCells, MaxCells)                                      FCLR1  271
      ELSE                                                                      FCLR1  272
c              otherwise, use minimum number of cells                           FCLR1  273
        NumCells = MAX(NumCells, MinCells)                                      FCLR1  274
      ENDIF                                                                     FCLR1  275
      CellNum  = FLOAT(NumCells)                                                FCLR1  276
c              GPM per cell                                                     FCLR1  277
      GPMcell = TWRgpm / CellNum                                                FCLR1  278
c              Temperature entering tower                                       FCLR1  279
      Tenter  = Ttower + RANGE                                                  FCLR1  280
c                                                                               FCLR1  281
c              Fan output required to hold setpoint                             FCLR1  282
c              First, determine how much heat rejection convective              FCLR1  283
c              cooling can provide (fan off)                                    FCLR1  284
      QtwrOff = TwrQrej(GPMcell,<tw:FAN-OFF-CFM>,Tenter,Twet1) * CellNum        FCLR1  285
      IF (QtwrOff .GE. TWRrej)  THEN                                            FCLR1  286
        FankWr = 0.0                                                            FCLR1  287
        Sprayr = 1.0                                                            FCLR1  288
        IF (<tw:CAP-CTRL> .EQ. Bypass)  THEN                                    FCLR1  289
          GOTO 400                                                              FCLR1  290
        ELSE                                                                    FCLR1  291
c              get floating temperature using natural convection                FCLR1  292
          CFMra = <tw:FAN-OFF-CFM>                                              FCLR1  293
          GOTO 201                                                              FCLR1  294
        ENDIF                                                                   FCLR1  295
      ENDIF                                                                     FCLR1  296
c              select capacity control mechanism                                FCLR1  297
      GOTO (161,162,163,164,164), <tw:CAP-CTRL>                                 FCLR1  298
c              fluid bypass                                                     FCLR1  299
  161 FankWr = 1.0                                                              FCLR1  300
      Sprayr = 1.0                                                              FCLR1  301
      GOTO 400                                                                  FCLR1  302
c              single-speed fan                                                 FCLR1  303
  162 QtwrLo = QtwrOff                                                          FCLR1  304
      EfanLo = 0.0                                                              FCLR1  305
      QtwrHi = TwrQrej(GPMcell, 1.0, Tenter, Twet1) * CellNum                   FCLR1  306
      EfanHi = 1.0                                                              FCLR1  307
      GOTO 170                                                                  FCLR1  308
c              2-speed fan                                                      FCLR1  309
  163 QtwrLo = TwrQrej(GPMcell, <tw:FAN-LOW-CFM>,Tenter,Twet1) * CellNum        FCLR1  310
      EfanLo = <tw:FAN-LOW-ELEC>                                                FCLR1  311
      IF (QtwrLo .GE. TWRrej)  THEN                                             FCLR1  312
c              will cycle Off/Lo                                                FCLR1  313
        QtwrHi = QtwrLo                                                         FCLR1  314
        EfanHi = EfanLo                                                         FCLR1  315
        QtwrLo = QtwrOff                                                        FCLR1  316
        EfanLo = 0.0                                                            FCLR1  317
      ELSE                                                                      FCLR1  318
c              will cycle Lo/Hi                                                 FCLR1  319
        QtwrHi = TwrQrej(GPMcell, 1.0, Tenter, Twet1) * CellNum                 FCLR1  320
        EfanHi = 1.0                                                            FCLR1  321
        Sprayr = -1.                                                            FCLR1  322
      ENDIF                                                                     FCLR1  323
      GOTO 170                                                                  FCLR1  324
c              Variable cfm - get the required airflow                          FCLR1  325
  164 CFMra = TwrCFMr(GPMcell, RANGE, APP, Twet1)                               FCLR1  326
      IF (<tw:CAP-CTRL> .EQ. SpeedV)  THEN                                      FCLR1  327
c              Variable speed airflow must be above that associated with        FCLR1  328
c              fan's critical speed - must cycle below                          FCLR1  329
        VFDmin = <tw:MIN-FAN-SPD>                                               FCLR1  330
        IF (CFMra .GT. VFDmin)  THEN                                            FCLR1  331
          FankWr = CVAL(<tw:KW-fSPEED>, CFMra, CFMra)                           FCLR1  332
          Sprayr = 1.0                                                          FCLR1  333
          GOTO 400                                                              FCLR1  334
        ELSE                                                                    FCLR1  335
c              cycle fan between off and minimum                                FCLR1  336
          QtwrLo = QtwrOff                                                      FCLR1  337
          EfanLo = 0.0                                                          FCLR1  338
          QtwrHi = TwrQrej(GPMcell, VFDmin, Tenter, Twet1) * CellNum            FCLR1  339
          EfanHi = CVAL(<tw:KW-fSPEED>, VFDmin, VFDmin)                         FCLR1  340
          GOTO 170                                                              FCLR1  341
        ENDIF                                                                   FCLR1  342
      ELSE                                                                      FCLR1  343
c              Discharge damper                                                 FCLR1  344
        FankWr = CVAL(<tw:KW-fDAMPER>, CFMra, CFMra)                            FCLR1  345
        Sprayr = 1.0                                                            FCLR1  346
        GOTO 400                                                                FCLR1  347
      ENDIF                                                                     FCLR1  348
c              cycling fan energy                                               FCLR1  349
  170 IF (QtwrHi .gt. QtwrLo) THEN                                              -044c9   6
        FracHi = Max(0., Min(1., (TWRrej-QtwrLo) / (QtwrHi-QtwrLo) ))           -044c9   7
      ELSE                                                                      -044c9   8
        FracHi = 1.                                                             -044c9   9
      ENDIF                                                                     -044c9  10
      FankWr = EfanLo*(1.0-FracHi) + EfanHi*FracHi                              FCLR1  351
      IF (Sprayr .NE. -1.)  THEN                                                FCLR1  352
        Sprayr = FracHi                                                         FCLR1  353
      ELSE                                                                      FCLR1  354
        Sprayr = 1.                                                             FCLR1  355
      ENDIF                                                                     FCLR1  356
      GO TO 400                                                                 FCLR1  357
c                                                                               FCLR1  358
c============= FLOATING TEMPERATURE CALCULATIONS ============================== FCLR1  359
c              Temperature is floating above or below setpoint.                 FCLR1  360
c              When above setpoint, turn on as many cells as possible.          FCLR1  361
  200 NumCells = MaxCells                                                       FCLR1  362
      CellNum  = FLOAT(NumCells)                                                FCLR1  363
      CFMra    = 1.0                                                            FCLR1  364
      FracHi   = 1.0                                                            FCLR1  365
      FankWr   = 1.0                                                            FCLR1  366
      Sprayr   = 1.0                                                            FCLR1  367
c              If jumped to 201, tower can handle load using natural            FCLR1  368
c              convection only, and will be floating below the setpoint         FCLR1  369
c              (CFMra is set to the natural convective flow)                    FCLR1  370
  201 Ttower = TwrTexit(TWRload, TWRgpm, CellNum, CFMra, Twet1)                 FCLR1  371
c              when floating below setpoint, do not let temperature drop        FCLR1  372
c              below the minimum                                                FCLR1  373
      IF (Ttower .LT. <lp:MIN-RESET-T>)  THEN                                   FCLR1  374
        APP = <lp:MIN-RESET-T> - Twet1                                          FCLR1  375
        Ttower = <lp:MIN-RESET-T>                                               FCLR1  376
      ENDIF                                                                     FCLR1  377
c              end of floating temperature calcs                                FCLR1  378
      GOTO 400                                                                  FCLR1  379
c                                                                               FCLR1  380
c============= LOAD RESET CALCULATIONS ======================================== FCLR1  381
c              Control tower fan speed directly on chiller load and let         FCLR1  382
c              leaving temperature float as the load and wetbulb vary.          FCLR1  383
c              First, number of cells operating.                                FCLR1  384
  300 IF (<tw:CELL-CTRL> .EQ. RunMaxCells)  THEN                                FCLR1  385
        NumCells = MaxCells                                                     FCLR1  386
      ELSE                                                                      FCLR1  387
c              otherwise, use minimum number of cells                           FCLR1  388
        NumCells = MinCells                                                     FCLR1  389
      ENDIF                                                                     FCLR1  390
      CellNum = FLOAT(NumCells)                                                 FCLR1  391
c              water flow per cell                                              FCLR1  392
      GPMcell = TWRgpm / CellNum                                                FCLR1  393
c              fraction of design heat rejection load                           FCLR1  394
      PLR = (RANGE * GPMcell) / (<tw:DESIGN-RANGE> * <tw;GPM/CELL>)             FCLR1  395
c              fraction of airflow and fan speed requested                      FCLR1  396
c              at this part load ratio                                          FCLR1  397
      IF (<tw:CAP-CTRL> .EQ. SpeedV)  THEN                                      FCLR1  398
c              variable speed fan(s)                                            FCLR1  399
        CFMra = <tw:MIN-FAN-SPD>                                                FCLR1  400
     &          + (<tw:MAX-FAN-SPD> - <tw:MIN-FAN-SPD>)                         FCLR1  401
     &                 * (PLR-<tw:MIN-FAN-PLR>)/(1.0-<tw:MIN-FAN-PLR>)          FCLR1  402
        CFMra = MAX(<tw:MIN-FAN-SPD>,                                           FCLR1  403
     &                  MIN(CFMra , <tw:MAX-FAN-SPD>))                          FCLR1  404
      ELSE                                                                      FCLR1  405
c              2-speed fan - let float on low speed                             FCLR1  406
        CFMra = <tw:FAN-LOW-CFM>                                                FCLR1  407
      ENDIF                                                                     FCLR1  408
c              get tower temperature                                            FCLR1  409
      Ttower = TwrTexit(TWRload, TWRgpm, CellNum, CFMra, Twet1)                 FCLR1  410
c              check if temp is within the acceptable range                     FCLR1  411
      IF (Ttower .GT. <lp:CL-SETPT-T>)  THEN                                    FCLR1  412
c              floating temperature is TOO HOT - control to max temp            FCLR1  413
        TWRset = <lp:CL-SETPT-T>                                                FCLR1  414
        GOTO 150                                                                FCLR1  415
      ELSEIF (Ttower .LT. <lp:MIN-RESET-T>)  THEN                               FCLR1  416
c              floating temperature is TOO COLD - control to min temp           FCLR1  417
        TWRset = <lp:MIN-RESET-T>                                               FCLR1  418
        Ttower = <lp:MIN-RESET-T>                                               FCLR1  419
        IF (RealCall)  THEN                                                     FCLR1  420
          GOTO 160                                                              FCLR1  421
        ELSE                                                                    FCLR1  422
          TWRsupply = Ttower                                                    FCLR1  423
          GOTO 401                                                              FCLR1  424
        ENDIF                                                                   FCLR1  425
      ELSE                                                                      FCLR1  426
c              floating temperature is JUUSST RIGHT.  Get the fan energy        FCLR1  427
        IF (RealCall)  THEN                                                     FCLR1  428
          IF (<tw:CAP-CTRL> .EQ. SpeedV)  THEN                                  FCLR1  429
c              variable speed                                                   FCLR1  430
            FankWr = CVAL(<tw:KW-fSPEED>, CFMra, CFMra)                         FCLR1  431
          ELSE                                                                  FCLR1  432
c              2-speed fan running on low speed                                 FCLR1  433
            FankWr = <tw:FAN-LOW-ELEC>                                          FCLR1  434
          ENDIF                                                                 FCLR1  435
          Sprayr = 1.0                                                          FCLR1  436
        ELSE                                                                    FCLR1  437
          TWRsupply = Ttower                                                    FCLR1  438
          GOTO 401                                                              FCLR1  439
        ENDIF                                                                   FCLR1  440
      ENDIF                                                                     FCLR1  441
c              end of fan control on chiller load                               FCLR1  442
c                                                                               FCLR1  443
c============= MISCELLANEOUS ================================================== FCLR1  444
c              Load is now satisfied.                                           FCLR1  445
  400 TWRsupply     = Ttower                                                    FCLR1  446
  401 <pe;SUPPLY_T> = TWRsupply                                                 FCLR1  447
c                                                                               FCLR1  448
c ****         run function : FluidCooler_1-4                                   FCLR1  449
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        FCLR1  450
c                                                                               FCLR1  451
c                                                                               FCLR1  452
c              Skip rest if an estimation call                                  FCLR1  453
  410 IF (.NOT. RealCall)  RETURN                                               FCLR1  454
c                                                                               FCLR1  455
c              power consumption of fans                                        FCLR1  456
      FankW = <tw:FAN-KW/CELL> * CellNum * FankWr                               FCLR1  457
c              power consumption of spray pump                                  FCLR1  458
      SpraykW = <tw:SPRAY-KW/CELL> * CellNum                                    FCLR1  459
      IF (<tw:SPRAY-CTRL> .EQ. CycleWithFan)  SpraykW = SpraykW * Sprayr        FCLR1  460
c                                                                               FCLR1  461
c ****         run function : FluidCooler_1-5                                   FCLR1  462
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        FCLR1  463
c                                                                               FCLR1  464
c                                                                               FCLR1  465
c              report variables                                                 FCLR1  466
 1000 <tw;KW>  = FankW                                                          FCLR1  467
      <tw;AUX> = TWRaux + SpraykW                                               FCLR1  468
      IF (<tw:PAN-HTR-TYPE> .NE. ElecPanHtr)  <tw;AUX_HEAT> = QpanLoss          FCLR1  469
c                                                                               FCLR1  470
c              hourly-report variables                                          FCLR1  471
      IF (<tw;HREP> .NE. 0  .AND.  IRSCH .NE. 0)  THEN                          FCLR1  472
c              full output maximum CAP                                          FCLR1  473
        TCAP = <pe;OPER_CAPACITY> * RANGE * <lp;BTUH/GPM-F>                     FCLR1  474
        CALL HourRepPLT(TWRSAV(1), <tw;HREP>, 19, 0)                            FCLR1  475
      ENDIF                                                                     FCLR1  476
c                                                                               FCLR1  477
      RETURN                                                                    FCLR1  478
      END                                                                       FCLR1  479
      FUNCTION GLHX_GroundDTpast(Jgl)                                           GLHXDT   2
c                                                                               GLHXDT   3
c              Calculates temperature differential between the far              GLHXDT   4
c              ground and the well, excluding the effect of the                 GLHXDT   5
c              current hour's load                                              GLHXDT   6
c                                                                               GLHXDT   7
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /GLHX  / iPnt(15)                                                 /GLHX/   2
c                                                                               GLHXDT  11
c              First, average heat input during past hours                      GLHXDT  12
      DO  IW=2,15                                                               GLHXDT  13
        IH = 8761 - iPnt(IW-1)                                                  GLHXDT  14
        Q1 = <gl;Q_8760>                                                        GLHXDT  15
        IH = 8761 - iPnt(IW)                                                    GLHXDT  16
        Q2 = <gl;Q_8760>                                                        GLHXDT  17
        <gl;Qaverage> = <gl;QaveragePast> + (Q1 - Q2)*<gl;fMult>                GLHXDT  18
      ENDDO                                                                     GLHXDT  19
c                                                                               GLHXDT  20
c              Find the ground temperature rise at well bore                    GLHXDT  21
      IW = 16                                                                   GLHXDT  22
      GLHX_GroundDTpast = <gl;TIME_WEIGHT> * <gl;Qyear> / 8760.0                GLHXDT  23
      DO  IW=2,15                                                               GLHXDT  24
        GLHX_GroundDTpast = GLHX_GroundDTpast                                   GLHXDT  25
     &                    + <gl;Qaverage>*<gl;TIME_WEIGHT>                      GLHXDT  26
      ENDDO                                                                     GLHXDT  27
c                                                                               GLHXDT  28
      RETURN                                                                    GLHXDT  29
      END                                                                       GLHXDT  30
      SUBROUTINE FluidCooler_1_Design                                           FCLR1d   2
c                                                                               FCLR1d   3
c                                                                               FCLR1d   4
c              Calculates the design data for a fluid cooler                    FCLR1d   5
c                                                                               FCLR1d   6
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /DESDAT/ ZCFM,ICFM,ZVENT,C1,IFLAG                                 /DESDAT/ 2
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /REPORT/ IREPRT(4,37),IPRG,IUNIQV(100),IUNIQS(100),IUNIQL         /REPORT/ 2
      COMMON  /TWRDAT/ TWRload,TCAP,TWRrej,CWgpm,TWRgpm,TWRsupply,              /TWRDAT/ 2
     &                 TWRset,Ttower,RANGE,APP,twr1FRA,GPMra,GPMcap,            /TWRDAT/ 3
     &                 GPMcell,NumCells,MinCells,MaxCells,Ttop,GPMtop,          /TWRDAT/ 4
     &                 Tbot,GPMbot,CFMra,FankWr,FankW,TWRaux,QpanLoss,          -034     2
     &                 QcoilLoss, SpraykW, Twet1, Tstart                        /TWRDAT/ 6
      DIMENSION        TWRSAV(25)                                               /TWRDAT/ 7
      EQUIVALENCE     (TWRSAV(1),TWRload)                                       /TWRDAT/ 8
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               FCLR1d  19
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
      COMMON  /TWRKY / Open, OpenHX, FluidCool,                                 /TWRKY/  2
     &                 Bypass, Speed1, Speed2, SpeedV, Damper,                  /TWRKY/  3
     &                 RunMinCells, RunMaxCells,                                /TWRKY/  4
     &                 ElecPanHtr, NoPanHtr, HWPanHtr,                          /TWRKY/  5
     &                 CycleWithFan, StayOn                                     /TWRKY/  6
      INTEGER          Open, OpenHX, FluidCool,                                 /TWRKY/  7
     &                 Bypass, Speed1, Speed2, SpeedV, Damper,                  /TWRKY/  8
     &                 RunMinCells, RunMaxCells,                                /TWRKY/  9
     &                 ElecPanHtr, NoPanHtr, HWPanHtr,                          /TWRKY/ 10
     &                 CycleWithFan, StayOn                                     /TWRKY/ 11
c                                                                               FCLR1d  24
c                                                                               FCLR1d  30
c                                                                               FCLR1d  31
c              pointer to cw loop                                               FCLR1d  32
        Jlp = <tw:CW-LOOP>                                                      FCLR1d  33
c              tower size                                                       FCLR1d  34
        IF (<tw:CAPACITY> .EQ. 0.)  THEN                                        FCLR1d  35
c              default tower size                                               FCLR1d  36
          IF (<tw:CAP-RATIO> .EQ. 0.)  THEN                                     -042L2  12
c              no capcity ratio specified - size equipment equally              FCLR1d  38
            TCAP = <lp;DES_CCAP> / FLOAT(<lp;CL_NUM_EQUIP>)                     FCLR1d  39
          ELSE                                                                  FCLR1d  40
            TCAP = <lp;DES_CCAP> * <tw:CAP-RATIO>                               FCLR1d  41
          ENDIF                                                                 FCLR1d  42
        ELSE                                                                    FCLR1d  43
          TCAP = <tw:CAPACITY>                                                  FCLR1d  44
        ENDIF                                                                   FCLR1d  45
c              number of cells - if not specified, do not allow to              FCLR1d  46
c              exceed 8MBTU each when autosizing                                FCLR1d  47
        IF (<tw:NUM-CELLS> .EQ. 0.)                                             FCLR1d  48
     &     <tw:NUM-CELLS> = FLOAT(INT(TCAP/8.0E6))                              FCLR1d  49
c              force to be whole real number                                    FCLR1d  50
        <tw:NUM-CELLS> = MAX(1.,FLOAT(INT(<tw:NUM-CELLS>+0.5)))                 FCLR1d  51
c              pick up temperature rise from loop if not specd.                 FCLR1d  52
        IF (<tw:CW-DT> .EQ. 0.)  <tw:CW-DT> = <lp:DESIGN-DT>                    FCLR1d  53
c              temperature change is positive for consistency with load         FCLR1d  54
        <tw:CW-DT> = ABS(<tw:CW-DT>)                                            FCLR1d  55
c              cw water flow - greater of load or flow requirement              -034    25
        CWload = TCAP / (<lp;BTUH/GPM-F>*<tw:CW-DT>)                            -034    26
        CWflow = <lp;DES_GPM> * TCAP/<lp;DES_CCAP>                              -034    27
        TWRgpm = MAX(CWload, CWflow)                                            -034    28
c              convert minimum flow from fraction to gpm                        FCLR1d  58
        <tw:CW-MIN-GPM> = TWRgpm * <tw:CW-MIN-GPM>                              FCLR1d  59
c              warn if loop pressure drop different than others                 FCLR1d  60
        IF (<tw:CW-PUMP> .EQ. 0)  THEN                                          FCLR1d  61
          IF (ABS(<tw:CW-HEAD>+<tw:CW-STATIC>                                   FCLR1d  62
     &         - (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>))                       FCLR1d  63
     &        / (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>) .GT. 0.05)  THEN        FCLR1d  64
            CALL MSGSIM(-3,II,II,II,II)                                         FCLR1d  65
            WRITE (IOUTPT,9107) (<tw:NAME>,II=1,8),                             FCLR1d  66
     &                          (<lp:NAME>,II=1,8)                              FCLR1d  67
          ENDIF                                                                 FCLR1d  68
        ENDIF                                                                   FCLR1d  69
c                                                                               FCLR1d  70
c              default range is same as loop temp change                        FCLR1d  71
      IF (<tw:DESIGN-RANGE> .EQ. 0.)                                            FCLR1d  72
     &    <tw:DESIGN-RANGE> = <tw:CW-DT>                                        FCLR1d  73
c              no tower if no flow                                              FCLR1d  74
      IF (TWRgpm .LT. .001)  THEN                                               FCLR1d  75
        <tw:CAPACITY> = 0.                                                      FCLR1d  76
        CALL MSGSIM(-3, II,II,II,II)                                            FCLR1d  77
        WRITE(IOUTPT,9100) (<tw:NAME>,II=1,8),                                  FCLR1d  78
     &                     (<lp:NAME>,II=1,8)                                   FCLR1d  79
        RETURN                                                                  FCLR1d  80
      ENDIF                                                                     FCLR1d  81
c              design the attached tower pump (not spray pump)                  FCLR1d  82
      IF (<tw:CW-PUMP> .GT. 0)  THEN                                            FCLR1d  83
        Jpm = <tw:CW-PUMP>                                                      FCLR1d  84
        CALL PUMPdes(TWRgpm)                                                    FCLR1d  85
c              increase default size by pump heat                               FCLR1d  86
        IF (<tw:CAPACITY> .EQ. 0.)  TCAP = TCAP + PMPQ                          FCLR1d  87
c              store pump heat as parasitic load for hourly OpCap calc          FCLR1d  88
        <tw;Q_PARASITIC> = PMPQ                                                 FCLR1d  89
c              store design variables for use in pump calcs                     FCLR1d  90
        <pm;MIN_GPM>     = <tw:CW-MIN-GPM>                                      FCLR1d  91
      ENDIF                                                                     FCLR1d  92
                                                                                -047i   25
c              Flow capacity at rated conditions                                -047i   26
      IF (<tw:CAPACITY> .gt. 0.) THEN                                           -047i   27
        GPMra = CVAL(<tw:GPM-fAPP&WB>,<tw:DESIGN-APPRO>,                        -047i   28
     &                                             <tw:DESIGN-WETBU>)           -047i   29
     &        / CVAL(<tw:GPM-fRNG&WB>,<tw:DESIGN-RANGE>,                        -047i   30
     &                                             <tw:DESIGN-WETBU>)           -047i   31
        GPMrated          = TCAP / (<tw:DESIGN-RANGE> * <lp;BTUH/GPM-F>)        -047i   32
        <tw;GPM/CELL_CTI> = GPMrated / (GPMra * <tw:NUM-CELLS>)                 -047i   33
      ELSE                                                                      -047i   34
        RANGE = TCAP / (Twrgpm * <lp;BTUH/GPM-F>)                               -047i   35
        GPMra = CVAL(<tw:GPM-fAPP&WB>,<tw:DESIGN-APPRO>,                        -047i   36
     &                                             <tw:DESIGN-WETBU>)           -047i   37
     &         / CVAL(<tw:GPM-fRNG&WB>,RANGE,<tw:DESIGN-WETBU>)                 -047i   38
        <tw;GPM/CELL_CTI> = Twrgpm / (GPMra * <tw:NUM-CELLS>)                   -047i   39
      ENDIF                                                                     -047i   40
c              store tower capacity                                             -047i   41
      <tw:CAPACITY> = TCAP                                                      -047i   42
c              maximum and minimum flowrate per cell - convert from             -047i   43
c              ratio to gpm                                                     -047i   44
      <tw;GPM/CELL>     = Twrgpm / <tw:NUM-CELLS>                               -047i   45
      <tw:CELL-MAX-GPM> = <tw;GPM/CELL_CTI> * <tw:CELL-MAX-GPM>                 -047i   46
      <tw:CELL-MAX-GPM> = Max(<tw:CELL-MAX-GPM>, <tw;GPM/CELL>)                 -047i   47
      <tw:CELL-MIN-GPM> = <tw;GPM/CELL_CTI> * <tw:CELL-MIN-GPM>                 -047i   48
                                                                                -047i   49
c              Condenser spray pump not simulated using pump component          -047i   50
c              because constant kW all hours of operation                       -047i   51
      IF (<tw:SPRAY-KW/CELL> .EQ. 0.)                                           -047i   52
     &  <tw:SPRAY-KW/CELL> = <tw;GPM/CELL_CTI> * <tw:SPRAY-KW/GPM>              -047i   53
c              no convective cooling if spray pump cycles with fan              -047i   54
      IF (<tw:SPRAY-CTRL> .EQ. CycleWithFan)  <tw:FAN-OFF-CFM> = 0.             -047i   55
c                                                                               FCLR1d 118
c              tower fan energy per cell.  If not user-defined, default         FCLR1d 119
c              is 0.088 HP/GPM @ CTI nominal rating, which is the default       FCLR1d 120
c              eir                                                              FCLR1d 121
      IF (<tw:FAN-KW/CELL> .EQ. 0.)                                             FCLR1d 122
     &  <tw:FAN-KW/CELL> =                                                      FCLR1d 123
     &        <tw;GPM/CELL_CTI> * 500.4 * 10. * <tw:EIR> * KWBTU                FCLR1d 124
c              total fan kW for all cells, plus auxiliary                       FCLR1d 125
      <tw;DES_KW> = <tw:FAN-KW/CELL> * <tw:NUM-CELLS> + <tw:AUX-KW>             FCLR1d 126
c              default low-speed kW according to the speed curve                FCLR1d 127
      IF (<tw:CAP-CTRL> .EQ. Speed2  .AND.  <tw:FAN-LOW-ELEC> .EQ. 0.)          FCLR1d 128
     &  <tw:FAN-LOW-ELEC> = CVAL(<tw:KW-fSPEED>, <tw:FAN-LOW-CFM>,              FCLR1d 129
     &                                           <tw:FAN-LOW-CFM>)              FCLR1d 130
c                                                                               FCLR1d 131
c              When the loop temperature control strategy is LOAD-RESET,        FCLR1d 132
c              the tower fan must be 2-speed or variable-speed.                 FCLR1d 133
      IF (<lp:CL-SETPT-CTRL> .EQ. LOAD                                          FCLR1d 134
     &                         .AND.  <tw:CAP-CTRL> .NE. Speed2                 FCLR1d 135
     &                         .AND.  <tw:CAP-CTRL> .NE. SpeedV)  THEN          FCLR1d 136
        CALL MSGSIM(-2,II,II,II,II)                                             FCLR1d 137
        WRITE (IOUTPT,9102)  (<tw:NAME>,II=1,8)                                 FCLR1d 138
        <lp:CL-SETPT-CTRL> = FIXED                                              FCLR1d 139
      ENDIF                                                                     FCLR1d 140
c                                                                               FCLR1d 141
c              Design the dry coil heat exchanger.                              FCLR1d 142
      IF (<tw:DRY-HX> .GT. 0.)  THEN                                            FCLR1d 143
c              load per cell                                                    FCLR1d 144
        Qhx = <tw;GPM/CELL_CTI> * 500.4 * 10.                                   FCLR1d 145
c              loop temperature entering hx                                     FCLR1d 146
        Treturn = <lp:DESIGN-COOL-T> + RANGE                                    Chlr1 2880
c              loop flow per cell, gpm                                          FCLR1d 148
        GPMcell = TWRgpm / <tw:NUM-CELLS>                                       FCLR1d 149
c              airflow per cell, cfm                                            FCLR1d 150
        CFMcell = <tw;GPM/CELL_CTI> * <tw:CFM/GPM> * <tw:DRY-AIR-RATIO>         FCLR1d 151
c              entering air condition                                           FCLR1d 152
        Tair = Treturn - <tw:DRY-INLET-DT>                                      FCLR1d 153
c              humidity ratio at 50% relative humidity                          FCLR1d 154
        Wair = WFUNC(Tair,50.,BLDGP)                                            FCLR1d 155
c              specific volume                                                  FCLR1d 156
        Vair = 0.754*(Tair+459.7)*(1.0+1.605*Wair)/BLDGP                        FCLR1d 157
c              specific heat of air, Btu/CFM-F                                  FCLR1d 158
        AirCp = (0.24 + 0.444*Wair) * 60. / Vair                                FCLR1d 159
c              design the heat exchanger                                        FCLR1d 160
        CALL HeatExchanger_Design(<tw:DRY-HX>, Jtw, Jlp, Qhx,                   FCLR1d 161
     &                  CFMcell,           AirCp,    Tair,          xxx,        FCLR1d 162
     &                  GPMcell, <lp;BTUH/GPM-F>, Treturn, <tw:CW-HEAD>)        FCLR1d 163
        <tw;MAX_DRY_CFM> = CFMcell                                              FCLR1d 164
      ENDIF                                                                     FCLR1d 165
c                                                                               FCLR1d 166
c              Set up the pan heater if required                                FCLR1d 167
      IF (<tw:PAN-HTR-TYPE> .NE. NoPanHtr)  THEN                                FCLR1d 168
        IF (<tw:PAN-LOSS> .EQ. 0.)  THEN                                        FCLR1d 169
            <tw:PAN-LOSS> = <tw;GPM/CELL_CTI> * 500.4 * 10.                     FCLR1d 170
     &                    * <tw:PAN-LOSS-RATI> * <tw:NUM-CELLS>                 FCLR1d 171
        ELSE                                                                    FCLR1d 172
            <tw:PAN-LOSS> = -<tw:PAN-LOSS>                                      FCLR1d 173
        ENDIF                                                                   FCLR1d 174
c              effective loss coefficient                                       FCLR1d 175
        Tair = <tw:PAN-AMBIENT>                                                 FCLR1d 176
        Tpan = <tw:PAN-FLUID-T>                                                 FCLR1d 177
        dT   = Tair - Tpan                                                      FCLR1d 178
        IF (dT .GE. 0.)  THEN                                                   FCLR1d 179
          CALL MSGSIM(-1,II,II,II,II)                                           FCLR1d 180
          WRITE (IOUTPT, 9104)  (<tw:NAME>,II=1,8), Tair, Tpan                  FCLR1d 181
          call MessageBox( NULL, 'TOWER pan loss error -'                       FCLR1d 182
     &      //' ABORTING'//char(0),'OTWRD Errors'//char(0), MB_OK               FCLR1d 183
     &      + MB_ICONSTOP + MB_TASKMODAL )                                      FCLR1d 184
          RETURN                                                                FCLR1d 186
        ENDIF                                                                   FCLR1d 187
        <tw;PAN_UA> = <tw:PAN-LOSS>                                             FCLR1d 188
     &              / (dT * SurfaceFilmAdj(Tpan, Tair, <tw:PAN-WIND>))          FCLR1d 189
c              design flow                                                      FCLR1d 190
        IF (<tw:PAN-HTR-TYPE> .EQ. HWPanHtr)                                    -034    29
     &    <tw;PAN_DES_GPM> = -<tw:PAN-LOSS>                                     -034    30
     &                               / (<lp;BTUH/GPM-F>*<tw:PAN-HTR-DT>)        -034    31
      ENDIF                                                                     FCLR1d 193
c                                                                               FCLR1d 194
c              total primary loop equipment capacity                            FCLR1d 195
 100  <lp;PRIMARY_CCAP> = <lp;PRIMARY_CCAP> + <tw:CAPACITY>                     FCLR1d 196
c              save design variables for use in PrimaryEquip                    FCLR1d 197
      Jpe = <tw;Jpe>                                                            FCLR1d 198
      <pe;Jpm>        = <tw:CW-PUMP>                                            FCLR1d 199
      <pe;DES_GPM>    = TWRgpm                                                  FCLR1d 200
      <pe;MAX_GPM>    = <tw:CELL-MAX-GPM>*<tw:NUM-CELLS>                        FCLR1d 201
      <pe;DES_HEAD>   = <tw:CW-HEAD>                                            FCLR1d 202
      <pe;DES_STATIC> = <tw:CW-STATIC>                                          FCLR1d 203
      <pe:ISOLATION>  = 1                                                       FCLR1d 204
      IF (<pe;MAX_GPM> .LT. <lp:RECIRC-GPM>  .OR.                               -035    65
     &    <pe;MAX_GPM> .LT. <lp:MIN-GPM>)    THEN                               -035    66
        CALL MSGSIM(-3,II,II,II,II)                                             -035    67
        WRITE (IOUTPT, 9001)  (<tw:NAME>,II=1,8)                                -035    68
      ENDIF                                                                     -035    69
c                                                                               FCLR1d 205
c              dump tower design variables if needed                            FCLR1d 206
      IF (IREPRT(3,34) .GT. 0)                                                  FCLR1d 207
     &  WRITE(IOUTPT,9000) (<tw:NAME>,II=1,8),<tw:CAPACITY>,                    FCLR1d 208
     &  <tw:NUM-CELLS>,RANGE, GPMra, <tw:CELL-MAX-GPM>,                         FCLR1d 209
     &  <tw:CELL-MIN-GPM>,<tw;GPM/CELL_CTI>,<tw:FAN-KW/CELL>,                   FCLR1d 210
     &  TWRgpm                                                                  FCLR1d 211
c                                                                               FCLR1d 212
      RETURN                                                                    FCLR1d 213
c                                                                               FCLR1d 214
c              dump formats                                                     FCLR1d 215
 9000 FORMAT(' ',8A4,                                                           FCLR1d 216
     &      /    17X,'     SIZE   NumCells     RANGE    GPMra    GPMMAX'        FCLR1d 217
     &      /    17X,     F10.1,    F10.1,    F10.1,    F10.1,    F10.1         FCLR1d 218
     &      /    17X,'   GPMMIN    GPMCTI    EFCELL    DESGPM          '        FCLR1d 219
     &      /    17X,     F10.1,    F10.1,    F10.1,    F10.1          )        FCLR1d 220
c              message formats                                                  FCLR1d 221
 9001 FORMAT(14X,8A4,' has a maximum flow smaller'                     /        -035    70
     &       14X,'than the loops minimum flow, and will never be used' /        -035    71
     &       14X,'by itself.'                                          )        -035    72
 9100 FORMAT(14X,'Tower: ',8A4,' on loop ',8A4                         /        FCLR1d 222
     &       14X,'is not needed.  No simulation will be performed.    ')        FCLR1d 223
 9101 FORMAT(14X,'unused'                                              )        FCLR1d 224
 9102 FORMAT(14X,'Tower: ',8A4,' must have a 2-speed or'               /        FCLR1d 225
     &       14X,'variable-speed fan for the condenser loop LOAD-RESET'/        FCLR1d 226
     &       14X,'temperature control strategy to work.  The control'  /        FCLR1d 227
     &       14X,'strategy has been changed to FIXED.'                 )        FCLR1d 228
 9104 FORMAT(14X,'Tower: ',8A4,' is specified to have'                 /        FCLR1d 229
     &       14X,'pan losses, but the design outdoor temperature is '  /        FCLR1d 230
     &       14X,'higher than the design pan temperature.'             /        FCLR1d 231
     &       14X,'Outdoor T: ',F5.1,' Pan setpoint: ',F5.1             )        FCLR1d 232
 9107 FORMAT(14X,'Plant equipment: ',8A4,' has a different'            /        FCLR1d 233
     &       14X,'pressure drop on loop: ',8A4,' than the'             /        FCLR1d 234
     &       14X,'other equipment.  This is unusual unless the loop'   /        FCLR1d 235
     &       14X,'uses flow meters or other dynamic flow control'      /        FCLR1d 236
     &       14X,'devices to allocate the flow on an hourly basis to'  /        FCLR1d 237
     &       14X,'the active equipment.'                               )        FCLR1d 238
c                                                                               FCLR1d 239
      END                                                                       FCLR1d 240
      SUBROUTINE GLHX_Horizontal(Mode,Icall)                                    GLHXH    2
c                                                                               GLHXH    3
c              Simulates a ground-loop heat-exchanger with a                    GLHXH    4
c              one or more horizontal trenches                                  GLHXH    5
c                                                                               GLHXH    6
c              Mode =  1  Heating mode                                          GLHXH    7
c                      2  Cooling mode                                          GLHXH    8
c                                                                               GLHXH    9
c              Icall = 1  Operating capacity                                    GLHXH   10
c                      2  Output temperature                                    GLHXH   11
c                      3  Update history                                        GLHXH   12
c                                                                               GLHXH   13
c                                                                               /JJHLIT/ 2
c              Original DOE-2 Ground HX models developed by                     -044d    1
c                            R. Merriam, Arthur D Little (617-498-5887)         /JJHLIT/ 4
c                            August 29, 1995                                    /JJHLIT/ 5
c                                                                               /JJHLIT/ 6
c              and IMPLEMENTATION BY                                            -044d    2
c                            S. D. Gates                                        /JJHLIT/ 8
c                            J. J. Hirsch                                       /JJHLIT/ 9
c                            James J. Hirsch & Associates                       /JJHLIT/10
c                            Camarillo, California                              /JJHLIT/11
c                                                                               /JJHLIT/12
Copyright (c) 1997 by James J. Hirsch. All Rights Reserved. Unpublished         /JJHLIT/13
c rights reserved under the Copyright Laws of the United States.                /JJHLIT/14
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHLIT/15
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHLIT/16
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHLIT/17
c                                                                               /JJHLIT/18
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /DESHRQ/ NDESDY, IDDTYP(2), DESHRQ(360)                           Time     1
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /GLHX  / iPnt(15)                                                 /GLHX/   2
      COMMON  /GLHXD / QLoad,GPM,OperCap,OutletT,FarGroundT,                    /GLHXD/  2
     &                 GroundDeltaT,QdeltaT,LoopDeltaT,Qrate,Runtime,           /GLHXD/  3
     &                 spare(10)                                                /GLHXD/  4
      REAL             LoopDeltaT                                               /GLHXD/  5
      DIMENSION        GLHXDAT(20)                                              /GLHXD/  6
      EQUIVALENCE     (GLHXDAT(1), QLoad)                                       /GLHXD/  7
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
c                                                                               GLHXH   24
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
c                                                                               GLHXH   28
c                                                                               GLHXH   29
      DATA PI / 3.1415927 /                                                     GLHXH   30
c                                                                               GLHXH   31
c                                                                               GLHXH   32
c ****         run function : GLHX_Horizontal-1                                 GLHXH   33
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        GLHXH   34
c                                                                               GLHXH   35
      GOTO (1000,2000,3000), Icall                                              GLHXH   36
c                                                                               GLHXH   37
c============= ROUTINE CALLED TO GET OPERATING CAPACITY ======================= GLHXH   38
c                                                                               GLHX1  105
 1000 CONTINUE                                                                  GLHX1  106
c              Far field ground temperature - function of depth and             GLHX1  107
c              time of year                                                     GLHX1  108
      ARGdepth = <gl;AVERAGE_DEPTH>                                             GLHX1  109
     &                   * SQRT (PI / (365.0 * 24.0 * <gl:GRND-DIFFUS>))        GLHX1  110
      ARGtime = 2.0 * PI / 365.0 * (IDOY - <gl:GRND-PHASE-C>                    GLHX1  111
     &               - <gl;AVERAGE_DEPTH> / 2.0                                 GLHX1  112
     &                      * SQRT (365.0 / (PI*24.0*<gl:GRND-DIFFUS>)))        GLHX1  113
      <gl;FarGroundT> = <gl:REF-GRND-TEMP>                                      GLHX1  114
     &              - <gl:GRND-YR-SWING> * EXP(-ARGdepth) * COS(ARGtime)        GLHX1  115
c                                                                               GLHX1  116
      IF (Mode .EQ. HeatMode)  THEN                                             GLHX1  117
c              heating mode capacity is in Btuh                                 GLHX1  118
        <pe;OPER_CAPACITY> = <gl:CAPACITY>                                      GLHX1  119
c              make maximum capacity big so all load will be assigned           GLHX1  120
        <pe;MAX_CAPACITY>  = <gl:CAPACITY> * 10.                                GLHX1  121
        RETURN                                                                  GLHX1  122
      ELSE                                                                      GLHX1  123
c              Heat-rejection capacity is in gpm                                GLHX1  124
        IF (<gl;Initialized> .EQ. 0)  THEN                                      GLHX1  125
c              still in design day calcs                                        GLHX1  126
          GPMcap = <gl:HX-MAX-GPM>                                              GLHX1  127
        ELSE                                                                    GLHX1  128
c              Normal operation - get near ground temperature, excluding        GLHX1  129
c              effect of current hour's load                                    GLHX1  130
          GroundDeltaT = GLHX_GroundDTpast(Jgl)                                 GLHX1  131
c              effect of run time - assume very small runtime has               GLHX1  132
c              same effect as large                                             GLHX1  133
          RunTime = <lp;RUN_FRACTION>                                           GLHX1  134
          IF (RunTime .LT. 0.1)  RunTime = 1.0                                  GLHX1  135
c              load field can handle at current setpoint                        GLHX1  136
          IW    = 1                                                             GLHX1  137
          Qload = (<lp;COOL_SETPT> - (<gl;FarGroundT>+GroundDeltaT))            GLHX1  138
     &         / (<gl;TIME_WEIGHT>/<gl;NUM_WELLS> + <gl;FACTOR>/RunTime)        GLHX1  139
          IF (QloopNet .GT. 0.)  THEN                                           GLHX1  140
            GPMcap = MAX(Qload/QloopNet * GPMs, 1.0)                            GLHX1  141
            GPMcap = MIN(GPMcap, <gl:HX-MAX-GPM>)                               GLHX1  142
          ELSE                                                                  GLHX1  143
            GPMcap = <gl:HX-MAX-GPM>                                            GLHX1  144
          ENDIF                                                                 GLHX1  145
        ENDIF                                                                   GLHX1  146
        <pe;OPER_CAPACITY> = GPMcap                                             GLHX1  147
        <pe;MAX_CAPACITY>  = GPMcap                                             GLHX1  148
      ENDIF                                                                     GLHX1  149
c                                                                               GLHX1  150
c ****         run function : GLHX_Vertical-2                                   GLHX1  151
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        GLHX1  152
c                                                                               GLHX1  153
      RETURN                                                                    GLHX1  154
c                                                                               GLHXH   56
c                                                                               GLHXH   57
c============= ROUTINE CALLED TO CALCULATE OUTPUT TEMPERATURE ================= GLHXH   58
c              zero hourly data                                                 GLHXH   59
 2000 CALL FILLN(0., GLHXDAT(1), IVTLIM(2,27))                                  GLHXH   60
c              total equipment pump kW                                          GLHXH   61
      AuxPumpKW  = 0.                                                           GLHXH   62
c              condenser loop flow thru this glhx                               GLHXH   63
      GPM = <pe;GPM>                                                            GLHXH   64
c                                                                               GLHXH   65
c ****         run function : GLHX_Horizontal-3                                 GLHXH   66
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        GLHXH   67
c                                                                               GLHXH   68
c              hourly load and operating capacity                               GLHXH   69
      IF (Mode .EQ. 1)  THEN                                                    GLHXH   70
c              make heating loads negative                                      GLHXH   71
        QLoad = -<pe;LOAD>                                                      GLHXH   72
        <pe;LOAD> = QLoad                                                       GLHXH   73
      ELSE                                                                      GLHXH   74
        QLoad = <pe;LOAD>                                                       GLHXH   75
      ENDIF                                                                     GLHXH   76
c              operating capacity                                               GLHXH   77
      OperCap = <pe;OPER_CAPACITY>                                              GLHXH   78
c                                                                               GLHXH   79
c              skip rest if design day                                          GLHXH   80
      IF (IDDFLG .GT. 0)  THEN                                                  GLHXH   81
        IF (Mode .EQ. HEATMODE)  THEN                                           GLHXH   82
c              heating mode - use loop heating setpoint                         GLHXH   83
          <pe;SUPPLY_T> = <lp;HEAT_SETPT>                                       GLHXH   84
        ELSE                                                                    GLHXH   85
          <pe;SUPPLY_T> = <lp;COOL_SETPT>                                       GLHXH   86
        ENDIF                                                                   GLHXH   87
        RETURN                                                                  GLHXH   88
      ELSEIF (<gl;Initialized> .EQ. 0)  THEN                                    GLHXH   89
c              initialize history if first hour of real simulation              GLHXH   90
        CALL GLHX_Horizontal_Design(2)                                          GLHXH   91
      ENDIF                                                                     GLHXH   92
c                                                                               GLHXH   93
c              Adjust averaged heat inputs over the time increments.            GLHXH   94
c              Use concept of moving pointer to determine average heat          GLHXH   95
c              inputs over portions of the year.  Do once for cooling           GLHXH   96
c              mode, and then repeat for heating mode only if heating           GLHXH   97
c              actually required (meaning cooling was bogus).                   GLHXH   98
      IF (Mode .NE. HEATMODE                                                    GLHXH   99
     &          .OR.  (Mode .EQ. HEATMODE  .AND.  Qload .LT. 0.))  THEN         GLHXH  100
c              Effect of current load on ground deltaT                          GLHX1  155
        IW = 1                                                                  GLHX1  156
        <gl;Qaverage> = QLoad / <gl;NUM_WELLS>                                  GLHX1  157
        GroundDeltaT  = <gl;Qaverage>*<gl;TIME_WEIGHT>                          GLHX1  158
c              include effect of past hours                                     GLHX1  159
        GroundDeltaT  = GroundDeltaT + GLHX_GroundDTpast(Jgl)                   GLHX1  160
c                                                                               GLHX1  161
c              Determine heat input RATE during time the pump is on             GLHX1  162
        Runtime = <lp;RUN_FRACTION>                                             GLHX1  163
        IF (Runtime .LT. 0.10)  RunTime = 1.0                                   GLHX1  164
        Qrate = Qload / RunTime                                                 GLHX1  165
c              delta T due to load                                              GLHX1  166
        QDeltaT = <gl;FACTOR>*Qrate                                             GLHX1  167
c                                                                               GLHX1  168
c              Outlet temperature.                                              GLHX1  169
        OutletT = <gl;FarGroundT> + GroundDeltaT + QDeltaT                      GLHX1  170
c                                                                               GLHXH  145
c              temperature change in loop                                       GLHXH  146
        IF (GPM .GT. 0.)  LoopDeltaT = QLoad / (<lp;BTUH/GPM-F> * GPM)          GLHXH  147
c                                                                               GLHXH  148
c ****         run function : GLHX_Horizontal-4                                 GLHXH  149
c       IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                      GLHXH  150
c                                                                               GLHXH  151
c              Check if GLHX is producing an unrealistic outlet T               -045h    6
        IF (OutletT .gt. 150.  .or.  OutletT .lt. 0.) THEN                      -045h    7
          Call MsgSim(-1,ii,ii,ii,ii)                                           -045h    8
          Write (IOUTPT, 9101) (<gl:NAME>,II=1,8), Int(OutletT),                -045h    9
     &                         IMO,IDAY,IHR                                     -045h   10
          CALL MessageBox( NULL,                                                -045h   11
     &      'GLHX is undersized and is'//char(10)//char(13)//                   -045h   12
     &      ' producing an extreme temperature'//char(0),                       -045h   13
     &      'GLHX Errors'//char(0),                                             -045h   14
     &      MB_OK + MB_ICONSTOP + MB_TASKMODAL )                                -045h   15
        ENDIF                                                                   -045h   16
 9101   FORMAT(14x,'Ground-loop HX: ',8A4,                             /        -045h   17
     &  14x,'is undersized for the load and is producing an extreme'   /        -045h   18
     &  14x,'temperature of',I6'F.  Mon/Day/Hr: ',I2,'/',I2,'/',I2     )        -045h   19
                                                                                -045h   20
c              report variables                                                 GLHXH  152
        <pe;SUPPLY_T> = OutletT                                                 GLHXH  153
c                                                                               GLHXH  154
c              hourly-report variables                                          GLHXH  155
        IF (<gl;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                              GLHXH  156
     &    CALL HourRepPLT(GLHXDAT(1), <gl;HREP>, 27, 0)                         GLHXH  157
      ENDIF  ! Mode                                                             GLHXH  158
c                                                                               GLHXH  159
      RETURN                                                                    GLHXH  160
c                                                                               GLHXH  161
c                                                                               GLHXH  162
c============= ROUTINE CALLED TO UPDATE HISTORY =============================== GLHXH  163
c              Move the pointers iPnt(I) to account for next hour.  Note        GLHXH  164
c              that all glhx components use the same set - update only          GLHXH  165
c              once per hour                                                    GLHXH  166
 3000 IF (Jgl .EQ. Igl)  THEN                                                   GLHXH  167
        DO  I=1,15                                                              GLHXH  168
          iPnt(i) = iPnt(i) - 1                                                 GLHXH  169
          IF (iPnt(i) .EQ. 0)  iPnt(i) = 8760                                   GLHXH  170
        ENDDO                                                                   GLHXH  171
      ENDIF                                                                     GLHXH  172
c              Store value of past hour's heat input to ground                  GLHXH  173
      IH = 8761 - iPnt(1)                                                       GLHXH  174
      IW = 1                                                                    GLHXH  175
      <gl;Q_8760> = <gl;Qaverage>                                               GLHXH  176
c              Transfer current weighted heat input to past for use             GLHXH  177
c              next hour                                                        GLHXH  178
      DO  IW=1,15                                                               GLHXH  179
        <gl;QaveragePast> = <gl;Qaverage>                                       GLHXH  180
      ENDDO                                                                     GLHXH  181
c                                                                               GLHXH  182
c ****         run function : GLHX_Horizontal-5                                 GLHXH  183
c       IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                      GLHXH  184
c                                                                               GLHXH  185
c                                                                               GLHXH  186
      RETURN                                                                    GLHXH  187
      END                                                                       GLHXH  188
      SUBROUTINE GLHX_Horizontal_Design(Mode)                                   GLHXHD   2
c                                                                               GLHXHD   3
c              Sets up a horizontal ground-loop heat-exchanger                  GLHXHD   4
c                                                                               GLHXHD   5
c              Mode = 1  Setup the circulation-loop interface                   GLHXHD   6
c                     2  Setup the ground field parameters and                  GLHXHD   7
c                        initialize the history                                 GLHXHD   8
c                                                                               GLHXHD   9
c                                                                               /JJHLIT/ 2
c              Original DOE-2 Ground HX models developed by                     -044d    1
c                            R. Merriam, Arthur D Little (617-498-5887)         /JJHLIT/ 4
c                            August 29, 1995                                    /JJHLIT/ 5
c                                                                               /JJHLIT/ 6
c              and IMPLEMENTATION BY                                            -044d    2
c                            S. D. Gates                                        /JJHLIT/ 8
c                            J. J. Hirsch                                       /JJHLIT/ 9
c                            James J. Hirsch & Associates                       /JJHLIT/10
c                            Camarillo, California                              /JJHLIT/11
c                                                                               /JJHLIT/12
Copyright (c) 1997 by James J. Hirsch. All Rights Reserved. Unpublished         /JJHLIT/13
c rights reserved under the Copyright Laws of the United States.                /JJHLIT/14
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHLIT/15
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHLIT/16
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHLIT/17
c                                                                               /JJHLIT/18
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /GLHX  / iPnt(15)                                                 /GLHX/   2
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
c                                                                               GLHXHD  17
      REAL Mcp                                                                  GLHXHD  18
c              Note: dimension 16 is for previous years                         GLHXHD  19
      DIMENSION Gi(16), iPntSet(15)                                             GLHXHD  20
      DIMENSION d_2(4),  h_2(4),  f_2(4)                                        GLHXHD  21
      DIMENSION d_3(10), h_3(10), f_3(10)                                       GLHXHD  22
      DIMENSION d_4(5),  w_4(5),  f_4(5)                                        GLHXHD  23
      DIMENSION d_5(14), h_5(14), w_5(14), f_5(14)                              GLHXHD  24
c                                                                               GLHXHD  25
      DATA PI / 3.1415927 /                                                     GLHXHD  26
      DATA iPntSet / 1, 2, 3, 6, 12, 24, 48, 96, 192, 384, 768, 1536,           GLHXHD  27
     &               2184, 4368, 8760 /                                         GLHXHD  28
c              Coefficients for calculating the ground resistance               GLHXHD  29
      DATA d_2 / 0.0,  1.0,  1.0,  1.0 /                                        GLHXHD  30
      DATA h_2 / 1.0,  0.0, -1.0, -2.0 /                                        GLHXHD  31
      DATA f_2 / 1.0, -0.5, -1.0, -0.5 /                                        GLHXHD  32
c                                                                               GLHXHD  33
      DATA d_3 / 0.0,  0.0,  0.0,  1.0,  1.0,  1.0,  1.0,  1.0,  1.0,           GLHXHD  34
     &           1.0 /                                                          GLHXHD  35
      DATA h_3 / 1.0,  2.0,  3.0,  0.0, -1.0, -2.0, -3.0, -4.0, -5.0,           GLHXHD  36
     &          -6.0 /                                                          GLHXHD  37
      DATA f_3 / 1.5,  1.0,  0.5, -0.25, -0.5, -0.75, -1.0, -0.75,              GLHXHD  38
     &          -0.5, -0.25 /                                                   GLHXHD  39
c                                                                               GLHXHD  40
      DATA d_4 / 0.0,  0.0,  1.0,  1.0,  1.0 /                                  GLHXHD  41
      DATA w_4 / 1.0, -1.0,  0.0,  1.0, -1.0 /                                  GLHXHD  42
      DATA f_4 / 0.5,  0.5, -1.0, -0.5, -0.5 /                                  GLHXHD  43
c                                                                               GLHXHD  44
      DATA d_5 / 0.0,  0.0,  0.0,  0.0,  0.0,  1.0,  1.0,  1.0,  1.0,           GLHXHD  45
     &           1.0,  1.0,  1.0,  1.0,  1.0 /                                  GLHXHD  46
      DATA h_5 / 0.0,  0.0,  1.0,  1.0,  1.0,  0.0, -1.0,  0.0, -1.0,           GLHXHD  47
     &           0.0, -1.0, -2.0, -2.0, -2.0 /                                  GLHXHD  48
      DATA w_5 / 1.0, -1.0,  0.0,  1.0, -1.0,  0.0,  0.0,  1.0,  1.0,           GLHXHD  49
     &          -1.0, -1.0,  0.0,  1.0, -1.0 /                                  GLHXHD  50
      DATA f_5 / 0.5,  0.5,  1.0,  0.5,  0.5, -0.5, -1.0, -0.25, -0.5,          GLHXHD  51
     &          -0.25, -0.5, -0.5, -0.25, -0.25 /                               GLHXHD  52
c                                                                               GLHXHD  53
c                                                                               GLHXHD  59
c                                                                               GLHXHD  60
c              pointer to cw loop                                               GLHXHD  61
      Jlp = <gl:LOOP>                                                           GLHXHD  62
c                                                                               GLHXHD  63
      IF (Mode .EQ. 2)  GOTO 2000                                               GLHXHD  64
c                                                                               GLHXHD  65
c============= SETUP THE LOOP INTERFACE ======================================= GLHXHD  66
c              design capacity                                                  -034    32
      Qloop = MAX(<lp;DES_CCAP>, ABS(<lp;DES_HCAP>))                            -034    33
      IF (<gl:CAPACITY> .EQ. 0.)  THEN                                          -034    34
        QLoad = Qloop                                                           -034    35
        IF (<gl:CAP-RATIO> .EQ. UNFILD)  THEN                                   GLHXHD  70
c              no capacity ratio specified - size equipment equally             GLHXHD  71
          QLoad = QLoad / FLOAT(<lp;CL_NUM_EQUIP>)                              GLHXHD  72
        ELSE                                                                    GLHXHD  73
          QLoad = QLoad * <gl:CAP-RATIO>                                        GLHXHD  74
        ENDIF                                                                   GLHXHD  75
      ELSE                                                                      GLHXHD  76
        QLoad = <gl:CAPACITY>                                                   GLHXHD  77
      ENDIF                                                                     GLHXHD  78
c              no glhx if no flow                                               GLHXHD  79
      IF (QLoad .LT. 1.)  THEN                                                  GLHXHD  80
        <gl:CAPACITY> = 0.                                                      GLHXHD  81
        CALL MSGSIM(-3, II,II,II,II)                                            GLHXHD  82
        WRITE(IOUTPT,9100) (<gl:NAME>,II=1,8),                                  GLHXHD  83
     &                     (<lp:NAME>,II=1,8)                                   GLHXHD  84
        RETURN                                                                  GLHXHD  85
      ENDIF                                                                     GLHXHD  86
      <gl:CAPACITY> = QLoad                                                     GLHXHD  87
c                                                                               GLHXHD  88
c              pick up component dT from loop if not specd.                     GLHXHD  89
      IF (<gl:HX-DT> .EQ. 0.)  <gl:HX-DT> = <lp:DESIGN-DT>                      GLHXHD  90
c              design flow - greater of load or flow requirement                -034    36
      GPMload = QLoad / (<lp;BTUH/GPM-F> * <gl:HX-DT>)                          -034    37
      GPMflow = <lp;DES_GPM> * Qload/Qloop                                      -034    38
      GPM     = MAX(GPMload, GPMflow)                                           -034    39
c              convert minimum and maximum flow from fraction to gpm            GLHXHD  93
      <gl:HX-MIN-GPM> = GPM * <gl:HX-MIN-GPM>                                   GLHXHD  94
      <gl:HX-MAX-GPM> = GPM * <gl:HX-MAX-GPM>                                   GLHXHD  95
      IF (<gl:HX-MAX-GPM> .LT. <lp:RECIRC-GPM>  .OR.                            -035    73
     &    <gl:HX-MAX-GPM> .LT. <lp:MIN-GPM>)    THEN                            -035    74
        CALL MSGSIM(-3,II,II,II,II)                                             -035    75
        WRITE (IOUTPT, 9001)  (<gl:NAME>,II=1,8)                                -035    76
      ENDIF                                                                     -035    77
c                                                                               GLHXHD  96
c              warn if loop pressure drop different than others                 GLHXHD  97
      IF (<gl:HX-PUMP> .EQ. 0)  THEN                                            GLHXHD  98
        IF (ABS(<gl:HX-HEAD>+<gl:HX-STATIC>                                     GLHXHD  99
     &       - (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>))                         GLHXHD 100
     &      / (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>) .GT. 0.05)  THEN          GLHXHD 101
          CALL MSGSIM(-3,II,II,II,II)                                           GLHXHD 102
          WRITE (IOUTPT,9107) (<gl:NAME>,II=1,8),                               GLHXHD 103
     &                        (<lp:NAME>,II=1,8)                                GLHXHD 104
        ENDIF                                                                   GLHXHD 105
      ENDIF                                                                     GLHXHD 106
c              design the attached pump                                         GLHXHD 107
      IF (<gl:HX-PUMP> .GT. 0)  THEN                                            GLHXHD 108
        Jpm = <gl:HX-PUMP>                                                      GLHXHD 109
c                                                                               GLHXHD 110
        CALL PUMPdes(GPM)                                                       GLHXHD 111
        <pm;MIN_GPM> = <gl:HX-MIN-GPM>                                          GLHXHD 112
      ENDIF                                                                     GLHXHD 113
c              total primary loop equipment capacity                            GLHXHD 114
      <lp;PRIMARY_CCAP> = <lp;PRIMARY_CCAP> + QLoad                             GLHXHD 115
      <lp;PRIMARY_HCAP> = <lp;PRIMARY_HCAP> - QLoad                             GLHXHD 116
                                                                                GLHXHD 117
c              save design variables for use in PrimaryEquip                    GLHXHD 118
c              heat-rejection mode                                              GLHXHD 119
      Jpe = <gl;Jpe>                                                            GLHXHD 120
      <pe;Jpm>        = <gl:HX-PUMP>                                            GLHXHD 121
      <pe;DES_GPM>    = GPM                                                     GLHXHD 122
      <pe;MAX_GPM>    = <gl:HX-MAX-GPM>                                         GLHXHD 123
      <pe;DES_HEAD>   = <gl:HX-HEAD>                                            GLHXHD 124
      <pe;DES_STATIC> = <gl:HX-STATIC>                                          GLHXHD 125
      <pe:ISOLATION>  = 1                                                       GLHXHD 126
c              heat-absorption mode                                             GLHXHD 127
      Jpe = <gl;Jpe_HEAT>                                                       GLHXHD 128
      <pe;Jpm>        = <gl:HX-PUMP>                                            GLHXHD 129
      <pe;DES_GPM>    = GPM                                                     GLHXHD 130
      <pe;MAX_GPM>    = <gl:HX-MAX-GPM>                                         GLHXHD 131
      <pe;DES_HEAD>   = <gl:HX-HEAD>                                            GLHXHD 132
      <pe;DES_STATIC> = <gl:HX-STATIC>                                          GLHXHD 133
      <pe:ISOLATION>  = 1                                                       GLHXHD 134
c                                                                               GLHXHD 135
      RETURN                                                                    GLHXHD 136
c                                                                               GLHXHD 137
c                                                                               GLHXHD 138
c============= GLHX INITIALIZATION OF LOOP HISTORY============================= GLHXHD 139
 2000 <gl;Initialized>  = 1                                                     GLHXHD 140
c              round some variables to nearest integer                          GLHXHD 141
      <gl:TRENCH-NUMBER> = ANINT(<gl:TRENCH-NUMBER>)                            GLHXHD 142
      <gl:NUM-OF-YEARS>  = ANINT(<gl:NUM-OF-YEARS>)                             GLHXHD 143
      <gl:DES-HEAT-DAY>  = ANINT(<gl:DES-HEAT-DAY>)                             GLHXHD 144
      <gl:DES-COOL-DAY>  = ANINT(<gl:DES-COOL-DAY>)                             GLHXHD 145
c                                                                               GLHXHD 146
c              get the 24-hour profile                                          GLHXHD 147
      CALL GLHX_LoadProfiles                                                    GLHXHD 148
c                                                                               GLHXHD 149
c============= SET-UP THE GROUND-FIELD ======================================== GLHXHD 150
c              input error checking                                             GLHXHD 151
c              depth must be at least one foot                                  GLHXHD 152
      IF (<gl:DEPTH> .LT. 1.0)  THEN                                            GLHXHD 153
        CALL MSGSIM(-1,II,II,II,II)                                             GLHXHD 154
        WRITE (IOUTPT, 9110)  (<gl:NAME>,II=1,8)                                GLHXHD 155
        call MessageBox( NULL, 'Pipe depth less than 1 Foot -'                  GLHXHD 156
     &    //' ABORTING'//char(0),'GLHX Design Errors'//char(0), MB_OK           GLHXHD 157
     &    + MB_ICONSTOP + MB_TASKMODAL )                                        GLHXHD 158
        RETURN                                                                  GLHXHD 160
      ENDIF                                                                     GLHXHD 161
c              trench depth minus vertical separation must be at least          GLHXHD 162
c              one foot                                                         GLHXHD 163
      IF ((<gl:CONFIGURATION> .EQ. 2 .OR. <gl:CONFIGURATION> .EQ. 5)            GLHXHD 164
     &            .AND.  (<gl:DEPTH>-<gl:PIPE-VERT-SEP> .LT. 1.0))  THEN        GLHXHD 165
        CALL MSGSIM(-1,II,II,II,II)                                             GLHXHD 166
        WRITE (IOUTPT, 9111)  (<gl:NAME>,II=1,8)                                GLHXHD 167
        call MessageBox( NULL, 'Depth - Vert Separation lt 1 Foot -'            GLHXHD 168
     &    //' ABORTING'//char(0),'GLHX Design Errors'//char(0), MB_OK           GLHXHD 169
     &    + MB_ICONSTOP + MB_TASKMODAL )                                        GLHXHD 170
        RETURN                                                                  GLHXHD 172
      ENDIF                                                                     GLHXHD 173
c              trench depth minus 3x the vertical separation must be at         GLHXHD 174
c              least one foot                                                   GLHXHD 175
      IF (<gl:CONFIGURATION> .EQ. 3  .AND.                                      GLHXHD 176
     &   (<gl:DEPTH> - 3.0*<gl:PIPE-VERT-SEP> .LT. 1.0))  THEN                  GLHXHD 177
        CALL MSGSIM(-1,II,II,II,II)                                             GLHXHD 178
        WRITE (IOUTPT, 9112)  (<gl:NAME>,II=1,8)                                GLHXHD 179
        call MessageBox( NULL, 'Depth - 3*VertSeparation lt 1 Foot -'           GLHXHD 180
     &    //' ABORTING'//char(0),'GLHX Design Errors'//char(0), MB_OK           GLHXHD 181
     &    + MB_ICONSTOP + MB_TASKMODAL )                                        GLHXHD 182
        RETURN                                                                  GLHXHD 184
      ENDIF                                                                     GLHXHD 185
c              if more than one trench                                          GLHXHD 186
      IF (<gl:TRENCH-NUMBER> .GT. 1)  THEN                                      GLHXHD 187
c               trench spacing must be at least one foot                        GLHXHD 188
        IF (<gl:CONFIGURATION> .LE. 3 .AND. <gl:SPACING> .LT. 1.0)  THEN        GLHXHD 189
          CALL MSGSIM(-1,II,II,II,II)                                           GLHXHD 190
          WRITE (IOUTPT, 9113)  (<gl:NAME>,II=1,8)                              GLHXHD 191
          call MessageBox( NULL, 'Trench spacing lt 1 Foot'                     GLHXHD 192
     &      //' ABORTING'//char(0),'GLHX Design Errors'//char(0), MB_OK         GLHXHD 193
     &      + MB_ICONSTOP + MB_TASKMODAL )                                      GLHXHD 194
          RETURN                                                                GLHXHD 196
        ENDIF                                                                   GLHXHD 197
c              trench spacing must be at least one foot greater than the        GLHXHD 198
c              horizontal separation                                            GLHXHD 199
        IF (<gl:CONFIGURATION> .GE. 4  .AND.                                    GLHXHD 200
     &                 <gl:SPACING> .LT. <gl:PIPE-HORIZ-SE> + 1.0)  THEN        GLHXHD 201
          CALL MSGSIM(-1,II,II,II,II)                                           GLHXHD 202
          WRITE (IOUTPT, 9114)  (<gl:NAME>,II=1,8)                              GLHXHD 203
          call MessageBox( NULL, 'Trench spacing lt HorizSeparation+1-'         GLHXHD 204
     &      //' ABORTING'//char(0),'GLHX Design Errors'//char(0), MB_OK         GLHXHD 205
     &      + MB_ICONSTOP + MB_TASKMODAL )                                      GLHXHD 206
          RETURN                                                                GLHXHD 208
        ENDIF                                                                   GLHXHD 209
      ENDIF                                                                     GLHXHD 210
c                                                                               GLHXHD 211
c              setup piping characteristics                                     GLHXHD 212
      <gl:PIPE-OUT-DIA>  = <gl:PIPE-OUT-DIA>  / 12.0    ! Tube OD               GLHXHD 213
      <gl:PIPE-IN-DIA>   = <gl:PIPE-IN-DIA>   / 12.0    ! Tube ID               GLHXHD 214
c              radius of single pipe                                            GLHXHD 215
      S = <gl:PIPE-OUT-DIA> / 2.0                                               GLHXHD 216
c              average depth of the pipes                                       GLHXHD 217
      SELECT CASE (<gl:CONFIGURATION>)                                          GLHXHD 218
        CASE (1, 4)          ! (1x1, 1x2)                                       GLHXHD 219
          <gl;AVERAGE_DEPTH> = <gl:DEPTH>                                       GLHXHD 220
        CASE (2, 5)          ! (2x1, 2x2)                                       GLHXHD 221
          <gl;AVERAGE_DEPTH> = <gl:DEPTH> - <gl:PIPE-VERT-SEP> / 2.0            GLHXHD 222
        CASE (3)             ! (4x1)                                            GLHXHD 223
          <gl;AVERAGE_DEPTH> = <gl:DEPTH> - 3.0 * <gl:PIPE-VERT-SEP> / 2.0      GLHXHD 224
        CASE DEFAULT         ! U-Tube (and slinky)                              GLHXHD 225
          <gl;AVERAGE_DEPTH> = <gl:DEPTH>                                       GLHXHD 226
      END SELECT                                                                GLHXHD 227
c                                                                               GLHXHD 228
c              define internal variables                                        GLHXHD 229
      D = 2.0 * <gl:DEPTH>     ! distance to image pipe                         GLHXHD 230
      P = <gl:SPACING>         ! trench separation                              GLHXHD 231
      H = <gl:PIPE-VERT-SEP>   ! vertical separation                            GLHXHD 232
      W = <gl:PIPE-HORIZ-SE>   ! horizontal separation                          GLHXHD 233
c              Determine parameter for slinky coil                              GLHXHD 234
      ATL = <gl:TRENCH-LENGTH>  ! trench length                                 GLHXHD 235
      IF (<gl:CONFIGURATION> .GT. 5)  THEN  ! slinky                            GLHXHD 236
        nTurns = 12.0 * (<gl:TRENCH-LENGTH> - <gl:SLINKY-DIA>)                  GLHXHD 237
     &                / <gl:SLINKY-PITCH>                                       GLHXHD 238
        PL     = nTurns * PI * <gl:SLINKY-DIA> + 2.0*<gl:TRENCH-LENGTH>         GLHXHD 239
     &               + (PI / 2.0 - 1.0) * <gl:SLINKY-DIA>                       GLHXHD 240
c              Determine fractional coverage of face by coil,                   GLHXHD 241
c              then use a polynomial as a function of coverage                  GLHXHD 242
c              ratio to determine an equivalent length of                       GLHXHD 243
c              U-tube pipe (based on generalizing data from                     GLHXHD 244
c              MD Smith).                                                       GLHXHD 245
        f_area = PI * <gl:PIPE-OUT-DIA> * PL                                    GLHXHD 246
     &              / (2.0 * <gl:TRENCH-LENGTH> * <gl:SLINKY-DIA>)              GLHXHD 247
        EPL = PL / (0.98 + 0.24 * f_area + 1.475 * f_area **2)                  GLHXHD 248
        ATL = EPL / 2.0      ! convert to U-tube trench                         GLHXHD 249
c                                                                               GLHXHD 250
        IF (<gl:CONFIGURATION> .EQ. 7)  THEN   !  vertical slinky               GLHXHD 251
          D = D - <gl:SLINKY-DIA>  ! Note: equivalent location for              GLHXHD 252
        ENDIF                      ! U-tube is D / 2                            GLHXHD 253
      ENDIF                                                                     GLHXHD 254
c                                                                               GLHXHD 255
c              Handle U-tube diameter                                           GLHXHD 256
      IF (<gl:CONFIGURATION> .EQ. 0 .OR. <gl:CONFIGURATION> .GT. 5)             GLHXHD 257
     &  S = S * SQRT (2.0)                                                      GLHXHD 258
c                                                                               GLHXHD 259
c              Set up time pointers and determine Gi                            GLHXHD 260
      DO  i=1,16                                                                GLHXHD 261
        IF (i .LT. 16) then                                                     GLHXHD 262
          iPnt(i) = iPntSet(i)                                                  GLHXHD 263
          TheHour = FLOAT(iPnt(i))                                              GLHXHD 264
        ELSE                                                                    GLHXHD 265
          TheHour = <gl:NUM-OF-YEARS> * 8760.                                   GLHXHD 266
        END IF                                                                  GLHXHD 267
        AT = <gl:GRND-DIFFUS> * TheHour    ! numerator in Z equation            GLHXHD 268
c                                                                               GLHXHD 269
c              Account for interference effects according to the                GLHXHD 270
c              the number of pipes and configuration.  Handle                   GLHXHD 271
c              up to three trenchs "exactly", and higher multiples              GLHXHD 272
c              approximately by neglecting influence from more                  GLHXHD 273
c              than two trenchs away.                                           GLHXHD 274
        SELECT CASE (<gl:CONFIGURATION>)            ! Well configuration        GLHXHD 275
          CASE (0, 1, 6, 7)                                                     GLHXHD 276
            <gl;NUM_WELLS> = <gl:TRENCH-NUMBER>                                 GLHXHD 277
            Nc = <gl:TRENCH-NUMBER>                                             GLHXHD 278
c              single pipe contribution                                         GLHXHD 279
            Z     = AT / (S * S)                                                GLHXHD 280
            Gi(i) = GLHX_Exponential(Z)                                         GLHXHD 281
c              image pipe contribution                                          GLHXHD 282
            Z     = AT / (D * D)                                                GLHXHD 283
            Gi(i) = Gi(i) - GLHX_Exponential(Z)                                 GLHXHD 284
c              influence of adjacent trench                                     GLHXHD 285
            IF (<gl:TRENCH-NUMBER> .GT. 1) THEN                                 GLHXHD 286
              Z        = AT / (P * P)                                           GLHXHD 287
              Adjacent = GLHX_Exponential(Z)                                    GLHXHD 288
              Z        = AT / (P * P + D * D)                                   GLHXHD 289
              Adjacent = Adjacent - GLHX_Exponential(Z)                         GLHXHD 290
              Gi(i)    = (2.0 - 2.0/<gl:TRENCH-NUMBER>)*Adjacent + Gi(i)        GLHXHD 291
            ENDIF                                                               GLHXHD 292
c              influence of two trenches away                                   GLHXHD 293
            IF (<gl:TRENCH-NUMBER> .GT. 2) THEN                                 GLHXHD 294
              Z        = AT / (4.0 * P * P)                                     GLHXHD 295
              Adjacent = GLHX_Exponential(Z)                                    GLHXHD 296
              Z        = AT / (4.0 * P * P + D * D)                             GLHXHD 297
              Adjacent = Adjacent - GLHX_Exponential(Z)                         GLHXHD 298
              Gi(i)    = (2.0 - 4.0/<gl:TRENCH-NUMBER>)*Adjacent + Gi(i)        GLHXHD 299
            ENDIF                                                               GLHXHD 300
c                                                                               GLHXHD 301
          CASE (2)           ! 2 x 1 configuration                              GLHXHD 302
            <gl;NUM_WELLS> = 2. * <gl:TRENCH-NUMBER>                            GLHXHD 303
            Nc    = 1. * <gl:TRENCH-NUMBER>  ! series flow (one circuit)        GLHXHD 304
            Z     = AT / (S * S)                                                GLHXHD 305
            Gi(i) = GLHX_Exponential(Z)                                         GLHXHD 306
            DO  k=1,4                                                           GLHXHD 307
              SqrDist = (d_2(k) * D + h_2(k) * H) ** 2                          GLHXHD 308
              Z       = AT / SqrDist                                            GLHXHD 309
              Gi(i)   = Gi(i) + f_2(k) * GLHX_Exponential(Z)                    GLHXHD 310
            ENDDO                                                               GLHXHD 311
c              influence of adjacent trench                                     GLHXHD 312
            IF (<gl:TRENCH-NUMBER> .GT. 1) THEN                                 GLHXHD 313
              Z        = AT / (P * P)                                           GLHXHD 314
              Adjacent = GLHX_Exponential(Z)                                    GLHXHD 315
              DO  k=1,4                                                         GLHXHD 316
                SqrDist  = (d_2(k) * D + h_2(k) * H) ** 2                       GLHXHD 317
                SqrDist  = SqrDist + P * P                                      GLHXHD 318
                Z        = AT / SqrDist                                         GLHXHD 319
                Adjacent = Adjacent + f_2(k) * GLHX_Exponential(Z)              GLHXHD 320
              ENDDO                                                             GLHXHD 321
              Gi(i) = (2.0 - 2.0/<gl:TRENCH-NUMBER>)*Adjacent + Gi(i)           GLHXHD 322
            ENDIF                                                               GLHXHD 323
c              influence of two trenches away                                   GLHXHD 324
            IF (<gl:TRENCH-NUMBER> .GT. 2) THEN                                 GLHXHD 325
              Z        = AT / (4.0 * P * P)                                     GLHXHD 326
              Adjacent = GLHX_Exponential(Z)                                    GLHXHD 327
              DO  k=1,4                                                         GLHXHD 328
                SqrDist  = (d_2(k) * D + h_2(k) * H) ** 2                       GLHXHD 329
                SqrDist  = SqrDist + 4.0 * P * P                                GLHXHD 330
                Z        = AT / SqrDist                                         GLHXHD 331
                Adjacent = Adjacent + f_2(k) * GLHX_Exponential(Z)              GLHXHD 332
              ENDDO                                                             GLHXHD 333
              Gi(i) = (2.0 - 4.0 / <gl:TRENCH-NUMBER>)*Adjacent + Gi(i)         GLHXHD 334
            ENDIF                                                               GLHXHD 335
c                                                                               GLHXHD 336
          CASE (3)           ! 4 x 1 configuration                              GLHXHD 337
            <gl;NUM_WELLS> = 4. * <gl:TRENCH-NUMBER>                            GLHXHD 338
            Nc    = 2. * <gl:TRENCH-NUMBER>  ! series flow (2 parallel circuits)GLHXHD 339
            Z     = AT / (S * S)                                                GLHXHD 340
            Gi(i) = GLHX_Exponential(Z)                                         GLHXHD 341
            DO  k=1,10                                                          GLHXHD 342
              SqrDist = (d_3(k) * D + h_3(k) * H) ** 2                          GLHXHD 343
              Z       = AT / SqrDist                                            GLHXHD 344
              Gi(i)   = Gi(i) + f_3(k) * GLHX_Exponential(Z)                    GLHXHD 345
            ENDDO                                                               GLHXHD 346
c              influence of adjacent trench                                     GLHXHD 347
            IF (<gl:TRENCH-NUMBER> .GT. 1) THEN                                 GLHXHD 348
              Z        = AT / (P * P)                                           GLHXHD 349
              Adjacent = GLHX_Exponential(Z)                                    GLHXHD 350
              DO  k=1,10                                                        GLHXHD 351
                SqrDist  = (d_3(k) * D + h_3(k) * H) ** 2                       GLHXHD 352
                SqrDist  = SqrDist + P * P                                      GLHXHD 353
                Z        = AT / SqrDist                                         GLHXHD 354
                Adjacent = Adjacent + f_3(k) * GLHX_Exponential(Z)              GLHXHD 355
              ENDDO                                                             GLHXHD 356
              Gi(i) = (2.0 - 2.0 / <gl:TRENCH-NUMBER>)*Adjacent + Gi(i)         GLHXHD 357
            ENDIF                                                               GLHXHD 358
c              influence of two trenches away                                   GLHXHD 359
            IF (<gl:TRENCH-NUMBER> .GT. 2) THEN                                 GLHXHD 360
              Z        = AT / (4.0 * P * P)                                     GLHXHD 361
              Adjacent = GLHX_Exponential(Z)                                    GLHXHD 362
              DO  k=1,10                                                        GLHXHD 363
                SqrDist  = (d_3(k) * D + h_3(k) * H) ** 2                       GLHXHD 364
                SqrDist  = SqrDist + 4.0 * P * P                                GLHXHD 365
                Z        = AT / SqrDist                                         GLHXHD 366
                Adjacent = Adjacent + f_3(k) * GLHX_Exponential(Z)              GLHXHD 367
              END DO                                                            GLHXHD 368
              Gi(i) = (2.0 - 4.0 / <gl:TRENCH-NUMBER>)*Adjacent + Gi(i)         GLHXHD 369
            ENDIF                                                               GLHXHD 370
c                                                                               GLHXHD 371
          CASE (4)           ! 1 x 2 configuration                              GLHXHD 372
            <gl;NUM_WELLS> = 2. * <gl:TRENCH-NUMBER>                            GLHXHD 373
            Nc    = 2. * <gl:TRENCH-NUMBER>  ! (2 parallel circuits)            GLHXHD 374
            Z     = AT / (S * S)                                                GLHXHD 375
            Gi(i) = GLHX_Exponential(Z)                                         GLHXHD 376
            DO  k=1,5                                                           GLHXHD 377
              SqrDist = (d_4(k) * D) ** 2                                       GLHXHD 378
              SqrDist = SqrDist + (w_4(k) * W) ** 2                             GLHXHD 379
              Z       = AT / SqrDist                                            GLHXHD 380
              Gi(i)   = Gi(i) + f_4(k) * GLHX_Exponential(Z)                    GLHXHD 381
            ENDDO                                                               GLHXHD 382
c              influence of adjacent trench                                     GLHXHD 383
            IF (<gl:TRENCH-NUMBER> .GT. 1) THEN                                 GLHXHD 384
              Z        = AT / (P * P)                                           GLHXHD 385
              Adjacent = GLHX_Exponential(Z)                                    GLHXHD 386
              DO  k=1,5                                                         GLHXHD 387
                SqrDist  = (d_4(k) * D) ** 2                                    GLHXHD 388
                SqrDist  = SqrDist  + (P + w_4(k) * W) ** 2                     GLHXHD 389
                Z        = AT / SqrDist                                         GLHXHD 390
                Adjacent = Adjacent + f_4(k) * GLHX_Exponential(Z)              GLHXHD 391
              ENDDO                                                             GLHXHD 392
              Gi(i) = (2.0 - 2.0 / <gl:TRENCH-NUMBER>)*Adjacent + Gi(i)         GLHXHD 393
            ENDIF                                                               GLHXHD 394
c              influence of two trenches away                                   GLHXHD 395
            IF (<gl:TRENCH-NUMBER> .GT. 2) THEN                                 GLHXHD 396
              Z        = AT / (4.0 * P * P)                                     GLHXHD 397
              Adjacent = GLHX_Exponential(Z)                                    GLHXHD 398
              DO  k=1,5                                                         GLHXHD 399
                SqrDist = (d_4(k) * D) ** 2                                     GLHXHD 400
                SqrDist  = SqrDist + (2.0 * P + w_4(k) * W) ** 2                GLHXHD 401
                Z        = AT / SqrDist                                         GLHXHD 402
                Adjacent = Adjacent + f_4(k) * GLHX_Exponential(Z)              GLHXHD 403
              ENDDO                                                             GLHXHD 404
              Gi(i) = (2.0 - 4.0 / <gl:TRENCH-NUMBER>)*Adjacent + Gi(i)         GLHXHD 405
            ENDIF                                                               GLHXHD 406
c                                                                               GLHXHD 407
          CASE (5)           ! 2 x 2 configuration                              GLHXHD 408
            <gl;NUM_WELLS> = 4. * <gl:TRENCH-NUMBER>                            GLHXHD 409
            Nc    = 2. * <gl:TRENCH-NUMBER>  ! series flow (2 parallel circuits)GLHXHD 410
            Z     = AT / (S * S)                                                GLHXHD 411
            Gi(i) = GLHX_Exponential(Z)                                         GLHXHD 412
            DO  k=1,14                                                          GLHXHD 413
              SqrDist = (d_5(k) * D + h_5(k) * H) ** 2                          GLHXHD 414
              SqrDist = SqrDist + (w_5(k) * W) ** 2                             GLHXHD 415
              Z       = AT / SqrDist                                            GLHXHD 416
              Gi(i)   = Gi(i) + f_5(k) * GLHX_Exponential(Z)                    GLHXHD 417
            ENDDO                                                               GLHXHD 418
c              influence of adjacent trench                                     GLHXHD 419
            IF (<gl:TRENCH-NUMBER> .GT. 1) THEN                                 GLHXHD 420
              Z        = AT / (P * P)                                           GLHXHD 421
              Adjacent = GLHX_Exponential(Z)                                    GLHXHD 422
              DO  k=1,14                                                        GLHXHD 423
                SqrDist  = (d_5(k) * D + h_5(k) * H) ** 2                       GLHXHD 424
                SqrDist  = SqrDist + (P + w_5(k) * W) ** 2                      GLHXHD 425
                Z        = AT / SqrDist                                         GLHXHD 426
                Adjacent = Adjacent + f_5(k) * GLHX_Exponential(Z)              GLHXHD 427
              ENDDO                                                             GLHXHD 428
              Gi(i) = (2.0 - 2.0 / <gl:TRENCH-NUMBER>)*Adjacent + Gi(i)         GLHXHD 429
            ENDIF                                                               GLHXHD 430
c              influence of two trenches away                                   GLHXHD 431
            IF (<gl:TRENCH-NUMBER> .GT. 2) THEN                                 GLHXHD 432
              Z        = AT / (4.0 * P * P)                                     GLHXHD 433
              Adjacent = GLHX_Exponential(Z)                                    GLHXHD 434
              DO  k=1,14                                                        GLHXHD 435
                SqrDist  = (d_5(k) * D + h_5(k) * H) ** 2                       GLHXHD 436
                SqrDist  = SqrDist + (2.0 * P + w_5(k) * W) ** 2                GLHXHD 437
                Z        = AT / SqrDist                                         GLHXHD 438
                Adjacent = Adjacent + f_5(k) * GLHX_Exponential(Z)              GLHXHD 439
                ENDDO                                                           GLHXHD 440
              Gi(i) = (2.0 - 4.0 / <gl:TRENCH-NUMBER>)*Adjacent + Gi(i)         GLHXHD 441
            ENDIF                                                               GLHXHD 442
        END SELECT  ! Well configuration                                        GLHXHD 443
c                                                                               GLHXHD 444
        IW = i                                                                  GLHXHD 445
        IF (i .NE. 1 .AND. i .NE. 16) THEN                                      GLHXHD 446
          <gl;TIME_WEIGHT> = (Gi(i) - Gi(i-1)) / (ATL * <gl:GRND-COND>)         GLHXHD 447
        ELSE                                                                    GLHXHD 448
          <gl;TIME_WEIGHT> = Gi(i) / (ATL * <gl:GRND-COND>)                     GLHXHD 449
        END IF                                                                  GLHXHD 450
      ENDDO                                                                     GLHXHD 451
c                                                                               GLHXHD 452
c              Average heat inputs to soil for preceeding 8760 hours            GLHXHD 453
      qYear = 0.0                                                               GLHXHD 454
      IF (<gl:NUM-OF-YEARS> .GT. 0) THEN                                        GLHXHD 455
c              Account for seasonal imbalances                                  GLHXHD 456
        IF (<gl:DES-COOL-DAY> .GT. <gl:DES-HEAT-DAY>) THEN                      GLHXHD 457
          Phse1 = <gl:DES-HEAT-DAY> - <gl:DES-COOL-DAY> + 365                   GLHXHD 458
          Phse2 = <gl:DES-COOL-DAY> - <gl:DES-HEAT-DAY>                         GLHXHD 459
        ELSE                                                                    GLHXHD 460
          Phse1 = <gl:DES-COOL-DAY> - <gl:DES-HEAT-DAY> + 365                   GLHXHD 461
          Phse2 = <gl:DES-HEAT-DAY> - <gl:DES-COOL-DAY>                         GLHXHD 462
        END IF                                                                  GLHXHD 463
        DO  i=1,365                                                             GLHXHD 464
          IF (<gl:DES-COOL-DAY> .GT. <gl:DES-HEAT-DAY>) THEN                    GLHXHD 465
            ARG = i - <gl:DES-COOL-DAY>                                         GLHXHD 466
            IF (i .LT. <gl:DES-HEAT-DAY>) THEN                                  GLHXHD 467
              ARG = (ARG + 365.0) * PI / Phse1                                  GLHXHD 468
            ELSEIF (i .GT. <gl:DES-COOL-DAY>) THEN                              GLHXHD 469
              ARG = ARG * PI / Phse1                                            GLHXHD 470
            ELSE                                                                GLHXHD 471
              ARG = ARG * PI / Phse2                                            GLHXHD 472
            ENDIF                                                               GLHXHD 473
          ELSE                                                                  GLHXHD 474
            ARG = i - <gl:DES-HEAT-DAY>                                         GLHXHD 475
            IF (i .LT. <gl:DES-COOL-DAY>) THEN                                  GLHXHD 476
              ARG = (ARG + 365.0) * PI / Phse1                                  GLHXHD 477
            ELSEIF (i .GT. <gl:DES-HEAT-DAY>) THEN                              GLHXHD 478
              ARG = ARG * PI / Phse1                                            GLHXHD 479
            ELSE                                                                GLHXHD 480
              ARG = ARG * PI / Phse2                                            GLHXHD 481
            ENDIF                                                               GLHXHD 482
            ARG = ARG + PI                                                      GLHXHD 483
          ENDIF                                                                 GLHXHD 484
          fScale = COS(ARG)                                                     GLHXHD 485
          DO  KK=1,24                                                           GLHXHD 486
            IH = 24 * (i-1) + KK                                                GLHXHD 487
            IF (fScale .GT. 0) THEN                                             GLHXHD 488
              <gl;Q_8760> =  fScale * <gl:DES-COOL-LOAD>/<gl;NUM_WELLS>         GLHXHD 489
            ELSE                                                                GLHXHD 490
              <gl;Q_8760> = -fScale * <gl:DES-HEAT-LOAD>/<gl;NUM_WELLS>         GLHXHD 491
            END IF                                                              GLHXHD 492
            qYear = qYear + <gl;Q_8760>                                         GLHXHD 493
          ENDDO                                                                 GLHXHD 494
        ENDDO                                                                   GLHXHD 495
      ELSE                                                                      GLHXHD 496
c              Assume the coil has just been installed                          GLHXHD 497
        DO  IH=1,8760                                                           GLHXHD 498
          <gl;Q_8760> = 0.                                                      GLHXHD 499
        ENDDO                                                                   GLHXHD 500
      ENDIF                                                                     GLHXHD 501
c              Save yearly heat                                                 GLHXHD 502
      <gl;Qyear> = qYear                                                        GLHXHD 503
c                                                                               GLHXHD 504
c              Equivalent pipe and film resistances (Kavanaugh)                 GLHXHD 505
      Rp = ALOG (<gl:PIPE-OUT-DIA> / <gl:PIPE-IN-DIA>)                          GLHXHD 506
     &                             / (2.0 * PI * <gl:PIPE-COND>)                GLHXHD 507
      hf = 1.14 * ((<pe;DES_GPM> / Nc) ** 0.8)                                  GLHXHD 508
     &          / (<gl:PIPE-IN-DIA> ** 1.8)                                     GLHXHD 509
      Rp = Rp + 1.0 / (PI * <gl:PIPE-IN-DIA> * hf)                              GLHXHD 510
c                                                                               GLHXHD 511
c              Determine gl;QaveragePast(iw)                                    GLHXHD 512
c              (Averaged Heat Inputs for period i)                              GLHXHD 513
      IW = 1                                                                    GLHXHD 514
      IH = 8760                                                                 GLHXHD 515
      <gl;QaveragePast> = <gl;Q_8760>                                           GLHXHD 516
      DO  IW=2,15                                                               GLHXHD 517
        IH1 = 8760 - iPnt(IW-1)                                                 GLHXHD 518
        IH2 = 8760 - (iPnt(IW) - 1)                                             GLHXHD 519
        <gl;QaveragePast> = 0                                                   GLHXHD 520
        DO  IH=IH2,IH1                                                          -041k    3
          <gl;QaveragePast> = <gl;QaveragePast>                                 GLHXHD 522
     &                      + <gl;Q_8760> / FLOAT(IH1-IH2 + 1)                  GLHXHD 523
        ENDDO                                                                   GLHXHD 524
      ENDDO                                                                     GLHXHD 525
c                                                                               GLHXHD 526
c              Set up fMult values used to update gl;Qaverage(iw) values        GLHXHD 527
      DO  IW=2,15                                                               GLHXHD 528
        <gl;fMult> = 1.0 / FLOAT(iPnt(IW) - iPnt(IW-1))                         GLHXHD 529
      ENDDO                                                                     GLHXHD 530
c                                                                               GLHXHD 531
c              Heat transport capacity in piping                                GLHXHD 532
      MCp = <lp;BTUH/GPM-F> * <pe;DES_GPM>                                      GLHXHD 533
c              Define FACTOR term used to calculate leaving fluid temp          GLHXHD 534
      ARG         = (<gl;NUM_WELLS> * ATL / Rp) / MCp                           GLHXHD 535
      <gl;FACTOR> = EXP(-ARG) / (1.0 - EXP(-ARG)) / MCp                         GLHXHD 536
c                                                                               GLHXHD 537
c                                                                               GLHXHD 538
      RETURN                                                                    GLHXHD 539
c                                                                               GLHXHD 540
c              message formats                                                  GLHXHD 541
 9001 FORMAT(14X,8A4,' has a maximum flow smaller'                     /        -035    78
     &       14X,'than the loops minimum flow, and will never be used' /        -035    79
     &       14X,'by itself.'                                          )        -035    80
 9100 FORMAT(14X,'Ground-loop HX: ',8A4,                               /        GLHXHD 542
     &       14X,'on loop ',8A4,'is not needed.  No simulation will'   /        GLHXHD 543
     &       14X,'be performed.    '                                   )        GLHXHD 544
 9107 FORMAT(14X,'Plant equipment: ',8A4,' has a different'            /        GLHXHD 545
     &       14X,'pressure drop on loop: ',8A4,' than the'             /        GLHXHD 546
     &       14X,'other equipment.  This is unusual unless the loop'   /        GLHXHD 547
     &       14X,'uses flow meters or other dynamic flow control'      /        GLHXHD 548
     &       14X,'devices to allocate the flow on an hourly basis to'  /        GLHXHD 549
     &       14X,'the active equipment.'                               )        GLHXHD 550
 9110 FORMAT(14X,'Ground-loop HX: ',8a4,' has a pipe'                  /        GLHXHD 551
     &       14X,'depth less than one foot.'                           )        GLHXHD 552
 9111 FORMAT(14X,'Ground-loop HX: ',8a4,' must have a'                 /        GLHXHD 553
     &       14X,'depth - vertical separation greater than 1 foot.'    )        GLHXHD 554
 9112 FORMAT(14X,'Ground-loop HX: ',8a4,' must have a'                 /        GLHXHD 555
     &       14X,'depth - 3*vertical separation greater than 1 foot.'  )        GLHXHD 556
 9113 FORMAT(14X,'Ground-loop HX: ',8a4,' must have a'                 /        GLHXHD 557
     &       14X,'trench spacing greater than 1 foot.'                 )        GLHXHD 558
 9114 FORMAT(14X,'Ground-loop HX: ',8a4,' must have a'                 /        GLHXHD 559
     &       14X,'trench spacing greater than horizontal separation+1' )        GLHXHD 560
c                                                                               GLHXHD 561
      END                                                                       GLHXHD 562
      SUBROUTINE GLHX_LoadProfiles                                              GLHXL    2
c                                                                               GLHXL    3
c              Sets up the 24-hour design load profiles for the                 GLHXL    4
c              Ground-loop heat-exchangers                                      GLHXL    5
c                                                                               GLHXL    6
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /DESHRQ/ NDESDY, IDDTYP(2), DESHRQ(360)                           Time     1
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               GLHXL   11
      REAL SUMS(3)                                                              GLHXL   12
c                                                                               GLHXL   13
c              See if the user specified the heating design profile             GLHXL   14
      KK = 1                                                                    GLHXL   15
      IF (VECVAL(<gl:DES-HEAT-LOAD>,24) .eq. 0.)  THEN                          GLHXL   16
c              Heating design profile not specified - see if design             GLHXL   17
c              days specified                                                   GLHXL   18
        IF (NDESDY .GT. 0 ) THEN                                                Time    32
c            sum all DD profiles and collect min                                GLHXL   20
          SUMM = 0.                                                             GLHXL   21
          DO JJ=1,NDESDY                                                        Time    33
            II = (JJ-1)*24 + 1                                                  GLHXL   23
            SUMS(JJ) = VECSUM(<lp;DesDayProfile>,24)                            GLHXL   24
            SUMM     = MIN(SUMM,SUMS(JJ))                                       GLHXL   25
          ENDDO                                                                 GLHXL   26
c           see which one was min and put it into place                         GLHXL   27
          DO JJ=1,NDESDY                                                        Time    34
            IF(SUMS(JJ) .EQ. SUMM) THEN                                         GLHXL   29
              KK = 1                                                            GLHXL   30
              II = (JJ-1)*24 + 1                                                GLHXL   31
              CALL MOVEN(<lp;DesDayProfile>,<gl:DES-HEAT-LOAD>,24)              GLHXL   32
              <gl:DES-HEAT-DAY> = <lp;DesDayNumbers>                            GLHXL   33
            ENDIF                                                               GLHXL   34
          ENDDO                                                                 GLHXL   35
        ELSE                                                                    GLHXL   36
c            no design days, use DESIGN value in step function                  GLHXL   37
          DO KK=7,18                                                            GLHXL   38
            <gl:DES-HEAT-LOAD> = <lp;DES_DEM_HEAT>                              GLHXL   39
            <gl:DES-HEAT-DAY>  = 355                                            GLHXL   40
          ENDDO                                                                 GLHXL   41
        ENDIF                                                                   GLHXL   42
      ENDIF                                                                     GLHXL   43
c                                                                               GLHXL   44
c              Repeat for cooling profile                                       GLHXL   45
      KK = 1                                                                    GLHXL   46
      IF (VECVAL(<gl:DES-COOL-LOAD>,24) .eq. 0.)  THEN                          GLHXL   47
c              Cooling design profile not specified - see if design             GLHXL   48
c              days specified                                                   GLHXL   49
        IF (NDESDY .GT. 0 ) THEN                                                Time    35
c            sum all DD profiles and collect max                                GLHXL   51
          SUMM = 0.                                                             GLHXL   52
          DO JJ=1,NDESDY                                                        Time    36
            II = (JJ-1)*24 + 1                                                  GLHXL   54
            SUMS(JJ) = VECSUM(<lp;DesDayProfile>,24)                            GLHXL   55
            SUMM     = MAX(SUMM,SUMS(JJ))                                       GLHXL   56
          ENDDO                                                                 GLHXL   57
c           see which one was max and put it into place                         GLHXL   58
          DO JJ=1,NDESDY                                                        Time    37
            IF(SUMS(JJ) .EQ. SUMM) THEN                                         GLHXL   60
              KK = 1                                                            GLHXL   61
              II = (JJ-1)*24 + 1                                                GLHXL   62
              CALL MOVEN(<lp;DesDayProfile>,<gl:DES-COOL-LOAD>,24)              GLHXL   63
              <gl:DES-COOL-DAY> = <lp;DesDayNumbers>                            GLHXL   64
            ENDIF                                                               GLHXL   65
          ENDDO                                                                 GLHXL   66
        ELSE                                                                    GLHXL   67
c            no design days, use DESIGN value in step function                  GLHXL   68
          DO KK=7,18                                                            GLHXL   69
            <gl:DES-COOL-LOAD> = <lp;DES_DEM_COOL>                              GLHXL   70
            <gl:DES-COOL-DAY>  = 172                                            GLHXL   71
          ENDDO                                                                 GLHXL   72
        ENDIF                                                                   GLHXL   73
      ENDIF                                                                     GLHXL   74
c                                                                               GLHXL   75
      RETURN                                                                    GLHXL   76
      END                                                                       GLHXL   77
      SUBROUTINE GLHX_Scheduled(Mode)                                           GLHXS    2
c                                                                               GLHXS    3
c              Simulates a ground-loop heat-exchanger with a                    GLHXS    4
c              scheduled output temperature                                     GLHXS    5
c                                                                               GLHXS    6
c              Mode = 1  Heating mode                                           GLHXS    7
c                     2  Cooling mode                                           GLHXS    8
c                                                                               GLHXS    9
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /GLHXD / QLoad,GPM,OperCap,OutletT,FarGroundT,                    /GLHXD/  2
     &                 GroundDeltaT,QdeltaT,LoopDeltaT,Qrate,Runtime,           /GLHXD/  3
     &                 spare(10)                                                /GLHXD/  4
      REAL             LoopDeltaT                                               /GLHXD/  5
      DIMENSION        GLHXDAT(20)                                              /GLHXD/  6
      EQUIVALENCE     (GLHXDAT(1), QLoad)                                       /GLHXD/  7
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               GLHXS   20
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
c                                                                               GLHXS   24
c              zero hourly data                                                 GLHXS   25
      CALL FILLN(0., GLHXDAT(1), IVTLIM(2,27))                                  GLHXS   26
c                                                                               GLHXS   27
c============= ROUTINE CALLED TO GET OPERATING CAPACITY ======================= GLHXS   28
c              Unlike other equipment, capacity is in gpm, not energy           GLHXS   29
      IF (SimCtrl .EQ. 11)  THEN                                                GLHXS   30
        IF (Mode .EQ. COOLMODE)  THEN                                           GLHXS   31
c              heat-rejection capacity is in gpm                                GLHXS   32
c              scheduled device has full capacity all hours                     GLHXS   33
          <pe;OPER_CAPACITY> = <gl:HX-MAX-GPM>                                  GLHXS   34
          <pe;MAX_CAPACITY>  = <gl:HX-MAX-GPM>                                  GLHXS   35
        ELSE                                                                    GLHXS   36
c              all other modes capacity is in Btuh - make max capactiy big      GLHXS   37
          <pe;OPER_CAPACITY> = <gl:CAPACITY>                                    GLHXS   38
          <pe;MAX_CAPACITY>  = <gl:CAPACITY> * 10.                              GLHXS   39
        ENDIF                                                                   GLHXS   40
c                                                                               GLHXS   41
c ****         run function : GLHX_Scheduled-1                                  GLHXS   42
c       IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                      GLHXS   43
c                                                                               GLHXS   44
c                                                                               GLHXS   45
        RETURN                                                                  GLHXS   46
      ENDIF                                                                     GLHXS   47
c                                                                               GLHXS   48
c                                                                               GLHXS   49
c============= ROUTINE CALLED TO SIMULATE EQUIPMENT =========================== GLHXS   50
c              total equipment pump kW                                          GLHXS   51
      AuxPumpKW  = 0.                                                           GLHXS   52
c              condenser loop flow thru this glhx                               GLHXS   53
      GPM = <pe;GPM>                                                            GLHXS   54
c                                                                               GLHXS   55
c ****         run function : GLHX_Scheduled-2                                  GLHXS   56
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        GLHXS   57
c                                                                               GLHXS   58
c              skip if no load                                                  GLHXS   59
      IF (GPM .EQ. 0.)  THEN                                                    GLHXS   60
        GOTO 1000                                                               GLHXS   61
      ELSE                                                                      GLHXS   62
        IF (Mode .EQ. 1)  THEN                                                  GLHXS   63
c              hourly load and operating capacity                               GLHXS   64
          QLoad = -<pe;LOAD>                                                    GLHXS   65
          <pe;LOAD> = QLoad                                                     GLHXS   66
        ELSE                                                                    GLHXS   67
          glLOAD = <pe;LOAD>                                                    GLHXS   68
        ENDIF                                                                   GLHXS   69
      ENDIF                                                                     GLHXS   70
c              operating capacity                                               GLHXS   71
      OperCap = <pe;OPER_CAPACITY>                                              GLHXS   72
c              leaving temperature                                              GLHXS   73
      OutletT = SchVal(<gl:LOOP-TEMP-SCH>, GTEMP(IMO)-460.)                     ERV     39
c                                                                               GLHXS   79
c              flow thru the glhx                                               GLHXS   80
      IF (<gl:HX-PUMP> .GT. 0)  THEN                                            GLHXS   81
        Jpm = <gl:HX-PUMP>                                                      GLHXS   82
        IF (<pm;TYPE> .EQ. EquipmentPump)  THEN                                 GLHXS   83
c              pump recirculates thru the tower only                            GLHXS   84
          IF (<pm;EQUIP_CTRL> .EQ. ConstantFlow)  THEN                          GLHXS   85
c              constant flow                                                    GLHXS   86
            GPM = <pm;EQUIP_GPM>                                                GLHXS   87
          ELSE                                                                  GLHXS   88
c              not constant flow, flow is loop flow                             GLHXS   89
            GPM = MAX(<pe;GPM>, <gl:HX-MIN-GPM>)                                GLHXS   90
          ENDIF                                                                 GLHXS   91
        ELSE                                                                    GLHXS   92
c              pump powers the loop, flow is loop flow                          GLHXS   93
          GPM = <pe;GPM>                                                        GLHXS   94
        ENDIF                                                                   GLHXS   95
      ELSE                                                                      GLHXS   96
c              no recirculation pump, flow is loop flow                         GLHXS   97
        GPM = <pe;GPM>                                                          GLHXS   98
      ENDIF                                                                     GLHXS   99
c                                                                               GLHXS  100
c              temperature change in loop                                       GLHXS  101
      LoopDeltaT = QLoad / (<lp;BTUH/GPM-F> * GPM)                              GLHXS  102
c                                                                               GLHXS  103
c ****         run function : GLHX_Scheduled-2                                  GLHXS  104
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        GLHXS  105
c                                                                               GLHXS  106
 1000 CONTINUE                                                                  GLHXS  107
c                                                                               GLHXS  108
c              report variables                                                 GLHXS  109
      <pe;SUPPLY_T> = OutletT                                                   GLHXS  110
c                                                                               GLHXS  111
c              hourly-report variables                                          GLHXS  112
      IF (<gl;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                                GLHXS  113
     &  CALL HourRepPLT(GLHXDAT(1), <gl;HREP>, 27, 0)                           GLHXS  114
c                                                                               GLHXS  115
c                                                                               GLHXS  116
      RETURN                                                                    GLHXS  117
      END                                                                       GLHXS  118
      SUBROUTINE GLHX_Scheduled_Design                                          GLHXSD   2
c                                                                               GLHXSD   3
c              Sets up a ground-loop heat-exchanger with a                      GLHXSD   4
c              scheduled output temperature                                     GLHXSD   5
c                                                                               GLHXSD   6
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /GLHXD / QLoad,GPM,OperCap,OutletT,FarGroundT,                    /GLHXD/  2
     &                 GroundDeltaT,QdeltaT,LoopDeltaT,Qrate,Runtime,           /GLHXD/  3
     &                 spare(10)                                                /GLHXD/  4
      REAL             LoopDeltaT                                               /GLHXD/  5
      DIMENSION        GLHXDAT(20)                                              /GLHXD/  6
      EQUIVALENCE     (GLHXDAT(1), QLoad)                                       /GLHXD/  7
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               GLHXSD  13
c                                                                               GLHXSD  14
c              pointer to cw loop                                               GLHXSD  15
      Jlp = <gl:LOOP>                                                           GLHXSD  16
c                                                                               GLHXSD  17
c              design capacity                                                  -034    40
      Qloop = MAX(<lp;DES_CCAP>, ABS(<lp;DES_HCAP>))                            -034    41
      IF (<gl:CAPACITY> .EQ. 0.)  THEN                                          -034    42
        QLoad = Qloop                                                           -034    43
        IF (<gl:CAP-RATIO> .EQ. UNFILD)  THEN                                   GLHXSD  21
c              no capacity ratio specified - size equipment equally             GLHXSD  22
          QLoad = QLoad / FLOAT(<lp;CL_NUM_EQUIP>)                              GLHXSD  23
        ELSE                                                                    GLHXSD  24
          QLoad = QLoad * <gl:CAP-RATIO>                                        GLHXSD  25
        ENDIF                                                                   GLHXSD  26
      ELSE                                                                      GLHXSD  27
        QLoad = <gl:CAPACITY>                                                   GLHXSD  28
      ENDIF                                                                     GLHXSD  29
c              no glhx if no flow                                               GLHXSD  30
      IF (QLoad .LT. 1.)  THEN                                                  GLHXSD  31
        <gl:CAPACITY> = 0.                                                      GLHXSD  32
        CALL MSGSIM(-3, II,II,II,II)                                            GLHXSD  33
        WRITE(IOUTPT,9100) (<gl:NAME>,II=1,8),                                  GLHXSD  34
     &                     (<lp:NAME>,II=1,8)                                   GLHXSD  35
        RETURN                                                                  GLHXSD  36
      ENDIF                                                                     GLHXSD  37
      <gl:CAPACITY> = QLoad                                                     GLHXSD  38
c                                                                               GLHXSD  39
c              pick up component dT from loop if not specd.                     GLHXSD  40
      IF (<gl:HX-DT> .EQ. 0.)  <gl:HX-DT> = <lp:DESIGN-DT>                      GLHXSD  41
c              design flow - greater of load or flow requirement                -034    44
      GPMload = QLoad / (<lp;BTUH/GPM-F> * <gl:HX-DT>)                          -034    45
      GPMflow = <lp;DES_GPM> * Qload/Qloop                                      -034    46
      GPM     = MAX(GPMload, GPMflow)                                           -034    47
c              convert minimum and maximum flow from fraction to gpm            GLHXSD  44
      <gl:HX-MIN-GPM> = GPM * <gl:HX-MIN-GPM>                                   GLHXSD  45
      <gl:HX-MAX-GPM> = GPM * <gl:HX-MAX-GPM>                                   GLHXSD  46
      IF (<gl:HX-MAX-GPM> .LT. <lp:RECIRC-GPM>  .OR.                            -035    81
     &    <gl:HX-MAX-GPM> .LT. <lp:MIN-GPM>)    THEN                            -035    82
        CALL MSGSIM(-3,II,II,II,II)                                             -035    83
        WRITE (IOUTPT, 9001)  (<gl:NAME>,II=1,8)                                -035    84
      ENDIF                                                                     -035    85
c                                                                               GLHXSD  47
c              warn if loop pressure drop different than others                 GLHXSD  48
      IF (<gl:HX-PUMP> .EQ. 0)  THEN                                            GLHXSD  49
        IF (ABS(<gl:HX-HEAD>+<gl:HX-STATIC>                                     GLHXSD  50
     &       - (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>))                         GLHXSD  51
     &      / (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>) .GT. 0.05)  THEN          GLHXSD  52
          CALL MSGSIM(-3,II,II,II,II)                                           GLHXSD  53
          WRITE (IOUTPT,9107) (<gl:NAME>,II=1,8),                               GLHXSD  54
     &                        (<lp:NAME>,II=1,8)                                GLHXSD  55
        ENDIF                                                                   GLHXSD  56
      ENDIF                                                                     GLHXSD  57
c              design the attached pump                                         GLHXSD  58
      IF (<gl:HX-PUMP> .GT. 0)  THEN                                            GLHXSD  59
        Jpm = <gl:HX-PUMP>                                                      GLHXSD  60
c                                                                               GLHXSD  61
        CALL PUMPdes(GPM)                                                       GLHXSD  62
        <pm;MIN_GPM> = <gl:HX-MIN-GPM>                                          GLHXSD  63
      ENDIF                                                                     GLHXSD  64
c              total primary loop equipment capacity                            GLHXSD  65
      <lp;PRIMARY_CCAP> = <lp;PRIMARY_CCAP> + QLoad                             GLHXSD  66
      <lp;PRIMARY_HCAP> = <lp;PRIMARY_HCAP> - QLoad                             GLHXSD  67
                                                                                GLHXSD  68
c              save design variables for use in PrimaryEquip                    GLHXSD  69
c              heat-rejection mode                                              GLHXSD  70
      Jpe = <gl;Jpe>                                                            GLHXSD  71
      <pe;Jpm>        = <gl:HX-PUMP>                                            GLHXSD  72
      <pe;DES_GPM>    = GPM                                                     GLHXSD  73
      <pe;MAX_GPM>    = <gl:HX-MAX-GPM>                                         GLHXSD  74
      <pe;DES_HEAD>   = <gl:HX-HEAD>                                            GLHXSD  75
      <pe;DES_STATIC> = <gl:HX-STATIC>                                          GLHXSD  76
      <pe:ISOLATION>  = 1                                                       GLHXSD  77
c              heat-absorption mode                                             GLHXSD  78
      Jpe = <gl;Jpe_HEAT>                                                       GLHXSD  79
      <pe;Jpm>        = <gl:HX-PUMP>                                            GLHXSD  80
      <pe;DES_GPM>    = GPM                                                     GLHXSD  81
      <pe;MAX_GPM>    = <gl:HX-MAX-GPM>                                         GLHXSD  82
      <pe;DES_HEAD>   = <gl:HX-HEAD>                                            GLHXSD  83
      <pe;DES_STATIC> = <gl:HX-STATIC>                                          GLHXSD  84
      <pe:ISOLATION>  = 1                                                       GLHXSD  85
c                                                                               GLHXSD  86
c                                                                               GLHXSD  87
      RETURN                                                                    GLHXSD  88
c                                                                               GLHXSD  89
c              message formats                                                  GLHXSD  90
 9001 FORMAT(14X,8A4,' has a maximum flow smaller'                     /        -035    86
     &       14X,'than the loops minimum flow, and will never be used' /        -035    87
     &       14X,'by itself.'                                          )        -035    88
 9100 FORMAT(14X,'Ground-loop HX: ',8A4,                               /        GLHXSD  91
     &       14X,'on loop ',8A4,'is not needed.  No simulation will'   /        GLHXSD  92
     &       14X,'be performed.    '                                   )        GLHXSD  93
 9107 FORMAT(14X,'Plant equipment: ',8A4,' has a different'            /        GLHXSD  94
     &       14X,'pressure drop on loop: ',8A4,' than the'             /        GLHXSD  95
     &       14X,'other equipment.  This is unusual unless the loop'   /        GLHXSD  96
     &       14X,'uses flow meters or other dynamic flow control'      /        GLHXSD  97
     &       14X,'devices to allocate the flow on an hourly basis to'  /        GLHXSD  98
     &       14X,'the active equipment.'                               )        GLHXSD  99
c                                                                               GLHXSD 100
      END                                                                       GLHXSD 101
      SUBROUTINE GLHX_Vertical(Mode,Icall)                                      GLHXV    2
c                                                                               GLHXV    3
c              Simulates a ground-loop heat-exchanger with a                    GLHXV    4
c              one or more vertical wells                                       GLHXV    5
c                                                                               GLHXV    6
c              Mode =  1  Heating mode                                          GLHXV    7
c                      2  Cooling mode                                          GLHXV    8
c                                                                               GLHXV    9
c              Icall = 1  Operating capacity                                    GLHXV   10
c                      2  Output temperature                                    GLHXV   11
c                      3  Update history                                        GLHXV   12
c                                                                               GLHXV   13
C              Enhancements of water-source/ground-source heat pump             -044d   16
C              capability of eQUEST & DOE-2.2 were supported in part            -044d   17
C              by Climatemaster Inc. New vertical well ground heat              -044d   18
C              exchanger model was implemented by Xiaobing Liu of               -044d   19
C              Climatemaster. That model is based upon work by                  -044d   20
C              Claesson, Eskilson, Hellstrom, .et.alr, University of            -044d   21
C              Lund, Sweden and Spitler, .et.al, Oklahoma State Univ.           -044d   22
c                                                                               /JJHLIT/ 2
c              Original DOE-2 Ground HX models developed by                     -044d    1
c                            R. Merriam, Arthur D Little (617-498-5887)         /JJHLIT/ 4
c                            August 29, 1995                                    /JJHLIT/ 5
c                                                                               /JJHLIT/ 6
c              and IMPLEMENTATION BY                                            -044d    2
c                            S. D. Gates                                        /JJHLIT/ 8
c                            J. J. Hirsch                                       /JJHLIT/ 9
c                            James J. Hirsch & Associates                       /JJHLIT/10
c                            Camarillo, California                              /JJHLIT/11
c                                                                               /JJHLIT/12
Copyright (c) 1997 by James J. Hirsch. All Rights Reserved. Unpublished         /JJHLIT/13
c rights reserved under the Copyright Laws of the United States.                /JJHLIT/14
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHLIT/15
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHLIT/16
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHLIT/17
c                                                                               /JJHLIT/18
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /DESHRQ/ NDESDY, IDDTYP(2), DESHRQ(360)                           Time     1
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /GLHX  / iPnt(15)                                                 /GLHX/   2
      COMMON  /GLHXD / QLoad,GPM,OperCap,OutletT,FarGroundT,                    /GLHXD/  2
     &                 GroundDeltaT,QdeltaT,LoopDeltaT,Qrate,Runtime,           /GLHXD/  3
     &                 spare(10)                                                /GLHXD/  4
      REAL             LoopDeltaT                                               /GLHXD/  5
      DIMENSION        GLHXDAT(20)                                              /GLHXD/  6
      EQUIVALENCE     (GLHXDAT(1), QLoad)                                       /GLHXD/  7
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
c                                                                               GLHXV   24
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
c                                                                               GLHXV   28
c                                                                               GLHXV   29
c ****         run function : GLHX_Vertical-1                                   GLHXV   30
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        GLHXV   31
c                                                                               GLHXV   32
      GOTO (1000,2000,3000), Icall                                              GLHXV   33
c                                                                               GLHXV   34
c============= ROUTINE CALLED TO GET OPERATING CAPACITY ======================= GLHXV   35
c                                                                               GLHX1  172
 1000 IF (Mode .EQ. HeatMode)  THEN                                             GLHX1  173
c              heating mode capacity is in Btuh                                 GLHX1  174
        <pe;OPER_CAPACITY> = <gl:CAPACITY>                                      GLHX1  175
c              make maximum capacity big so all load will be assigned           GLHX1  176
        <pe;MAX_CAPACITY>  = <gl:CAPACITY> * 10.                                GLHX1  177
        RETURN                                                                  GLHX1  178
      ELSE                                                                      GLHX1  179
c              Heat-rejection capacity is in gpm                                GLHX1  180
        IF (<gl;Initialized> .EQ. 0)  THEN                                      GLHX1  181
c              still in design day calcs                                        GLHX1  182
          GPMcap = <gl:HX-MAX-GPM>                                              GLHX1  183
        ELSE                                                                    GLHX1  184
c              Normal operation - get near ground temperature, excluding        GLHX1  185
c              effect of current hour's load                                    GLHX1  186
          GroundDeltaT = GLHX_GroundDTpast(Jgl)                                 GLHX1  187
c              effect of run time - assume very small runtime has               GLHX1  188
c              same effect as large                                             GLHX1  189
          RunTime = <lp;RUN_FRACTION>                                           GLHX1  190
          IF (RunTime .LT. 0.1)  RunTime = 1.0                                  GLHX1  191
c              load field can handle at current setpoint                        GLHX1  192
          IW    = 1                                                             GLHX1  193
          Qload = (<lp;COOL_SETPT> - (<gl:REF-GRND-TEMP>+GroundDeltaT))         GLHX1  194
     &         / (<gl;TIME_WEIGHT>/<gl;NUM_WELLS> + <gl;FACTOR>/RunTime)        GLHX1  195
          IF (QloopNet .GT. 0.)  THEN                                           GLHX1  196
            GPMcap = MAX(Qload/QloopNet * GPMs, 1.0)                            GLHX1  197
            GPMcap = MIN(GPMcap, <gl:HX-MAX-GPM>)                               GLHX1  198
          ELSE                                                                  GLHX1  199
            GPMcap = <gl:HX-MAX-GPM>                                            GLHX1  200
          ENDIF                                                                 GLHX1  201
        ENDIF                                                                   GLHX1  202
        <pe;OPER_CAPACITY> = GPMcap                                             GLHX1  203
        <pe;MAX_CAPACITY>  = GPMcap                                             GLHX1  204
      ENDIF                                                                     GLHX1  205
c                                                                               GLHX1  206
c ****         run function : GLHX_Vertical-2                                   GLHX1  207
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        GLHX1  208
c                                                                               GLHX1  209
      RETURN                                                                    GLHX1  210
c                                                                               GLHXV   53
c                                                                               GLHXV   54
c============= ROUTINE CALLED TO CALCULATE OUTPUT TEMPERATURE ================= GLHXV   55
c              zero hourly data                                                 GLHXV   56
 2000 CALL FILLN(0., GLHXDAT(1), IVTLIM(2,27))                                  GLHXV   57
c              total equipment pump kW                                          GLHXV   58
      AuxPumpKW  = 0.                                                           GLHXV   59
c              condenser loop flow thru this glhx                               GLHXV   60
      GPM = <pe;GPM>                                                            GLHXV   61
c                                                                               GLHXV   62
c ****         run function : GLHX_Vertical-3                                   GLHXV   63
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        GLHXV   64
c                                                                               GLHXV   65
c              hourly load and operating capacity                               GLHXV   66
      IF (Mode .EQ. 1)  THEN                                                    GLHXV   67
c              make heating loads negative                                      GLHXV   68
        QLoad = -<pe;LOAD>                                                      GLHXV   69
        <pe;LOAD> = QLoad                                                       GLHXV   70
      ELSE                                                                      GLHXV   71
        QLoad = <pe;LOAD>                                                       GLHXV   72
      ENDIF                                                                     GLHXV   73
c              operating capacity                                               GLHXV   74
      OperCap = <pe;OPER_CAPACITY>                                              GLHXV   75
c                                                                               GLHXV   76
c              skip rest if design day                                          GLHXV   77
      IF (IDDFLG .GT. 0)  THEN                                                  GLHXV   78
        IF (Mode .EQ. HEATMODE)  THEN                                           GLHXV   79
c              heating mode - use loop heating setpoint                         GLHXV   80
          <pe;SUPPLY_T> = <lp;HEAT_SETPT>                                       GLHXV   81
        ELSE                                                                    GLHXV   82
          <pe;SUPPLY_T> = <lp;COOL_SETPT>                                       GLHXV   83
        ENDIF                                                                   GLHXV   84
        RETURN                                                                  GLHXV   85
      ELSEIF (<gl;Initialized> .EQ. 0)  THEN                                    GLHXV   86
c              initialize history if first hour of real simulation              GLHXV   87
        CALL GLHX_Vertical_Design(2)                                            GLHXV   88
      ENDIF                                                                     GLHXV   89
c                                                                               GLHXV   90
c              Adjust averaged heat inputs over the time increments.            GLHXV   91
c              Use concept of moving pointer to determine average heat          GLHXV   92
c              inputs over portions of the year.  Do once for cooling           GLHXV   93
c              mode, and then repeat for heating mode only if heating           GLHXV   94
c              actually required (meaning cooling was bogus).                   GLHXV   95
      IF (Mode .NE. HEATMODE                                                    GLHXV   96
     &          .OR.  (Mode .EQ. HEATMODE  .AND.  Qload .LT. 0.))  THEN         GLHXV   97
c              Effect of current load on ground deltaT                          GLHX1  211
        IW = 1                                                                  GLHX1  212
        <gl;Qaverage> = QLoad / <gl;NUM_WELLS>                                  GLHX1  213
        GroundDeltaT  = <gl;Qaverage>*<gl;TIME_WEIGHT>                          GLHX1  214
c              include effect of past hours                                     GLHX1  215
        GroundDeltaT  = GroundDeltaT + GLHX_GroundDTpast(Jgl)                   GLHX1  216
c                                                                               GLHX1  217
c              Determine heat input RATE during time the pump is on             GLHX1  218
        Runtime = <lp;RUN_FRACTION>                                             GLHX1  219
        IF (Runtime .LT. 0.10)  RunTime = 1.0                                   GLHX1  220
        Qrate = Qload / RunTime                                                 GLHX1  221
c              delta T due to load                                              GLHXV  124
        IF(<gl:ALGORITHM> .EQ. 494) THEN                                        -044d2   1
c             Re-calculate borehole thermal resistance using                    -044d2   2
C             hourly loop temp.                                                 -044d2   3
          Fluid_Flow = <pe;DES_GPM> / <gl;NUM_WELLS>*3.78541 ! in l/min         -044d2   4
          gl_k_ground   = <gl:GRND-COND>  * 1.7296 ! Ground TC W/(m-C)          -044d2   5
          gl_k_grout = <gl:GROUT-COND> * 1.7296    ! Grout  TC W/(m-C)          -044d2   6
          gl_k_pipe     = <gl:PIPE-COND>  * 1.7296 ! Tube TC W/(m-C)            -044d2   7
          X_UTUBE    = <gl:UTUBE-LEG-SEP>  * 0.3048             ! in m          -044d2   8
          Pipe_Out_Dia = <gl:PIPE-OUT-DIA> * 0.3048             ! in m          -044d2   9
          Pipe_In_Dia  = <gl:PIPE-IN-DIA>  * 0.3048             ! in m          -044d2  10
          gl_Bore_Radius = <gl:BOREHOLE-DIAM>/(2.0*12.)*0.3048  ! in m          -044d2  11
          gl_Bore_Depth = <gl:DEPTH> * 0.3048                   ! in m          -044d2  12
c             Get loop temperature at the end of last hour                      -044d2  13
          Jlp = <gl:LOOP>                                                       -044d2  14
          Avg_Loop_T = ((<lp;SUPPLY_T> + <lp;RETURN_T>)                         -044d2  15
     $                / 2. - 32.) * 5. / 9.                     ! in C          -044d2  16
c                                                                               -044d2  17
          CALL Borehole_Therm_Resis(Fluid_Flow,gl_k_ground,gl_k_grout,          -044d2  18
     $       gl_k_pipe,X_UTUBE,Pipe_Out_Dia,Pipe_In_Dia,gl_Bore_Depth,          -044d2  19
     $       gl_Bore_Radius,<gl:FLUID>,<gl:ANTI-FREEZE-C>,                      -044d2  20
     $       Avg_Loop_T,RB)                                                     -044d2  21
          <gl;FACTOR> = (RB * 1.7296) / (<gl;NUM_WELLS> * <gl:DEPTH>)           -044d2  22
        ENDIF                                                                   -044d2  23
        QDeltaT = <gl;FACTOR>*Qrate                                             GLHXV  125
c                                                                               GLHXV  126
c              For old GLHXV use outlet tmep, for new ave loop temp             -044d   44
        OutletT = <gl:REF-GRND-TEMP> + GroundDeltaT + QDeltaT                   GLHXV  128
c                                                                               GLHXV  129
        IF(GPM .GT. 0.) THEN                                                    -044d   45
c              temperature change in loop                                       -044d   46
          LoopDeltaT = QLoad / (<lp;BTUH/GPM-F> * GPM)                          -044d   47
c              For new GLHX use average as outlet temperature                   -044d   48
          IF(<gl:ALGORITHM>.EQ.494) OutletT = OutletT - LoopDeltaT/2.           -044d   49
        ENDIF                                                                   -044d   50
c                                                                               GLHXV  132
c ****         run function : GLHX_Vertical-4                                   GLHXV  133
c       IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                      GLHXV  134
c                                                                               GLHXV  135
c              Check if GLHX is producing an unrealistic outlet T               -045h   23
        IF (OutletT .gt. 150.  .or.  OutletT .lt. 0.) THEN                      -045h   24
          Call MsgSim(-1,ii,ii,ii,ii)                                           -045h   25
          Write (IOUTPT, 9101) (<gl:NAME>,II=1,8), Int(OutletT),                -045h   26
     &                         IMO,IDAY,IHR                                     -045h   27
          CALL MessageBox( NULL,                                                -045h   28
     &      'GLHX is undersized and is'//char(10)//char(13)//                   -045h   29
     &      ' producing an extreme temperature'//char(0),                       -045h   30
     &      'GLHX Errors'//char(0),                                             -045h   31
     &      MB_OK + MB_ICONSTOP + MB_TASKMODAL )                                -045h   32
        ENDIF                                                                   -045h   33
 9101   FORMAT(14x,'Ground-loop HX: ',8A4,                             /        -045h   34
     &  14x,'is undersized for the load and is producing an extreme'   /        -045h   35
     &  14x,'temperature of',I6'F.  Mon/Day/Hr: ',I2,'/',I2,'/',I2     )        -045h   36
                                                                                -045h   37
c              report variables                                                 GLHXV  136
        <pe;SUPPLY_T> = OutletT                                                 GLHXV  137
c                                                                               GLHXV  138
c              hourly-report variables                                          GLHXV  139
        IF (<gl;HREP> .NE. 0  .AND.  IRSCH .NE. 0)  THEN                        GLHXV  140
          FarGroundT = <gl:REF-GRND-TEMP>                                       GLHXV  141
          CALL HourRepPLT(GLHXDAT(1), <gl;HREP>, 27, 0)                         GLHXV  142
        ENDIF                                                                   GLHXV  143
      ENDIF  ! Mode                                                             GLHXV  144
c                                                                               GLHXV  145
      RETURN                                                                    GLHXV  146
c                                                                               GLHXV  147
c                                                                               GLHXV  148
c============= ROUTINE CALLED TO UPDATE HISTORY =============================== GLHXV  149
c              Move the pointers iPnt(I) to account for next hour.  Note        GLHXV  150
c              that all glhx components use the same set - update only          GLHXV  151
c              once per hour                                                    GLHXV  152
 3000 IF (Jgl .EQ. Igl)  THEN                                                   GLHXV  153
        DO  I=1,15                                                              GLHXV  154
          iPnt(i) = iPnt(i) - 1                                                 GLHXV  155
          IF (iPnt(i) .EQ. 0)  iPnt(i) = 8760                                   GLHXV  156
        ENDDO                                                                   GLHXV  157
      ENDIF                                                                     GLHXV  158
c              Store value of past hour's heat input to ground                  GLHXV  159
      IH = 8761 - iPnt(1)                                                       GLHXV  160
      IW = 1                                                                    GLHXV  161
      <gl;Q_8760> = <gl;Qaverage>                                               GLHXV  162
c              Transfer current weighted heat input to past for use             GLHXV  163
c              next hour                                                        GLHXV  164
      DO  IW=1,15                                                               GLHXV  165
        <gl;QaveragePast> = <gl;Qaverage>                                       GLHXV  166
      ENDDO                                                                     GLHXV  167
c                                                                               GLHXV  168
c ****         run function : GLHX_Vertical-5                                   GLHXV  169
c       IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                      GLHXV  170
c                                                                               GLHXV  171
c                                                                               GLHXV  172
      RETURN                                                                    GLHXV  173
      END                                                                       GLHXV  174
      SUBROUTINE GLHX_Vertical_Design(Mode)                                     GLHXVD   2
c                                                                               GLHXVD   3
c              Sets up a ground-loop heat-exchanger with a                      GLHXVD   4
c              scheduled output temperature                                     GLHXVD   5
c                                                                               GLHXVD   6
c              Mode = 1  Setup the circulation-loop interface                   GLHXVD   7
c                     2  Setup the ground field parameters and                  GLHXVD   8
c                        initialize the history                                 GLHXVD   9
c                                                                               GLHXVD  10
c                                                                               /JJHLIT/ 2
c              Original DOE-2 Ground HX models developed by                     -044d    1
c                            R. Merriam, Arthur D Little (617-498-5887)         /JJHLIT/ 4
c                            August 29, 1995                                    /JJHLIT/ 5
c                                                                               /JJHLIT/ 6
c              and IMPLEMENTATION BY                                            -044d    2
c                            S. D. Gates                                        /JJHLIT/ 8
c                            J. J. Hirsch                                       /JJHLIT/ 9
c                            James J. Hirsch & Associates                       /JJHLIT/10
c                            Camarillo, California                              /JJHLIT/11
c                                                                               /JJHLIT/12
Copyright (c) 1997 by James J. Hirsch. All Rights Reserved. Unpublished         /JJHLIT/13
c rights reserved under the Copyright Laws of the United States.                /JJHLIT/14
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHLIT/15
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHLIT/16
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHLIT/17
c                                                                               /JJHLIT/18
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /GLHX  / iPnt(15)                                                 /GLHX/   2
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               GLHXVD  17
      REAL Mcp                                                                  GLHXVD  18
c              Note: dimension 16 is for previous years                         GLHXVD  19
      DIMENSION Gi(16), iPntSet(15)                                             GLHXVD  20
      DIMENSION p3(2),   p4(3),    p5(5),   p6(7),   p7(9),   p9(2),            GLHXVD  21
     &          p10(4),  p11(5),   p12(11), p13(9),  p14(8),  p15(10),          GLHXVD  22
     &          p16(14), p17(18),  p18(14), p19(25)                             GLHXVD  23
                                                                                GLHXVD  24
      DIMENSION g3(2),   g4(3),    g5(5),   g6(7),   g7(9),   g9(2),            GLHXVD  25
     &          g10(4),  g11(5),   g12(11), g13(9),  g14(8),  g15(10),          GLHXVD  26
     &          g16(14), g17(18),  g18(14), g19(25)                             GLHXVD  27
c                                                                               GLHXVD  28
      DATA PI / 3.1415927 /                                                     GLHXVD  29
      DATA iPntSet / 1, 2, 3, 6, 12, 24, 48, 96, 192, 384, 768, 1536,           GLHXVD  30
     &               2184, 4368, 8760 /                                         GLHXVD  31
      DATA p3 / 1.0, 2.0 /                                                      GLHXVD  32
      DATA g3 / 1.33333, 0.66667 /                                              GLHXVD  33
      DATA p4 / 1.0, 2.0, 3.0 /                                                 GLHXVD  34
      DATA g4 / 1.5, 1.0, 0.5 /                                                 GLHXVD  35
      DATA p5 / 1.0, 2.0, 3.0, 4.0, 5.0 /                                       GLHXVD  36
      DATA g5 / 1.6667, 1.3333, 1.0, 0.6667, 0.3333 /                           GLHXVD  37
      DATA p6 / 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0 /                             GLHXVD  38
      DATA g6 / 1.75, 1.50, 1.25, 1.0, 0.75, 0.50, 0.25 /                       GLHXVD  39
      DATA p7 / 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0 /                   GLHXVD  40
      DATA g7 / 1.80, 1.60, 1.40, 1.20, 1.0, 0.80, 0.60, 0.40, 0.20 /           GLHXVD  41
      DATA p9 / 1.0, 1.414214 /                                                 GLHXVD  42
      DATA g9 / 2.0, 1.0 /                                                      GLHXVD  43
      DATA p10 / 1.0, 2.0, 1.41421, 2.23607 /                                   GLHXVD  44
      DATA g10 / 2.3333, 0.6667, 1.3333, 0.6667 /                               GLHXVD  45
      DATA p11 / 1.0, 2.0, 1.41421, 2.23607, 2.82843 /                          GLHXVD  46
      DATA g11 / 2.6667, 1.3333, 1.7778, 1.7778, 0.4444 /                       GLHXVD  47
      DATA p12 / 1.0, 2.0, 3.0, 4.0, 1.41421, 2.23607, 2.82843,                 GLHXVD  48
     &           3.16228, 3.60555, 4.12311, 4.47214 /                           GLHXVD  49
      DATA g12 / 2.9333, 1.8667, 0.8, 0.4, 2.1333, 2.6667,                      GLHXVD  50
     &           0.8, 1.0667, 0.5333, 0.5333, 0.2667 /                          GLHXVD  51
      DATA p13 / 1.0, 2.0, 3.0, 1.41421, 2.23607, 2.82843,                      GLHXVD  52
     &           3.16228, 3.60555, 4.24264 /                                    GLHXVD  53
      DATA g13 / 3.0, 2.0, 1.0, 2.25, 3.0, 1.0, 1.5, 1.0, 0.25 /                GLHXVD  54
      DATA p14 / 1.0, 2.0, 3.0, 1.41421, 2.23607, 2.82843,                      GLHXVD  55
     &           3.16228, 3.60555 /                                             GLHXVD  56
      DATA g14 / 2.8333, 1.6667, 0.5, 2.0, 2.3333, 0.6667,                      GLHXVD  57
     &           0.6667, 0.3333 /                                               GLHXVD  58
      DATA p15 / 1.0, 2.0, 3.0, 4.0, 5.0, 1.41421, 2.23607,                     GLHXVD  59
     &           3.16228, 4.12311, 5.09902 /                                    GLHXVD  60
      DATA g15 / 2.6667, 1.3333, 1.0, 0.6667, 0.3333, 1.6667,                   GLHXVD  61
     &           1.3333, 1.0, 0.6667, 0.3333 /                                  GLHXVD  62
      DATA p16 / 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 1.41421,                    GLHXVD  63
     &           2.23607, 3.16228, 4.12311, 5.09902, 6.08276, 7.07107 /         GLHXVD  64
      DATA g16 / 2.75, 1.50, 1.25, 1.0, 0.75, 0.5, 0.25,                        GLHXVD  65
     &           1.75, 1.50, 1.25, 1.0, 0.75, 0.5, 0.25 /                       GLHXVD  66
      DATA p17 / 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0,                   GLHXVD  67
     &           1.41421, 2.23607, 3.16228, 4.12311, 5.09902,                   GLHXVD  68
     &           6.08276, 7.07107, 8.06226, 9.05539 /                           GLHXVD  69
      DATA g17 / 2.8, 1.6, 1.4, 1.2, 1.0, 0.8, 0.6, 0.4, 0.2,                   GLHXVD  70
     &           1.8, 1.6, 1.4, 1.2, 1.0, 0.8, 0.6, 0.4, 0.2 /                  GLHXVD  71
      DATA p18 / 1.0, 2.0, 3.0, 4.0, 5.0, 1.41421, 2.23607, 3.16228,            GLHXVD  72
     &           4.12311, 5.09902, 2.82843, 3.60555, 4.47214, 5.38516 /         GLHXVD  73
      DATA g18 / 3.0, 2.0, 1.0, 0.6667, 0.3333, 2.2222, 2.8889,                 GLHXVD  74
     &           1.3333, 0.8889, 0.4444, 0.8889, 0.6667, 0.4444, 0.2222/        GLHXVD  75
      DATA p19 / 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 1.41421, 2.23607,           GLHXVD  76
     &           3.16228, 4.12311, 5.09902, 6.08276, 7.07107,                   GLHXVD  77
     &           2.82843, 3.60555, 4.47214, 5.38516, 6.32456,                   GLHXVD  78
     &           7.28011, 4.24264, 5.0, 5.83095, 6.70820, 7.48331 /             GLHXVD  79
      DATA g19 / 3.25, 2.5, 1.75, 1.0, 0.75, 0.5, 0.25, 2.625,                  GLHXVD  80
     &           4.0, 2.75, 1.5, 1.125, 0.75, 0.375, 1.5, 2.0,                  GLHXVD  81
     &           1.0, 0.75, 0.5, 0.25, 0.625, 0.5, 0.375, 0.25, 0.125 /         GLHXVD  82
c                                                                               GLHXVD  83
c                                                                               GLHXVD  84
c              pointer to cw loop                                               GLHXVD  85
      Jlp = <gl:LOOP>                                                           GLHXVD  86
c                                                                               GLHXVD  87
      IF (Mode .EQ. 2)  GOTO 2000                                               GLHXVD  88
c                                                                               GLHXVD  89
c============= SETUP THE LOOP INTERFACE ======================================= GLHXVD  90
c              design capacity                                                  -034    48
      Qloop = MAX(<lp;DES_CCAP>, ABS(<lp;DES_HCAP>))                            -034    49
      IF (<gl:CAPACITY> .EQ. 0.)  THEN                                          -034    50
        QLoad = Qloop                                                           -034    51
        IF (<gl:CAP-RATIO> .EQ. UNFILD)  THEN                                   GLHXVD  94
c              no capacity ratio specified - size equipment equally             GLHXVD  95
          QLoad = QLoad / FLOAT(<lp;CL_NUM_EQUIP>)                              GLHXVD  96
        ELSE                                                                    GLHXVD  97
          QLoad = QLoad * <gl:CAP-RATIO>                                        GLHXVD  98
        ENDIF                                                                   GLHXVD  99
      ELSE                                                                      GLHXVD 100
        QLoad = <gl:CAPACITY>                                                   GLHXVD 101
      ENDIF                                                                     GLHXVD 102
c              no glhx if no flow                                               GLHXVD 103
      IF (QLoad .LT. 1.)  THEN                                                  GLHXVD 104
        <gl:CAPACITY> = 0.                                                      GLHXVD 105
        CALL MSGSIM(-3, II,II,II,II)                                            GLHXVD 106
        WRITE(IOUTPT,9100) (<gl:NAME>,II=1,8),                                  GLHXVD 107
     &                     (<lp:NAME>,II=1,8)                                   GLHXVD 108
        RETURN                                                                  GLHXVD 109
      ENDIF                                                                     GLHXVD 110
      <gl:CAPACITY> = QLoad                                                     GLHXVD 111
c                                                                               GLHXVD 112
c              pick up component dT from loop if not specd.                     GLHXVD 113
      IF (<gl:HX-DT> .EQ. 0.)  <gl:HX-DT> = <lp:DESIGN-DT>                      GLHXVD 114
c              design flow - greater of load or flow requirement                -034    52
      GPMload = QLoad / (<lp;BTUH/GPM-F> * <gl:HX-DT>)                          -034    53
      GPMflow = <lp;DES_GPM> * Qload/Qloop                                      -034    54
      GPM     = MAX(GPMload, GPMflow)                                           -034    55
c              convert minimum and maximum flow from fraction to gpm            GLHXVD 117
      <gl:HX-MIN-GPM> = GPM * <gl:HX-MIN-GPM>                                   GLHXVD 118
      <gl:HX-MAX-GPM> = GPM * <gl:HX-MAX-GPM>                                   GLHXVD 119
      IF (<gl:HX-MAX-GPM> .LT. <lp:RECIRC-GPM>  .OR.                            -035    89
     &    <gl:HX-MAX-GPM> .LT. <lp:MIN-GPM>)    THEN                            -035    90
        CALL MSGSIM(-3,II,II,II,II)                                             -035    91
        WRITE (IOUTPT, 9001)  (<gl:NAME>,II=1,8)                                -035    92
      ENDIF                                                                     -035    93
c                                                                               GLHXVD 120
c            Calculate head loss of GLHX using Hazen-Williams equation          -044d   51
c            Plant model needs to be revised so that the following              -044d   52
c            head loss calculation is performed when total loop head            -044d   53
c            loss is calculated. LXB 06-03-20                                   -044d   54
cc      <gl:HX-HEAD> = (0.2083 * (100. / 150.) ** 1.852                         -044d   55
cc     $               * (GPM / (<gl:FIELD-MULT>*<gl:NUM-BOREHOLES>))           -044d   56
cc     $               ** 1.852 / (<gl:PIPE-IN-DIA> ** 4.8655))                 -044d   57
cc     $               * ( (<gl:DEPTH> * 2. + 40.) / 100.)                      -044d   58
c                                                                               -044d   59
c            Anti-freeze correction for head loss of GLHX                       -044d   60
cc      IF((<gl:FLUID> .EQ. 1.) .OR. (<gl:FLUID> .EQ. 2.))THEN                  -044d   61
c            For Glycol solution                                                -044d   62
cc        <gl:HX-HEAD> = <gl:HX-HEAD> * 1.35                                    -044d   63
cc      ELSEIF((<gl:FLUID> .EQ. 3.) .OR. (<gl:FLUID> .EQ. 4.))THEN              -044d   64
c            For Alcohol solution                                               -044d   65
cc        <gl:HX-HEAD> = <gl:HX-HEAD> * 1.22                                    -044d   66
cc      ENDIF                                                                   -044d   67
c                                                                               -044d   68
c              warn if loop pressure drop different than others                 GLHXVD 121
      IF (<gl:HX-PUMP> .EQ. 0)  THEN                                            GLHXVD 122
        IF (ABS(<gl:HX-HEAD>+<gl:HX-STATIC>                                     GLHXVD 123
     &       - (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>))                         GLHXVD 124
     &      / (<lp;SUP-SIDE_HEAD>+<lp;SUP-SIDE_STAT>) .GT. 0.05)  THEN          GLHXVD 125
          CALL MSGSIM(-3,II,II,II,II)                                           GLHXVD 126
          WRITE (IOUTPT,9107) (<gl:NAME>,II=1,8),                               GLHXVD 127
     &                        (<lp:NAME>,II=1,8)                                GLHXVD 128
        ENDIF                                                                   GLHXVD 129
      ENDIF                                                                     GLHXVD 130
c              design the attached pump                                         GLHXVD 131
      IF (<gl:HX-PUMP> .GT. 0)  THEN                                            GLHXVD 132
        Jpm = <gl:HX-PUMP>                                                      GLHXVD 133
c                                                                               GLHXVD 134
        CALL PUMPdes(GPM)                                                       GLHXVD 135
        <pm;MIN_GPM> = <gl:HX-MIN-GPM>                                          GLHXVD 136
      ENDIF                                                                     GLHXVD 137
c              total primary loop equipment capacity                            GLHXVD 138
      <lp;PRIMARY_CCAP> = <lp;PRIMARY_CCAP> + QLoad                             GLHXVD 139
      <lp;PRIMARY_HCAP> = <lp;PRIMARY_HCAP> - QLoad                             GLHXVD 140
                                                                                GLHXVD 141
c              save design variables for use in PrimaryEquip                    GLHXVD 142
c              heat-rejection mode                                              GLHXVD 143
      Jpe = <gl;Jpe>                                                            GLHXVD 144
      <pe;Jpm>        = <gl:HX-PUMP>                                            GLHXVD 145
      <pe;DES_GPM>    = GPM                                                     GLHXVD 146
      <pe;MAX_GPM>    = <gl:HX-MAX-GPM>                                         GLHXVD 147
      <pe;DES_HEAD>   = <gl:HX-HEAD>                                            GLHXVD 148
      <pe;DES_STATIC> = <gl:HX-STATIC>                                          GLHXVD 149
      <pe:ISOLATION>  = 1                                                       GLHXVD 150
c              heat-absorption mode                                             GLHXVD 151
      Jpe = <gl;Jpe_HEAT>                                                       GLHXVD 152
      <pe;Jpm>        = <gl:HX-PUMP>                                            GLHXVD 153
      <pe;DES_GPM>    = GPM                                                     GLHXVD 154
      <pe;MAX_GPM>    = <gl:HX-MAX-GPM>                                         GLHXVD 155
      <pe;DES_HEAD>   = <gl:HX-HEAD>                                            GLHXVD 156
      <pe;DES_STATIC> = <gl:HX-STATIC>                                          GLHXVD 157
      <pe:ISOLATION>  = 1                                                       GLHXVD 158
c                                                                               GLHXVD 159
      RETURN                                                                    GLHXVD 160
c                                                                               GLHXVD 161
c                                                                               GLHXVD 162
c============= GLHX INITIALIZATION OF LOOP HISTORY============================= GLHXVD 163
 2000 <gl;Initialized>  = 1                                                     GLHXVD 164
c              round some variables to nearest integer                          GLHXVD 165
      <gl:FIELD-MULT>   = ANINT(<gl:FIELD-MULT>)                                GLHXVD 166
      <gl:NUM-OF-YEARS> = ANINT(<gl:NUM-OF-YEARS>)                              GLHXVD 167
      <gl:DES-HEAT-DAY> = ANINT(<gl:DES-HEAT-DAY>)                              GLHXVD 168
      <gl:DES-COOL-DAY> = ANINT(<gl:DES-COOL-DAY>)                              GLHXVD 169
c                                                                               GLHXVD 170
c              get the 24-hour profile                                          GLHXVD 171
      CALL GLHX_LoadProfiles                                                    GLHXVD 172
c                                                                               GLHXVD 173
c============= SET-UP THE GROUND-FIELD ======================================== GLHXVD 174
c              setup piping characteristics                                     GLHXVD 175
      <gl:PIPE-OUT-DIA>  = <gl:PIPE-OUT-DIA>  / 12.0    ! Tube OD               GLHXVD 176
      <gl:PIPE-IN-DIA>   = <gl:PIPE-IN-DIA>   / 12.0    ! Tube ID               GLHXVD 177
      <gl:UTUBE-LEG-SEP> = <gl:UTUBE-LEG-SEP> / 12.0    ! Tube separation       GLHXVD 178
c              Equivalent radius of single pipe representing U-tube             GLHXVD 179
      S = <gl:PIPE-OUT-DIA> * SQRT(2.0) / 2.0                                   GLHXVD 180
c                                                                               GLHXVD 181
c              Determine value for "time to steady-state" (Eskilson)            GLHXVD 182
      t1 = <gl:DEPTH>*<gl:DEPTH> / 9.0 / <gl:GRND-DIFFUS>                       GLHXVD 183
      IF(<gl:ALGORITHM> .EQ. 494) THEN                                          -044d   69
          <gl;NUM_WELLS> = <gl:FIELD-MULT>*<gl:NUM-BOREHOLES>                   -044d   70
      ENDIF                                                                     -044d   71
c              Set up time pointers and determine Gi                            GLHXVD 184
      DO  i=1,16                                                                GLHXVD 185
        IF (i .LT. 16) then                                                     GLHXVD 186
          iPnt(i) = iPntSet(i)                                                  GLHXVD 187
          TheHour = FLOAT(iPnt(i))                                              GLHXVD 188
        ELSE                                                                    GLHXVD 189
          TheHour = <gl:NUM-OF-YEARS> * 8760.                                   GLHXVD 190
        END IF                                                                  GLHXVD 191
        IF(<gl:ALGORITHM> .EQ. 494) THEN                                        -044d   72
          IF(TheHour .EQ. 0) THEN                                               -044d   73
            Gi(i) = 0.                                                          -044d   74
          ELSE                                                                  -044d   75
            tlog = log (TheHour / t1)                                           -044d   76
            JJ = 1                                                              -044d   77
            CALL INTERP(<gl:LN-T/TS>,<gl:G-FUNCTIONS>,27,tlog,GVAL)             -044d   78
            Gi(i) = GVAL / (2.0 * PI)                                           -044d   79
          ENDIF                                                                 -044d   80
        ELSE                                                                    -044d   81
        Z     = <gl:GRND-DIFFUS> * TheHour / (S*S)                              GLHXVD 192
        Gi(i) = GLHX_Exponential(Z)                                             GLHXVD 193
c                                                                               GLHXVD 194
c              Account for interference effects according to the                GLHXVD 195
c              the number of wells and the patterns of drilling                 GLHXVD 196
        SELECT CASE (<gl:CONFIGURATION>)            ! Well configuration        GLHXVD 197
          CASE (1)           ! Only one well - no inteference                   GLHXVD 198
            <gl;NUM_WELLS> = <gl:FIELD-MULT>                                    GLHXVD 199
          CASE (2)           ! 2 wells                                          GLHXVD 200
            <gl;NUM_WELLS> = 2. * <gl:FIELD-MULT>                               GLHXVD 201
            P     = <gl:SPACING>                                                GLHXVD 202
            Z     = <gl:GRND-DIFFUS> * TheHour / (P*P)                          GLHXVD 203
            Gi(i) = Gi(i) + GLHX_Exponential(Z)                                 GLHXVD 204
          CASE (3)           ! 3 wells (line)                                   GLHXVD 205
            <gl;NUM_WELLS> = 3. * <gl:FIELD-MULT>                               GLHXVD 206
            DO  k=1,2                                                           GLHXVD 207
              P     = p3(k) * <gl:SPACING>                                      GLHXVD 208
              Z     = <gl:GRND-DIFFUS> * TheHour / (P*P)                        GLHXVD 209
              Gi(i) = Gi(i) + g3(k) * GLHX_Exponential(Z)                       GLHXVD 210
            ENDDO                                                               GLHXVD 211
          CASE (4)           ! 4 wells (line)                                   GLHXVD 212
            <gl;NUM_WELLS> = 4. * <gl:FIELD-MULT>                               GLHXVD 213
            DO  k=1,3                                                           GLHXVD 214
              P     = p4(k) * <gl:SPACING>                                      GLHXVD 215
              Z     = <gl:GRND-DIFFUS> * TheHour / (P*P)                        GLHXVD 216
              Gi(i) = Gi(i) + g4(k) * GLHX_Exponential(Z)                       GLHXVD 217
            ENDDO                                                               GLHXVD 218
          CASE (5)           ! 6 wells (line)                                   GLHXVD 219
            <gl;NUM_WELLS> = 6. * <gl:FIELD-MULT>                               GLHXVD 220
            DO  k=1,5                                                           GLHXVD 221
              P     = p5(k) * <gl:SPACING>                                      GLHXVD 222
              Z     = <gl:GRND-DIFFUS> * TheHour / (P*P)                        GLHXVD 223
              Gi(i) = Gi(i) + g5(k) * GLHX_Exponential(Z)                       GLHXVD 224
            ENDDO                                                               GLHXVD 225
          CASE (6)           ! 8 wells (line)                                   GLHXVD 226
            <gl;NUM_WELLS> = 8. * <gl:FIELD-MULT>                               GLHXVD 227
            DO  k=1,7                                                           GLHXVD 228
              P     = p6(k) * <gl:SPACING>                                      GLHXVD 229
              Z     = <gl:GRND-DIFFUS> * TheHour / (P*P)                        GLHXVD 230
              Gi(i) = Gi(i) + g6(k) * GLHX_Exponential(Z)                       GLHXVD 231
            ENDDO                                                               GLHXVD 232
          CASE (7)           ! 10 wells (line)                                  GLHXVD 233
            <gl;NUM_WELLS> = 10. * <gl:FIELD-MULT>                              GLHXVD 234
             DO  k=1,9                                                          GLHXVD 235
               P     = p7(k) * <gl:SPACING>                                     GLHXVD 236
               Z     = <gl:GRND-DIFFUS> * TheHour / (P*P)                       GLHXVD 237
               Gi(i) = Gi(i) + g7(k) * GLHX_Exponential(Z)                      GLHXVD 238
             ENDDO                                                              GLHXVD 239
          CASE (8)           ! 3 wells (triangle)                               GLHXVD 240
            <gl;NUM_WELLS> = 3. * <gl:FIELD-MULT>                               GLHXVD 241
            P     = <gl:SPACING>                                                GLHXVD 242
            Z     = <gl:GRND-DIFFUS> * TheHour / (P*P)                          GLHXVD 243
            Gi(i) = Gi(i) + 2.0 * GLHX_Exponential(Z)                           GLHXVD 244
          CASE (9)           ! 4 wells (square)                                 GLHXVD 245
            <gl;NUM_WELLS> = 4. * <gl:FIELD-MULT>                               GLHXVD 246
            DO  k=1,2                                                           GLHXVD 247
              P     = p9(k) * <gl:SPACING>                                      GLHXVD 248
              Z     = <gl:GRND-DIFFUS> * TheHour / (P*P)                        GLHXVD 249
              Gi(i) = Gi(i) + g9(k) * GLHX_Exponential(Z)                       GLHXVD 250
            ENDDO                                                               GLHXVD 251
          CASE (10)          ! 6 wells (rectangle)                              GLHXVD 252
            <gl;NUM_WELLS> = 6. * <gl:FIELD-MULT>                               GLHXVD 253
            DO  k=1,4                                                           GLHXVD 254
              P     = p10(k) * <gl:SPACING>                                     GLHXVD 255
              Z     = <gl:GRND-DIFFUS> * TheHour / (P*P)                        GLHXVD 256
              Gi(i) = Gi(i) + g10(k) * GLHX_Exponential(Z)                      GLHXVD 257
            ENDDO                                                               GLHXVD 258
          CASE (11)          ! 9 wells (square)                                 GLHXVD 259
            <gl;NUM_WELLS> = 9. * <gl:FIELD-MULT>                               GLHXVD 260
            DO  k=1,5                                                           GLHXVD 261
              P     = p11(k) * <gl:SPACING>                                     GLHXVD 262
              Z     = <gl:GRND-DIFFUS> * TheHour / (P*P)                        GLHXVD 263
              Gi(i) = Gi(i) + g11(k) * GLHX_Exponential(Z)                      GLHXVD 264
            ENDDO                                                               GLHXVD 265
          CASE (12)          ! 15 wells (square)                                GLHXVD 266
            <gl;NUM_WELLS> = 15. * <gl:FIELD-MULT>                              GLHXVD 267
            DO  k=1,11                                                          GLHXVD 268
              P     = p12(k) * <gl:SPACING>                                     GLHXVD 269
              Z     = <gl:GRND-DIFFUS> * TheHour / (P*P)                        GLHXVD 270
              Gi(i) = Gi(i) + g12(k) * GLHX_Exponential(Z)                      GLHXVD 271
            ENDDO                                                               GLHXVD 272
          CASE (13)          ! 16 wells (square)                                GLHXVD 273
            <gl;NUM_WELLS> = 16. * <gl:FIELD-MULT>                              GLHXVD 274
            DO  k=1,9                                                           GLHXVD 275
              P     = p13(k) * <gl:SPACING>                                     GLHXVD 276
              Z     = <gl:GRND-DIFFUS> * TheHour / (P*P)                        GLHXVD 277
              Gi(i) = Gi(i) + g13(k) * GLHX_Exponential(Z)                      GLHXVD 278
            ENDDO                                                               GLHXVD 279
          CASE (14)          ! 4 x 3 wells                                      GLHXVD 280
            <gl;NUM_WELLS> = 12. * <gl:FIELD-MULT>                              GLHXVD 281
            DO  k=1,8                                                           GLHXVD 282
              P     = p14(k) * <gl:SPACING>                                     GLHXVD 283
              Z     = <gl:GRND-DIFFUS> * TheHour / (P*P)                        GLHXVD 284
              Gi(i) = Gi(i) + g14(k) * GLHX_Exponential(Z)                      GLHXVD 285
            ENDDO                                                               GLHXVD 286
          CASE (15)          ! 6 x 2 wells                                      GLHXVD 287
            <gl;NUM_WELLS> = 12. * <gl:FIELD-MULT>                              GLHXVD 288
            DO  k=1,10                                                          GLHXVD 289
              P     = p15(k) * <gl:SPACING>                                     GLHXVD 290
              Z     = <gl:GRND-DIFFUS> * TheHour / (P*P)                        GLHXVD 291
              Gi(i) = Gi(i) + g15(k) * GLHX_Exponential(Z)                      GLHXVD 292
            END DO                                                              GLHXVD 293
          CASE (16)          ! 8 x 2 wells                                      GLHXVD 294
            <gl;NUM_WELLS> = 16. * <gl:FIELD-MULT>                              GLHXVD 295
            DO  k=1,14                                                          GLHXVD 296
              P     = p16(k) * <gl:SPACING>                                     GLHXVD 297
              Z     = <gl:GRND-DIFFUS> * TheHour / (P*P)                        GLHXVD 298
              Gi(i) = Gi(i) + g16(k) * GLHX_Exponential(Z)                      GLHXVD 299
            ENDDO                                                               GLHXVD 300
          CASE (17)          ! 10 x 2 wells                                     GLHXVD 301
            <gl;NUM_WELLS> = 20. * <gl:FIELD-MULT>                              GLHXVD 302
            DO  k=1,18                                                          GLHXVD 303
              P     = p17(k) * <gl:SPACING>                                     GLHXVD 304
              Z     = <gl:GRND-DIFFUS> * TheHour / (P*P)                        GLHXVD 305
              Gi(i) = Gi(i) + g17(k) * GLHX_Exponential(Z)                      GLHXVD 306
            ENDDO                                                               GLHXVD 307
          CASE (18)          ! 6 x 3 wells                                      GLHXVD 308
            <gl;NUM_WELLS> = 18. * <gl:FIELD-MULT>                              GLHXVD 309
            DO  k=1,14                                                          GLHXVD 310
              P     = p18(k) * <gl:SPACING>                                     GLHXVD 311
              Z     = <gl:GRND-DIFFUS> * TheHour / (P*P)                        GLHXVD 312
              Gi(i) = Gi(i) + g18(k) * GLHX_Exponential(Z)                      GLHXVD 313
            ENDDO                                                               GLHXVD 314
          CASE (19)          ! 8 x 4 wells                                      GLHXVD 315
            <gl;NUM_WELLS> = 32. * <gl:FIELD-MULT>                              GLHXVD 316
            DO  k=1,25                                                          GLHXVD 317
              P     = p19(k) * <gl:SPACING>                                     GLHXVD 318
              Z     = <gl:GRND-DIFFUS> * TheHour / (P*P)                        GLHXVD 319
              Gi(i) = Gi(i) + g19(k) * GLHX_Exponential(Z)                      GLHXVD 320
            ENDDO                                                               GLHXVD 321
        END SELECT  ! Well configuration                                        GLHXVD 322
c                                                                               GLHXVD 323
c              Correct for approach to "steady-state" time                      GLHXVD 324
        gValue = 1.0                                                            GLHXVD 325
        IF (TheHour .GT. 0.0) THEN                                              GLHXVD 326
          tlog = log (TheHour / t1)                                             GLHXVD 327
          IF (tlog .GT. -2.0)  gValue = 0.947738                                GLHXVD 328
     &                  - 0.045796 * tlog - 0.00812779 * tlog*tlog              GLHXVD 329
        ENDIF                                                                   GLHXVD 330
        gValue = gValue - 0.00688 * 2.0 * PI * Gi(i)                            GLHXVD 331
        Gi(i)  = gValue * Gi(i)                                                 GLHXVD 332
        ENDIF                                                                   -044d   82
        IW     = i                                                              GLHXVD 333
        IF (i .NE. 1 .AND. i .NE. 16) THEN                                      GLHXVD 334
          <gl;TIME_WEIGHT> = (Gi(i) - Gi(i-1))                                  GLHXVD 335
     &                             / (<gl:DEPTH> * <gl:GRND-COND>)              GLHXVD 336
        ELSE                                                                    GLHXVD 337
          <gl;TIME_WEIGHT> = Gi(i) / (<gl:DEPTH> * <gl:GRND-COND>)              GLHXVD 338
        ENDIF                                                                   GLHXVD 339
      ENDDO                                                                     GLHXVD 340
c                                                                               GLHXVD 341
c              Average heat inputs to soil for preceeding 8760 hours            GLHXVD 342
      qYear = 0.0                                                               GLHXVD 343
      IF (<gl:NUM-OF-YEARS> .GT. 0) THEN                                        GLHXVD 344
c              Account for seasonal imbalances                                  GLHXVD 345
        IF (<gl:DES-COOL-DAY> .GT. <gl:DES-HEAT-DAY>) THEN                      GLHXVD 346
          Phse1 = <gl:DES-HEAT-DAY> - <gl:DES-COOL-DAY> + 365                   GLHXVD 347
          Phse2 = <gl:DES-COOL-DAY> - <gl:DES-HEAT-DAY>                         GLHXVD 348
        ELSE                                                                    GLHXVD 349
          Phse1 = <gl:DES-COOL-DAY> - <gl:DES-HEAT-DAY> + 365                   GLHXVD 350
          Phse2 = <gl:DES-HEAT-DAY> - <gl:DES-COOL-DAY>                         GLHXVD 351
        END IF                                                                  GLHXVD 352
        DO  i=1,365                                                             GLHXVD 353
          IF (<gl:DES-COOL-DAY> .GT. <gl:DES-HEAT-DAY>) THEN                    GLHXVD 354
            ARG = i - <gl:DES-COOL-DAY>                                         GLHXVD 355
            IF (i .LT. <gl:DES-HEAT-DAY>) THEN                                  GLHXVD 356
              ARG = (ARG + 365.0) * PI / Phse1                                  GLHXVD 357
            ELSEIF (i .GT. <gl:DES-COOL-DAY>) THEN                              GLHXVD 358
              ARG = ARG * PI / Phse1                                            GLHXVD 359
            ELSE                                                                GLHXVD 360
              ARG = ARG * PI / Phse2                                            GLHXVD 361
            ENDIF                                                               GLHXVD 362
          ELSE                                                                  GLHXVD 363
            ARG = i - <gl:DES-HEAT-DAY>                                         GLHXVD 364
            IF (i .LT. <gl:DES-COOL-DAY>) THEN                                  GLHXVD 365
              ARG = (ARG + 365.0) * PI / Phse1                                  GLHXVD 366
            ELSEIF (i .GT. <gl:DES-HEAT-DAY>) THEN                              GLHXVD 367
              ARG = ARG * PI / Phse1                                            GLHXVD 368
            ELSE                                                                GLHXVD 369
              ARG = ARG * PI / Phse2                                            GLHXVD 370
            ENDIF                                                               GLHXVD 371
            ARG = ARG + PI                                                      GLHXVD 372
          ENDIF                                                                 GLHXVD 373
          fScale = COS(ARG)                                                     GLHXVD 374
          DO  KK=1,24                                                           GLHXVD 375
            IH = 24 * (i-1) + KK                                                GLHXVD 376
            IF (fScale .GT. 0) THEN                                             GLHXVD 377
              <gl;Q_8760> =  fScale * <gl:DES-COOL-LOAD>/<gl;NUM_WELLS>         GLHXVD 378
            ELSE                                                                GLHXVD 379
              <gl;Q_8760> = -fScale * <gl:DES-HEAT-LOAD>/<gl;NUM_WELLS>         GLHXVD 380
            END IF                                                              GLHXVD 381
            qYear = qYear + <gl;Q_8760>                                         GLHXVD 382
          ENDDO                                                                 GLHXVD 383
        ENDDO                                                                   GLHXVD 384
      ELSE                                                                      GLHXVD 385
c              Assume the coil has just been installed                          GLHXVD 386
        DO  IH=1,8760                                                           GLHXVD 387
          <gl;Q_8760> = 0.                                                      GLHXVD 388
        ENDDO                                                                   GLHXVD 389
      ENDIF                                                                     GLHXVD 390
c              Save yearly heat                                                 GLHXVD 391
      <gl;Qyear> = qYear                                                        GLHXVD 392
c                                                                               GLHXVD 393
c              Determine gl;QaveragePast(iw)                                    GLHXVD 402
c              (Averaged Heat Inputs for period i)                              GLHXVD 403
      IW = 1                                                                    GLHXVD 404
      IH = 8760                                                                 GLHXVD 405
      <gl;QaveragePast> = <gl;Q_8760>                                           GLHXVD 406
      DO  IW=2,15                                                               GLHXVD 407
        IH1 = 8760 - iPnt(IW-1)                                                 GLHXVD 408
        IH2 = 8760 - (iPnt(IW) - 1)                                             GLHXVD 409
        <gl;QaveragePast> = 0                                                   GLHXVD 410
        DO  IH=IH2,IH1                                                          -041k    4
          <gl;QaveragePast> = <gl;QaveragePast>                                 GLHXVD 412
     &                      + <gl;Q_8760> / FLOAT(IH1-IH2 + 1)                  GLHXVD 413
        ENDDO                                                                   GLHXVD 414
      ENDDO                                                                     GLHXVD 415
c                                                                               GLHXVD 416
c              Set up fMult values used to update gl;Qaverage(iw) values        GLHXVD 417
      DO  IW=2,15                                                               GLHXVD 418
        <gl;fMult> = 1.0 / FLOAT(iPnt(IW) - iPnt(IW-1))                         GLHXVD 419
      ENDDO                                                                     GLHXVD 420
c                                                                               GLHXVD 421
      IF(<gl:ALGORITHM> .NE. 494) THEN                                          -044d   83
c              vertical well OLD algorithm                                      -044d   84
c              Equivalent pipe and film resistances (Kavanaugh)                 -044d   85
        Rp = ALOG (<gl:PIPE-OUT-DIA> / <gl:PIPE-IN-DIA>)                        -044d   86
     $                               / (2.0 * PI * <gl:PIPE-COND>)              -044d   87
        hf = 1.14 * ((<pe;DES_GPM> / <gl;NUM_WELLS>) ** 0.8)                    -044d   88
     $            / (<gl:PIPE-IN-DIA> ** 1.8)                                   -044d   89
        Rp = Rp + 1.0 / (PI * <gl:PIPE-IN-DIA> * hf)                            -044d   90
        Rp = Rp / (2.0 * 0.85)                                                  -044d   91
c              Heat transport capacity in piping                                -044d   92
        MCp = <lp;BTUH/GPM-F> * <pe;DES_GPM>                                    -044d   93
c              Define FACTOR term used to calculate leaving fluid temp          -044d   94
        ARG   = (<gl;NUM_WELLS> * <gl:DEPTH> / Rp) / MCp                        -044d   95
        Rf    = 8.0 / (3.0 * PI * <gl:PIPE-IN-DIA> * hf * <gl:DEPTH>)           -044d   96
        Rpw   = 4.0 * ALOG (<gl:PIPE-OUT-DIA> / <gl:PIPE-IN-DIA>)               -044d   97
     $              / (3.0 * PI * <gl:PIPE-COND> * <gl:DEPTH>)                  -044d   98
        THETA = 1.0 + <gl:UTUBE-LEG-SEP> / <gl:PIPE-IN-DIA>                     -044d   99
        Rsl   = ALOG(THETA + SQRT ( THETA * THETA - 1.0))                       -044d  100
     $               / (PI * <gl:GRND-COND> * <gl:DEPTH>)                       -044d  101
        Rsc   = 2.0 * Rf + 2.0 * Rpw + Rsl                                      -044d  102
        ARG   = 1.0 / (1.0 / ARG + <gl;NUM_WELLS>                               -044d  103
     $              / (2.0 * MCp * Rsc))                                        -044d  104
        <gl;FACTOR> = EXP(-ARG) / (1.0 - EXP(-ARG)) / MCp                       -044d  105
c                                                                               -044d  106
      ELSE                                                                      -044d  107
c           vertical well new algorithm                                         -044d  108
c           Convert parameters to SI unit                                       -044d  109
        Fluid_Flow = <pe;DES_GPM> / <gl;NUM_WELLS> * 3.78541 ! in l/min         -044d  110
        gl_k_ground   = <gl:GRND-COND>  * 1.7296 ! Ground TC in W/(m-C)         -044d  111
        gl_k_grout = <gl:GROUT-COND> * 1.7296    ! Grout  TC in W/(m-C)         -044d  112
        gl_k_pipe     = <gl:PIPE-COND>  * 1.7296 ! Tube wall TC W/(m-C)         -044d  113
        X_UTUBE    = <gl:UTUBE-LEG-SEP>  * 0.3048        ! in m                 -044d  114
        Pipe_Out_Dia = <gl:PIPE-OUT-DIA> * 0.3048        ! in m                 -044d  115
        Pipe_In_Dia  = <gl:PIPE-IN-DIA>  * 0.3048        ! in m                 -044d  116
        gl_Bore_Radius = <gl:BOREHOLE-DIAM>/(2.0*12.)*0.3048  ! in m            -044d  117
        gl_Bore_Depth = <gl:DEPTH> * 0.3048              ! in m                 -044d  118
        Avg_Loop_T = 20.                                 ! in C                 -044d  119
c                                                                               -044d  120
        CALL Borehole_Therm_Resis(Fluid_Flow,gl_k_ground,gl_k_grout,            -044d  121
     $       gl_k_pipe,X_UTUBE,Pipe_Out_Dia,Pipe_In_Dia,gl_Bore_Depth,          -044d  122
     $       gl_Bore_Radius,<gl:FLUID>,<gl:ANTI-FREEZE-C>,                      -044d  123
     $       Avg_Loop_T,RB)                                                     -044d  124
        <gl;FACTOR> = (RB * 1.7296) / (<gl;NUM_WELLS> * <gl:DEPTH>)             -044d  125
        <gl;Rborehole> = RB * 1.730735 ! (m-K)/W >> (HR-FT-F)/BTU               -044e5   2
      ENDIF                                                                     -044d  126
      RETURN                                                                    GLHXVD 438
c                                                                               GLHXVD 439
c              message formats                                                  GLHXVD 440
 9001 FORMAT(14X,8A4,' has a maximum flow smaller'                     /        -035    94
     &       14X,'than the loops minimum flow, and will never be used' /        -035    95
     &       14X,'by itself.'                                          )        -035    96
 9100 FORMAT(14X,'Ground-loop HX: ',8A4,                               /        GLHXVD 441
     &       14X,'on loop ',8A4,'is not needed.  No simulation will'   /        GLHXVD 442
     &       14X,'be performed.    '                                   )        GLHXVD 443
 9107 FORMAT(14X,'Plant equipment: ',8A4,' has a different'            /        GLHXVD 444
     &       14X,'pressure drop on loop: ',8A4,' than the'             /        GLHXVD 445
     &       14X,'other equipment.  This is unusual unless the loop'   /        GLHXVD 446
     &       14X,'uses flow meters or other dynamic flow control'      /        GLHXVD 447
     &       14X,'devices to allocate the flow on an hourly basis to'  /        GLHXVD 448
     &       14X,'the active equipment.'                               )        GLHXVD 449
c                                                                               GLHXVD 450
      END                                                                       GLHXVD 451
      SUBROUTINE INTERP(LNTTS,GFNC,NPAIRS,XI,G)                                 GLHXVa   2
c**********************************************************                     GLHXVa   3
c                                                                               GLHXVa   4
c  PURPOSE:    To interpolate or extrapolate data in GFILE                      GLHXVa   5
c              to find the correct g-function value for a                       GLHXVa   6
c              known value of the natural log of (T/T_Steady)                   GLHXVa   7
c                                                                               GLHXVa   8
c**********************************************************                     GLHXVa   9
c                                                                               GLHXVa  10
c  INPUT VARIABLES:                                                             GLHXVa  11
c                                                                               GLHXVa  12
c  LNTTS   LNTTS(I) holds the Ith value of LN(t/T_Steady).                      GLHXVa  13
c  GFNC    GFNC(I) holds the Ith value of the g-function                        GLHXVa  14
c          which is associated with LNTTS(I)                                    GLHXVa  15
c  NPAIRS  The number of pairs data in the file                                 GLHXVa  16
c  XI      The value of LN(t/T_Steady) that a g-function                        GLHXVa  17
c          needs to be found for                                                GLHXVa  18
c                                                                               GLHXVa  19
c  OUTPUT VARIABLES:                                                            GLHXVa  20
c                                                                               GLHXVa  21
c  G       The value of the g-function at XI; found by                          GLHXVa  22
c          either extrapolation or interpolation                                GLHXVa  23
c                                                                               GLHXVa  24
c**********************************************************                     GLHXVa  25
c                                                                               GLHXVa  26
c  DEVELOPER:          Chris L. Marshall                                        GLHXVa  27
c                      Jeffrey D. Spitler, Ph.D., P.E.                          GLHXVa  28
c                      Oklahoma State University                                GLHXVa  29
c                                                                               GLHXVa  30
c  DATE:               October 13, 1993                                         GLHXVa  31
c                                                                               GLHXVa  32
c**********************************************************                     GLHXVa  33
      IMPLICIT REAL (A-Z)                                                       GLHXVa  34
      DIMENSION LNTTS(27),GFNC(27)                                              GLHXVa  35
      INTEGER I,NPAIRS                                                          GLHXVa  36
c                                                                               GLHXVa  37
c The following IF loop determines the g-function for the case                  GLHXVa  38
c when XI is less than the first element of the LNTTS array.                    GLHXVa  39
c In this case, the g-function must be found by extrapolation.                  GLHXVa  40
c                                                                               GLHXVa  41
      IF (XI .LE. LNTTS(1)) THEN                                                GLHXVa  42
        G = ((XI-LNTTS(1))/(LNTTS(2)-LNTTS(1)))*(GFNC(2)-GFNC(1))               GLHXVa  43
     &       +GFNC(1)                                                           GLHXVa  44
        RETURN                                                                  GLHXVa  45
      ENDIF                                                                     GLHXVa  46
c                                                                               GLHXVa  47
c The following IF loop determines the g-function for the case                  GLHXVa  48
c when XI is greater than the last element of the LNTTS array.                  GLHXVa  49
c In this case, the g-function must be found by extrapolation.                  GLHXVa  50
c                                                                               GLHXVa  51
      IF (XI .GT. LNTTS(NPAIRS)) THEN                                           GLHXVa  52
        G = ((XI-LNTTS(NPAIRS))/(LNTTS(NPAIRS-1)-LNTTS(NPAIRS)))                GLHXVa  53
     &       *(GFNC(NPAIRS-1)-GFNC(NPAIRS))+GFNC(NPAIRS)                        GLHXVa  54
        RETURN                                                                  GLHXVa  55
      ENDIF                                                                     GLHXVa  56
c                                                                               GLHXVa  57
c The following DO loop is for the case when XI falls within                    GLHXVa  58
c the first and last elements of the LNTTS array, or is identically             GLHXVa  59
c equal to one of the LNTTS elements.  In this case the g-function              GLHXVa  60
c must be found by interpolation.                                               GLHXVa  61
c                                                                               GLHXVa  62
      DO I=2,NPAIRS                                                             GLHXVa  63
        IF (XI .EQ. LNTTS(I)) THEN                                              GLHXVa  64
          G = GFNC(I)                                                           GLHXVa  65
          RETURN                                                                GLHXVa  66
        ELSEIF (XI .LT. LNTTS(I) .AND. XI .GT. LNTTS(I-1)) THEN                 GLHXVa  67
          G = ((XI-LNTTS(I))/(LNTTS(I-1)-LNTTS(I)))*(GFNC(I-1)-GFNC(I))         GLHXVa  68
     &         +GFNC(I)                                                         GLHXVa  69
          RETURN                                                                GLHXVa  70
        ENDIF                                                                   GLHXVa  71
      ENDDO                                                                     GLHXVa  72
c                                                                               GLHXVa  73
      END                                                                       GLHXVa  74
c                                                                               GLHXVa  75
      SUBROUTINE Borehole_Therm_Resis(Fluid_Flow,k_ground,k_grout,              GLHXVb   2
     &           k_pipe,X_UTUBE,Pipe_Out_Dia,Pipe_In_Dia,                       GLHXVb   3
     &           Borehole_Depth,Borehole_Radius,IFluidType,                     GLHXVb   4
     &           AntiFrzConcen,ALP_T,RB_Eff)                                    GLHXVb   5
c******************************************************************             GLHXVb   6
c                                                                               GLHXVb   7
c  PURPOSE:       Calculates the thermal resistance of a vertical               GLHXVb   8
c                 borehole with single U-tube inserted into it.                 GLHXVb   9
c                                                                               GLHXVb  10
c******************************************************************             GLHXVb  11
c                                                                               GLHXVb  12
c  DEVELOPER:          Xiaobing Liu, Ph. D.                                     GLHXVb  13
c                      ClimateMaster, Ltd.                                      GLHXVb  14
c                                                                               GLHXVb  15
c  DATE:               July 13, 2005                                            GLHXVb  16
c                                                                               GLHXVb  17
c******************************************************************             GLHXVb  18
c              Required inputs for calculating borehole thermal                 GLHXVb  19
C              resistance                                                       GLHXVb  20
      REAL  k_ground, k_grout, k_pipe, k_fluid                                  GLHXVb  21
      REAL  NU, NU_Laminar, NU_TranTurb                                         GLHXVb  22
c                                                                               GLHXVb  23
      DATA PI / 3.1415927 /                                                     GLHXVb  24
c                                                                               GLHXVb  25
      ro = Pipe_Out_Dia / (2.0)                                                 GLHXVb  26
      ri = Pipe_In_Dia / 2.0                                                    GLHXVb  27
      di = 2.0 * ri                                                             GLHXVb  28
      rb1 = Borehole_Radius                                                     GLHXVb  29
c                                                                               GLHXVb  30
      ISECC = IFluidType                                                        GLHXVb  31
      CONCENT = AntiFrzConcen                                                   GLHXVb  32
      TEMP = ALP_T                                                              GLHXVb  33
c                                                                               GLHXVb  34
c              Fluid viscosity in kg/(m-s)                                      GLHXVb  35
      Visc_fluid = SECCVISC(CONCENT,TEMP,ISECC)                                 GLHXVb  36
c              Fluid density in kg/m^3                                          GLHXVb  37
      Rho_fluid = SECCDENS(CONCENT,TEMP,ISECC)                                  GLHXVb  38
c              Fluid heat capacity in J/(kg-C)                                  GLHXVb  39
      C_fluid = SECCSPHT(CONCENT,TEMP,ISECC)                                    GLHXVb  40
c              Fluid thermal conductance in W/(m-C)                             GLHXVb  41
      k_fluid = SECCCOND(CONCENT,TEMP,ISECC)                                    GLHXVb  42
c                                                                               GLHXVb  43
c              (1). Convection resistance                                       GLHXVb  44
      IF(Fluid_Flow.LE.0.1)THEN                                                 GLHXVb  45
        RCONV = 0.                                                              GLHXVb  46
      ELSE                                                                      GLHXVb  47
        Reynolds = (Pipe_In_Dia*((Fluid_Flow/(60 * 1000))                       GLHXVb  48
     $                /(((Pipe_In_Dia/2)**2)                                    GLHXVb  49
     $              *3.141593)))/(VisC_fluid/Rho_fluid)                         GLHXVb  50
        Prandtl = (C_fluid*Visc_fluid)/(k_fluid)                                GLHXVb  51
c                                                                               GLHXVb  52
c              Fanning friction factor for smooth pipes                         GLHXVb  53
c              (Hellstrom,1991)                                                 GLHXVb  54
        FrictionFactor=(1.58*LOG(Reynolds)-3.28)**(-2.0)                        GLHXVb  55
c              Nu number for laminar flow inside tubes                          GLHXVb  56
c              at constant heat rate condition                                  GLHXVb  57
        NU_Laminar = 4.36                                                       GLHXVb  58
c              GNIELINSKI correlation, which includes the transition            GLHXVb  59
c              and turbulent zone (Hellstrom,1991)                              GLHXVb  60
        NU_TranTurb = MAX(0.0,(FrictionFactor/2.0)*(Reynolds-1000.0)*           GLHXVb  61
     $              Prandtl/(1+12.7*(FrictionFactor/2.0)**0.5*                  GLHXVb  62
     $              (Prandtl**(2.0/3.0)-1.0)))                                  GLHXVb  63
c              "Smoothed" correlation for all regimes of flow                   GLHXVb  64
        NU = (NU_Laminar**2.0 + NU_TranTurb**2.0)**0.5                          GLHXVb  65
c                                                                               GLHXVb  66
        hci = NU * k_fluid / di                                                 GLHXVb  67
        RCONV = 1.0 / (2.0*PI*di*hci)                                           GLHXVb  68
      ENDIF                                                                     GLHXVb  69
c                                                                               GLHXVb  70
c              (2). Pipe wall thermal resistance                                GLHXVb  71
      RCOND = Log(ro / ri) / (2. * Pi * k_pipe)                                 GLHXVb  72
c                                                                               GLHXVb  73
c              (3). Borehole Resistance                                         GLHXVb  74
c              Center to center distance between two legs of a U-tube           GLHXVb  75
      X_UTUBE = X_UTUBE + Pipe_Out_Dia                                          GLHXVb  76
c                                                                               GLHXVb  77
      Beta  = 2. * Pi * k_grout * (RCONV + RCOND)                               GLHXVb  78
      Theta = (k_grout - k_ground) / (k_grout + k_ground)                       GLHXVb  79
      ARG_1 = ro ** 2 / X_UTUBE ** 2                                            GLHXVb  80
      ARG_2 = (1 + Beta) / (1 - Beta)                                           GLHXVb  81
      ARG_3 = 4. * Theta * (X_UTUBE / 2)**4                                     GLHXVb  82
     $        / (rb1**4 - (X_UTUBE / 2)**4)                                     GLHXVb  83
c                                                                               GLHXVb  84
c              Correction from 1st order multipoles                             GLHXVb  85
      IF (Abs(Theta) .gt. 0.000001) THEN                                        -045e    1
        C_Multipole = ARG_1 * (1 - ARG_3)**2 / (ARG_2 + ARG_1                   -045e    2
     $                * (1 + ARG_3**2 * rb1**4                                  -045e    3
     $                / (((X_UTUBE/2.)**4) * Theta)))                           -045e    4
      ELSE                                                                      -045e    5
        C_Multipole = ARG_1 / (ARG_2 + ARG_1)                                   -045e    6
      ENDIF                                                                     -045e    7
c                                                                               GLHXVb  89
c              Borehole Resistance (RB) using Multipole method                  GLHXVb  90
c              (1st order multipoles and for two symmetric pipes)               GLHXVb  91
      RB = (((Beta + Log(rb1/ro)                                                GLHXVb  92
     $     + Log(rb1 / X_UTUBE)                                                 GLHXVb  93
     $     + Theta * Log(rb1**4 / (rb1**4                                       GLHXVb  94
     $     - (X_UTUBE / 2)**4))) - C_Multipole)                                 GLHXVb  95
     $     / (2. * Pi * k_grout)) / 2.                                          GLHXVb  96
c                                                                               GLHXVb  97
c              Borehole Resistance (RA) using Multipole method                  GLHXVb  98
c              (1st order multipoles and for two asymmetric pipes)              GLHXVb  99
      ARG_4 = 4. * Theta * rb1**4 * (X_UTUBE / 2)**2                            GLHXVb 100
     $        / (rb1 ** 4 - (X_UTUBE / 2)**4)                                   GLHXVb 101
      ARG_5 = 2. * Theta * rb1**2 * ro**2                                       GLHXVb 102
     $        * (rb1**4 + (X_UTUBE/2)**4)                                       GLHXVb 103
     $        / (rb1**4 - (X_UTUBE/2)**4)**2                                    GLHXVb 104
c                                                                               GLHXVb 105
c              Correction from 1st order multipoles                             GLHXVb 106
      C_Multipole = ARG_1 * (1 + ARG_4)**2 / (ARG_2 - ARG_1 + ARG_5)            GLHXVb 107
c                                                                               GLHXVb 108
      RA = (Beta + Log(X_UTUBE / ro)                                            GLHXVb 109
     $     + Theta * Log((rb1**2 + (X_UTUBE/2)**2) / (rb1**2                    GLHXVb 110
     $     - (X_UTUBE/2)**2)) - C_Multipole)                                    GLHXVb 111
     $     / (Pi * k_grout)                                                     GLHXVb 112
c                                                                               GLHXVb 113
c              Effective borehole thermal resistance                            GLHXVb 114
c             (Uniform heat flux)                                               GLHXVb 115
      RB_UHX = RB + (1./3.) * (1. / RA) * (Borehole_Depth                       GLHXVb 116
     $         / (C_fluid * Fluid_Flow / 60.))**2                               GLHXVb 117
c                                                                               GLHXVb 118
c              Effective borehole thermal resistance                            GLHXVb 119
c             (Uniform borehole wall temperature)                               GLHXVb 120
      R12 = RB * RA / (RB - 0.25 * RA)                                          GLHXVb 121
      RB_UBWT = RB + (1./3.) * (1./R12) * (Borehole_Depth                       GLHXVb 122
     $         / (C_fluid*Fluid_Flow/60.))**2 + (1. / 12.) * (1./RB)            GLHXVb 123
     $         * (Borehole_Depth/(C_fluid*Fluid_Flow/60.))**2                   GLHXVb 124
c                                                                               GLHXVb 125
c                                                                               GLHXVb 126
      RB_Eff = 0.5 * (RB_UBWT + RB_UHX)                                         GLHXVb 127
c                                                                               GLHXVb 128
      RETURN                                                                    GLHXVb 129
      END                                                                       GLHXVb 130
C***********************************************************************        GLHXVc   2
C                                                                               GLHXVc   3
C   LIBRARY:        Secondary coolant property utilities                        GLHXVc   4
C                                                                               GLHXVc   5
C   DEVELOPER:      Muhammad Haider Khan                                        GLHXVc   6
c                                                                               GLHXVc   7
c   REVISED BY:     Xiaobing Liu, Ph. D.                                        GLHXVc   8
c                   ClimateMaster, Ltd.                                         GLHXVc   9
C                                                                               GLHXVc  10
C   REFERENCE:      (1) Khan,M.H., and Spitler, J.D., Thermophysical            GLHXVc  11
C                       Properties of Antifreeze Mixtures                       GLHXVc  12
c                   (2) Khan,M.H., Modeling, Simulation and                     GLHXVc  13
c                       optimization of Ground Source Heat Pump                 GLHXVc  14
C                       Systems, M.S. Thesis, November 2004.                    GLHXVc  15
C                                                                               GLHXVc  16
C   USAGE:          The library contains the following functions -              GLHXVc  17
C                                                                               GLHXVc  18
C   SECCVISC(CONCENT,TEMP,ISECC) Calc the dynamic viscosity (N/m**2.s)          GLHXVc  19
C   SECCCOND(CONCENT,TEMP,ISECC) Calc the Thermal conductivity (W/m.K)          GLHXVc  20
C   SECCDENS(CONCENT,TEMP,ISECC) Calc the density (kg/m**3)                     GLHXVc  21
C   SECCSPHT(CONCENT,TEMP,ISECC) Calc the specific heat (J/kg.K)                GLHXVc  22
C                                                                               GLHXVc  23
C                   All functions use an integer (ISECC) as their last          GLHXVc  24
C                   argument to select the fluid type. The fluids are:          GLHXVc  25
C                     ISECC   FLUID                                             GLHXVc  26
C                       0     Pure water                                        GLHXVc  27
C                       1     Propylene Glycol solution                         GLHXVc  28
C                       2     Ethylene Glycol solution                          GLHXVc  29
C                       3     Methyl Alcohol solution                           GLHXVc  30
C                       4     Ethyl Alcohol solution                            GLHXVc  31
C=======================================================================        GLHXVc  32
C                                                                               GLHXVc  33
      BLOCK DATA SCNDCOOL                                                       GLHXVc  34
C                                                                               GLHXVc  35
C***********************************************************************        GLHXVc  36
C *                                                                             GLHXVc  37
C * PURPOSE:  Contains data shared between functions in the library             GLHXVc  38
C *                                                                             GLHXVc  39
C***********************************************************************        GLHXVc  40
C * INPUTS                                                                      GLHXVc  41
C * ======                                                                      GLHXVc  42
C * N/A                                                                         GLHXVc  43
C *                                                                             GLHXVc  44
C * OUTPUT                                                                      GLHXVc  45
C * ======                                                                      GLHXVc  46
C * N/A                                                                         GLHXVc  47
C *                                                                             GLHXVc  48
C * VARIABLES                                                                   GLHXVc  49
C * =========                                                                   GLHXVc  50
C * NSECC       Parameter for number of secondary coolants                      GLHXVc  51
C * B,C,D,E     Arrays of coefficients for viscosity                            GLHXVc  52
C * B0          Arrays of coefficients for conductivity                         GLHXVc  53
C * BD          Arrays of coefficients for density                              GLHXVc  54
C * D0,D1,D2,D3 Arrays of coefficients for specific heat                        GLHXVc  55
C *                                                                             GLHXVc  56
C **********************************************************************        GLHXVc  57
C                                                                               GLHXVc  58
C              Number of fluids                                                 GLHXVc  59
      PARAMETER (NSECC = 4)                                                     GLHXVc  60
C              Arrays for viscosity coefficient data                            GLHXVc  61
      COMMON/COEFVISC/B(NSECC),C(NSECC),D(NSECC),E(NSECC)                       GLHXVc  62
C              Arrays for conductivity coefficient data                         GLHXVc  63
      COMMON/COEFCOND/B0(NSECC)                                                 GLHXVc  64
C              Arrays for density coefficient data                              GLHXVc  65
      COMMON/COEFDENS/BD(NSECC)                                                 GLHXVc  66
C              Arrays for specific heat coefficient data                        GLHXVc  67
      COMMON/COEFSPHT/D0(NSECC),D1(NSECC) ,D2(NSECC),D3(NSECC)                  GLHXVc  68
C              Viscosity coefficient data                                       GLHXVc  69
      DATA B/0,-0.46265918457,0.357050556,0.248253314/                          GLHXVc  70
      DATA C/0,3.7063275478,2.783367272,1.033876987/                            GLHXVc  71
      DATA D/1.40E-09,19.520789690,0.041380367,0.00097712/                      GLHXVc  72
      DATA E/0,0,1.008552041,1.937396423/                                       GLHXVc  73
C              Conductivity coefficient data                                    GLHXVc  74
      DATA B0/0.114010508,-0.497355166,0.193428424,0.269953496/                 GLHXVc  75
C              Density coefficient data                                         GLHXVc  76
      DATA BD/0.100712784,0.084211734,0.107165766,0.090924937/                  GLHXVc  77
C              Specific heat coefficient data                                   GLHXVc  78
      DATA D0/0.512566798,0.25408174,0.867040451,1.072637702/                   GLHXVc  79
      DATA D1/-0.003097081,-0.005879748,-0.063,-0.037433876/                    GLHXVc  80
      DATA D2/249.088,138.448,56.78139184,74.396/                               GLHXVc  81
      DATA D3/-0.000414405,-0.000824252,0.003086734,0.002727949/                GLHXVc  82
C                                                                               GLHXVc  83
      END                                                                       GLHXVc  84
      FUNCTION SECCVISC(CONCENT1,TEMP,ISECC)                                    GLHXVc  85
C***********************************************************************        GLHXVc  86
C *                                                                             GLHXVc  87
C * PURPOSE:  Calculate the dynamic viscosity of secondary coolants             GLHXVc  88
C *                                                                             GLHXVc  89
C***********************************************************************        GLHXVc  90
C * INPUTS                                                                      GLHXVc  91
C * ======                                                                      GLHXVc  92
C * CONCENT  : Wt concentration of Organic Compound (%)                         GLHXVc  93
C * TEMP     : Fluid temperature   (C)                                          GLHXVc  94
C * ISECC    : selected secondary coolant  (-)                                  GLHXVc  95
C *                                                                             GLHXVc  96
C * OUTPUT                                                                      GLHXVc  97
C * ======                                                                      GLHXVc  98
C * SECCVISC: Dynamic viscosity  (N/m**2.s or Pa.s)                             GLHXVc  99
C **********************************************************************        GLHXVc 100
      IMPLICIT REAL (A-Z)                                                       GLHXVc 101
      INTEGER NSECC                                                             GLHXVc 102
      PARAMETER (NSECC = 4)                                                     GLHXVc 103
      COMMON/COEFVISC/B(NSECC),C(NSECC),D(NSECC),E(NSECC)                       GLHXVc 104
C                                                                               GLHXVc 105
C              Arguments                                                        GLHXVc 106
      REAL CONCENT,CONCENT1, TEMP                                               GLHXVc 107
      INTEGER ISECC                                                             GLHXVc 108
C              Concentration of water                                           GLHXVc 109
      REAL CONCofWATER                                                          GLHXVc 110
C                                                                               GLHXVc 111
C    Clamp the concentration within 0-100 bounds                                GLHXVc 112
      IF(CONCENT1.GT.100.0)THEN                                                 GLHXVc 113
        CONCENT1 = 100.0                                                        GLHXVc 114
      ELSE IF(CONCENT1.LT.0.0)THEN                                              GLHXVc 115
        CONCENT1 = 0.0                                                          GLHXVc 116
      END IF                                                                    GLHXVc 117
C                                                                               GLHXVc 118
C              mass fraction of Organic Compound                                GLHXVc 119
      CONCENT = CONCENT1 / 100.0                                                GLHXVc 120
C              mass fraction of Water                                           GLHXVc 121
      CONCofWATER= Abs(1 - CONCENT)                                             GLHXVc 122
                                                                                GLHXVc 123
C              0% concentration of anti-freeze indicates water                  GLHXVc 124
      IF (CONCENT .EQ. 0) THEN                                                  GLHXVc 125
        ISECC = 0                                                               GLHXVc 126
      END IF                                                                    GLHXVc 127
                                                                                GLHXVc 128
C    Calculate Dynamic viscosity in N/m**2.s or Pa.s                            GLHXVc 129
      IF (ISECC .EQ. 0) THEN                                                    GLHXVc 130
C              if pure water Dynamic viscosity                                  GLHXVc 131
C              is being calculated ISECC is set to 0                            GLHXVc 132
      SECCVISC = muWater(TEMP)                                                  GLHXVc 133
      ELSE IF (ISECC .EQ. 1) THEN                                               GLHXVc 134
C              if Propylene glycol mixture Dynamic viscosity                    GLHXVc 135
C              is being calculated ISECC is set to 1                            GLHXVc 136
        SECCVISC = Exp(CONCofWATER * Log(muWater(TEMP))                         GLHXVc 137
     $             + CONCENT * Log(MuPrGl(TEMP))                                GLHXVc 138
     $             + D(ISECC) * (125 - TEMP) ** E(ISECC)                        GLHXVc 139
     $             * CONCofWATER * CONCENT)                                     GLHXVc 140
      ELSE IF (ISECC .EQ. 2) THEN                                               GLHXVc 141
C              if Ethylene glycol mixture Dynamic viscosity                     GLHXVc 142
C              is being calculated ISECC is set to 2                            GLHXVc 143
        SECCVISC = Exp(CONCofWATER * Log(muWater(TEMP))                         GLHXVc 144
     $             + CONCENT * Log(MuEtGl(TEMP))                                GLHXVc 145
     $             + CONCENT * CONCofWATER * B(ISECC)                           GLHXVc 146
     $             * (Abs(Log(muWater(TEMP))                                    GLHXVc 147
     $             - Log(MuEtGl(TEMP))))                                        GLHXVc 148
     $             + Log(1 + ((CONCENT * CONCofWATER)                           GLHXVc 149
     $             / (C(ISECC) * CONCofWATER ** 4                               GLHXVc 150
     $             + D(ISECC) * CONCENT ** 4))))                                GLHXVc 151
      ELSE IF (ISECC .EQ. 3) THEN                                               GLHXVc 152
C              if methyl alcohol mixture Dynamic viscosity                      GLHXVc 153
C              is being calculated ISECC is set to 3                            GLHXVc 154
        SECCVISC = Exp(CONCofWATER * Log(muWater(TEMP))                         GLHXVc 155
     $             + CONCENT * Log(MuMeoH(TEMP))                                GLHXVc 156
     $             + D(ISECC) * (70 - TEMP) ** E(ISECC)                         GLHXVc 157
     $             * CONCofWATER * CONCENT                                      GLHXVc 158
     $             + Log(1 + ((CONCENT * CONCofWATER)                           GLHXVc 159
     $             / (B(ISECC)* CONCofWATER ** 2                                GLHXVc 160
     $             + C(ISECC) * CONCENT ** 2))))                                GLHXVc 161
      ELSE IF (ISECC .EQ. 4) THEN                                               GLHXVc 162
C              if ethyl alcohol mixture Dynamic viscosity                       GLHXVc 163
C              is being calculated ISECC is set to 4                            GLHXVc 164
        SECCVISC = Exp(CONCofWATER * Log(muWater(TEMP))                         GLHXVc 165
     $             + CONCENT * Log(MuEtoH(TEMP))                                GLHXVc 166
     $             + D(ISECC) * (70 - TEMP) ** E(ISECC)                         GLHXVc 167
     $             * CONCofWATER * CONCENT                                      GLHXVc 168
     $             + Log(1 + ((CONCENT * CONCofWATER)                           GLHXVc 169
     $             / (B(ISECC)* CONCofWATER ** 2                                GLHXVc 170
     $             + C(ISECC) * CONCENT ** 2))))                                GLHXVc 171
      END IF                                                                    GLHXVc 172
C              CONVERT mPa.S to Pa.S                                            GLHXVc 173
      SECCVISC=SECCVISC*0.001                                                   GLHXVc 174
      RETURN                                                                    GLHXVc 175
      END                                                                       GLHXVc 176
      FUNCTION SECCCOND(CONCENT1,TEMP,ISECC)                                    GLHXVc 177
C***********************************************************************        GLHXVc 178
C *                                                                             GLHXVc 179
C * PURPOSE:  Calculate the Thermal conductivity of secondary coolants          GLHXVc 180
C *                                                                             GLHXVc 181
C***********************************************************************        GLHXVc 182
C * INPUTS                                                                      GLHXVc 183
C * ======                                                                      GLHXVc 184
C * CONCENT  : Wt concentration of Organic Compound (%)                         GLHXVc 185
C * TEMP     : Fluid temperature  (C)                                           GLHXVc 186
C * ISECC    : selected secondary coolant  (-)                                  GLHXVc 187
C *                                                                             GLHXVc 188
C * OUTPUT                                                                      GLHXVc 189
C * ======                                                                      GLHXVc 190
C * SECCCOND: Thermal conductivity   (W/m.K)                                    GLHXVc 191
C **********************************************************************        GLHXVc 192
C                                                                               GLHXVc 193
      IMPLICIT REAL (A-Z)                                                       GLHXVc 194
      INTEGER NSECC                                                             GLHXVc 195
      PARAMETER (NSECC = 4)                                                     GLHXVc 196
      COMMON/COEFCOND/B0(NSECC)                                                 GLHXVc 197
                                                                                GLHXVc 198
C              Arguments                                                        GLHXVc 199
      REAL CONCENT,CONCENT1, TEMP                                               GLHXVc 200
      INTEGER ISECC                                                             GLHXVc 201
C              Concentration of water                                           GLHXVc 202
      REAL CONCofWATER                                                          GLHXVc 203
C              Clamp the concentration within 0-100 bounds                      GLHXVc 204
      IF(CONCENT1.GT.100.0)THEN                                                 GLHXVc 205
        CONCENT1 = 100.0                                                        GLHXVc 206
      ELSE IF(CONCENT1.LT.0.0)THEN                                              GLHXVc 207
        CONCENT1 = 0.0                                                          GLHXVc 208
      END IF                                                                    GLHXVc 209
                                                                                GLHXVc 210
C                mass fraction of Organic Compound                              GLHXVc 211
      CONCENT = CONCENT1 / 100.0                                                GLHXVc 212
C                mass fraction of Water                                         GLHXVc 213
      CONCofWATER= Abs(1 - CONCENT)                                             GLHXVc 214
                                                                                GLHXVc 215
C                0% concentration of anti-freeze indicates water                GLHXVc 216
      IF (CONCENT .EQ. 0) THEN                                                  GLHXVc 217
        ISECC = 0                                                               GLHXVc 218
      END IF                                                                    GLHXVc 219
                                                                                GLHXVc 220
C              Calculate thermal conductivity in W/m.K.                         GLHXVc 221
      IF (ISECC .EQ. 0) THEN                                                    GLHXVc 222
C              pure water thermal conductivity                                  GLHXVc 223
C              is being calculated ISECC is set to 0                            GLHXVc 224
        SECCCOND = TCWater(TEMP)                                                GLHXVc 225
      ELSE IF (ISECC .EQ. 1) THEN                                               GLHXVc 226
C              if Propylene glycol mixture Thermal Conductivity                 GLHXVc 227
C              is being calculated ISECC is set to 1                            GLHXVc 228
        SECCCOND = (CONCofWATER * TCWater(TEMP) ** B0(ISECC)                    GLHXVc 229
     $             + CONCENT * TCPrGl(TEMP) ** B0(ISECC))                       GLHXVc 230
     $             ** (1 / B0(ISECC))                                           GLHXVc 231
      ELSE IF (ISECC .EQ. 2) THEN                                               GLHXVc 232
C              if Ethylene glycol mixture Thermal Conductivity                  GLHXVc 233
C              is being calculated ISECC is set to 2                            GLHXVc 234
        SECCCOND = (CONCofWATER * TCWater(TEMP) ** B0(ISECC)                    GLHXVc 235
     $             + CONCENT * TCEtGl(TEMP) ** B0(ISECC))                       GLHXVc 236
     $             ** (1 / B0(ISECC))                                           GLHXVc 237
      ELSE IF (ISECC .EQ. 3) THEN                                               GLHXVc 238
C              if methyl alcohol mixture Thermal Conductivity is                GLHXVc 239
C              being calculated ISECC is set to 3                               GLHXVc 240
        SECCCOND = (CONCofWATER * TCWater(TEMP) ** B0(ISECC)                    GLHXVc 241
     $             + CONCENT * TCMeoH(TEMP) ** B0(ISECC))                       GLHXVc 242
     $             ** (1 / B0(ISECC))                                           GLHXVc 243
      ELSE IF (ISECC .EQ. 4) THEN                                               GLHXVc 244
C              if ethyl alcohol mixture Thermal Conductivity is                 GLHXVc 245
C              being calculated ISECC is set to 4                               GLHXVc 246
        SECCCOND = (CONCofWATER * TCWater(TEMP) ** B0(ISECC)                    GLHXVc 247
     $             + CONCENT * TCEtoH(TEMP) ** B0(ISECC))                       GLHXVc 248
     $             ** (1 / B0(ISECC))                                           GLHXVc 249
      END IF                                                                    GLHXVc 250
      RETURN                                                                    GLHXVc 251
      END                                                                       GLHXVc 252
      FUNCTION SECCDENS(CONCENT1,TEMP,ISECC)                                    GLHXVc 253
C                                                                               GLHXVc 254
C***********************************************************************        GLHXVc 255
C *                                                                             GLHXVc 256
C * PURPOSE:  Calculate the density of secondary coolants                       GLHXVc 257
C *                                                                             GLHXVc 258
C***********************************************************************        GLHXVc 259
C * INPUTS                                                                      GLHXVc 260
C * ======                                                                      GLHXVc 261
C * CONCENT  : Wt concentration of Organic Compound (%)                         GLHXVc 262
C * TEMP     : Fluid temperature  (C)                                           GLHXVc 263
C * ISECC    : selected secondary coolant (-)                                   GLHXVc 264
C *                                                                             GLHXVc 265
C * OUTPUT                                                                      GLHXVc 266
C * ======                                                                      GLHXVc 267
C * SECCDENS: Density  (kg/m**3)                                                GLHXVc 268
C **********************************************************************        GLHXVc 269
C                                                                               GLHXVc 270
      IMPLICIT REAL (A-Z)                                                       GLHXVc 271
      INTEGER NSECC                                                             GLHXVc 272
      PARAMETER (NSECC = 4)                                                     GLHXVc 273
      COMMON/COEFDENS/BD(NSECC)                                                 GLHXVc 274
C              Arguments                                                        GLHXVc 275
      REAL CONCENT,CONCENT1, TEMP                                               GLHXVc 276
      INTEGER ISECC                                                             GLHXVc 277
C              Concentration of water                                           GLHXVc 278
      REAL CONCofWATER                                                          GLHXVc 279
C              Clamp the concentration within 0-100 bounds                      GLHXVc 280
      IF(CONCENT1.GT.100.0)THEN                                                 GLHXVc 281
        CONCENT1 = 100.0                                                        GLHXVc 282
      ELSE IF(CONCENT1.LT.0.0)THEN                                              GLHXVc 283
        CONCENT1 = 0.0                                                          GLHXVc 284
      END IF                                                                    GLHXVc 285
                                                                                GLHXVc 286
C              mass fraction of Organic Compound                                GLHXVc 287
      CONCENT = CONCENT1 / 100.0                                                GLHXVc 288
C              mass fraction of Water                                           GLHXVc 289
      CONCofWATER= Abs(1 - CONCENT)                                             GLHXVc 290
                                                                                GLHXVc 291
C              0% concentration of anti-freeze indicates water                  GLHXVc 292
      IF (CONCENT .EQ. 0) THEN                                                  GLHXVc 293
        ISECC = 0                                                               GLHXVc 294
      END IF                                                                    GLHXVc 295
                                                                                GLHXVc 296
C              Calculate Density in kg/m**3                                     GLHXVc 297
      IF (ISECC .EQ. 0) THEN                                                    GLHXVc 298
C              if pure water Density                                            GLHXVc 299
C              is being calculated ISECC is set to 0                            GLHXVc 300
        SECCDENS = densWater(TEMP)                                              GLHXVc 301
      ELSE IF (ISECC .EQ. 1) THEN                                               GLHXVc 302
C              if Propylene glycol mixture Density ISECC                        GLHXVc 303
C              is set to 1                                                      GLHXVc 304
        SECCDENS =  CONCofWATER * densWater(TEMP)+                              GLHXVc 305
     $              CONCENT * densPrGl(TEMP)                                    GLHXVc 306
     $              + BD(ISECC) * CONCofWATER * CONCENT                         GLHXVc 307
      ELSE IF (ISECC .EQ. 2) THEN                                               GLHXVc 308
C              if Ethylene glycol mixture Density ISECC                         GLHXVc 309
C              is set to 2                                                      GLHXVc 310
        SECCDENS =  CONCofWATER * densWater(TEMP)+                              GLHXVc 311
     $              CONCENT * densEtGl(TEMP)                                    GLHXVc 312
     $              + BD(ISECC) * CONCofWATER * CONCENT                         GLHXVc 313
      ELSE IF (ISECC .EQ. 3) THEN                                               GLHXVc 314
C              if Methyl alcohol mixture Density ISECC                          GLHXVc 315
C              is set to 3                                                      GLHXVc 316
        SECCDENS = CONCofWATER * densWater(TEMP) +                              GLHXVc 317
     $             CONCENT * densMeoH(TEMP)                                     GLHXVc 318
     $             + BD(ISECC) * CONCofWATER * CONCENT                          GLHXVc 319
      ELSE IF (ISECC .EQ. 4) THEN                                               GLHXVc 320
C              if Ethyl alcohol mixture Density ISECC                           GLHXVc 321
C              is set to 4                                                      GLHXVc 322
        SECCDENS =  CONCofWATER * densWater(TEMP) +                             GLHXVc 323
     $              CONCENT * densEtoH(TEMP)                                    GLHXVc 324
     $              + BD(ISECC) * CONCofWATER * CONCENT                         GLHXVc 325
      END IF                                                                    GLHXVc 326
C              Change from g/cm**3 to kg/m**3                                   GLHXVc 327
      SECCDENS = SECCDENS*1000.0                                                GLHXVc 328
      RETURN                                                                    GLHXVc 329
      END                                                                       GLHXVc 330
C                                                                               GLHXVc 331
C-----------------------------------------------------------------------        GLHXVc 332
C                                                                               GLHXVc 333
      FUNCTION SECCSPHT(CONCENT1,TEMP,ISECC)                                    GLHXVc 334
C                                                                               GLHXVc 335
C***********************************************************************        GLHXVc 336
C *                                                                             GLHXVc 337
C * PURPOSE:  Calculate the specific heat of secondary coolants                 GLHXVc 338
C *                                                                             GLHXVc 339
C***********************************************************************        GLHXVc 340
C * INPUTS                                                                      GLHXVc 341
C * ======                                                                      GLHXVc 342
C * CONCENT  : Wt concentration of Organic Compound (%)                         GLHXVc 343
C * TEMP     : Fluid temperature  (C)                                           GLHXVc 344
C * ISECC    : selected secondary coolant (-)                                   GLHXVc 345
C *                                                                             GLHXVc 346
C * OUTPUT                                                                      GLHXVc 347
C * ======                                                                      GLHXVc 348
C * SECCSPHT: specific heat  (J/kg.K)                                           GLHXVc 349
C *                                                                             GLHXVc 350
C * FUNCTION CALLS                                                              GLHXVc 351
C * ======                                                                      GLHXVc 352
C *       cpMeoH                                                                GLHXVc 353
C *       cpEtoH                                                                GLHXVc 354
C *       cpPrGl                                                                GLHXVc 355
C *       cpEtGl                                                                GLHXVc 356
C *       cpWater                                                               GLHXVc 357
C **********************************************************************        GLHXVc 358
C                                                                               GLHXVc 359
      IMPLICIT REAL (A-Z)                                                       GLHXVc 360
      INTEGER NSECC                                                             GLHXVc 361
      PARAMETER (NSECC = 4)                                                     GLHXVc 362
      COMMON/COEFSPHT/D0(NSECC),D1(NSECC),D2(NSECC),D3(NSECC)                   GLHXVc 363
C              Arguments                                                        GLHXVc 364
      REAL CONCENT,CONCENT1, TEMP                                               GLHXVc 365
      INTEGER ISECC                                                             GLHXVc 366
C              Concentration of water                                           GLHXVc 367
      REAL CONCofWATER                                                          GLHXVc 368
C              Clamp the concentration within 0-100 bounds                      GLHXVc 369
      IF(CONCENT1.GT.100.0)THEN                                                 GLHXVc 370
        CONCENT1 = 100.0                                                        GLHXVc 371
      ELSE IF(CONCENT1.LT.0.0)THEN                                              GLHXVc 372
        CONCENT1 = 0.0                                                          GLHXVc 373
      END IF                                                                    GLHXVc 374
C              mass fraction of Organic Compound                                GLHXVc 375
      CONCENT = CONCENT1 / 100.0                                                GLHXVc 376
C              mass fraction of Water                                           GLHXVc 377
      CONCofWATER= Abs(1 - CONCENT)                                             GLHXVc 378
C              0% concentration of anti-freeze indicates water                  GLHXVc 379
      IF (CONCENT .EQ. 0) THEN                                                  GLHXVc 380
        ISECC = 0                                                               GLHXVc 381
      END IF                                                                    GLHXVc 382
C              Calculate Specific Heat in J/kg.K                                GLHXVc 383
      IF (ISECC .EQ. 0) THEN                                                    GLHXVc 384
C              if pure water Specific Heat                                      GLHXVc 385
C              is being calculated ISECC is set to 0                            GLHXVc 386
        SECCSPHT = cpWater(TEMP)                                                GLHXVc 387
      ELSE IF (ISECC .EQ. 1) THEN                                               GLHXVc 388
C              if Propylene glycol mixture Specific Heat                        GLHXVc 389
C              ISECC is set to 1                                                GLHXVc 390
        SECCSPHT = (cpWater(TEMP) *CONCofWATER +cpPrGl(TEMP)*CONCENT)           GLHXVc 391
     $             * (1 + D0(ISECC) * CONCofWATER * CONCENT)                    GLHXVc 392
     $             + D1(ISECC) * (D2(ISECC) - TEMP)                             GLHXVc 393
     $             * CONCENT * CONCofWATER                                      GLHXVc 394
     $             + D3(ISECC) * (D2(ISECC) - TEMP)                             GLHXVc 395
      ELSE IF (ISECC .EQ. 2) THEN                                               GLHXVc 396
C              if Ethylene glycol mixture Specific Heat                         GLHXVc 397
C              ISECC is set to 2                                                GLHXVc 398
        SECCSPHT = (cpWater(TEMP) *CONCofWATER +cpEtGl(TEMP)*CONCENT)           GLHXVc 399
     $             * (1 + D0(ISECC) * CONCofWATER * CONCENT)                    GLHXVc 400
     $             + D1(ISECC) * (D2(ISECC) - TEMP)                             GLHXVc 401
     $             * CONCENT * CONCofWATER                                      GLHXVc 402
     $             + D3(ISECC) * (D2(ISECC) - TEMP)                             GLHXVc 403
      ELSE IF (ISECC .EQ. 3) THEN                                               GLHXVc 404
C              if methyl alcohol mixture Specific Heat                          GLHXVc 405
C              ISECC is set to 3                                                GLHXVc 406
        SECCSPHT = (cpWater(TEMP)*CONCofWATER + cpMeoH(TEMP)*CONCENT)           GLHXVc 407
     $             * (1 + D0(ISECC) * CONCofWATER * CONCENT)                    GLHXVc 408
     $             + D1(ISECC) * (D2(ISECC) - TEMP)                             GLHXVc 409
     $             * CONCENT * CONCofWATER                                      GLHXVc 410
     $             + D3(ISECC) * (D2(ISECC) - TEMP)                             GLHXVc 411
      ELSE IF (ISECC .EQ. 4) THEN                                               GLHXVc 412
C              if ethyl alcohol mixture Specific Heat                           GLHXVc 413
C              ISECC is set to 4                                                GLHXVc 414
        SECCSPHT = (cpWater(TEMP) *CONCofWATER +cpEtoH(TEMP)*CONCENT)           GLHXVc 415
     $             * (1 + D0(ISECC) * CONCofWATER * CONCENT)                    GLHXVc 416
     $             + D1(ISECC) * (D2(ISECC) - TEMP)                             GLHXVc 417
     $             * CONCENT * CONCofWATER                                      GLHXVc 418
     $             + D3(ISECC) * (D2(ISECC) - TEMP)                             GLHXVc 419
      END IF                                                                    GLHXVc 420
C      Change from KJ/kg.K to J/kg.K                                            GLHXVc 421
      SECCSPHT = SECCSPHT*1000.0                                                GLHXVc 422
      RETURN                                                                    GLHXVc 423
      END                                                                       GLHXVc 424
      Function TCWater(Tem )                                                    GLHXVc 425
C***********************************************************************        GLHXVc 426
C *                                                                             GLHXVc 427
C * PURPOSE:  Calculate the Thermal conductivity of pure water between          GLHXVc 428
C *           the temperature range of 230 to 400K.                             GLHXVc 429
C***********************************************************************        GLHXVc 430
C * INPUTS                                                                      GLHXVc 431
C * ======                                                                      GLHXVc 432
C * TEMP     : Fluid temperature (C)                                            GLHXVc 433
C *                                                                             GLHXVc 434
C * OUTPUT                                                                      GLHXVc 435
C * ======                                                                      GLHXVc 436
C * TCWater: Thermal Conductivity (W/m.K)                                       GLHXVc 437
C *                                                                             GLHXVc 438
C * Reference                                                                   GLHXVc 439
C * =========                                                                   GLHXVc 440
C *      Touloukian, Y. S., Liley, P.E., and Saxena, S.C., 1970.                GLHXVc 441
C *              Thermal Conductivity, non metallic liquids and gases,          GLHXVc 442
C *             thermophysical properties of matter,                            GLHXVc 443
C *              Vol 3, TPRC data series.IFI/Plenum, New York                   GLHXVc 444
C **********************************************************************        GLHXVc 445
C              the polynomial returns the value in (mW/cm.k)                    GLHXVc 446
C              Argument                                                         GLHXVc 447
      Real Tem                                                                  GLHXVc 448
      TCWater = (273.778 + 3.9 * (Tem+ 273.15)) * 0.004184                      GLHXVc 449
     $          * 0.1 !convert to (W/m.k)                                       GLHXVc 450
      RETURN                                                                    GLHXVc 451
      END                                                                       GLHXVc 452
      Function TCPrGl(Tem )                                                     GLHXVc 453
C***********************************************************************        GLHXVc 454
C *                                                                             GLHXVc 455
C * PURPOSE:  Calculate the Thermal conductivity of propylene glycol            GLHXVc 456
C *           between 253 to 400K.                                              GLHXVc 457
C***********************************************************************        GLHXVc 458
C * INPUTS                                                                      GLHXVc 459
C * ======                                                                      GLHXVc 460
C * TEMP     : Fluid temperature (C)                                            GLHXVc 461
C *                                                                             GLHXVc 462
C * OUTPUT                                                                      GLHXVc 463
C * ======                                                                      GLHXVc 464
C * TCPrGl: Thermal conductivity of propylene glycol (W/m.K)                    GLHXVc 465
C *                                                                             GLHXVc 466
C * Reference                                                                   GLHXVc 467
C * =========                                                                   GLHXVc 468
C *      Stephan, K., and Hildwein, H., 1987.                                   GLHXVc 469
C *            Recommended data of selected compounds and binary                GLHXVc 470
C *            mixtures.  DECHEMA,Chemistry Data Series, Vol IV, pt 1+2         GLHXVc 471
C **********************************************************************        GLHXVc 472
C                                                                               GLHXVc 473
C              Argument                                                         GLHXVc 474
      Real Tem                                                                  GLHXVc 475
C              the polynomial returns the value in (mW/m.k)                     GLHXVc 476
      TCPrGl = (0.0000006525 * (Tem+ 273.15) ** 3 - 0.0019245191                GLHXVc 477
     $         * (Tem+ 273.15) ** 2 + 0.8187420602 *                            GLHXVc 478
     $         (Tem+ 273.15) + 115.8385095349)                                  GLHXVc 479
     $         *0.001 !convert to (W/m.k)                                       GLHXVc 480
      RETURN                                                                    GLHXVc 481
      END                                                                       GLHXVc 482
      Function TCEtGl(Tem )                                                     GLHXVc 483
C***********************************************************************        GLHXVc 484
C *                                                                             GLHXVc 485
C * PURPOSE:  Calculate the Thermal conductivity of Ethylene glycol             GLHXVc 486
C *             between 250 to 400K.                                            GLHXVc 487
C***********************************************************************        GLHXVc 488
C * INPUTS                                                                      GLHXVc 489
C * ======                                                                      GLHXVc 490
C * TEMP     : Fluid temperature (C)                                            GLHXVc 491
C *                                                                             GLHXVc 492
C * OUTPUT                                                                      GLHXVc 493
C * ======                                                                      GLHXVc 494
C * TCEtGl: Thermal conductivity of Ethylene glycol (W/m.K)                     GLHXVc 495
C *                                                                             GLHXVc 496
C * Reference                                                                   GLHXVc 497
C * =========                                                                   GLHXVc 498
C *            Touloukian, Y. S., Liley, P.E., and Saxena, S.C., 1970.          GLHXVc 499
C *            Thermal Conductivity, non metallic liquids and gases,            GLHXVc 500
C *            thermophysical properties of matter,                             GLHXVc 501
C *            Vol 3, TPRC data series.IFI/Plenum, New York                     GLHXVc 502
C **********************************************************************        GLHXVc 503
C                                                                               GLHXVc 504
C              Argument                                                         GLHXVc 505
      Real Tem                                                                  GLHXVc 506
C              the polynomial returns the value in (mW/cm.k)                    GLHXVc 507
      TCEtGl = (519.442 + 0.32092 * (Tem+273.15)) * 0.004184                    GLHXVc 508
     $         * 0.1 !convert to (W/m.k)                                        GLHXVc 509
                                                                                GLHXVc 510
      RETURN                                                                    GLHXVc 511
      END                                                                       GLHXVc 512
      Function TCMeoH(Tem )                                                     GLHXVc 513
C***********************************************************************        GLHXVc 514
C *                                                                             GLHXVc 515
C * PURPOSE:  Calculate the Thermal conductivity of Methanol between            GLHXVc 516
C *           150-400K                                                          GLHXVc 517
C *                                                                             GLHXVc 518
C***********************************************************************        GLHXVc 519
C * INPUTS                                                                      GLHXVc 520
C * ======                                                                      GLHXVc 521
C * TEMP     : Fluid temperature  (C)                                           GLHXVc 522
C *                                                                             GLHXVc 523
C * OUTPUT                                                                      GLHXVc 524
C * ======                                                                      GLHXVc 525
C * TCMeoH: Thermal conductivity of Methanol (W/m.K)                            GLHXVc 526
C *                                                                             GLHXVc 527
C * Reference                                                                   GLHXVc 528
C * =========                                                                   GLHXVc 529
C *            Touloukian, Y. S., Liley, P.E., and Saxena, S.C., 1970.          GLHXVc 530
C *            Thermal Conductivity, non metallic liquids and gases,            GLHXVc 531
C *            thermophysical properties of matter,                             GLHXVc 532
C *            Vol 3, TPRC data series.IFI/Plenum, New York                     GLHXVc 533
C **********************************************************************        GLHXVc 534
C                                                                               GLHXVc 535
C              Argument                                                         GLHXVc 536
      Real Tem                                                                  GLHXVc 537
C              The polynomial returns the value in (mW/cm.k)                    GLHXVc 538
      TCMeoH = (687.314 - 0.680519 * (Tem+273.15)) * 0.004184                   GLHXVc 539
     $         * 0.1 !Convert to (W/m.k)                                        GLHXVc 540
      RETURN                                                                    GLHXVc 541
      END                                                                       GLHXVc 542
      Function TCEtoH(Tem )                                                     GLHXVc 543
C***********************************************************************        GLHXVc 544
C *                                                                             GLHXVc 545
C * PURPOSE:  Calculate the Thermal conductivity of Ethanol between             GLHXVc 546
C *           150-400K                                                          GLHXVc 547
C *                                                                             GLHXVc 548
C***********************************************************************        GLHXVc 549
C * INPUTS                                                                      GLHXVc 550
C * ======                                                                      GLHXVc 551
C * TEMP     : Fluid temperature  (C)                                           GLHXVc 552
C *                                                                             GLHXVc 553
C * OUTPUT                                                                      GLHXVc 554
C * ======                                                                      GLHXVc 555
C * TCEtoH   : Thermal conductivity of Ethanol  (W/m.K)                         GLHXVc 556
C *                                                                             GLHXVc 557
C * Reference                                                                   GLHXVc 558
C * =========                                                                   GLHXVc 559
C *      Touloukian, Y. S., Liley, P.E., and Saxena, S.C., 1970.                GLHXVc 560
C *            Thermal Conductivity, non metallic liquids and gases,            GLHXVc 561
C *            thermophysical properties of matter,                             GLHXVc 562
C *            Vol 3, TPRC data series.IFI/Plenum, New York                     GLHXVc 563
C **********************************************************************        GLHXVc 564
C              Argument                                                         GLHXVc 565
      Real Tem                                                                  GLHXVc 566
C              The polynomial returns the value in (mW/cm.k)                    GLHXVc 567
      TCEtoH = (609.512 - 0.70924 * (Tem+273.15)) * 0.004184                    GLHXVc 568
     $         * 0.1 !Convert to (W/m.k)                                        GLHXVc 569
      RETURN                                                                    GLHXVc 570
      END                                                                       GLHXVc 571
      Function densWater(Tem )                                                  GLHXVc 572
C***********************************************************************        GLHXVc 573
C *                                                                             GLHXVc 574
C * PURPOSE:  Calculate the Density of Water between the temperature            GLHXVc 575
C *             range -34 to 96C                                                GLHXVc 576
C *                                                                             GLHXVc 577
C***********************************************************************        GLHXVc 578
C * INPUTS                                                                      GLHXVc 579
C * ======                                                                      GLHXVc 580
C * TEMP     : Fluid temperature  (C)                                           GLHXVc 581
C *                                                                             GLHXVc 582
C * OUTPUT                                                                      GLHXVc 583
C * ======                                                                      GLHXVc 584
C * densWater: Density of Water  (kg/m3)                                        GLHXVc 585
C *                                                                             GLHXVc 586
C * Reference                                                                   GLHXVc 587
C * =========                                                                   GLHXVc 588
C *      D.E Hare and Sorensen (CHECK)                                          GLHXVc 589
C *      reference 2 missing                                                    GLHXVc 590
C **********************************************************************        GLHXVc 591
                                                                                GLHXVc 592
C              Argument                                                         GLHXVc 593
      REAL Tem                                                                  GLHXVc 594
C              if the temperature is less than 0 C then the following           GLHXVc 595
C               polynomial is used                                              GLHXVc 596
      If (Tem .LT. 0) Then                                                      GLHXVc 597
        densWater = 0.99986 + 0.0000669 * Tem                                   GLHXVc 598
     $              - 0.000008486 * Tem** 2 + 0.0000001518 * Tem**3             GLHXVc 599
     $              - 0.0000000069484 * Tem ** 4 - 0.00000000036449             GLHXVc 600
     $              * Tem**5 - 0.000000000007497 * Tem**6                       GLHXVc 601
C              if the temperature is greater than 0 C the following             GLHXVc 602
C               polynomial is used                                              GLHXVc 603
      Else                                                                      GLHXVc 604
        densWater = 0.0000000155 * Tem**3 - 0.0000058378 * Tem**2               GLHXVc 605
     $              + 0.0000108821 * Tem + 1.0000941648                         GLHXVc 606
      End If                                                                    GLHXVc 607
      RETURN                                                                    GLHXVc 608
      END                                                                       GLHXVc 609
      Function densPrGl(Tem )                                                   GLHXVc 610
C***********************************************************************        GLHXVc 611
C *                                                                             GLHXVc 612
C * PURPOSE:  Calculate the Density of Propylene glycol between the             GLHXVc 613
C *           temperature range 213 to 400K                                     GLHXVc 614
C***********************************************************************        GLHXVc 615
C * INPUTS                                                                      GLHXVc 616
C * ======                                                                      GLHXVc 617
C * TEMP     : Fluid temperature  (C)                                           GLHXVc 618
C *                                                                             GLHXVc 619
C * OUTPUT                                                                      GLHXVc 620
C * ======                                                                      GLHXVc 621
C * densPrGl: Density of Propylene glycol  (kg/m3)                              GLHXVc 622
C *                                                                             GLHXVc 623
C * Reference                                                                   GLHXVc 624
C * =========                                                                   GLHXVc 625
C *      Daubert, T.E., and Danner, R.P., 1989.                                 GLHXVc 626
C *            Physical and thermodynamic properties of pure                    GLHXVc 627
C *            chemicals: data compilation.                                     GLHXVc 628
C *            Hemisphere Pub. Corp, New York.                                  GLHXVc 629
C **********************************************************************        GLHXVc 630
C                                                                               GLHXVc 631
C              Argument                                                         GLHXVc 632
      Real Tem                                                                  GLHXVc 633
C              The polynomial returns the Density in kmol/m3                    GLHXVc 634
      densPrGl = (1.0923 / 0.26106**                                            -044e    1
     $          (1 + (1 - ((Tem+273.15) / 626))**0.20459) )                     GLHXVc 636
     $          * 76.095 * 0.001                                                GLHXVc 637
C               Convert to kg/m3 where 76.095 is the molecular                  GLHXVc 638
C               weight of proplylene glycol                                     GLHXVc 639
      RETURN                                                                    GLHXVc 640
      END                                                                       GLHXVc 641
      Function densEtGl(Tem )                                                   GLHXVc 642
C***********************************************************************        GLHXVc 643
C *                                                                             GLHXVc 644
C * PURPOSE:  Calculate the Density of Ethylene glycol between the              GLHXVc 645
C *           temperature range 200 to 400K                                     GLHXVc 646
C***********************************************************************        GLHXVc 647
C * INPUTS                                                                      GLHXVc 648
C * ======                                                                      GLHXVc 649
C * TEMP     : Fluid temperature  (C)                                           GLHXVc 650
C *                                                                             GLHXVc 651
C * OUTPUT                                                                      GLHXVc 652
C * ======                                                                      GLHXVc 653
C * densEtGl: Density of Ethylene glycol (kg/m3)                                GLHXVc 654
C *                                                                             GLHXVc 655
C * Reference                                                                   GLHXVc 656
C * =========                                                                   GLHXVc 657
C *              Daubert, T.E., and Danner, R.P., 1989.                         GLHXVc 658
C *            Physical and thermodynamic properties of pure                    GLHXVc 659
C *            chemicals: data compilation.                                     GLHXVc 660
C *            Hemisphere Pub. Corp, New York.                                  GLHXVc 661
C **********************************************************************        GLHXVc 662
C                                                                               GLHXVc 663
C              Argument                                                         GLHXVc 664
      Real Tem                                                                  GLHXVc 665
C              The polynomial returns the Density in kmol/m3                    GLHXVc 666
      densEtGl = (1.2342 / 0.27029 **                                           GLHXVc 667
     $           (1 + (1 - ((Tem+273.15) / 629))**0.21997))                     GLHXVc 668
     $           * 78.135 * 0.001                                               GLHXVc 669
C                 Convert to kg/m3 where 78.135 is the molecular weight         GLHXVc 670
C                 of Ethylene glycol                                            GLHXVc 671
      RETURN                                                                    GLHXVc 672
      END                                                                       GLHXVc 673
      Function densMeoH(Tem )                                                   GLHXVc 674
C***********************************************************************        GLHXVc 675
C *                                                                             GLHXVc 676
C * PURPOSE:  Calculate the Density of Methanol between the                     GLHXVc 677
C *           temperature range 175 to 400K                                     GLHXVc 678
C***********************************************************************        GLHXVc 679
C * INPUTS                                                                      GLHXVc 680
C * ======                                                                      GLHXVc 681
C * TEMP     : Fluid temperature (C)                                            GLHXVc 682
C *                                                                             GLHXVc 683
C * OUTPUT                                                                      GLHXVc 684
C * ======                                                                      GLHXVc 685
C * densMeoH: Density of Methanol  (kg/m3)                                      GLHXVc 686
C *                                                                             GLHXVc 687
C * Reference                                                                   GLHXVc 688
C * =========                                                                   GLHXVc 689
C *      Daubert, T.E., and Danner, R.P., 1989.                                 GLHXVc 690
C *            Physical and thermodynamic properties of pure                    GLHXVc 691
C *            chemicals: data compilation.                                     GLHXVc 692
C *            Hemisphere Pub. Corp, New York.                                  GLHXVc 693
C **********************************************************************        GLHXVc 694
C                                                                               GLHXVc 695
C              Argument                                                         GLHXVc 696
      Real Tem                                                                  GLHXVc 697
C              The polynomial returns the Density in kmol/m3                    GLHXVc 698
      densMeoH = (2.308 / 0.27192**                                             GLHXVc 699
     $           (1 + (1 - ((Tem+273.15) / 512.58))**0.2331))                   GLHXVc 700
     $           *32.042*0.001                                                  GLHXVc 701
C              Convert to kg/m3 32.042 molecular weight of Methanol             GLHXVc 702
      RETURN                                                                    GLHXVc 703
      END                                                                       GLHXVc 704
      Function densEtoH(Tem )                                                   GLHXVc 705
C***********************************************************************        GLHXVc 706
C *                                                                             GLHXVc 707
C * PURPOSE:  Calculate the Density of Ethanol between the                      GLHXVc 708
C *           temperature range 159-400K                                        GLHXVc 709
C***********************************************************************        GLHXVc 710
C * INPUTS                                                                      GLHXVc 711
C * ======                                                                      GLHXVc 712
C * TEMP     : Fluid temperature  (C)                                           GLHXVc 713
C *                                                                             GLHXVc 714
C * OUTPUT                                                                      GLHXVc 715
C * ======                                                                      GLHXVc 716
C * densEtoH: Density of Ethanol  (kg/m3)                                       GLHXVc 717
C *                                                                             GLHXVc 718
C * Reference                                                                   GLHXVc 719
C * =========                                                                   GLHXVc 720
C *      Daubert, T.E., and Danner, R.P., 1989.                                 GLHXVc 721
C *            Physical and thermodynamic properties of pure                    GLHXVc 722
C *             chemicals: data compilation.                                    GLHXVc 723
C *            Hemisphere Pub. Corp, New York.                                  GLHXVc 724
C **********************************************************************        GLHXVc 725
C            '159-400K                                                          GLHXVc 726
C              Argument                                                         GLHXVc 727
      Real Tem                                                                  GLHXVc 728
C              The polynomial returns the Density in kmol/m3                    GLHXVc 729
C              Convert to kg/m3 where 46.069 molecular weight Ethanol           GLHXVc 730
      densEtoH = (1.5223 / 0.26395**                                            GLHXVc 731
     $            (1 + (1 - ((Tem+273.15)/516.25))**0.2367))                    GLHXVc 732
     $            *46.069*0.001                                                 GLHXVc 733
      RETURN                                                                    GLHXVc 734
      END                                                                       GLHXVc 735
      Function cpWater(Tem )                                                    GLHXVc 736
C***********************************************************************        GLHXVc 737
C *                                                                             GLHXVc 738
C * PURPOSE:  Calculate the specific heat of pure Water in the                  GLHXVc 739
C *           temperature range of 236-400K                                     GLHXVc 740
C *                                                                             GLHXVc 741
C***********************************************************************        GLHXVc 742
C * INPUTS                                                                      GLHXVc 743
C * ======                                                                      GLHXVc 744
C * TEMP     : Fluid temperature  (C)                                           GLHXVc 745
C *                                                                             GLHXVc 746
C * OUTPUT                                                                      GLHXVc 747
C * ======                                                                      GLHXVc 748
C * cpWater:  specific heat of water  (kJ/kg.K)                                 GLHXVc 749
C *                                                                             GLHXVc 750
C * Reference                                                                   GLHXVc 751
C * =========                                                                   GLHXVc 752
C *      Touloukian, Y. S., and Makita, T., 1970.                               GLHXVc 753
C *            Specific heat, non metallic liquids and gases,                   GLHXVc 754
C *            thermophysical properties of matter,                             GLHXVc 755
C *            Vol 6, TPRC data series. IFI/Plenum, New York.                   GLHXVc 756
C *      Westh, P., and Hvidt, A., 1993.                                        GLHXVc 757
C *            Heat capacity of aqueous solutions of monohydric                 GLHXVc 758
C *            alcohols at subzero temperatures.                                GLHXVc 759
C *            Biophys. Chem. 46: 27-35.                                        GLHXVc 760
C **********************************************************************        GLHXVc 761
C                                                                               GLHXVc 762
C              Argument                                                         GLHXVc 763
      Real Tem                                                                  GLHXVc 764
C              if the temperature >0 use the following polynomial               GLHXVc 765
      If (Tem .GT. 0) Then                                                      GLHXVc 766
C              The polynomial returns the specific heat in Btu/lb. F            GLHXVc 767
         cpWater = (2.13974 - 0.00968137 * (Tem+273.15) +                       GLHXVc 768
     $             0.0000268536 * (Tem+273.15)**2                               GLHXVc 769
     $             - 0.0000000242139 * (Tem+273.15)**3 )                        GLHXVc 770
     $             * 4.184 !      Convert to kJ/kg.K                            GLHXVc 771
      Else                                                                      GLHXVc 772
C      if the temperature less than 0 use the following polynomial              GLHXVc 773
         cpWater = -0.0000001134 * Tem**5 - 0.0000084011 * Tem**4               GLHXVc 774
     $             - 0.0002459819 * Tem**3 - 0.0027076312 * Tem**2              GLHXVc 775
     $             - 0.0168617731 * Tem + 4.1942562129                          GLHXVc 776
      End If                                                                    GLHXVc 777
      RETURN                                                                    GLHXVc 778
      END                                                                       GLHXVc 779
      Function cpPrGl(Tem )                                                     GLHXVc 780
C***********************************************************************        GLHXVc 781
C *                                                                             GLHXVc 782
C * PURPOSE:  Calculate the specific heat of Propylene Glycol in the            GLHXVc 783
C *           temperature range of 213-400k                                     GLHXVc 784
C***********************************************************************        GLHXVc 785
C * INPUTS                                                                      GLHXVc 786
C * ======                                                                      GLHXVc 787
C * TEMP     : Fluid temperature  (C)                                           GLHXVc 788
C *                                                                             GLHXVc 789
C * OUTPUT                                                                      GLHXVc 790
C * ======                                                                      GLHXVc 791
C * cpPrGl: specific heat Propylene Glycol  (kJ/kg.K)                           GLHXVc 792
C *                                                                             GLHXVc 793
C * Reference                                                                   GLHXVc 794
C * =========                                                                   GLHXVc 795
C *      Daubert, T.E., and Danner, R.P., 1989.                                 GLHXVc 796
C *            Physical and thermodynamic properties of pure                    GLHXVc 797
C *            chemicals: data compilation.                                     GLHXVc 798
C *            Hemisphere Pub. Corp, New York.                                  GLHXVc 799
C **********************************************************************        GLHXVc 800
C        C                                                                      GLHXVc 801
C              Argument                                                         GLHXVc 802
      Real Tem                                                                  GLHXVc 803
C              The polynomial returns the specific heat in j/kmol.K             GLHXVc 804
      cpPrGl = (58080 + 445.2 * (Tem+273.15))                                   GLHXVc 805
     $         *0.0131415  * 0.001  !Convert to kJ/kg.K                         GLHXVc 806
               !0.0131415 is the molecular weight term (1/76.095)               GLHXVc 807
      RETURN                                                                    GLHXVc 808
      END                                                                       GLHXVc 809
      Function cpEtGl(Tem )                                                     GLHXVc 810
C***********************************************************************        GLHXVc 811
C *                                                                             GLHXVc 812
C * PURPOSE:  Calculate the specific heat of Ethylene Glycol in the             GLHXVc 813
C *           temperature range of 262-400K                                     GLHXVc 814
C***********************************************************************        GLHXVc 815
C * INPUTS                                                                      GLHXVc 816
C * ======                                                                      GLHXVc 817
C * TEMP     : Fluid temperature  (C)                                           GLHXVc 818
C *                                                                             GLHXVc 819
C * OUTPUT                                                                      GLHXVc 820
C * ======                                                                      GLHXVc 821
C * cpEtGl: specific heat  of Ethylene Glycol (kJ/kg.K)                         GLHXVc 822
C *                                                                             GLHXVc 823
C * Reference                                                                   GLHXVc 824
C * =========                                                                   GLHXVc 825
C *      Touloukian, Y. S., and Makita, T., 1970.                               GLHXVc 826
C *            Specific heat, non metallic liquids and gases,                   GLHXVc 827
C *            thermophysical properties of matter,                             GLHXVc 828
C *            Vol 6, TPRC data series. IFI/Plenum, New York.                   GLHXVc 829
C **********************************************************************        GLHXVc 830
C                                                                               GLHXVc 831
C              Argument                                                         GLHXVc 832
      Real Tem                                                                  GLHXVc 833
C              The polynomial returns the specific heat in Btu/lb. F            GLHXVc 834
      cpEtGl = (0.016884 + 0.00335083 * (Tem+273.15) - 0.000007224              GLHXVc 835
     $         *(Tem+273.15)**2 + 0.00000000761748                              GLHXVc 836
     $         * (Tem+273.15) ** 3) * 4.184 !Convert to kJ/kg.K                 GLHXVc 837
      RETURN                                                                    GLHXVc 838
      END                                                                       GLHXVc 839
      Function cpMeoH(Tem )                                                     GLHXVc 840
C***********************************************************************        GLHXVc 841
C *                                                                             GLHXVc 842
C * PURPOSE:  Calculate the specific heat of Methanol 239.15 to 400 K           GLHXVc 843
C *                                                                             GLHXVc 844
C***********************************************************************        GLHXVc 845
C * INPUTS                                                                      GLHXVc 846
C * ======                                                                      GLHXVc 847
C * TEMP     : Fluid temperature  (C)                                           GLHXVc 848
C *                                                                             GLHXVc 849
C * OUTPUT                                                                      GLHXVc 850
C * ======                                                                      GLHXVc 851
C * cpMeoH: specific heat (kJ/kg.K)                                             GLHXVc 852
C *                                                                             GLHXVc 853
C * Reference                                                                   GLHXVc 854
C * =========                                                                   GLHXVc 855
C *      Touloukian, Y. S., and Makita, T., 1970.                               GLHXVc 856
C *            Specific heat, non metallic liquids and gases,                   GLHXVc 857
C *            thermophysical properties of matter,                             GLHXVc 858
C *            Vol 6, TPRC data series. IFI/Plenum, New York.                   GLHXVc 859
C *      Westh, P., and Hvidt, A., 1993.                                        GLHXVc 860
C *            Heat capacity of aqueous solutions of monohydric alcohols        GLHXVc 861
C *            at subzero temperatures.                                         GLHXVc 862
C *            Biophys. Chem. 46: 27-35.                                        GLHXVc 863
C **********************************************************************        GLHXVc 864
C                                                                               GLHXVc 865
C              Argument                                                         GLHXVc 866
      Real Tem                                                                  GLHXVc 867
C              if the temperature is less than 20 C use the                     GLHXVc 868
C              following polynomial                                             GLHXVc 869
      If (Tem .LT. 20) Then                                                     GLHXVc 870
        cpMeoH = 0.000000679332 * (Tem+273.15) ** 3 - 0.000507395605            GLHXVc 871
     $           * (Tem+273.15) ** 2 + 0.130806587813                           GLHXVc 872
     $           * (Tem+273.15) - 9.271119425358                                GLHXVc 873
      Else                                                                      GLHXVc 874
C              use the following polynomial expression if the temperature       GLHXVc 875
C              is greater than 20C                                              GLHXVc 876
        cpMeoH = (0.582485 - 0.000375646 * (Tem+273.15)                         GLHXVc 877
     $           - 0.00000167844 * (Tem+273.15) ** 2                            GLHXVc 878
     $           + 0.0000000106214 * (Tem+273.15) ** 3 )                        GLHXVc 879
     $           * 4.184      !Convert to kJ/kg.K                               GLHXVc 880
      End If                                                                    GLHXVc 881
      RETURN                                                                    GLHXVc 882
      END                                                                       GLHXVc 883
      Function cpEtoH(Tem )                                                     GLHXVc 884
C***********************************************************************        GLHXVc 885
C *                                                                             GLHXVc 886
C * PURPOSE:  Calculate the specific heat of Methanol 241.15 to 400 K           GLHXVc 887
C *                                                                             GLHXVc 888
C***********************************************************************        GLHXVc 889
C * INPUTS                                                                      GLHXVc 890
C * ======                                                                      GLHXVc 891
C * TEMP     : Fluid temperature  (C)                                           GLHXVc 892
C *                                                                             GLHXVc 893
C * OUTPUT                                                                      GLHXVc 894
C * ======                                                                      GLHXVc 895
C * cpEtoH: specific heat  (J/kg.K)                                             GLHXVc 896
C *                                                                             GLHXVc 897
C * Reference                                                                   GLHXVc 898
C * =========                                                                   GLHXVc 899
C *      Stephan, K., and Hildwein, H., 1987.                                   GLHXVc 900
C *            Recommended data of selected compounds and binary                GLHXVc 901
C *            mixtures.  DECHEMA,Chemistry Data Series, Vol IV, pt1+2.         GLHXVc 902
C **********************************************************************        GLHXVc 903
                                                                                GLHXVc 904
C              Argument                                                         GLHXVc 905
      Real Tem                                                                  GLHXVc 906
C              Reduced temperature. Calculated by dividing the                  GLHXVc 907
C              temperature with critical temperature of 513.92                  GLHXVc 908
C              Polynomial gives the value of specific heat Kj/Kmol.K            GLHXVc 909
      cpEtoH=(8.3143*(11.7928-6.49805*((Tem+273.15)/513.92)                     GLHXVc 910
     $       -3.43888*((Tem+273.15)/513.92)**2                                  GLHXVc 911
     $       +33.9621*((Tem+273.15)/513.92)**3))/ 46.069                        GLHXVc 912
C             Convert to kJ/kg.K where 46.069 is the molecular                  GLHXVc 913
C             weight of Ethanol                                                 GLHXVc 914
      RETURN                                                                    GLHXVc 915
      END                                                                       GLHXVc 916
      REAL Function muWater(Tem )                                               GLHXVc 917
C***********************************************************************        GLHXVc 918
C *                                                                             GLHXVc 919
C * PURPOSE:  Calculate the Viscosity of pure water between the                 GLHXVc 920
C *           temperature range of -23 to 130C                                  GLHXVc 921
C***********************************************************************        GLHXVc 922
C * INPUTS                                                                      GLHXVc 923
C * ======                                                                      GLHXVc 924
C * TEMP     : Fluid temperature (C)                                            GLHXVc 925
C *                                                                             GLHXVc 926
C * OUTPUT                                                                      GLHXVc 927
C * ======                                                                      GLHXVc 928
C * muWater: Viscosity of pure water (CentiPoise)                               GLHXVc 929
C *                                                                             GLHXVc 930
C * Reference                                                                   GLHXVc 931
C * =========                                                                   GLHXVc 932
C *      Touloukian, Y. S., Saxena, S.C., and Hestermans, P., 1970.             GLHXVc 933
C *            Viscosity, thermophysical properties of matter,                  GLHXVc 934
C *            Vol 11,  TPRC data series. IFI/Plenum, New York.                 GLHXVc 935
C *      Halfpap, B. L., 1981.                                                  GLHXVc 936
C *            An investigation of some properties of supercooled               GLHXVc 937
C *            fluids using photon correlation spectroscopy.                    GLHXVc 938
C *            M.S. Thesis. Kansas State University. Manhattan, KS              GLHXVc 939
C **********************************************************************        GLHXVc 940
C                                                                               GLHXVc 941
C              Argument                                                         GLHXVc 942
      Real Tem                                                                  GLHXVc 943
      If (Tem .LT. 0) Then                                                      GLHXVc 944
C              Polynomial gives the value of Viscosity for                      GLHXVc 945
C              temperature less than 0C                                         GLHXVc 946
        muWater = -0.000192677 * Tem ** 3 - 0.001689785 * Tem**2                GLHXVc 947
     $            - 0.085518661 * Tem + 1.770253561                             GLHXVc 948
      Else                                                                      GLHXVc 949
C              Polynomial gives the value of Viscosity for temperature          GLHXVc 950
C              more than or equal to 0C                                         GLHXVc 951
        muWater = 0.02414 * 10 ** (247.8 / ((Tem+273.15) - 140))                GLHXVc 952
      End If                                                                    GLHXVc 953
      RETURN                                                                    GLHXVc 954
      END                                                                       GLHXVc 955
      REAL Function MuPrGl(Tem )                                                GLHXVc 956
C***********************************************************************        GLHXVc 957
C *                                                                             GLHXVc 958
C * PURPOSE:  Calculate the Viscosity of Propylene Glycol between               GLHXVc 959
C *                  the temperature range of 233-400K                          GLHXVc 960
C***********************************************************************        GLHXVc 961
C * INPUTS                                                                      GLHXVc 962
C * ======                                                                      GLHXVc 963
C * TEMP     : Fluid temperature  (C)                                           GLHXVc 964
C *                                                                             GLHXVc 965
C * OUTPUT                                                                      GLHXVc 966
C * ======                                                                      GLHXVc 967
C * MuPrGl: Viscosity of Propylene Glycol  (CentiPoise)                         GLHXVc 968
C *                                                                             GLHXVc 969
C * Reference                                                                   GLHXVc 970
C * =========                                                                   GLHXVc 971
C *      Daubert, T.E., and Danner, R.P., 1989.                                 GLHXVc 972
C *            Physical and thermodynamic properties of pure chemicals:         GLHXVc 973
C *            data compilation.                                                GLHXVc 974
C *            Hemisphere Pub. Corp, New York.                                  GLHXVc 975
                                                                                GLHXVc 976
C **********************************************************************        GLHXVc 977
C                                                                               GLHXVc 978
C              Argument                                                         GLHXVc 979
      Real Tem                                                                  GLHXVc 980
C              Polynomial gives the value of Viscosity in Centipoise            GLHXVc 981
      MuPrGl = (Exp(-293.07 + (17494 / (Tem+273.15))                            GLHXVc 982
     $         + 40.576 * Log((Tem+273.15))))* 1000.0                           GLHXVc 983
      RETURN                                                                    GLHXVc 984
      END                                                                       GLHXVc 985
      REAL Function MuEtGl(Tem )                                                GLHXVc 986
C***********************************************************************        GLHXVc 987
C *                                                                             GLHXVc 988
C * PURPOSE:  Calculate the Viscosity of Ethylene Glycol between                GLHXVc 989
C *           the temperature range of 200-400K                                 GLHXVc 990
C *                                                                             GLHXVc 991
C***********************************************************************        GLHXVc 992
C * INPUTS                                                                      GLHXVc 993
C * ======                                                                      GLHXVc 994
C * TEMP     : Fluid temperature  (C)                                           GLHXVc 995
C *                                                                             GLHXVc 996
C * OUTPUT                                                                      GLHXVc 997
C * ======                                                                      GLHXVc 998
C * MuEtGl: Viscosity of Ethylene Glycol  (CentiPoise)                          GLHXVc 999
C *                                                                             GLHXVc1000
C * Reference                                                                   GLHXVc1001
C * =========                                                                   GLHXVc1002
C *      Daubert, T.E., and Danner, R.P., 1989.                                 GLHXVc1003
C *            Physical and thermodynamic properties of pure chemicals:         GLHXVc1004
C *            data compilation.                                                GLHXVc1005
C *            Hemisphere Pub. Corp, New York.                                  GLHXVc1006
C **********************************************************************        GLHXVc1007
C                                                                               GLHXVc1008
C              Argument                                                         GLHXVc1009
      Real Tem                                                                  GLHXVc1010
C              Polynomial gives the value of  Viscosity in Centipoise           GLHXVc1011
      MuEtGl = (520.24 * Exp((1158.95 / ((Tem + 273.15)                         GLHXVc1012
     $         - 132.353)) - 3.32075 * ((Tem + 273.15) / 645.)                  GLHXVc1013
     $         ** (-0.07027))) * 0.001                                          GLHXVc1014
      RETURN                                                                    GLHXVc1015
      END                                                                       GLHXVc1016
      REAL Function MuMeoH(Tem )                                                GLHXVc1017
C***********************************************************************        GLHXVc1018
C *                                                                             GLHXVc1019
C * PURPOSE:  Calculate the Viscosity of Methanol between                       GLHXVc1020
C *           the temperature range of 230-375K                                 GLHXVc1021
C***********************************************************************        GLHXVc1022
C * INPUTS                                                                      GLHXVc1023
C * ======                                                                      GLHXVc1024
C * TEMP     : Fluid temperature   (C)                                          GLHXVc1025
C *                                                                             GLHXVc1026
C * OUTPUT                                                                      GLHXVc1027
C * ======                                                                      GLHXVc1028
C * MuMeoH: Viscosity of Methanol  (CentiPoise)                                 GLHXVc1029
C *                                                                             GLHXVc1030
C * Reference                                                                   GLHXVc1031
C * =========                                                                   GLHXVc1032
C *      Daubert, T.E., and Danner, R.P., 1989.                                 GLHXVc1033
C *            Physical and thermodynamic properties of pure chemicals:         GLHXVc1034
C *            data compilation.                                                GLHXVc1035
C *            Hemisphere Pub. Corp, New York.                                  GLHXVc1036
C **********************************************************************        GLHXVc1037
C                                                                               GLHXVc1038
C              Argument                                                         GLHXVc1039
      Real Tem                                                                  GLHXVc1040
C              Polynomial gives the value of  Viscosity in Centipoise           GLHXVc1041
      MuMeoH = (Exp(-7.288 + (1065.3 / (Tem+273.15))                            GLHXVc1042
     $         - 0.6657 * Log((Tem+273.15))))*1000.0                            GLHXVc1043
      RETURN                                                                    GLHXVc1044
      END                                                                       GLHXVc1045
      REAL Function MuEtoH(Tem )                                                GLHXVc1046
C***********************************************************************        GLHXVc1047
C *                                                                             GLHXVc1048
C * PURPOSE:  Calculate the Viscosity of Ethanol between                        GLHXVc1049
C *           the temperature range of 200-400K                                 GLHXVc1050
C *                                                                             GLHXVc1051
C***********************************************************************        GLHXVc1052
C * INPUTS                                                                      GLHXVc1053
C * ======                                                                      GLHXVc1054
C * TEMP     : Fluid temperature  (C)                                           GLHXVc1055
C *                                                                             GLHXVc1056
C * OUTPUT                                                                      GLHXVc1057
C * ======                                                                      GLHXVc1058
C * MuEtoH: Viscosity of Ethanol  (CentiPoise)                                  GLHXVc1059
C *                                                                             GLHXVc1060
C * Reference                                                                   GLHXVc1061
C * =========                                                                   GLHXVc1062
C *      Stephan, K., and Hildwein, H., 1987.                                   GLHXVc1063
C *            Recommended data of selected compounds and binary                GLHXVc1064
C *            mixtures.                                                        GLHXVc1065
C *            DECHEMA,Chemistry Data Series, Vol. IV, part. 1+2.               GLHXVc1066
                                                                                GLHXVc1067
C **********************************************************************        GLHXVc1068
C                                                                               GLHXVc1069
C              Argument                                                         GLHXVc1070
      Real Tem                                                                  GLHXVc1071
C              returns the value of viscosity in Centipoise                     GLHXVc1072
      MuEtoH=(69.8963*EXP((877.267/((Tem+273.15)-43.8958))                      GLHXVc1073
     $       -2.13138*((Tem+273.15)/513.92)**2.0094))*0.001                     GLHXVc1074
      RETURN                                                                    GLHXVc1075
      END                                                                       GLHXVc1076
c                                                                               GLHXVc1077
      FUNCTION GLHX_Exponential(Z)                                              GLHXVE   2
c                                                                               GLHXVE   3
c              Estimates the exponential integral function for                  GLHXVE   4
c              ground-loop heat-exchangers                                      GLHXVE   5
c                                                                               GLHXVE   6
c              z = Dimensionless term                                           GLHXVE   7
c                                                                               /JJHLIT/ 2
c              Original DOE-2 Ground HX models developed by                     -044d    1
c                            R. Merriam, Arthur D Little (617-498-5887)         /JJHLIT/ 4
c                            August 29, 1995                                    /JJHLIT/ 5
c                                                                               /JJHLIT/ 6
c              and IMPLEMENTATION BY                                            -044d    2
c                            S. D. Gates                                        /JJHLIT/ 8
c                            J. J. Hirsch                                       /JJHLIT/ 9
c                            James J. Hirsch & Associates                       /JJHLIT/10
c                            Camarillo, California                              /JJHLIT/11
c                                                                               /JJHLIT/12
Copyright (c) 1997 by James J. Hirsch. All Rights Reserved. Unpublished         /JJHLIT/13
c rights reserved under the Copyright Laws of the United States.                /JJHLIT/14
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHLIT/15
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHLIT/16
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHLIT/17
c                                                                               /JJHLIT/18
c                                                                               GLHXVE   9
      DATA PI / 3.1415927 /                                                     GLHXVE  10
c                                                                               GLHXVE  11
      IF (Z .EQ. 0.)  THEN                                                      GLHXVE  12
        GLHX_Exponential = 0.                                                   GLHXVE  13
      ELSE                                                                      GLHXVE  14
        x = 0.25 / z                                                            GLHXVE  15
        IF (x .LT. 1.0)  THEN                                                   GLHXVE  16
          E1X = - 0.57721 + x + x * x * (- 0.24991 + x * (0.05520               GLHXVE  17
     &                    + x * (-0.00976 + x * 0.00108))) - alog(x)            GLHXVE  18
        ELSE                                                                    GLHXVE  19
          E1X = (exp (-x) / x) * (x * x + 2.3347 * x + 0.25062) /(x * x         GLHXVE  20
     &                   + 3.33066 * x + 1.68153)                               GLHXVE  21
        ENDIF                                                                   GLHXVE  22
        GLHX_Exponential =  E1X / 4.0 / PI                                      GLHXVE  23
      ENDIF                                                                     GLHXVE  24
c                                                                               GLHXVE  25
      RETURN                                                                    GLHXVE  26
      END                                                                       GLHXVE  27
      SUBROUTINE HeatExchanger(Jhx,Mode,MaxFlag,Qhx,SupFlow,SupTi,SupTo,        HTEX     2
     &                                              DemFlow,DemTi,DemTo)        HTEX     3
c                                                                               HTEX     4
c              Simulates heat exchangers                                        HTEX     5
c                                                                               HTEX     6
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /HRVARS/ HRVars(15)                                               /HRVARS/ 2
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
c                                                                               HTEX    15
      COMMON  /HXKY  / Counterflow, Parallelflow, CrossflowNoMix,               /HXKY/   2
     &                 CrossflowBothMix, CrossflowDemMix,                       /HXKY/   3
     &                 CrossflowSupMix                                          /HXKY/   4
      INTEGER          Counterflow, Parallelflow, CrossflowNoMix,               /HXKY/   5
     &                 CrossflowBothMix, CrossflowDemMix,                       /HXKY/   6
     &                 CrossflowSupMix                                          /HXKY/   7
c                                                                               HTEX    17
      REAL    NTU, MaxErr                                                       HTEX    18
      INTEGER Config                                                            HTEX    19
c                                                                               HTEX    20
c              Jhx      Pointer to heat exchanger component                     HTEX    21
c              MaxFlag  Flag=1 indicates that a flow greater than               HTEX    22
c                       the design flow is required to meet the load            HTEX    23
c              Qhx      Heat transferred across HX                              HTEX    24
c              SupFlow  Supply side flow, cfm or gpm                            HTEX    25
c              SupTi    Supply side inlet temperature                           HTEX    26
c              SupTo    Supply side outlet temperature                          HTEX    27
c              DemFlow  Demand side flow, cfm or gpm                            HTEX    28
c              DemTi    Demand side inlet temperature                           HTEX    29
c              DemTo    Demand side outlet temperature                          HTEX    30
c                                                                               HTEX    31
c              Mode specifies the parameters to solve, given other data         HTEX    32
c                                                                               HTEX    33
c              Mode  Qhx  SupFlow  SupTi  SupTo  DemFlow  DemTi  DemTo          HTEX    34
c              ----  ---  -------  -----  -----  -------  -----  -----          HTEX    35
c                1  Solve  Given   Given   Solve  Given   Given  Solve          HTEX    36
c                2  Given  Solve   Given   Solve  Given   Given  -----          HTEX    37
c                3  Solve  Given   Given   -----  Solve   Given  Given          HTEX    38
c                4  Given  Given   Given   -----  Given   Solve  Solve          HTEX    39
c                5  Given  Given   Solve   Solve  Given   Given  -----          HTEX    40
c                                                                               HTEX    41
c              Mode = 1  Qhx      Heat transfer                                 HTEX    42
c                        SupTo    Supply outlet temp                            HTEX    43
c                        DemTo    Demand outlet temp                            HTEX    44
c                     2  SupFlow  Supply-side flow rate                         HTEX    45
c                        SupTo    Supply-side outlet temperature                HTEX    46
c                     3  Qhx      Maximum demand side load and flow             HTEX    47
c                        DemFlow                                                HTEX    48
c                     4  DemTi    Demand-side temperatures                      HTEX    49
c                        DemTo                                                  HTEX    50
c                     5  SupTi    Supply-side temperatures                      HTEX    51
c                        SupTo                                                  HTEX    52
c                                                                               HTEX    53
c                                                                               HTEX    59
      Config  = <hx:CONFIGURATION>                                              HTEX    60
      MaxErr  = <hx:MAX-ERROR>                                                  HTEX    61
      MaxFlag = 0                                                               HTEX    62
      Iter    = 0                                                               HTEX    63
      SELECT CASE (Mode)                                                        -045     6
      CASE (2)                                                                  -045     7
c              Check inputs for consistency                                     -045     8
        IF ((Qhx .gt. 0.  .and.  SupTi .ge. DemTi)  .or.                        -045     9
     &      (Qhx .lt. 0.  .and.  SupTi .le. DemTi))  THEN                       -045    10
          CALL MSGSIM(-1,II,II,II,II)                                           -045    11
          WRITE (IOUTPT,9101) (<hx:NAME>,II=1,8),                               -045    12
     &                        Mode, Qhx, SupTi, DemTi                           -045    13
          call MessageBox( NULL, 'HT-EXCH flow calc error -'                    -045    14
     &      //' ABORTING'//char(0),'HT-EXCH Errors'//char(0), MB_OK             -045    15
     &      + MB_ICONSTOP + MB_TASKMODAL )                                      -045    16
        ENDIF                                                                   -045    17
c              when calculating a flow, the first guess is the design flow      -045    18
        SupFlow = <hx:SUP-FLOW>                                                 -045    19
      CASE (3)                                                                  -045    20
c              Check inputs for consistency                                     -045    21
        IF ((SupTi .ge. DemTi  .and.  DemTo .le. DemTi)  .or.                   -045    22
     &      (SupTi .le. DemTi  .and.  DemTo .ge. DemTi))  THEN                  -045    23
          CALL MSGSIM(-1,II,II,II,II)                                           -045    24
          WRITE (IOUTPT,9102) (<hx:NAME>,II=1,8),                               -045    25
     &                        Mode, SupTi, DemTi, DemTo                         -045    26
          call MessageBox( NULL, 'HT-EXCH flow calc error -'                    -045    27
     &      //' ABORTING'//char(0),'HT-EXCH Errors'//char(0), MB_OK             -045    28
     &      + MB_ICONSTOP + MB_TASKMODAL )                                      -045    29
        ENDIF                                                                   -045    30
c              when calculating a flow, the first guess is the design flow      -045    31
        DemFlow = <hx:DEM-FLOW>                                                 -045    32
        Qhx     = 0.                                                            -045    33
      END SELECT                                                                -045    34
c                                                                               HTEX    70
c ****         run function : HeatExchanger-1                                   HTEX    71
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        HTEX    72
c                                                                               HTEX    73
c              Calculate the UA from the film resistances                       HTEX    74
c              supply side                                                      HTEX    75
   10 Rsup = <hx;SUP_FILM_r> *(SupFlow/<hx:SUP-FLOW>)**<hx:SUP-FILM-EXP>        HTEX    76
c              demand side                                                      HTEX    77
      Rdem = <hx;DEM_FILM_r> *(DemFlow/<hx:DEM-FLOW>)**<hx:DEM-FILM-EXP>        HTEX    78
c              total resistance                                                 HTEX    79
      Rtot = Rsup + <hx;HTX_r> + Rdem                                           HTEX    80
      UA   = 1. / Rtot                                                          HTEX    81
c                                                                               HTEX    82
c              fluid capacity rates                                             HTEX    83
      Csup = SupFlow * <hx;SUPPLY_cp>                                           HTEX    84
      Cdem = DemFlow * <hx;DEMAND_cp>                                           HTEX    85
c              minimum and maximum capacity rates                               HTEX    86
      Cmin = MIN(Csup, Cdem)                                                    HTEX    87
      Cmax = MAX(Csup, Cdem)                                                    HTEX    88
c              capacity ratio                                                   HTEX    89
      C    = Cmin / Cmax                                                        HTEX    90
c              number of transfer units                                         HTEX    91
      NTU = UA / Cmin                                                           HTEX    92
c                                                                               HTEX    93
c              effectiveness                                                    HTEX    94
      IF (C .GT. 1.E-6)  THEN                                                   HTEX    95
c              non-phase change hx                                              HTEX    96
        SELECT CASE (Config)                                                    HTEX    97
        CASE (1)                                                                HTEX    98
c              counterflow                                                      HTEX    99
          IF (C .LT. .9999)  THEN                                               HTEX   100
            x   = EXP(-NTU*(1.-C))                                              HTEX   101
            eff = (1.0 - x) / (1.0 - C*x)                                       HTEX   102
          ELSE                                                                  HTEX   103
            eff = NTU / (1.+NTU)                                                HTEX   104
          ENDIF                                                                 HTEX   105
        CASE (2)                                                                HTEX   106
c              parallel flow                                                    HTEX   107
          eff = (1.0 - EXP(-NTU*(1.+C))) / (1.0 + C)                            HTEX   108
        CASE (3)                                                                HTEX   109
c              crossflow with no mixing                                         HTEX   110
          x   = NTU**(-0.22)                                                    HTEX   111
          eff = 1. - EXP((EXP(-NTU*C*x)-1.)/(C*x))                              HTEX   112
        CASE (4)                                                                HTEX   113
c              crossflow with both streams mixed                                HTEX   114
          eff = 1. / (1./(1.-EXP(-NTU)) + C/(1.-EXP(-NTU*C)) - 1./NTU)          HTEX   115
        CASE (5)                                                                HTEX   116
c              crossflow with demand side mixed                                 HTEX   117
          IF (Cdem .EQ. Cmin)  THEN                                             HTEX   118
c              Cmin is mixed, Cmax is unmixed                                   HTEX   119
            eff = 1. - EXP(-(1.-EXP(-NTU*C)) / C)                               HTEX   120
          ELSE                                                                  HTEX   121
c              Cmin is unmixed, Cmax is mixed                                   HTEX   122
            eff = (1.-EXP(-C*(1.-EXP(-NTU)))) / C                               HTEX   123
          ENDIF                                                                 HTEX   124
        CASE (6)                                                                HTEX   125
c              crossflow with supply side mixed                                 HTEX   126
          IF (Csup .EQ. Cmin)  THEN                                             HTEX   127
c              Cmin is mixed, Cmax is unmixed                                   HTEX   128
            eff = 1. - EXP(-(1.-EXP(-NTU*C)) / C)                               HTEX   129
          ELSE                                                                  HTEX   130
c              Cmin is unmixed, Cmax is mixed                                   HTEX   131
            eff = (1.-EXP(-C*(1.-EXP(-NTU)))) / C                               HTEX   132
          ENDIF                                                                 HTEX   133
        CASE (7)                                                                HTEX   134
c              1-2 Parallel-Counterflow                                         HTEX   135
          y = (1.+C*C)**0.5                                                     HTEX   136
          x = -NTU*Y                                                            HTEX   137
          eff = 2. / (1.+C + y*(1.+EXP(x))/(1.-EXP(x)) )                        HTEX   138
        END SELECT                                                              HTEX   139
      ELSE                                                                      HTEX   140
c              phase change is occuring on one side                             HTEX   141
        eff = 1.0 - EXP(-NTU)                                                   HTEX   142
      ENDIF                                                                     HTEX   143
c                                                                               HTEX   144
c              heat transfer - negative Q means heating load                    HTEX   145
      QhxNew = eff * Cmin * (DemTi-SupTi)                                       HTEX   146
c                                                                               HTEX   147
c              Now find out what is needed                                      HTEX   148
      SELECT CASE (Mode)                                                        HTEX   149
      CASE (1)                                                                  HTEX   150
c              Mode 1 - Call is to get heat transfer and leaving temps          HTEX   151
        Qhx   = QhxNew                                                          HTEX   152
        SupTo = SupTi + Qhx/Csup                                                HTEX   153
        DemTo = DemTi - Qhx/Cdem                                                HTEX   154
        GOTO 1000                                                               HTEX   155
      CASE (2)                                                                  HTEX   156
c              Mode 2 - Calculate SupFlow and SupTo.                            HTEX   157
c              Check if maximum fluid capacity can meet load                    HTEX   158
        IF (Iter .EQ. 0  .AND.  ABS(QhxNew) .LT. ABS(Qhx))  THEN                HTEX   159
c              conditions can't be met given temperature constraints            HTEX   160
          MaxFlag = 1                                                           HTEX   161
        ENDIF                                                                   HTEX   162
        IF (ABS((QhxNew-Qhx)/Qhx) .GT. MaxErr)  THEN                            HTEX   163
          IF (Iter .LT. 100)  THEN                                              HTEX   164
c              solution not converged yet - make new estimate                   HTEX   165
            SupFlow = SupFlow * Qhx/QhxNew                                      HTEX   166
            Iter    = Iter + 1                                                  HTEX   167
            GOTO 10                                                             HTEX   168
          ELSE                                                                  HTEX   169
            GOTO 900                                                            HTEX   170
          ENDIF                                                                 HTEX   171
        ELSE                                                                    HTEX   172
c              solution achieved                                                HTEX   173
          SupTo   = SupTi + QhxNew/Csup                                         HTEX   174
          GOTO 1000                                                             HTEX   175
        ENDIF                                                                   HTEX   176
      CASE (3)                                                                  HTEX   177
c              Mode 3 - Determine demand-side load and flow given               HTEX   178
c              demand-side inlet and outlet temps.                              HTEX   179
c              Leaving temperature                                              HTEX   180
        Toutlet = DemTi - QhxNew/Cdem                                           HTEX   181
        IF (Abs((QhxNew-Qhx)/QhxNew) .gt. MaxErr) THEN                          -045    35
          Qhx = QhxNew                                                          -045    36
          IF (Iter .LT. 100)  THEN                                              HTEX   183
c              solution not converged yet - make new estimate                   HTEX   184
            DemFlow = DemFlow * (Toutlet-DemTi)/(DemTo-DemTi)                   HTEX   185
            Iter = Iter + 1                                                     HTEX   186
            GOTO 10                                                             HTEX   187
          ELSE                                                                  HTEX   188
            GOTO 900                                                            HTEX   189
          ENDIF                                                                 HTEX   190
        ELSE                                                                    HTEX   191
c              solution achieved                                                HTEX   192
          Qhx = QhxNew                                                          HTEX   193
          GOTO 1000                                                             HTEX   194
        ENDIF                                                                   HTEX   195
      CASE (4)                                                                  HTEX   196
c              Mode 4 - Determine demand-side inlet and outlet                  HTEX   197
c              temperatures when heat transfer is specified                     HTEX   198
        DemTi = SupTi + Qhx/(eff * Cmin)                                        HTEX   199
        DemTo = DemTi - Qhx/Cdem                                                HTEX   200
        GOTO 1000                                                               HTEX   201
      CASE (5)                                                                  HTEX   202
c              Mode 5 - Determine supply-side inlet and outlet                  HTEX   203
c              temperatures when heat transfer is specified                     HTEX   204
        SupTi = DemTi - Qhx/(eff * Cmin)                                        HTEX   205
        SupTo = SupTi + Qhx/Csup                                                HTEX   206
        GOTO 1000                                                               HTEX   207
      END SELECT                                                                HTEX   208
c                                                                               HTEX   209
c              convergence has failed                                           HTEX   210
  900 CALL MSGSIM(-1,II,II,II,II)                                               HTEX   211
      WRITE (IOUTPT, 9100)  (<hx:NAME>,II=1,8),IMO,IDAY,IHR,                    HTEX   212
     &                       Mode,Qhx,SupFlow,SupTi,SupTo,                      HTEX   213
     &                                DemFlow,DemTi,DemTo                       HTEX   214
      call MessageBox( NULL, 'HT-EXCH convergence error -'                      HTEX   215
     &  //' ABORTING'//char(0),'HT-EXCH Errors'//char(0), MB_OK                 HTEX   216
     &  + MB_ICONSTOP + MB_TASKMODAL )                                          HTEX   217
      RETURN                                                                    HTEX   219
c                                                                               HTEX   220
c                                                                               HTEX   221
 1000 CONTINUE                                                                  HTEX   222
c              report variables                                                 HTEX   223
c                                                                               HTEX   224
c ****         run function : HeatExchanger-2                                   HTEX   225
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        HTEX   226
c                                                                               HTEX   227
      <hx;LOAD> = Qhx                                                           HTEX   228
c                                                                               HTEX   229
c              hourly-report variables                                          HTEX   230
      IF (<hx;HREP> .NE. 0  .AND.  IRSCH .NE. 0)  THEN                          HTEX   231
c        CALL FILLN(0, HRVars(1), IVTLIM(2,17?)                                 HTEX   232
c        CALL HourRepPLT(EQUIPDAT(1), <hx;HREP>, 17?, 0)                        HTEX   233
      ENDIF                                                                     HTEX   234
c                                                                               HTEX   235
c              message formats                                                  HTEX   236
 9100 FORMAT(14X,'Heat-Exchanger: ',8A4,' calculations'                /        HTEX   237
     &       14X,'have failed to converge  MO/DY/HR: ',I2,'/',I2,'/',I2/        HTEX   238
     &       14X,'      Mode       Qhx   SupFlow     SupTi     SupTo'  /        HTEX   239
     &       14X,        I10,    F10.0,    F10.0,    F10.1,    F10.1   /        HTEX   240
     &       34X,'                       DemFlow     DemTi     DemTo'  /        HTEX   241
     &       34X,                          F10.0,    F10.1,    F10.1   )        HTEX   242
 9101 FORMAT(14X,'Heat-Exchanger: ',8A4,' has inconsistent'            /        ChlrHP 663
     &       14X,'input parameters for flow calculations'              /        ChlrHP 664
     &       14X,'      Mode       Qhx     SupTi     DemTi'            /        ChlrHP 665
     &       14X,        I10,    F10.0,    F10.0,    F10.1             )        ChlrHP 666
 9102 FORMAT(14X,'Heat-Exchanger: ',8A4,' has inconsistent'            /        -045    37
     &       14X,'input parameters for flow calculations'              /        -045    38
     &       14X,'      Mode     SupTi     DemTi     DemTo'            /        -045    39
     &       14X,        I10,    F10.2,    F10.2,    F10.2             )        -045    40
c                                                                               HTEX   243
      RETURN                                                                    HTEX   244
      END                                                                       HTEX   245
      SUBROUTINE HeatExchanger_Design(Jhx, Jsup, Jdem, QhxDesign,               HTEXd    2
     &                                SupFlow, SupCp, SupTi, SupdP,             HTEXd    3
     &                                DemFlow, DemCp, DemT1, DemdP)             -041b    1
c                                                                               HTEXd    5
c              Design calculations for a heat exchanger                         HTEXd    6
c                                                                               HTEXd    7
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
c                                                                               HTEXd   12
      COMMON  /HXKY  / Counterflow, Parallelflow, CrossflowNoMix,               /HXKY/   2
     &                 CrossflowBothMix, CrossflowDemMix,                       /HXKY/   3
     &                 CrossflowSupMix                                          /HXKY/   4
      INTEGER          Counterflow, Parallelflow, CrossflowNoMix,               /HXKY/   5
     &                 CrossflowBothMix, CrossflowDemMix,                       /HXKY/   6
     &                 CrossflowSupMix                                          /HXKY/   7
c                                                                               HTEXd   14
      REAL    NTU, MaxError                                                     HTEXd   15
      LOGICAL HeatingFlag                                                       HTEXd   16
      INTEGER Config                                                            HTEXd   17
c                                                                               HTEXd   18
c              Jhx        Pointer to heat-exchanger component                   HTEXd   19
c              Jsup       Pointer to supply-side component                      HTEXd   20
c              Jdem       Pointer to demand-side component                      HTEXd   21
c              QhxDesign  Required heat transfer, Btuh                          HTEXd   22
c              SupFlow    Supply-side flow, cfm or gpm                          HTEXd   23
c              SupCp      Supply-side heat capacity, Btu/(hr-F-flow)            HTEXd   24
c              SupTi      Supply-side inlet temperature                         HTEXd   25
c              SupdP      Supply-side pressure drop at design flow,             HTEXd   26
c                              ft head, inches static, or psia                  HTEXd   27
c              DemFlow    Demand-side flow, cfm or gpm                          HTEXd   28
c              DemCp      Demand-side heat capacity, Btu/(hr-F-flow)            HTEXd   29
c              DemTi      Demand-side inlet temperature                         HTEXd   30
c              DemdP      Demand-side pressure drop at design flow              HTEXd   31
c                              ft head, inches static, or psia                  HTEXd   32
c                                                                               HTEXd   33
c              SupCp and DemCp include the units of flow (cfm, gpm, etc.)       HTEXd   34
c              so that the hourly algorithm can be passed the supply-side       HTEXd   35
c              and demand-side flow in actual units of cfm, gpm, etc.           HTEXd   36
c                                                                               HTEXd   37
c                                                                               HTEXd   43
      Config   = <hx:CONFIGURATION>                                             HTEXd   44
      MaxError = <hx:MAX-ERROR> * .10                                           HTEXd   45
      Iter     = 0                                                              HTEXd   46
      IF (QhxDesign .GT. 0.)  THEN                                              HTEXd   47
        HeatingFlag = .FALSE.                                                   HTEXd   48
      ELSE                                                                      HTEXd   49
        HeatingFlag = .TRUE.                                                    HTEXd   50
      ENDIF                                                                     HTEXd   51
c              override defaults specified by calling routine if user           HTEXd   52
c              specified                                                        HTEXd   53
      IF (<hx:CAP> .NE. 0.)  THEN                                               HTEXd   54
c              check if specified capacity is close to requested capacity       HTEXd   55
        IF (ABS(<hx:CAP>/QhxDesign)  .LT. 0.85)  THEN                           HTEXd   56
          CALL MSGSIM(-3,II,II,II,II)                                           HTEXd   57
          WRITE (IOUTPT,9103)  (<hx:NAME>,II=1,8),                              HTEXd   58
     &                          QhxDesign,<hx:CAP>                              HTEXd   59
        ENDIF                                                                   HTEXd   60
        QhxDesign = <hx:CAP>                                                    HTEXd   61
        IF (HeatingFlag)  QhxDesign = -ABS(QhxDesign)                           HTEXd   62
      ENDIF                                                                     HTEXd   63
      IF (<hx:INLETS-DT> .NE. 0)  THEN                                          HTEXd   64
        dTinlets = <hx:INLETS-DT>                                               HTEXd   65
        dTinlets = <hx:INLETS-DT>                                               -041b    2
        IF (HeatingFlag)  dTinlets = -ABS(dTinlets)                             -041b    3
        DemTi = SupTi + dTinlets                                                -041b    4
      ELSE                                                                      HTEXd   66
        DemTi    = DemT1                                                        -041b    5
        dTinlets = DemTi - SupTi                                                HTEXd   67
      ENDIF                                                                     HTEXd   68
      IF (<hx:UA>  .NE. 0.)  THEN                                               ChlrHP 667
        UA = <hx:UA>                                                            ChlrHP 668
        GOTO 1000                                                               ChlrHP 669
      ENDIF                                                                     ChlrHP 670
c                                                                               ChlrHP 671
c              Calculate HX UA, checking for consistency                        ChlrHP 672
      Csup  = SupFlow * SupCp                    ! min capacity rate            ChlrHP 673
      Cdem  = DemFlow * DemCp                    ! max capacity rate            ChlrHP 674
      SupTo = SupTi + QhxDesign/Csup             ! leaving supply T             ChlrHP 675
      DemTo = DemTi - QhxDesign/Cdem             ! leaving demand T             ChlrHP 676
      IF (HeatingFlag)  THEN                                                    ChlrHP 677
        IF (SupTo .LT. DemTi+1.)  THEN                                          ChlrHP 678
          Call DesignError                                                      -048    52
          RETURN                                                                ChlrHP 680
        ENDIF                                                                   ChlrHP 681
        IF (DemTo .GT. SupTi-1.)  THEN                                          ChlrHP 682
          Call DesignError                                                      -048    53
          RETURN                                                                ChlrHP 684
        ENDIF                                                                   ChlrHP 685
      ELSE                                                                      ChlrHP 686
        IF (SupTo .GT. DemTi-1.)  THEN                                          ChlrHP 687
          Call DesignError                                                      -048    54
          RETURN                                                                ChlrHP 689
        ENDIF                                                                   ChlrHP 690
        IF (DemTo .LT. SupTi+1.)  THEN                                          ChlrHP 691
          Call DesignError                                                      -048    55
          RETURN                                                                ChlrHP 693
        ENDIF                                                                   ChlrHP 694
      ENDIF                                                                     ChlrHP 695
      UA    = QhxDesign/dTinlets                 ! ideal UA                     ChlrHP 696
      IF (UA .LT. 0.)  THEN                                                     ChlrHP 697
        Call DesignError                                                        -048    56
        RETURN                                                                  ChlrHP 699
      ENDIF                                                                     ChlrHP 700
      Cmin = MIN(Csup, Cdem)                                                    ChlrHP 701
      Cmax = MAX(Csup, Cdem)                                                    ChlrHP 702
      C    = Cmin / Cmax                         ! capacity ratio               ChlrHP 703
c                                                                               HTEXd   97
c              number of transfer units                                         HTEXd   98
   10 NTU = UA / Cmin                                                           HTEXd   99
c              effectiveness                                                    HTEXd  100
      IF (C .GT. 1.E-6)  THEN                                                   HTEXd  101
c              non-phase change hx                                              HTEXd  102
        SELECT CASE (Config)                                                    HTEXd  103
        CASE (1)                                                                HTEXd  104
c              counterflow                                                      HTEXd  105
          IF (C .LT. .9999)  THEN                                               HTEXd  106
            x   = EXP(-NTU*(1.-C))                                              HTEXd  107
            eff = (1.0 - x) / (1.0 - C*x)                                       HTEXd  108
          ELSE                                                                  HTEXd  109
            eff = NTU / (1.+NTU)                                                HTEXd  110
          ENDIF                                                                 HTEXd  111
        CASE (2)                                                                HTEXd  112
c              parallel flow                                                    HTEXd  113
          eff = (1.0 - EXP(-NTU*(1.+C))) / (1.0 + C)                            HTEXd  114
        CASE (3)                                                                HTEXd  115
c              crossflow with no mixing                                         HTEXd  116
          x   = NTU**(-0.22)                                                    HTEXd  117
          eff = 1. - EXP((EXP(-NTU*C*x)-1.)/(C*x))                              HTEXd  118
        CASE (4)                                                                HTEXd  119
c              crossflow with both streams mixed                                HTEXd  120
          eff = 1. / (1./(1.-EXP(-NTU)) + C/(1.-EXP(-NTU*C)) - 1./NTU)          HTEXd  121
        CASE (5)                                                                HTEXd  122
c              crossflow with demand side mixed                                 HTEXd  123
          IF (Cdem .EQ. Cmin)  THEN                                             HTEXd  124
c              Cmin is mixed, Cmax is unmixed                                   HTEXd  125
            eff = 1. - EXP(-(1.-EXP(-NTU*C)) / C)                               HTEXd  126
          ELSE                                                                  HTEXd  127
c              Cmin is unmixed, Cmax is mixed                                   HTEXd  128
            eff = (1.-EXP(-C*(1.-EXP(-NTU)))) / C                               HTEXd  129
          ENDIF                                                                 HTEXd  130
        CASE (6)                                                                HTEXd  131
c              crossflow with supply side mixed                                 HTEXd  132
          IF (Csup .EQ. Cmin)  THEN                                             HTEXd  133
c              Cmin is mixed, Cmax is unmixed                                   HTEXd  134
            eff = 1. - EXP(-(1.-EXP(-NTU*C)) / C)                               HTEXd  135
          ELSE                                                                  HTEXd  136
c              Cmin is unmixed, Cmax is mixed                                   HTEXd  137
            eff = (1.-EXP(-C*(1.-EXP(-NTU)))) / C                               HTEXd  138
          ENDIF                                                                 HTEXd  139
        CASE (7)                                                                HTEXd  140
c              1-2 Parallel-Counterflow                                         HTEXd  141
          y = (1.+C*C)**0.5                                                     HTEXd  142
          x = -NTU*Y                                                            HTEXd  143
          eff = 2. / (1.+C + y*(1.+EXP(x))/(1.-EXP(x)) )                        HTEXd  144
        END SELECT                                                              HTEXd  145
      ELSE                                                                      HTEXd  146
c              phase change is occuring on one side                             HTEXd  147
        eff = 1.0 - EXP(-NTU)                                                   HTEXd  148
      ENDIF                                                                     HTEXd  149
c                                                                               HTEXd  150
c              heat transfer for this size hx                                   HTEXd  151
      Qhx = eff * Cmin * dTinlets                                               HTEXd  152
c              see if converged on UA                                           HTEXd  153
      IF (ABS((Qhx-QhxDesign)/QhxDesign) .GT. MaxError)  THEN                   HTEXd  154
        IF (Iter .LT. 100)  THEN                                                HTEXd  155
c              solution not converged yet - make new estimate                   HTEXd  156
          UA   = UA * QhxDesign/Qhx                                             HTEXd  157
          Iter = Iter + 1                                                       HTEXd  158
          GOTO 10                                                               HTEXd  159
        ELSE                                                                    HTEXd  160
c              convergence has failed after 100 iterations                      HTEXd  161
          CALL MSGSIM(-1,II,II,II,II)                                           HTEXd  162
          WRITE (IOUTPT, 9100)  (<hx:NAME>,II=1,8)                              HTEXd  163
          call MessageBox( NULL, 'HT-EXCH convergence error -'                  HTEXd  164
     &      //' ABORTING'//char(0),'HT-EXCHD Errors'//char(0), MB_OK            HTEXd  165
     &      + MB_ICONSTOP + MB_TASKMODAL )                                      HTEXd  166
          RETURN                                                                HTEXd  168
        ENDIF                                                                   HTEXd  169
      ENDIF                                                                     HTEXd  170
c                                                                               HTEXd  171
c              Break down UA into its components                                HTEXd  172
 1000 Resistance = 1. / UA                                                      HTEXd  173
      <hx;SUP_FILM_r> = Resistance * <hx:SUP-FILM-RES>                          HTEXd  174
      <hx;DEM_FILM_r> = Resistance * <hx:DEM-FILM-RES>                          HTEXd  175
      <hx;HTX_r>      = Resistance - (<hx;SUP_FILM_r>+<hx;DEM_FILM_r>)          HTEXd  176
c              check resistances for consistency                                HTEXd  177
      IF (<hx;HTX_r> .LT. 0.)  THEN                                             HTEXd  178
        CALL MSGSIM(-1,II,II,II,II)                                             HTEXd  179
        WRITE (IOUTPT, 9102)  (<hx:NAME>,II=1,8)                                HTEXd  180
        call MessageBox( NULL, 'HT-EXCH design error -'                         HTEXd  181
     &    //' ABORTING'//char(0),'HT-EXCHD Errors'//char(0), MB_OK              HTEXd  182
     &    + MB_ICONSTOP + MB_TASKMODAL )                                        HTEXd  183
        RETURN                                                                  HTEXd  185
      ENDIF                                                                     HTEXd  186
c              make film resistance coefs negative for faster                   HTEXd  187
c              hourly computation (can multiply instead of divide)              HTEXd  188
      <hx:SUP-FILM-EXP> = -<hx:SUP-FILM-EXP>                                    HTEXd  189
      <hx:DEM-FILM-EXP> = -<hx:DEM-FILM-EXP>                                    HTEXd  190
c                                                                               HTEXd  191
c              STORE DESIGN VARIABLES                                           HTEXd  192
      <hx:CAP> = QhxDesign                                                      HTEXd  193
      <hx:UA>  = UA                                                             HTEXd  194
      <hx:INLETS-DT> = dTinlets                                                 HTEXd  195
      <hx;SUP_ATTACHMNT> = Jsup                                                 HTEXd  196
      <hx;DEM_ATTACHMNT> = Jdem                                                 HTEXd  197
      <hx;SUP_ATTACHMNT> = Jsup                                                 HTEXd  198
      <hx;DEM_ATTACHMNT> = Jdem                                                 HTEXd  199
      IF (<hx:SUP-FLOW> .EQ. 0.)  <hx:SUP-FLOW> = SupFlow                       HTEXd  200
      <hx:MAX-SUP-FLOW> = <hx:SUP-FLOW> * <hx:MAX-SUP-FLOW>                     HTEXd  201
      IF (<hx:DEM-FLOW> .EQ. 0.)  <hx:DEM-FLOW> = DemFlow                       HTEXd  202
      <hx:MAX-DEM-FLOW> = <hx:DEM-FLOW> * <hx:MAX-DEM-FLOW>                     HTEXd  203
      IF (<hx:SUP-dP>   .EQ. 0.)  <hx:SUP-dP>   = SupdP                         HTEXd  204
      IF (<hx:DEM-dP>   .EQ. 0.)  <hx:DEM-dP>   = DemdP                         HTEXd  205
c              specific heats include the units of flow (gpm, cfm, etc.)        HTEXd  206
      <hx;SUPPLY_cp> = SupCp                                                    HTEXd  207
      <hx;DEMAND_cp> = DemCp                                                    HTEXd  208
c              design temperature changes                                       HTEXd  209
      <hx;SUP_dT> = QhxDesign / (<hx:SUP-FLOW>*SupCp)                           HTEXd  210
      <hx;DEM_dT> = QhxDesign / (<hx:DEM-FLOW>*DemCp)                           HTEXd  211
c                                                                               ChlrHP 704
      RETURN                                                                    ChlrHP 705
c                                                                               ChlrHP 706
c              Message formats                                                  -048    57
 9100 Format(14X,'Heat-Exchanger: ',8A4,' design'                      /        -048    58
     &       14X,'calculations failed to converge in 100 iterations.'  )        -048    59
 9102 Format(14X,'Heat-Exchanger: ',8A4,' has supply'                  /        -048    60
     &       14X,'side and demand side film resistances > 1.0'         )        -048    61
 9103 Format(14X,'Heat-Exchanger: ',8A4,' has a '                      /        -048    62
     &       14X,'specified capacity of ',F10.0,' but the design'      /        -048    63
     &       14X,'calculations suggest the capacity should be',F10.0   )        -048    64
                                                                                -048    65
                                                                                -048    66
      CONTAINS                                                                  -048    67
c ============== DesignError ================================================== -048    68
      Subroutine DesignError                                                    -048    69
                                                                                -048    70
      Call MSGSIM(-1,II,II,II,II)                                               -048    71
      Write (IOUTPT,9101)  (<hx:NAME>,II=1,8),                                  -048    72
     &                      QhxDesign,SupFlow,SupTi,SupTo,                      -048    73
     &                                DemFlow,DemTi,DemTo                       -048    74
      Call MessageBox( NULL, 'HT-EXCH design error -'                           -048    75
     &  //' ABORTING'//char(0),'HT-EXCHD Errors'//char(0), MB_OK                -048    76
     &  + MB_ICONSTOP + MB_TASKMODAL )                                          -048    77
                                                                                -048    78
 9101 Format(14X,'Heat-Exchanger: ',8A4,' has'                         /        -048    79
     &       14X,'inconsistent design parameters:'                     /        -048    80
     &       14X,' QhxDesign   SupFlow     SupTi     SupTo'            /        -048    81
     &       14X,      F10.0,    F10.0,    F10.1,    F10.1             /        -048    82
     &       14X,'             DemFlow     DemTi     DemTo'            /        -048    83
     &       24X,                F10.0,    F10.1,    F10.1             )        -048    84
                                                                                -048    85
      End Subroutine DesignError                                                -048    86
c                                                                               HTEXd  228
      END                                                                       HTEXd  230
      FUNCTION NewHX(Jna, Config, UA, Error,                                    NewHX    2
     &               SupRes, SupExp, DemRes, DemExp)                            NewHX    3
c                                                                               NewHX    4
c              Creates a heat-exchanger sub-component for components            NewHX    5
c              having imbedded heat exchangers                                  NewHX    6
c                                                                               NewHX    7
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               NewHX   11
      INTEGER Config                                                            NewHX   12
c                                                                               NewHX   13
c              Create the heat exchanger                                        NewHX   14
      Jhx = NewBlockPtr(<+#Lhx>)                                                NewHX   15
c                                                                               NewHX   16
c              Transfer parameters                                              NewHX   17
      DO II=1,8                                                                 NewHX   18
        <hx:NAME> = <na:Name>                                                   NewHX   19
      ENDDO                                                                     NewHX   20
      <hx;DEM_ATTACHMNT> = Jna                                                  NewHX   21
      <hx:CONFIGURATION> = Config                                               NewHX   22
      <hx:UA>            = UA                                                   NewHX   23
      <hx:MAX-SUP-FLOW>  = 1.1                                                  NewHX   24
      <hx:SUP-FILM-RES>  = SupRes                                               NewHX   25
      <hx:SUP-FILM-EXP>  = SupExp                                               NewHX   26
      <hx:MAX-DEM-FLOW>  = 1.1                                                  NewHX   27
      <hx:DEM-FILM-RES>  = DemRes                                               NewHX   28
      <hx:DEM-FILM-EXP>  = DemExp                                               NewHX   29
      <hx:MAX-ERROR>     = Error                                                NewHX   30
c                                                                               NewHX   31
      NewHX = Jhx                                                               NewHX   32
c                                                                               NewHX   33
      RETURN                                                                    NewHX   34
      END                                                                       NewHX   35
      SUBROUTINE HourRepPlt(Vars, IRBptr, Itype, Mode)                          HRPPLT   2
c                                                                               HRPPLT   3
c              Writes report block variables to temporary buffer                HRPPLT   4
c                                                                               HRPPLT   5
c              Vars - The variables to be stored in the report buffer           HRPPLT   6
c            IRBptr   The pointer to the report buffer                          HRPPLT   7
c             Itype   The component type index into IVTLIM                      HRPPLT   8
c                                                                               HRPPLT   9
c              Mode = 0  Normal write to the buffer - write all variables       HRPPLT  10
c                     1  Re-write to a buffer previously written to.            HRPPLT  11
c                        Replace only the Vars(i) that are non-zero.            HRPPLT  12
c                        This is done for the circulation-loop component        HRPPLT  13
c                        as not all of the data may be known at the same        HRPPLT  14
c                        time, or may be changed for pump values, etc.          HRPPLT  15
c                                                                               HRPPLT  16
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               HRPPLT  21
      DIMENSION Vars(1)                                                         HRPPLT  22
c                                                                               HRPPLT  23
c                                                                               HRPPLT  24
c              start of buffer                                                  HRPPLT  25
      Istart = IRBptr - 1                                                       HRPPLT  26
c              buffer size                                                      HRPPLT  27
      Len    = IVTLIM(2,Itype)                                                  HRPPLT  28
c                                                                               HRPPLT  29
c              transfer variables                                               HRPPLT  30
      IF (Mode .EQ. 0)  THEN                                                    HRPPLT  31
        DO  I=1,Len                                                             HRPPLT  32
          AA(Istart+I) = Vars(I)                                                HRPPLT  33
        ENDDO                                                                   HRPPLT  34
      ELSE                                                                      HRPPLT  35
        DO  I=1,Len                                                             HRPPLT  36
          IF (Vars(I) .NE. 0.)  AA(Istart+I) = Vars(I)                          HRPPLT  37
        ENDDO                                                                   HRPPLT  38
      ENDIF                                                                     HRPPLT  39
c                                                                               HRPPLT  40
      RETURN                                                                    HRPPLT  41
c                                                                               HRPPLT  42
c                                                                               HRPPLT  43
      END                                                                       HRPPLT  44
      Subroutine InitialPLT                                                     INITP    2
c                                                                               INITP    3
c              Initializes all common block variables to zero                   INITP    4
c              in the PLANT code section                                        INITP    5
c                                                                               INITP    6
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
c                                                                               INITP    8
      COMMON  /COGENn/ CogenMode, CogenIterateIndex, TrackMode,                 /COGEN/  2
     &                 QCogenWaste                                              /COGEN/  3
      INTEGER          CogenMode, CogenIterateIndex, TrackMode                  /COGEN/  4
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /EQUIPD/ EQload, EQrun, EQhgb, OperCap, Frac,                     /EQUIPD/ 2
     &                 PLR, EQsupplyT, Tcond,                                   Chlr1    1
     &                 EIRPLR, EIRFT, EQEIR, EQelec, EQfanKW, EQaux,            /EQUIPD/ 4
     &                 HIRPLR, HIRFT, EQHIR, EQfuel, EQcond, EQrecvr,           /EQUIPD/ 5
     &                 HWflow, HWhead, CHWflow, CHWhead, CWflow, CWhead,        /EQUIPD/ 6
     &                 HTRECflow,HTREChead, Qenvir, EQstart, EQloadH,           -041d    1
     &                 EQstartH, PLRh, FracH, EQfuelH, EQelecH                  /EQUIPD/ 8
      REAL             EQUIPDAT(36)                                             /EQUIPD/10
      EQUIVALENCE      (EQUIPDAT(1), EQload), (Tambient, Tcond)                 FreeCl   1
      COMMON  /LDMGMT/ LengthCtrlGroup                                          /LDMGMT/ 2
      COMMON  /LOOP  / Nloop(16,2), NextType(40), NLP2,                         -41a     1
     &                 WLHPoff, RealCall, RegenFlag, Sim2x, LoopSimCount        ChlrHP   2
      LOGICAL          WLHPoff, RealCall, RegenFlag, Sim2x                      ChlrHP   3
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /PLTREP/ EndUses(20,2,4), EndUsePeaks(20,2,4),                    /PLTREP/ 2
     &                 EndPeakDay(20,2,4), EndPeakHour(20,2,4),                 /PLTREP/ 3
     &                 EndUseAtPeak(20,2,4),                                    HVAC29   1
     &                 PSA(13,2)                                                /PLTREP/ 4
      INTEGER          EndPeakDay, EndPeakHour                                  /PLTREP/ 5
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /TESDAT/ Qcharge, Qdischarge, Qloss, Qfreeze, Qtank,              /TESDAT/ 2
     &                 CapMax, AuxkW, TtankEnv, Ttank, NumChrgHours,            /TESDAT/ 3
     &                 NumHoursToStart, ChrgHours, DChrgHours,                  /TESDAT/ 4
     &                 StoredKWh, StoredFuel                                    /TESDAT/ 5
      DIMENSION        TESSAV(15)                                               /TESDAT/ 6
      EQUIVALENCE     (TESSAV(1), Qcharge)                                      /TESDAT/ 7
      COMMON  /TWRDAT/ TWRload,TCAP,TWRrej,CWgpm,TWRgpm,TWRsupply,              /TWRDAT/ 2
     &                 TWRset,Ttower,RANGE,APP,twr1FRA,GPMra,GPMcap,            /TWRDAT/ 3
     &                 GPMcell,NumCells,MinCells,MaxCells,Ttop,GPMtop,          /TWRDAT/ 4
     &                 Tbot,GPMbot,CFMra,FankWr,FankW,TWRaux,QpanLoss,          -034     2
     &                 QcoilLoss, SpraykW, Twet1, Tstart                        /TWRDAT/ 6
      DIMENSION        TWRSAV(25)                                               /TWRDAT/ 7
      EQUIVALENCE     (TWRSAV(1),TWRload)                                       /TWRDAT/ 8
      COMMON  /ZEROP/  LpmHR,LlpHR,LchHR,LblHR,LdwHR,LtwHR,LpvHR,LgnHR,         PV       5
     &                 LtkHR,LhxHR,LecHR,LlmHR,LemHR,LfmHR,LsmHR,LcmHR,         /ZEROP/  3
     &                 LglHR,LpeHR,                                             /ZEROP/  4
     &                 LpmMO,LlpMO,LchMO,LblMO,LdwMO,LtwMO,LpvMO,LgnMO,         PV       6
     &                 LtkMO,LhxMO,LecMO,LlmMO,LemMO,LfmMO,LsmMO,LcmMO,         /ZEROP/  6
     &                 LglMO,LpeMO,                                             /ZEROP/  7
     &                 LpmYR,LlpYR,LchYR,LblYR,LdwYR,LtwYR,LpvYR,LgnYR,         PV       7
     &                 LtkYR,LhxYR,LecYR,LlmYR,LemYR,LfmYR,LsmYR,LcmYR,         /ZEROP/  9
     &                 LglYR,LpeYR                                              /ZEROP/ 10
c                                                                               INITP   21
c                                                                               INITP   22
c              /COGEN/                                                          INITP   23
      CALL FILLN(0, CogenMode, 4)                                               INITP   24
c              /EQCTRL/                                                         INITP   25
      CALL FILLN(0, HeatRejMode, 2)                                             INITP   26
c              /EQUIPD/                                                         INITP   27
      CALL FILLN(0, EQload, 36)                                                 INITP   28
c              /LDMGMT/                                                         INITP   29
      CALL FILLN(0, LengthCtrlGroup, 1)                                         INITP   30
c              /LOOP/                                                           INITP   31
      CALL FILLN(0, Nloop(1,1), 78)                                             ChlrHP 725
c              /LOOPD/                                                          INITP   33
      CALL FILLN(0, RunLoop, 50)                                                INITP   34
c              /PLTREP/                                                         INITP   35
      CALL FILLN(0, EndUses(1,1,1), 826)                                        HVAC29  32
c              /PTRPLT/                                                         INITP   37
      CALL FILLN(0, Ipm, 100)                                                   INITP   38
c              /PUMPD/                                                          INITP   39
      CALL FILLN(0, PMPgpm, 20)                                                 INITP   40
c              /TESDAT/                                                         INITP   41
      CALL FILLN(0, Qcharge, 15)                                                INITP   42
c              /TWRDAT/                                                         INITP   43
      CALL FILLN(0, TWRload, 30)                                                INITP   44
c              /ZEROP/                                                          INITP   45
      CALL FILLN(0, LpmHR, 51)                                                  INITP   46
c                                                                               INITP   47
      RETURN                                                                    INITP   48
      END                                                                       INITP   49
      FUNCTION JComp(Icomp, Lcomp, Ncomp)                                       Jcomp    2
c                                                                               Jcomp    3
c              Calculates the pointer to a component                            Jcomp    4
c              given the component number                                       Jcomp    5
c                                                                               Jcomp    6
c              Ncomp  Number of component as defined in BDL                     Jcomp    7
c              Icomp  Base pointer for component                                Jcomp    8
c              Lcomp  Length of component block                                 Jcomp    9
c                                                                               Jcomp   10
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
c                                                                               Jcomp   12
      IF (Ncomp .GT. 0)  THEN                                                   Jcomp   13
        Jcomp = Icomp + (Ncomp-1)*Lcomp                                         Jcomp   14
      ELSE                                                                      Jcomp   15
        Jcomp = 0                                                               Jcomp   16
      ENDIF                                                                     Jcomp   17
c                                                                               Jcomp   18
      RETURN                                                                    Jcomp   19
      END                                                                       Jcomp   20
      SUBROUTINE LoadManagement(Mode)                                           LDMGMT   2
c                                                                               LDMGMT   3
c              Sets the EQUIP-CTRL sequences for all loops and elec             LDMGMT   4
c              meters.                                                          LDMGMT   5
c                                                                               LDMGMT   6
c              Mode = 1  Beginning of hour call from PLANTi.  Sets default      LDMGMT   7
c                        EQUIP-CTRL sequences, and forces loops on or off       LDMGMT   8
c                     2  Call after loop load calcs from PLANT.  Sets           LDMGMT   9
c                        override EQUIP-CTRL sequences.                         LDMGMT  10
c                                                                               LDMGMT  11
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /LDMGMT/ LengthCtrlGroup                                          /LDMGMT/ 2
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PTRSYS/ nzone , iz    , nczd  , zp2 ,         mtw  ,             -045a    1
     $                 nsys  , is    , nss   , nsp ,  ns   , icode,             HR      11
     $                 nsz   , isz   , nzd   , zp1 ,  nz   ,                    HR      12
     $                 nspace, lpr   ,                                          HR      13
     $                 nattch, iatt  ,                                          HR      14
     $                 P2, IDAYHR, IDBWBT,                                      HR      15
     $                 IRPPLT, IRPSUM, IRPSYS, IRPZON, MR1, MR2                 HR      16
      INTEGER          ZP1, ZP2, P2                                             /PTRSYS/14
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               LDMGMT  19
      COMMON  /LDMGKY/ ScheduledEC, OATemp, PeakShaving                         /LDMGKY/ 2
      INTEGER          ScheduledEC, OATemp, PeakShaving                         /LDMGKY/ 3
      COMMON  /SimAlg/ Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/ 2
     &                 Electrical,                                              /SIMALG/ 3
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/ 4
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/ 5
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   2
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/ 7
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/ 8
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/ 9
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/10
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    3
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    4
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    5
     &                 Ground_LoopVert_H2,Ground_LoopHoriz_H,                   -044d    6
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/14
      INTEGER          Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/15
     &                 Electrical,                                              /SIMALG/16
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/17
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/18
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   3
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/20
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/21
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/22
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/23
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    7
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    8
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    9
     &                 Ground_LoopVert_H2, Ground_LoopHoriz_H,                  -044d   10
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/27
c                                                                               LDMGMT  22
c                                                                               LDMGMT  23
      IF (Mode .EQ. 2)  GOTO 1000                                               LDMGMT  24
c                                                                               LDMGMT  25
c============= DEFAULT EQUIP-CTRL STRATEGIES ================================== LDMGMT  26
c                                                                               LDMGMT  27
c              Set the default EQUIP-CTRL sequences for each loop and/or        LDMGMT  28
c              meter.  The default is specified using the HEAT-EQUIP-CTRL       LDMGMT  29
c              and COOL-EQUIP-CTRL keywords in CIRCULATION-LOOP, or the         LDMGMT  30
c              EQUIP-CTRL keyword in the ELEC-METER command.  These             LDMGMT  31
c              defaults may be overridden at the end of the hour if the         LDMGMT  32
c              load threshholds are exceeded.                                   LDMGMT  33
      DO  NL=1,Nlp                                                              LDMGMT  34
c              pointer to this loop's data                                      LDMGMT  35
        Jlp = Ilp + (NL-1)*Llp                                                  LDMGMT  36
        <lp;HT_EQUIP_CTRL> = <lp:HT-EQUIP-CTRL>                                 LDMGMT  37
        <lp;HT_PRIORITY>   = 0.                                                 LDMGMT  38
        <lp;CL_EQUIP_CTRL> = <lp:CL-EQUIP-CTRL>                                 LDMGMT  39
        <lp;CL_PRIORITY>   = 0.                                                 LDMGMT  40
c              on/off override priority                                         LDMGMT  41
        <lp;OVR_PRIORITY>  = 0.                                                 LDMGMT  42
      ENDDO                                                                     LDMGMT  43
c                                                                               LDMGMT  44
c              Same for electric meters                                         LDMGMT  45
      DO  Nmeter=1,Nem                                                          LDMGMT  46
        Jem = Iem + (Nmeter-1)*Lem                                              LDMGMT  47
        <em;EQUIP_CTRL>    = <em:EQUIP-CTRL>                                    LDMGMT  48
        <em;CTRL_PRIORITY> = 0.                                                 LDMGMT  49
      ENDDO                                                                     LDMGMT  50
c                                                                               LDMGMT  51
c                                                                               LDMGMT  52
c============= LOAD-MANAGEMENT instructions =================================== LDMGMT  53
 1000 CONTINUE                                                                  LDMGMT  54
c              Loop thru all load management sequences                          LDMGMT  55
      DO  Nctrl=1,Nlm                                                           -048r    1
        Jlm = Ilm + (Nctrl-1)*Llm                                               -048r    2
c              See if sequence qualifies for this hour                          LDMGMT  58
        IF (SchVal(<lm:QUAL-SCH>, 0.) .NE. <lm:QUAL-SCH-FLAG>)  CYCLE           Time    39
c                                                                               LDMGMT  65
c              Number of control groups                                         LDMGMT  66
        NumCtrlGroups  = <lm;NUM_GROUPS>                                        LDMGMT  67
c              Determine which group to use                                     LDMGMT  68
        Index = 0                                                               LDMGMT  69
        SELECT CASE (Mode)                                                      LDMGMT  70
        CASE (1)                                                                LDMGMT  71
c              Beginning of hour instructions                                   LDMGMT  72
          SELECT CASE (<lm:TYPE>)                                               LDMGMT  73
          CASE (1)                     ! Scheduled                              LDMGMT  74
c              get the flag value                                               LDMGMT  75
            Flag = SchVal(<lm:EQUIP-SCH>, 0.)                                   Time    40
            DO  IG=1,NumCtrlGroups                                              LDMGMT  77
              IF (Flag .EQ. <lm:CTRL-FLAGS>)  THEN                              LDMGMT  78
                INDEX = IG                                                      LDMGMT  79
                EXIT                                                            LDMGMT  80
              ENDIF                                                             LDMGMT  81
            ENDDO                                                               LDMGMT  82
          CASE (2)                     ! Outdoor air temperature                LDMGMT  83
            DO  IG=1,NumCtrlGroups                                              LDMGMT  84
              IF (DBT .LE. <lm:CTRL-TEMPS>)  THEN                               LDMGMT  85
                INDEX = IG                                                      LDMGMT  86
                EXIT                                                            LDMGMT  87
              ENDIF                                                             LDMGMT  88
            ENDDO                                                               LDMGMT  89
c             if no range found, use hottest                                    -048r    3
            IF (Index .eq. 0)  Index = NumCtrlGroups                            -048r    4
          CASE (3)                     ! Zone temperature                       LDMGMT  90
            ZP1      = <lm:CTRL-ZONE>                                           LDMGMT  91
            ZoneTemp = <TNOW>                                                   LDMGMT  92
            DO  IG=1,NumCtrlGroups                                              LDMGMT  93
              IF (ZoneTemp .LE. <lm:CTRL-TEMPS>)  THEN                          LDMGMT  94
                INDEX = IG                                                      LDMGMT  95
                EXIT                                                            LDMGMT  96
              ENDIF                                                             LDMGMT  97
            ENDDO                                                               LDMGMT  98
c             if no range found, use hottest                                    -048r    5
            IF (Index .eq. 0)  Index = NumCtrlGroups                            -048r    6
          CASE (4)                     ! Loop load                              LDMGMT  99
          CASE (5)                     ! Peak Shaving                           LDMGMT 100
          END SELECT                                                            LDMGMT 101
        CASE (2)                       ! Call from Plant                        LDMGMT 102
c              Plant instructions                                               LDMGMT 103
          SELECT CASE (<lm:TYPE>)                                               LDMGMT 104
          CASE (1)                     ! Scheduled                              LDMGMT 105
          CASE (2)                     ! Outdoor air temperature                LDMGMT 106
          CASE (3)                     ! Zone temperature                       LDMGMT 107
          CASE (4)                     ! Loop load                              LDMGMT 108
            Jlp     = <lm:CTRL-LOOP>                                            LDMGMT 109
            Qloop   = ABS(<lp;Q_NET>)                                           LDMGMT 110
            DO  IG=1,NumCtrlGroups                                              LDMGMT 111
              IF (Qloop .LE. <lm:CTRL-LOADS>)  THEN                             LDMGMT 112
                INDEX = IG                                                      LDMGMT 113
                EXIT                                                            LDMGMT 114
              ENDIF                                                             LDMGMT 115
            ENDDO                                                               LDMGMT 116
c             if no range found, use largest                                    -048r    7
            IF (Index .eq. 0)  Index = NumCtrlGroups                            -048r    8
          CASE (5)                     ! Peak Shaving                           LDMGMT 117
          END SELECT                                                            LDMGMT 118
        END SELECT  !Mode                                                       LDMGMT 119
c                                                                               LDMGMT 120
c              Skip this LOAD-MANAGEMENT if no match found                      LDMGMT 121
        IF (Index .EQ. 0)  CYCLE                                                LDMGMT 122
c                                                                               LDMGMT 123
c              Match found                                                      LDMGMT 124
        IG = Index                                                              LDMGMT 125
c              command priority for this group                                  LDMGMT 126
        Priority = <lm:CTRL-PRIORS>                                             LDMGMT 127
        IIstart = (IG-1)*LengthCtrlGroup + 1                                    LDMGMT 128
        IIend   = IIstart + <lm;NUM_EQUIP-CTR>-1                                -048r    9
        DO  II=IIstart,IIend                                                    LDMGMT 130
          Jec = <lm:EQUIP-CTRL>                                                 LDMGMT 131
          IF (Jec .eq. 0)  Cycle                                                Ver42L1  1
          SELECT CASE (<ec:TYPE>)                                               LDMGMT 132
          CASE (1,4)                                                            LDMGMT 133
c              cooling or heat-rejection                                        LDMGMT 134
            Jlp = <ec:LOOP>                                                     LDMGMT 135
            IF (Priority .GT. <lp;CL_PRIORITY>)  THEN                           LDMGMT 136
              <lp;CL_EQUIP_CTRL> = Jec                                          LDMGMT 137
              <lp;CL_PRIORITY>   = Priority                                     LDMGMT 138
            ENDIF                                                               LDMGMT 139
          CASE (2,3)                                                            LDMGMT 140
c              heating or dw heating                                            LDMGMT 141
            Jlp = <ec:LOOP>                                                     LDMGMT 142
            IF (Priority .GT. <lp;HT_PRIORITY>)  THEN                           LDMGMT 143
              <lp;HT_EQUIP_CTRL> = Jec                                          LDMGMT 144
              <lp;HT_PRIORITY>   = Priority                                     LDMGMT 145
            ENDIF                                                               LDMGMT 146
          CASE (5)                                                              LDMGMT 147
c              electrical                                                       LDMGMT 148
            Jem = <ec:ELEC-METER>                                               LDMGMT 149
            IF (Priority .GT. <em;CTRL_PRIORITY>)  THEN                         LDMGMT 150
              <em;EQUIP_CTRL>    = Jec                                          LDMGMT 151
              <em;CTRL_PRIORITY> = Priority                                     LDMGMT 152
            ENDIF                                                               LDMGMT 153
          END SELECT                                                            LDMGMT 154
        ENDDO                                                                   LDMGMT 155
c              set flags to force loops on                                      LDMGMT 156
        IIend   = IIstart + <lm;NUM_LOOPS_ON>-1                                 -048r   10
        DO  II=IIstart,IIend                                                    LDMGMT 158
          Jlp = <lm:LOOPS-ON>                                                   LDMGMT 159
          IF (Jpl .eq. 0)  Cycle                                                -048r   11
          IF (Priority .GT. <lp;OVR_PRIORITY>)  THEN                            LDMGMT 160
            <lp;OVERRIDE>     = 1                                               LDMGMT 161
            <lp;OVR_PRIORITY> = Priority                                        LDMGMT 162
          ENDIF                                                                 LDMGMT 163
        ENDDO                                                                   LDMGMT 164
c              set flags to force loops off                                     LDMGMT 165
        IIend   = IIstart + <lm;NUM_LOOPS_OFF>-1                                -048r   12
        DO  II=IIstart,IIend                                                    LDMGMT 167
          Jlp = <lm:LOOPS-OFF>                                                  LDMGMT 168
          IF (Jpl .eq. 0)  Cycle                                                -048r   13
          IF (Priority .GT. <lp;OVR_PRIORITY>)  THEN                            LDMGMT 169
            <lp;OVERRIDE>     = -1                                              LDMGMT 170
            <lp;OVR_PRIORITY> = Priority                                        LDMGMT 171
          ENDIF                                                                 LDMGMT 172
        ENDDO                                                                   LDMGMT 173
      ENDDO                                                                     LDMGMT 174
c                                                                               LDMGMT 175
      RETURN                                                                    LDMGMT 176
      END                                                                       LDMGMT 177
      SUBROUTINE LoadManagementSetup                                            LDMGMS   2
c                                                                               LDMGMS   3
c              Sets up the parameters for the user-specified                    LDMGMS   4
c              LOAD-MANAGEMENT sequences for primary equipment                  LDMGMS   5
c                                                                               LDMGMS   6
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /LDMGMT/ LengthCtrlGroup                                          /LDMGMT/ 2
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PTRSYS/ nzone , iz    , nczd  , zp2 ,         mtw  ,             -045a    1
     $                 nsys  , is    , nss   , nsp ,  ns   , icode,             HR      11
     $                 nsz   , isz   , nzd   , zp1 ,  nz   ,                    HR      12
     $                 nspace, lpr   ,                                          HR      13
     $                 nattch, iatt  ,                                          HR      14
     $                 P2, IDAYHR, IDBWBT,                                      HR      15
     $                 IRPPLT, IRPSUM, IRPSYS, IRPZON, MR1, MR2                 HR      16
      INTEGER          ZP1, ZP2, P2                                             /PTRSYS/14
c                                                                               LDMGMS  12
      COMMON  /LDMGKY/ ScheduledEC, OATemp, PeakShaving                         /LDMGKY/ 2
      INTEGER          ScheduledEC, OATemp, PeakShaving                         /LDMGKY/ 3
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
c                                                                               LDMGMS  14
c                                                                               LDMGMS  15
c              find the offset between successive EQUIP-CTRL groups             LDMGMS  16
      Jlm = Ilm                                                                 LDMGMS  17
      LengthCtrlGroup = IndexPosition(<lm:EQUIP-CTRL>,                          LDMGMS  18
     &                                <lm:EQUIP-CTRL-2>,2) - 1                  LDMGMS  19
c                                                                               LDMGMS  20
c              set up each LOAD-MANAGEMENT sequence                             LDMGMS  21
      DO  Nctrl=1,Nlm                                                           LDMGMS  22
c              pointer to this sequence's data                                  LDMGMS  23
        Jlm     = Ilm + (Nctrl-1)*Llm                                           LDMGMS  24
c              convert QUAL-SCH component number to pointer                     LDMGMS  25
        <lm:QUAL-SCH> = Jsched(<lm:QUAL-SCH>)                                   Time    41
        IF (<lm:TYPE> .EQ. ScheduledEC)  THEN                                   LDMGMS  27
c              convert EQUIP-SCH component number to pointer                    LDMGMS  28
          <lm:EQUIP-SCH> = Jsched(<lm:EQUIP-SCH>)                               Time    42
        ENDIF                                                                   LDMGMS  30
c                                                                               LDMGMS  31
c              Set up special criteria for each type                            LDMGMS  32
        SELECT CASE (<lm:TYPE>)                                                 LDMGMS  33
        CASE (1)   ! Scheduled                                                  LDMGMS  34
        CASE (2)   ! OA temp                                                    LDMGMS  35
        CASE (3)   ! Zone temp                                                  LDMGMS  36
          ZP2 = IZ + (<lm:CTRL-ZONE>-1)*NCZD                                    LDMGMS  37
          DO  NS=1,NSYS                                                         LDMGMS  38
            NSP = IS + (NS-1)*NSS                                               LDMGMS  39
            ISZ = <ISZONES>                                                     LDMGMS  40
            NSZ = <NZONES>                                                      LDMGMS  41
            DO  NZ=1,NSZ                                                        LDMGMS  42
              ZP1 = ISZ + (NZ-1)*NZD                                            LDMGMS  43
              IF (ZP2 .EQ. <ZP2>)  THEN                                         LDMGMS  44
                <lm:CTRL-ZONE> = ZP1                                            LDMGMS  45
                GOTO 101                                                        LDMGMS  46
              ENDIF                                                             LDMGMS  47
            ENDDO                                                               LDMGMS  48
          ENDDO                                                                 LDMGMS  49
  101     CONTINUE                                                              LDMGMS  50
        CASE (4)   ! Loop load                                                  LDMGMS  51
          <lm:CTRL-LOOP> = Ilp + (<lm:CTRL-LOOP>-1)*Llp                         LDMGMS  52
c              convert MBtu to Btu                                              LDMGMS  53
          DO  IG=1,5                                                            LDMGMS  54
            IF (<lm:CTRL-LOADS> .ne. UnFild)                                    Ver42L1  5
     &          <lm:CTRL-LOADS> = <lm:CTRL-LOADS> * 1.E6                        Ver42L1  6
          ENDDO                                                                 LDMGMS  56
        CASE (5)   ! Peak shaving                                               LDMGMS  57
        END SELECT                                                              LDMGMS  58
c                                                                               LDMGMS  59
c              Cycle thru each control group (5 maximum)                        Ver42L1  7
c              Note that lm;NUM_EQUIP-CTR, lm:LOOPS-ON, and lm:LOOPS-OFF        Ver42L1  8
c              use the IG index.  lm:EQUIP-CTRL, lm:LOOPS-ON, and               Ver42L1  9
c              lm:LOOPS-OFF use the II index                                    Ver42L1 10
        DO  IG=1,5                                                              Ver42L1 11
          IIstart = (IG-1)*LengthCtrlGroup                                      Ver42L1 12
          DO  Neq=1,LengthCtrlGroup                                             Ver42L1 13
            II = IIstart + Neq                                                  Ver42L1 14
c              equip-ctrl                                                       Ver42L1 15
            IF (<lm:EQUIP-CTRL> .gt. 0)  THEN                                   Ver42L1 16
              <lm;NUM_EQUIP-CTR> = Neq                                          Ver42L1 17
              <lm:EQUIP-CTRL>    = Iec + (<lm:EQUIP-CTRL>-1)*Lec                Ver42L1 18
            ENDIF                                                               Ver42L1 19
c              loops-on                                                         Ver42L1 20
            IF (<lm:LOOPS-ON> .gt. 0)  THEN                                     Ver42L1 21
              <lm;NUM_LOOPS_ON> = Neq                                           Ver42L1 22
              <lm:LOOPS-ON>     = Ilp + (<lm:LOOPS-ON>-1)*Llp                   Ver42L1 23
            ENDIF                                                               Ver42L1 24
c              loops-off                                                        Ver42L1 25
            IF (<lm:LOOPS-OFF> .gt. 0)  THEN                                    Ver42L1 26
              <lm;NUM_LOOPS_OFF> = Neq                                          Ver42L1 27
              <lm:LOOPS-OFF>     = Ilp + (<lm:LOOPS-OFF>-1)*Llp                 Ver42L1 28
            ENDIF                                                               Ver42L1 29
          ENDDO  ! II                                                           Ver42L1 30
          Neq = <lm;NUM_EQUIP-CTR> + <lm;NUM_LOOPS_ON>                          Ver42L1 31
     &                             + <lm;NUM_LOOPS_OFF>                         Ver42L1 32
          IF (<lm:CTRL-FLAGS> .eq. Unfild)  THEN                                Ver42L1 33
c              no control range specified                                       Ver42L1 34
            IF (Neq .gt. 0)  THEN                                               Ver42L1 35
c                error if input without a control range                         Ver42L1 36
              CALL MSGSIM(-1,II,II,II,II)                                       Ver42L1 37
              WRITE (IOUTPT, 9001)  (<lm:NAME>,II=1,8), IG                      Ver42L1 38
              CALL MessageBox( NULL,                                            Ver42L1 39
     &        'Control Group has entries'//char(10)//char(13)//                 Ver42L1 40
     &        'but no control range'//char(0),                                  Ver42L1 41
     &        'LOAD-MANAGEMENT Errors'//char(0),                                Ver42L1 42
     &        MB_OK + MB_ICONSTOP + MB_TASKMODAL )                              Ver42L1 43
            ENDIF                                                               Ver42L1 45
          ELSEIF (Neq .eq. 0  .and.                                             -048r   14
     &           ((<lm:CTRL-FLAGS> .ne. Unfild  .and.                           -048r   15
     &                          IG .eq. <lm;NUM_GROUPS>+1)  .or.                -048r   16
     &            (<lm:CTRL-FLAGS> .ne. 0.  .and.                               -048r   17
     &                          IG .gt. <lm;NUM_GROUPS>+1))) THEN               -048r   18
c              control range specified without anything controlled              Ver42L1 47
            CALL MSGSIM(-3,II,II,II,II)                                         Ver42L1 48
            WRITE (IOUTPT, 9002)  (<lm:NAME>,II=1,8), IG                        Ver42L1 49
          ELSEIF (Neq .gt. 0)  THEN                                             Ver42L1 50
c              valid control group                                              Ver42L1 51
            <lm;NUM_GROUPS> = IG                                                Ver42L1 52
          ENDIF  ! lm:CTRL-FLAGS                                                Ver42L1 53
        ENDDO  ! IG                                                             Ver42L1 54
      ENDDO    ! LOAD-MANAGEMENT sequences                                      LDMGMS 109
c                                                                               LDMGMS 110
      RETURN                                                                    LDMGMS 111
c                                                                               Ver42L1 55
c              Message formats                                                  Ver42L1 56
 9001 FORMAT(14x,'In Load Management: ' 8A4,' control'                 /        Ver42L1 57
     &14x,'group ',I1,' has equip-ctrl, loops-on or loops-off'         /        Ver42L1 58
     &14x,'specified, but has no control range specified.'             )        Ver42L1 59
 9002 FORMAT(14x,'In Load Management: ', 8A4,' control'                /        Ver42L1 60
     &14x,'group ',I1,' has a control range but no other entries.'     /        Ver42L1 61
     &14x,'Control will be via a different load management command, or'/        Ver42L1 62
     &14x,'by default.'                                                )        Ver42L1 63
      END                                                                       LDMGMS 112
      SUBROUTINE LoopCoilFlow                                                   LOOPCF   2
c                                                                               LOOPCF   3
c              Determines the coil flows on the current loop                    LOOPCF   4
c              given a fluid supply temperature                                 LOOPCF   5
c                                                                               LOOPCF   6
c              Called successively for each loop                                LOOPCF   7
c                                                                               LOOPCF   8
c                                                                               LOOPCF   9
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PTRSYS/ nzone , iz    , nczd  , zp2 ,         mtw  ,             -045a    1
     $                 nsys  , is    , nss   , nsp ,  ns   , icode,             HR      11
     $                 nsz   , isz   , nzd   , zp1 ,  nz   ,                    HR      12
     $                 nspace, lpr   ,                                          HR      13
     $                 nattch, iatt  ,                                          HR      14
     $                 P2, IDAYHR, IDBWBT,                                      HR      15
     $                 IRPPLT, IRPSUM, IRPSYS, IRPZON, MR1, MR2                 HR      16
      INTEGER          ZP1, ZP2, P2                                             /PTRSYS/14
c                                                                               LOOPCF  15
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
c                                                                               LOOPCF  18
      DIMENSION GPMLIM(2)                                                       LOOPCF  19
c              minimum cfm ratio for curve - interpolate below                  LOOPCF  20
      DATA CFMRMIN /0.3/                                                        LOOPCF  21
c              limits for inverse curves                                        LOOPCF  22
      DATA GPMLIM /2.0, 0.2/                                                    LOOPCF  23
c                                                                               LOOPCF  24
      RunFrac(PLR) = (1.-<lp;RUN_FRACTION>)*PLR + <lp;RUN_FRACTION>             GLHX1  222
c                                                                               GLHX1  223
c              Zero coil values as the program may iterate through this         GLHX1  224
c              routine more than once per loop per hour                         GLHX1  225
      <lp;3WayGPM> = 0.                                                         GLHX1  226
      <lp;2WayGPM> = 0.                                                         GLHX1  227
      CoilHead     = 0.                                                         GLHX1  228
c                                                                               GLHX1  229
c              loop through all systems and zones and calculate                 GLHX1  230
c              the coil flows for any coils on this loop                        GLHX1  231
      DO 100  NS=1,NSYS                                                         GLHX1  232
        NSP   = IS + (NS-1)*NSS                                                 GLHX1  233
c              skip if this system is not attached to any loops                 GLHX1  234
        IF (<SYS_LOOP_FLAG> .EQ. 0)  CYCLE                                      GLHX1  235
        ICODE = <SYSTEM-TYPE>                                                   GLHX1  236
c              central system coils                                             GLHX1  237
c              first, hot water - skip if not hot water or no load              GLHX1  238
        IF (<HW-LOOP> .EQ. Jlp)  THEN                                           GLHX1  239
          IF (<HEATING-CAPACITY> .GT. -10.  .AND.                               Bug40   91
     &                                       <HT_COIL_Q> .LT. 0.)  THEN         Bug40   92
c              phantom heating load at non-existent central coil                Bug40   93
            GPM          = <HT_COIL_Q>/(<lp;BTUH/GPM-F>*<lp:DESIGN-DT>)         Bug40   94
            <lp;2WayGPM> = <lp;2WayGPM> + ABS(GPM)                              Bug40   95
            CoilHead     = MAX(CoilHead, 10.)                                   Bug40   96
          ELSEIF (<HW-VALVE-TYPE> .EQ. 3)  THEN                                 Bug40   97
c              3-way valve                                                      GLHX1  241
            IF (<lp;RUNNING> .GT. 0)  THEN                                      GLHX1  242
              <lp;3WayGPM> = <lp;3WayGPM> + <HWDESGPMS>                         GLHX1  243
              CoilHead     = MAX(CoilHead, <HW-COIL-HEAD>)                      GLHX1  244
            ENDIF                                                               GLHX1  245
          ELSEIF (<HT_COIL_Q> .LT. 0.  .AND.  ICODE .NE. 25)  THEN              GLHX1  246
c              2-way valve with a load                                          GLHX1  247
c              normalized temperature between EAT and EWT                       GLHX1  248
            DTR = (<HT_COIL_EDB> - <lp;COIL_EWT>) / <HWDESDTS>                  GLHX1  249
            DTR = MIN(1.5, MAX(DTR, 0.1) )                                      RetLoss  1
c              cfm ratio - interpolate to zero below ratio of 0.3               GLHX1  251
            CFMR  = <HT_COIL_CFM> / <CFMH>                                      GLHX1  252
            CFMR  = Min(1.4, CFMR)                                              -041N    1
            CFMRR = 1.0                                                         GLHX1  253
            IF (CFMR .LT. CFMRMIN)  THEN                                        GLHX1  254
              CFMRR = CFMR / CFMRMIN                                            GLHX1  255
              CFMR  = CFMRMIN                                                   GLHX1  256
            ENDIF                                                               GLHX1  257
c              capacity ratio - do not let coil operate at .gt. 100%            GLHX1  258
            CAPR = <HT_COIL_Q> / (<HEATING-CAPACITY>                            GLHX1  259
     &                                  * CFMRR * <HT_COIL_CYCLE>               GLHX1  260
     &                                  * CVAL(<HW-CAP-FCFM>,CFMR,CFMR)         GLHX1  261
     &                                  * CVAL(<HW-CAP-FDT> ,DTR ,DTR) )        GLHX1  262
            Call CheckCapR                                                      -048    87
c              interpolate if capacity corresponds to a GPM .lt. 30%            GLHX1  264
            IF (CAPR .LT. <HWGPMMINCAP>)  THEN                                  GLHX1  265
              GPMR = 0.3 * CAPR/<HWGPMMINCAP>                                   GLHX1  266
            ELSE                                                                GLHX1  267
c              pointer to CAP = f(GPMR) curve                                   GLHX1  268
              Jcv = <HW-CAP-FGPM>                                               -045b    8
              CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 1,GPMR,Y,CAPR,                 -045b    9
     &                                                 GPMLIM(1),IERR)          GLHX1  271
            ENDIF                                                               GLHX1  272
            IF (ICODE .NE. 17)  THEN                                            GLHX1  273
c              loop head and flow                                               GLHX1  274
              CoilHead     = MAX(CoilHead, <HW-COIL-HEAD>*GPMR**1.8)            GLHX1  275
              <lp;2WayGPM> = <lp;2WayGPM>                                       GLHX1  276
     &                     + <HWDESGPMS>*GPMR*<HT_COIL_CYCLE>                   GLHX1  277
            ELSE                                                                GLHX1  278
c              flow cycles with fan in RESYS                                    GLHX1  279
              GPMR     = <HT_COIL_CYCLE>                                        GLHX1  280
              CoilHead = MAX(CoilHead, <HW-COIL-HEAD>)                          GLHX1  281
              <lp;2WayGPM> = <lp;2WayGPM> + <HWDESGPMS>*<HT_COIL_CYCLE>         GLHX1  282
            ENDIF                                                               GLHX1  283
          ELSEIF (ICODE .EQ. 25)  THEN                                          GLHX1  284
c              PTGSD flow assumed to be linear with load                        GLHX1  285
            GPMR         = <HT_COIL_Q> / <HEATING-CAPACITY>                     GLHX1  286
            CoilHead     = MAX(CoilHead, <HW-COIL-HEAD>*GPMR**1.8)              GLHX1  287
            <lp;2WayGPM> = <lp;2WayGPM>+ <HWDESGPMS>*GPMR                       GLHX1  288
          ENDIF                                                                 GLHX1  289
c              Humidifier flow                                                  -035    97
          IF (<HUM_COIL_Q> .LT. 0.)  THEN                                       -035    98
            GPM = ABS(<HUM_COIL_Q> / (<lp;BTUH/GPM-F>*<lp:DESIGN-DT>))          -035    99
            <lp;2WayGPM> = <lp;2WayGPM> + GPM                                   -035   100
          ENDIF                                                                 -035   101
        ENDIF                                                                   GLHX1  290
c              preheat coil                                                     GLHX1  291
        IF (<PHW-LOOP> .EQ. Jlp)  THEN                                          GLHX1  292
          IF (<HW-VALVE-TYPE> .EQ. 3)  THEN                                     GLHX1  293
c              3-way valve                                                      GLHX1  294
            IF (<lp;RUNNING> .GT. 0)  THEN                                      GLHX1  295
              <lp;3WayGPM> = <lp;3WayGPM> + <PHWDESGPMS>                        GLHX1  296
              CoilHead     = MAX(CoilHead, <PHW-COIL-HEAD>)                     GLHX1  297
            ENDIF                                                               GLHX1  298
          ELSEIF (<PHT_COIL_Q> .LT. 0.)  THEN                                   GLHX1  299
c              2-way valve with a load                                          GLHX1  300
            DTR  = (<PHT_COIL_EDB> - <lp;COIL_EWT>) / <PHWDESDTS>               GLHX1  301
            DTR  = MIN(1.5, MAX(DTR, 0.1) )                                     RetLoss  2
            CAPR = <PHT_COIL_Q> / (<PREHEAT-CAPACITY>                           GLHX1  303
     &                                 * <PHT_COIL_CYCLE>                       GLHX1  304
     &                                 * CVAL(<HW-CAP-FDT>,DTR,DTR) )           GLHX1  305
            Call CheckCapR                                                      -048    88
c              interpolate if capacity corresponds to a GPM .lt. 30%            GLHX1  307
            IF (CAPR .LT. <HWGPMMINCAP>)  THEN                                  GLHX1  308
              GPMR = 0.3 * CAPR/<HWGPMMINCAP>                                   GLHX1  309
            ELSE                                                                GLHX1  310
c              pointer to CAP = f(GPMR) curve                                   GLHX1  311
              Jcv = <HW-CAP-FGPM>                                               -045b   10
              CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 1,GPMR,Y,CAPR,                 -045b   11
     &                                                 GPMLIM(1),IERR)          GLHX1  314
            ENDIF                                                               GLHX1  315
            CoilHead     = MAX(CoilHead, <PHW-COIL-HEAD>*GPMR**1.8)             GLHX1  316
            <lp;2WayGPM> = <lp;2WayGPM>                                         GLHX1  317
     &                   + <PHWDESGPMS>*GPMR*<PHT_COIL_CYCLE>                   GLHX1  318
          ENDIF                                                                 GLHX1  319
        ENDIF                                                                   GLHX1  320
c              ERV preheat coil                                                 ERV     40
        IF (<sy;ERVentilator> .GT. 0)  THEN                                     ERV     41
          Jrv = <sy;ERVentilator>                                               ERV     42
          IF (<rv;PreheatLoop> .EQ. Jlp)  THEN                                  ERV     43
            IF (<rv;Qpreheat> .LT. 0.)  THEN                                    ERV     44
c                 ERV preheat assumes a simple linear coil model                ERV     45
              dTinlets     = <lp;COIL_EWT> - <rv;TairPreheat>                   ERV     46
              GPMR         = <rv;Qpreheat> * <rv:PREHEAT-IN-DT>                 ERV     47
     &                                 / (<rv;QpreheatDes>*dTinlets)            ERV     48
               CoilHead     = MAX(CoilHead, 10.*GPMR**1.8)                      ERV     49
               <lp;2WayGPM> = <lp;2WayGPM> + <rv;GPMpreheatDes>*GPMR            ERV     50
            ENDIF                                                               ERV     51
          ENDIF                                                                 ERV     52
        ENDIF                                                                   ERV     53
c              desiccant regeneration coil                                      GLHX1  321
        IF (<DESC-LOOP> .EQ. Jlp)  THEN                                         GLHX1  322
          IF (<DESC-VALVE-TYPE> .EQ. 3)  THEN                                   GLHX1  323
c              3-way valve                                                      GLHX1  324
            IF (<lp;RUNNING> .GT. 0)  THEN                                      GLHX1  325
              <lp;3WayGPM> = <lp;3WayGPM> + <DESCDESGPMS>                       GLHX1  326
              CoilHead     = MAX(CoilHead, <DESC-COIL-HEAD>)                    GLHX1  327
            ENDIF                                                               GLHX1  328
          ELSEIF (<DESC_COIL_Q> .LT. 0.)  THEN                                  GLHX1  329
c              2-way valve with a load                                          GLHX1  330
c              desiccant flow assumed to be linear with load                    GLHX1  331
            GPMR         = <DESC_COIL_Q> / <HEATING-CAPACITY>                   GLHX1  332
            CoilHead     = MAX(CoilHead, <DESC-COIL-HEAD>*GPMR**1.8)            GLHX1  333
            <lp;2WayGPM> = <lp;2WayGPM> + <DESCDESGPMS>*GPMR                    GLHX1  334
          ENDIF                                                                 GLHX1  335
        ENDIF                                                                   GLHX1  336
c              central system chilled water coil                                GLHX1  337
        IF (<CHW-LOOP> .EQ. Jlp)  THEN                                          GLHX1  338
          IF (<CHW-VALVE-TYPE> .EQ. 3)  THEN                                    GLHX1  339
c              3-way valve - flow already counted in hw calc for 2-pipe         GLHX1  340
            IF (<lp;RUNNING> .GT. 0                                             GLHX1  341
     &                              .AND.  <lp:TYPE> .NE. PIPE2)  THEN          GLHX1  342
              <lp;3WayGPM> = <lp;3WayGPM> + <CHWDESGPMS>                        GLHX1  343
              CoilHead     = MAX(CoilHead, <CHW-COIL-HEAD>)                     GLHX1  344
            ENDIF                                                               GLHX1  345
          ELSEIF (<CL_COIL_Q> .GT. 0.)  THEN                                    GLHX1  346
c              2-way valve with a load                                          GLHX1  347
c              coil entering wetbulb temp                                       GLHX1  348
            EWB = MIN(73., MAX(<CL_COIL_EWB>, 59.))                             GLHX1  349
c              cfm ratio - interpolate to zero below ratio of 0.3               GLHX1  350
            CFMR  = <CL_COIL_CFM> / (<SUPPLY-CFM> * <CL_COIL_CYCLE>)            GLHX1  351
            CFMR  = Min(1.4, CFMR)                                              -041N    2
            CFMRR = 1.0                                                         GLHX1  352
            IF (CFMR .LT. CFMRMIN)  THEN                                        GLHX1  353
              CFMRR = CFMR / CFMRMIN                                            GLHX1  354
              CFMR  = CFMRMIN                                                   GLHX1  355
            ENDIF                                                               GLHX1  356
c              capacity ratio - do not let coil operate at .gt. 100%            GLHX1  357
            CAPR = <CL_COIL_Q> / (<CHWCAP6544S>                                 GLHX1  358
     &                   * CFMRR * <CL_COIL_CYCLE>                              GLHX1  359
     &                   * CVAL(<CHW-CAP-FCFM>,CFMR,CFMR)                       GLHX1  360
     &                   * CVAL(<CHW-CAP-FEWBEWT>,EWB,<lp;COIL_EWT>) )          GLHX1  361
            Call CheckCapR                                                      -048    89
c              interpolate if capacity corresponds to a GPM .lt. 30%            GLHX1  363
            IF (CAPR .LT. <CHWGPMMINCAP>)  THEN                                 GLHX1  364
              GPMR = 0.3 * CAPR/<CHWGPMMINCAP>                                  GLHX1  365
            ELSE                                                                GLHX1  366
c              pointer to CAP = f(GPMR) curve                                   GLHX1  367
              Jcv = <CHW-CAP-FGPM>                                              -045b   12
              CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 1,GPMR,Y,CAPR,                 -045b   13
     &                                                 GPMLIM(1),IERR)          GLHX1  370
            ENDIF                                                               GLHX1  371
c              loop head and flow                                               GLHX1  372
            CoilHead     = MAX(CoilHead, <CHW-COIL-HEAD>*GPMR**1.8)             GLHX1  373
            <lp;2WayGPM> = <lp;2WayGPM>                                         GLHX1  374
     &                   + <CHWDESGPMS>*GPMR*<CL_COIL_CYCLE>                    GLHX1  375
          ELSEIF (<CL_COIL_Q> .LT. 0.  .AND.  ICODE .EQ. 25)  THEN              GLHX1  376
c              PTGSD regeneration flow assumed to be linear with load           GLHX1  377
c              Note that this is actually the regeneration heating load,        GLHX1  378
c              kept separate from space heating for end-use accounting          GLHX1  379
            GPMR         = <CL_COIL_Q> / <HEATING-CAPACITY>                     GLHX1  380
            CoilHead     = MAX(CoilHead, <HW-COIL-HEAD>*GPMR**1.8)              GLHX1  381
            <lp;2WayGPM> = <lp;2WayGPM> + <HWDESGPMS>*GPMR                      GLHX1  382
          ENDIF                                                                 GLHX1  383
        ENDIF                                                                   GLHX1  384
c              central water-cooled DX or WLHP                                  GLHX1  385
        IF (<CW-LOOP> .EQ. Jlp)  THEN                                           GLHX1  386
c              sum the loop flow                                                GLHX1  387
          IF (<lp;RUNNING> .GT. 0)  THEN                                        GLHX1  388
c              head requirement of condenser always constant when running       GLHX1  389
            IF (<CW_COIL_Q> .NE. 0.)  THEN                                      -044d  127
              CoilHead      = MAX(CoilHead, <CW-COIL-HEAD>)                     GLHX1  391
              <CW_COIL_GPM> = MAX(<CW_COIL_GPM>, <CWDESGPMS>*0.01)              GLHX1  392
            ENDIF                                                               GLHX1  393
            IF (<CW-VALVE> .EQ. No)  THEN                                       GLHX1  394
c              unit has no condenser valve                                      GLHX1  395
              IF (Jlp .NE. <WSE-LOOP>)  THEN                                    GLHX1  396
                <lp;3WayGPM> = <lp;3WayGPM> + <CWDESGPMS>                       GLHX1  397
              ELSE                                                              GLHX1  398
c              for condenser in series with water-side econo, deduct            GLHX1  399
c              water already accounted for by wse                               GLHX1  400
                <lp;3WayGPM> = <lp;3WayGPM>+<CWDESGPMS>-<WSE_COIL_GPM>          GLHX1  401
              ENDIF                                                             GLHX1  402
            ELSE                                                                GLHX1  403
c              water flows only when unit is cycled on                          GLHX1  404
              IF (<COOL-FT-MIN> .LT. <lp;COIL_EWT>)  THEN                       PV2      1
                <lp;2WayGPM> = <lp;2WayGPM> + <CW_COIL_GPM>                     PV2      2
              ELSE                                                              PV2      3
c                 adjust flow for minimum allowable CW temperature              PV2      4
                GPMr = <CW-COIL-DT>                                             PV2      5
     &               / (<COOL-FT-MIN>-<lp;COIL_EWT> + <CW-COIL-DT>)             PV2      6
                <lp;2WayGPM> = <lp;2WayGPM> + <CW_COIL_GPM>*GPMr                PV2      7
              ENDIF                                                             PV2      8
            ENDIF                                                               GLHX1  406
c              estimate the fraction of the hour the loop runs                  GLHX1  407
            PLR = MIN(1., <CW_COIL_GPM> / <CWDESGPMS>)                          GLHX1  408
            <lp;RUN_FRACTION> = RunFrac(PLR)                                    GLHX1  409
          ENDIF                                                                 GLHX1  410
        ENDIF                                                                   GLHX1  411
c              central water-side economizer                                    GLHX1  412
        IF (<WSE-LOOP> .EQ. Jlp)  THEN                                          GLHX1  413
c              sum the loop flow                                                GLHX1  414
          IF (<lp;RUNNING> .GT. 0)  THEN                                        GLHX1  415
            IF (<WSE-VALVE-TYPE> .EQ. 3)  THEN                                  GLHX1  416
c              3-way valve                                                      GLHX1  417
              GPMR         = 1.0                                                GLHX1  418
              <lp;3WayGPM> = <lp;3WayGPM> + <WSEDESGPMS>*GPMR                   GLHX1  419
            ELSE                                                                GLHX1  420
              GPMR         = <WSE_COIL_GPM> / <WSEDESGPMS>                      GLHX1  421
              <lp;2WayGPM> = <lp;2WayGPM> + <WSEDESGPMS>*GPMR                   GLHX1  422
            ENDIF                                                               GLHX1  423
            IF (GPMR .GT. 0.)  <lp;RUN_FRACTION> = 1.0                          GLHX1  424
c              wse may be on same loop as cw, or different                      GLHX1  425
            IF (Jlp .NE. <CW-LOOP>  .OR.  <CW_COIL_Q> .EQ. 0.)  THEN            GLHX1  426
              CoilHead = MAX(CoilHead, <WSE-COIL-HEAD>*GPMR**1.8)               GLHX1  427
c              on same loop                                                     GLHX1  428
            ELSE                                                                GLHX1  429
c              when condenser is on, flow is in series, and must                GLHX1  430
c              be maximum (otherwise, wse could handle entire load)             GLHX1  431
              CoilHead = MAX(CoilHead, <CW-COIL-HEAD>+<WSE-COIL-HEAD>)          GLHX1  432
            ENDIF                                                               GLHX1  433
          ENDIF                                                                 GLHX1  434
        ENDIF                                                                   GLHX1  435
c              central water-cooled refrigeration equipment                     GLHX1  436
        IF (<REFG-CW-LOOP> .EQ. Jlp)  THEN                                      GLHX1  437
c              sum the loop flow                                                GLHX1  438
          IF (<lp;RUNNING> .GT. 0)  THEN                                        GLHX1  439
            IF (<REFG_COIL_GPM> .GT. 0.)  THEN                                  GLHX1  440
c                 condenser head always constant when running                   GLHX1  441
              CoilHead = MAX(CoilHead, <REFG-COIL-HEAD>)                        GLHX1  442
              <REFG_COIL_GPM> = MAX(<REFG_COIL_GPM>,<REFGDESGPMST>*0.01)        GLHX1  443
            ENDIF                                                               GLHX1  444
            IF (<REFG-VALVE-TYPE> .EQ. 3)  THEN                                 GLHX1  445
c              unit has no condenser valve, or 3-way                            GLHX1  446
              <lp;3WayGPM> = <lp;3WayGPM> + <REFGDESGPMST>                      GLHX1  447
            ELSE                                                                GLHX1  448
c              water flows only when unit is cycled on                          GLHX1  449
              <lp;2WayGPM> = <lp;2WayGPM> + <REFG_COIL_GPM>                     GLHX1  450
            ENDIF                                                               GLHX1  451
c                estimate the fraction of the hour the loop runs                GLHX1  452
            PLR = MIN(1., <REFG_COIL_GPM> / <REFGDESGPMST>)                     GLHX1  453
            <lp;RUN_FRACTION> = RunFrac(PLR)                                    GLHX1  454
          ENDIF                                                                 GLHX1  455
        ENDIF                                                                   GLHX1  456
c                                                                               GLHX1  457
c              now loop through the zones.  skip if no zones have loops         GLHX1  458
        IF (<ZONE_LOOP_FLAG> .EQ. 0)  CYCLE                                     GLHX1  459
        ISZ = <ISZONES>                                                         GLHX1  460
        NSZ = <NZONES>                                                          GLHX1  461
        DO  NZ=1,NSZ                                                            GLHX1  462
          ZP1 = ISZ + (NZ-1)*NZD                                                GLHX1  463
          ZP2 = <ZP2>                                                           GLHX1  464
c              only conditioned zones or plenums have coils                     GLHX1  465
          IF (<ZONE-TYPE> .NE. 2)  THEN                                         GLHX1  466
            Zmult = <MULTIPLIER>                                                GLHX1  467
c              zone hot water coil                                              GLHX1  468
            IF (<HW-LOOPZ> .EQ. Jlp)  THEN                                      GLHX1  469
              IF (<HW-VALVE-TYPEZ> .EQ. 3)  THEN                                GLHX1  470
c              3-way valve                                                      GLHX1  471
                IF (<lp;RUNNING> .GT. 0)  THEN                                  GLHX1  472
                  <lp;3WayGPM> = <lp;3WayGPM> + <HWDESGPMZ>*Zmult               GLHX1  473
                  CoilHead     = MAX(CoilHead, <HW-COIL-HEADZ>)                 GLHX1  474
                ENDIF                                                           GLHX1  475
              ELSEIF (<COIL_QZ> .LT. 0.)  THEN                                  GLHX1  476
c              2-way valve with a load                                          GLHX1  477
                IF (ICODE .LT. 6  .OR.  ICODE .GT. 8)  THEN                     GLHX1  478
c              normalized temperature between EAT and EWT                       GLHX1  479
                  DTR = (<COIL_EDBZ> - <lp;COIL_EWT>) / <HWDESDTZ>              GLHX1  480
                  DTR = MIN(1.5, MAX(DTR, 0.1) )                                RetLoss  3
c              cfm ratio - interpolate to zero below ratio of 0.3               GLHX1  482
                  CFMR  = <COIL_CFMZ> / (<zn;HW_DES_CFM>*<COIL_CYCLEZ>)         GLHX1  483
                  CFMR  = Min(1.4, CFMR)                                        -041N    3
                  CFMRR = 1.0                                                   GLHX1  484
                  IF (CFMR .LT. CFMRMIN)  THEN                                  GLHX1  485
                    CFMRR = CFMR / CFMRMIN                                      GLHX1  486
                    CFMR  = CFMRMIN                                             GLHX1  487
                  ENDIF                                                         GLHX1  488
c              capacity ratio - do not let coil operate at .gt. 100%            GLHX1  489
                  CAPR = <COIL_QZ> / (<HEATCAPZ>                                GLHX1  490
     &                                 * CFMRR * <COIL_CYCLEZ>                  GLHX1  491
     &                                 * CVAL(<HW-CAP-FCFM>,CFMR,CFMR)          GLHX1  492
     &                                 * CVAL(<HW-CAP-FDT>,DTR,DTR) )           GLHX1  493
                  Call CheckCapR                                                -048    90
c              interpolate if capacity corresponds to a GPM .lt. 30%            GLHX1  495
                  IF (CAPR .LT. <HWGPMMINCAP>)  THEN                            GLHX1  496
                    GPMR = 0.3 * CAPR/<HWGPMMINCAP>                             GLHX1  497
                  ELSE                                                          GLHX1  498
c              pointer to CAP = f(GPMR) curve                                   GLHX1  499
                    Jcv = <HW-CAP-FGPM>                                         -045b   14
                    CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 1,GPMR,Y,CAPR,           -045b   15
     &                                                  GPMLIM(1),IERR)         GLHX1  502
                  ENDIF                                                         GLHX1  503
c              loop head and flow                                               GLHX1  504
                  CoilHead = MAX(CoilHead, <HW-COIL-HEADZ>*GPMR**1.8)           GLHX1  505
                  <lp;2WayGPM> = <lp;2WayGPM>                                   GLHX1  506
     &                         + <HWDESGPMZ>*GPMR*<COIL_CYCLEZ>*Zmult           GLHX1  507
c                                                                               GLHX1  508
                ELSEIF (ICODE .EQ. 6  .OR.  ICODE .EQ. 7)  THEN                 GLHX1  509
c              flow cycles with fan in unit heater and ventilator               GLHX1  510
                  CoilHead     = MAX(CoilHead, <HW-COIL-HEADZ>)                 GLHX1  511
                  <lp;2WayGPM> = <lp;2WayGPM>                                   GLHX1  512
     &                         + <HWDESGPMZ> * <COIL_CYCLEZ>*Zmult              GLHX1  513
                ELSEIF (ICODE .EQ. 8)  THEN                                     GLHX1  514
c              floor panel system - set flow to be linear with load             GLHX1  515
                  GPMR     = MIN(1., <COIL_QZ> / <HEATCAPZ>)                    GLHX1  516
                  CoilHead = MAX(CoilHead, <HW-COIL-HEADZ>*GPMR**1.8)           GLHX1  517
                  <lp;2WayGPM> = <lp;2WayGPM> + <HWDESGPMZ>*GPMR*Zmult          GLHX1  518
                ENDIF                                                           GLHX1  519
              ENDIF  ! 3-way vs. 2-way valves                                   GLHX1  520
            ENDIF    ! loop heating coils                                       GLHX1  521
c              baseboards                                                       GLHX1  522
            IF (<BBRD-LOOPZ> .EQ. Jlp)  THEN                                    GLHX1  523
              IF (<BBRD-VALVE-TYPE> .EQ. 3)  THEN                               GLHX1  524
c              3-way valve                                                      GLHX1  525
                IF (<lp;RUNNING> .GT. 0)  THEN                                  GLHX1  526
                  <lp;3WayGPM> = <lp;3WayGPM> + <BBRDDESGPMZ>*Zmult             GLHX1  527
                  CoilHead     = MAX(CoilHead, <BBRD-COIL-HEAD>)                GLHX1  528
                ENDIF                                                           GLHX1  529
              ELSEIF (<BBRD_Q> .LT. 0.)  THEN                                   GLHX1  530
c              2-way valve with a load                                          GLHX1  531
c              normalized temperature between EAT and EWT                       GLHX1  532
                DTR = (<BBRD_EDB> - <lp;COIL_EWT>) / <BBRDDESDTZ>               GLHX1  533
                DTR = MIN(1.5, MAX(DTR, 0.1) )                                  RetLoss  4
c              cfm ratio - assume that airflow is sqrt of load ratio            GLHX1  535
                CFMR = MIN(MAX(<BBRD_Q> / <BASEBOARD-RATING>,                   GLHX1  536
     &                             CFMRMIN), 1.0)                               GLHX1  537
                CFMR = SQRT(CFMR)                                               GLHX1  538
                CFMR  = Min(1.4, CFMR)                                          -041N    4
c              cfm ratio - interpolate to zero below ratio of 0.3               GLHX1  539
                CFMRR = 1.0                                                     GLHX1  540
                IF (CFMR .LT. CFMRMIN)  THEN                                    GLHX1  541
                  CFMRR = CFMR / CFMRMIN                                        GLHX1  542
                  CFMR  = CFMRMIN                                               GLHX1  543
                ENDIF                                                           GLHX1  544
c              capacity ratio - do not let coil operate at .gt. 100%            GLHX1  545
                CAPR = <BBRD_Q> / (<BASEBOARD-RATING> * CFMRR                   GLHX1  546
     &                             * CVAL(<HW-CAP-FCFM>,CFMR,CFMR)              GLHX1  547
     &                             * CVAL(<HW-CAP-FDT>,DTR,DTR) )               GLHX1  548
                Call CheckCapR                                                  -048    91
c              interpolate if capacity corresponds to a GPM .lt. 30%            GLHX1  550
                IF (CAPR .LT. <HWGPMMINCAP>)  THEN                              GLHX1  551
                  GPMR = 0.3 * CAPR/<HWGPMMINCAP>                               GLHX1  552
                ELSE                                                            GLHX1  553
c              pointer to CAP = f(GPMR) curve                                   GLHX1  554
                  Jcv = <HW-CAP-FGPM>                                           -045b   16
                  CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 1,GPMR,Y,CAPR,             -045b   17
     &                                                  GPMLIM(1),IERR)         GLHX1  557
                ENDIF                                                           GLHX1  558
c              loop head and flow                                               GLHX1  559
                CoilHead = MAX(CoilHead, <BBRD-COIL-HEADZ>*GPMR**1.8)           GLHX1  560
                <lp;2WayGPM> = <lp;2WayGPM> + <BBRDDESGPMZ>*GPMR*Zmult          GLHX1  561
              ENDIF                                                             GLHX1  562
            ENDIF                                                               GLHX1  563
c              chilled water zone coil                                          GLHX1  564
            IF (<CHW-LOOPZ> .EQ. Jlp)  THEN                                     GLHX1  565
              IF (<CHW-VALVE-TYPEZ> .EQ. 3)  THEN                               GLHX1  566
c              3-way valve - flow already counted in hw calc for 2-pipe         GLHX1  567
                IF (<lp;RUNNING> .GT. 0                                         GLHX1  568
     &                              .AND.  <lp:TYPE> .NE. PIPE2)  THEN          GLHX1  569
                  <lp;3WayGPM> = <lp;3WayGPM> + <CHWDESGPMZ>*Zmult              GLHX1  570
                  CoilHead     = MAX(CoilHead, <CHW-COIL-HEADZ>)                GLHX1  571
                ENDIF                                                           GLHX1  572
              ELSEIF (<COIL_QZ> .GT. 0.)  THEN                                  GLHX1  573
c              2-way valve with a load                                          GLHX1  574
c              coil entering wetbulb temp                                       GLHX1  575
                EWB = MIN(73., MAX(<COIL_EWBZ>, 59.))                           GLHX1  576
c              cfm ratio - interpolate to zero below ratio of 0.3               GLHX1  577
                CFMR  = <COIL_CFMZ> / (<zn;CHW_DES_CFM> * <COIL_CYCLEZ>)        GLHX1  578
                CFMR  = Min(1.4, CFMR)                                          -041N    5
                CFMRR = 1.0                                                     GLHX1  579
                IF (CFMR .LT. CFMRMIN)  THEN                                    GLHX1  580
                  CFMRR = CFMR / CFMRMIN                                        GLHX1  581
                  CFMR  = CFMRMIN                                               GLHX1  582
                ENDIF                                                           GLHX1  583
c              capacity ratio - do not let coil operate at .gt. 100%            GLHX1  584
                CAPR = <COIL_QZ> / (<CHWCAP6544Z>                               GLHX1  585
     &                 * CFMRR * <COIL_CYCLEZ>                                  GLHX1  586
     &                 * CVAL(<CHW-CAP-FCFM>,CFMR,CFMR)                         GLHX1  587
     &                 * CVAL(<CHW-CAP-FEWBEWT>,EWB,<lp;COIL_EWT>) )            GLHX1  588
                Call CheckCapR                                                  -048    92
c              interpolate if capacity corresponds to a GPM .lt. 30%            GLHX1  590
                IF (CAPR .LT. <CHWGPMMINCAP>)  THEN                             GLHX1  591
                  GPMR = 0.3 * CAPR/<CHWGPMMINCAP>                              GLHX1  592
                ELSE                                                            GLHX1  593
c              pointer to CAP = f(GPMR) curve                                   GLHX1  594
                  Jcv = <CHW-CAP-FGPM>                                          -045b   18
                  CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 1,GPMR,Y,CAPR,             -045b   19
     &                                                   GPMLIM(1),IERR)        GLHX1  597
                ENDIF                                                           GLHX1  598
c              loop head and flow                                               GLHX1  599
                CoilHead = MAX(CoilHead, <CHW-COIL-HEADZ>*GPMR**1.8)            GLHX1  600
                <lp;2WayGPM> = <lp;2WayGPM>                                     GLHX1  601
     &                       + <CHWDESGPMZ>*GPMR*<COIL_CYCLEZ>*Zmult            GLHX1  602
              ENDIF                                                             GLHX1  603
            ENDIF                                                               GLHX1  604
c              zonal water-cooled DX or WLHP                                    GLHX1  605
            IF (<CW-LOOPZ> .EQ. Jlp)  THEN                                      GLHX1  606
c              sum the loop flow                                                GLHX1  607
              IF (<lp;RUNNING> .GT. 0)  THEN                                    GLHX1  608
c                  condenser head constant when running                         GLHX1  609
                IF (<CW_COIL_QZ> .NE. 0.)  THEN                                 -044d  128
                  CoilHead       = MAX(CoilHead, <CW-COIL-HEADZ>)               GLHX1  611
                  <CW_COIL_GPMZ> = MAX(<CW_COIL_GPMZ>, <CWDESGPMZ>*0.01)        GLHX1  612
                ENDIF                                                           GLHX1  613
                IF (<CW-VALVEZ> .EQ. No)  THEN                                  GLHX1  614
c                    unit has no condenser valve                                GLHX1  615
                  IF (Jlp .NE. <WSE-LOOPZ>)  THEN                               GLHX1  616
                    <lp;3WayGPM> = <lp;3WayGPM> + <CWDESGPMZ>*Zmult             GLHX1  617
                  ELSE                                                          GLHX1  618
c                      for condenser in series with water-side econo,           GLHX1  619
c                      deduct water already accounted for by wse                GLHX1  620
                    <lp;3WayGPM> = <lp;3WayGPM>                                 GLHX1  621
     &                           + (<CWDESGPMZ>-<WSE_COIL_GPMZ>)*Zmult          GLHX1  622
                  ENDIF                                                         GLHX1  623
                ELSE                                                            GLHX1  624
c                    water flows only when unit is cycled on                    GLHX1  625
                  IF (<COOL-FT-MIN> .LT. <lp;COIL_EWT>)  THEN                   PV2      9
                    <lp;2WayGPM> = <lp;2WayGPM> + <CW_COIL_GPMZ>*Zmult          PV2     10
                  ELSE                                                          PV2     11
c                    adjust flow for minimum allowable CW temperature           PV2     12
                    GPMr = <CW-COIL-DTZ>                                        PV2     13
     &                   / (<COOL-FT-MIN>-<lp;COIL_EWT> + <CW-COIL-DTZ>)        PV2     14
                    <lp;2WayGPM> = <lp;2WayGPM>                                 PV2     15
     &                           + <CW_COIL_GPMZ>*Zmult*GPMr                    PV2     16
                  ENDIF                                                         PV2     17
                ENDIF                                                           GLHX1  627
c                    estimate the fraction of the hour the loop runs            GLHX1  628
                PLR = MIN(1., <CW_COIL_GPMZ> / <CWDESGPMZ>)                     GLHX1  629
                iZmult = Zmult                                                  -047k   16
                DO  Nmult=1,iZmult                                              -047k   17
                  <lp;RUN_FRACTION> = RunFrac(PLR)                              GLHX1  631
                ENDDO                                                           GLHX1  632
              ENDIF                                                             GLHX1  633
            ENDIF                                                               GLHX1  634
c              zonal water-side economizer                                      GLHX1  635
            IF (<WSE-LOOPZ> .EQ. Jlp)  THEN                                     GLHX1  636
c              sum the loop flow                                                GLHX1  637
              IF (<lp;RUNNING> .GT. 0)  THEN                                    GLHX1  638
                IF (<WSE-VALVE-TYPEZ> .EQ. 3)  THEN                             GLHX1  639
c                    3-way valve                                                GLHX1  640
                  GPMR         = 1.0                                            GLHX1  641
                  <lp;3WayGPM> = <lp;3WayGPM> + <WSEDESGPMZ>*GPMR*Zmult         GLHX1  642
                ELSE                                                            GLHX1  643
                  GPMR         = <WSE_COIL_GPMZ> / <WSEDESGPMZ>                 GLHX1  644
                  <lp;2WayGPM> = <lp;2WayGPM> + <WSEDESGPMZ>*GPMR*Zmult         GLHX1  645
                ENDIF                                                           GLHX1  646
                IF (GPMR .GT. 0.)  <lp;RUN_FRACTION> = 1.0                      GLHX1  647
c              wse may be on same loop as cw, or different                      GLHX1  648
                IF (Jlp .NE. <CW-LOOPZ>                                         GLHX1  649
     &                              .OR.  <CW_COIL_QZ> .EQ. 0.)  THEN           GLHX1  650
                  CoilHead = MAX(CoilHead, <WSE-COIL-HEADZ>*GPMR**1.8)          GLHX1  651
c              on same loop                                                     GLHX1  652
                ELSE                                                            GLHX1  653
c              when condenser is on, flow is in series, and must                GLHX1  654
c              be maximum (otherwise, wse could handle entire load)             GLHX1  655
                  CoilHead = MAX(CoilHead,                                      GLHX1  656
     &                             <CW-COIL-HEADZ>+<WSE-COIL-HEADZ>)            GLHX1  657
                ENDIF                                                           GLHX1  658
              ENDIF                                                             GLHX1  659
            ENDIF                                                               GLHX1  660
c              Ice skating rink                                                 IcRink 732
            IF (<zn:ICE-RINK> .GT. 0)  THEN                                     IcRink 733
              Jir = <zn:ICE-RINK>                                               IcRink 734
              IF (<ir:BRINE-LOOP> .EQ. Jlp)  THEN                               IcRink 735
                IF (<ir:BRINE-VALVE> .EQ. 3)  THEN                              IcRink 736
c                  3-way valve                                                  IcRink 737
                  IF (<lp;RUNNING> .GT. 0)  THEN                                IcRink 738
                    <lp;3WayGPM> = <lp;3WayGPM> + <ir;MrinkDes>*Zmult           IcRink 739
                    CoilHead     = MAX(CoilHead, <ir:BRINE-HEAD>)               IcRink 740
                  ENDIF                                                         IcRink 741
                ELSEIF (<ir;Qbrine> .GT. 0.)  THEN                              IcRink 742
c                  2-way valve with a load - assumes flow linear with load      IcRink 743
                  GPMR = <ir;Qbrine> / <ir;QrinkDes>                            IcRink 744
                  GPMR = MIN(1.0, GPMR)                                         IcRink 745
c                  loop head and flow                                           IcRink 746
                  CoilHead = MAX(CoilHead, <ir:BRINE-HEAD>*GPMR**1.8)           IcRink 747
                  <lp;2WayGPM> = <lp;2WayGPM> + <ir;MrinkDes>*GPMR*Zmult        IcRink 748
                ENDIF                                                           IcRink 749
              ENDIF                                                             IcRink 750
c                  Ice skating rink, subfloor heating                           IcRink 751
              IF (<ir:SUBFLOOR-LOOP> .EQ. Jlp)  THEN                            IcRink 752
                IF (<ir:SUBFLOOR-VALV> .EQ. 3)  THEN                            IcRink 753
c                  3-way valve                                                  IcRink 754
                  IF (<lp;RUNNING> .GT. 0)  THEN                                IcRink 755
                    <lp;3WayGPM> = <lp;3WayGPM> +<ir;MsubfloorDes>*Zmult        IcRink 756
                    CoilHead     = MAX(CoilHead, <ir:SUBFLOOR-HEAD>)            IcRink 757
                  ENDIF                                                         IcRink 758
                ELSEIF (<ir;Qsubfloor> .LT. 0.)  THEN                           IcRink 759
c                  2-way valve with a load - assumes flow linear with load      IcRink 760
                  GPMR = <ir;Qsubfloor> / <ir;QsubfloorDes>                     IcRink 761
                  GPMR = MIN(1.0, GPMR)                                         IcRink 762
c                  loop head and flow                                           IcRink 763
                  CoilHead = MAX(CoilHead, <ir:SUBFLOOR-HEAD>*GPMR**1.8)        IcRink 764
                  <lp;2WayGPM> = <lp;2WayGPM>                                   IcRink 765
     &                         + <ir;MsubfloorDes>*GPMR*Zmult                   IcRink 766
                ENDIF                                                           IcRink 767
              ENDIF                                                             IcRink 768
            ENDIF  ! zn:ICE-RINK                                                IcRink 769
c              end of conditioned zone loop                                     GLHX1  661
          ENDIF                                                                 GLHX1  662
        ENDDO                                                                   GLHX1  663
c              end of systems loop                                              GLHX1  664
  100 CONTINUE                                                                  GLHX1  665
c                                                                               GLHX1  666
      <lp;DEM-SIDE_HEAD> = CoilHead                                             GLHX1  667
c                                                                               GLHX1  668
      RETURN                                                                    GLHX1  669
c                                                                               Ver44c8  8
                                                                                -048    93
      CONTAINS                                                                  -048    94
c ============== CheckCapR ==================================================== -048    95
      Subroutine CheckCapR                                                      -048    96
                                                                                Ver44c8 12
c              Check the coil capacity ratio for legal values                   Ver44c8 13
      IF (CAPR .le. 0.) THEN                                                    Ver44c8 14
        CALL MSGSIM(-1,II,II,II,II)                                             Ver44c8 15
        WRITE (IOUTPT,9101) (<lp:NAME>,II=1,8), <lp;COIL_EWT>                   Ver44c8 16
        call MessageBox( NULL, 'Suspicious loop temperature -'                  Ver44c8 17
     &  //' ABORTING'//char(0),'Loop Errors'//char(0), MB_OK                    Ver44c8 18
     &  + MB_ICONSTOP + MB_TASKMODAL )                                          Ver44c8 19
        IwinReturn = 1                                                          Ver44c8 20
        CAPR = 0.1                                                              Ver44c8 21
      ENDIF                                                                     Ver44c8 22
                                                                                Ver44c8 23
      CAPR = MIN(1.0, CAPR)                                                     Ver44c8 24
                                                                                Ver44c8 25
c              Message formats                                                  Ver44c8 28
 9101 Format(14X,'Loop: ',8A4,' has a coil curve generating'           /        Ver44c8 29
     &14X,'a negative capacity ratio.  Check the loop supply'          /        Ver44c8 30
     &14X,'temperature,',F6.0,'F, for consistency with the coil curves')        Ver44c8 31
                                                                                -048    97
      End Subroutine CheckCapR                                                  -048    98
                                                                                -048    99
      END                                                                       GLHX1  670
      SUBROUTINE LoopCoilLoad                                                   LOOPCL   2
c                                                                               LOOPCL   3
c              Sums the coil loads for all loops, and calculates                LOOPCL   4
c              the fluid temperature required by the worst case coil            LOOPCL   5
c              on a loop-by-loop basis.                                         LOOPCL   6
c                                                                               LOOPCL   7
c              Called after systems simulations are complete                    LOOPCL   8
c              by PLANT                                                         LOOPCL   9
c                                                                               LOOPCL  10
c                                                                               LOOPCL  11
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PTRSYS/ nzone , iz    , nczd  , zp2 ,         mtw  ,             -045a    1
     $                 nsys  , is    , nss   , nsp ,  ns   , icode,             HR      11
     $                 nsz   , isz   , nzd   , zp1 ,  nz   ,                    HR      12
     $                 nspace, lpr   ,                                          HR      13
     $                 nattch, iatt  ,                                          HR      14
     $                 P2, IDAYHR, IDBWBT,                                      HR      15
     $                 IRPPLT, IRPSUM, IRPSYS, IRPZON, MR1, MR2                 HR      16
      INTEGER          ZP1, ZP2, P2                                             /PTRSYS/14
c                                                                               LOOPCL  17
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
c                                                                               LOOPCL  19
      DIMENSION DTRLIM(2), EWTLIM(2)                                            LOOPCL  20
c              minimum cfm ratio for curve - interpolate below                  LOOPCL  21
      DATA CFMRMIN /0.3/                                                        LOOPCL  22
c              limits for inverse curves                                        LOOPCL  23
      DATA DTRLIM /2.0, 0.0/                                                    LOOPCL  24
      DATA EWTLIM /80., 35./                                                    LOOPCL  25
c                                                                               LOOPCL  26
c              loop thru all of the systems and zones                           LOOPCL  27
      DO 100  NS=1,NSYS                                                         LOOPCL  28
        NSP   = IS + (NS-1)*NSS                                                 LOOPCL  29
c              skip if this system not attached to any loops                    LOOPCL  30
        IF (<SYS_LOOP_FLAG> .EQ. 0)  GOTO 100                                   LOOPCL  31
        ICODE = <SYSTEM-TYPE>                                                   LOOPCL  32
c              flags to indicate standby loop operation                         LOOPCL  33
        LoopStandbyC = 0                                                        LOOPCL  34
        LoopStandbyH = 0                                                        LOOPCL  35
c              flag set if both fan and heat/cool schedule active               LOOPCL  36
        IF (<IHRONS>  .NE. 0  .AND.  <CON> .NE. 0.)  LoopStandbyC = 1           LOOPCL  37
        IF (<IHRONSh> .NE. 0  .AND.  <HON> .NE. 0.)  LoopStandbyH = 1           LOOPCL  38
c              central system coils                                             LOOPCL  39
c              first, hot water - skip if not hot water or no load              LOOPCL  40
        IF (<HW-LOOP> .GT. 0)  THEN                                             LOOPCL  41
c              hot water loop pointer                                           LOOPCL  42
          Jlp   = <HW-LOOP>                                                     LOOPCL  43
c              set loop flag for standby status                                 LOOPCL  44
          <lp;RUNNING> = <lp;RUNNING> + LoopStandbyH                            LOOPCL  45
          IF (<HT_COIL_Q> .EQ. 0.)  THEN                                        Bug40   98
c              skip                                                             Bug40   99
          ELSEIF (<HEATING-CAPACITY> .GT. -10.)  THEN                           Bug40  100
c              phantom heating load at non-existent central coil                Bug40  101
            <lp;COIL_HEAT> = <lp;COIL_HEAT> + <HT_COIL_Q>                       Bug40  102
            IF (<lp:HT-SETPT-CTRL> .EQ. LOAD)                                   Bug40  103
     &        <lp;COIL_EWT> = MAX(<lp;COIL_EWT>,<HT_COIL_EDB>+40.)              Bug40  104
          ELSE                                                                  Bug40  105
c              sum the loop load                                                LOOPCL  47
            <lp;COIL_HEAT> = <lp;COIL_HEAT> + <HT_COIL_Q>                       LOOPCL  48
c              if loop temperature is reset on coil load or loop was            LOOPCL  49
c              overloaded previous hour                                         LOOPCL  50
            IF ((<lp:HT-SETPT-CTRL> .EQ. LOAD                                   LOOPCL  51
     &                    .OR.  <lp;HCAP_RATIO> .LT. 1.)                        LOOPCL  52
     &                                      .AND.  ICODE .NE. 25)  THEN         LOOPCL  53
c              cfm ratio - interpolate to zero below ratio of 0.3               LOOPCL  54
              CFMR  = <HT_COIL_CFM> / <CFMH>                                    LOOPCL  55
              CFMR  = Min(1.4, CFMR)                                            -041N    6
              CFMRR = 1.0                                                       LOOPCL  56
              IF (CFMR .LT. CFMRMIN)  THEN                                      LOOPCL  57
                CFMRR = CFMR / CFMRMIN                                          LOOPCL  58
                CFMR  = CFMRMIN                                                 LOOPCL  59
              ENDIF                                                             LOOPCL  60
c              target hot water gpm ratio                                       LOOPCL  61
              IF (<HW-VALVE-TYPE> .EQ. 2)  THEN                                 LOOPCL  62
                GPMR = <lp:FLOW-RESET>                                          LOOPCL  63
              ELSE                                                              LOOPCL  64
                GPMR = 1.0                                                      LOOPCL  65
              ENDIF                                                             LOOPCL  66
c              capacity ratio - do not let coil operate at .gt. 100%            LOOPCL  67
              CAPR = <HT_COIL_Q> / (<HEATING-CAPACITY>                          LOOPCL  68
     &                                 * CFMRR * <HT_COIL_CYCLE>                LOOPCL  69
     &                                 * CVAL(<HW-CAP-FCFM>,CFMR,CFMR)          LOOPCL  70
     &                                 * CVAL(<HW-CAP-FGPM>,GPMR,GPMR) )        LOOPCL  71
              Call CheckCapR                                                    -048   100
c              pointer to differential temperature curve                        LOOPCL  73
c              solve for temp difference between EAT and HWS                    LOOPCL  75
              Jcv = <HW-CAP-FDT>                                                -045b   20
              CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 1,DTR,Y,CAPR,                  -045b   21
     &                                                   DTRLIM(1),IERR)        -045b   22
c              and hot water supply temp                                        LOOPCL  78
              <lp;COIL_EWT> = MAX(<lp;COIL_EWT>,                                LOOPCL  79
     &                              <HT_COIL_EDB> - DTR*<HWDESDTS>)             LOOPCL  80
            ELSEIF (ICODE .EQ. 25)  THEN                                        LOOPCL  81
c              PTGSD systems cannot have hw reset when active                   LOOPCL  82
              <lp;COIL_EWT> = MAX(<lp;COIL_EWT>,<lp:DESIGN-HEAT-T>)             Chlr1 2881
            ENDIF                                                               LOOPCL  84
          ENDIF                                                                 LOOPCL  85
          IF (<HUM_COIL_Q> .LT. 0.)  THEN                                       -035   104
c              sum the loop load                                                -035   105
            <lp;COIL_HEAT> = <lp;COIL_HEAT> + <HUM_COIL_Q>                      -035   106
c              no reset allowed when humidifier active                          -035   107
            <lp;COIL_EWT> = MAX(<lp;COIL_EWT>,<lp:DESIGN-HEAT-T>)               Chlr1 2882
          ENDIF                                                                 -035   109
        ENDIF                                                                   LOOPCL  86
c              repeat for preheat - always constant volume airflow              LOOPCL  87
        IF (<PHW-LOOP> .GT. 0)  THEN                                            LOOPCL  88
c              hot water loop pointer                                           LOOPCL  89
          Jlp  = <PHW-LOOP>                                                     LOOPCL  90
c              set loop flag for standby status                                 LOOPCL  91
          <lp;RUNNING> = <lp;RUNNING> + LoopStandbyH                            LOOPCL  92
          IF (<PHT_COIL_Q> .LT. 0.)  THEN                                       LOOPCL  93
c              sum the loop load                                                LOOPCL  94
            <lp;COIL_HEAT> = <lp;COIL_HEAT> + <PHT_COIL_Q>                      LOOPCL  95
c              if loop temperature is reset on coil load                        LOOPCL  96
            IF (<lp:HT-SETPT-CTRL> .EQ. LOAD                                    LOOPCL  97
     &                             .OR.  <lp;HCAP_RATIO> .LT. 1.)  THEN         LOOPCL  98
c              pointer to differential temperature curve                        LOOPCL  99
              IDT  = <HW-CAP-FDT>                                               LOOPCL 100
c              target hot water gpm ratio                                       LOOPCL 101
              IF (<PHW-VALVE-TYPE> .EQ. 2)  THEN                                LOOPCL 102
                GPMR = <lp:FLOW-RESET>                                          LOOPCL 103
              ELSE                                                              LOOPCL 104
                GPMR = 1.0                                                      LOOPCL 105
              ENDIF                                                             LOOPCL 106
              CAPR = <PHT_COIL_Q> / (<PREHEAT-CAPACITY>                         LOOPCL 107
     &                                 * <PHT_COIL_CYCLE>                       LOOPCL 108
     &                                 * CVAL(<HW-CAP-FGPM>,GPMR,GPMR) )        LOOPCL 109
              Call CheckCapR                                                    -048   101
              Jcv = <HW-CAP-FDT>                                                -045b   23
              CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 1,DTR,Y,CAPR,                  -045b   24
     &                                                   DTRLIM(1),IERR)        -045b   25
              <lp;COIL_EWT> = MAX(<lp;COIL_EWT>,                                LOOPCL 114
     &                                 <PHT_COIL_EDB> - DTR*<PHWDESDTS>)        LOOPCL 115
            ENDIF                                                               LOOPCL 116
          ENDIF                                                                 LOOPCL 117
        ENDIF                                                                   LOOPCL 118
c              ERV preheat coil                                                 ERV     54
        IF (<sy;ERVentilator> .GT. 0)  THEN                                     ERV     55
          Jrv = <sy;ERVentilator>                                               ERV     56
          IF (<rv;PreheatLoop> .GT. 0)  THEN                                    ERV     57
            Jlp          = <rv;PreheatLoop>                                     ERV     58
            <lp;RUNNING> = <lp;RUNNING> + LoopStandbyH                          ERV     59
            IF (<rv;Qpreheat> .LT. 0.)  THEN                                    ERV     60
c              sum the loop load                                                ERV     61
              <lp;COIL_HEAT> = <lp;COIL_HEAT> + <rv;Qpreheat>                   ERV     62
c                 if loop temperature is reset on coil load                     ERV     63
              IF (<lp:HT-SETPT-CTRL> .EQ. LOAD                                  ERV     64
     &                             .OR.  <lp;HCAP_RATIO> .LT. 1.)  THEN         ERV     65
c                 ERV preheat assumes a simple linear coil model                ERV     66
                PLR           = <rv;Qpreheat> / <rv;QpreheatDes>                ERV     67
                Treqd         = <rv;TairPreheat>+<rv:PREHEAT-IN-DT>*PLR         ERV     68
                <lp;COIL_EWT> = MAX(<lp;COIL_EWT>, Treqd)                       ERV     69
              ENDIF                                                             ERV     70
            ENDIF                                                               ERV     71
          ENDIF                                                                 ERV     72
        ENDIF                                                                   ERV     73
c              desiccant regeneration coil                                      LOOPCL 119
        IF (<DESC-LOOP> .GT. 0)  THEN                                           LOOPCL 120
c              hot water loop pointer                                           LOOPCL 121
          Jlp   = <DESC-LOOP>                                                   LOOPCL 122
c              set loop flag for standby status - note that desiccant           LOOPCL 123
c              systems use heat to provide cooling, and this quantity           LOOPCL 124
c              is summed into loop_coil_cool for end-use accounting             LOOPCL 125
          <lp;RUNNING> = <lp;RUNNING> + LoopStandbyC                            LOOPCL 126
          IF (<DESC_COIL_Q> .LT. 0.)  THEN                                      LOOPCL 127
c              sum the loop load                                                LOOPCL 128
            <lp;COIL_COOL> = <lp;COIL_COOL> + <DESC_COIL_Q>                     LOOPCL 129
c              regeneration coils cannot have hw reset when active              LOOPCL 130
            <lp;COIL_EWT>  = MAX(<lp;COIL_EWT>,<lp:DESIGN-HEAT-T>)              Chlr1 2883
          ENDIF                                                                 LOOPCL 132
        ENDIF                                                                   LOOPCL 133
c              central chilled water coil                                       LOOPCL 134
        IF (<CHW-LOOP> .GT. 0)  THEN                                            LOOPCL 135
c              chilled water loop pointer                                       LOOPCL 136
          Jlp = <CHW-LOOP>                                                      LOOPCL 137
          <lp;RUNNING> = <lp;RUNNING> + LoopStandbyC                            LOOPCL 138
          IF (<CL_COIL_Q> .GT. 1.)  THEN                                        LOOPCL 139
c              sum the loop load                                                LOOPCL 140
            <lp;COIL_COOL> = <lp;COIL_COOL> + <CL_COIL_Q>                       LOOPCL 141
c              if loop temperature is reset on coil load                        LOOPCL 142
            IF (<lp:CL-SETPT-CTRL> .EQ. LOAD                                    LOOPCL 143
     &                            .OR.  <lp;CCAP_RATIO> .LT. 1.)  THEN          LOOPCL 144
c              cfm ratio - interpolate to zero below ratio of 0.3               LOOPCL 145
              CFMR  = <CL_COIL_CFM> / <SUPPLY-CFM>                              LOOPCL 146
              CFMR  = Min(1.4, CFMR)                                            -041N    7
              CFMRR = 1.0                                                       LOOPCL 147
              IF (CFMR .LT. CFMRMIN)  THEN                                      LOOPCL 148
                CFMRR = CFMR / CFMRMIN                                          LOOPCL 149
                CFMR  = CFMRMIN                                                 LOOPCL 150
              ENDIF                                                             LOOPCL 151
c              target chilled water gpm ratio                                   LOOPCL 152
              IF (<CHW-VALVE-TYPE> .EQ. 2)  THEN                                LOOPCL 153
                GPMR = <lp:FLOW-RESET>                                          LOOPCL 154
              ELSE                                                              LOOPCL 155
                GPMR = 1.0                                                      LOOPCL 156
              ENDIF                                                             LOOPCL 157
c              capacity ratio - do not let coil operate at .gt. 100%            LOOPCL 158
              CAPR = <CL_COIL_Q> / (<CHWCAP6544S>                               LOOPCL 159
     &                                * CFMRR * <CL_COIL_CYCLE>                 LOOPCL 160
     &                                * CVAL(<CHW-CAP-FCFM>,CFMR,CFMR)          LOOPCL 161
     &                                * CVAL(<CHW-CAP-FGPM>,GPMR,GPMR) )        LOOPCL 162
              Call CheckCapR                                                    -048   102
c              solve for capacity vs. EWB and CHWS                              LOOPCL 164
              EWB  = MIN(73., MAX(<CL_COIL_EWB>, 59.))                          LOOPCL 165
c              pointer to capacity vs. EWB and EAT curve                        LOOPCL 166
              Jcv = <CHW-CAP-FEWBEWT>                                           -045b   26
              CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 2,EWB,EWT,CAPR,                -045b   27
     &                                                EWTLIM(1),IERR)           LOOPCL 169
c              and chilled water supply temp                                    LOOPCL 170
              <lp;COIL_EWT> = MIN(<lp;COIL_EWT>, EWT)                           LOOPCL 171
            ENDIF                                                               LOOPCL 172
          ENDIF                                                                 LOOPCL 173
        ENDIF                                                                   LOOPCL 174
c              water-cooled DX, or central WLHP                                 LOOPCL 175
        IF (<CW-LOOP> .GT. 0)  THEN                                             LOOPCL 176
c              cw loop pointer                                                  LOOPCL 177
          Jlp = <CW-LOOP>                                                       LOOPCL 178
          <lp;RUNNING> = <lp;RUNNING> + <IHRONS>                                LOOPCL 179
c              sum the loop load                                                LOOPCL 180
          IF (<CW_COIL_Q> .LT. 0.)  THEN                                        LOOPCL 181
            <lp;COIL_HEAT> = <lp;COIL_HEAT> + <CW_COIL_Q>                       LOOPCL 182
          ELSE                                                                  LOOPCL 183
            <lp;COIL_COOL> = <lp;COIL_COOL> + <CW_COIL_Q>                       LOOPCL 184
            IF (<lp:TYPE> .EQ. CHW)                                             PV2     18
     &        <lp;COIL_EWT> = MIN(<lp;COIL_EWT>, <COOL-FT-MIN>)                 PV2     19
          ENDIF                                                                 LOOPCL 185
        ENDIF                                                                   LOOPCL 186
c              central water-side economizer                                    LOOPCL 187
        IF (<WSE-LOOP> .GT. 0)  THEN                                            LOOPCL 188
c              wse loop pointer                                                 LOOPCL 189
          Jlp = <WSE-LOOP>                                                      LOOPCL 190
          <lp;RUNNING> = <lp;RUNNING> + <IHRONS>                                LOOPCL 191
c              sum the loop load                                                LOOPCL 192
          IF (<WSE_COIL_Q> .GT. 0.)                                             LOOPCL 193
     &      <lp;COIL_COOL> = <lp;COIL_COOL> + <WSE_COIL_Q>                      LOOPCL 194
        ENDIF                                                                   LOOPCL 195
c              water-cooled refrigeration equipment                             LOOPCL 196
        IF (<REFG-CW-LOOP> .GT. 0)  THEN                                        LOOPCL 197
c              refrigeration loop pointer                                       LOOPCL 198
          Jlp = <REFG-CW-LOOP>                                                  LOOPCL 199
          IF (<REFG_COIL_Q> .NE. 0.)  <lp;RUNNING> = <lp;RUNNING> + 1           LOOPCL 200
c              sum the loop load                                                LOOPCL 201
          IF (<REFG_COIL_Q> .LT. 0.)  THEN                                      LOOPCL 202
            <lp;COIL_HEAT> = <lp;COIL_HEAT> + <REFG_COIL_Q>                     LOOPCL 203
          ELSE                                                                  LOOPCL 204
            <lp;COIL_COOL> = <lp;COIL_COOL> + <REFG_COIL_Q>                     LOOPCL 205
          ENDIF                                                                 LOOPCL 206
        ENDIF                                                                   LOOPCL 207
c              now loop through the zones.  skip if no zones have loops         LOOPCL 208
        IF (<ZONE_LOOP_FLAG> .EQ. 0)  GOTO 100                                  LOOPCL 209
        ISZ = <ISZONES>                                                         LOOPCL 210
        NSZ = <NZONES>                                                          LOOPCL 211
        DO  NZ=1,NSZ                                                            LOOPCL 212
          ZP1 = ISZ + (NZ-1)*NZD                                                LOOPCL 213
          ZP2 = <ZP2>                                                           LOOPCL 214
c              only conditioned zones or plenums have coils                     LOOPCL 215
          IF (<ZONE-TYPE> .NE. 2)  THEN                                         LOOPCL 216
            ZMULT = <MULTIPLIER>                                                LOOPCL 217
c              hot water coils                                                  LOOPCL 218
            IF (<HW-LOOPZ> .GT. 0)  THEN                                        LOOPCL 219
c              zone coil loop pointer                                           LOOPCL 220
              Jlp = <HW-LOOPZ>                                                  LOOPCL 221
              <lp;RUNNING> = <lp;RUNNING> + LoopStandbyH                        LOOPCL 222
              IF (<COIL_QZ> .LT. 0.)  THEN                                      LOOPCL 223
c              sum the loop load                                                LOOPCL 224
                <lp;COIL_HEAT> = <lp;COIL_HEAT> + <COIL_QZ>*ZMULT               LOOPCL 225
c              if loop temperature is reset on coil load                        LOOPCL 226
                IF (( <lp:HT-SETPT-CTRL> .EQ. LOAD                              LOOPCL 227
     &                .OR.  <lp;HCAP_RATIO> .LT. 1.)                            LOOPCL 228
     &                                         .AND. ICODE .NE. 8)  THEN        LOOPCL 229
c              cfm ratio - interpolate to zero below ratio of 0.3               LOOPCL 230
                  CFMR  = <COIL_CFMZ> / <zn;HW_DES_CFM>                         LOOPCL 231
                  CFMR  = Min(1.4, CFMR)                                        -041N    8
                  CFMRR = 1.0                                                   LOOPCL 232
                  IF (CFMR .LT. CFMRMIN)  THEN                                  LOOPCL 233
                    CFMRR = CFMR / CFMRMIN                                      LOOPCL 234
                    CFMR  = CFMRMIN                                             LOOPCL 235
                  ENDIF                                                         LOOPCL 236
c              target hot water gpm ratio                                       LOOPCL 237
                  IF (<HW-VALVE-TYPEZ> .EQ. 2)  THEN                            LOOPCL 238
                    GPMR = <lp:FLOW-RESET>                                      LOOPCL 239
                  ELSE                                                          LOOPCL 240
                    GPMR = 1.0                                                  LOOPCL 241
                  ENDIF                                                         LOOPCL 242
                  CAPR = <COIL_QZ> / (<HEATCAPZ>                                LOOPCL 243
     &                                 * CFMRR * <COIL_CYCLEZ>                  LOOPCL 244
     &                                 * CVAL(<HW-CAP-FCFM>,CFMR,CFMR)          LOOPCL 245
     &                                 * CVAL(<HW-CAP-FGPM>,GPMR,GPMR) )        LOOPCL 246
                  Call CheckCapR                                                -048   103
                  Jcv = <HW-CAP-FDT>                                            -045b   28
                  CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 1,DTR,Y,CAPR,              -045b   29
     &                                                  DTRLIM(1), IERR)        LOOPCL 250
                  <lp;COIL_EWT> = MAX(<lp;COIL_EWT>,                            LOOPCL 251
     &                                   <HT_COIL_EDB> - DTR*<HWDESDTZ>)        LOOPCL 252
                ELSEIF (ICODE .EQ. 8)  THEN                                     LOOPCL 253
c              floor panel systems cannot have reset                            LOOPCL 254
                  <lp;COIL_EWT> = <lp:DESIGN-HEAT-T>                            Chlr1 2884
                ENDIF                                                           LOOPCL 256
              ENDIF                                                             LOOPCL 257
            ENDIF                                                               LOOPCL 258
c              baseboards - the following assumes that a baseboard              LOOPCL 259
c              behaves similarly to a coil, which is probably not a very        LOOPCL 260
c              good assumption.                                                 LOOPCL 261
            IF (<BBRD-LOOPZ> .GT. 0)  THEN                                      LOOPCL 262
c              baseboard loop pointer                                           LOOPCL 263
              Jlp = <BBRD-LOOPZ>                                                LOOPCL 264
              <lp;RUNNING> = <lp;RUNNING> + INT(<HON>+0.1)                      LOOPCL 265
              IF (<BBRD_Q> .LT. 0.) THEN                                        LOOPCL 266
c              sum the loop load                                                LOOPCL 267
                <lp;COIL_HEAT> = <lp;COIL_HEAT> + <BBRD_Q>*ZMULT                LOOPCL 268
c              if loop temperature is reset on coil load                        LOOPCL 269
                IF (<lp:HT-SETPT-CTRL> .EQ. LOAD                                LOOPCL 270
     &                            .OR.  <lp;HCAP_RATIO> .LT. 1.)  THEN          LOOPCL 271
c              cfm ratio - assume that airflow is sqrt of load ratio            LOOPCL 272
                  CFMR = MIN(MAX(CFMRMIN,                                       LOOPCL 273
     &                               <BBRD_Q>/<BASEBOARD-RATING>), 1.0)         LOOPCL 274
                  CFMR = SQRT(CFMR)                                             LOOPCL 275
                  CFMR  = Min(1.4, CFMR)                                        -041N    9
c              cfm ratio - interpolate to zero below ratio of 0.3               LOOPCL 276
                  CFMRR = 1.0                                                   LOOPCL 277
                  IF (CFMR .LT. CFMRMIN)  THEN                                  LOOPCL 278
                    CFMRR = CFMR / CFMRMIN                                      LOOPCL 279
                    CFMR  = CFMRMIN                                             LOOPCL 280
                  ENDIF                                                         LOOPCL 281
c              target hot water gpm ratio                                       LOOPCL 282
                  IF (<HW-VALVE-TYPEZ> .EQ. 2)  THEN                            LOOPCL 283
                    GPMR = <lp:FLOW-RESET>                                      LOOPCL 284
                  ELSE                                                          LOOPCL 285
                    GPMR = 1.0                                                  LOOPCL 286
                  ENDIF                                                         LOOPCL 287
c              capacity ratio                                                   LOOPCL 288
                  CAPR = <BBRD_Q> / (<BASEBOARD-RATING> * CFMRR                 LOOPCL 289
     &                                 * CVAL(<HW-CAP-FCFM>,CFMR,CFMR)          LOOPCL 290
     &                                 * CVAL(<HW-CAP-FGPM>,GPMR,GPMR) )        LOOPCL 291
                  Call CheckCapR                                                -048   104
                  Jcv = <HW-CAP-FDT>                                            -045b   30
                  CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 1,DTR,Y,CAPR,              -045b   31
     &                                                  DTRLIM(1), IERR)        LOOPCL 295
                  <lp;COIL_EWT> = MAX(<lp;COIL_EWT>,                            LOOPCL 296
     &                                  (<BBRD_EDB> - DTR*<BBRDDESDTZ>))        LOOPCL 297
                ENDIF                                                           LOOPCL 298
              ENDIF                                                             LOOPCL 299
            ENDIF                                                               LOOPCL 300
c              chilled water zone coils                                         LOOPCL 301
            IF (<CHW-LOOPZ> .GT. 0)  THEN                                       LOOPCL 302
c              chilled water loop pointer                                       LOOPCL 303
              Jlp = <CHW-LOOPZ>                                                 LOOPCL 304
              <lp;RUNNING> = <lp;RUNNING> + LoopStandbyC                        LOOPCL 305
              IF (<COIL_QZ> .GT. 0.)  THEN                                      LOOPCL 306
c              sum the loop load                                                LOOPCL 307
                <lp;COIL_COOL> = <lp;COIL_COOL> + <COIL_QZ>*ZMULT               LOOPCL 308
c              if loop temperature is reset on coil load                        LOOPCL 309
                IF (<lp:CL-SETPT-CTRL> .EQ. LOAD                                LOOPCL 310
     &                            .OR.  <lp;CCAP_RATIO> .LT. 1.)  THEN          LOOPCL 311
c              cfm ratio - interpolate to zero below ratio of 0.3               LOOPCL 312
                  CFMR  = <COIL_CFMZ> / <zn;CHW_DES_CFM>                        LOOPCL 313
                  CFMR  = Min(1.4, CFMR)                                        -041N   10
                  CFMRR = 1.0                                                   LOOPCL 314
                  IF (CFMR .LT. CFMRMIN)  THEN                                  LOOPCL 315
                    CFMRR = CFMR / CFMRMIN                                      LOOPCL 316
                    CFMR  = CFMRMIN                                             LOOPCL 317
                  ENDIF                                                         LOOPCL 318
c              target chilled water gpm ratio                                   LOOPCL 319
                  IF (<CHW-VALVE-TYPEZ> .EQ. 2)  THEN                           LOOPCL 320
                    GPMR = <lp:FLOW-RESET>                                      LOOPCL 321
                  ELSE                                                          LOOPCL 322
                    GPMR = 1.0                                                  LOOPCL 323
                  ENDIF                                                         LOOPCL 324
c              capacity ratio - do not let coil operate at .gt. 100%            LOOPCL 325
                  CAPR = <COIL_QZ> / (<CHWCAP6544Z>                             LOOPCL 326
     &                                * CFMRR * <COIL_CYCLEZ>                   LOOPCL 327
     &                                * CVAL(<CHW-CAP-FCFM>,CFMR,CFMR)          LOOPCL 328
     &                                * CVAL(<CHW-CAP-FGPM>,GPMR,GPMR) )        LOOPCL 329
                  Call CheckCapR                                                -048   105
c              solve for capacity vs. EWB and CHWS                              LOOPCL 331
                  EWB  = MIN(73., MAX(<COIL_EWBZ>, 59.))                        LOOPCL 332
c              pointer to capacity vs. EWB and EAT curve                        LOOPCL 333
                  Jcv = <CHW-CAP-FEWBEWT>                                       -045b   32
                  CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 2,EWB,EWT,CAPR,            -045b   33
     &                                                  EWTLIM(1),IERR)         LOOPCL 336
                  <lp;COIL_EWT> = MIN(<lp;COIL_EWT>, EWT)                       LOOPCL 337
                ENDIF                                                           LOOPCL 338
              ENDIF                                                             LOOPCL 339
            ENDIF                                                               LOOPCL 340
c              zonal wlhp or water-cooled DX                                    LOOPCL 341
            IF (<CW-LOOPZ> .NE. 0.)  THEN                                       LOOPCL 342
c              cw loop pointer                                                  LOOPCL 343
              Jlp = <CW-LOOPZ>                                                  LOOPCL 344
              <lp;RUNNING> = <lp;RUNNING> + <IHRONS>                            LOOPCL 345
c              sum the loop load                                                LOOPCL 346
              IF (<CW_COIL_QZ> .LT. 0.)  THEN                                   LOOPCL 347
                <lp;COIL_HEAT> = <lp;COIL_HEAT> + <CW_COIL_QZ>*ZMULT            LOOPCL 348
              ELSE                                                              LOOPCL 349
                <lp;COIL_COOL> = <lp;COIL_COOL> + <CW_COIL_QZ>*ZMULT            LOOPCL 350
                IF (<lp:TYPE> .EQ. CHW)                                         PV2     20
     &            <lp;COIL_EWT> = MIN(<lp;COIL_EWT>, <COOL-FT-MIN>)             PV2     21
              ENDIF                                                             LOOPCL 351
            ENDIF                                                               LOOPCL 352
                                                                                LOOPCL 353
c              zonal water-side economizer                                      LOOPCL 354
            IF (<WSE-LOOPZ> .GT. 0)  THEN                                       LOOPCL 355
c              wse loop pointer                                                 LOOPCL 356
              Jlp = <WSE-LOOPZ>                                                 LOOPCL 357
              <lp;RUNNING> = <lp;RUNNING> + <IHRONS>                            LOOPCL 358
c              sum the loop load                                                LOOPCL 359
              IF (<WSE_COIL_QZ> .GT. 0.)                                        LOOPCL 360
     &          <lp;COIL_COOL> = <lp;COIL_COOL>                                 LOOPCL 361
     &                         + <WSE_COIL_QZ>*ZMULT                            LOOPCL 362
            ENDIF                                                               LOOPCL 363
c              Ice skating rink                                                 IcRink 770
            IF (<zn:ICE-RINK> .GT. 0)  THEN                                     IcRink 771
              Jir = <zn:ICE-RINK>                                               IcRink 772
              IF (<ir:BRINE-LOOP> .GT. 0)  THEN                                 IcRink 773
c                 brine loop pointer                                            IcRink 774
                Jlp = <ir:BRINE-LOOP>                                           IcRink 775
                <lp;RUNNING> = <lp;RUNNING> + 1                                 IcRink 776
                IF (<ir;Qbrine> .GT. 0.)  THEN                                  IcRink 777
c                   sum the loop load                                           IcRink 778
                  <lp;COIL_COOL> = <lp;COIL_COOL> + <ir;Qbrine>*Zmult           IcRink 779
c                   if loop temperature is reset on coil load                   IcRink 780
                  IF (<lp:CL-SETPT-CTRL> .EQ. LOAD)  THEN                       IcRink 781
                    dT = <ir:RINK-BRINE-DT> * <ir;Qbrine>/<ir;QrinkDes>         IcRink 782
                    <lp;COIL_EWT> = MIN(<lp;COIL_EWT>, <ir;Trink>-dT)           IcRink 783
                  ENDIF                                                         IcRink 784
                ENDIF                                                           IcRink 785
              ENDIF                                                             IcRink 786
              IF (<ir:SUBFLOOR-LOOP> .GT. 0)  THEN                              IcRink 787
c                 subfloor HW loop                                              IcRink 788
                Jlp = <ir:SUBFLOOR-LOOP>                                        IcRink 789
                <lp;RUNNING> = <lp;RUNNING> + 1                                 IcRink 790
                IF (<ir;Qsubfloor> .LT. 0.)  THEN                               IcRink 791
c                   sum the loop load                                           IcRink 792
                  <lp;COIL_HEAT> = <lp;COIL_HEAT> + <ir;Qsubfloor>*Zmult        IcRink 793
c                   if loop temperature is reset on coil load                   IcRink 794
                  IF (<lp:HT-SETPT-CTRL> .EQ. LOAD)  THEN                       IcRink 795
                    dT = <ir:RINK-SBFLR-DT>                                     IcRink 796
     &                                * <ir;Qsubfloor>/<ir;QsubfloorDes>        IcRink 797
                    <lp;COIL_EWT> = MAX(<lp;COIL_EWT>,                          IcRink 798
     &                                  <ir:SUBFLOOR-SETP>+dT)                  IcRink 799
                  ENDIF                                                         IcRink 800
                ENDIF                                                           IcRink 801
              ENDIF                                                             IcRink 802
            ENDIF  ! zn:ICE-RINK                                                IcRink 803
          ENDIF                                                                 LOOPCL 364
c              end of zone loop                                                 LOOPCL 365
        ENDDO                                                                   LOOPCL 366
c              end of systems loop                                              LOOPCL 367
  100 CONTINUE                                                                  LOOPCL 368
c                                                                               LOOPCL 369
      RETURN                                                                    LOOPCL 370
c                                                                               Ver44c8 39
                                                                                -048   106
      CONTAINS                                                                  -048   107
c ============== CheckCapR ==================================================== -048   108
      Subroutine CheckCapR                                                      -048   109
                                                                                Ver44c8 43
c              Check the coil capacity ratio for legal values                   Ver44c8 44
      IF (CAPR .le. 0.) THEN                                                    Ver44c8 45
        CALL MSGSIM(-1,II,II,II,II)                                             Ver44c8 46
        WRITE (IOUTPT,9101) (<lp:NAME>,II=1,8), <lp;COIL_EWT>                   Ver44c8 47
        call MessageBox( NULL, 'Suspicious loop temperature -'                  Ver44c8 48
     &  //' ABORTING'//char(0),'Loop Errors'//char(0), MB_OK                    Ver44c8 49
     &  + MB_ICONSTOP + MB_TASKMODAL )                                          Ver44c8 50
        IwinReturn = 1                                                          Ver44c8 51
        CAPR = 0.1                                                              Ver44c8 52
      ENDIF                                                                     Ver44c8 53
                                                                                Ver44c8 54
      CAPR = MIN(1.0, CAPR)                                                     Ver44c8 55
                                                                                Ver44c8 56
c              Message formats                                                  Ver44c8 59
 9101 Format(14X,'Loop: ',8A4,' has a coil curve generating'           /        Ver44c8 60
     &14X,'a negative capacity ratio.  Check the loop supply'          /        Ver44c8 61
     &14X,'temperature,',F6.0,'F, for consistency with the coil curves')        Ver44c8 62
                                                                                -048   110
      End Subroutine CheckCapR                                                  -048   111
                                                                                -048   112
      END                                                                       LOOPCL 371
      SUBROUTINE LoopPrimLoads                                                  LOOPPL   2
c                                                                               LOOPPL   3
c              Sums the loads on a loop arising from primary equipment.         LOOPPL   4
c              Currently, only chiller heat rejection is implemented            LOOPPL   5
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               LOOPPL   9
c              Primary loop                                                     LOOPPL  10
      Call EquipLoads                                                           -048   113
c                                                                               LOOPPL  12
c              Attached secondary loops                                         LOOPPL  13
      IF (<lp;NUM_2ND_LOOPS> .GT. 0)  THEN                                      LOOPPL  14
        Jlp1 = Jlp                                                              LOOPPL  15
        N2nd = <lp;NUM_2ND_LOOPS>                                               LOOPPL  16
        DO  L2=1,N2nd                                                           LOOPPL  17
          Jlp = <lp;PTR_2ND_LOOPS>                                              LOOPPL  18
          Call EquipLoads                                                       -048   114
          Jlp = Jlp1                                                            LOOPPL  20
        ENDDO                                                                   LOOPPL  21
      ENDIF                                                                     LOOPPL  22
c                                                                               LOOPPL  23
      RETURN                                                                    LOOPPL  24
c                                                                               LOOPPL  25
c                                                                               LOOPPL  26
      CONTAINS                                                                  -048   115
c ============== EquipLoads =================================================== -048   116
      Subroutine EquipLoads                                                     -048   117
c                                                                               LOOPPL  29
c                                                                               LOOPPL  35
c              Chillers                                                         LOOPPL  36
      DO  Neq=1,Nch                                                             LOOPPL  37
        Jch = Ich + (Neq-1)*Lch                                                 LOOPPL  38
        IF (<ch:CW-LOOP> .EQ. Jlp  .AND.  <ch;CWflow> .GT. 0.)  THEN            LOOPPL  39
          <lp;PRIM_HTREJ> = <lp;PRIM_HTREJ> + <ch;CWload>                       LOOPPL  40
          <lp;PRIM_GPM>   = <lp;PRIM_GPM>   + <ch;CWflow>                       LOOPPL  41
          IF (<ch:CW-PUMP> .EQ. 0)  THEN                                        LOOPPL  42
            <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,    <ch;CWhead>)        LOOPPL  43
            <lp;DEM-SIDE_STAT> = MAX(<lp;DEM-SIDE_STAT>, <ch:CW-STATIC>)        LOOPPL  44
          ENDIF                                                                 LOOPPL  45
        ENDIF                                                                   LOOPPL  46
      ENDDO                                                                     LOOPPL  47
c                                                                               LOOPPL  48
      End Subroutine EquipLoads                                                 -048   118
c                                                                               LOOPPL  50
      END                                                                       LOOPPL  51
      SUBROUTINE LOOPdes                                                        LOOPd    2
c                                                                               LOOPd    3
c              Design calculations for the circulation loops.                   LOOPd    4
c                                                                               LOOPd    5
c              This routine is called repeatedly from PLANTd for each           LOOPd    6
c              type of loop, and each loop of that type.  Secondary             LOOPd    7
c              loops are set up first, followed by primary loops.               LOOPd    8
c                                                                               LOOPd    9
c              Most loops have only one type of demand, such as heating or      LOOPd   10
c              cooling.  However, 2-pipe systems have heating and cooling       LOOPd   11
c              on the same loop, and WLHP's have heating and heat rejection     LOOPd   12
c              on the same loop.  For this reason, Qlooph and Qloopc            LOOPd   13
c              keep separate track of these quantities.                         LOOPd   14
c                                                                               LOOPd   15
c                                                                               LOOPd   16
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /DESDAT/ ZCFM,ICFM,ZVENT,C1,IFLAG                                 /DESDAT/ 2
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /LOOP  / Nloop(16,2), NextType(40), NLP2,                         -41a     1
     &                 WLHPoff, RealCall, RegenFlag, Sim2x, LoopSimCount        ChlrHP   2
      LOGICAL          WLHPoff, RealCall, RegenFlag, Sim2x                      ChlrHP   3
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PTRSYS/ nzone , iz    , nczd  , zp2 ,         mtw  ,             -045a    1
     $                 nsys  , is    , nss   , nsp ,  ns   , icode,             HR      11
     $                 nsz   , isz   , nzd   , zp1 ,  nz   ,                    HR      12
     $                 nspace, lpr   ,                                          HR      13
     $                 nattch, iatt  ,                                          HR      14
     $                 P2, IDAYHR, IDBWBT,                                      HR      15
     $                 IRPPLT, IRPSUM, IRPSYS, IRPZON, MR1, MR2                 HR      16
      INTEGER          ZP1, ZP2, P2                                             /PTRSYS/14
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /REPORT/ IREPRT(4,37),IPRG,IUNIQV(100),IUNIQS(100),IUNIQL         /REPORT/ 2
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               LOOPd   30
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
c                                                                               LOOPd   33
       LOGICAL DefaultFound                                                     LOOPd   34
c              default loop names found in BDLLIB                               LOOPd   35
       INTEGER DefaultNames(8,9), SubType                                       LOOPd   36
       DATA    DefaultNames                                                     LOOPd   37
     1   / 4HDEFA,4HULT-,4HCHW ,4H    ,4H    ,4H    ,4H    ,4H    ,             LOOPd   38
     2     4H    ,4H    ,4H    ,4H    ,4H    ,4H    ,4H    ,4H    ,             LOOPd   39
     3     4H    ,4H    ,4H    ,4H    ,4H    ,4H    ,4H    ,4H    ,             LOOPd   40
     4     4HDEFA,4HULT-,4HHW  ,4H    ,4H    ,4H    ,4H    ,4H    ,             LOOPd   41
     5     4H    ,4H    ,4H    ,4H    ,4H    ,4H    ,4H    ,4H    ,             LOOPd   42
     6     4H    ,4H    ,4H    ,4H    ,4H    ,4H    ,4H    ,4H    ,             LOOPd   43
     7     4HDEFA,4HULT-,4HWLHP,4H    ,4H    ,4H    ,4H    ,4H    ,             LOOPd   44
     8     4HDEFA,4HULT-,4HDHW ,4H    ,4H    ,4H    ,4H    ,4H    ,             LOOPd   45
     9     4HDEFA,4HULT-,4HCW  ,4H    ,4H    ,4H    ,4H    ,4H    /             LOOPd   46
c                                                                               LOOPd   47
c                                                                               LOOPd   53
      LoopType = <lp:TYPE>                                                      LOOPd   54
      SubType  = <lp:SUBTYPE>                                                   LOOPd   55
c                                                                               LOOPd   56
      IF (<lp:OPERATION> .EQ. SubhourDemand  .AND.                              GLHX1  671
     &    LoopType .NE. WLHP  .AND.  LoopType .NE. CW)  THEN                    GLHX1  672
        CALL MSGSIM(-2,II,II,II,II)                                             GLHX1  673
        WRITE (IOUTPT,9119)  (<lp:NAME>,II=1,8)                                 GLHX1  674
        <lp:OPERATION> = DEMAND                                                 GLHX1  675
      ENDIF                                                                     GLHX1  676
c              2-Pipe and WLHP loops cannot snap on according to a              -041k    5
c              temperature; reset to Demand                                     -041k    6
      IF (<lp:OPERATION> .eq. Snap  .and.                                       -041k    7
     &    (LoopType .eq. PIPE2  .or.  LoopType .eq. WLHP))                      -041k    8
     &    <lp:OPERATION> = Demand                                               -041k    9
c              check the zone specification for the SNAP-ZONE                   -041k   10
      IF (<lp:SNAP-LOCN> .eq. Zone)  THEN                                       -041k   11
        IF (<lp:SNAP-ZONE> .GT. 0)  THEN                                        LOOPd   59
c              check if this zone is on this loop                               LOOPd   60
          ISNAP = <lp:SNAP-ZONE>                                                LOOPd   61
          Iok   = 1                                                             LOOPd   62
          DO  NS=1,NSYS                                                         LOOPd   63
            NSP = IS + (NS-1)*NSS                                               LOOPd   64
            ISZ = <ISZONES>                                                     LOOPd   65
            NSZ = <NZONES>                                                      LOOPd   66
            DO  NZ=1,NSZ                                                        LOOPd   67
              ZP1 = ISZ + (NZ-1)*NZD                                            LOOPd   68
              IF (ZP1 .EQ. ISNAP)  THEN                                         LOOPd   69
                ZP2 = <ZP2>                                                     LOOPd   70
                IF (<ZONE-TYPE> .NE. 1)  THEN                                   LOOPd   71
                  Iok = 0                                                       LOOPd   72
                ELSE                                                            LOOPd   73
                  IF (LoopType .EQ. CHW)  THEN                                  LOOPd   74
                    IF (<CHW-LOOP> .NE. Jlp  .AND.                              LOOPd   75
     &                  <CHW-LOOPZ> .NE. Jlp )   Iok = 0                        LOOPd   76
                  ELSEIF (LoopType .EQ. CW  .OR.                                LOOPd   77
     &                    LoopType .EQ. WLHP)  THEN                             LOOPd   78
                    IF (<CW-LOOP>  .NE. Jlp  .AND.                              LOOPd   79
     &                 <WSE-LOOP>  .NE. Jlp  .AND.                              LOOPd   80
     &                  <CW-LOOPZ> .NE. Jlp  .AND.                              LOOPd   81
     &                 <WSE-LOOPZ> .NE. Jlp )    Iok = 0                        LOOPd   82
                  ELSEIF (LoopType .EQ. PIPE2)  THEN                            LOOPd   83
                    IF (<HW-LOOP>  .NE. Jlp  .AND.                              LOOPd   84
     &                 <CHW-LOOP>  .NE. Jlp  .AND.                              LOOPd   85
     &                <BBRD-LOOP>  .NE. Jlp  .AND.                              LOOPd   86
     &                  <HW-LOOPZ> .NE. Jlp  .AND.                              LOOPd   87
     &                 <CHW-LOOPZ> .NE. Jlp  .AND.                              LOOPd   88
     &                <BBRD-LOOPZ> .NE. Jlp )    Iok = 0                        LOOPd   89
                  ELSEIF (LoopType .EQ. HW  .OR.                                LOOPd   90
     &                    LoopType .EQ. STM)  THEN                              LOOPd   91
                    IF (<HW-LOOP>  .NE. Jlp  .AND.                              LOOPd   92
     &                <BBRD-LOOP>  .NE. Jlp  .AND.                              LOOPd   93
     &                  <HW-LOOPZ> .NE. Jlp  .AND.                              LOOPd   94
     &                <BBRD-LOOPZ> .NE. Jlp )    Iok = 0                        LOOPd   95
                  ENDIF                                                         LOOPd   96
                ENDIF                                                           LOOPd   97
              ENDIF                                                             LOOPd   98
            ENDDO                                                               LOOPd   99
          ENDDO                                                                 LOOPd  100
          IF (Iok .EQ. 0)  THEN                                                 LOOPd  101
            CALL MSGSIM(-3,II,II,II,II)                                         LOOPd  102
            WRITE (IOUTPT, 9112) (<lp:NAME>,II=1,8),                            LOOPd  103
     &                           (<ZONE-NAME>,II=1,8)                           LOOPd  104
          ENDIF                                                                 LOOPd  105
        ELSE                                                                    LOOPd  106
c              not specified - default SNAP-ZONE to first conditioned           LOOPd  107
c              zone found on this loop                                          LOOPd  108
          DO  NS=1,NSYS                                                         LOOPd  109
            NSP = IS + (NS-1)*NSS                                               LOOPd  110
            ISZ = <ISZONES>                                                     LOOPd  111
            NSZ = <NZONES>                                                      LOOPd  112
            DO  NZ=1,NSZ                                                        LOOPd  113
              ZP1 = ISZ + (NZ-1)*NZD                                            LOOPd  114
              ZP2 = <ZP2>                                                       LOOPd  115
              IF (<ZONE-TYPE> .EQ. 1  .AND.                                     LOOPd  116
     &           ( <HW-LOOP>  .EQ. Jlp  .OR.  <CHW-LOOP>  .EQ. Jlp  .OR.        LOOPd  117
     &             <CW-LOOP>  .EQ. Jlp  .OR. <BBRD-LOOP>  .EQ. Jlp  .OR.        LOOPd  118
     &            <WSE-LOOP>  .EQ. Jlp  .OR.                                    LOOPd  119
     &             <HW-LOOPZ> .EQ. Jlp  .OR.  <CHW-LOOPZ> .EQ. Jlp  .OR.        LOOPd  120
     &             <CW-LOOPZ> .EQ. Jlp  .OR. <BBRD-LOOPZ> .EQ. Jlp  .OR.        LOOPd  121
     &            <WSE-LOOPZ> .EQ. Jlp  ))  THEN                                LOOPd  122
                CALL MSGSIM(-3,II,II,II,II)                                     LOOPd  123
                WRITE (IOUTPT, 9109) (<lp:NAME>,II=1,8),                        LOOPd  124
     &                               (<ZONE-NAME>,II=1,8)                       LOOPd  125
                <lp:SNAP-ZONE> = ZP1                                            LOOPd  126
                GOTO 10                                                         LOOPd  127
              ENDIF                                                             LOOPd  128
            ENDDO                                                               LOOPd  129
          ENDDO                                                                 LOOPd  130
          CALL MSGSIM(-1,II,II,II,II)                                           LOOPd  131
          WRITE (IOUTPT,9110)  (<lp:NAME>,II=1,8)                               LOOPd  132
          IFLAG = 1                                                             LOOPd  133
        ENDIF                                                                   LOOPd  134
      ENDIF                                                                     LOOPd  135
   10 CONTINUE                                                                  LOOPd  136
c                                                                               LOOPd  137
c              Size the loop - load and flow                                    LOOPd  138
      IF (<lp:SUBTYPE> .EQ. PRIMARY)  THEN                                      LOOPd  139
c              primary loop may be sized on the basis of either the             LOOPd  146
c              secondary HVAC load or the primary plant equipment               LOOPd  147
        IF (<lp:SIZE-OPTION> .EQ. PRIMARY)  THEN                                LOOPd  148
c              size loop on the basis of primary equipment                      LOOPd  149
c              heating, cooling, and flow                                       LOOPd  150
          QloopH = <lp;PRIMARY_HCAP>                                            LOOPd  151
          QloopC = <lp;PRIMARY_CCAP>                                            LOOPd  152
          GPMs   = MAX(ABS(QloopH), QloopC)                                     LOOPd  153
     &                       / (<lp;BTUH/GPM-F>*ABS(<lp:DESIGN-DT>))            LOOPd  154
c              warn if no primary equipment sized by user                       LOOPd  155
          SELECT CASE (LoopType)                                                -041b    6
            CASE (2,4,6,7,8)                                                    -041b    7
              IF (QloopH .EQ. 0.)  THEN                                         -041b    8
                CALL MSGSIM(-2,II,II,II,II)                                     -041b    9
                WRITE (IOUTPT,9100)  (<lp:NAME>,II=1,8)                         -041b   10
c                 since no primary equipment user-sized,                        -041b   11
c                 size on secondary HVAC                                        -041b   12
                IF (<lp:FLOW> .EQ. 0.)  THEN                                    -041b   13
                  QloopH = <lp;COIL_HEAT> * <lp:SIZE-RATIO>                     -041b   14
                  GPMs   = <lp;GPM>       * <lp:SIZE-RATIO>                     -041b   15
                ELSE                                                            -041b   16
                  QloopH = <lp;COIL_HEAT>                                       -041b   17
                  GPMs   = <lp;GPM>                                             -041b   18
                ENDIF                                                           -041b   19
              ENDIF                                                             -041b   20
          END SELECT                                                            -041b   21
          SELECT CASE (LoopType)                                                -041b   22
            CASE (1,2,7,9)                                                      -041b   23
              IF (QloopC .EQ. 0.)  THEN                                         -041b   24
                CALL MSGSIM(-2,II,II,II,II)                                     -041b   25
                WRITE (IOUTPT,9100)  (<lp:NAME>,II=1,8)                         -041b   26
c                 since no primary equipment user-sized,                        -041b   27
c                 size on secondary HVAC                                        -041b   28
                IF (<lp:FLOW> .EQ. 0.)  THEN                                    -041b   29
                  QloopC = <lp;COIL_COOL> * <lp:SIZE-RATIO>                     -041b   30
                  GPMs   = <lp;GPM>       * <lp:SIZE-RATIO>                     -041b   31
                ELSE                                                            -041b   32
                  QloopC = <lp;COIL_COOL>                                       -041b   33
                  GPMs   = <lp;GPM>                                             -041b   34
                ENDIF                                                           -041b   35
              ENDIF                                                             -041b   36
          END SELECT                                                            -041b   37
        ELSE                                                                    LOOPd  165
c              size loop on the basis of secondary equipment                    LOOPd  166
          IF (<lp:FLOW> .EQ. 0.)  THEN                                          ERV     83
            QloopH = <lp;COIL_HEAT> * <lp:SIZE-RATIO>                           ERV     84
            QloopC = <lp;COIL_COOL> * <lp:SIZE-RATIO>                           ERV     85
            GPMs   = <lp;GPM>       * <lp:SIZE-RATIO>                           ERV     86
          ELSE                                                                  ERV     87
            QloopH = <lp;COIL_HEAT>                                             ERV     88
            QloopC = <lp;COIL_COOL>                                             ERV     89
            GPMs   = <lp;GPM>                                                   ERV     90
          ENDIF                                                                 ERV     91
        ENDIF                                                                   LOOPd  170
c              save design demander's values                                    LOOPd  171
        <lp;DES_DEM_HEAT> = <lp;COIL_HEAT>                                      LOOPd  172
        <lp;DES_DEM_COOL> = <lp;COIL_COOL>                                      LOOPd  173
c                                                                               LOOPd  174
c              DHW loops                                                        LOOPd  175
        IF (LoopType .eq. DHW)  THEN                                            LOOPd  176
c                coil flows   non-coil flows (down the drain)                   LOOPd  177
          GPMs = <lp;GPM> + <lp;DES_GPMdhw> + <lp;Recirc21dhw>                  Bug40  106
        ENDIF  !dhw calcs                                                       LOOPd  234
c              zero the primary loop capacity for use again                     LOOPd  235
        <lp;PRIMARY_HCAP> = 0.                                                  LOOPd  236
        <lp;PRIMARY_CCAP> = 0.                                                  LOOPd  237
      ELSE                                                                      LOOPd  238
c              always size secondary loops on basis of secondary equip          LOOPd  239
        <lp:SIZE-OPTION> = SECONDARY                                            LOOPd  240
          IF (<lp:FLOW> .EQ. 0.)  THEN                                          ERV     92
            QloopH = <lp;COIL_HEAT> * <lp:SIZE-RATIO>                           ERV     93
            QloopC = <lp;COIL_COOL> * <lp:SIZE-RATIO>                           ERV     94
            GPMs   = <lp;GPM>       * <lp:SIZE-RATIO>                           ERV     95
          ELSE                                                                  ERV     96
            QloopH = <lp;COIL_HEAT>                                             ERV     97
            QloopC = <lp;COIL_COOL>                                             ERV     98
            GPMs   = <lp;GPM>                                                   ERV     99
          ENDIF                                                                 ERV    100
c              include the non-coil flows for DHW                               LOOPd  244
        IF (LoopType .EQ. DHW)  GPMs = GPMs + <lp;DES_GPMdhw>                   LOOPd  245
      ENDIF                                                                     LOOPd  246
c                                                                               ERV    101
c              Adjust loads when user specifies the flow                        ERV    102
      IF (<lp:FLOW> .GT. 0.)  THEN                                              ERV    103
        QloopH = QloopH * <lp:FLOW> / GPMs                                      ERV    104
        QloopC = QloopC * <lp:FLOW> / GPMs                                      ERV    105
        GPMs   = <lp:FLOW>                                                      ERV    106
      ENDIF                                                                     ERV    107
c                                                                               LOOPd  247
c              error if loop flow and/or load is zero                           LOOPd  248
      IF (GPMs .EQ. 0.)  THEN                                                   LOOPd  249
c              check to see if this is a default loop which should be ignored   LOOPd  250
        DefaultFound = .TRUE.                                                   LOOPd  251
        DO  II=1,8                                                              LOOPd  252
          IF (<lp:NAME> .NE. DefaultNames(II,LoopType) )                        LOOPd  253
     &                                            DefaultFound = .FALSE.        LOOPd  254
        ENDDO                                                                   LOOPd  255
        IF (.NOT. DefaultFound)  THEN                                           LOOPd  256
          CALL MSGSIM(-1,II,II,II,II)                                           LOOPd  257
          WRITE (IOUTPT,9114) (<lp:NAME>,II=1,8)                                LOOPd  258
          call MessageBox( NULL, 'LOOP has zero flow -'                         LOOPd  259
     &      //' ABORTING'//char(0),'LOOPd Errors'//char(0), MB_OK               LOOPd  260
     &      + MB_ICONSTOP + MB_TASKMODAL )                                      LOOPd  261
          RETURN                                                                LOOPd  263
        ELSE                                                                    LOOPd  264
c              dont size unused default - make a nonentity                      LOOPd  265
          <lp:TYPE> = Deleted                                                   LOOPd  266
          RETURN                                                                LOOPd  267
        ENDIF                                                                   LOOPd  268
      ELSEIF (ABS(QloopH) .LT. 10.  .AND.  ABS(QloopC) .LT. 10.                 LOOPd  269
     &                              .AND. LoopType .NE. DHW)  THEN              LOOPd  270
        CALL MSGSIM(-1,II,II,II,II)                                             LOOPd  271
        WRITE (IOUTPT,9113) (<lp:NAME>,II=1,8)                                  LOOPd  272
        call MessageBox( NULL, 'LOOP has zero load -'                           LOOPd  273
     &    //' ABORTING'//char(0),'LOOPd Errors'//char(0), MB_OK                 LOOPd  274
     &    + MB_ICONSTOP + MB_TASKMODAL )                                        LOOPd  275
        RETURN                                                                  LOOPd  277
      ENDIF                                                                     LOOPd  278
c                                                                               LOOPd  279
c              return flow                                                      LOOPd  280
      IF (LoopType .NE. DHW)  THEN                                              LOOPd  281
        GPMr = GPMs                                                             LOOPd  282
      ELSE                                                                      LOOPd  283
c              dhw return at this point is recirculation carried down           LOOPd  284
c              from any secondary loops, as well as return from coils           LOOPd  285
        GPMr = <lp;GPMr> + <lp;GPM>                                             LOOPd  286
      ENDIF                                                                     LOOPd  287
c              include any recirculation gpm in this loop                       LOOPd  288
      IF (<lp:FLOW> .EQ. 0.)  THEN                                              ERV    108
        GPMs = GPMs + <lp:RECIRC-GPM>                                           ERV    109
        GPMr = GPMr + <lp:RECIRC-GPM>                                           ERV    110
      ELSE                                                                      ERV    111
        GPMr = MIN(GPMr+<lp:RECIRC-GPM>, GPMs)                                  ERV    112
      ENDIF                                                                     ERV    113
c              flow must be at least the minimum                                LOOPd  291
      <lp:MIN-GPM> = GPMs * <lp:MIN-GPM>                                        LOOPd  292
      GPMr = MAX(GPMr, <lp:MIN-GPM>)                                            -41a     2
c                                                                               Proces  40
c              Return flow must be non-zero if loop has a pump                  Proces  41
      IF (<lp:PUMP>+<lp;NUM_SUP_PUMPS>+<lp;NUM_DEM_PUMPS> .GT. 0                Proces  42
     &                                          .AND. GPMr .EQ. 0)  THEN        Proces  43
        CALL MSGSIM(-1,II,II,II,II)                                             Proces  44
        WRITE (IOUTPT,9120) (<lp:NAME>,II=1,8)                                  Proces  45
        IFLAG = 1                                                               Proces  46
        RETURN                                                                  Proces  48
      ENDIF                                                                     Proces  49
c                                                                               LOOPd  293
c              default head loss in distribution piping based on                LOOPd  294
c              2" average pipe size, 4ft/sec velocity,                          LOOPd  295
c              3'/100' doubled for fittings                                     LOOPd  296
      IF (<lp:PIPE-HEAD> .EQ. 0.)  THEN                                         LOOPd  297
        <lp:PIPE-HEAD> = <lp:AVG-CIRC-TIME> * 60.0 * 4.0 * 6.0 / 100.           LOOPd  298
c              if DHW loops have recirculation losses only, they are only       LOOPd  299
c              on the return side and smaller per length                        LOOPd  300
        IF (LoopType .EQ. DHW  .AND.  <lp;GPM> .LT. .01)                        LOOPd  301
     $    <lp:PIPE-HEAD> = <lp:PIPE-HEAD> * 0.25                                LOOPd  302
      ENDIF                                                                     LOOPd  303
c                                                                               LOOPd  304
c                                                                               LOOPd  305
c              The total head on the pump is the sum of                         LOOPd  306
c              the distribution losses.  Note that the supply-side and          LOOPd  307
c              demand-side head losses do not include equipment losses          LOOPd  308
c              when the equipment has a pump directly attached                  LOOPd  309
      HDpump = <lp:PIPE-HEAD>     + <lp:STATIC-HEAD>                            LOOPd  310
c                   plus the demand-side losses                                 LOOPd  311
     &       + <lp;DEM-SIDE_HEAD> + <lp;DEM-SIDE_STAT>                          LOOPd  312
c                   plus the supply-side losses                                 LOOPd  313
     &       + <lp;SUP-SIDE_HEAD> + <lp;SUP-SIDE_STAT>                          LOOPd  314
c                   plus the supply-side heat recovery losses                   LOOPd  315
     &       + <lp;HTREC_HEAD>    + <lp;HTREC_STATIC>                           LOOPd  316
c                                                                               LOOPd  317
c              Save design loop and primary equipment head                      LOOPd  318
      <lp;HEAD>          = HDpump                                               LOOPd  319
      <lp;SUP_DES_HEAD>  = <lp;SUP-SIDE_HEAD> + <lp;HTREC_HEAD>                 LOOPd  320
      <lp;SUP_DES_STATI> = <lp;SUP-SIDE_STAT> + <lp;HTREC_STATIC>               LOOPd  321
      EquipHead   = 0.                                                          LOOPd  322
      EquipStatic = 0.                                                          LOOPd  323
c                                                                               LOOPd  324
c              Calculate the required setpoint of the pump controller.          LOOPd  325
c              The calculation varies according to whether the loop             LOOPd  326
c              is powered by its own pump(s), pumps attached to the             LOOPd  327
c              supply-side equipment (boilers, chiller evaporators,             LOOPd  328
c              etc.), or pumps attached to the demand-side equipment            LOOPd  329
c              (chiller condensers, generators).                                LOOPd  330
c                                                                               LOOPd  331
      IF (<lp:PUMP> .GT. 0)  THEN                                               LOOPd  332
        Jpm = <lp:PUMP>                                                         LOOPd  333
c              loop has pumps directly attached                                 LOOPd  334
        IF (<lp:HD-SENS-LOCN> .EQ. AtCoils)  THEN                               LOOPd  335
c              sensor located at coils - the setpoint need overcome             LOOPd  336
c              only the head of the demand-side devices                         LOOPd  337
c                  worst demand/2nd                                             LOOPd  338
          HDset = <lp;DEM-SIDE_HEAD> + <lp;DEM-SIDE_STAT>                       LOOPd  339
        ELSEIF (<lp:HD-SENS-LOCN> .EQ. EnterLoop)  THEN                         LOOPd  340
c              sensor located at beginning of loop - the setpoint               LOOPd  341
c              must overcome the head of both the demand-side devices           LOOPd  342
c              and the piping                                                   LOOPd  343
c                  worst demand/2nd                                             LOOPd  344
          HDset = <lp;DEM-SIDE_HEAD> + <lp;DEM-SIDE_STAT>                       LOOPd  345
c                  pipe loss                                                    LOOPd  346
     &          + <lp:PIPE-HEAD>   + <lp:STATIC-HEAD>                           LOOPd  347
        ELSE                                                                    LOOPd  348
c              sensor located at the pump - the setpoint must overcome          LOOPd  349
c              the head of the demand-side devices, piping, and                 LOOPd  350
c              supply-side equipment                                            LOOPd  351
          HDset = HDpump                                                        LOOPd  352
        ENDIF                                                                   LOOPd  353
c              default pump head setpoint to be the loop setpoint               LOOPd  354
        IF (<pm:HEAD-SETPT> .EQ. 0.)                                            LOOPd  355
     &      <pm:HEAD-SETPT> = <lp:HD-SETPT>                                     LOOPd  356
        IF (<pm:SETPT-RATIO> .EQ. 0.)                                           LOOPd  357
     &      <pm:SETPT-RATIO> = <lp:HD-SETPT-RATI>                               LOOPd  358
c              save the setpoint for hourly calcs                               LOOPd  359
        IF (<pm:HEAD-SETPT> .EQ. 0.)  THEN                                      LOOPd  360
c              default setpoint - include the 1/2 the throttling range,         LOOPd  361
c              so that at full flow the head is HDSETPT                         LOOPd  362
c              store only if pump actually has a capacity control mechanism     LOOPd  363
          IF (<pm:NUMBER> .GT. 1.                                               LOOPd  364
     &                       .OR.  <pm:CAP-CTRL> .NE. OneSpeed)                 LOOPd  365
     &      <pm:HEAD-SETPT> = HDset*<pm:SETPT-RATIO>                            LOOPd  366
     &                                        + <lp:HD-SETPT-RNG>*0.5           LOOPd  367
        ELSE                                                                    LOOPd  368
c              user specified head                                              LOOPd  369
c              head setpoint unused if no capacity control mechanism            LOOPd  370
          IF (<pm:NUMBER> .EQ. 1.                                               LOOPd  371
     &                       .AND.  <pm:CAP-CTRL> .EQ. OneSpeed)  THEN          LOOPd  372
            CALL MSGSIM(-2,II,II,II,II)                                         LOOPd  373
            WRITE (IOUTPT, 9117)  (<pm:NAME>,II=1,8)                            LOOPd  374
            <pm:HEAD-SETPT> = 0.                                                LOOPd  375
          ENDIF                                                                 LOOPd  376
c              check if at least the required value                             LOOPd  377
          HDreqd = HDset + <lp:HD-SETPT-RNG>*0.5                                LOOPd  378
          IF (<pm:HEAD-SETPT> .LT. HDreqd*.98)  THEN                            LOOPd  379
            CALL MSGSIM(-2,II,II,II,II)                                         LOOPd  380
            WRITE (IOUTPT,9106) (<lp:NAME>,II=1,8),                             LOOPd  381
     &                           <pm:HEAD-SETPT>, HDreqd                        LOOPd  382
          ENDIF                                                                 LOOPd  383
        ENDIF                                                                   LOOPd  384
      ELSEIF (<lp;NUM_SUP_PUMPS> .GT. 0)  THEN                                  LOOPd  385
c              loop is powered by pumps attached to the supply-side             LOOPd  386
c              primary equipment - setpoint for each pump may be                LOOPd  387
c              different, depending on the head of the attached equipment       LOOPd  388
        Neq = <lp;NUM_SUP_PUMPS>                                                LOOPd  389
        DO  IQ=1,Neq                                                            LOOPd  390
          Jpm = <lp;SUP_SIDE_PMPS>                                              LOOPd  391
          IF (<lp:HD-SENS-LOCN> .EQ. AtCoils)  THEN                             LOOPd  392
c              sensor located at coils - the setpoint need overcome             LOOPd  393
c              only the head of the demand-side devices                         LOOPd  394
c                  worst demand/2nd                                             LOOPd  395
            HDset = <lp;DEM-SIDE_HEAD> + <lp;DEM-SIDE_STAT>                     LOOPd  396
          ELSEIF (<lp:HD-SENS-LOCN> .EQ. EnterLoop)  THEN                       LOOPd  397
c              sensor located at beginning of loop - the setpoint               LOOPd  398
c              must overcome the head of both the demand-side devices           LOOPd  399
c              and the piping                                                   LOOPd  400
c                  worst demand/2nd                                             LOOPd  401
            HDset = <lp;DEM-SIDE_HEAD> + <lp;DEM-SIDE_STAT>                     LOOPd  402
c                    pipe loss                                                  LOOPd  403
     &            + <lp:PIPE-HEAD>   + <lp:STATIC-HEAD>                         LOOPd  404
          ELSE                                                                  LOOPd  405
c              sensor located at the pump - the setpoint must overcome          LOOPd  406
c              the head of the demand-side devices, piping,                     LOOPd  407
c              supply-side equipment,                                           LOOPd  408
            HDset = HDpump                                                      LOOPd  409
c                    attached equip                                             LOOPd  410
     &            + <pm;EQUIP_HEAD> + <pm;STATIC_HEAD>                          LOOPd  411
          ENDIF                                                                 LOOPd  412
c              default pump head setpoint to be the loop setpoint               LOOPd  413
          IF (<pm:HEAD-SETPT> .EQ. 0.)                                          LOOPd  414
     &        <pm:HEAD-SETPT> = <lp:HD-SETPT>                                   LOOPd  415
          IF (<pm:SETPT-RATIO> .EQ. 0.)                                         LOOPd  416
     &        <pm:SETPT-RATIO> = <lp:HD-SETPT-RATI>                             LOOPd  417
c              save the setpoint for hourly calcs                               LOOPd  418
          IF (<pm:HEAD-SETPT> .EQ. 0.)  THEN                                    LOOPd  419
c              default setpoint - include the 1/2 the throttling range,         LOOPd  420
c              so that at full flow the head is HDSETPT                         LOOPd  421
c              store only if pump actually has a capacity control mechanism     LOOPd  422
            IF (<pm:NUMBER> .GT. 1.                                             LOOPd  423
     &                       .OR.  <pm:CAP-CTRL> .NE. OneSpeed)                 LOOPd  424
     &        <pm:HEAD-SETPT> = HDset*<pm:SETPT-RATIO>                          LOOPd  425
     &                                        + <lp:HD-SETPT-RNG>*0.5           LOOPd  426
          ELSE                                                                  LOOPd  427
c              user specified head                                              LOOPd  428
c              head setpoint unused if no capacity control mechanism            LOOPd  429
            IF (<pm:NUMBER> .EQ. 1.                                             LOOPd  430
     &                       .AND.  <pm:CAP-CTRL> .EQ. OneSpeed)  THEN          LOOPd  431
              CALL MSGSIM(-2,II,II,II,II)                                       LOOPd  432
              WRITE (IOUTPT, 9117)  (<pm:NAME>,II=1,8)                          LOOPd  433
              <pm:HEAD-SETPT> = 0.                                              LOOPd  434
            ENDIF                                                               LOOPd  435
c              check if at least the required value                             LOOPd  436
            HDreqd = HDset + <lp:HD-SETPT-RNG>*0.5                              LOOPd  437
            IF (<pm:HEAD-SETPT> .LT. HDreqd*.98)  THEN                          LOOPd  438
              CALL MSGSIM(-2,II,II,II,II)                                       LOOPd  439
              WRITE (IOUTPT,9106) (<lp:NAME>,II=1,8),                           LOOPd  440
     &                             <pm:HEAD-SETPT>, HDreqd                      LOOPd  441
            ENDIF                                                               LOOPd  442
          ENDIF                                                                 LOOPd  443
c              maximum equipment head for all attached to loop                  LOOPd  444
          IF (<pm;EQUIP_HEAD>+<pm;STATIC_HEAD> .GT.                             LOOPd  445
     &               EquipHead+EquipStatic)  THEN                               LOOPd  446
            EquipHead   = <pm;EQUIP_HEAD>                                       LOOPd  447
            EquipStatic = <pm;STATIC_HEAD>                                      LOOPd  448
          ENDIF                                                                 LOOPd  449
        ENDDO                                                                   LOOPd  450
      ELSEIF (<lp;NUM_DEM_PUMPS> .GT. 0)  THEN                                  LOOPd  451
c              loop is powered by pumps attached to the demand-side             LOOPd  452
c              primary equipment - setpoint for each pump may be                LOOPd  453
c              different, depending on the head of the attached equipment       LOOPd  454
        Neq = <lp;NUM_DEM_PUMPS>                                                LOOPd  455
        DO  IQ=1,Neq                                                            LOOPd  456
          Jpm = <lp;DEM_SIDE_PMPS>                                              LOOPd  457
          IF (<lp:HD-SENS-LOCN> .EQ. AtCoils)  THEN                             LOOPd  458
c              sensor located at coils - the setpoint need overcome             LOOPd  459
c              only the head of the demand-side devices (the attached           LOOPd  460
c              equipment is a demand-side device also)                          LOOPd  461
c                  worst demand/2nd                                             LOOPd  462
            HDset = <lp;DEM-SIDE_HEAD> + <lp;DEM-SIDE_STAT>                     LOOPd  463
c                    attached equip                                             LOOPd  464
     &            + <pm;EQUIP_HEAD>  + <pm;STATIC_HEAD>                         LOOPd  465
          ELSEIF (<lp:HD-SENS-LOCN> .EQ. EnterLoop)  THEN                       LOOPd  466
c              sensor located at beginning of loop - the setpoint               LOOPd  467
c              must overcome the head of both the demand-side devices           LOOPd  468
c              and the piping                                                   LOOPd  469
c                  worst demand/2nd                                             LOOPd  470
            HDset = <lp;DEM-SIDE_HEAD> + <lp;DEM-SIDE_STAT>                     LOOPd  471
c                    attached equip                                             LOOPd  472
     &            + <pm;EQUIP_HEAD>    + <pm;STATIC_HEAD>                       LOOPd  473
c                    pipe loss                                                  LOOPd  474
     &            + <lp:PIPE-HEAD>     + <lp:STATIC-HEAD>                       LOOPd  475
          ELSE                                                                  LOOPd  476
c              sensor located at the pump - the setpoint must overcome          LOOPd  477
c              the head of the demand-side devices, piping, and                 LOOPd  478
c              supply-side equipment                                            LOOPd  479
            HDset = HDpump                                                      LOOPd  480
c                    attached equip                                             LOOPd  481
     &            + <pm;EQUIP_HEAD> + <pm;STATIC_HEAD>                          LOOPd  482
          ENDIF                                                                 LOOPd  483
c              default pump head setpoint to be the loop setpoint               LOOPd  484
          IF (<pm:HEAD-SETPT> .EQ. 0.)                                          LOOPd  485
     &        <pm:HEAD-SETPT> = <lp:HD-SETPT>                                   LOOPd  486
          IF (<pm:SETPT-RATIO> .EQ. 0.)                                         LOOPd  487
     &        <pm:SETPT-RATIO> = <lp:HD-SETPT-RATI>                             LOOPd  488
c              save the setpoint for hourly calcs                               LOOPd  489
          IF (<pm:HEAD-SETPT> .EQ. 0.)  THEN                                    LOOPd  490
c              default setpoint - include the 1/2 the throttling range,         LOOPd  491
c              so that at full flow the head is HDSETPT                         LOOPd  492
c              store only if pump actually has a capacity control mechanism     LOOPd  493
            IF (<pm:NUMBER> .GT. 1.                                             LOOPd  494
     &                       .OR.  <pm:CAP-CTRL> .NE. OneSpeed)                 LOOPd  495
     &        <pm:HEAD-SETPT> = HDset*<pm:SETPT-RATIO>                          LOOPd  496
     &                                        + <lp:HD-SETPT-RNG>*0.5           LOOPd  497
          ELSE                                                                  LOOPd  498
c              user specified head                                              LOOPd  499
c              head setpoint unused if no capacity control mechanism            LOOPd  500
            IF (<pm:NUMBER> .EQ. 1.                                             LOOPd  501
     &                       .AND.  <pm:CAP-CTRL> .EQ. OneSpeed)  THEN          LOOPd  502
              CALL MSGSIM(-2,II,II,II,II)                                       LOOPd  503
              WRITE (IOUTPT, 9117)  (<pm:NAME>,II=1,8)                          LOOPd  504
              <pm:HEAD-SETPT> = 0.                                              LOOPd  505
            ENDIF                                                               LOOPd  506
c              check if at least the required value                             LOOPd  507
            HDreqd = HDset + <lp:HD-SETPT-RNG>*0.5                              LOOPd  508
            IF (<pm:HEAD-SETPT> .LT. HDreqd*.98)  THEN                          LOOPd  509
              CALL MSGSIM(-2,II,II,II,II)                                       LOOPd  510
              WRITE (IOUTPT,9106) (<lp:NAME>,II=1,8),                           LOOPd  511
     &                             <pm:HEAD-SETPT>, HDreqd                      LOOPd  512
            ENDIF                                                               LOOPd  513
          ENDIF                                                                 LOOPd  514
c              maximum equipment head for all attached to loop                  LOOPd  515
          IF (<pm;EQUIP_HEAD>+<pm;STATIC_HEAD> .GT.                             LOOPd  516
     &               EquipHead+EquipStatic)  THEN                               LOOPd  517
            EquipHead   = <pm;EQUIP_HEAD>                                       LOOPd  518
            EquipStatic = <pm;STATIC_HEAD>                                      LOOPd  519
          ENDIF                                                                 LOOPd  520
        ENDDO                                                                   LOOPd  521
      ELSEIF (SubType .EQ. PRIMARY  .AND.  GPMr .GT. 0.)  THEN                  LOOPd  522
c              this primary loop not pumped                                     LOOPd  523
        CALL MSGSIM(-1,II,II,II,II)                                             LOOPd  524
        WRITE (IOUTPT,9116) (<lp:NAME>,II=1,8)                                  LOOPd  525
        IFLAG = 1                                                               LOOPd  526
      ENDIF                                                                     LOOPd  527
c                                                                               LOOPd  528
c              Size the pump attached directly to the loop                      LOOPd  529
      Qpump  = 0.                                                               LOOPd  530
      dTpump = 0.                                                               LOOPd  531
      IF (<lp:PUMP> .GT. 0)  THEN                                               LOOPd  532
        Jpm = <lp:PUMP>                                                         LOOPd  533
        CALL PUMPdes(GPMr)                                                      LOOPd  534
c              design head for reports                                          LOOPd  535
        <lp;DES_HEAD> = HDpump                                                  LOOPd  536
      ELSEIF (SubType .EQ. PRIMARY  .AND.                                       LOOPd  537
     &             (<lp;NUM_SUP_PUMPS>+<lp;NUM_DEM_PUMPS>) .GT. 0)  THEN        LOOPd  538
c              Supply-side and demand-side pumps cannot be sized until          LOOPd  539
c              the flow of their attached equipment is calcd.  For now,         LOOPd  540
c              do an estimate of pump heat based on worst-case pump             LOOPd  541
c              Get a pump pointer                                               LOOPd  542
        IQ = 1                                                                  LOOPd  543
        IF (<lp;NUM_SUP_PUMPS> .GT. 0)  THEN                                    LOOPd  544
          Jpm = <lp;SUP_SIDE_PMPS>                                              LOOPd  545
        ELSE                                                                    LOOPd  546
          Jpm = <lp;DEM_SIDE_PMPS>                                              LOOPd  547
        ENDIF                                                                   LOOPd  548
c              design head                                                      LOOPd  549
        HeadLoop = (HDpump+EquipHead+EquipStatic) * <pm:HEAD-RATIO>             LOOPd  550
c              pump brake horsepower                                            LOOPd  551
        BHP = GPMr * HeadLoop / (3960. * <pm:MECH-EFF>)                         LOOPd  552
c              motor efficiency                                                 LOOPd  553
        IF (<pm:MOTOR-EFF> .EQ. 0.)  THEN                                       LOOPd  554
c              assume motor is 30% larger than BHP                              LOOPd  555
          HP = BHP * 1.3                                                        LOOPd  556
          EfficiencyMotor = EffMotor(HP,<pm:MOTOR-CLASS>)                       LOOPd  557
        ELSE                                                                    LOOPd  558
          EfficiencyMotor = <pm:MOTOR-EFF>                                      LOOPd  559
        ENDIF                                                                   LOOPd  560
c              power consumption                                                LOOPd  561
        PumpkW = BHP * .746 / EfficiencyMotor                                   LOOPd  562
c              design pump heat                                                 LOOPd  563
        Qpump  = PumpkW  * BTUKW * EfficiencyMotor                              LOOPd  564
c              loop temperature rise due to pump                                LOOPd  565
        dTpump = Qpump / (<lp;BTUH/GPM-F> * GPMr)                               LOOPd  566
c              design head for loop reports                                     LOOPd  567
        <lp;DES_HEAD> = HDpump + EquipHead + EquipStatic                        LOOPd  568
      ELSEIF (SubType .EQ. SECONDARY)  THEN                                     LOOPd  569
c              design head of un-pumped secondary loop                          LOOPd  570
        <lp;DES_HEAD> = HDpump                                                  LOOPd  571
      ENDIF                                                                     LOOPd  572
c                                                                               LOOPd  573
c              add the pump heat to the load if sized on secondary loads        LOOPd  574
      IF (<lp:SIZE-OPTION> .EQ. SECONDARY)  THEN                                LOOPd  575
        QloopH = QloopH + Qpump                                                 LOOPd  576
        QloopC = QloopC + Qpump                                                 LOOPd  577
      ENDIF                                                                     LOOPd  578
c                                                                               LOOPd  579
c              Initialize start-up hour estimates                               GLHX1  677
      <lp;START_GPM>     = GPMs                                                 GLHX1  678
      <lp;START_GPMr>    = GPMr                                                 GLHX1  679
      <lp;START_PUMPQ>   = Qpump                                                GLHX1  680
      <lp;START_PUMPT>   = dTpump                                               GLHX1  681
      <lp;RUN_FRAC_STRT> = 1.0                                                  GLHX1  682
c                                                                               LOOPd  595
c              Loop volume                                                      LOOPd  596
      Gallons = <lp:FLUID-VOL>                                                  LOOPd  597
c              if loop volume not specified, base on average                    LOOPd  598
c              circulation time                                                 LOOPd  599
      IF (Gallons .EQ. 0.)  Gallons = GPMs * <lp:AVG-CIRC-TIME>                 LOOPd  600
c              loop heat capacity (total for supply and return)                 LOOPd  601
      <lp;BTU/F>     = Max(1., Gallons * <lp;BTUH/GPM-F> / 60.)                 -047j   56
      <lp:FLUID-VOL> = Gallons                                                  LOOPd  603
                                                                                LOOPd  604
c              Set up the piping thermal losses                                 LOOPd  605
      IF (<lp:SUPPLY-UA> .NE. 0.  .OR.  <lp:SLOSS-DT> .NE. 0.)  THEN            LOOPd  606
        CALL PipeDT_Design(QloopH, QloopC)                                      LOOPd  607
        IF (IwinReturn .ne. 0)  RETURN                                          LOOPd  608
      ELSE                                                                      -034    56
        <lp:LOCN> = 0                                                           -034    57
      ENDIF                                                                     LOOPd  609
c                                                                               LOOPd  610
c              Constrain design loads according to type of loop                 LOOPd  611
      IF (<lp:SIZE-OPTION> .EQ. SECONDARY)  THEN                                LOOPd  612
        IF (LoopType .EQ. HW  .OR.  LoopType .EQ. STM                           LOOPd  613
     &                        .OR.  LoopType .EQ. DHW)  THEN                    LOOPd  614
          QloopC = 0.                                                           LOOPd  615
        ELSEIF (LoopType .EQ. CHW  .OR.  LoopType .EQ. CW)  THEN                LOOPd  616
          QloopH = 0.                                                           LOOPd  617
        ENDIF                                                                   LOOPd  618
      ENDIF                                                                     LOOPd  619
c                                                                               LOOPd  620
c              design supply and return temperatures                            LOOPd  621
      TsupplyH = <lp:DESIGN-HEAT-T>                                             Chlr1 2886
      TreturnH = TsupplyH + QloopH / (<lp;BTUH/GPM-F>*GPMs)                     LOOPd  623
      TsupplyC = <lp:DESIGN-COOL-T>                                             Chlr1 2887
      TreturnC = TsupplyC + QloopC / (<lp;BTUH/GPM-F>*GPMs)                     LOOPd  625
c                                                                               LOOPd  626
c              secondary loop - flow and head between secondary                 LOOPd  627
c              and primary loop                                                 LOOPd  628
      IF (SubType .EQ. SECONDARY)  THEN                                         LOOPd  629
c              supply and return flows in the secondary                         LOOPd  630
        GPM21    = GPMs                                                         LOOPd  631
        GPM21r   = GPMr                                                         LOOPd  632
        GPM21dhw = <lp;DES_GPMdhw>                                              LOOPd  633
        GPM21cir = <lp:RECIRC-GPM>                                              LOOPd  634
        GPM21min = <lp:MIN-GPM>                                                 -41a     3
        IF (<lp:PUMP> .EQ. 0)  THEN                                             LOOPd  635
c              no secondary pump - flow and head demand on primary              LOOPd  636
c              is the flow and head of secondary                                LOOPd  637
          HEAD21   = HDpump - <lp:STATIC-HEAD>                                  LOOPd  638
          STATIC21 = <lp:STATIC-HEAD>                                           LOOPd  639
        ELSE                                                                    LOOPd  640
c              loop has a secondary pump - head requirement on primary          LOOPd  641
c              is only that of the secondary temperature control valve          LOOPd  642
          HEAD21   = <lp:VALV-HEAD-2ND>                                         LOOPd  643
          STATIC21 = 0.                                                         LOOPd  644
c               Flow from primary may be less than secondary if                 LOOPd  645
c               secondary has a more moderate temperature.  Note that           LOOPd  646
c               WLHP, DHW, and CW loops do not have any primary/secondary       LOOPd  647
c               temperature control valves                                      LOOPd  648
          IF (LoopType .EQ. HW  .OR.  LoopType .EQ. CHW                         LOOPd  649
     &                          .OR.  LoopType .EQ. PIPE2)  THEN                LOOPd  650
            GPM21  = GPMs * <lp:PRIM-FLOW-PCT>*0.01                             LOOPd  651
            GPM21r = GPMr * <lp:PRIM-FLOW-PCT>*0.01                             LOOPd  652
c                 check to see if this is reasonable                            LOOPd  653
            Jlp2 = Jlp                                                          LOOPd  654
            Jlp  = <lp:PRIMARY>                                                 LOOPd  655
c              primary loop temperature - note that this does not               LOOPd  656
c              include losses                                                   LOOPd  657
            IF (LoopType .EQ. CHW    .OR.  LoopType .EQ. CW  .OR.               LOOPd  658
     &          LoopType .EQ. PIPE2  .OR.  LoopType .EQ. WLHP)  THEN            LOOPd  659
              Ts1  = <lp:DESIGN-COOL-T>                                         Chlr1 2888
c              primary flow to secondary                                        LOOPd  661
              IF (ABS(TreturnC-Ts1) .GT. 1.E-4)                                 LOOPd  662
     &          GPM12 = QloopC/(<lp;BTUH/GPM-F>*(TreturnC-Ts1))                 LOOPd  663
            ELSE                                                                LOOPd  664
              Ts1  = <lp:DESIGN-HEAT-T>                                         Chlr1 2889
              IF (ABS(TreturnH-Ts1) .GT. 1.E-4)                                 LOOPd  666
     &          GPM12 = QloopH/(<lp;BTUH/GPM-F>*(TreturnH-Ts1))                 LOOPd  667
            ENDIF                                                               LOOPd  668
            Jlp  = Jlp2                                                         LOOPd  669
            IF (GPM12 .GT. GPM21*1.1)  THEN                                     LOOPd  670
              CALL MSGSIM(-2,II,II,II,II)                                       LOOPd  671
              WRITE (IOUTPT,9103) (<lp:NAME>,II=1,8), GPM21, GPM12              LOOPd  672
            ENDIF                                                               LOOPd  673
c              1st/2nd temps would cause a negative flow                        LOOPd  674
            IF (GPM12 .LT. 0.)  THEN                                            LOOPd  675
              CALL MSGSIM(-1,II,II,II,II)                                       LOOPd  676
              WRITE (IOUTPT,9104)  (<lp:NAME>,II=1,8)                           LOOPd  677
              IFLAG = 1                                                         LOOPd  678
            ENDIF                                                               LOOPd  679
c              1st/2nd temps would cause an infinite flow                       LOOPd  680
            IF (ABS(TreturnC-Ts1) .LT. 1.E-4)  THEN                             LOOPd  681
              CALL MSGSIM(-1,II,II,II,II)                                       LOOPd  682
              WRITE (IOUTPT,9104)  (<lp:NAME>,II=1,8)                           LOOPd  683
              IFLAG = 1                                                         LOOPd  684
            ENDIF                                                               LOOPd  685
          ENDIF                                                                 LOOPd  686
        ENDIF                                                                   LOOPd  687
c              now transfer secondary load, flow, and head onto primary         LOOPd  688
        Jlp2 = Jlp                                                              LOOPd  689
        Jlp  = <lp:PRIMARY>                                                     LOOPd  690
        <lp;COIL_HEAT> = <lp;COIL_HEAT> + QloopH                                LOOPd  691
        <lp;COIL_COOL> = <lp;COIL_COOL> + QloopC                                LOOPd  692
        <lp;GPM>       = <lp;GPM>       + GPM21                                 LOOPd  693
        <lp;GPMr>      = <lp;GPMr>      + GPM21r                                LOOPd  694
        IF (LoopType .EQ. DHW)  THEN                                            LOOPd  695
          <lp;GPM>         = <lp;GPM> - (GPM21dhw+GPM21cir)                     Bug40  107
          <lp;GPMr>        = <lp;GPMr> - GPM21r                                 -41a     4
     &                     + MAX(GPM21cir, GPM21min)                            -41a     5
          <lp;DES_GPMdhw>  = <lp;DES_GPMdhw>  + GPM21dhw                        Bug40  108
          <lp;Recirc21dhw> = <lp;Recirc21dhw> + GPM21cir                        Bug40  109
        ENDIF                                                                   LOOPd  698
        <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD> , HEAD21)                   LOOPd  699
        <lp;DEM-SIDE_STAT> = MAX(<lp;DEM-SIDE_STAT>, STATIC21)                  LOOPd  700
        Jlp  = Jlp2                                                             LOOPd  701
      ENDIF                                                                     LOOPd  702
c                                                                               LOOPd  703
c              loop design capacity and gpm                                     LOOPd  704
      <lp;DES_HCAP> = QloopH                                                    LOOPd  705
      <lp;DES_CCAP> = QloopC                                                    LOOPd  706
      <lp;DES_GPM>  = GPMs                                                      LOOPd  707
      <lp;DES_GPMr> = GPMr                                                      LOOPd  708
c              Recalculate loop design temperature drop based on actual         LOOPd  709
c              coil flows, and including pump heat and thermal losses           LOOPd  710
c              This value will be used in calculating design flows for          LOOPd  711
c              the primary equipment                                            LOOPd  712
      IF (QloopC .GT. 0.)  THEN                                                 LOOPd  713
        <lp:DESIGN-DT> = QloopC / (<lp;BTUH/GPM-F>*GPMs)                        LOOPd  714
      ELSE                                                                      LOOPd  715
        <lp:DESIGN-DT> = QloopH / (<lp;BTUH/GPM-F>*GPMs)                        LOOPd  716
      ENDIF                                                                     LOOPd  717
c                                                                               LOOPd  718
c              startup condenser loop load for beginning of hour tower          LOOPd  719
c              estimate                                                         LOOPd  720
      IF (LoopType .EQ. CW)  <lp;START_Q> = <lp;DES_CCAP> * 0.75                LOOPd  721
c                                                                               LOOPd  722
c              initialize loop temperature setpoints                            LOOPd  723
      <lp;HEAT_SETPT>  = -999999.                                               LOOPd  724
      <lp;COOL_SETPT>  =  999999.                                               LOOPd  725
c              initialize loop temperatures                                     LOOPd  726
      <lp;SUPPLY_T>    = 70.                                                    LOOPd  727
      <lp;RETURN_T>    = 70.                                                    LOOPd  728
      <lp;COIL_EWT>    = 70.                                                    LOOPd  729
      <lp;COIL_LWT>    = 70.                                                    LOOPd  730
      <lp;SUPPLY_AVG'> = 70.                                                    LOOPd  731
      <lp;RETURN_AVG'> = 70.                                                    LOOPd  732
c              Initialize the fluid temperature for thermal loss calcs          LOOPd  733
      IF (<lp;SupplyLossPtr> .GT. 0)  THEN                                      LOOPd  734
        CALL PutVars3c(<lp;SupplyLossPtr>, -77777., -77777., 70.)               LOOPd  735
        CALL PutVars3c(<lp;ReturnLossPtr>, -77777., -77777., 70.)               LOOPd  736
      ENDIF                                                                     LOOPd  737
      IF (LoopType .EQ. CHW  .OR.  LoopType .EQ. PIPE2                          LOOPd  738
     &                       .OR.  LoopType .EQ. HW)  <lp;HWorCHW> = 1          LOOPd  739
c                                                                               LOOPd  749
c              dump design variables                                            LOOPd  750
      IF (IREPRT(3,34) .NE. 0)  WRITE(IOUTPT,9000) (<lp:NAME>,II=1,8),          LOOPd  751
     &  <lp;COIL_HEAT>, <lp;COIL_COOL>, <lp;GPM>, <lp;GPMr>,                    LOOPd  752
     &  <lp;DES_HCAP>, <lp;DES_CCAP>, <lp;DES_GPM>,                             LOOPd  753
     &  <lp:PIPE-HEAD>,<lp;START_PUMPQ>,<lp;START_PUMPT>,                       LOOPd  754
     &  GPM21, HEAD21, STATIC21, <lp;BTU/F>                                     LOOPd  755
c                                                                               LOOPd  756
 1000 RETURN                                                                    LOOPd  757
c              dump formats                                                     LOOPd  758
 9000 FORMAT(' ',8A4 /                                                          LOOPd  759
     &           17X,' 2ND LOAD 2ND LOADC   2ND GPM  2ND GPMr          '        LOOPd  760
     &      /    17X,     F10.1,    F10.1,    F10.1,    F10.1                   LOOPd  761
     &      /    17X,'LOOP HCAP LOOP CCAP  LOOP GPM                    '        LOOPd  762
     &      /    17X,     F10.1,    F10.1,    F10.1                             LOOPd  763
     &      /    17X,' PIPEHEAD    PUMP Q   PUMP DT                    '        LOOPd  764
     &      /    17X,     F10.1,    F10.1,    F10.1                             LOOPd  765
     &      /    17X,'    GPM21    HEAD21  STATIC21     BTU/F          '        LOOPd  766
     &      /    17X,     F10.1,    F10.1,    F10.1,    F10.1                   LOOPd  767
     &      /    17X,' HD SETPT                                        '        LOOPd  768
     &      /    17X,     F10.1                                        )        LOOPd  769
c                                                                               LOOPd  770
c              message formats                                                  LOOPd  771
 9100 FORMAT(14X,'Loop: ',8A4,' is specified to be sized to'           /        LOOPd  772
     &       14X,'primary equipment, but no equipment size defined.'   /        LOOPd  773
     &       14X,'Loop will be sized to secondary HVAC equipment load' ,        LOOPd  774
     &           ' instead.'                                           )        LOOPd  775
 9103 FORMAT(14X,'Secondary loop: ',8A4,' has a design flow'           /        LOOPd  776
     &       14X,'to the primary of',f10.1' gpm, but the flow based on'/        LOOPd  777
     &       14X,'the secondary load, secondary return temp, and'      /        LOOPd  778
     &       14X,'primary setpoint is',f10.1,'   Check setpoints for'  ,        LOOPd  779
     &           'consistency.'                                        )        LOOPd  780
 9104 FORMAT(14X,'Secondary loop: ',8A4,' has a temperature'           /        LOOPd  781
     &       14X,'setpoint relative to its primary loop that will'     /        LOOPd  782
     &       14X,'cause the flow to be infinite or negative.  Check'   /        LOOPd  783
     &       14X,'setpoints for consistency.'                          )        LOOPd  784
 9105 FORMAT(14X,'Loop: ',8A4,' primary capacity is smaller'           /        LOOPd  785
     &       14X,'than the secondary demand. Primary=',F10.0           ,        LOOPd  786
     &           ' Secondary=',F10.0                                   )        LOOPd  787
 9106 FORMAT(14X,'Loop: ',8A4,' has a specified setpoint'              /        LOOPd  788
     &       14X,'less than required.  Pump energy will be'            /        LOOPd  789
     &       14X,'underestimated as a result.  Specified head:',F6.1   /        LOOPd  790
     &       14X,'Required:',F6.1                                      )        LOOPd  791
 9107 FORMAT(14X,'Loop: ',8A4,' has a head controller'                 /        LOOPd  792
     &       14X,'setpoint of',F6.1,' but the pump can only deliver '  /        LOOPd  793
     &       14X,F6.1,' at full flow, at the location of the '         ,        LOOPd  794
     &           'controller.'                                         )        LOOPd  795
 9109 FORMAT(14X,'Loop: ',8a4,' has SNAP-LOCN = ZONE, but'             /        LOOPd  800
     &       14X,'no SNAP-ZONE was specified.  Will default'           /        LOOPd  801
     &       14X,'to: ',8a4,'.'                                        )        LOOPd  802
 9110 FORMAT(14X,'Loop: ',8a4,' has SNAP-LOCN = ZONE, but',            /        LOOPd  803
     &       14X,'no SNAP-ZONE was specified, and no zone is attached' /        LOOPd  804
     &       14X,'to this loop that can be the default.  You must'     /        LOOPd  805
     &       14X,'specify the SNAP-ZONE.'                              )        LOOPd  806
 9112 FORMAT(14X,'Loop: ',8a4,' has SNAP-ZONE = '                      /        LOOPd  807
     &       14X,8A4,', but this zone is not served by this'           /        LOOPd  808
     &       14X,'loop.  Control may be poor.'                         )        LOOPd  809
 9113 FORMAT(14X,'Loop: ',8a4,' has zero design load.'                 /        LOOPd  810
     &       14X,'Check input for consistency, or specify design coil' /        LOOPd  811
     &       14X,'loads or primary equipment sizes.'                   )        LOOPd  812
 9114 FORMAT(14X,'Loop: ',8a4,' has zero design flow.'                 /        LOOPd  813
     &       14X,'Check input for consistency, or specify design'      ,        LOOPd  814
     &           ' loads.'                                             )        LOOPd  815
 9116 FORMAT(14X,'Loop: ',8A4,' does not have any pumps '              /        LOOPd  818
     &       14X,'directly attached, nor do the primary equipment'     /        LOOPd  819
     &       14X,'units.  You must define a pump.'                     )        LOOPd  820
 9117 FORMAT(14X,'Pump: ',8A4,' has a head setpoint'                   /        LOOPd  821
     &       14X,'specified, but does not have any type of capacity'   /        LOOPd  822
     &       14X,'control.  The setpoint will be ignored and the pump' /        LOOPd  823
     &       14X,'will ride the curve.'                                )        LOOPd  824
 9119 FORMAT(14X,'Loop: ',8a4,' has LOOP-OPERATION ='                  /        GLHX1  684
     &       14X,'SUBHOURLY-DEMAND, but this control mode is valid'    /        GLHX1  685
     &       14X,'only for WLHP and CW loops.  LOOP-OPERATION will be' /        GLHX1  686
     &       14X,'changed to DEMAND.'                                  )        GLHX1  687
 9120 FORMAT(14X,'Loop: ',8a4,' has a pump, but no return'             /        Proces  50
     &       14X,'flow. If a DHW loop, specify the LOOP-RECIRC-FLOW'   /        Proces  51
     &       14X,'or the LOOP-MIN-FLOW to create a return flow'        )        Proces  52
c                                                                               LOOPd  828
      END                                                                       LOOPd  829
      FUNCTION LoopLoadCheck(Jlp)                                               LOOPCK   2
c                                                                               LOOPCK   3
c              Checks to see if any additional loads have been placed           LOOPCK   4
c              on a loop since the loop was originally simulated                LOOPCK   5
c              in LoopSim                                                       LOOPCK   6
c                                                                               LOOPCK   7
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               LOOPCK  10
      LoopLoadCheck = 0                                                         LOOPCK  11
c              additional loads on primary loop                                 LOOPCK  12
      IF (<lp;PRIM_HEAT> + <lp;PRIM_HTREJ>                                      ChlrHP 726
     &                   + <lp;CogenQ> + <lp;AUX_HEAT> .NE. 0.)  THEN           ChlrHP 727
        LoopLoadCheck = 1                                                       LOOPCK  15
      ELSEIF (<lp;NUM_2ND_LOOPS> .GT. 0)  THEN                                  LOOPCK  16
c              additional loads on attached secondary loops                     LOOPCK  17
        Jlp1 = Jlp                                                              LOOPCK  18
        N2nd = <lp;NUM_2ND_LOOPS>                                               LOOPCK  19
        DO  L2=1,N2nd                                                           LOOPCK  20
          Jlp = <lp;PTR_2ND_LOOPS>                                              LOOPCK  21
          IF (<lp;PRIM_HEAT> + <lp;PRIM_HTREJ>                                  ChlrHP 728
     &                       + <lp;CogenQ> + <lp;AUX_HEAT> .NE. 0.)             ChlrHP 729
     &      LoopLoadCheck = 1                                                   LOOPCK  24
          Jlp = Jlp1                                                            LOOPCK  25
        ENDDO                                                                   LOOPCK  26
      ENDIF                                                                     LOOPCK  27
c                                                                               LOOPCK  28
      RETURN                                                                    LOOPCK  29
      END                                                                       LOOPCK  30
      SUBROUTINE LoopSim                                                        LOOPS    2
c                                                                               LOOPS    3
c              Calculates the loop temperatures and flows for a                 LOOPS    4
c              primary loop and its associated secondaries.                     LOOPS    5
c                                                                               LOOPS    6
c              Called from PLANT                                                LOOPS    7
c                                                                               LOOPS    8
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /DESHRQ/ NDESDY, IDDTYP(2), DESHRQ(360)                           Time     1
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /LOOP  / Nloop(16,2), NextType(40), NLP2,                         -41a     1
     &                 WLHPoff, RealCall, RegenFlag, Sim2x, LoopSimCount        ChlrHP   2
      LOGICAL          WLHPoff, RealCall, RegenFlag, Sim2x                      ChlrHP   3
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PTRSYS/ nzone , iz    , nczd  , zp2 ,         mtw  ,             -045a    1
     $                 nsys  , is    , nss   , nsp ,  ns   , icode,             HR      11
     $                 nsz   , isz   , nzd   , zp1 ,  nz   ,                    HR      12
     $                 nspace, lpr   ,                                          HR      13
     $                 nattch, iatt  ,                                          HR      14
     $                 P2, IDAYHR, IDBWBT,                                      HR      15
     $                 IRPPLT, IRPSUM, IRPSYS, IRPZON, MR1, MR2                 HR      16
      INTEGER          ZP1, ZP2, P2                                             /PTRSYS/14
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               LOOPS   23
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
c                                                                               LOOPS   25
      INTEGER SubType                                                           LOOPS   26
c                                                                               LOOPS   27
c              The loop calculations are as follows:                            LOOPS   28
c              1.  Transfer the load and temperature reset requirements         LOOPS   29
c                  from the secondary loops onto the primary loop.              LOOPS   30
c              2.  Determine whether the primary loop is running, and           LOOPS   31
c                  set its supply temperature.                                  LOOPS   32
c              3.  Constrain the operation and supply temperature               LOOPS   33
c                  of the secondary loops to the limits imposed by the          LOOPS   34
c                  primary loop.                                                LOOPS   35
c              4.  Calculate the coil flows (LoopCoilFlow) for                  LOOPS   36
c                  each secondary loop, and determine the secondary return      LOOPS   37
c                  temperature, loop head, and pumping energy (Pump).           LOOPS   38
c                  Transfer these to the primary.                               LOOPS   39
c              5.  Calculate the coil flows (LoopCoilFlow) for the primary,     LOOPS   40
c                  and determine the primary return temperature.                LOOPS   41
c                                                                               LOOPS   42
c                                                                               LOOPS   43
c              Reset the control mode to be as originally set in PLANTi         LOOPS   44
c              as a previous call to this routine may have changed it           LOOPS   45
      <lp;CTRL_MODE> = <lp;SCH_MODE>                                            LOOPS   46
c              type of loop (HW, CHW, etc.)                                     LOOPS   47
      LoopType = <lp:TYPE>                                                      LOOPS   48
c              number of secondary loops attached to this loop                  LOOPS   49
      N2nd = <lp;NUM_2ND_LOOPS>                                                 LOOPS   50
c              save primary loop pointer                                        LOOPS   51
      Jlp1 = Jlp                                                                LOOPS   52
c                                                                               LOOPS   53
c ****         run function : LoopSim-1                                         LOOPS   54
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        LOOPS   55
c                                                                               LOOPS   56
c                                                                               LOOPS   57
c                                                                               LOOPS   58
c============= TRANSFER SECONDARY LOOP REQUIREMENTS TO PRIMARY ================ LOOPS   59
c              If secondary loops are attached to this primary, transfer        LOOPS   60
c              the load, operation, and temperature reset requirement           LOOPS   61
c              onto the primary                                                 LOOPS   62
      IF (N2nd .GT. 0)  THEN                                                    LOOPS   63
c              rezero these quantities, as this routine may be called           LOOPS   64
c              more than once in an hour, and this stuff will have to           LOOPS   65
c              be recounted.                                                    LOOPS   66
        <lp;2ND_HEAT> = 0.                                                      LOOPS   67
        <lp;2ND_COOL> = 0.                                                      LOOPS   68
        <lp;2ND_GPM>  = 0.                                                      LOOPS   69
        <lp;2ND_GPMr> = 0.                                                      LOOPS   70
        <lp;2ndGPMr*T> = 0.                                                     -41a     6
        DO 100  L2=1,N2nd                                                       LOOPS   71
c              pointer to secondary loop                                        LOOPS   72
          Jlp = Jlp1                                                            LOOPS   73
          Jlp = <lp;PTR_2ND_LOOPS>                                              LOOPS   74
c              reset the control mode to be as originally set in PLANTi         LOOPS   75
c              as a previous call to this routine may have changed it           LOOPS   76
          <lp;CTRL_MODE> = <lp;SCH_MODE>                                        LOOPS   77
c              Secondary loop demands - note that heating and cooling           LOOPS   78
c              loads will never both be non-zero each hour, except              LOOPS   79
c              possibly for desiccant systems where loop_coil_cool is           LOOPS   80
c              actually a heating load representing the heat                    LOOPS   81
c              required to regenerate the desiccant                             LOOPS   82
c                    heating/cooling coils and process load                     LOOPS   83
          Qloop =  <lp;COIL_HEAT> + <lp;COIL_COOL>                              LOOPS   84
     &                            + <lp;PROCESS_Q>                              LOOPS   85
c                    primary equipment - heating                                LOOPS   86
          Qprim = <lp;PRIM_HEAT> + <lp;TES_CHRG_HEAT>                           ChlrHP 730
c                    auxiliary heating for tower sumps, TES freeze              LOOPS   88
     &          + <lp;AUX_HEAT>                                                 LOOPS   89
c                    primary equipment - cooling/condenser                      LOOPS   90
     &          + <lp;TES_CHRG_COOL> + <lp;PRIM_HTREJ> + <lp;CogenQ>            LOOPS   91
c                    thermal losses                                             LOOPS   92
          Qloss = <lp;SUPPLY_LOSS> + <lp;RETURN_LOSS>                           LOOPS   93
c              net loop load - include pump heat (last hours, will be           LOOPS   94
c              adjusted later)                                                  LOOPS   95
          QloopNet = Qloop + Qprim + Qloss + <lp;PUMP_Q_PAST>                   LOOPS   96
c                                                                               LOOPS   97
c              determine whether secondary wants to run: 0 OFF  1 ON            LOOPS   98
          IRUN2 = 0                                                             LOOPS   99
c              Loop control mode as initialized at beginning of                 LOOPS  100
c              hour - off, floating, heating, cooling                           LOOPS  101
          LoopCtrl = <lp;CTRL_MODE>                                             LOOPS  102
          IF (LoopType .EQ. DHW)  THEN                                          Bug40  110
c              DHW is special case because load can exist when pump off         Bug40  111
            IF (<lp:OPERATION> .EQ. 0)  THEN                                    Bug40  112
              IF (Qloop .EQ. 0.)  <lp;CTRL_MODE>  = OffMode                     Bug40  113
            ELSEIF (<lp:OPERATION> .EQ. DEMAND)  THEN                           -041j    1
              IF (Qloop .EQ. 0.)  THEN                                          -041j    2
                <lp;CTRL_MODE>  = OffMode                                       -041j    3
                <lp;RunDHWPump> = 0.                                            -041j    4
              ELSEIF (<lp:RECIRC-GPM> .eq. 0.  .and.                            -041j    5
     &                           (<lp;COIL_HEAT>+Qprim) .EQ. 0.)  THEN          -041j    6
                <lp;RunDHWPump> = 0.                                            -041j    7
              ENDIF                                                             -041j    8
            ENDIF                                                               Bug40  118
            IF (<lp;CTRL_MODE> .NE. OffMode)  IRUN2 = 1                         Bug40  119
          ELSEIF (LoopCtrl .NE. OffMode)  THEN                                  Bug40  120
c              loop is not forced off                                           Bug40  121
            IF (<lp:OPERATION> .EQ. DEMAND  .OR.                                Bug40  122
     &          <lp:OPERATION> .EQ. SubhourDemand)  THEN                        Bug40  123
c              loop runs only when a demand exists                              Bug40  124
              IF (ABS(Qloop)+ABS(Qprim) .GT. 1.)  IRUN2 = 1                     Bug40  125
            ELSEIF (<lp:OPERATION> .eq. STANDBY  .or.                           -041k   12
     &              <lp:OPERATION> .eq. SNAP)  THEN                             -041k   13
c              loop runs anytime an associated system is running,               Bug40  127
c              and system level heat/cool scheduled on                          Bug40  128
              IF (<lp;RUNNING> .GT. 0  .OR.  ABS(Qprim) .GT. 1.)                Bug40  129
     &                                                        IRUN2 = 1         Bug40  130
            ELSE                                                                Bug40  131
c              scheduled operation - if scheduled off, then                     -041k   14
c              control mode would have been OffMode                             Bug40  133
              IRUN2 = 1                                                         Bug40  134
            ENDIF                                                               Bug40  135
          ENDIF                                                                 Bug40  136
c              force on if LOAD-MANAGEMENT says so                              LOOPS  118
          IF (<lp;OVERRIDE> .GT. 0)  IRUN2 = 1                                  LOOPS  119
c              regardless of the above, force a condenser loop on               LOOPS  120
c              if a chiller says so                                             LOOPS  121
          IF (<lp;PRIM_GPM> .GT. 0.  .OR.  <lp;CogenGPM> .GT. 0.)  THEN         ChlrHP 731
            IF (LoopType .EQ. CW)  THEN                                         ChlrHP 732
              IRUN2          = 1                                                ChlrHP 735
            ELSEIF (LoopType .EQ. WLHP)  THEN                                   ChlrHP 736
              IRUN2 = 1                                                         ChlrHP 737
            ENDIF                                                               ChlrHP 745
          ENDIF                                                                 ChlrHP 746
c              non-zero means this loop is running                              LOOPS  127
          <lp;RUNNING> = IRUN2                                                  LOOPS  128
c              skip if loop is off                                              LOOPS  129
          IF (IRUN2 .EQ. 0)  CYCLE                                              LOOPS  130
c                                                                               LOOPS  131
c              Now set secondary supply temperature for hw and chw loops        LOOPS  132
c              Skip for condenser or dhw loops as it is irrelevant at this      LOOPS  133
c              point                                                            LOOPS  134
          IF (<lp;HWorCHW> .EQ. 1  .AND.  LoopCtrl .GT. FLOATING)  THEN         LOOPS  135
c              first, determine the loop's floating temperature                 LOOPS  136
c              past hour's average temperature                                  LOOPS  137
            TavgPast = (<lp;SUPPLY_AVG>+<lp;RETURN_AVG>) * 0.5                  LOOPS  138
c              temperature change if loop floats                                LOOPS  139
            dTfloat  = QloopNet / <lp;BTU/F>                                    LOOPS  140
c              average temperature if loop floats                               LOOPS  141
            Tfloat   = TavgPast + dTfloat*0.5                                   LOOPS  142
c              secondary loop temperature setpoint                              LOOPS  143
            IF ((LoopCtrl .EQ. HEATMODE  .AND.                                  -041e    1
     &                  (<lp:HT-SETPT-CTRL> .EQ. LOAD  .OR.                     -041e    2
     &                   <lp:HT-SETPT-CTRL> .EQ. 0     .OR.                     -041e    3
     &                   <lp;HCAP_RATIO> .LT. 0.95))   .OR.                     -041e    4
     &          (LoopCtrl .EQ. COOLMODE  .AND.                                  -041e    5
     &                  (<lp:CL-SETPT-CTRL> .EQ. LOAD  .OR.                     -041e    6
     &                   <lp:CL-SETPT-CTRL> .EQ. 0     .OR.                     -041e    7
     &                   <lp;CCAP_RATIO> .LT. 0.95)))  THEN                     -041e    8
c              setpoint reset on load - override if there is a                  LOOPS  150
c              load from process or primary equipment                           LOOPS  151
              IF (Qprim .EQ. 0)  THEN                                           LOOPS  152
c              most extreme fluid temperature as found in LoopCoilLoad          LOOPS  153
                Tcoil = <lp;COIL_EWT>                                           LOOPS  154
c              translate reset temp from coil temp to controller                LOOPS  155
c              temp (at entrance to secondary loop)                             LOOPS  156
                IF (<lp;HOURS_RUNNING> .GT. 0)  THEN                            -044c    1
                  Tset = Tcoil - <lp;SUPPLY_DT>                                 -044c    2
                ELSE  ! start-up; loss dT not yet switched with decay dT        -044c    3
                  Tset = Tcoil - <lp;SupplyDTSave>                              -044c    4
                ENDIF                                                           -044c    5
c              limit the maximum reset                                          LOOPS  158
                Tset = MAX(<lp:MIN-RESET-T>,                                    LOOPS  159
     &                       MIN(<lp:MAX-RESET-T>, Tset))                       LOOPS  160
              ELSE                                                              LOOPS  161
c              no temperature reset when a process load or primary load         LOOPS  162
                IF (LoopCtrl .EQ. HEATMODE)  THEN                               LOOPS  163
                  Tset = <lp:DESIGN-HEAT-T>                                     -041e    9
c              override setpoint if a TES device demanding                      LOOPS  165
                  IF (<lp;TES_T> .NE. 0.)  Tset = MAX(Tset,<lp;TES_T>)          LOOPS  166
                  THR  = 0.5 - QloopNet/<lp;DES_HCAP>                           LOOPS  167
                ELSE                                                            LOOPS  168
                  Tset = <lp:DESIGN-COOL-T>                                     -041e   10
c              override setpoint if a TES device demanding                      LOOPS  170
                  IF (<lp;TES_T> .NE. 0.)  Tset = MIN(Tset,<lp;TES_T>)          LOOPS  171
                  THR  = QloopNet/<lp;DES_CCAP> - 0.5                           LOOPS  172
                ENDIF                                                           LOOPS  173
                THR  = MAX(-0.5, MIN(0.5, THR)) * <lp:SETPT-RNG>                LOOPS  174
                Tset = Tset + THR                                               LOOPS  175
              ENDIF                                                             LOOPS  176
c              store reset setpoint if actually using reset control,            LOOPS  177
c              and loop not floating due to overload                            LOOPS  178
              IF (LoopCtrl .EQ. HEATMODE  .AND.                                 LOOPS  179
     &                                   <lp:HT-SETPT-CTRL> .EQ. LOAD)          LOOPS  180
     &            <lp;HEAT_SETPT> = Tset                                        LOOPS  181
              IF (LoopCtrl .EQ. COOLMODE  .AND.                                 LOOPS  182
     &                                   <lp:CL-SETPT-CTRL> .EQ. LOAD)          LOOPS  183
     &            <lp;COOL_SETPT> = Tset                                        LOOPS  184
            ELSE                                                                LOOPS  185
c              all temp setpoint control strategies other than load reset       LOOPS  186
              IF (LoopCtrl .EQ. HEATMODE)  THEN                                 LOOPS  187
                Tset = <lp;HEAT_SETPT>                                          LOOPS  188
c              override setpoint if a TES device demanding                      LOOPS  189
                IF (<lp;TES_T> .NE. 0.)  Tset = MAX(Tset,<lp;TES_T>)            LOOPS  190
                THR  = 0.5 - QloopNet/<lp;DES_HCAP>                             LOOPS  191
              ELSE                                                              LOOPS  192
                Tset = <lp;COOL_SETPT>                                          LOOPS  193
c              override setpoint if a TES device demanding                      LOOPS  194
                IF (<lp;TES_T> .NE. 0.)  Tset = MIN(Tset,<lp;TES_T>)            LOOPS  195
                THR  = QloopNet/<lp;DES_CCAP> - 0.5                             LOOPS  196
              ENDIF                                                             LOOPS  197
              THR  = MAX(-0.5, MIN(0.5, THR)) * <lp:SETPT-RNG>                  LOOPS  198
              Tset = Tset + THR                                                 LOOPS  199
            ENDIF                                                               LOOPS  200
            IF (LoopCtrl .EQ. HEATMODE)  THEN                                   LOOPS  201
c              loop may be floating above the heating setpoint                  LOOPS  202
              Tsupply = MAX(Tset, Tfloat)                                       LOOPS  203
              IF (<lp:LOCN> .EQ. 0)                                             -035   110
     &          Tsupply = MIN(Tsupply, Tset+10.)                                -035   111
            ELSE                                                                LOOPS  204
c              loop may be floating below the cooling setpoint                  LOOPS  205
              Tsupply = MIN(Tset, Tfloat)                                       LOOPS  206
            ENDIF                                                               LOOPS  207
c              temperature entering the secondary loop                          LOOPS  208
            <lp;SUPPLY_T> = Tsupply                                             LOOPS  209
c              temporarily store the floating temperature                       LOOPS  210
            <lp;COIL_EWT> = Tfloat                                              LOOPS  211
            IF (<lp:LOCN> .EQ. 0)                                               -035   112
     &        <lp;COIL_EWT> = MIN(<lp;COIL_EWT>, Tset+10.)                      -035   113
c              adjust primary temperature request from secondary loop           LOOPS  212
c              for secondary pump heat                                          LOOPS  213
            Tset = Tset - <lp;PUMP_DT_PAST>                                     LOOPS  214
          ENDIF  ! hw, chw, and 2-pipe entering loop temp calcs                 LOOPS  215
c                                                                               LOOPS  216
c              save net secondary loop load                                     LOOPS  217
          <lp;Q_NET> = QloopNet                                                 LOOPS  218
c              now transfer secondary data to primary                           LOOPS  219
c              get pointer to attached primary loop                             LOOPS  220
          Jlp2 = Jlp                                                            LOOPS  221
          Jlp  = Jlp1                                                           LOOPS  222
c              transfer secondary standby status to primary                     LOOPS  223
          <lp;RUNNING> = <lp;RUNNING> + IRUN2                                   LOOPS  224
c              transfer secondary loads to primary                              LOOPS  225
          IF (QloopNet .LT. 0.)  THEN                                           LOOPS  226
            <lp;2ND_HEAT> = <lp;2ND_HEAT> + QloopNet                            LOOPS  227
          ELSE                                                                  LOOPS  228
            <lp;2ND_COOL> = <lp;2ND_COOL> + QloopNet                            LOOPS  229
          ENDIF                                                                 LOOPS  230
c              transfer secondary temp reset requirement to primary             LOOPS  231
          IF (LoopCtrl .EQ. HEATMODE)  THEN                                     LOOPS  232
            <lp;COIL_EWT> = MAX(<lp;COIL_EWT>, Tset)                            LOOPS  233
          ELSEIF (LoopCtrl .EQ. COOLMODE)  THEN                                 LOOPS  234
            <lp;COIL_EWT> = MIN(<lp;COIL_EWT>, Tset)                            LOOPS  235
          ENDIF                                                                 LOOPS  236
c              end of initial secondary loop calcs                              LOOPS  237
  100   CONTINUE                                                                LOOPS  238
      ENDIF                                                                     LOOPS  239
c                                                                               LOOPS  240
c============= PRIMARY LOOP OPERATION AND TEMPERATURE ========================= LOOPS  241
c              determine if the primary loop is running                         LOOPS  242
      Jlp = Jlp1                                                                LOOPS  243
      LoopCtrl = <lp;CTRL_MODE>                                                 LOOPS  244
c              primary loop demands - note that heating and cooling             LOOPS  245
c              loads will never both be non-zero each hour                      LOOPS  246
c                    heating/cooling coils and process load                     LOOPS  247
      Qloop =  <lp;COIL_HEAT> + <lp;COIL_COOL>                                  LOOPS  248
     &                        + <lp;PROCESS_Q>                                  LOOPS  249
c                    secondary loop loads                                       LOOPS  250
     &      +  <lp;2ND_HEAT>  + <lp;2ND_COOL>                                   LOOPS  251
c                    primary equipment - heating                                LOOPS  252
      Qprim = <lp;PRIM_HEAT> + <lp;TES_CHRG_HEAT>                               ChlrHP 747
c                    auxiliary heating for tower sumps, TES freeze              LOOPS  254
     &      + <lp;AUX_HEAT>                                                     LOOPS  255
c                    primary equipment - cooling/condenser                      LOOPS  256
     &      + <lp;TES_CHRG_COOL> + <lp;PRIM_HTREJ> + <lp;CogenQ>                LOOPS  257
c              net loop load - include pump heat (last hours, will be           LOOPS  258
c              adjusted later)                                                  LOOPS  259
      QloopNet = Qloop + Qprim + <lp;PUMP_Q_PAST>                               LOOPS  260
c                                                                               LOOPS  261
c              determine whether primary loop is running: 0 OFF  1 ON           LOOPS  262
      IRUN1 = 0                                                                 LOOPS  263
      IF (LoopType .EQ. DHW)  THEN                                              Bug40  137
c              DHW is special case because load can exist when pump off         Bug40  138
        IF (<lp:OPERATION> .EQ. 0)  THEN                                        Bug40  139
          IF (Qloop .EQ. 0.)  <lp;CTRL_MODE>  = OffMode                         Bug40  140
        ELSEIF (<lp:OPERATION> .EQ. DEMAND)  THEN                               -041j    9
          IF (Qloop .EQ. 0.)  THEN                                              -041j   10
            <lp;CTRL_MODE>  = OffMode                                           -041j   11
            <lp;RunDHWPump> = 0.                                                -041j   12
          ELSEIF (<lp:RECIRC-GPM> .eq. 0.  .and.                                -041j   13
     &                           (<lp;COIL_HEAT>+Qprim) .EQ. 0.)  THEN          -041j   14
            <lp;RunDHWPump> = 0.                                                -041j   15
          ENDIF                                                                 -041j   16
        ENDIF                                                                   Bug40  144
        IF (<lp;CTRL_MODE> .NE. OffMode)  IRUN1 = 1                             Bug40  145
      ELSEIF (LoopCtrl .NE. OFFMODE)  THEN                                      Bug40  146
        IF (<lp:OPERATION> .EQ. DEMAND  .OR.                                    Bug40  147
     &      <lp:OPERATION> .EQ. SubhourDemand)  THEN                            Bug40  148
c              loop runs only when a demand exists                              Bug40  149
          IF (ABS(Qloop)+ABS(Qprim) .GT. 1.)  IRUN1 = 1                         Bug40  150
        ELSEIF (<lp:OPERATION> .eq. STANDBY  .or.                               -041k   15
     &          <lp:OPERATION> .eq. SNAP)  THEN                                 -041k   16
c              loop runs anytime an associated system or secondary loop         Bug40  152
c              is running, and heat/cool scheduled on                           Bug40  153
          IF (<lp;RUNNING> .GT. 0  .OR.  ABS(Qprim) .GT. 1.)  IRUN1 = 1         Bug40  154
        ELSE                                                                    Bug40  155
c              scheduled operation - if scheduled off, then                     -041k   17
c              control mode would have been offmode                             Bug40  157
          IRUN1 = 1                                                             Bug40  158
        ENDIF                                                                   Bug40  159
      ENDIF                                                                     Bug40  160
c              force on if LOAD-MANAGEMENT says so                              LOOPS  281
      IF (<lp;OVERRIDE> .GT. 0)  IRUN1 = 1                                      LOOPS  282
c              regardless of the above, force a condenser loop on               LOOPS  283
c              if a chiller or other water-cooled condenser says so             LOOPS  284
      IF (<lp;PRIM_GPM> .GT. 0.  .OR.  <lp;CogenGPM> .GT. 0.)  THEN             ChlrHP 748
        IF (LoopType .EQ. CW)  THEN                                             ChlrHP 749
          <lp;CTRL_MODE> = COOLMODE                                             ChlrHP 750
          LoopCtrl       = COOLMODE                                             ChlrHP 751
          IRUN1          = 1                                                    ChlrHP 752
        ELSEIF (LoopType .EQ. WLHP)  THEN                                       ChlrHP 753
          IRUN1 = 1                                                             ChlrHP 754
          IF (QloopNet .LT. 0.)  THEN                                           ChlrHP 755
            <lp;CTRL_MODE> = HEATMODE                                           ChlrHP 756
            LoopCtrl       = HEATMODE                                           ChlrHP 757
          ELSE                                                                  ChlrHP 758
            <lp;CTRL_MODE> = COOLMODE                                           ChlrHP 759
            LoopCtrl       = COOLMODE                                           ChlrHP 760
          ENDIF                                                                 ChlrHP 761
        ENDIF                                                                   ChlrHP 762
      ENDIF                                                                     ChlrHP 763
c              non-zero means this loop is running                              LOOPS  290
      <lp;RUNNING> = IRUN1                                                      LOOPS  291
c                                                                               LOOPS  292
c              Adjust losses if a transition hour (first hour on or off)        LOOPS  293
      IF (LoopSimCount .EQ. 1)  THEN                                            -41a     7
c              Switch loss values with those of the last transition             -41a     8
c              (switches a flow loss for a decay loss, and opposite)            -41a     9
        IF (<lp;RUNNING> .EQ. 0  .AND. <lp;HOURS_RUNNING> .GT. 0)  THEN         -41a    10
          Call SwitchSupply                                                     -048   119
          IF (<lp;GPMr_PAST> .GT. 0.)  Call SwitchReturn                        -048   120
        ELSEIF (<lp;RUNNING> .EQ. 1 .AND.                                       -41a    13
     &                                   <lp;HOURS_RUNNING> .LT. 0) THEN        -41a    14
          Call SwitchSupply                                                     -048   121
          IF (LoopType .NE. DHW)  Call SwitchReturn                             -048   122
        ENDIF                                                                   -41a    17
      ENDIF                                                                     -41a    18
c              skip if loop is off                                              LOOPS  311
      IF (IRUN1 .EQ. 0)  THEN                                                   LOOPS  312
        <lp;RUNNING> = 0                                                        LOOPS  313
        GOTO 110                                                                LOOPS  314
      ENDIF                                                                     LOOPS  315
c                                                                               LOOPS  316
c              Set the primary supply temperature                               LOOPS  317
c              first, determine the loop's floating temperature                 LOOPS  318
c              past hour's average temperature                                  LOOPS  319
      TavgPast = (<lp;SUPPLY_AVG>+<lp;RETURN_AVG>) * 0.5                        LOOPS  320
c              temperature change if loop floats                                LOOPS  321
      dTfloat  = QloopNet / <lp;BTU/F>                                          LOOPS  322
      IF (ABS(dTfloat) .LT. 0.01)  LoopCtrl = FLOATING                          -033     6
c              ending temperature if loop floats                                LOOPS  323
      Tend     = TavgPast + dTfloat                                             LOOPS  324
c              average temperature if loop floats                               LOOPS  325
      Tfloat   = TavgPast + dTfloat*0.5                                         LOOPS  326
      IF (<lp;HWorCHW> .EQ. 1  .AND.  LoopCtrl .GT. FLOATING)  THEN             LOOPS  327
c              primary loop temperature setpoint                                LOOPS  328
        IF ((LoopCtrl .EQ. HEATMODE  .AND.                                      -044c    6
     &       (<lp:HT-SETPT-CTRL> .EQ. LOAD    .OR.                              -044c    7
     &        (<lp;HOURS_RUNNING> .GT. 0  .AND.                                 -044c    8
     &           <lp;HCAP_RATIO> .LT. 0.95)   .OR.                              -044c    9
     &        (<lp;HOURS_RUNNING> .LT. 0  .AND.                                 -044c   10
     &           QloopNet/<lp;DES_HCAP> .gt. <lp;HCAP_RATIO>*.9)))              -044c   11
     &    .OR.                                                                  -044c   12
     &      (LoopCtrl .EQ. COOLMODE  .AND.                                      -044c   13
     &       (<lp:CL-SETPT-CTRL> .EQ. LOAD    .OR.                              -044c   14
     &        (<lp;HOURS_RUNNING> .GT. 0  .AND.                                 -044c   15
     &           <lp;CCAP_RATIO> .LT. 0.95)   .OR.                              -044c   16
     &        (<lp;HOURS_RUNNING> .LT. 0  .AND.                                 -044c   17
     &           QloopNet/<lp;DES_CCAP> .gt. <lp;CCAP_RATIO>*.9)))) THEN        -044c   18
c              setpoint reset on load - override if there is a                  LOOPS  335
c              load from process or primary equipment                           LOOPS  336
          IF (Qprim .EQ. 0)  THEN                                               LOOPS  337
c              most extreme fluid temperature as found in LoopCoilLoad          LOOPS  338
            Tcoil = <lp;COIL_EWT>                                               LOOPS  339
c              translate reset temp from coil temp to controller                LOOPS  340
c              temp (at central plant)                                          LOOPS  341
            Tset = Tcoil - <lp;SUPPLY_DT>                                       LOOPS  342
c              limit the maximum reset                                          LOOPS  343
            Tset = MAX(<lp:MIN-RESET-T>,                                        LOOPS  344
     &                     MIN(<lp:MAX-RESET-T>, Tset))                         LOOPS  345
          ELSE                                                                  LOOPS  346
c              no temperature reset when a process load or primary load         LOOPS  347
            IF (LoopCtrl .EQ. HEATMODE)  THEN                                   LOOPS  348
              Tset = <lp;HEAT_SETPT>                                            LOOPS  349
c              override setpoint if a TES device demanding                      LOOPS  350
              IF (<lp;TES_T> .NE. 0.)  Tset = MAX(Tset,<lp;TES_T>)              LOOPS  351
              THR  = 0.5 - QloopNet/<lp;DES_HCAP>                               LOOPS  352
            ELSE                                                                LOOPS  353
              Tset = <lp;COOL_SETPT>                                            LOOPS  354
c              override setpoint if a TES device demanding                      LOOPS  355
              IF (<lp;TES_T> .NE. 0.)  Tset = MIN(Tset,<lp;TES_T>)              LOOPS  356
              THR  = QloopNet/<lp;DES_CCAP> - 0.5                               LOOPS  357
            ENDIF                                                               LOOPS  358
            THR  = MAX(-0.5, MIN(0.5, THR)) * <lp:SETPT-RNG>                    LOOPS  359
            Tset = Tset + THR                                                   LOOPS  360
          ENDIF                                                                 LOOPS  361
c              store reset setpoint if actually using reset control,            LOOPS  362
c              and loop not floating due to overload                            LOOPS  363
          IF (LoopCtrl .EQ. HEATMODE  .AND.                                     LOOPS  364
     &                                   <lp:HT-SETPT-CTRL> .EQ. LOAD)          LOOPS  365
     &        <lp;HEAT_SETPT> = Tset                                            LOOPS  366
          IF (LoopCtrl .EQ. COOLMODE  .AND.                                     LOOPS  367
     &                                   <lp:CL-SETPT-CTRL> .EQ. LOAD)          LOOPS  368
     &        <lp;COOL_SETPT> = Tset                                            LOOPS  369
        ELSE                                                                    LOOPS  370
c              all other setpoint control strategies                            LOOPS  371
          IF (LoopCtrl .EQ. HEATMODE)  THEN                                     LOOPS  372
            Tset = <lp;HEAT_SETPT>                                              LOOPS  373
c              override setpoint if a TES device demanding                      LOOPS  374
            IF (<lp;TES_T> .NE. 0.)  Tset = MAX(Tset,<lp;TES_T>)                LOOPS  375
            THR  = 0.5 - QloopNet/<lp;DES_HCAP>                                 LOOPS  376
          ELSE                                                                  LOOPS  377
            Tset = <lp;COOL_SETPT>                                              LOOPS  378
c              override setpoint if a TES device demanding                      LOOPS  379
            IF (<lp;TES_T> .NE. 0.)  Tset = MIN(Tset,<lp;TES_T>)                LOOPS  380
            THR  = QloopNet/<lp;DES_CCAP> - 0.5                                 LOOPS  381
          ENDIF                                                                 LOOPS  382
c              throttling range - range is calculated later for towers          LOOPS  383
          IF (LoopType .NE. CW)  THEN                                           LOOPS  384
            THR  = MAX(-0.5, MIN(0.5, THR))*<lp:SETPT-RNG>                      LOOPS  385
          ELSE                                                                  LOOPS  386
            THR  = 0.                                                           LOOPS  387
          ENDIF                                                                 LOOPS  388
          Tset   = Tset + THR                                                   LOOPS  389
        ENDIF                                                                   LOOPS  390
        IF (LoopCtrl .EQ. HEATMODE)  THEN                                       LOOPS  391
c              loop may be floating above the heating setpoint                  LOOPS  392
              Tsupply = MAX(Tset, Tfloat)                                       LOOPS  393
              IF (<lp:LOCN> .EQ. 0)                                             -035   114
     &          Tsupply = MIN(Tsupply, Tset+10.)                                -035   115
        ELSE                                                                    LOOPS  394
c              loop may be floating below the cooling setpoint                  LOOPS  395
              Tsupply = MIN(Tset, Tfloat)                                       LOOPS  396
        ENDIF                                                                   LOOPS  397
c              temperature entering the primary loop                            LOOPS  398
        <lp;SUPPLY_T> = Tsupply                                                 LOOPS  399
c              translate the primary loop supply temperature from the           LOOPS  400
c              plant to the coils and/or secondary loops                        LOOPS  401
        Tcoil1 = Tsupply + <lp;SUPPLY_DT>                                       LOOPS  402
        <lp;COIL_EWT> = Tcoil1                                                  LOOPS  403
c              end of hw, chw, and 2-pipe entering coil temp calcs              LOOPS  404
      ELSEIF (LoopType .EQ. WLHP)  THEN                                         LOOPS  405
c              use supply temperature estimated in PLANTi                       LOOPS  406
        Tsupply = <lp;SUPPLY_T>                                                 LOOPS  407
        Tcoil1  = <lp;COIL_EWTest>                                              Bug40  161
        IF (Tend .LE. <lp;HEAT_SETPT>+<lp;SETPT_RNG2>)  THEN                    LOOPS  409
          THR  = MAX(-0.5, MIN(0.5, 0.5-QloopNet/<lp;DES_HCAP>))                LOOPS  410
     &         * <lp:SETPT-RNG>                                                 LOOPS  411
          Tset = <lp;HEAT_SETPT> + THR                                          LOOPS  412
          <lp;HEAT_SETPT> = Tset                                                LOOPS  413
        ENDIF                                                                   LOOPS  414
      ELSEIF (LoopType .EQ. CW)  THEN                                           LOOPS  415
        IF (<lp;FreeCoolChlr> .LT. 0)  THEN                                     FreeCl  46
c              free cooling is active                                           FreeCl  47
          Jch             = -<lp;FreeCoolChlr>                                  FreeCl  48
          Tsupply         = <ch;ECTsetpt>                                       FreeCl  49
          Tcoil1          = <ch;ECTsetpt>                                       FreeCl  50
          <lp;COOL_SETPT> = <ch;ECTsetpt>                                       FreeCl  51
        ELSE                                                                    FreeCl  52
          Tsupply = <lp;SUPPLY_T>                                               FreeCl  53
          Tcoil1  = <lp;COIL_EWTest>                                            Bug40  162
        ENDIF                                                                   FreeCl  55
      ELSEIF (LoopType .EQ. DHW)  THEN                                          LOOPS  419
c              no throttling range for DHW                                      LOOPS  420
        Tset    = <lp;HEAT_SETPT>                                               LOOPS  421
        Tsupply = Tset                                                          LOOPS  422
        Tcoil1  = Tsupply + <lp;SUPPLY_DT>                                      LOOPS  423
        <lp;SUPPLY_T> = Tsupply                                                 LOOPS  424
        <lp;COIL_EWT> = Tcoil1                                                  LOOPS  425
      ENDIF                                                                     LOOPS  426
c              end of primary loop setpoint calcs                               LOOPS  427
  110 CONTINUE                                                                  LOOPS  428
      <lp;2ND_HEAT> = 0.                                                        SG0701   1
      <lp;2ND_COOL> = 0.                                                        SG0701   2
c                                                                               LOOPS  429
c============= TRANSFER PRIMARY OPERATION TO SECONDARIES ====================== LOOPS  430
c              constrain secondary loop operation to the limits imposed         LOOPS  431
c              by the primary loop                                              LOOPS  432
      RunDHWPump = <lp;RunDHWPump>                                              Bug40  163
      DO  L2=1,N2nd                                                             LOOPS  433
c              pointer to secondary loop                                        LOOPS  434
        Jlp = Jlp1                                                              LOOPS  435
        Jlp = <lp;PTR_2ND_LOOPS>                                                LOOPS  436
c              secondary can run only when primary is running                   LOOPS  437
        IF (IRUN1 .EQ. 0  .or.  <lp;CTRL_MODE> .eq. OFFMODE)  THEN              -044e    2
          <lp;RUNNING> = 0                                                      LOOPS  439
        ELSE                                                                    LOOPS  440
c              secondary loop without pump always runs with primary             LOOPS  441
          IF (<lp:PUMP> .EQ. 0)  THEN                                           Bug40  164
            <lp;RUNNING>    = IRUN1                                             Bug40  165
            <lp;RunDHWPump> = RunDHWPump                                        Bug40  166
          ENDIF                                                                 Bug40  167
        ENDIF                                                                   LOOPS  443
        IF (LoopSimCount .EQ. 1)  THEN                                          -41a    19
c              Switch loss values with those of the last transition             -41a    20
c              (switches a flow loss for a decay loss, and opposite)            -41a    21
          IF (<lp;RUNNING> .EQ. 0  .AND. <lp;HOURS_RUNNING> .GT. 0) THEN        -41a    22
            Call SwitchSupply                                                   -048   123
            IF (<lp;GPMr_PAST> .GT. 0.)  Call SwitchReturn                      -048   124
          ELSEIF (<lp;RUNNING> .EQ. 1 .AND.                                     -41a    25
     &                                   <lp;HOURS_RUNNING> .LT. 0) THEN        -41a    26
            Call SwitchSupply                                                   -048   125
            IF (LoopType .NE. DHW)  Call SwitchReturn                           -048   126
          ENDIF                                                                 -41a    29
        ENDIF                                                                   -41a    30
        IF (<lp;RUNNING> .EQ. 0)  CYCLE                                         LOOPS  444
c                                                                               LOOPS  445
c              temperature entering secondary from primary                      LOOPS  446
        Ts1 = Tcoil1                                                            LOOPS  447
c              check if secondary loop has a pump                               LOOPS  448
        IF (<lp:PUMP> .EQ. 0)  THEN                                             LOOPS  449
c              2nd temp must be whatever comes from primary                     LOOPS  450
          Tsupply = Ts1                                                         LOOPS  451
        ELSE                                                                    LOOPS  452
c              increment primary temp by secondary pump heat - do not           LOOPS  453
c              increment for secondary dhw as this pump is on the               LOOPS  454
c              return side                                                      LOOPS  455
          IF (LoopType .NE. DHW)  Ts1 = Ts1 + <lp;PUMP_DT_PAST>                 LOOPS  456
          IF (<lp;HWorCHW> .EQ. 0)  THEN                                        LOOPS  457
c              these loops have no active secondary temperature control         LOOPS  458
            Tsupply = Ts1                                                       LOOPS  459
          ELSE                                                                  LOOPS  460
c              a HW or CHW loop with a pump may have its own                    LOOPS  461
c              temperature setpoint, but the setpoint is limited by what        LOOPS  462
c              is available from the primary                                    LOOPS  463
            IF (<lp;CTRL_MODE> .EQ. HEATMODE)  THEN                             LOOPS  464
c              secondary supply temperature can be floating above               LOOPS  465
c              the primary supply temperature                                   LOOPS  466
c              (float temp was stored in coil_t)                                LOOPS  467
              Tsupply = MAX(Ts1, <lp;COIL_EWT>)                                 LOOPS  468
              Tsupply = MIN(Tsupply,<lp;SUPPLY_T>)                              LOOPS  469
            ELSE                                                                LOOPS  470
              Tsupply = MIN(Ts1, <lp;COIL_EWT>)                                 LOOPS  471
              Tsupply = MAX(Tsupply,<lp;SUPPLY_T>)                              LOOPS  472
            ENDIF                                                               LOOPS  473
          ENDIF                                                                 LOOPS  474
        ENDIF                                                                   LOOPS  475
        <lp;SUPPLY_T> = Tsupply                                                 LOOPS  476
        <lp;COIL_EWT> = Tsupply + <lp;SUPPLY_DT>                                LOOPS  477
      ENDDO  ! secondary constraints                                            LOOPS  478
c                                                                               LOOPS  479
c============= CALCULATE LOOP FLOWS AND RETURN TEMPERATURES =================== LOOPS  480
c              Now that the loop temperature(s) entering the coil(s) are        LOOPS  481
c              known, calculate the loop flows and temperatures.                LOOPS  482
c              Do secondary loops first                                         LOOPS  483
      L2  = 0                                                                   LOOPS  484
  240 Jlp = Jlp1                                                                LOOPS  485
      IF (L2 .LT. N2nd)  THEN                                                   LOOPS  486
        SubType = SECONDARY                                                     LOOPS  487
        L2  = L2 + 1                                                            LOOPS  488
        Jlp = <lp;PTR_2ND_LOOPS>                                                LOOPS  489
      ELSE                                                                      LOOPS  490
        SubType = PRIMARY                                                       LOOPS  491
      ENDIF                                                                     LOOPS  492
c                                                                               LOOPS  493
c              zero hourly loop data                                            LOOPS  494
      CALL FILLN(0., LOOPDAT(1), IVTLIM(2,14))                                  LOOPS  495
c              skip most of this if the loop is not operating                   LOOPS  496
  242 IF (<lp;RUNNING> .NE. 0)  THEN                                            Bug40  168
        LoopCtrl = <lp;CTRL_MODE>                                               -035   117
      ELSE                                                                      -035   118
        LoopCtrl = OFFMODE                                                      LOOPS  498
        <lp;CTRL_MODE> = OFFMODE                                                LOOPS  499
        IF (LoopType .EQ. WLHP)  WLHPoff = .TRUE.                               LOOPS  500
        Tsupply   = <lp;SUPPLY_AVG>                                             LOOPS  501
        Treturn   = <lp;RETURN_AVG>                                             LOOPS  502
        TcoilEnt  = <lp;SUPPLY_AVG>                                             LOOPS  503
        TcoilExit = <lp;RETURN_AVG>                                             LOOPS  504
        TavgS     = <lp;SUPPLY_AVG> + <lp;SUPPLY_DT>                            LOOPS  505
        TavgR     = <lp;RETURN_AVG> + <lp;RETURN_DT>                            LOOPS  506
        <lp;SUPPLY_AVG'> = TavgS                                                LOOPS  507
        <lp;RETURN_AVG'> = TavgR                                                LOOPS  508
        IF (<lp;SupplyLossPtr> .GT. 0)  THEN                                    LOOPS  509
          QlossS  = <lp;SUPPLY_LOSS>                                            LOOPS  510
          QlossR  = <lp;RETURN_LOSS>                                            LOOPS  511
c              Save values in thermal loss blocks for use next hour.            LOOPS  512
c              Note that the load in a transition hour has been switched.       LOOPS  513
c                                           load   flow  Tavg                   LOOPS  514
          CALL PutVars3(<lp;SupplyLossPtr>, QlossS, 0., TavgS)                  LOOPS  515
          CALL PutVars3(<lp;ReturnLossPtr>, QlossR, 0., TavgR)                  LOOPS  516
        ENDIF                                                                   LOOPS  517
        GOTO 250                                                                LOOPS  518
      ENDIF                                                                     LOOPS  519
c              get the coil flows on this loop                                  LOOPS  520
c              initialize sub-hour cycling                                      GLHX1  693
      IF (<lp:OPERATION> .EQ. SubhourDemand)  THEN                              GLHX1  694
        <lp;RUN_FRACTION> = 0.                                                  GLHX1  695
      ELSE                                                                      GLHX1  696
        <lp;RUN_FRACTION> = 1.                                                  GLHX1  697
      ENDIF                                                                     GLHX1  698
      IF (<lp;RUNNING> .GT. 0  .AND.  <lp;COIL_FLAG> .GT. 0)                    LOOPS  521
     &                                                 CALL LoopCoilFlow        LOOPS  522
c                                                                               LOOPS  523
c              Loop flow - non coil                                             GLHX1  699
      GPM = <lp;PROCESS_GPM>  + <lp;2ND_GPM> + <lp;PRIM_GPM>                    GLHX1  700
     &    + <lp;TES_CHRG_GPM> + <lp;CogenGPM>                                   GLHX1  701
c              Supply flow including coils                                      -044c4 383
      GPMs = GPM + <lp;3WayGPM> + <lp;2WayGPM>                                  -044c4 384
c              loop must run whole hour if non-coil load                        -044c4 385
      IF (GPM .gt. 0.)  <lp;RUN_FRACTION> = 1.                                  -044c4 386
c              recirculation flow                                               -044c4 387
      IF (LoopType .ne. DHW)  THEN                                              -044c4 388
        GPMs = GPMs + <lp:RECIRC-GPM> * <lp;RUN_FRACTION>                       -044c4 389
        GPMs = MAX(GPMs, <lp:MIN-GPM> * <lp;RUN_FRACTION>)                      -044c4 390
      ELSE                                                                      -044c4 391
c              DHW recirc pump runs if coil flow                                -044c4 392
        IF (<lp;3WayGPM>+<lp;2WayGPM> .gt. 0.)  <lp;RunDHWPump> = 1.            -044c4 393
        GPMs = GPMs + <lp:RECIRC-GPM> * <lp;RunDHWPump>                         -044c4 394
        GPMs = MAX(GPMs, <lp:MIN-GPM> * <lp;RunDHWPump>)                        -044c4 395
      ENDIF                                                                     -044c4 396
c              Adjust for excess thermal storage demand                         -042     5
      IF (<lp;TES_CHRG_GPM> .gt. 0.)  THEN                                      -042     6
        IF (GPMs .le. <lp;DES_GPM>*<lp;RUN_FRACTION>)  THEN                     -042     7
          <lp;CHRG_CAP_RATI> = 1.0                                              -042     8
        ELSE                                                                    -042     9
          GPMover = GPMs - <lp;DES_GPM>*<lp;RUN_FRACTION>                       -042    10
          GPMover = Min(GPMover, <lp;TES_CHRG_GPM>)                             -042    11
          GPMs    = GPMs - GPMover                                              -042    12
          GPM     = GPM  - GPMover                                              -042    13
          <lp;CHRG_CAP_RATI> = 1.0 - GPMover/<lp;TES_CHRG_GPM>                  -042    14
          <lp;TES_CHRG_HEAT> = <lp;TES_CHRG_HEAT> * <lp;CHRG_CAP_RATI>          -042    15
          <lp;TES_CHRG_COOL> = <lp;TES_CHRG_COOL> * <lp;CHRG_CAP_RATI>          -042    16
          <lp;TES_CHRG_GPM>  = <lp;TES_CHRG_GPM>  - GPMover                     -042    17
          IF (<lp;CHRG_CAP_RATI> .lt. 0.5  .and.  InitialFlg .eq. 0             -047e   15
     &                          .and.  <lp;TESflowFlag> .eq. 0)  THEN           -042    19
            <lp;TESflowFlag> = 1                                                -042    20
            IF (Abs(1.-<lp;3WayGPM>/GPMs) .lt. 0.001) THEN                      -047e   16
c              Tank can't ever charge                                           -047e   17
              CALL MSGSIM(-1,II,II,II,II)                                       -047e   18
              WRITE (IOUTPT, 9102)  (<lp:NAME>,II=1,8)                          -047e   19
            ELSE                                                                -047e   20
              CALL MSGSIM(-2,II,II,II,II)                                       -047e   21
              WRITE (IOUTPT, 9101)  (<lp:NAME>,II=1,8), IMO,IDAY,IHR            -047e   22
            ENDIF                                                               -047e   23
          ENDIF                                                                 -042    23
        ENDIF                                                                   -042    24
      ENDIF                                                                     -042    25
c              do not let loop exceed design flow                               -042    26
      GPMs = MIN(GPMs, <lp;DES_GPM> * <lp;RUN_FRACTION>)                        -042    27
      IF (GPMs .EQ. 0.)  THEN                                                   Bug40  176
c              zero flow - loop not running                                     Bug40  177
        <lp;RUNNING> = 0                                                        Bug40  178
        GOTO 242                                                                Bug40  179
      ENDIF                                                                     Bug40  180
c                                                                               LOOPS  532
c              Loop flow - return side                                          LOOPS  533
      IF (LoopType .EQ. DHW)  THEN                                              LOOPS  534
c              For dhw loops, deduct the flows that do not return (go down      LOOPS  535
c              the drain instead).  The remaining flow is either the            LOOPS  536
c              recirculation flow (most commonly), but may also be a coil       LOOPS  537
c              flow when the coil HEAT-SOURCE is DHW-LOOP                       LOOPS  538
        GPMr1 = GPMs - <lp;PROCESS_GPM> - <lp;2ND_GPM>                          -41a    31
        GPMr  = GPMr1 + <lp;2ND_GPMr>                                           -41a    32
      ELSEIF (LoopType .EQ. STM)  THEN                                          LOOPS  541
c              steam has condensate (liquid) flow on the return side            LOOPS  542
c  ??          calculate condensate flow and Treturn here                       LOOPS  543
      ELSE                                                                      LOOPS  544
c              all other loops have same return flow as supply                  LOOPS  545
        GPMr = GPMs                                                             LOOPS  546
      ENDIF                                                                     LOOPS  547
c              pump flow - calculate for fraction of hour loop                  GLHX1  711
c              active (WLHP and CW loops only)                                  GLHX1  712
      IF (<lp:OPERATION> .EQ. SubhourDemand)  THEN                              GLHX1  713
        <lp;PumpGPM> = GPM + <lp;3WayGPM>                                       GLHX1  714
     &                     + <lp;2WayGPM>/<lp;RUN_FRACTION>                     GLHX1  715
        <lp;PumpGPM> = <lp;PumpGPM> + <lp:RECIRC-GPM>                           GLHX1  716
        <lp;PumpGPM> = MAX(<lp;PumpGPM>, <lp:MIN-GPM>)                          GLHX1  717
        <lp;PumpGPM> = MIN(<lp;PumpGPM>, <lp;DES_GPM>)                          GLHX1  718
      ELSE                                                                      GLHX1  719
        <lp;PumpGPM> = GPMr                                                     GLHX1  720
      ENDIF                                                                     GLHX1  721
c                                                                               LOOPS  548
c              Loop head and pumping - calculate exactly for secondary,         LOOPS  549
c              but use last hours value for primary (primary equipment          LOOPS  550
c              has not yet been selected, so equipment heads are not yet        LOOPS  551
c              known).  Primary will be calcd exactly in PrimaryEquip once      LOOPS  552
c              flow is allocated to primary equipment.                          LOOPS  553
      IF (SubType .EQ. SECONDARY)  THEN                                         LOOPS  554
c              secondary loop calcs                                             LOOPS  555
c              pipe flow ratio                                                  LOOPS  556
        PLRpipe  = MIN(1.,MAX(0.,GPMr/(<lp;DES_GPM>*<lp;RUN_FRACTION>)))        GLHX1  722
c              friction head created by flow                                    LOOPS  558
        PipeHead = <lp:PIPE-HEAD>*PLRpipe**1.8                                  LOOPS  559
c              net loop friction                                                LOOPS  560
c                      worst demand      piping                                 LOOPS  561
        Friction = <lp;DEM-SIDE_HEAD> + PipeHead                                LOOPS  562
c              simulate pump                                                    LOOPS  563
        IF (<lp:PUMP> .GT. 0)  THEN                                             LOOPS  564
          Jpm = <lp:PUMP>                                                       LOOPS  565
c              Calculate head required of pump to meet the setpoint             LOOPS  566
          IF (<lp:HD-SETPT-CTRL> .NE. FIXED)  THEN                              LOOPS  567
c              No fixed setpoint - set hourly to match the reqt. of the         LOOPS  568
c              worst case coil or secondary loop.  This scheme assumes          LOOPS  569
c              proportional + integral control so there is no throttling        LOOPS  570
c              range                                                            LOOPS  571
c                      worst demand                                             LOOPS  572
            HDset = <lp;DEM-SIDE_HEAD> + <lp;DEM-SIDE_STAT>                     LOOPS  573
c                      piping                                                   LOOPS  574
     &            + PipeHead           + <lp:STATIC-HEAD>                       LOOPS  575
          ELSE                                                                  LOOPS  576
c              The pump is controlled to a fixed setpoint.  The setpoint        LOOPS  577
c              was calculated in the design routine, and is based on the        LOOPS  578
c              design heads of all components downstream of the sensor.         LOOPS  579
c              First, calculate the throttling range of the controller          LOOPS  580
            THR = <lp:HD-SETPT-RNG> * (0.5-PLRpipe)                             LOOPS  581
c              Calculate the head based on the location of the sensor           LOOPS  582
            IF (<lp:HD-SENS-LOCN> .EQ. AtCoils)  THEN                           LOOPS  583
c              The differential pressure sensor is located toward the           LOOPS  584
c              coil end of the loop.                                            LOOPS  585
              HDset = <pm:HEAD-SETPT> + THR                                     LOOPS  586
c                        piping                                                 LOOPS  587
     &              + PipeHead        + <lp:STATIC-HEAD>                        LOOPS  588
            ELSE                                                                LOOPS  589
c              sensor is located at beginning of loop                           LOOPS  590
              HDset = <pm:HEAD-SETPT> + THR                                     LOOPS  591
            ENDIF                                                               LOOPS  592
          ENDIF                                                                 LOOPS  593
c              simulate pump                                                    LOOPS  594
          PMPgpm    = <lp;PumpGPM>                                              GLHX1  723
          PMPset    = HDset                                                     LOOPS  596
          PMPfric   = Friction                                                  LOOPS  597
          PMPstatic = <lp;DEM-SIDE_STAT> + <lp:STATIC-HEAD>                     LOOPS  598
          HDpump    = Friction + <lp;DEM-SIDE_STAT> + <lp:STATIC-HEAD>          LOOPS  599
          PMPfrac   = <lp;RUN_FRACTION>                                         GLHX1  724
          CALL PUMP                                                             LOOPS  601
c              transfer pump quantities to loop common block                    LOOPS  602
          Qpump  = PMPQ                                                         LOOPS  603
          dTpump = PMPdT                                                        LOOPS  604
c              adjust loop flows if pump(s) could not meet                      LOOPS  605
c              flow/head requirements                                           LOOPS  606
          IF (PMPgpm .LT. <lp;PumpGPM>)  THEN                                   GLHX1  725
            dGPM = (PMPgpm-<lp;PumpGPM>) * <lp;RUN_FRACTION>                    GLHX1  726
            GPMr = GPMr + dGPM                                                  GLHX1  727
            GPMs = GPMs + dGPM                                                  GLHX1  728
          ENDIF                                                                 GLHX1  729
        ELSE                                                                    LOOPS  612
c              no pump heat                                                     LOOPS  613
          Qpump  = 0.                                                           LOOPS  614
          dTpump = 0.                                                           LOOPS  615
        ENDIF                                                                   LOOPS  616
      ELSE                                                                      LOOPS  617
c              primary loop - use last hours value for pump heat                LOOPS  618
c              for now, will be revised in PrimaryEquip                         LOOPS  619
        IF (LoopType .NE. DHW  .OR.  <lp;RunDHWPump> .EQ. 1.)  THEN             -041j   20
          Qpump  = <lp;PUMP_Q_PAST>                                             -041j   21
          dTpump = <lp;PUMP_DT_PAST>                                            -041j   22
        ELSE                                                                    -041j   23
          Qpump  = 0.                                                           -041j   24
          dTpump = 0.                                                           -041j   25
        ENDIF                                                                   -041j   26
      ENDIF                                                                     LOOPS  622
c                                                                               LOOPS  623
c              loop supply and return conduction losses - calc'd in TEMDEV      LOOPS  624
c              for zone piping, PLANTi for outdoor or tunnel piping             LOOPS  625
c              For DHW, switch return loss values with those of the last        -41a    33
c              transition  if return flow is now non-zero                       -41a    34
      IF (LoopSimCount .EQ. 1  .AND.  LoopType .EQ. DHW  .AND.                  -41a    35
     &    (GPMr .GT. 0.  .AND.  <lp;GPMr_PAST> .EQ. 0.)  .OR.                   -41a    36
     &    (GPMr .EQ. 0.  .AND.  <lp;GPMr_PAST> .GT. 0.))                        -41a    37
     &  Call SwitchReturn                                                       -048   127
      QlossS = <lp;SUPPLY_LOSS>                                                 LOOPS  626
      dTsc   = <lp;SUPPLY_DT>                                                   LOOPS  627
      QlossR = <lp;RETURN_LOSS>                                                 LOOPS  628
      dTrc   = <lp;RETURN_DT>                                                   LOOPS  629
c                                                                               LOOPS  630
c              past hour's average temperature                                  LOOPS  631
      IF (GPMr .GT. 0.)  THEN                                                   -41a    39
        TavgPast = (<lp;SUPPLY_AVG>+<lp;RETURN_AVG>) * 0.5                      -41a    40
      ELSE                                                                      -41a    41
        TavgPast = <lp;SUPPLY_AVG>                                              -41a    42
      ENDIF                                                                     -41a    43
c                    heating/cooling coils and process load                     LOOPS  633
      Qloop    =  <lp;COIL_HEAT> + <lp;COIL_COOL>                               LOOPS  634
     &                         + <lp;PROCESS_Q>                                 LOOPS  635
c                    primary equipment - heating                                LOOPS  638
     &         + <lp;PRIM_HEAT> + <lp;TES_CHRG_HEAT>                            ChlrHP 767
c                    auxiliary heating for tower sumps, TES freeze              LOOPS  640
     &         + <lp;AUX_HEAT>                                                  LOOPS  641
c                    primary equipment - cooling/condenser                      LOOPS  642
     &         + <lp;TES_CHRG_COOL> + <lp;PRIM_HTREJ> + <lp;CogenQ>             LOOPS  643
c                    secondary loops                                            -41a    44
      Qloop2   = <lp;2ND_HEAT>   + <lp;2ND_COOL>                                -41a    45
c              net loop load, including any accumulated overload                LOOPS  644
c              from previous hours (nonzero only for primaries)                 LOOPS  645
      QloopNet = Qloop+Qloop2 + Qpump + QlossS+QlossR + <lp;ACCUM_OVRLD>        -41a    46
c                                                                               LOOPS  647
c              determine control mode                                           LOOPS  648
      IF (<lp;HWorCHW> .EQ. 1  .OR.  SubType .EQ. PRIMARY)  THEN                LOOPS  649
c              change to loop average temp if floating                          LOOPS  650
        IF (GPMr .GT. 0.)  THEN                                                 -41a    47
          dTfloat = QloopNet / <lp;BTU/F>                                       -41a    48
        ELSE                                                                    -41a    49
          dTfloat = QloopNet / (<lp;BTU/F>*0.5)                                 -41a    50
        ENDIF                                                                   -41a    51
        IF (ABS(dTfloat) .LT. 0.01)  LoopCtrl = FLOATING                        -033     7
c              temperature at end of hour if floating                           LOOPS  652
        Tfloat  = TavgPast + dTfloat                                            LOOPS  653
c              control mode                                                     LOOPS  654
  244   IF (LoopCtrl .GT. FLOATING  .AND.  QloopNet .LT. -1.                    -041e   11
     &    .AND.  (Tfloat .LT. <lp;HEAT_SETPT>+<lp;SETPT_RNG2>                   ChlrHP 769
     &                        .OR.  <lp;GLHX_Flag> .EQ. 1                       -041e   12
     &                        .OR.  <lp:HT-SETPT-CTRL> .EQ. 0))  THEN           -041e   13
c              loop temperature is in heating throttling range, but only        -041e   14
c              a WLHP can switch modes                                          -041e   15
          IF (LoopType .EQ. WLHP)  THEN                                         -041e   16
            LoopCtrl = HeatMode                                                 -041e   17
          ELSEIF (LoopCtrl .eq. CoolMode)  THEN                                 -041e   18
            LoopCtrl = Floating                                                 -041e   19
            GoTo 244                                                            -041e   20
          ENDIF                                                                 -041e   21
        ELSEIF (LoopCtrl .GT. FLOATING  .AND.  QloopNet .GT. 1.                 ChlrHP 771
     &    .AND.  (Tfloat .GT. <lp;COOL_SETPT>-<lp;SETPT_RNG2>                   ChlrHP 772
     &    .OR.  LoopType .EQ. CW  .OR.  <lp;GLHX_Flag> .EQ. 1                   -041e   22
     &                            .OR.  <lp:CL-SETPT-CTRL> .EQ. 0)) THEN        -041e   23
c              loop temperature is in cooling throttling range, but only        -041e   24
c              a WLHP can switch modes                                          -041e   25
          IF (LoopType .EQ. WLHP)  THEN                                         -041e   26
            LoopCtrl = CoolMode                                                 -041e   27
          ELSEIF (LoopCtrl .eq. HeatMode)  THEN                                 -041e   28
            LoopCtrl = Floating                                                 -041e   29
            GoTo 244                                                            -041e   30
          ENDIF                                                                 -041e   31
        ELSE                                                                    LOOPS  665
c              loop temperature is floating - no heating or cooling             LOOPS  666
          IF (<lp:LOCN> .EQ. 0)  THEN                                           ERV    114
c              No pipe loss - don't let pump heat drive loop temperature        ERV    115
c              unrealistically high                                             ERV    116
            IF (<lp;CTRL_MODE> .EQ. HEATMODE)                                   ERV    117
     &                               Tfloat = MIN(Tfloat, <lp;SUPPLY_T>)        ERV    118
          ELSE                                                                  ERV    119
c              Don't let a bad estimate of the loop losses float the            ERV    120
c              loop temperature past the environmental temperature              ERV    121
            Jxe     = <lp;SupplyLossPtr>                                        ERV    122
            dTloss  = (QlossS + QlossR) / <lp;BTU/F>                            ERV    123
            TnoLoss = Tfloat - dTloss                                           ERV    124
            IF (dTloss .GT. 0.)  THEN                                           ERV    125
              Tfloat = MAX(TnoLoss, MIN(<xe;Tenvir>, Tfloat))                   ERV    126
            ELSE                                                                ERV    127
              Tfloat = MIN(TnoLoss, MAX(<xe;Tenvir>, Tfloat))                   ERV    128
            ENDIF                                                               ERV    129
          ENDIF                                                                 ERV    130
          LoopCtrl  = FLOATING                                                  LOOPS  667
          Qcp       = -QloopNet                                                 SG0701   3
          QloopNet  = 0.                                                        LOOPS  669
          Tsupply   = Tfloat                                                    LOOPS  670
          Treturn   = Tfloat                                                    LOOPS  671
          TavgS     = Tfloat                                                    LOOPS  672
          TavgR     = Tfloat                                                    LOOPS  673
          TcoilEnt  = Tfloat                                                    LOOPS  674
          TcoilExit = Tfloat                                                    LOOPS  675
          IF (SubType .EQ. PRIMARY)  GOTO 249                                   SG0701   4
        ENDIF                                                                   LOOPS  677
      ENDIF                                                                     LOOPS  678
c                                                                               LOOPS  679
c              Calculate loop temperatures.                                     LOOPS  680
c              supply temperature entering loop                                 LOOPS  681
      IF (<lp;FreeCoolChlr> .LT. 0)  THEN                                       FreeCl  56
c              free cooling is active                                           FreeCl  57
        Jch             = -<lp;FreeCoolChlr>                                    FreeCl  58
        Tsupply         = <ch;ECTsetpt>                                         FreeCl  59
        <lp;COOL_SETPT> = <ch;ECTsetpt>                                         FreeCl  60
      ELSE                                                                      FreeCl  61
        Tsupply = <lp;SUPPLY_T>                                                 FreeCl  62
      ENDIF                                                                     FreeCl  63
c              supply temperature entering coils                                LOOPS  683
      TcoilEnt = Tsupply + dTsc                                                 LOOPS  684
c              return temperature (leaving coils at this point)                 LOOPS  685
      IF (LoopType .EQ. DHW)  THEN                                              LOOPS  686
        IF (GPMs .EQ. 0.)  THEN                                                 Chlr1 2890
          LoopCtrl = FLOATING                                                   Chlr1 2891
        ELSE                                                                    Chlr1 2892
          IF (GPMr .GT. 0.)  THEN                                               -41a    52
            Treturn = TcoilEnt                                                  -41a    53
            IF (GPMr1 .GT. 0.)  Treturn = TcoilEnt                              -41a    54
     &        + (Qloop-<lp;PROCESS_Q>) / (<lp;BTUH/GPM-F>*GPMr1)                -41a    55
c              include effect of secondary loops                                -41a    56
            IF (<lp;2ND_GPMr> .GT. 0.)                                          -41a    57
     &        Treturn = (Treturn*GPMr1 + <lp;2ndGPMr*T>) / GPMr                 -41a    58
          ELSE                                                                  -41a    59
c              no flow in return leg                                            -41a    60
            TavgR   = <lp;RETURN_AVG> + dTrc                                    -41a    61
            Treturn = TavgR                                                     -41a    62
            dTrc    = 0.                                                        -41a    63
          ENDIF                                                                 -41a    64
        ENDIF                                                                   Chlr1 2895
      ELSEIF (LoopType .EQ. STM)  THEN                                          LOOPS  689
c ??           steam condensate temperature entering return                     LOOPS  690
      ELSE                                                                      LOOPS  691
        Treturn = TcoilEnt + (Qloop+Qloop2)/(<lp;BTUH/GPM-F>*GPMs)              -41a    65
      ENDIF                                                                     LOOPS  694
      TcoilExit = Treturn                                                       LOOPS  695
c              return temperature at end of loop                                LOOPS  696
      Treturn = Treturn + dTrc                                                  LOOPS  697
c              average supply & return temps                                    LOOPS  698
      TavgS = Tsupply + dTsc*0.5                                                LOOPS  699
      TavgR = Treturn - dTrc*0.5                                                LOOPS  700
c              load caused by loop temperature change from last hour            LOOPS  701
c              to this hour - ignore for GLHX systems                           LOOPS  702
      IF (<lp;GLHX_Flag> .EQ. 0)  THEN                                          -41a    66
        IF (GPMr .GT. 0.)  THEN                                                 -41a    67
          QCp = (TavgPast - (TavgS+TavgR)*0.5) * <lp;BTU/F>                     -41a    68
        ELSE                                                                    -41a    69
          QCp = (<lp;SUPPLY_AVG> - TavgS) * <lp;BTU/F> * 0.5                    -41a    70
        ENDIF                                                                   -41a    71
      ENDIF                                                                     -41a    72
c              the changed temperatures may cause the loop to float             LOOPS  705
c              during very small loads                                          LOOPS  706
      IF ((<lp;HWorCHW> .EQ. 1  .OR.  SubType .EQ. PRIMARY)  .AND.              Bug40  181
     &    ( LoopCtrl .EQ. FLOATING                                .OR.          Bug40  182
     &     (LoopCtrl .EQ. HEATMODE  .AND.  QloopNet+Qcp .GE. 0.)  .OR.          Bug40  183
     &     (LoopCtrl .EQ. COOLMODE  .AND.  QloopNet+Qcp .LE. 0.)))  THEN        Bug40  184
c              loop temperature is floating - no heating or cooling             LOOPS  709
        LoopCtrl  = FLOATING                                                    LOOPS  710
        Qcp       = -QloopNet                                                   SG0701   5
        QloopNet  = 0.                                                          LOOPS  712
        Tsupply   = Tfloat                                                      LOOPS  713
        Treturn   = Tfloat                                                      LOOPS  714
        TavgS     = Tfloat                                                      LOOPS  715
        TavgR     = Tfloat                                                      LOOPS  716
        TcoilEnt  = Tfloat                                                      LOOPS  717
        TcoilExit = Tfloat                                                      LOOPS  718
        IF (SubType .EQ. PRIMARY)  GOTO 249                                     SG0701   6
      ENDIF                                                                     LOOPS  720
c              net loop load including any float                                LOOPS  721
      QloopNet = QloopNet + QCp                                                 LOOPS  722
c                                                                               LOOPS  723
c              transfer flow and head between secondary                         LOOPS  724
c              and primary loop                                                 LOOPS  725
      IF (SubType .EQ. SECONDARY)  THEN                                         LOOPS  726
        IF (<lp:PUMP> .EQ. 0)  THEN                                             LOOPS  727
c              no secondary pump - flow and head demand on primary              LOOPS  728
c              is the flow and head of secondary - note that 2ndary             LOOPS  729
c              head was already included in primary during design               LOOPS  730
          GPM21   = GPMs                                                        LOOPS  731
          GPM21r  = GPMr                                                        LOOPS  732
          HEAD21f = Friction                                                    LOOPS  733
          HEAD21s = <lp;DEM-SIDE_STAT> + <lp:STATIC-HEAD>                       LOOPS  734
        ELSE                                                                    LOOPS  735
c              secondary pump handles flow and head of secondary loop.          LOOPS  736
c              head and flow demand on primary loop depends on                  LOOPS  737
c              the type of metering valve between the two loops                 LOOPS  738
          IF (<lp;HWorCHW> .EQ. 1)  THEN                                        LOOPS  739
            IF (<lp:VALV-TYPE-2ND> .NE. 3)  THEN                                -044c   19
c              two-way primary/secondary valve - flow between loops is          LOOPS  741
c              a function of the secondary load and the temperature             LOOPS  742
c              differential                                                     LOOPS  743
              Jlp2 = Jlp                                                        LOOPS  744
              Jlp  = <lp:PRIMARY>                                               LOOPS  745
c              primary loop temperature at the secondary valve                  LOOPS  746
              Ts1  = <lp;COIL_EWT>                                              LOOPS  747
              Jlp  = Jlp2                                                       LOOPS  748
c              primary flow to secondary                                        LOOPS  749
              IF (ABS(Treturn-Ts1) .GT. 1.E-4)  THEN                            LOOPS  750
                GPM21 = MAX(0.,                                                 LOOPS  751
     &                  MIN(QloopNet/(<lp;BTUH/GPM-F>*(Treturn-Ts1)),           LOOPS  752
     &                        <lp;DES_GPM>))                                    LOOPS  753
              ELSE                                                              LOOPS  754
                IF (QloopNet .EQ. 0.)  THEN                                     SG0701   7
                  GPM21 = 0.                                                    SG0701   8
                ELSE                                                            SG0701   9
                  GPM21 = <lp;DES_GPM>                                          SG0701  10
                ENDIF                                                           SG0701  11
              ENDIF                                                             LOOPS  756
c              head through primary/secondary valve                             LOOPS  757
              PLR     = GPM21 / <lp;DES_GPM>                                    LOOPS  758
              HEAD21f = <lp:VALV-HEAD-2ND> * PLR**1.8                           LOOPS  759
            ELSE                                                                LOOPS  760
c              three-way primary/secondary valve - head and flow are the        LOOPS  761
c              design heads                                                     LOOPS  762
              GPM21   = <lp;DES_GPM>                                            LOOPS  763
              HEAD21f = <lp:VALV-HEAD-2ND>                                      LOOPS  764
            ENDIF                                                               LOOPS  765
c              return is the same as supply                                     LOOPS  766
            GPM21r = GPM21                                                      LOOPS  767
          ELSE                                                                  LOOPS  768
c              secondary loops with pumps, but without temperature control      LOOPS  769
c              valves, pass flow directly onto loop                             LOOPS  770
            GPM21   = GPMs                                                      LOOPS  771
            GPM21r  = GPMr                                                      LOOPS  772
            Head21f = 0.                                                        LOOPS  773
          ENDIF                                                                 LOOPS  774
c              secondary pump absorbs all static head in secondary loop         LOOPS  775
          HEAD21s = 0.                                                          LOOPS  776
        ENDIF                                                                   LOOPS  777
c              transfer secondary loop requirements onto primary                LOOPS  784
c              get pointer to primary loop                                      LOOPS  785
        Jlp2  = Jlp                                                             LOOPS  786
        Jlp   = Jlp1                                                            LOOPS  787
c              transfer secondary loads to primary                              SG0701  12
        IF (QloopNet .LT. 0.)  THEN                                             SG0701  13
          <lp;2ND_HEAT> = <lp;2ND_HEAT> + QloopNet                              SG0701  14
        ELSE                                                                    SG0701  15
          <lp;2ND_COOL> = <lp;2ND_COOL> + QloopNet                              SG0701  16
        ENDIF                                                                   SG0701  17
        <lp;2ND_GPM>       = <lp;2ND_GPM>  + GPM21                              LOOPS  793
        <lp;2ND_GPMr>      = <lp;2ND_GPMr> + GPM21r                             LOOPS  794
        <lp;2ndGPMr*T>     = <lp;2ndGPMr*T> + GPM21r*Treturn                    -41a    73
        <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>, HEAD21f)                   LOOPS  795
        <lp;DEM-SIDE_STAT> = MAX(<lp;DEM-SIDE_STAT>, HEAD21s)                   LOOPS  796
        Jlp  = Jlp2                                                             LOOPS  797
c              end of primary/secondary transfer calcs                          LOOPS  798
      ELSE                                                                      LOOPS  799
c              primary loop - include pump heat in primary                      LOOPS  800
c              return temperature (estimate from last hour)                     LOOPS  801
        Treturn = Treturn + <lp;PUMP_DT_PAST>                                   LOOPS  802
      ENDIF                                                                     LOOPS  803
c                                                                               LOOPS  804
c ****         run function : LoopSim-2                                         LOOPS  805
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        LOOPS  806
c                                                                               LOOPS  807
c              save the loop values                                             LOOPS  808
  249 <lp;Q_NET>       = QloopNet                                               LOOPS  809
      <lp;Q_ENDUSES>   = Qloop + Qloop2                                         -41a    74
      <lp;GPM>         = GPMs                                                   LOOPS  811
      <lp;HTREC_GPM>   = GPMs                                                   LOOPS  812
      <lp;GPMr>        = GPMr                                                   LOOPS  813
      <lp;CTRL_MODE>   = LoopCtrl                                               LOOPS  814
      <lp;PUMP_Q>      = Qpump                                                  LOOPS  815
      <lp;PUMP_DT>     = dTpump                                                 LOOPS  816
      <lp;SUPPLY_T>    = Tsupply                                                LOOPS  817
      <lp;SUPPLY_AVG'> = TavgS                                                  LOOPS  818
      <lp;COIL_EWT>    = TcoilEnt                                               LOOPS  819
      <lp;COIL_LWT>    = TcoilExit                                              LOOPS  820
      <lp;RETURN_AVG'> = TavgR                                                  LOOPS  821
      <lp;RETURN_T>   = Treturn                                                 LOOPS  825
      IF (<lp;SupplyLossPtr> .GT. 0)  THEN                                      LOOPS  826
c              Save values in thermal loss blocks for use next hour.            LOOPS  827
c              Note that the load in a transition hour has been switched.       LOOPS  828
c                                        load  flow  Tenter                     LOOPS  829
        CALL PutVars3(<lp;SupplyLossPtr>,QlossS,GPMs,Tsupply)                   LOOPS  830
        IF (GPMr .GT. 0)  THEN                                                  -41a    75
          CALL PutVars3(<lp;ReturnLossPtr>,QlossR,GPMr,TcoilExit)               -41a    76
        ELSE                                                                    -41a    77
          CALL PutVars3(<lp;ReturnLossPtr>,QlossR,  0.,    TavgR)               -41a    78
        ENDIF                                                                   -41a    79
      ENDIF                                                                     LOOPS  832
c                                                                               LOOPS  833
c              Hourly-report variables.  Note that, for primary                 LOOPS  834
c              loops, the report buffer will be updated once                    LOOPS  835
c              pumps.                                                           LOOPS  836
  250 IF (<lp;HREP> .NE. 0 .AND. IRSCH .NE. 0)  THEN                            LOOPS  837
c              average supply temperatures were calc-d in TEMDEV                LOOPS  838
c              if the loop was not running this hour                            LOOPS  839
        RunLoop  = FLOAT(<lp;RUNNING>)                                          LOOPS  840
        ModeCtrl = ModeText(<lp;CTRL_MODE>+2)                                   LOOPS  841
        IF (<lp;CTRL_MODE> .EQ. HEATMODE)  THEN                                 LOOPS  842
          Tset   = <lp;HEAT_SETPT>                                              LOOPS  843
        ELSEIF (<lp;CTRL_MODE> .EQ. COOLMODE)  THEN                             LOOPS  844
          Tset   = <lp;COOL_SETPT>                                              LOOPS  845
        ELSE                                                                    LOOPS  846
          Tset   = -999.                                                        LOOPS  847
        ENDIF                                                                   LOOPS  848
        QcoilH   = <lp;COIL_HEAT>                                               LOOPS  849
        QcoilC   = <lp;COIL_COOL>                                               LOOPS  850
        Q2nd     = <lp;2ND_HEAT>      + <lp;2ND_COOL>                           LOOPS  851
        Q1st     = <lp;PRIM_HEAT>     + <lp;CogenQ>                             ChlrHP 775
     &           + <lp;TES_CHRG_HEAT> + <lp;AUX_HEAT>                           LOOPS  853
     &           + <lp;TES_CHRG_COOL> + <lp;PRIM_HTREJ>                         LOOPS  854
        Qprocess = <lp;PROCESS_Q>                                               LOOPS  855
        Tinlet   = <lp;INLET_T>                                                 LOOPS  856
        IF (<lp;SupplyLossPtr> .GT. 0)  THEN                                    Bug40  187
          Jxe  = <lp;SupplyLossPtr>                                             Bug40  188
          Tenv = <xe;Tenvir>                                                    Bug40  189
        ENDIF                                                                   Bug40  190
        GPM2     = <lp;2ND_GPM>                                                 LOOPS  857
        TcoilEst = <lp;COIL_EWTest>                                             LOOPS  858
        CALL HourRepPLT(LOOPDAT(1), <lp;HREP>, 14, 0)                           LOOPS  859
      ENDIF                                                                     LOOPS  860
c                                                                               LOOPS  861
c              repeat for next secondary loop, and finally for primary          LOOPS  862
      IF (SubType .EQ. SECONDARY)  GOTO 240                                     LOOPS  863
c                                                                               LOOPS  864
      RETURN                                                                    LOOPS  865
c                                                                               -41a    80
c              Message formats                                                  -048   128
 9101 FORMAT(14X,'In Circulation-Loop: ',8A4, 'the thermal'            /        -048   129
     &14x,'storage charging flow was drastically reduced because other'/        -048   130
     &14x,'coil flows took higher priority. If using 3-way coil valves'/        -048   131
     &14x,'either change to 2-way valves, or manually specify the '    /        -048   132
     &14x,'LOOP-FLOW to be large enough to handle both the 3-way coils'/        -048   133
     &14x,'and the desired charge flow.  Otherwise, tank may fail to'  /        -048   134
     &14x,'charge.  First occurrence: ',I2,'/',I2,'/',I2               )        -048   135
 9102 FORMAT(14X,'In Circulation-Loop: ',8A4, 'the thermal'            /        -048   136
     &14x,'storage can never charge because coils with 3-way valves'   /        -048   137
     &14x,'have higher priority on the available flow. Either change'  /        -048   138
     &14x,'to 2-way valves, or manually specify the LOOP-FLOW to be'   /        -048   139
     &14x,'large enough for both the 3-way coils and the desired'      /        -048   140
     &14x,'charge flow.'                                               )        -048   141
                                                                                -048   142
                                                                                -048   143
      CONTAINS                                                                  -048   144
c ============== SwitchReturn ================================================= -048   145
      Subroutine SwitchReturn                                                   -048   146
c                                                                               -41a    84
c              Switches a flow loss with a decay loss on the return leg         -41a    85
      X                  = <lp;ReturnLossSav>                                   -41a    86
      <lp;ReturnLossSav> = <lp;RETURN_LOSS>                                     -41a    87
      <lp;RETURN_LOSS>   = X                                                    -41a    88
      X                  = <lp;ReturnDTSave>                                    -41a    89
      <lp;ReturnDTSave>  = <lp;RETURN_DT>                                       -41a    90
      <lp;RETURN_DT>     = X                                                    -41a    91
c                                                                               -41a    92
      End Subroutine SwitchReturn                                               -048   147
c                                                                               -41a    94
c                                                                               -41a    95
c ============== SwitchSupply ================================================= -048   148
      Subroutine SwitchSupply                                                   -048   149
c                                                                               -41a    98
c              Switches a flow loss with a decay loss on the supply leg         -41a    99
      X                  = <lp;SupplyLossSav>                                   -41a   100
      <lp;SupplyLossSav> = <lp;SUPPLY_LOSS>                                     -41a   101
      <lp;SUPPLY_LOSS>   = X                                                    -41a   102
      X                  = <lp;SupplyDTSave>                                    -41a   103
      <lp;SupplyDTSave>  = <lp;SUPPLY_DT>                                       -41a   104
      <lp;SUPPLY_DT>     = X                                                    -41a   105
c                                                                               -41a   106
      End Subroutine SwitchSupply                                               -048   150
                                                                                -048   151
      END                                                                       LOOPS  866
      SUBROUTINE PipeDT(Jxe, xTfluid, xGPM, xTenvir, Locn,                      -047k   18
     &                  dTf, Qloss, Tmean)                                      PipeDT   3
c                                                                               PipeDT   4
c              Calculates the temperature rise through a pipe, the              PipeDT   5
c              corresponding thermal loss, and the log mean temperature         PipeDT   6
c              of the fluid in the pipe.                                        PipeDT   7
c                                                                               PipeDT   8
c              Jxe      Pointer to the extraction rate interface block          PipeDT   9
c              Tfluid   Fluid temperature                                       PipeDT  10
c              GPM      Fluid flow                                              PipeDT  11
c              Tenvir   Environment temperature, if set by TEMDEV               PipeDT  12
c              Locn     1  Tfluid is entering pipe (beginning of loop)          PipeDT  13
c                       2  Tfluid is leaving pipe                               PipeDT  14
c                                                                               PipeDT  15
c              dTf      Fluid temperature change thru pipe                      PipeDT  16
c              Qloss    Thermal loss from pipe (represents a zone               PipeDT  17
c                         extraction rate)                                      PipeDT  18
c              Tmean    Log mean temperature of the fluid in the pipe           PipeDT  19
c                                                                               PipeDT  20
c              This algorithm uses the NTU/effectiveness heat-exchanger         PipeDT  21
c              equations, and assumes that the environmental temperature        PipeDT  22
c              along and around the pipe is uniform.  The solution is           PipeDT  23
c              then the same as for a condensing fluid on one side of           PipeDT  24
c              a heat-exchanger.                                                PipeDT  25
c                                                                               PipeDT  26
c              When the flow is zero, this algorithm uses Newton's              PipeDT  27
c              Law of Cooling to exponentially decay the fluid                  PipeDT  28
c              temperature to the environmental temperature.                    PipeDT  29
c                                                                               PipeDT  30
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               PipeDT  35
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
c                                                                               PipeDT  37
      INTEGER ZP1                                                               PipeDT  38
c                                                                               PipeDT  39
c              If no piping losses                                              PipeDT  40
      IF (Jxe .EQ. 0.)  THEN                                                    PipeDT  41
        dTf   = 0.                                                              PipeDT  42
        Qloss = 0.                                                              PipeDT  43
        Tmean = 0.                                                              PipeDT  44
        RETURN                                                                  PipeDT  45
      ENDIF                                                                     PipeDT  46
c                                                                               PipeDT  47
c              Design parameters                                                PipeDT  48
      CALL GetDesignVars5(Jxe, xxx, UA, Capacitance, FlowCap, DecayRate)        PipeDT  49
                                                                                -047k   19
c              Subroutine call may initialize these values to -77777;           -047k   20
c              which is a flag to set the values in this routine                -047k   21
      Tfluid = xTfluid                                                          -047k   22
      GPM    = xGPM                                                             -047k   23
      Tenvir = xTenvir                                                          -047k   24
c              Fluid temperature and flow - these are always last hour's        PipeDT  50
c              values, unless set by estimation routine                         PipeDT  51
      IF (Tfluid .EQ. -77777.)                                                  PipeDT  52
     &  CALL GetPastVars5(Jxe, xxx, GPM, Tfluid, xxx, xxx)                      PipeDT  53
c                                                                               PipeDT  54
c              Temperature of the area containing the pipe.  If called          PipeDT  55
c              by TEMDEV, this variable will already be set.                    PipeDT  56
      IF (Tenvir .EQ. -77777.)  THEN                                            PipeDT  57
        Jlp = JComponentPtr(Jxe)                                                PipeDT  58
        SELECT CASE (<lp:LOCN>)                                                 PipeDT  59
          CASE (1)    ! indoors                                                 PipeDT  60
            ZP1    = <lp:LOSS-ZONE>                                             PipeDT  61
            Tenvir = <TNOW>                                                     PipeDT  62
          CASE (2)    ! outdoors                                                PipeDT  63
            Tenvir = DBT                                                        PipeDT  64
          CASE (3)    ! tunnel                                                  PipeDT  65
            Tenvir = SchVal(<lp:TUNNEL-SCH>, <lp:TUNNEL-T>)                     Time    43
          CASE (4)    ! underground                                             PipeDT  69
c              pipe is underground - the assumption of ground temperature       PipeDT  70
c              is very poor and should be replaced at some time                 PipeDT  71
            Tenvir = GTEMP(IMO) - 460.                                          ERV    131
        END SELECT                                                              PipeDT  73
      ENDIF                                                                     PipeDT  74
c                                                                               PipeDT  75
c ****         run function : PipeDT-1                                          PipeDT  76
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        PipeDT  77
c                                                                               PipeDT  78
c                                                                               PipeDT  79
      IF (GPM .GT. 0.0001)  THEN                                                PipeDT  80
c              Non-zero flow last hour - use NTU/effectiveness equation.        PipeDT  81
c              Ratio of the pipe UA to the pipe heat transport capacity.        PipeDT  82
        RUAGPM = UA / (FlowCap * GPM)                                           PipeDT  83
c              heat-exchanger effectiveness (assumes condensing fluid)          PipeDT  84
        Eff    = 1.0 - EXP(-RUAGPM)                                             PipeDT  85
c                                                                               PipeDT  86
c              fluid temperature rise for temperature entering pipe             PipeDT  87
        dTf = Eff * (Tenvir - Tfluid)                                           PipeDT  88
c              fluid temperature rise for temperature leaving pipe              PipeDT  89
        IF (Locn .EQ. 2)  dTf = dTf / (1.0 - Eff)                               PipeDT  90
c              thermal loss                                                     PipeDT  91
        Qloss = dTf * FlowCap * GPM                                             PipeDT  92
c              log mean temperature of fluid in pipe                            PipeDT  93
        Tmean = Tenvir - Qloss/UA                                               PipeDT  94
      ELSE                                                                      PipeDT  95
c              Zero flow last hour - use Newton's Law of Cooling.  Note         PipeDT  96
c              that Tfluid in this case is the average pipe temperature.        PipeDT  97
c              hourly temperature decay                                         PipeDT  98
        dTf   = DecayRate * (Tenvir - Tfluid)                                   PipeDT  99
c              thermal loss                                                     PipeDT 100
        Qloss = dTf * Capacitance                                               PipeDT 101
c              effective log mean temperature of fluid in pipe                  PipeDT 102
        IF (UA .GT. 0.)  THEN                                                   Chlr1 2898
          Tmean = Tenvir - Qloss/UA                                             Chlr1 2899
        ELSE                                                                    Chlr1 2900
          Tmean = Tfluid                                                        Chlr1 2901
        ENDIF                                                                   Chlr1 2902
      ENDIF                                                                     PipeDT 104
c                                                                               PipeDT 105
c              Store in Xface                                                   PipeDT 106
      CALL PutVars5c(Jxe, Qloss, -77777., -77777., dTf, Tenvir)                 ERV    132
c                                                                               PipeDT 108
c ****         run function : PipeDT-2                                          PipeDT 109
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        PipeDT 110
c                                                                               PipeDT 111
      RETURN                                                                    PipeDT 112
      END                                                                       PipeDT 113
      SUBROUTINE PipeDT_Design(QloopH, QloopC)                                  PipeDTd  2
c                                                                               PipeDTd  3
c              Sets up the thermal loss parameters for a circulation            PipeDTd  4
c              loop, both supply and return.                                    PipeDTd  5
c                                                                               PipeDTd  6
c              QloopH  Net loop heating load, including losses                  PipeDTd  7
c              QloopC  Net loop cooling load, including losses                  PipeDTd  8
c                                                                               PipeDTd  9
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /REPORT/ IREPRT(4,37),IPRG,IUNIQV(100),IUNIQS(100),IUNIQL         /REPORT/ 2
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               PipeDTd 20
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
c                                                                               PipeDTd 22
      INTEGER ZP1, ZP2                                                          PipeDTd 23
c                                                                               PipeDTd 24
c              This algorithm uses the NTU/effectiveness heat-exchanger         PipeDTd 25
c              equations, and assumes that the environmental temperature        PipeDTd 26
c              along and around the pipe is uniform.  The solution is           PipeDTd 27
c              then the same as for a condensing fluid on one side of           PipeDTd 28
c              a heat-exchanger.                                                PipeDTd 29
c                                                                               PipeDTd 30
c              Some loops can do both heating and cooling (2-pipe & wlhp)       PipeDTd 31
c              and piping UA products can be calculated on either the           PipeDTd 32
c              design heating conditions or the design cooling conditions.      PipeDTd 33
c              For this reason, the losses are calculated in the                PipeDTd 34
c              following sequence:                                              PipeDTd 35
c                 1.  Supply-UA based on heating mode parameters                PipeDTd 36
c                 2.  Supply-UA based on cooling mode parameters                PipeDTd 37
c                 3.  Supply-side design heating losses                         PipeDTd 38
c                 4.  Supply-side design cooling losses                         PipeDTd 39
c                 5.  Return-UA based on heating mode parameters                PipeDTd 40
c                 6.  Return-UA based on cooling mode parameters                PipeDTd 41
c                 7.  Return-side design heating losses                         PipeDTd 42
c                 8.  Return-side design cooling losses                         PipeDTd 43
c                                                                               PipeDTd 44
c                                                                               PipeDTd 45
      LoopType = <lp:TYPE>                                                      PipeDTd 46
c              If losses occur indoors, pointer to zone                         PipeDTd 47
      IF (<lp:LOCN> .EQ. INDOORS)  THEN                                         PipeDTd 48
c              zone pointers                                                    PipeDTd 49
        ZP1 = <lp:LOSS-ZONE>                                                    PipeDTd 50
        ZP2 = <ZP2>                                                             PipeDTd 51
      ENDIF                                                                     PipeDTd 52
c                                                                               PipeDTd 53
c              1. Calc UA for loops that can heat                               PipeDTd 54
      IF (LoopType .NE. CHW  .AND.  LoopType .NE. CW)  THEN                     PipeDTd 55
c              design entering fluid temperature                                PipeDTd 56
        TsupplyH = <lp:DESIGN-HEAT-T>                                           Chlr1 2903
c              design environmental temperature of the pipe                     PipeDTd 58
        TenvH = <lp:HTG-ENVIR-T>                                                PipeDTd 59
        IF (TenvH .EQ. 0.)  THEN                                                PipeDTd 60
c              environmental temperature not specified - default to             PipeDTd 61
c              location of pipe                                                 PipeDTd 62
          IF (<lp:LOCN> .EQ. INDOORS)  THEN                                     PipeDTd 63
c              loop is located indoors                                          PipeDTd 64
            TenvH  = <DESIGN-HEAT-T>                                            PipeDTd 65
          ELSEIF (<lp:LOCN> .EQ. OUTDOORS)  THEN                                PipeDTd 66
c              loop is located outdoors                                         PipeDTd 67
            TenvH  = DBTMIN                                                     PipeDTd 68
          ELSEIF (<lp:LOCN> .EQ. TUNNEL)  THEN                                  PipeDTd 69
c                loop is in a tunnel                                            PipeDTd 70
            TenvH = <lp:TUNNEL-T>                                               PipeDTd 71
          ELSE                                                                  PipeDTd 72
c              loop is buried - make the extreme of the yearly                  PipeDTd 73
c              ground temperature                                               PipeDTd 74
            TenvH = 999.                                                        ERV    133
            DO  II=1,12                                                         PipeDTd 75
              TenvH = MIN(TenvH, GTEMP(II))                                     PipeDTd 76
            ENDDO                                                               PipeDTd 77
            TenvH = TenvH - 460.                                                ERV    134
          ENDIF                                                                 PipeDTd 78
c              end of default environmental temp calcs                          PipeDTd 79
        ENDIF                                                                   PipeDTd 80
c              Supply-side calcs                                                PipeDTd 81
c              calc UA if user specified dT instead of UA directly              PipeDTd 82
        IF (<lp:SUPPLY-UA> .EQ. 0.)  THEN                                       PipeDTd 83
c              2-pipe and wlhp loops may calc UA based on either                PipeDTd 84
c              the heating or cooling mode                                      PipeDTd 85
          IF ((LoopType .EQ. PIPE2  .OR.  LoopType .EQ. WLHP)  .AND.            PipeDTd 86
     &                       <lp:LOSS-BASED-ON> .EQ. COOLMODE)  GOTO 220        PipeDTd 87
c              Check to see if temperature differentials even remotely          PipeDTd 88
c              reasonable.                                                      PipeDTd 89
          dTratio = ABS(<lp:SLOSS-DT> / (TenvH-TsupplyH))                       ERV    135
          IF (1.0/dTratio .LT. 0.5)  THEN                                       PipeDTd 91
            CALL MSGSIM(-1,II,II,II,II)                                         PipeDTd 92
            WRITE (IOUTPT,9101) (<lp:NAME>,II=1,8)                              PipeDTd 93
            call MessageBox( NULL, 'DeltaT for loss is unreasonable -'          PipeDTd 94
     &        //' ABORTING'//char(0),'LOOPd Errors'//char(0), MB_OK             PipeDTd 95
     &        + MB_ICONSTOP + MB_TASKMODAL )                                    PipeDTd 96
            RETURN                                                              PipeDTd 98
          ENDIF                                                                 PipeDTd 99
          <lp:SUPPLY-UA> = -<lp;BTUH/GPM-F>*GPMs * ALOG(1.0-dTratio)            PipeDTd100
        ENDIF                                                                   PipeDTd101
c              end of supply-side heating UA calcs                              PipeDTd102
      ENDIF                                                                     PipeDTd103
c                                                                               PipeDTd104
c              2. Calc UA for loops that can cool                               PipeDTd105
  220 IF (LoopType .EQ. CHW    .OR.  LoopType .EQ. CW  .OR.                     PipeDTd106
     &    LoopType .EQ. PIPE2  .OR.  LoopType .EQ. WLHP)  THEN                  PipeDTd107
c              design entering fluid temperature                                PipeDTd108
        TsupplyC = <lp:DESIGN-COOL-T>                                           Chlr1 2904
c              design environmental temperature of the pipe                     PipeDTd110
        TenvC = <lp:CLG-ENVIR-T>                                                PipeDTd111
        IF (TenvC .EQ. 0.)  THEN                                                PipeDTd112
c              environmental temperature not specified - default to             PipeDTd113
c              location of pipe                                                 PipeDTd114
          IF (<lp:LOCN> .EQ. INDOORS)  THEN                                     PipeDTd115
c              loop is located indoors                                          PipeDTd116
            TenvC = <DESIGN-COOL-T>                                             PipeDTd117
          ELSEIF (<lp:LOCN> .EQ. OUTDOORS)  THEN                                PipeDTd118
c              loop is located outdoors                                         PipeDTd119
            TenvC = DBTMAX                                                      PipeDTd120
          ELSEIF (<lp:LOCN> .EQ. TUNNEL)  THEN                                  PipeDTd121
c                loop is in a tunnel                                            PipeDTd122
            TenvC = <lp:TUNNEL-T>                                               PipeDTd123
          ELSE                                                                  PipeDTd124
c              loop is buried - make the extreme of the yearly                  PipeDTd125
c              ground temperature                                               PipeDTd126
            DO  II=1,12                                                         PipeDTd127
              TenvC = MAX(TenvC, GTEMP(II))                                     PipeDTd128
            ENDDO                                                               PipeDTd129
            TenvC = TenvC - 460.                                                ERV    136
          ENDIF                                                                 PipeDTd130
c              end of default environmental temp calcs                          PipeDTd131
        ENDIF                                                                   PipeDTd132
c              Supply-side calcs                                                PipeDTd133
c              calc UA if user specified dT instead of UA directly              PipeDTd134
        IF (<lp:SUPPLY-UA> .EQ. 0.)  THEN                                       PipeDTd135
c              Check to see if temperature differentials even remotely          PipeDTd136
c              reasonable.                                                      PipeDTd137
          dTratio = ABS(<lp:SLOSS-DT> / (TenvC-TsupplyC))                       ERV    137
          IF (1.0/dTratio .LT. 0.5)  THEN                                       PipeDTd139
            CALL MSGSIM(-1,II,II,II,II)                                         PipeDTd140
            WRITE (IOUTPT,9101) (<lp:NAME>,II=1,8)                              PipeDTd141
            call MessageBox( NULL, 'DeltaT for loss is unreasonable -'          PipeDTd142
     &        //' ABORTING'//char(0),'LOOPd Errors'//char(0), MB_OK             PipeDTd143
     &        + MB_ICONSTOP + MB_TASKMODAL )                                    PipeDTd144
            RETURN                                                              PipeDTd146
          ENDIF                                                                 PipeDTd147
          <lp:SUPPLY-UA> = -<lp;BTUH/GPM-F>*GPMs * ALOG(1.0-dTratio)            PipeDTd148
c              end of supply-side cooling UA calcs                              PipeDTd149
        ENDIF                                                                   PipeDTd150
      ENDIF                                                                     PipeDTd151
c                                                                               PipeDTd152
c              3.  Supply-side design heating losses                            PipeDTd153
      IF (LoopType .NE. CHW  .AND.  LoopType .NE. CW)  THEN                     PipeDTd154
c              loop temperature rise corresponding to UA when the               PipeDTd155
c              entering pipe temperature is specified                           PipeDTd156
        dTpipeHs = (1.0-EXP(-<lp:SUPPLY-UA>/(<lp;BTUH/GPM-F>*GPMs)))            PipeDTd157
     &                                              * (TenvH - TsupplyH)        PipeDTd158
c              design thermal loss - supply side                                PipeDTd159
        QlossHs = <lp;BTUH/GPM-F> * GPMs * dTpipeHs                             PipeDTd160
        IF (<lp:SIZE-OPTION> .EQ. SECONDARY)  QloopH = QloopH+QlossHs           PipeDTd161
c              decay rate when no flow                                          PipeDTd162
        DecayRate = 1.0 - EXP(-<lp:SUPPLY-UA> / (<lp;BTU/F>*0.5))               PipeDTd163
c              Store loss design variables in interface block                   PipeDTd164
        CALL PutDesignVars5(<lp;SupplyLossPtr>, QlossHs, <lp:SUPPLY-UA>,        PipeDTd165
     &                      <lp;BTU/F>*0.5, <lp;BTUH/GPM-F>, DecayRate)         PipeDTd166
c              Initialize the fluid temperature                                 PipeDTd167
        CALL PutPastVars(<lp;SupplyLossPtr>, 0., 0., 70., 0., 0.)               PipeDTd168
      ENDIF                                                                     PipeDTd169
c                                                                               PipeDTd170
c              4.  Supply-side design cooling losses                            PipeDTd171
      IF (LoopType .EQ. CHW    .OR.  LoopType .EQ. CW  .OR.                     PipeDTd172
     &    LoopType .EQ. PIPE2  .OR.  LoopType .EQ. WLHP)  THEN                  PipeDTd173
c              loop temperature rise corresponding to UA when the               PipeDTd174
c              entering pipe temperature is specified                           PipeDTd175
        dTpipeCs = (1.0-EXP(-<lp:SUPPLY-UA>/(<lp;BTUH/GPM-F>*GPMs)))            PipeDTd176
     &                                              * (TenvC - TsupplyC)        PipeDTd177
c              design thermal loss - supply side                                PipeDTd178
        QlossCs = <lp;BTUH/GPM-F> * GPMs * dTpipeCs                             PipeDTd179
        IF (<lp:SIZE-OPTION> .EQ. SECONDARY)  QloopC = QloopC+QlossCs           PipeDTd180
c              decay rate when no flow                                          PipeDTd181
        DecayRate = 1.0 - EXP(-<lp:SUPPLY-UA> / (<lp;BTU/F>*0.5))               PipeDTd182
c              Store loss design variables in interface block                   PipeDTd183
        CALL PutDesignVars5(<lp;SupplyLossPtr>, QlossCs, <lp:SUPPLY-UA>,        PipeDTd184
     &                      <lp;BTU/F>*0.5, <lp;BTUH/GPM-F>, DecayRate)         PipeDTd185
c              Initialize the fluid temperature                                 PipeDTd186
        CALL PutPastVars(<lp;SupplyLossPtr>, 0., 0., 70., 0., 0.)               PipeDTd187
      ENDIF                                                                     PipeDTd188
c                                                                               PipeDTd189
c              5.  Return UA based on heating mode parameters                   PipeDTd190
      IF (LoopType .NE. CHW  .AND.  LoopType .NE. CW)  THEN                     PipeDTd191
c                  temperature entering return piping                           PipeDTd192
        IF (LoopType .NE. DHW)  THEN                                            PipeDTd193
          TreturnH = TsupplyH + QloopH / (<lp;BTUH/GPM-F>*GPMs)                 PipeDTd194
        ELSE                                                                    PipeDTd195
c                  dhw does not see a coil load, only the supply loss           PipeDTd196
          TreturnH = TsupplyH + QlossHs / (<lp;BTUH/GPM-F>*GPMs)                PipeDTd197
        ENDIF                                                                   PipeDTd198
c              2-pipe and wlhp loops may calc UA based on either                PipeDTd199
c              the heating or cooling mode                                      PipeDTd200
        IF ((LoopType .EQ. PIPE2  .OR.  LoopType .EQ. WLHP)  .AND.              PipeDTd201
     &                       <lp:LOSS-BASED-ON> .EQ. COOLMODE)  GOTO 230        PipeDTd202
        IF (<lp:RETURN-UA> .EQ. 0.)  THEN                                       PipeDTd203
          IF (<lp:RLOSS-DT> .NE. 0.)  THEN                                      PipeDTd204
c              Check to see if temperature differentials even remotely          PipeDTd205
c              reasonable.                                                      PipeDTd206
            dTratio = ABS(<lp:RLOSS-DT> / (TenvH-TreturnH))                     ERV    138
            IF (1.0/dTratio .LT. 0.5)  THEN                                     PipeDTd208
              CALL MSGSIM(-1,II,II,II,II)                                       PipeDTd209
              WRITE (IOUTPT,9101) (<lp:NAME>,II=1,8)                            PipeDTd210
              call MessageBox( NULL, 'DeltaT for loss is unreasonable -'        PipeDTd211
     &          //' ABORTING'//char(0),'LOOPd Errors'//char(0), MB_OK           PipeDTd212
     &          + MB_ICONSTOP + MB_TASKMODAL )                                  PipeDTd213
              RETURN                                                            PipeDTd215
            ENDIF                                                               PipeDTd216
            <lp:RETURN-UA> = -<lp;BTUH/GPM-F>*GPMr * ALOG(1.0-dTratio)          PipeDTd217
          ELSE                                                                  PipeDTd218
c              nothing specified for return - default to supply                 PipeDTd219
            <lp:RETURN-UA> = <lp:SUPPLY-UA>                                     PipeDTd220
          ENDIF                                                                 PipeDTd221
        ENDIF                                                                   PipeDTd222
      ENDIF                                                                     PipeDTd223
c                                                                               PipeDTd224
c              6.  Return UA based on cooling mode parameters                   PipeDTd225
c                  temperature entering return loop                             PipeDTd226
  230 IF (LoopType .EQ. CHW    .OR.  LoopType .EQ. CW  .OR.                     PipeDTd227
     &    LoopType .EQ. PIPE2  .OR.  LoopType .EQ. WLHP)  THEN                  PipeDTd228
c                  temperature entering return piping                           PipeDTd229
        TreturnC = TsupplyC + QloopC / (<lp;BTUH/GPM-F>*GPMs)                   PipeDTd230
        IF (<lp:RETURN-UA> .EQ. 0.)  THEN                                       PipeDTd231
          IF (<lp:RLOSS-DT> .NE. 0.)  THEN                                      PipeDTd232
c              Check to see if temperature differentials even remotely          PipeDTd233
c              reasonable.                                                      PipeDTd234
            dTratio = ABS(<lp:RLOSS-DT> / (TenvC-TreturnC))                     ERV    139
            IF (1.0/dTratio .LT. 0.5)  THEN                                     PipeDTd236
              CALL MSGSIM(-1,II,II,II,II)                                       PipeDTd237
              WRITE (IOUTPT,9101) (<lp:NAME>,II=1,8)                            PipeDTd238
              call MessageBox( NULL, 'DeltaT for loss is unreasonable -'        PipeDTd239
     &          //' ABORTING'//char(0),'LOOPd Errors'//char(0), MB_OK           PipeDTd240
     &          + MB_ICONSTOP + MB_TASKMODAL )                                  PipeDTd241
              RETURN                                                            PipeDTd243
            ENDIF                                                               PipeDTd244
            <lp:RETURN-UA> = -<lp;BTUH/GPM-F>*GPMr * ALOG(1.0-dTratio)          PipeDTd245
          ELSE                                                                  PipeDTd246
c              nothing specified for return - default to supply                 PipeDTd247
            <lp:RETURN-UA> = <lp:SUPPLY-UA>                                     PipeDTd248
          ENDIF                                                                 PipeDTd249
        ENDIF                                                                   PipeDTd250
      ENDIF                                                                     PipeDTd251
c                                                                               PipeDTd252
c              7.  Return-side design heating losses                            PipeDTd253
      IF (LoopType .NE. CHW  .AND.  LoopType .NE. CW                            Chlr1 2905
     &                       .AND.  GPMr .GT. 0.)  THEN                         Chlr1 2906
c              loop temperature rise corresponding to UA when the               PipeDTd255
c              entering pipe temperature is specified                           PipeDTd256
        dTpipeHr = (1.0-EXP(-<lp:RETURN-UA>/(<lp;BTUH/GPM-F>*GPMr)))            PipeDTd257
     &                                              * (TenvH - TreturnH)        PipeDTd258
c              design thermal loss - return side                                PipeDTd259
        QlossHr = <lp;BTUH/GPM-F> * GPMr * dTpipeHr                             PipeDTd260
        IF (<lp:SIZE-OPTION> .EQ. SECONDARY)  QloopH = QloopH+QlossHr           PipeDTd261
c              decay rate when no flow                                          PipeDTd262
        DecayRate = 1.0 - EXP(-<lp:RETURN-UA> / (<lp;BTU/F>*0.5))               PipeDTd263
c              Store loss design variables in interface block                   PipeDTd264
        CALL PutDesignVars5(<lp;ReturnLossPtr>, QlossHr, <lp:RETURN-UA>,        PipeDTd265
     &                      <lp;BTU/F>*0.5, <lp;BTUH/GPM-F>, DecayRate)         PipeDTd266
c              Initialize the fluid temperature                                 PipeDTd267
        CALL PutPastVars(<lp;ReturnLossPtr>, 0., 0., 70., 0., 0.)               PipeDTd268
      ENDIF                                                                     PipeDTd269
c                                                                               PipeDTd270
c              8.  Return-side design cooling losses                            PipeDTd271
      IF (LoopType .EQ. CHW    .OR.  LoopType .EQ. CW  .OR.                     PipeDTd272
     &    LoopType .EQ. PIPE2  .OR.  LoopType .EQ. WLHP)  THEN                  PipeDTd273
c              loop temperature rise corresponding to UA when the               PipeDTd274
c              entering pipe temperature is specified                           PipeDTd275
        dTpipeCr = (1.0-EXP(-<lp:RETURN-UA>/(<lp;BTUH/GPM-F>*GPMr)))            PipeDTd276
     &                                              * (TenvC - TreturnC)        PipeDTd277
c              design thermal loss - return side                                PipeDTd278
        QlossCr = <lp;BTUH/GPM-F> * GPMr * dTpipeCr                             PipeDTd279
        IF (<lp:SIZE-OPTION> .EQ. SECONDARY)  QloopC = QloopC+QlossCr           PipeDTd280
c              decay rate when no flow                                          PipeDTd281
        DecayRate = 1.0 - EXP(-<lp:RETURN-UA> / (<lp;BTU/F>*0.5))               PipeDTd282
c              Store loss design variables in interface block                   PipeDTd283
        CALL PutDesignVars5(<lp;ReturnLossPtr>, QlossCr, <lp:RETURN-UA>,        PipeDTd284
     &                      <lp;BTU/F>*0.5, <lp;BTUH/GPM-F>, DecayRate)         PipeDTd285
c              Initialize the fluid temperature                                 PipeDTd286
        CALL PutPastVars(<lp;ReturnLossPtr>, 0., 0., 70., 0., 0.)               PipeDTd287
      ENDIF                                                                     PipeDTd288
c              End of thermal loss calcs                                        PipeDTd289
c                                                                               PipeDTd290
c              dump design variables                                            PipeDTd291
      IF (IREPRT(3,34) .NE. 0)  WRITE(IOUTPT,9000) (<lp:NAME>,II=1,8),          PipeDTd292
     &  TenvC,TenvH,                                                            PipeDTd293
     &  <lp:SUPPLY-UA>, <lp:SLOSS-DT>, TsupplyH, dTpipeHs, QlossHs,             PipeDTd294
     &  TsupplyC, dTpipeCs, QlossCs,                                            PipeDTd295
     &  <lp:RETURN-UA>, <lp:RLOSS-DT>, TreturnH, dTpipeHr, QlossHr,             PipeDTd296
     &  TreturnC, dTpipeCr, QlossCr                                             PipeDTd297
c                                                                               PipeDTd298
      RETURN                                                                    PipeDTd299
c              dump formats                                                     PipeDTd300
 9000 FORMAT(' ',8A4,'Thermal loss calcs' /                                     PipeDTd301
     &      /    17X,'    TenvC     TenvH                              '        PipeDTd302
     &      /    17X,     F10.1,    F10.1                                       PipeDTd303
     &      /    17X,'SUPPLY UA  SLOSS DT  TsupplyH  dTpipeHs   QlossHs'        PipeDTd304
     &      /    17X,     F10.1,    F10.1,    F10.1,    F10.1,    F10.1         PipeDTd305
     &      /    17X,' TsupplyC  dTpipeCs   QlossCs                    '        PipeDTd306
     &      /    17X,     F10.1,    F10.1,    F10.1                             PipeDTd307
     &      /    17X,'RETURN UA  RLOSS DT  TreturnH  dTpipeHr   QlossHr'        PipeDTd308
     &      /    17X,     F10.1,    F10.1,    F10.1,    F10.1,    F10.1         PipeDTd309
     &      /    17X,' TreturnC  dTpipeCr   QlossCr                    '        PipeDTd310
     &      /    17X,     F10.1,    F10.1,    F10.1                    )        PipeDTd311
c                                                                               PipeDTd312
c              message formats                                                  PipeDTd313
 9101   FORMAT(14X,'In Circulation-Loop: ',8A4,'the pipe'              /        PipeDTd314
     &         14X,'thermal losses based on the SUPPLY-LOSS-DT,'       /        PipeDTd315
     &         14X,'HT-SETPT-T, and environmental temperature are'     /        PipeDTd316
     &         14X,'either excessive or impossible.  Check these'      /        PipeDTd317
     &         14X,'values for consistency.'                           )        PipeDTd318
c                                                                               PipeDTd319
      END                                                                       PipeDTd320
      SUBROUTINE PLANTdes                                                       PLANTd   2
c                                                                               PLANTd   3
c              Calculates the design data for the central plant equipment       PLANTd   4
c                                                                               PLANTd   5
c              Called from DESIGN                                               PLANTd   6
c                                                                               PLANTd   7
c              Nloop(LoopType,SubType)                                          PLANTd   8
c                    LoopType    loop type (HW, CHW, etc.)                      PLANTd   9
c                       SubType  1  number of primary loops of this type        PLANTd  10
c                                2  number of secondary loops of this type      PLANTd  11
c                                                                               PLANTd  12
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /DESDAT/ ZCFM,ICFM,ZVENT,C1,IFLAG                                 /DESDAT/ 2
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /LOOP  / Nloop(16,2), NextType(40), NLP2,                         -41a     1
     &                 WLHPoff, RealCall, RegenFlag, Sim2x, LoopSimCount        ChlrHP   2
      LOGICAL          WLHPoff, RealCall, RegenFlag, Sim2x                      ChlrHP   3
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PTRSYS/ nzone , iz    , nczd  , zp2 ,         mtw  ,             -045a    1
     $                 nsys  , is    , nss   , nsp ,  ns   , icode,             HR      11
     $                 nsz   , isz   , nzd   , zp1 ,  nz   ,                    HR      12
     $                 nspace, lpr   ,                                          HR      13
     $                 nattch, iatt  ,                                          HR      14
     $                 P2, IDAYHR, IDBWBT,                                      HR      15
     $                 IRPPLT, IRPSUM, IRPSYS, IRPZON, MR1, MR2                 HR      16
      INTEGER          ZP1, ZP2, P2                                             /PTRSYS/14
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /REPORT/ IREPRT(4,37),IPRG,IUNIQV(100),IUNIQS(100),IUNIQL         /REPORT/ 2
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TWRDAT/ TWRload,TCAP,TWRrej,CWgpm,TWRgpm,TWRsupply,              /TWRDAT/ 2
     &                 TWRset,Ttower,RANGE,APP,twr1FRA,GPMra,GPMcap,            /TWRDAT/ 3
     &                 GPMcell,NumCells,MinCells,MaxCells,Ttop,GPMtop,          /TWRDAT/ 4
     &                 Tbot,GPMbot,CFMra,FankWr,FankW,TWRaux,QpanLoss,          -034     2
     &                 QcoilLoss, SpraykW, Twet1, Tstart                        /TWRDAT/ 6
      DIMENSION        TWRSAV(25)                                               /TWRDAT/ 7
      EQUIVALENCE     (TWRSAV(1),TWRload)                                       /TWRDAT/ 8
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               PLANTd  28
      COMMON  /CHLRKY/ ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 2
     &                 WaterCool, AirCool                                       /CHLRKY/ 3
      INTEGER          ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 4
     &                 WaterCool, AirCool                                       /CHLRKY/ 5
      COMMON  /DHWKY / DHWgas, DHWelec, DHWhtpump                               /DHWKY/  2
      INTEGER          DHWgas, DHWelec, DHWhtpump                               /DHWKY/  3
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
      COMMON  /SimAlg/ Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/ 2
     &                 Electrical,                                              /SIMALG/ 3
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/ 4
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/ 5
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   2
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/ 7
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/ 8
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/ 9
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/10
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    3
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    4
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    5
     &                 Ground_LoopVert_H2,Ground_LoopHoriz_H,                   -044d    6
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/14
      INTEGER          Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/15
     &                 Electrical,                                              /SIMALG/16
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/17
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/18
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   3
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/20
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/21
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/22
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/23
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    7
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    8
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    9
     &                 Ground_LoopVert_H2, Ground_LoopHoriz_H,                  -044d   10
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/27
      COMMON  /TWRKY / Open, OpenHX, FluidCool,                                 /TWRKY/  2
     &                 Bypass, Speed1, Speed2, SpeedV, Damper,                  /TWRKY/  3
     &                 RunMinCells, RunMaxCells,                                /TWRKY/  4
     &                 ElecPanHtr, NoPanHtr, HWPanHtr,                          /TWRKY/  5
     &                 CycleWithFan, StayOn                                     /TWRKY/  6
      INTEGER          Open, OpenHX, FluidCool,                                 /TWRKY/  7
     &                 Bypass, Speed1, Speed2, SpeedV, Damper,                  /TWRKY/  8
     &                 RunMinCells, RunMaxCells,                                /TWRKY/  9
     &                 ElecPanHtr, NoPanHtr, HWPanHtr,                          /TWRKY/ 10
     &                 CycleWithFan, StayOn                                     /TWRKY/ 11
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
c                                                                               PLANTd  36
       INTEGER SubType                                                          Sync    40
c                                                                               PLANTd  43
c              SimCtrl = 1 indicates that algorithms are in design mode         PLANTd  44
      SimCtrl = 1                                                               PLANTd  45
c                                                                               PLANTd  46
c              suppress statistics                                              PLANTd  47
      RealCall = .FALSE.                                                        PLANTd  48
c                                                                               PLANTd  49
c============= BRINE CALCULATIONS ============================================= PLANTd  50
c              determine the specific heat of fluid in each loop                PLANTd  51
      DO  NL=1,Nlp                                                              PLANTd  52
c              pointer to loop                                                  PLANTd  53
        Jlp = Ilp + (NL-1)*Llp                                                  PLANTd  54
        IF (<lp:BRINE-PCT> .EQ. 0.)  THEN                                       PLANTd  55
c              no glycol - loop is essentially pure water                       PLANTd  56
c              heat transport capacity per gpm flow                             PLANTd  57
          <lp;BTUH/GPM-F> = 8.34 * 60.                                          PLANTd  58
        ELSE                                                                    PLANTd  59
c$             put glycol calculations in here in future                        PLANTd  60
          <lp;BTUH/GPM-F> = 8.34 * 60.                                          PLANTd  61
        ENDIF                                                                   PLANTd  62
      ENDDO                                                                     PLANTd  63
c              check that fluid in secondary loops is consistent                PLANTd  64
c              with primary                                                     PLANTd  65
      DO  NL=1,Nlp                                                              PLANTd  66
        Jlp = Ilp + (NL-1)*Llp                                                  PLANTd  67
        LoopType = <lp:TYPE>                                                    PLANTd  68
        SubType  = <lp:SUBTYPE>                                                 PLANTd  69
        IF (SubType .EQ. SECONDARY)  THEN                                       PLANTd  70
c              get pointer to primary loop                                      PLANTd  71
          Jlp2 = Jlp                                                            PLANTd  72
          Jlp  = <lp:PRIMARY>                                                   PLANTd  73
c              primary glycol fraction and heat transport capacity              PLANTd  74
          GLYCOL1 = <lp:BRINE-PCT>                                              PLANTd  75
          Cp1     = <lp;BTUH/GPM-F>                                             PLANTd  76
c              go back to secondary loop                                        PLANTd  77
          Jlp     = Jlp2                                                        PLANTd  78
c              check type of primary/secondary transfer                         PLANTd  79
          IF (<lp:PRIM-TRANSFER> .EQ. DIRECT)  THEN                             PLANTd  80
c              no heat exchanger - glycol percentage in the secondary           PLANTd  81
c              must be the same as the primary                                  PLANTd  82
            IF (<lp:BRINE-PCT> .NE. GLYCOL1)  THEN                              PLANTd  83
              CALL MSGSIM(-3,II,II,II,II)                                       PLANTd  84
              WRITE (IOUTPT,9100) (<lp:NAME>,II=1,8),GLYCOL1                    PLANTd  85
              <lp:BRINE-PCT>  = GLYCOL1                                         PLANTd  86
              <lp;BTUH/GPM-F> = Cp1                                             PLANTd  87
            ENDIF                                                               PLANTd  88
          ENDIF                                                                 PLANTd  89
        ENDIF                                                                   PLANTd  90
      ENDDO                                                                     PLANTd  91
c                                                                               PLANTd  92
c============= AIRSIDE SYSTEM COIL CALCULATIONS =============================== PLANTd  93
c              loop thru all systems and calculate the flows                    PLANTd  94
      DO  NS=1,NSYS                                                             PLANTd  95
        NSP   = IS + (NS-1)*NSS                                                 PLANTd  96
        ICODE = <SYSTEM-TYPE>                                                   PLANTd  97
c             coil capacity ratio corresponding to minimum allowed flow         PLANTd  98
        <HWGPMMINCAP> = CVAL(<HW-CAP-FGPM> ,.3,.3)                              PLANTd  99
        <CHWGPMMINCAP> = CVAL(<CHW-CAP-FGPM>,.3,.3)                             PLANTd 102
c              design flows at main air handler level                           PLANTd 103
c              check if a 2-pipe used here                                      PLANTd 104
        Jlp = <HW-LOOP>                                                         PLANTd 105
        I2flagH = 0                                                             PLANTd 106
        IF (Jlp .GT. 0  .AND.  <lp:TYPE> .EQ. PIPE2                             RetLoss  5
     &                  .AND.  <HEATING-CAPACITY> .LT. -1.)  I2flagH = 1        RetLoss  6
        Jlp = <CHW-LOOP>                                                        RetLoss  7
        I2flagC = 0                                                             RetLoss  8
        IF (Jlp .GT. 0  .AND.  <lp:TYPE> .EQ. PIPE2                             RetLoss  9
     &                  .AND.  <COOLING-CAPACITY> .GT.  1.)  I2flagC = 1        RetLoss 10
        IF (I2flagH+I2flagC .GT. 0)  THEN                                       PLANTd 113
c              Gas and electric heating may co-exist with 2-pipe CHW            -044e3   1
c              coils, and DX cooling may co-exist with 2-pipe heating           -044e3   2
c              coils.  If so, cancel the 2-pipe flags                           -044e3   3
          IF (<HEAT-SOURCE> .GE. 0) THEN                                        -044e3   4
            I2flagH = 0                                                         -044e3   5
            I2flagC = 0                                                         -044e3   6
          ELSE                                                                  -044e3   7
            SELECT CASE (ICODE)                                                 -044e3   8
            CASE (6:8,16,17,19:22,25:29)  ! no CHW coils                        -044e3   9
              I2flagH = 0                                                       -044e3  10
              I2flagC = 0                                                       -044e3  11
            END SELECT                                                          -044e3  12
          ENDIF                                                                 -044e3  13
c              hot and chilled water coils are the same in a 2-pipe loop        PLANTd 114
          IF (I2flagH .GT. 0)  THEN                                             PLANTd 115
            <CHW-VALVE-TYPE> = <HW-VALVE-TYPE>                                  PLANTd 116
            <CHW-LOOP>       = <HW-LOOP>                                        PLANTd 117
            IF (I2flagC .GT. 0)  THEN                                           PLANTd 118
              <CHW-COIL-HEAD> = MAX(<CHW-COIL-HEAD>,<HW-COIL-HEAD>)             PLANTd 119
              <HW-COIL-HEAD>  = <CHW-COIL-HEAD>                                 PLANTd 120
            ELSE                                                                PLANTd 121
              <CHW-COIL-HEAD> = <HW-COIL-HEAD>                                  PLANTd 122
            ENDIF                                                               PLANTd 123
          ENDIF                                                                 PLANTd 124
          IF (I2flagC .GT. 0)  THEN                                             PLANTd 125
            <HW-VALVE-TYPE> = <CHW-VALVE-TYPE>                                  PLANTd 126
            <HW-LOOP>       = <CHW-LOOP>                                        PLANTd 127
            IF (I2flagH .GT. 0)  THEN                                           PLANTd 128
              <HW-COIL-HEAD>  = MAX(<HW-COIL-HEAD>,<CHW-COIL-HEAD>)             PLANTd 129
              <CHW-COIL-HEAD> = <HW-COIL-HEAD>                                  PLANTd 130
            ELSE                                                                PLANTd 131
              <HW-COIL-HEAD>  = <CHW-COIL-HEAD>                                 PLANTd 132
            ENDIF                                                               PLANTd 133
          ENDIF                                                                 PLANTd 134
        ENDIF                                                                   PLANTd 135
c              central heating coil                                             PLANTd 136
        IF (<HEATING-CAPACITY> .LT. -1.)  THEN                                  PLANTd 137
          IF (<HEAT-SOURCE> .LT. 0)  THEN                                       PLANTd 138
c              flag to indicate this system attached to a loop                  PLANTd 139
            <SYS_LOOP_FLAG> = 1                                                 PLANTd 140
c              pointer to hw loop                                               PLANTd 141
            Jlp = <HW-LOOP>                                                     PLANTd 142
c              flag for 2-way control valve                                     PLANTd 143
            IF (<HW-VALVE-TYPE> .EQ. 2)  <lp;2WAY_FLAG> = 1                     PLANTd 144
c              flag to indicate a non-primary coil is on this loop              PLANTd 145
            <lp;COIL_FLAG>     = 1                                              PLANTd 146
            <lp;COIL_HEAT>     = <lp;COIL_HEAT> + <HEATING-CAPACITY>            PLANTd 147
            <HWDESGPMS>        = <HEATING-CAPACITY>                             PLANTd 148
     &                                  / (<lp;BTUH/GPM-F>*<HW-COIL-DT>)        PLANTd 149
            <lp;GPM>           = <lp;GPM> + <HWDESGPMS>                         PLANTd 150
            <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                        PLANTd 151
     &                                 <HW-COIL-HEAD>)                          PLANTd 152
            IF(IREPRT(3,34).NE.0) WRITE(IOUTPT,9000)                            PLANTd 153
     &        (<SYSTEM-NAME>,II=1,8),<HEATING-CAPACITY>,<HWDESGPMS>,            PLANTd 154
     &         <HWDESDTS>,<HW-COIL-HEAD>                                        PLANTd 155
          ELSE                                                                  PLANTd 156
c              zero out loop pointer if not used                                PLANTd 157
            IF (<HUMIDIFIER-TYPE> .GE. 0)  <HW-LOOP> = 0                        -035   125
c              set maximum kW for electric resistance                           PLANTd 159
            IF (<HEAT-SOURCE> .EQ. 1)  THEN                                     PLANTd 160
              <MAX_HEAT_KW> = -<HEATING-CAPACITY> * KWBTU                       PLANTd 161
c              set maximum kW for heat pump supplemental                        PLANTd 162
            ELSEIF (<HEAT-SOURCE> .EQ. 4  .AND.  <SUPP-SOURCE> .EQ. 1)          PLANTd 163
     &                                                              THEN        PLANTd 164
              <MAX_SUPP_KW> = -<SUPP-HEAT-CAP> * KWBTU                          PLANTd 165
            ENDIF                                                               PLANTd 166
          ENDIF                                                                 PLANTd 167
        ELSE                                                                    PLANTd 168
          IF (<HUMIDIFIER-TYPE> .GE. 0  .AND.                                   Bug40  191
     &                              <HEAT-SOURCE> .GE. 0)  <HW-LOOP> = 0        Bug40  192
        ENDIF                                                                   PLANTd 170
        IF (<HUMIDIFIER-TYPE> .LT. 0)  THEN                                     -035   127
          <SYS_LOOP_FLAG> = 1                                                   -035   128
          <lp;2WAY_FLAG>  = 1                                                   -035   129
          <lp;COIL_FLAG>  = 1                                                   -035   130
        ENDIF                                                                   -035   131
c              preheat coil                                                     PLANTd 171
        IF (<PREHEAT-CAPACITY> .LT. -1.)  THEN                                  PLANTd 172
          IF (<PREHEAT-SOURCE> .LT. 0)  THEN                                    PLANTd 173
c              flag to indicate this system attached to a loop                  PLANTd 174
            <SYS_LOOP_FLAG> = 1                                                 PLANTd 175
            Jlp = <PHW-LOOP>                                                    PLANTd 176
c              flag for 2-way control valve                                     PLANTd 177
            IF (<PHW-VALVE-TYPE> .EQ. 2)  <lp;2WAY_FLAG> = 1                    PLANTd 178
c              flag to indicate a non-primary coil is on this loop              PLANTd 179
            <lp;COIL_FLAG>     = 1                                              PLANTd 180
            <lp;COIL_HEAT>     = <lp;COIL_HEAT> + <PREHEAT-CAPACITY>            PLANTd 181
            <PHWDESGPMS>       = <PREHEAT-CAPACITY>                             PLANTd 182
     1                               / (<lp;BTUH/GPM-F>*<PHW-COIL-DT>)          PLANTd 183
            <lp;GPM>           = <lp;GPM> + <PHWDESGPMS>                        PLANTd 184
            <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                        PLANTd 185
     &                                 <PHW-COIL-HEAD>)                         PLANTd 186
            IF(IREPRT(3,34).NE.0) WRITE(IOUTPT,9001)                            PLANTd 187
     &        (<SYSTEM-NAME>,II=1,8),<PREHEAT-CAPACITY>,<PHWDESGPMS>,           PLANTd 188
     &         <PHWDESDTS>,<PHW-COIL-HEAD>                                      PLANTd 189
          ELSE                                                                  PLANTd 190
c              zero out loop pointer if not used                                PLANTd 191
            <PHW-LOOP> = 0                                                      PLANTd 192
c              electric preheat energy                                          PLANTd 193
            IF (<PREHEAT-SOURCE> .EQ. 1)                                        PLANTd 194
     &        <MAX_PREHEAT_KW> = -<PREHEAT-CAPACITY> * KWBTU                    PLANTd 195
          ENDIF                                                                 PLANTd 196
        ELSE                                                                    PLANTd 197
          <PHW-LOOP> = 0                                                        PLANTd 198
        ENDIF                                                                   PLANTd 199
c              ERV preheat coil                                                 ERV    140
        IF (<sy;ERVentilator> .GT. 0)  THEN                                     ERV    141
          Jrv = <sy;ERVentilator>                                               ERV    142
          IF (<rv:PREHEAT-SOURC> .EQ. 2)  THEN                                  ERV    143
            CALL ERVentilator(101, Jrv, xx,xx,xx,xx,xx,xx)                      ERV    144
c              flag to indicate this system attached to a loop                  ERV    145
            <SYS_LOOP_FLAG>    = 1                                              ERV    146
            Jlp                = <rv;PreheatLoop>                               ERV    147
            <lp;2WAY_FLAG>     = 1                                              ERV    148
            <lp;COIL_FLAG>     = 1                                              ERV    149
            <lp;COIL_HEAT>     = <lp;COIL_HEAT> + <rv;QpreheatDes>              ERV    150
            <lp;GPM>           = <lp;GPM> + <rv;GPMpreheatDes>                  ERV    151
            <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>, 10.)                   ERV    152
          ENDIF                                                                 ERV    153
        ENDIF                                                                   ERV    154
c              central desiccant regeneration coil                              PLANTd 200
        IF ((ICODE .EQ. 25  .AND.  <HEATING-CAPACITY> .LT. -1.                  ERV    155
     &                      .AND.  <DESC-HEAT-SOURCE> .LT. 0)  .OR.             ERV    156
     &      (<DESC_COIL_Q> .LT. -1.))  THEN                                     ERV    157
c              flag to indicate this system attached to a loop                  PLANTd 204
          <SYS_LOOP_FLAG> = 1                                                   PLANTd 205
c              pointer to desiccant loop                                        PLANTd 206
          Jlp = <DESC-LOOP>                                                     PLANTd 207
c              flag for 2-way control valve                                     PLANTd 208
          IF (<DESC-VALVE-TYPE> .EQ. 2)  <lp;2WAY_FLAG> = 1                     PLANTd 209
c              flag to indicate a non-primary coil is on this loop              PLANTd 210
          <lp;COIL_FLAG>     = 1                                                PLANTd 211
          IF (ICODE .EQ. 25)  THEN                                              ERV    158
            Qdesc = <HEATING-CAPACITY>                                          ERV    159
          ELSE                                                                  ERV    160
            Qdesc = <DESC_COIL_Q>                                               ERV    161
          ENDIF                                                                 ERV    162
          <lp;COIL_HEAT>     = <lp;COIL_HEAT> + Qdesc                           ERV    163
          <DESCDESGPMS>      = Qdesc / (<lp;BTUH/GPM-F>*<DESC-COIL-DT>)         ERV    164
          <lp;GPM>           = <lp;GPM> + <DESCDESGPMS>                         PLANTd 215
          <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                          PLANTd 216
     &                               <DESC-COIL-HEAD>)                          PLANTd 217
          IF(IREPRT(3,34).NE.0) WRITE(IOUTPT,9000)                              PLANTd 218
     &      (<SYSTEM-NAME>,II=1,8),Qdesc,<DESCDESGPMS>,                         ERV    165
     &       <DESCDESDTS>,<DESC-COIL-HEAD>                                      PLANTd 220
        ELSE                                                                    PLANTd 221
c              zero out loop pointer if not used                                PLANTd 222
          <DESC-LOOP> = 0                                                       PLANTd 223
        ENDIF                                                                   PLANTd 224
c             central cooling coil                                              PLANTd 225
        IF((<COOLING-CAPACITY> .GT. 1.) .AND. (ICODE .NE. 9) .AND.              -035   132
     $     (ICODE .LT. 15 .OR. ICODE .EQ. 18 .OR. ICODE .EQ. 24 .OR.            -044e    3
     $     (ICODE .EQ. 23 .AND. <COOL-SOURCE> .EQ. 1))) THEN                    -044e    4
c              flag to indicate this system attached to a loop                  PLANTd 228
          <SYS_LOOP_FLAG> = 1                                                   PLANTd 229
          Jlp = <CHW-LOOP>                                                      PLANTd 230
c              flag for 2-way control valve                                     PLANTd 231
          IF (<CHW-VALVE-TYPE> .EQ. 2)  <lp;2WAY_FLAG> = 1                      PLANTd 232
c              flag to indicate a non-primary coil is on this loop              PLANTd 233
          <lp;COIL_FLAG>     = 1                                                PLANTd 234
          <lp;COIL_COOL>     = <lp;COIL_COOL> + <COOLING-CAPACITY>              PLANTd 235
          <CHWDESGPMS>       = <COOLING-CAPACITY>                               PLANTd 236
     1                               / (<lp;BTUH/GPM-F>*<CHW-COIL-DT>)          PLANTd 237
          <lp;GPM>           = <lp;GPM>       + <CHWDESGPMS>                    PLANTd 238
          <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,<CHW-COIL-HEAD>)          PLANTd 239
          IF(IREPRT(3,34).NE.0) WRITE(IOUTPT,9002)                              PLANTd 240
     &      (<SYSTEM-NAME>,II=1,8),<COOLING-CAPACITY>,<CHWDESGPMS>,             PLANTd 241
     &       <CHWCAP6544S>,<CHW-COIL-HEAD>                                      PLANTd 242
        ELSE                                                                    PLANTd 243
c              zero out loop pointer if not used                                PLANTd 244
          <CHW-LOOP> = 0                                                        PLANTd 245
        ENDIF                                                                   PLANTd 246
c              2-pipe coils will have same flow heating and cooling             PLANTd 247
        IF (I2flagH+I2flagC .GT. 0)  THEN                                       PLANTd 248
c             adjust the design quantities for the mode having                  PLANTd 249
c             the smaller of the two design flows                               PLANTd 250
          IF (<CHWDESGPMS> .GT. <HWDESGPMS>)  THEN                              PLANTd 251
c             cooling dominated                                                 PLANTd 252
            IF (<HWDESGPMS> .GT. 0.)  THEN                                      PLANTd 253
c             remove the smaller of the 2 flowrates from the loop               PLANTd 254
              <lp;GPM> = <lp;GPM> - <HWDESGPMS>                                 PLANTd 255
c             adjust the heating capacity for the increased flow                PLANTd 256
              <HEATING-CAPACITY> = <HEATING-CAPACITY>                           PLANTd 257
     &                                      * <CHWDESGPMS> / <HWDESGPMS>        PLANTd 258
              <HWDESGPMS> = <CHWDESGPMS>                                        PLANTd 259
            ENDIF                                                               PLANTd 260
          ELSE                                                                  PLANTd 261
c              heating dominated                                                PLANTd 262
            IF (<CHWDESGPMS> .GT. 0.)  THEN                                     PLANTd 263
              <lp;GPM>           = <lp;GPM> - <CHWDESGPMS>                      PLANTd 264
              <COOLING-CAPACITY> = <COOLING-CAPACITY>                           PLANTd 265
     &                                      * <HWDESGPMS> / <CHWDESGPMS>        PLANTd 266
              <CHWCAP6544S> = <CHWCAP6544S> * <HWDESGPMS> / <CHWDESGPMS>        PLANTd 267
              <CHWDESGPMS>  = <HWDESGPMS>                                       PLANTd 268
            ENDIF                                                               PLANTd 269
          ENDIF                                                                 PLANTd 270
        ENDIF                                                                   PLANTd 271
c              central wlhp's and water-cooled condensers                       -044d  129
        IF (<CONDENSER-TYPE> .EQ. 1                                             PLANTd 273
     &                           .AND. <COOLING-CAPACITY> .GT. 0.)  THEN        PLANTd 274
c              flag to indicate this system attached to a loop                  PLANTd 275
          <SYS_LOOP_FLAG> = 1                                                   PLANTd 276
          Jlp = <CW-LOOP>                                                       PLANTd 277
c              flag for 2-way control valve                                     PLANTd 278
          IF (<CW-VALVE> .EQ. Yes)  <lp;2WAY_FLAG> = 1                          PLANTd 279
c              flag to indicate a non-primary coil is on this loop              PLANTd 280
          <lp;COIL_FLAG>     = 1                                                PLANTd 281
          QCW = <COOLING-CAPACITY> * (1.+<COOLING-EIR>)                         PLANTd 282
          <lp;COIL_COOL>     = <lp;COIL_COOL> + QCW                             PLANTd 283
          IF (<HEATING-EIR> .GT. 0.)  THEN                                      -044d  130
            QHW            = <HEATING-CAPACITY> * (1.-<HEATING-EIR>)            -044d  131
            <lp;COIL_HEAT> = <lp;COIL_HEAT> + QHW                               -044d  132
          ENDIF                                                                 -044d  133
          <CWDESGPMS>        = QCW / (<lp;BTUH/GPM-F>*<CW-COIL-DT>)             PLANTd 284
          <lp;GPM>           = <lp;GPM> + <CWDESGPMS>                           PLANTd 285
          <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>, <CW-COIL-HEAD>)          PLANTd 286
          IF(IREPRT(3,34).NE.0) WRITE(IOUTPT,9003)                              PLANTd 287
     &      (<SYSTEM-NAME>,II=1,8),QCW,<CWDESGPMS>,<CW-COIL-HEAD>               PLANTd 288
        ELSE                                                                    PLANTd 289
c              zero out loop pointer if not used                                PLANTd 290
          <CW-LOOP> = 0                                                         PLANTd 291
        ENDIF                                                                   PLANTd 292
c              water-side economizer                                            PLANTd 293
        IF (<WS-ECONO> .EQ. 1  .AND. <COOLING-CAPACITY> .GT. 0.)  THEN          GLHX1  730
c              flag to indicate this system attached to a loop                  PLANTd 295
          <SYS_LOOP_FLAG> = 1                                                   PLANTd 296
c              loop pointer                                                     PLANTd 297
          Jlp   = <WSE-LOOP>                                                    PLANTd 298
c              flag for 2-way control valve                                     PLANTd 299
          IF (<WSE-VALVE-TYPE> .EQ. 2)  <lp;2WAY_FLAG> = 1                      PLANTd 300
c              flag to indicate a non-primary coil is on this loop              PLANTd 301
          <lp;COIL_FLAG> = 1                                                    PLANTd 302
          <WSEDESGPMS>   = <COOLING-CAPACITY>                                   PLANTd 303
     &                            / (<lp;BTUH/GPM-F>*<WSE-COIL-DT>)             PLANTd 304
c              economizer adds to load only if on different                     PLANTd 305
c              loop than condenser                                              PLANTd 306
          IF (<WSE-LOOP> .NE. <CW-LOOP>)  THEN                                  PLANTd 307
            <lp;COIL_COOL>     = <lp;COIL_COOL> + <COOLING-CAPACITY>            PLANTd 308
            <lp;GPM>           = <lp;GPM> + <WSEDESGPMS>                        PLANTd 309
            <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                        PLANTd 310
     &                                 <WSE-COIL-HEAD>)                         PLANTd 311
          ELSE                                                                  PLANTd 312
            <WSEDESGPMS> = <CWDESGPMS>                                          PLANTd 313
            <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                        PLANTd 314
     &                                 <WSE-COIL-HEAD>+<CW-COIL-HEAD>)          PLANTd 315
          ENDIF                                                                 PLANTd 316
          IF(IREPRT(3,34).NE.0) WRITE(IOUTPT,9004)                              PLANTd 317
     &      (<SYSTEM-NAME>,II=1,8),<COOLING-CAPACITY>,<WSEDESGPMS>,             PLANTd 318
     &       <WSE-COIL-HEAD>                                                    PLANTd 319
        ELSE                                                                    PLANTd 320
c              zero out loop pointer if not used                                PLANTd 321
          <WSE-LOOP> = 0                                                        PLANTd 322
        ENDIF                                                                   PLANTd 323
c              refrigerated display cases, only if water-cooled                 PLANTd 324
        IF (<REFG-COND-TYPE> .EQ. 3                                             PLANTd 325
     &                            .AND.  <REFG-HTREJ-DES> .GT. 1.)  THEN        PLANTd 326
c              flag to indicate this system attached to a loop                  PLANTd 327
          <SYS_LOOP_FLAG> = 1                                                   PLANTd 328
          Jlp = <REFG-CW-LOOP>                                                  PLANTd 329
c              flag for 2-way control valve                                     PLANTd 330
          IF (<REFG-VALVE-TYPE> .EQ. 2)  <lp;2WAY_FLAG> = 1                     PLANTd 331
c              flag to indicate a non-primary coil is on this loop              PLANTd 332
          <lp;COIL_FLAG> = 1                                                    PLANTd 333
c              pointer to the zone containing the refrig equip                  PLANTd 334
          ZP1 = <REFG-ZONE-ZP1>                                                 PLANTd 335
          ZP2 = <ZP2>                                                           PLANTd 336
c              loop through all compressor categories and get load and flow     PLANTd 337
          IE = <NUM-REFG-EQUIP>                                                 PLANTd 338
          DO  IG=1,IE                                                           PLANTd 339
            <lp;COIL_COOL>     = <lp;COIL_COOL> + <REFG-COND-SIZE>              PLANTd 340
            <REFGDESGPMS>      = <REFG-COND-SIZE>                               PLANTd 341
     &                                / (<lp;BTUH/GPM-F>*<REFG-COIL-DT>)        PLANTd 342
            <REFGDESGPMST>     = <REFGDESGPMST> + <REFGDESGPMS>                 PLANTd 343
            <lp;GPM>           = <lp;GPM>       + <REFGDESGPMS>                 PLANTd 344
            <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                        PLANTd 345
     &                                 <REFG-COIL-HEAD>)                        PLANTd 346
            IF(IREPRT(3,34).NE.0) WRITE(IOUTPT,9003)                            PLANTd 347
     &        (<SYSTEM-NAME>,II=1,8),<REFG-COND-SIZE>,<REFGDESGPMS>,            PLANTd 348
     &         <REFG-COIL-HEAD>                                                 PLANTd 349
          ENDDO                                                                 PLANTd 350
        ELSE                                                                    PLANTd 351
          <REFG-CW-LOOP> = 0                                                    PLANTd 352
        ENDIF                                                                   PLANTd 353
c              now loop through zones and pick up zone flows                    PLANTd 354
        ISZ = <ISZONES>                                                         PLANTd 355
        NSZ = <NZONES>                                                          PLANTd 356
        DO  NZ=1,NSZ                                                            PLANTd 357
          ZP1 = ISZ + (NZ-1)*NZD                                                PLANTd 358
          ZP2 = <ZP2>                                                           PLANTd 359
          ZMULT = <MULTIPLIER>                                                  PLANTd 360
c              only conditioned zones or plenums have flows                     PLANTd 361
          IF (<ZONE-TYPE> .NE. 2)  THEN                                         PLANTd 362
c              check if a 2-pipe used here                                      PLANTd 363
            I2flagH = 0                                                         -043a    1
            I2flagC = 0                                                         -043a    2
            IF(<HW-LOOPZ> .ne. 0) THEN                                          -043a    3
              Jlp = <HW-LOOPZ>                                                  -043a    4
              IF (<lp:TYPE> .EQ. PIPE2  .AND.  <HEATCAPZ> .LT. -1.)             -043a    5
     $          I2flagH = 1                                                     -043a    6
            ENDIF                                                               -043a    7
            IF(<CHW-LOOPZ> .ne. 0) THEN                                         -043a    8
              Jlp = <CHW-LOOPZ>                                                 -043a    9
              IF (<lp:TYPE> .EQ. PIPE2  .AND.  <COOLCAPZ> .GT.  1.)             -043a   10
     $          I2flagC = 1                                                     -043a   11
            ENDIF                                                               -043a   12
            IF (I2flagH+I2flagC .GT. 0)  THEN                                   PLANTd 372
c                Gas and electric heating may co-exist with 2-pipe CHW          -044e3  14
c                coils, and DX cooling may co-exist with 2-pipe heating         -044e3  15
c                coils.  If so, cancel the 2-pipe flags                         -044e3  16
              IF (<ZONE-HEAT-SOURCE> .GE. 0) THEN                               -044e3  17
                I2flagH = 0                                                     -044e3  18
                I2flagC = 0                                                     -044e3  19
              ELSE                                                              -044e3  20
                SELECT CASE (ICODE)                                             -044e3  21
                CASE (6:8,16,17,19:22,25:29)  ! no CHW coils                    -044e3  22
                  I2flagH = 0                                                   -044e3  23
                  I2flagC = 0                                                   -044e3  24
                END SELECT                                                      -044e3  25
              ENDIF                                                             -044e3  26
c              hot and chilled water coils are the same in a 2-pipe loop        PLANTd 373
              IF (I2flagH .GT. 0)  THEN                                         PLANTd 374
                <CHW-VALVE-TYPEZ> = <HW-VALVE-TYPEZ>                            PLANTd 375
                <CHW-LOOPZ>       = <HW-LOOPZ>                                  PLANTd 376
                IF (I2flagC .GT. 0)  THEN                                       PLANTd 377
                  <CHW-COIL-HEADZ> = MAX(<CHW-COIL-HEADZ>,                      PLANTd 378
     &                                     <HW-COIL-HEADZ>)                     PLANTd 379
                  <HW-COIL-HEADZ>  = <CHW-COIL-HEADZ>                           PLANTd 380
                ELSE                                                            PLANTd 381
                  <CHW-COIL-HEADZ> = <HW-COIL-HEADZ>                            PLANTd 382
                ENDIF                                                           PLANTd 383
              ENDIF                                                             PLANTd 384
              IF (I2flagC .GT. 0)  THEN                                         PLANTd 385
                <HW-VALVE-TYPEZ> = <CHW-VALVE-TYPEZ>                            PLANTd 386
                <HW-LOOPZ>       = <CHW-LOOPZ>                                  PLANTd 387
                IF (I2flagH .GT. 0)  THEN                                       PLANTd 388
                  <HW-COIL-HEADZ>  = MAX(<HW-COIL-HEADZ>,                       PLANTd 389
     &                                     <CHW-COIL-HEADZ>)                    PLANTd 390
                  <CHW-COIL-HEADZ> = <HW-COIL-HEADZ>                            PLANTd 391
                ELSE                                                            PLANTd 392
                  <HW-COIL-HEADZ>  = <CHW-COIL-HEADZ>                           PLANTd 393
                ENDIF                                                           PLANTd 394
              ENDIF                                                             PLANTd 395
            ENDIF                                                               PLANTd 396
c              zonal hot water coil or reheat coil and not a floor panel        PLANTd 397
            IF (ICODE .NE. 8)  THEN                                             PLANTd 398
              IF (<HEATCAPZ> .LT. -1.)  THEN                                    PLANTd 399
                IF ((<HW-LOOPZ> .ne. 0) .AND.                                   -043a   13
     $              (<ZONE-HEAT-SOURCE> .LT. 0)) THEN                           -043a   14
c              flag to indicate one or more system zones attached to a loop     PLANTd 401
                  <ZONE_LOOP_FLAG> = 1                                          PLANTd 402
c              zone coil loop pointer                                           PLANTd 403
                  Jlp = <HW-LOOPZ>                                              PLANTd 404
c              flag for 2-way control valve                                     PLANTd 405
                  IF (<HW-VALVE-TYPEZ> .EQ. 2)  <lp;2WAY_FLAG> = 1              PLANTd 406
c              flag to indicate non-primary coil is on this loop                PLANTd 407
                  <lp;COIL_FLAG>     = 1                                        PLANTd 408
                  <lp;COIL_HEAT>     = <lp;COIL_HEAT> + <HEATCAPZ>*ZMULT        PLANTd 409
                  <HWDESGPMZ>        = <HEATCAPZ>                               PLANTd 410
     &                               / (<lp;BTUH/GPM-F>*<HW-COIL-DTZ>)          PLANTd 411
                  <lp;GPM>           = <lp;GPM> + <HWDESGPMZ>*ZMULT             PLANTd 412
                  <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                  PLANTd 413
     &                                       <HW-COIL-HEADZ>)                   PLANTd 414
c              store design airflow as CFMAXH may change hourly (already        PLANTd 415
c              stored in DESIGN for PIU)                                        PLANTd 416
                  IF (ICODE .NE. 23)  <zn;HW_DES_CFM> = <CFMAXH>                PLANTd 417
                  IF(IREPRT(3,34).NE.0) WRITE(IOUTPT,9000)                      PLANTd 418
     &              (<ZONE-NAME>,II=1,8),<HEATCAPZ>,<HWDESGPMZ>,                PLANTd 419
     &              <HWDESDTZ>,<HW-COIL-HEADZ>                                  PLANTd 420
                ELSE                                                            PLANTd 421
c              zero out loop pointer if not used                                PLANTd 422
                  <HW-LOOPZ> = 0                                                PLANTd 423
c              max zone heat kW                                                 PLANTd 424
                  IF (<ZONE-HEAT-SOURCE> .EQ. 1)                                PLANTd 425
     &              <MAX_HEAT_KWZ> = -<HEATCAPZ> * KWBTU                        PLANTd 426
                ENDIF                                                           PLANTd 427
              ELSE                                                              PLANTd 428
                <HW-LOOPZ> = 0                                                  PLANTd 429
              ENDIF                                                             PLANTd 430
            ELSE                                                                PLANTd 431
c              floor panel systems (FPH)                                        PLANTd 432
              IF (<ERMIND> .LT. -1.)  THEN                                      PLANTd 433
                IF (<ZONE-HEAT-SOURCE> .LT. 0)  THEN                            PLANTd 434
c              default the capacity if not specified                            PLANTd 435
                  IF (<HEATCAPZ> .GT. -1.)                                      PLANTd 436
     &                <HEATCAPZ> = <ERMIND>*(1.0+<PANEL-LOSS-RATIO>)            PLANTd 437
c              flag to indicate one or more system zones attached to a loop     PLANTd 438
                  <ZONE_LOOP_FLAG> = 1                                          PLANTd 439
c              zone coil loop pointer                                           PLANTd 440
                  Jlp = <HW-LOOPZ>                                              PLANTd 441
c              flag for 2-way control valve                                     PLANTd 442
                  IF (<HW-VALVE-TYPEZ> .EQ. 2)  <lp;2WAY_FLAG> = 1              PLANTd 443
c              flag to indicate non-primary coil is on this loop                PLANTd 444
                  <lp;COIL_FLAG> = 1                                            PLANTd 445
                  <lp;COIL_HEAT>     = <lp;COIL_HEAT> + <HEATCAPZ>*ZMULT        PLANTd 446
                  <HWDESGPMZ>        = <HEATCAPZ>                               PLANTd 447
     &                                / (<lp;BTUH/GPM-F>*<HW-COIL-DTZ>)         -034    61
                  <lp;GPM>           = <lp;GPM>  + <HWDESGPMZ>*ZMULT            PLANTd 449
                  <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                  PLANTd 450
     &                                       <HW-COIL-HEADZ>)                   PLANTd 451
                  IF(IREPRT(3,34).NE.0) WRITE(IOUTPT,9000)                      PLANTd 452
     &              (<ZONE-NAME>,II=1,8),<HEATCAPZ>,<HWDESGPMZ>,                PLANTd 453
     &              <HWDESDTZ>,<HW-COIL-HEADZ>                                  PLANTd 454
                ELSE                                                            PLANTd 455
c              zero out loop pointer if not used                                PLANTd 456
                  <HW-LOOPZ> = 0                                                PLANTd 457
c              max zone heat kW                                                 PLANTd 458
                  IF (<ZONE-HEAT-SOURCE> .EQ. 1)                                PLANTd 459
     &              <MAX_HEAT_KWZ> = -<ERMIND> * KWBTU                          PLANTd 460
                ENDIF                                                           PLANTd 461
              ELSE                                                              PLANTd 462
                <HW-LOOPZ> = 0                                                  PLANTd 463
              ENDIF                                                             PLANTd 464
            ENDIF                                                               PLANTd 465
c              baseboard coil                                                   PLANTd 466
            IF (<BASEBOARD-RATING> .LT. -1.)  THEN                              PLANTd 467
              IF (<BASEBOARD-SOURCE> .LT. 0)  THEN                              PLANTd 468
c              flag to indicate one or more system zones attached to a loop     PLANTd 469
                <ZONE_LOOP_FLAG> = 1                                            PLANTd 470
c              baseboard coil loop pointer                                      PLANTd 471
                Jlp = <BBRD-LOOPZ>                                              PLANTd 472
c              flag for 2-way control valve                                     PLANTd 473
              IF (<BBRD-VALVE-TYPEZ> .EQ. 2)  <lp;2WAY_FLAG> = 1                PLANTd 474
c              flag to indicate non-primary coil is on this loop                PLANTd 475
                <lp;COIL_FLAG> = 1                                              PLANTd 476
                <lp;COIL_HEAT>     = <lp;COIL_HEAT>                             PLANTd 477
     &                                        + <BASEBOARD-RATING>*ZMULT        PLANTd 478
c              design dT between EAT and EWT for hot water coil (zonal)         PLANTd 479
                <BBRDDESDTZ>       = <DESIGN-HEAT-T>-<lp:DESIGN-HEAT-T>         Chlr1 2907
                <BBRDDESGPMZ>      =  <BASEBOARD-RATING>                        PLANTd 481
     &                             / (<lp;BTUH/GPM-F>*<BBRD-COIL-DTZ>)          PLANTd 482
                <lp;GPM>           = <lp;GPM> + <BBRDDESGPMZ>*ZMULT             PLANTd 483
                <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                    PLANTd 484
     &                                     <BBRD-COIL-HEADZ>)                   PLANTd 485
                IF(IREPRT(3,34).NE.0) WRITE(IOUTPT,9005)                        PLANTd 486
     &            (<ZONE-NAME>,II=1,8),<BASEBOARD-RATING>,<BBRDDESGPMZ>,        PLANTd 487
     &            <BBRDDESDTZ>,<BBRD-COIL-HEADZ>                                -042f    1
              ELSE                                                              PLANTd 489
c              zero out loop pointer if not used                                PLANTd 490
                <BBRD-LOOPZ> = 0                                                PLANTd 491
c              max zone heat kW                                                 PLANTd 492
                IF (<BASEBOARD-SOURCE> .EQ. 1)                                  PLANTd 493
     &            <MAX_BBRD_KWZ> = -<BASEBOARD-RATING> * KWBTU                  PLANTd 494
              ENDIF                                                             PLANTd 495
            ELSE                                                                PLANTd 496
c              zero out loop pointer if not used                                PLANTd 497
                <BBRD-LOOPZ> = 0                                                PLANTd 498
            ENDIF                                                               PLANTd 499
c              chilled water zone coil                                          PLANTd 500
            IF((<COOLCAPZ>.GT.1.).and.(ICODE.EQ.9.or.ICODE.EQ.11)) THEN         -033    16
c              flag to indicate one or more system zones attached to a loop     PLANTd 502
              <ZONE_LOOP_FLAG> = 1                                              PLANTd 503
c              zone coil loop pointer                                           PLANTd 504
              Jlp = <CHW-LOOPZ>                                                 PLANTd 505
c              flag for 2-way control valve                                     PLANTd 506
              IF (<CHW-VALVE-TYPEZ> .EQ. 2)  <lp;2WAY_FLAG> = 1                 PLANTd 507
c              flag to indicate non-primary coil is on this loop                PLANTd 508
              <lp;COIL_FLAG> = 1                                                PLANTd 509
              <lp;COIL_COOL>     = <lp;COIL_COOL> + <COOLCAPZ>*ZMULT            PLANTd 510
              <CHWDESGPMZ>       = <COOLCAPZ>                                   PLANTd 511
     &                               / (<lp;BTUH/GPM-F>*<CHW-COIL-DTZ>)         -034    62
              <lp;GPM>           = <lp;GPM>    + <CHWDESGPMZ>*ZMULT             PLANTd 513
              <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                      PLANTd 514
     &                                   <CHW-COIL-HEADZ>)                      PLANTd 515
c              store design airflow as CFMAX may change hourly                  PLANTd 516
                <zn;CHW_DES_CFM> = <CFMAX>                                      PLANTd 517
              IF(IREPRT(3,34).NE.0) WRITE(IOUTPT,9002)                          PLANTd 518
     &          (<ZONE-NAME>,II=1,8),<COOLCAPZ>,<CHWDESGPMZ>,                   PLANTd 519
     &          <CHWCAP6544Z>,<CHW-COIL-HEADZ>                                  PLANTd 520
            ELSE                                                                PLANTd 521
c              zero out loop pointer if not used                                PLANTd 522
              <CHW-LOOPZ> = 0                                                   PLANTd 523
            ENDIF                                                               PLANTd 524
c              2-pipe coils will have same flow heating and cooling             PLANTd 525
            IF (I2flagH+I2flagC .GT. 0)  THEN                                   PLANTd 526
              IF (<CHWDESGPMZ> .GT. <HWDESGPMZ>)  THEN                          PLANTd 527
c              cooling dominated                                                PLANTd 528
                IF (<HWDESGPMZ> .GT. 0.)  THEN                                  PLANTd 529
c              remove the smaller of the 2 flowrates from the loop              PLANTd 530
                  <lp;GPM>   = <lp;GPM> - <HWDESGPMZ>*ZMULT                     PLANTd 531
c              adjust the heating capacity for the increased flow               PLANTd 532
                  <HEATCAPZ> = <HEATCAPZ> * <CHWDESGPMZ>/<HWDESGPMZ>            PLANTd 533
                ELSE                                                            PLANTd 534
c              coil has a capacity even when design heating capacity is zero    PLANTd 535
                  <HEATCAPZ> = <lp;BTUH/GPM-F> * <CHWDESGPMZ>                   PLANTd 536
     &                                            * <HW-COIL-DTZ>               PLANTd 537
                ENDIF                                                           PLANTd 538
                <HWDESGPMZ>  = <CHWDESGPMZ>                                     PLANTd 539
              ELSEIF (<HWDESGPMZ> .GT. <CHWDESGPMZ>)  THEN                      PLANTd 540
                IF (<CHWDESGPMZ> .GT. 0.)  THEN                                 PLANTd 541
                  <lp;GPM>      = <lp;GPM>    - <CHWDESGPMZ>*ZMULT              PLANTd 542
                  <COOLCAPZ>    = <COOLCAPZ>   *<HWDESGPMZ>/<CHWDESGPMZ>        PLANTd 543
                  <CHWCAP6544Z> = <CHWCAP6544Z>*<HWDESGPMZ>/<CHWDESGPMZ>        PLANTd 544
                ELSE                                                            PLANTd 545
                  <COOLCAPZ>    = <lp;BTUH/GPM-F> * <HWDESGPMZ>                 PLANTd 546
     &                                              * <CHW-COIL-DTZ>            PLANTd 547
                  <CHWCAP6544Z> = <COOLCAPZ>                                    PLANTd 548
                ENDIF                                                           PLANTd 549
                <CHWDESGPMZ> = <HWDESGPMZ>                                      PLANTd 550
              ENDIF                                                             PLANTd 551
            ENDIF                                                               PLANTd 552
c              zonal wlhp's and water-cooled condensers                         PLANTd 553
            IF ((<CONDENSER-TYPE> .EQ. 1  .OR.  ICODE .EQ. 15)                  PLANTd 554
     &                                  .AND.  <COOLCAPZ> .GT. 1.)  THEN        PLANTd 555
c              flag to indicate one or more system zones attached to a loop     PLANTd 556
              <ZONE_LOOP_FLAG> = 1                                              PLANTd 557
c              cw loop pointer                                                  PLANTd 558
              Jlp = <CW-LOOPZ>                                                  PLANTd 559
c              flag for 2-way control valve                                     PLANTd 560
              IF (<CW-VALVEZ> .EQ. Yes)  <lp;2WAY_FLAG> = 1                     PLANTd 561
c              flag to indicate non-primary coil is on this loop                PLANTd 562
              <lp;COIL_FLAG> = 1                                                PLANTd 563
              QCW            = <COOLCAPZ> * (1.+<COOLING-EIR>)                  PLANTd 564
              <lp;COIL_COOL> = <lp;COIL_COOL> + QCW*Zmult                       -034    63
              IF (ICODE .EQ. 15)  THEN                                          -034    64
                QHW            = <HEATCAPZ> * (1.-<HEATING-EIR>)                -034    65
                <lp;COIL_HEAT> = <lp;COIL_HEAT> + QHW*Zmult                     -034    66
              ENDIF                                                             -034    67
              <CWDESGPMZ>        = QCW / (<lp;BTUH/GPM-F>*<CW-COIL-DTZ>)        PLANTd 568
              <lp;GPM>           = <lp;GPM> + <CWDESGPMZ>*ZMULT                 PLANTd 569
              <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                      PLANTd 570
     &                                   <CW-COIL-HEADZ>)                       PLANTd 571
              IF(IREPRT(3,34).NE.0) WRITE(IOUTPT,9003)                          PLANTd 572
     &          (<ZONE-NAME>,II=1,8),<COOLCAPZ>,<CWDESGPMZ>,                    PLANTd 573
     &           <CW-COIL-HEADZ>                                                PLANTd 574
            ELSE                                                                PLANTd 575
c              zero out loop pointer if not used                                PLANTd 576
              <CW-LOOPZ> = 0                                                    PLANTd 577
            ENDIF                                                               PLANTd 578
c              water-side economizer - wlhp only                                PLANTd 579
            IF (<WS-ECONO> .EQ. 1                                               PLANTd 580
     &           .AND.  (<COOLCAPZ> .GT. 1.  .OR.  ICODE .EQ. 15))  THEN        PLANTd 581
c              flag to indicate one or more system zones attached to a loop     PLANTd 582
              <ZONE_LOOP_FLAG> = 1                                              PLANTd 583
c              loop pointer                                                     PLANTd 584
              Jlp = <WSE-LOOPZ>                                                 PLANTd 585
c              flag for 2-way control valve                                     PLANTd 586
              IF (<WSE-VALVE-TYPEZ> .EQ. 2)  <lp;2WAY_FLAG> = 1                 PLANTd 587
c              flag to indicate non-primary coil is on this loop                PLANTd 588
              <lp;COIL_FLAG> = 1                                                PLANTd 589
              <WSEDESGPMZ>   = <COOLCAPZ>                                       PLANTd 590
     &                              / (<lp;BTUH/GPM-F>*<WSE-COIL-DTZ>)          PLANTd 591
c              economizer adds to load and flow only if on different            PLANTd 592
c              loop than condenser                                              PLANTd 593
              IF (<WSE-LOOPZ> .NE. <CW-LOOPZ>)  THEN                            PLANTd 594
                <lp;COIL_COOL>     = <lp;COIL_COOL> + <COOLCAPZ>*ZMULT          PLANTd 595
                <lp;GPM>           = <lp;GPM>  + <WSEDESGPMZ>*ZMULT             PLANTd 596
                <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                    PLANTd 597
     &                                     <WSE-COIL-HEADZ>)                    PLANTd 598
              ELSE                                                              PLANTd 599
c              for the design head, assume that the economizer may be           PLANTd 600
c              active at the same time as the compressor                        PLANTd 601
                <WSEDESGPMZ>       = <CWDESGPMZ>                                PLANTd 602
                <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                    PLANTd 603
     &                                 <WSE-COIL-HEADZ>+<CW-COIL-HEADZ>)        PLANTd 604
              ENDIF                                                             PLANTd 605
              IF(IREPRT(3,34).NE.0) WRITE(IOUTPT,9004)                          PLANTd 606
     &          (<ZONE-NAME>,II=1,8),<COOLCAPZ>,<WSEDESGPMZ>,                   PLANTd 607
     &           <WSE-COIL-HEADZ>                                               PLANTd 608
            ELSE                                                                PLANTd 609
c              zero out loop pointer if not used                                PLANTd 610
              <WSE-LOOPZ> = 0                                                   PLANTd 611
            ENDIF                                                               PLANTd 612
c              Ice skating rink                                                 IcRink 804
            IF (<zn:ICE-RINK> .GT. 0)  THEN                                     IcRink 805
              Jir = <zn:ICE-RINK>                                               IcRink 806
              IF (<ir;QrinkDes>    .GT. 0.  .AND.                               IcRink 807
     &            <ir:BRINE-LOOP> .GT. 0)  THEN                                 IcRink 808
c                  flag to indicate a system zone attached to a loop            IcRink 809
                <ZONE_LOOP_FLAG> = 1                                            IcRink 810
c                  brine loop pointer                                           IcRink 811
                Jlp = <ir:BRINE-LOOP>                                           IcRink 812
c                  flag for 2-way control valve                                 IcRink 813
                IF (<ir:BRINE-VALVE> .EQ. 2)  <lp;2WAY_FLAG> = 1                IcRink 814
c                  flag to indicate non-primary coil is on this loop            IcRink 815
                <lp;COIL_FLAG> = 1                                              IcRink 816
                <lp;COIL_COOL> = <lp;COIL_COOL> + <ir;QrinkDes>*Zmult           IcRink 817
                <lp;GPM>       = <lp;GPM>       + <ir;MrinkDes>*Zmult           IcRink 818
                <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                    IcRink 819
     &                                   <ir:BRINE-HEAD>)                       IcRink 820
              ENDIF                                                             IcRink 821
c              Ice skating rink, subfloor heating                               IcRink 822
              IF (<ir;QsubfloorDes>  .LT. 0.  .AND.                             IcRink 823
     &            <ir:SUBFLOOR-LOOP> .GT. 0)  THEN                              IcRink 824
c                  flag to indicate a system zone attached to a loop            IcRink 825
                <ZONE_LOOP_FLAG> = 1                                            IcRink 826
c                  brine loop pointer                                           IcRink 827
                Jlp = <ir:SUBFLOOR-LOOP>                                        IcRink 828
c                  flag for 2-way control valve                                 IcRink 829
                IF (<ir:SUBFLOOR-VALV> .EQ. 2)  <lp;2WAY_FLAG> = 1              IcRink 830
c                  flag to indicate non-primary coil is on this loop            IcRink 831
                <lp;COIL_FLAG> = 1                                              IcRink 832
                <lp;COIL_HEAT> = <lp;COIL_HEAT>                                 IcRink 833
     &                         + <ir;QsubfloorDes>*Zmult                        IcRink 834
                <lp;GPM>       = <lp;GPM> + <ir;MsubfloorDes>*Zmult             IcRink 835
                <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                    IcRink 836
     &                                   <ir:SUBFLOOR-HEAD>)                    IcRink 837
              ENDIF                                                             IcRink 838
            ENDIF  ! zn;ICE-RINK                                                IcRink 839
c              end of conditioned zone loop                                     PLANTd 613
          ENDIF                                                                 PLANTd 614
        ENDDO                                                                   PLANTd 615
        IF (<ZONE_LOOP_FLAG> .NE. 0)  <SYS_LOOP_FLAG> = 1                       PLANTd 616
c              end of systems loop                                              PLANTd 617
      ENDDO                                                                     PLANTd 618
c                                                                               PLANTd 619
c============= PRIMARY EQUIPMENT HEADS ======================================== PLANTd 620
c              Look at primary equipment and see if any equipment               PLANTd 621
c              user-sized.  Also pass design equipment heads onto the           PLANTd 622
c              circulation loops.  In these calcs, the head is passed onto      PLANTd 623
c              the DEMAND-SIDE_HEAD variable if the equipment is on the demand  PLANTd 624
c              side of the loop (such as a chiller condenser, or absorption     PLANTd 625
c              hot water demand), or the SUPPLY-SIDE_HEAD if the equipment      PLANTd 626
c              is a supplier to the loop (such as a chiller evaporator).        PLANTd 627
c              This separation is necessary in calculating the                  PLANTd 628
c              pump head pressure setpoints.                                    PLANTd 629
c                                                                               PLANTd 630
c              boilers                                                          PLANTd 631
      DO  Neq=1,Nbl                                                             PLANTd 632
        Jbl = Ibl + (Neq-1)*Lbl                                                 PLANTd 633
c              loop that equipment supplies                                     PLANTd 634
        Jlp = <bl:HW-LOOP>                                                      PLANTd 635
c              pick up size and flow only if specified                          PLANTd 636
        IF (<bl:CAP> .NE. 0.)  THEN                                             PLANTd 637
c              boiler size should be a negative number, and in Btu              PLANTd 638
          <bl:CAP> = -ABS(<bl:CAP>*1.E6)                                        PLANTd 639
c              increment loop capacity                                          PLANTd 640
          <lp;PRIMARY_HCAP> = <lp;PRIMARY_HCAP> + <bl:CAP>                      PLANTd 641
        ENDIF                                                                   PLANTd 642
        IF (<bl:HW-PUMP> .EQ. 0)  THEN                                          PLANTd 643
c              no attached pump - primary loop must absorb head                 PLANTd 644
          <lp;SUP-SIDE_HEAD> = MAX(<lp;SUP-SIDE_HEAD>,                          PLANTd 645
     &                               <bl:HW-HEAD>)                              PLANTd 646
          <lp;SUP-SIDE_STAT> = MAX(<lp;SUP-SIDE_STAT>,                          PLANTd 647
     &                               <bl:HW-STATIC>)                            PLANTd 648
        ELSE                                                                    PLANTd 649
          Jpm = <bl:HW-PUMP>                                                    PLANTd 650
          <pm;EQUIP_CTRL>  = <bl:HW-CTRL>                                       PLANTd 651
          <pm;EQUIP_HEAD>  = <bl:HW-HEAD>                                       PLANTd 652
          <pm;STATIC_HEAD> = <bl:HW-STATIC>                                     PLANTd 653
        ENDIF                                                                   PLANTd 654
      ENDDO                                                                     PLANTd 655
c              dhw heaters                                                      PLANTd 656
      DO  Neq=1,Ndw                                                             PLANTd 657
        Jdw = Idw + (Neq-1)*Ldw                                                 PLANTd 658
c              loop that equipment supplies                                     PLANTd 659
        Jlp = <dw:DHW-LOOP>                                                     PLANTd 660
c              pick up size only if specified                                   PLANTd 661
        IF (<dw:CAP> .NE. UNFILD)  THEN                                         PLANTd 662
c              dw heater size should be a negative number, and in Btu           PLANTd 663
          <dw:CAP> = -ABS(<dw:CAP>*1.E6)                                        PLANTd 664
c              increment capacity of loop                                       PLANTd 665
          <lp;PRIMARY_HCAP> = <lp;PRIMARY_HCAP> + <dw:CAP>                      PLANTd 666
        ENDIF                                                                   PLANTd 667
c              default heat pump supplemental heat                              PLANTd 668
        IF (<dw:TYPE> .EQ. DHWhtpump                                            PLANTd 669
     &               .AND. <dw:HP-SUPP-CAP> .NE. UNFILD)  THEN                  PLANTd 670
          <dw:HP-SUPP-CAP>  = -ABS(<dw:HP-SUPP-CAP>*1.E6)                       PLANTd 671
          <lp;PRIMARY_HCAP> = <lp;PRIMARY_HCAP> + <dw:HP-SUPP-CAP>              PLANTd 672
        ENDIF                                                                   PLANTd 673
        IF (<dw:MAX-HTREC> .NE. UNFILD)                                         PLANTd 674
     &      <dw:MAX-HTREC> = -ABS(<dw:MAX-HTREC>*1.E6)                          PLANTd 675
        IF (<dw:PUMP> .EQ. 0)  THEN                                             PLANTd 676
c              no attached pump - primary loop must absorb head                 PLANTd 677
          <lp;SUP-SIDE_HEAD> = MAX(<lp;SUP-SIDE_HEAD>,                          PLANTd 678
     &                               <dw:HEAD>)                                 PLANTd 679
          <lp;SUP-SIDE_STAT> = MAX(<lp;SUP-SIDE_STAT>,                          PLANTd 680
     &                               <dw:STATIC>)                               PLANTd 681
        ELSE                                                                    PLANTd 682
          Jpm = <dw:PUMP>                                                       PLANTd 683
c              dhw pump acts to recirculate water only                          PLANTd 684
          <pm;EQUIP_CTRL>  = Constantflow                                       PLANTd 685
          <pm;EQUIP_HEAD>  = <dw:HEAD>                                          PLANTd 686
          <pm;STATIC_HEAD> = <dw:STATIC>                                        PLANTd 687
        ENDIF                                                                   PLANTd 688
      ENDDO                                                                     PLANTd 718
c              chillers                                                         PLANTd 719
      DO  Neq=1,Nch                                                             PLANTd 720
        Jch = Ich + (Neq-1)*Lch                                                 PLANTd 721
c              loop that equipment supplies                                     PLANTd 722
        Jlp = <ch:CHW-LOOP>                                                     PLANTd 723
c              pick up size and flow only if specified                          PLANTd 724
        IF (<ch:CAP> .NE. 0.)  THEN                                             PLANTd 725
c              chiller size should be a positive number                         PLANTd 726
          <ch:CAP> = ABS(<ch:CAP>*1.E6)                                         PLANTd 727
c              increment loop capacity                                          PLANTd 728
          IF (<ch:TYPE> .NE. 13)                                                FreeCl  64
     &      <lp;PRIMARY_CCAP> = <lp;PRIMARY_CCAP> + <ch:CAP>                    FreeCl  65
        ENDIF                                                                   PLANTd 730
        IF (<ch:CHW-PUMP> .EQ. 0)  THEN                                         PLANTd 731
c              no attached pump - primary loop must absorb head                 PLANTd 732
          <lp;SUP-SIDE_HEAD> = MAX(<lp;SUP-SIDE_HEAD>,                          PLANTd 733
     &                               <ch:CHW-HEAD>)                             PLANTd 734
          <lp;SUP-SIDE_STAT> = MAX(<lp;SUP-SIDE_STAT>,                          PLANTd 735
     &                               <ch:CHW-STATIC>)                           PLANTd 736
        ELSE                                                                    PLANTd 737
          Jpm = <ch:CHW-PUMP>                                                   PLANTd 738
          <pm;EQUIP_CTRL>  = <ch:CHW-CTRL>                                      PLANTd 739
          <pm;EQUIP_HEAD>  = <ch:CHW-HEAD>                                      PLANTd 740
          <pm;STATIC_HEAD> = <ch:CHW-STATIC>                                    PLANTd 741
        ENDIF                                                                   PLANTd 742
        IF (<ch:HW-LOOP> .GT. 0)  THEN                                          PLANTd 743
          Jlp = <ch:HW-LOOP>                                                    PLANTd 744
          IF (<ch:ALGORITHM> .EQ. Chiller_Absor1)  THEN                         PLANTd 745
c              hw or steam absorption                                           PLANTd 746
            IF (<ch:HW-PUMP> .EQ. 0)  THEN                                      PLANTd 747
c              no attached pump - primary loop must absorb head                 PLANTd 748
              <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                      PLANTd 749
     &                                   <ch:HW-HEAD>)                          PLANTd 750
              <lp;DEM-SIDE_STAT> = MAX(<lp;DEM-SIDE_STAT>,                      PLANTd 751
     &                                   <ch:HW-STATIC>)                        PLANTd 752
            ELSE                                                                PLANTd 753
              Jpm = <ch:HW-PUMP>                                                PLANTd 754
              <pm;EQUIP_CTRL>  = <ch:HW-CTRL>                                   PLANTd 755
              <pm;EQUIP_HEAD>  = <ch:HW-HEAD>                                   PLANTd 756
              <pm;STATIC_HEAD> = <ch:HW-STATIC>                                 PLANTd 757
            ENDIF                                                               PLANTd 758
          ELSEIF (<ch:ALGORITHM> .EQ. Chiller_Gas1  .OR.                        ChlrHP 776
     &            <ch:ALGORITHM> .EQ. Chiller_LoopHP1)  THEN                    ChlrHP 777
c              chiller/heater                                                   ChlrHP 778
            IF (<ch:HW-PUMP> .EQ. 0)  THEN                                      PLANTd 761
c              no attached pump - primary loop must absorb head                 PLANTd 762
              <lp;SUP-SIDE_HEAD> = MAX(<lp;SUP-SIDE_HEAD>,                      PLANTd 763
     &                                   <ch:HW-HEAD>)                          PLANTd 764
              <lp;SUP-SIDE_STAT> = MAX(<lp;SUP-SIDE_STAT>,                      PLANTd 765
     &                                   <ch:HW-STATIC>)                        PLANTd 766
            ELSE                                                                PLANTd 767
              Jpm = <ch:HW-PUMP>                                                PLANTd 768
              <pm;EQUIP_CTRL>  = <ch:HW-CTRL>                                   PLANTd 769
              <pm;EQUIP_HEAD>  = <ch:HW-HEAD>                                   PLANTd 770
              <pm;STATIC_HEAD> = <ch:HW-STATIC>                                 PLANTd 771
            ENDIF                                                               PLANTd 772
          ENDIF                                                                 PLANTd 773
        ENDIF                                                                   PLANTd 774
        IF (<ch:HTREC-LOOP> .GT. 0)  THEN                                       PLANTd 775
          IF (<ch:HTREC-PUMP> .EQ. 0)  THEN                                     PLANTd 776
c              no attached pump - primary loop must absorb head                 PLANTd 777
c              Note that heat recovery is presumed to be in series              PLANTd 778
c              with the rest of the primary equipment, but in parallel          PLANTd 779
c              with other heat recovery devices                                 PLANTd 780
            Jlp = <ch:HTREC-LOOP>                                               PLANTd 781
            <lp;HTREC_HEAD>   = MAX(<lp;HTREC_HEAD>,                            PLANTd 782
     &                                <ch:HTREC-HEAD>)                          PLANTd 783
            <lp;HTREC_STATIC> = MAX(<lp;HTREC_STATIC>,                          PLANTd 784
     &                                <ch:HTREC-STATI>)                         PLANTd 785
          ELSE                                                                  PLANTd 786
            Jpm = <ch:HTREC-PUMP>                                               PLANTd 787
            <pm;EQUIP_CTRL>  = <ch:HTREC-CTRL>                                  PLANTd 788
            <pm;EQUIP_HEAD>  = <ch:HTREC-HEAD>                                  PLANTd 789
            <pm;STATIC_HEAD> = <ch:HTREC-STATI>                                 PLANTd 790
          ENDIF                                                                 PLANTd 791
        ENDIF                                                                   PLANTd 792
        IF (<ch:CW-LOOP> .GT. 0)  THEN                                          PLANTd 793
          IF (<ch:CW-PUMP> .EQ. 0)  THEN                                        PLANTd 794
c              no attached pump - primary loop must absorb head                 PLANTd 795
            Jlp = <ch:CW-LOOP>                                                  PLANTd 796
            <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                        PLANTd 797
     &                                 <ch:CW-HEAD>)                            PLANTd 798
            <lp;DEM-SIDE_STAT> = MAX(<lp;DEM-SIDE_STAT>,                        PLANTd 799
     &                                 <ch:CW-STATIC>)                          PLANTd 800
          ELSE                                                                  PLANTd 801
            Jpm = <ch:CW-PUMP>                                                  PLANTd 802
            <pm;EQUIP_CTRL>  = <ch:CW-CTRL>                                     PLANTd 803
            <pm;EQUIP_HEAD>  = <ch:CW-HEAD>                                     PLANTd 804
            <pm;STATIC_HEAD> = <ch:CW-STATIC>                                   PLANTd 805
          ENDIF                                                                 PLANTd 806
        ENDIF                                                                   PLANTd 807
      ENDDO                                                                     PLANTd 808
c              cooling towers                                                   PLANTd 809
      DO  Neq=1,Ntw                                                             PLANTd 810
        Jtw = Itw + (Neq-1)*Ltw                                                 PLANTd 811
c              loop that equipment supplies                                     PLANTd 812
        Jlp = <tw:CW-LOOP>                                                      PLANTd 813
c              pick up size and flow only if specified                          PLANTd 814
        IF (<tw:CAPACITY> .NE. 0.)  THEN                                        PLANTd 815
c              tower size should be a positive number                           PLANTd 816
          <tw:CAPACITY> = ABS(<tw:CAPACITY>*1.E6)                               PLANTd 817
c              increment loop capacity                                          PLANTd 818
          <lp;PRIMARY_CCAP> = <lp;PRIMARY_CCAP> + <tw:CAPACITY>                 PLANTd 819
        ENDIF                                                                   PLANTd 820
        IF (<tw:CW-PUMP> .EQ. 0)  THEN                                          PLANTd 821
c              no attached pump - primary loop must absorb head                 PLANTd 822
          IF (<tw:NUM-CELLS> .GT. 1.  .AND.                                     PLANTd 823
     &                            <tw:CELL-CTRL> .EQ. RunMinCells)  THEN        PLANTd 824
c              Friction head losses will be relatively constant in multi-cell   PLANTd 825
c              towers controlled to minimize the number of cells operating      PLANTd 826
c              Approximate this by lumping the friction losses with the         PLANTd 827
c              static losses                                                    PLANTd 828
            <lp;SUP-SIDE_STAT> = MAX(<lp;SUP-SIDE_STAT>,                        PLANTd 829
     &                                 <tw:CW-HEAD>+<tw:CW-STATIC>)             PLANTd 830
          ELSE                                                                  PLANTd 831
c              single cell tower, or controlled to maximum number of cells      PLANTd 832
            <lp;SUP-SIDE_HEAD> = MAX(<lp;SUP-SIDE_HEAD>,                        PLANTd 833
     &                                 <tw:CW-HEAD>)                            PLANTd 834
            <lp;SUP-SIDE_STAT> = MAX(<lp;SUP-SIDE_STAT>,                        PLANTd 835
     &                                 <tw:CW-STATIC>)                          PLANTd 836
          ENDIF                                                                 PLANTd 837
        ELSE                                                                    PLANTd 838
c              tower has a pump                                                 PLANTd 839
          Jpm = <tw:CW-PUMP>                                                    PLANTd 840
          <pm;EQUIP_CTRL>  = <tw:CW-CTRL>                                       PLANTd 841
          IF (<tw:NUM-CELLS> .GT. 1.  .AND.                                     PLANTd 842
     &                            <tw:CELL-CTRL> .EQ. RunMinCells)  THEN        PLANTd 843
c              multi-cell tower controlled to minimum number of cells           PLANTd 844
            <pm;EQUIP_HEAD>  = <tw:HX-HEAD>                                     PLANTd 845
            <pm;STATIC_HEAD> = <tw:CW-HEAD> + <tw:CW-STATIC>                    PLANTd 846
          ELSE                                                                  PLANTd 847
c              single cell tower, or controlled to maximum number of cells      PLANTd 848
            <pm;EQUIP_HEAD>  = <tw:HX-HEAD> + <tw:CW-HEAD>                      PLANTd 849
            <pm;STATIC_HEAD> = <tw:CW-STATIC>                                   PLANTd 850
          ENDIF                                                                 PLANTd 851
          IF (<tw:TYPE> .EQ. OpenHX)                                            PLANTd 852
c              open-twr&hx head on condenser side is head of the                PLANTd 853
c              heat exchanger - no static allowed                               PLANTd 854
     &      <lp;SUP-SIDE_HEAD> = MAX(<lp;SUP-SIDE_HEAD>,                        PLANTd 855
     &                                 <tw:HX-HEAD>)                            PLANTd 856
        ENDIF                                                                   PLANTd 857
c              pan heater                                                       PLANTd 858
        IF (<tw:PAN-LOSS> .NE. 0.)  THEN                                        PLANTd 859
          <tw:PAN-LOSS> = -ABS(<tw:PAN-LOSS>)                                   PLANTd 860
          IF (<tw:PAN-HTR-TYPE> .EQ. HWPanHtr)  THEN                            PLANTd 861
            Jlp = <tw:PAN-HTR-LOOP>                                             PLANTd 862
            <lp;COIL_HEAT>     = <lp;COIL_HEAT> + <tw:PAN-LOSS>                 PLANTd 863
            <tw;PAN_DES_GPM>   = <tw:PAN-LOSS>                                  PLANTd 864
     &                               / (<lp;BTUH/GPM-F>*<tw:PAN-HTR-DT>)        PLANTd 865
            <lp;GPM>           = <lp;GPM> + <tw;PAN_DES_GPM>                    PLANTd 866
            <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                        PLANTd 867
     &                                 <tw:PAN-HTR-HEAD>)                       PLANTd 868
          ENDIF                                                                 PLANTd 869
        ENDIF                                                                   PLANTd 870
      ENDDO                                                                     PLANTd 871
c              elec-generators                                                  PLANTd 872
      DO  Neq=1,Ngn                                                             PLANTd 873
        Jgn = Ign + (Neq-1)*Lgn                                                 PLANTd 874
        CALL CogenerationEquip(1)                                               PLANTd 875
      ENDDO                                                                     PLANTd 876
c              ground-loop heat-exchangers                                      PLANTd 877
      DO  Neq=1,Ngl                                                             PLANTd 878
        Jgl = Igl + (Neq-1)*Lgl                                                 PLANTd 879
c              loop that equipment supplies                                     PLANTd 880
        Jlp = <gl:LOOP>                                                         PLANTd 881
        IF (<gl:HX-PUMP> .EQ. 0)  THEN                                          PLANTd 882
c              no attached pump - primary loop must absorb head                 PLANTd 883
          <lp;SUP-SIDE_HEAD> = MAX(<lp;SUP-SIDE_HEAD>,                          PLANTd 884
     &                               <gl:HX-HEAD>)                              PLANTd 885
          <lp;SUP-SIDE_STAT> = MAX(<lp;SUP-SIDE_STAT>,                          PLANTd 886
     &                               <gl:HX-STATIC>)                            PLANTd 887
        ELSE                                                                    PLANTd 888
          Jpm = <gl:HX-PUMP>                                                    PLANTd 889
          <pm;EQUIP_CTRL>  = <gl:HX-CTRL>                                       PLANTd 890
          <pm;EQUIP_HEAD>  = <gl:HX-HEAD>                                       PLANTd 891
          <pm;STATIC_HEAD> = <gl:HX-STATIC>                                     PLANTd 892
        ENDIF                                                                   PLANTd 893
      ENDDO                                                                     PLANTd 894
c              Thermal storage                                                  ERV    166
      DO  Neq=1,Ntk                                                             ERV    167
        Jtk = Itk + (Neq-1)*Ltk                                                 ERV    168
c              loop that equipment demands from                                 ERV    169
        IF (<tk:MAX-CHRG-RATE> .NE. UNFILD)  THEN                               ERV    170
          Jlp      = <tk:CHRG-LOOP>                                             ERV    171
          Qchrg    = ABS(<tk:MAX-CHRG-RATE>) * 1.E6                             ERV    172
          GPMchrg  = ABS(Qchrg / (<lp;BTUH/GPM-F>*<lp:DESIGN-DT>))              ERV    173
          <lp;GPM> = MAX(<lp;GPM>, GPMchrg)                                     ERV    174
          IF (<tk:TYPE> .EQ. 2  .OR.  <tk:TYPE> .EQ. 8)  THEN                   ERV    175
            <lp;COIL_HEAT> = MIN(<lp;COIL_HEAT>, -Qchrg)                        ERV    176
          ELSE                                                                  ERV    177
            <lp;COIL_COOL> = MAX(<lp;COIL_COOL>, Qchrg)                         ERV    178
          ENDIF                                                                 ERV    179
        ENDIF                                                                   ERV    180
        IF (<tk:MAX-DCHRG-RAT> .NE. UNFILD)  THEN                               ERV    181
          Jlp      = <tk:DCHRG-LOOP>                                            ERV    182
          Qdchrg   = ABS(<tk:MAX-DCHRG-RAT>) * 1.E6                             ERV    183
          IF (<tk:TYPE> .EQ. 2  .OR.  <tk:TYPE> .EQ. 8)  THEN                   ERV    184
            <lp;PRIMARY_HCAP> = <lp;PRIMARY_HCAP> - Qdchrg                      ERV    185
          ELSE                                                                  ERV    186
            <lp;PRIMARY_CCAP> = <lp;PRIMARY_CCAP> + Qdchrg                      ERV    187
          ENDIF                                                                 ERV    188
        ENDIF                                                                   ERV    189
      ENDDO                                                                     ERV    190
c              steam meters                                                     PLANTd 895
      DO  Neq=1,Nsm                                                             PLANTd 896
        Jsm = Ism + (Neq-1)*Lsm                                                 PLANTd 897
c              loop that equipment supplies                                     PLANTd 898
        Jlp = <sm:LOOP>                                                         PLANTd 899
c              pick up size and flow only if specified                          PLANTd 900
        IF (<sm:CAP> .NE. 0.)  THEN                                             PLANTd 901
c              meter size should be a positive number, and in Btu               PLANTd 902
          <sm:CAP> = ABS(<sm:CAP>*1.E6)                                         PLANTd 903
c              increment loop capacity                                          PLANTd 904
          <lp;PRIMARY_HCAP> = <lp;PRIMARY_HCAP> + <sm:CAP>                      PLANTd 905
        ENDIF                                                                   PLANTd 906
c              no attached pump - primary loop must absorb head                 PLANTd 907
        <lp;SUP-SIDE_HEAD> = MAX(<lp;SUP-SIDE_HEAD>,                            PLANTd 908
     &                             <sm:HX-HEAD>)                                PLANTd 909
        <lp;SUP-SIDE_STAT> = MAX(<lp;SUP-SIDE_STAT>,                            PLANTd 910
     &                             <sm:HX-STATIC>)                              PLANTd 911
      ENDDO                                                                     PLANTd 912
c              CHW meters                                                       PLANTd 913
      DO  Neq=1,Ncm                                                             PLANTd 914
        Jcm = Icm + (Neq-1)*Lcm                                                 PLANTd 915
c              loop that equipment supplies                                     PLANTd 916
        Jlp = <cm:LOOP>                                                         PLANTd 917
c              pick up size and flow only if specified                          PLANTd 918
        IF (<cm:CAP> .NE. 0.)  THEN                                             PLANTd 919
c              meter size should be a positive number, and in Btu               PLANTd 920
          <cm:CAP> = ABS(<cm:CAP>*1.E6)                                         PLANTd 921
c              increment loop capacity                                          PLANTd 922
          <lp;PRIMARY_HCAP> = <lp;PRIMARY_HCAP> + <cm:CAP>                      PLANTd 923
        ENDIF                                                                   PLANTd 924
c              no attached pump - primary loop must absorb head                 PLANTd 925
        <lp;SUP-SIDE_HEAD> = MAX(<lp;SUP-SIDE_HEAD>,                            PLANTd 926
     &                             <cm:HX-HEAD>)                                PLANTd 927
        <lp;SUP-SIDE_STAT> = MAX(<lp;SUP-SIDE_STAT>,                            PLANTd 928
     &                             <cm:HX-STATIC>)                              PLANTd 929
      ENDDO                                                                     PLANTd 930
c                                                                               PLANTd 931
c                                                                               PLANTd 932
c============= LOOP SIZING CALCULATIONS ======================================= PLANTd 933
c              Size the loops, pumps and primary equipment.  First,             PLANTd 934
c              secondary loops along with any secondary pumps, then             PLANTd 935
c              primary loops, primary pumps, and primary equipment.             PLANTd 936
c                                                                               PLANTd 937
c              CHILLED WATER LOOPS                                              PLANTd 938
      IF (Nloop(CHW,1) .GT. 0)  THEN                                            PLANTd 939
c              this loop type exists                                            PLANTd 940
        IF (Nloop(CHW,2) .GT. 0)  THEN                                          PLANTd 941
c              this loop type has secondary loops                               PLANTd 942
          SubType = SECONDARY                                                   PLANTd 943
        ELSE                                                                    PLANTd 944
c              this loop type has only primary loops                            PLANTd 945
          SubType = PRIMARY                                                     PLANTd 946
        ENDIF                                                                   PLANTd 947
  100   DO  NL=1,Nlp                                                            PLANTd 948
          Jlp = Ilp + (NL-1)*Llp                                                PLANTd 949
          IF (<lp:TYPE> .EQ. CHW .AND. <lp:SUBTYPE> .EQ. SubType) THEN          PLANTd 950
c              process load                                                     PLANTd 951
            NumProcess = <lp;NumProcess>                                        Proces  53
            DO  II=1,NumProcess                                                 Proces  54
              IF (<lp:PROCESS-LOAD> .NE. 0.)  THEN                              Proces  55
                IF (<lp:PROC-LOAD-SCH> .GT. 0)  THEN                            Proces  56
                  CALL SCHMNX(<lp:PROC-LOAD-SCH>, SchMax,SchMin)                -045d    1
                ELSE                                                            Proces  59
                  SchMax = 1.0                                                  Proces  60
                ENDIF                                                           Proces  61
                <lp;COIL_COOL> = <lp;COIL_COOL>+<lp:PROCESS-LOAD>*SchMax        Proces  62
                IF (<lp:PROCESS-GPM> .EQ. 0.)                                   Proces  63
     &            <lp:PROCESS-GPM> = <lp:PROCESS-LOAD>                          Proces  64
     &                             / (<lp;BTUH/GPM-F>*<lp:PROC-LOAD-DT>)        Proces  65
                <lp;GPM> = <lp;GPM> + <lp:PROCESS-GPM>*SchMax                   Proces  66
              ENDIF                                                             Proces  67
            ENDDO  ! NumProcess                                                 Proces  68
c              setup the loop                                                   PLANTd 965
            CALL LOOPdes                                                        PLANTd 966
            IF (IwinReturn .ne. 0)  RETURN                                      PLANTd 967
          ENDIF                                                                 PLANTd 968
        ENDDO                                                                   PLANTd 969
c              if secondary loops were just simulated, repeat for               PLANTd 970
c              primary loops                                                    PLANTd 971
        IF (SubType .EQ. SECONDARY)  THEN                                       PLANTd 972
          SubType = PRIMARY                                                     PLANTd 973
          GOTO 100                                                              PLANTd 974
        ENDIF                                                                   PLANTd 975
      ENDIF    ! CHW loops                                                      PLANTd 976
c                                                                               PLANTd 977
c              2-PIPE LOOPS                                                     PLANTd 978
      IF (Nloop(PIPE2,1) .GT. 0)  THEN                                          PLANTd 979
c              this loop type exists                                            PLANTd 980
        IF (Nloop(PIPE2,2) .GT. 0)  THEN                                        PLANTd 981
c              this loop type has secondary loops                               PLANTd 982
          SubType = SECONDARY                                                   PLANTd 983
        ELSE                                                                    PLANTd 984
c              this loop type has only primary loops                            PLANTd 985
          SubType = PRIMARY                                                     PLANTd 986
        ENDIF                                                                   PLANTd 987
  200   DO  NL=1,Nlp                                                            PLANTd 988
          Jlp = Ilp + (NL-1)*Llp                                                PLANTd 989
          IF (<lp:TYPE> .EQ. PIPE2  .AND.  <lp:SUBTYPE> .EQ. SubType)           PLANTd 990
     &                                                              THEN        PLANTd 991
c              setup the loop                                                   PLANTd 999
            CALL LOOPdes                                                        PLANTd1000
            IF (IwinReturn .ne. 0)  RETURN                                      PLANTd1001
          ENDIF                                                                 PLANTd1002
        ENDDO                                                                   PLANTd1003
c              if secondary loops were just simulated, repeat for               PLANTd1004
c              primary loops                                                    PLANTd1005
        IF (SubType .EQ. SECONDARY)  THEN                                       PLANTd1006
          SubType = PRIMARY                                                     PLANTd1007
          GOTO 200                                                              PLANTd1008
        ENDIF                                                                   PLANTd1009
      ENDIF    ! 2-pipe loops                                                   PLANTd1010
c                                                                               PLANTd1011
c              CHILLER EQUIPMENT                                                PLANTd1012
c              Size cooling-only chillers now so that heat/condenser            ChlrHP 779
c              loads can be incorporated into HW, WLHP and CW loops             ChlrHP 780
      DO  Neq=1,Nch                                                             ChlrHP 781
c              pointer to this chiller's data                                   ChlrHP 782
        Jch = Ich + (Neq-1)*Lch                                                 ChlrHP 783
        SELECT CASE (<ch:ALGORITHM>)                                            ChlrHP 784
          CASE (101)         ! Centrifugal/reciprocating                        ChlrHP 785
            CALL Chiller_Design_1                                               ChlrHP 786
          CASE (102)         ! unused                                           ChlrHP 787
          CASE (103)         ! Absorption (hot-water/steam)                     ChlrHP 788
            CALL Chiller_Design_1                                               ChlrHP 789
          CASE (104)         ! Gas chiller/heater                               ChlrHP 790
            CYCLE                                                               ChlrHP 791
          CASE (105)         ! Engine driven                                    ChlrHP 792
            CALL Chiller_Design_1                                               ChlrHP 793
          CASE (106)         ! Heat-pump                                        ChlrHP 794
            CALL Chiller_Design_1                                               ChlrHP 795
          CASE (107)         ! Loop-to-loop heat-pump                           ChlrHP 796
            CYCLE                                                               ChlrHP 797
          CASE (108)         ! Free Cooling                                     FreeCl  66
            CALL Chiller_Design_1(1)                                            FreeCl  67
        END SELECT                                                              ChlrHP 798
        IF( IwinReturn .ne. 0 )  RETURN                                         ChlrHP 799
      ENDDO                                                                     ChlrHP 800
c                                                                               PLANTd1032
c              HW LOOPS                                                         PLANTd1033
      IF (Nloop(HW,1) .GT. 0)  THEN                                             PLANTd1034
c              this loop type exists                                            PLANTd1035
        IF (Nloop(HW,2) .GT. 0)  THEN                                           PLANTd1036
c              this loop type has secondary loops                               PLANTd1037
          SubType = SECONDARY                                                   PLANTd1038
        ELSE                                                                    PLANTd1039
c              this loop type has only primary loops                            PLANTd1040
          SubType = PRIMARY                                                     PLANTd1041
        ENDIF                                                                   PLANTd1042
  400   DO  NL=1,Nlp                                                            PLANTd1043
          Jlp = Ilp + (NL-1)*Llp                                                PLANTd1044
          IF (<lp:TYPE> .EQ. HW .AND. <lp:SUBTYPE> .EQ. SubType)  THEN          PLANTd1045
c              process load                                                     PLANTd1046
            NumProcess = <lp;NumProcess>                                        Proces  69
            DO  II=1,NumProcess                                                 Proces  70
              IF (<lp:PROCESS-LOAD> .NE. 0.)  THEN                              Proces  71
                IF (<lp:PROC-LOAD-SCH> .GT. 0)  THEN                            Proces  72
                  CALL SCHMNX(<lp:PROC-LOAD-SCH>, SchMax,SchMin)                -045d    2
                ELSE                                                            Proces  75
                  SchMax = 1.0                                                  Proces  76
                ENDIF                                                           Proces  77
                <lp;COIL_HEAT> = <lp;COIL_HEAT>+<lp:PROCESS-LOAD>*SchMax        Proces  78
                IF (<lp:PROCESS-GPM> .EQ. 0.)                                   Proces  79
     &            <lp:PROCESS-GPM> = <lp:PROCESS-LOAD>                          Proces  80
     &                             / (<lp;BTUH/GPM-F>*<lp:PROC-LOAD-DT>)        Proces  81
                <lp;GPM> = <lp;GPM> + <lp:PROCESS-GPM>*SchMax                   Proces  82
              ENDIF                                                             Proces  83
            ENDDO  ! NumProcess                                                 Proces  84
c              setup the loop                                                   PLANTd1060
            CALL LOOPdes                                                        PLANTd1061
            IF (IwinReturn .ne. 0)  RETURN                                      PLANTd1062
          ENDIF                                                                 PLANTd1063
        ENDDO                                                                   PLANTd1064
c              if secondary loops were just simulated, repeat for               PLANTd1065
c              primary loops                                                    PLANTd1066
        IF (SubType .EQ. SECONDARY)  THEN                                       PLANTd1067
          SubType = PRIMARY                                                     PLANTd1068
          GOTO 400                                                              PLANTd1069
        ENDIF                                                                   PLANTd1070
      ENDIF    ! end of hw design calcs                                         PLANTd1071
c                                                                               ChlrHP 801
c              CHILLER/HEATERS                                                  ChlrHP 802
c              Size chillers that can also actively heat so that                ChlrHP 803
c              loads can be incorporated into WLHP and CW loops                 ChlrHP 804
      DO  Neq=1,Nch                                                             ChlrHP 805
c              pointer to this chiller's data                                   ChlrHP 806
        Jch = Ich + (Neq-1)*Lch                                                 ChlrHP 807
        SELECT CASE (<ch:ALGORITHM>)                                            ChlrHP 808
          CASE (101)         ! Centrifugal/reciprocating                        ChlrHP 809
            CYCLE                                                               ChlrHP 810
          CASE (102)         ! unused                                           ChlrHP 811
          CASE (103)         ! Absorption (hot-water/steam)                     ChlrHP 812
            CYCLE                                                               ChlrHP 813
          CASE (104)         ! Gas chiller/heater                               ChlrHP 814
            CALL Chiller_Design_1                                               ChlrHP 815
          CASE (105)         ! Engine driven                                    ChlrHP 816
            CYCLE                                                               ChlrHP 817
          CASE (106)         ! Heat-pump                                        ChlrHP 818
            CYCLE                                                               ChlrHP 819
          CASE (107)         ! Loop-to-loop heat-pump                           ChlrHP 820
            CALL Chiller_Design_1                                               ChlrHP 821
        END SELECT                                                              ChlrHP 822
        IF( IwinReturn .ne. 0 )  RETURN                                         ChlrHP 823
      ENDDO                                                                     ChlrHP 824
c                                                                               PLANTd1072
c              WLHP LOOPS                                                       PLANTd1073
      IF (Nloop(WLHP,1) .GT. 0)  THEN                                           PLANTd1074
c              this loop type exists                                            PLANTd1075
        IF (Nloop(WLHP,2) .GT. 0)  THEN                                         PLANTd1076
c              this loop type has secondary loops                               PLANTd1077
          SubType = SECONDARY                                                   PLANTd1078
        ELSE                                                                    PLANTd1079
c              this loop type has only primary loops                            PLANTd1080
          SubType = PRIMARY                                                     PLANTd1081
        ENDIF                                                                   PLANTd1082
  700   DO  NL=1,Nlp                                                            PLANTd1083
          Jlp = Ilp + (NL-1)*Llp                                                PLANTd1084
          IF (<lp:TYPE> .EQ. WLHP  .AND.  <lp:SUBTYPE> .EQ. SubType)            PLANTd1085
     &                                                              THEN        PLANTd1086
c              process load - load can be either positive or negative           PLANTd1087
            NumProcess = <lp;NumProcess>                                        Proces  85
            DO  II=1,NumProcess                                                 Proces  86
              IF (<lp:PROCESS-LOAD> .NE. 0.)  THEN                              Proces  87
                IF (<lp:PROC-LOAD-SCH> .GT. 0)  THEN                            Proces  88
                  CALL SCHMNX(<lp:PROC-LOAD-SCH>, SchMax,SchMin)                -045d    3
                ELSE                                                            Proces  91
                  SchMax = 1.0                                                  Proces  92
                ENDIF                                                           Proces  93
                IF (<lp:PROCESS-LOAD> .LT. 0.)  THEN                            Proces  94
                  <lp;COIL_HEAT> = <lp;COIL_HEAT>                               Proces  95
     &                                        + <lp:PROCESS-LOAD>*SchMax        Proces  96
                ELSE                                                            Proces  97
                  <lp;COIL_COOL> = <lp;COIL_COOL>                               Proces  98
     &                                        + <lp:PROCESS-LOAD>*SchMax        Proces  99
                ENDIF                                                           Proces 100
                IF (<lp:PROCESS-GPM> .EQ. 0.)                                   Proces 101
     &            <lp:PROCESS-GPM> = ABS(<lp:PROCESS-LOAD>                      Proces 102
     &                            / (<lp;BTUH/GPM-F>*<lp:PROC-LOAD-DT>))        Proces 103
                <lp;GPM> = <lp;GPM> + <lp:PROCESS-GPM>*SchMax                   Proces 104
              ENDIF                                                             Proces 105
            ENDDO  ! NumProcess                                                 Proces 106
c              setup the loop                                                   PLANTd1105
            CALL LOOPdes                                                        PLANTd1106
c              loop capacity ratios are always 1.0 for this type loop           Proces 107
            <lp;HCAP_RATIO> = 1.                                                Proces 108
            <lp;CCAP_RATIO> = 1.                                                Proces 109
            IF (IwinReturn .ne. 0)  RETURN                                      PLANTd1107
c              initialize start condition                                       PLANTd1108
            WLHPoff = .TRUE.                                                    PLANTd1109
c              now that the condenser loop head is known, setup any             ChlrHP 825
c              attached chiller condenser pumps for LAKE/WELL loops             ChlrHP 826
            IF (<lp:/WELLFLAG/> .GT. 0  .AND.                                   ChlrHP 827
     &                                  <lp;NUM_DEM_PUMPS> .GT. 0)  THEN        ChlrHP 828
              DO  Neq=1,Nch                                                     ChlrHP 829
c              pointer to this chiller's data                                   ChlrHP 830
                Jch = Ich + (Neq-1)*Lch                                         ChlrHP 831
                IF (<ch:CW-LOOP> .EQ. Jlp)  THEN                                ChlrHP 832
                  IF (<ch:CW-PUMP> .GT. 0)  THEN                                ChlrHP 833
                    Jpm  = <ch:CW-PUMP>                                         ChlrHP 834
                    CALL PUMPdes(<ch;DES_CW_GPM>)                               ChlrHP 835
c              adjust condenser loop load by pump heat                          ChlrHP 836
                    <lp;DES_CCAP> = <lp;DES_CCAP> + Qpump                       ChlrHP 837
c              store design variables for use in pump calcs                     ChlrHP 838
                    <pm;MIN_GPM>  = <ch:CW-MIN-GPM>                             ChlrHP 839
                  ELSE                                                          ChlrHP 840
c              chiller must have a condenser pump since the loop does           ChlrHP 841
c              not have a pump                                                  ChlrHP 842
                    CALL MSGSIM(-1,II,II,II,II)                                 ChlrHP 843
                    WRITE (IOUTPT,9105)  (<ch:NAME>,II=1,8),                    ChlrHP 844
     &                                   (<lp:NAME>,II=1,8)                     ChlrHP 845
                    IFLAG = 1                                                   ChlrHP 846
                  ENDIF                                                         ChlrHP 847
                ENDIF                                                           ChlrHP 848
              ENDDO                                                             ChlrHP 849
c              Recalculate condenser loop design temperature drop               ChlrHP 850
c              including pump heat just calculated                              ChlrHP 851
              <lp:DESIGN-DT> =                                                  ChlrHP 852
     &                  <lp;DES_CCAP> / (<lp;BTUH/GPM-F>*<lp;GPM>)              ChlrHP 853
            ENDIF                                                               ChlrHP 854
c              end of condenser loop design calcs                               ChlrHP 855
          ENDIF                                                                 PLANTd1110
        ENDDO                                                                   PLANTd1111
c              if secondary loops were just simulated, repeat for               PLANTd1112
c              primary loops                                                    PLANTd1113
        IF (SubType .EQ. SECONDARY)  THEN                                       PLANTd1114
          SubType = PRIMARY                                                     PLANTd1115
          GOTO 700                                                              PLANTd1116
        ENDIF                                                                   PLANTd1117
      ENDIF    ! end of wlhp design calcs                                       PLANTd1118
c                                                                               PLANTd1119
c              DOMESTIC HOT WATER LOOPS                                         PLANTd1120
      IF (Nloop(DHW,1) .GT. 0)  THEN                                            PLANTd1121
c              this loop type exists                                            PLANTd1122
        DO  NL=1,Nlp                                                            -045b   34
          Jlp = Ilp + (NL-1)*Llp                                                -045b   35
          IF (<lp:TYPE> .ne. DHW  .or.                                          -045b   36
     &                            <lp:SUBTYPE> .ne. PRIMARY)  Cycle             -045b   37
c              Design DHW loop flows and loads. First, find the coldest         -045b   38
c              inlet water temperature                                          -045b   39
          IF (<lp:DHW-INLET-SCH> .ne. 0)  THEN                                  -047k   25
            CALL SCHMNX(<lp:DHW-INLET-SCH>,TinletMax,TinletMin)                 -045b   41
          ELSEIF (<lp:DHW-INLET-T> .NE. UNFILD) THEN                            -045b   42
            TinletMin = <lp:DHW-INLET-T>                                        -045b   43
          ELSE                                                                  -045b   44
c              default to the coldest ground temperature                        -045b   45
            TinletMin = 999.                                                    -045b   46
            DO IMO=1,12                                                         -045b   47
              IF (GTEMP(IMO) .NE. UNFILD)                                       -045b   48
     &          TinletMin = MIN(TinletMin,GTEMP(IMO))                           -045b   49
            ENDDO                                                               -045b   50
c              convert from Rankin                                              -045b   51
            TinletMin = TinletMin-460.                                          -045b   52
          ENDIF                                                                 -045b   53
          <lp;DW_DES_INLT_T> = TinletMin                                        -045b   54
c              Next, get the hottest outlet temperature                         -045b   55
          IF (<lp:HT-SETPT-SCH> .ne. 0)  THEN                                   -047k   26
            CALL SCHMNX(<lp:HT-SETPT-SCH>,ToutletMax,ToutletMin)                -045b   57
          ELSE                                                                  -045b   58
            ToutletMax = <lp:DESIGN-HEAT-T>                                     -045b   59
          ENDIF                                                                 -045b   60
c              error if inlet hotter than outlet                                -045b   61
          IF (TinletMin .GT. ToutletMax)  THEN                                  -045b   62
            CALL MSGSIM(-1,II,II,II,II)                                         -045b   63
            WRITE (IOUTPT,9113)  (<lp:NAME>,II=1,8),                            -045b   64
     &                           TinletMin, ToutletMax                          -045b   65
            call MessageBox( NULL, 'DHW has hotter inlet than outlet -'         -045b   66
     &        //' ABORTING'//char(0),'LOOPd Errors'//char(0), MB_OK             -045b   67
     &        + MB_ICONSTOP + MB_TASKMODAL )                                    -045b   68
            RETURN                                                              -045b   69
          ENDIF                                                                 -045b   70
          IF (<lp;NUM_2ND_LOOPS> .ne. 0)  THEN                                  -047k   27
c              this loop type has secondary loops                               -045b   72
            SubType = SECONDARY                                                 -045b   73
            L2      = 1                    ! secondary loop index               -045b   74
            Jlp1    = Jlp                  ! primary loop ptr                   -045b   75
            Jlp     = <lp;PTR_2ND_LOOPS>   ! secondary loop ptr                 -045b   76
          ELSE                                                                  -045b   77
c              this loop type has only primary loops                            -045b   78
            SubType = PRIMARY                                                   -045b   79
          ENDIF                                                                 -045b   80
c              DHW end-use flows - note that lp;DES_GPMdhw is used for          -045b   81
c              end-uses where the fluid goes down the drain, vs.                -045b   82
c              lp;gpm for coil demands where the fluid is returned              -045b   83
  800     NumProcess = <lp;NumProcess>                                          -045b   84
          DO  II=1,NumProcess                                                   -045b   85
            IF (<lp:PROCESS-GPM> .eq. 0.)  Cycle                                -045b   86
            GPMprocess = <lp:PROCESS-GPM>                                       -045b   87
c              find maximum flow                                                -045b   88
            IF (<lp:PROC-LOAD-SCH> .ne. 0)  THEN                                -047k   28
              Call SCHMNX(<lp:PROC-LOAD-SCH>,SchMax,SchMin)                     -045b   90
              GPMprocess = GPMprocess * SchMax                                  -045b   91
            ENDIF                                                               -045b   92
c                  if a mixing temperature is specified, reduce flow            -045b   93
            IF (<lp:PROCESS-T> .ne. Unfild) THEN                                -045b   94
              Rmix = (<lp:PROCESS-T>-TinletMin) / (ToutletMax-TinletMin)        -045b   95
              GPMprocess = GPMprocess * Max(0., Min(1., Rmix))                  -045b   96
            ENDIF                                                               -045b   97
            <lp;DES_GPMdhw> = <lp;DES_GPMdhw> + GPMprocess                      -045b   98
            Qprocess        = <lp;BTUH/GPM-F> * GPMprocess                      -045b   99
     &                      * Min(0., TinletMin-ToutletMax)                     -045b  100
            <lp;COIL_HEAT>  = <lp;COIL_HEAT> + Qprocess                         -045b  101
          ENDDO  ! NumProcess                                                   -045b  102
c              setup the loop                                                   -045b  103
          Call LOOPdes                                                          -045b  104
          IF (IwinReturn .ne. 0)  Return                                        -045b  105
c              if secondary loops were just simulated, repeat for               -045b  106
c              primary loop                                                     -045b  107
          IF (SubType .eq. SECONDARY) THEN                                      -045b  108
            Jlp = Jlp1                  ! primary loop ptr                      -045b  109
            IF (L2 .eq. <lp;NUM_2ND_LOOPS>) THEN                                -045b  110
              SubType = PRIMARY                                                 -045b  111
            ELSE                                                                -045b  112
              L2  = L2 + 1                                                      -045b  113
              Jlp = <lp;PTR_2ND_LOOPS>  ! secondary loop ptr                    -045b  114
            ENDIF                                                               -045b  115
            GOTO 800                                                            -045b  116
          ENDIF                                                                 -045b  117
        ENDDO  ! Nlp DHW                                                        -045b  118
      ENDIF    ! DHW loops                                                      PLANTd1165
c                                                                               PLANTd1166
c              CONDENSER WATER LOOPS                                            PLANTd1167
      IF (Nloop(CW,1) .GT. 0)  THEN                                             PLANTd1168
c              this loop type exists                                            PLANTd1169
        IF (Nloop(CW,2) .GT. 0)  THEN                                           PLANTd1170
c              this loop type has secondary loops                               PLANTd1171
          SubType = SECONDARY                                                   PLANTd1172
        ELSE                                                                    PLANTd1173
c              this loop type has only primary loops                            PLANTd1174
          SubType = PRIMARY                                                     PLANTd1175
        ENDIF                                                                   PLANTd1176
  900   DO  NL=1,Nlp                                                            PLANTd1177
          Jlp = Ilp + (NL-1)*Llp                                                PLANTd1178
          IF (<lp:TYPE> .EQ. CW  .AND.  <lp:SUBTYPE> .EQ. SubType)  THEN        PLANTd1179
c              process load                                                     PLANTd1180
            NumProcess = <lp;NumProcess>                                        Proces 124
            DO  II=1,NumProcess                                                 Proces 125
              IF (<lp:PROCESS-LOAD> .NE. 0.)  THEN                              Proces 126
                IF (<lp:PROC-LOAD-SCH> .GT. 0)  THEN                            Proces 127
                  CALL SCHMNX(<lp:PROC-LOAD-SCH>, SchMax,SchMin)                -045d    4
                ELSE                                                            Proces 130
                  SchMax = 1.0                                                  Proces 131
                ENDIF                                                           Proces 132
                <lp;COIL_COOL> = <lp;COIL_COOL>+<lp:PROCESS-LOAD>*SchMax        Proces 133
                IF (<lp:PROCESS-GPM> .EQ. 0.)                                   Proces 134
     &            <lp:PROCESS-GPM> = <lp:PROCESS-LOAD>                          Proces 135
     &                             / (<lp;BTUH/GPM-F>*<lp:PROC-LOAD-DT>)        Proces 136
                <lp;GPM> = <lp;GPM> + <lp:PROCESS-GPM>*SchMax                   Proces 137
              ENDIF                                                             Proces 138
            ENDDO  ! NumProcess                                                 Proces 139
c              setup the loop                                                   PLANTd1194
            CALL LOOPdes                                                        PLANTd1195
c              loop capacity ratios are always 1.0 for this type loop           Proces 140
            <lp;CCAP_RATIO> = 1.                                                Proces 141
            IF (IwinReturn .ne. 0)  RETURN                                      PLANTd1196
c              now that the condenser loop head is known, setup any             PLANTd1197
c              attached chiller condenser pumps.                                PLANTd1198
            IF (<lp;NUM_DEM_PUMPS> .GT. 0)  THEN                                PLANTd1199
              DO  Neq=1,Nch                                                     PLANTd1200
c              pointer to this chiller's data                                   PLANTd1201
                Jch = Ich + (Neq-1)*Lch                                         PLANTd1202
                IF (<ch:CW-LOOP> .EQ. Jlp)  THEN                                PLANTd1203
                  IF (<ch:CW-PUMP> .GT. 0)  THEN                                PLANTd1204
                    Jpm  = <ch:CW-PUMP>                                         PLANTd1205
                    CALL PUMPdes(<ch;DES_CW_GPM>)                               PLANTd1206
c              adjust condenser loop load by pump heat                          PLANTd1207
                    <lp;DES_CCAP> = <lp;DES_CCAP> + Qpump                       PLANTd1208
c              store design variables for use in pump calcs                     PLANTd1209
                    <pm;MIN_GPM>  = <ch:CW-MIN-GPM>                             PLANTd1210
                  ELSE                                                          PLANTd1211
c              chiller must have a condenser pump since the loop does           PLANTd1212
c              not have a pump                                                  PLANTd1213
                    CALL MSGSIM(-1,II,II,II,II)                                 PLANTd1214
                    WRITE (IOUTPT,9105)  (<ch:NAME>,II=1,8),                    PLANTd1215
     &                                   (<lp:NAME>,II=1,8)                     PLANTd1216
                    IFLAG = 1                                                   PLANTd1217
                  ENDIF                                                         PLANTd1218
                ENDIF                                                           PLANTd1219
              ENDDO                                                             PLANTd1220
c              Recalculate condenser loop design temperature drop               PLANTd1221
c              including pump heat just calculated                              PLANTd1222
              <lp:DESIGN-DT> =                                                  PLANTd1223
     &                  <lp;DES_CCAP> / (<lp;BTUH/GPM-F>*<lp;GPM>)              PLANTd1224
            ENDIF                                                               PLANTd1225
c              end of condenser loop design calcs                               PLANTd1226
          ENDIF                                                                 PLANTd1227
        ENDDO                                                                   PLANTd1228
c              if secondary loops were just simulated, repeat for               PLANTd1229
c              primary loops                                                    PLANTd1230
        IF (SubType .EQ. SECONDARY)  THEN                                       PLANTd1231
          SubType = PRIMARY                                                     PLANTd1232
          GOTO 900                                                              PLANTd1233
        ENDIF                                                                   PLANTd1234
      ENDIF    ! CW loops                                                       PLANTd1235
c                                                                               PLANTd1236
c                                                                               PLANTd1237
c============= PRIMARY EQUIPMENT SIZING ======================================= PLANTd1238
c              Size all primary equipment, except for generators and chillers   PLANTd1239
c              which were already setup                                         PLANTd1240
c                                                                               PLANTd1241
c              BOILERS                                                          PLANTd1242
      DO  Neq=1,Nbl                                                             PLANTd1243
c              pointer to this boiler's data                                    PLANTd1244
        Jbl = Ibl + (Neq-1)*Lbl                                                 PLANTd1245
        Jpe = <bl;Jpe>                                                          PLANTd1246
        SELECT CASE (<pe:ALGORITHM>)                                            PLANTd1247
          CASE (201)         ! Hot water boiler                                 PLANTd1248
            CALL Boiler_Design_1                                                PLANTd1249
          CASE (202)         ! Condensing                                       -045k   10
            CALL Boiler_Design_1                                                -045k   11
        END SELECT                                                              PLANTd1251
        IF( IwinReturn .ne. 0 )  RETURN                                         PLANTd1252
      ENDDO                                                                     PLANTd1253
c                                                                               PLANTd1254
c              DOMESTIC HOT WATER HEATERS                                       PLANTd1255
      DO  Neq=1,Ndw                                                             PLANTd1256
c              pointer to this heater's data                                    PLANTd1257
        Jdw = Idw + (Neq-1)*Ldw                                                 PLANTd1258
        Jpe = <dw;Jpe>                                                          PLANTd1259
        SELECT CASE (<pe:ALGORITHM>)                                            PLANTd1260
          CASE (301,302)     ! Conventional and heat pump                       PLANTd1261
            CALL DW_Design_1                                                    PLANTd1262
          CASE (303)         ! Unused                                           PLANTd1263
        END SELECT                                                              PLANTd1264
        IF( IwinReturn .ne. 0 )  RETURN                                         PLANTd1265
      ENDDO                                                                     PLANTd1266
c                                                                               PLANTd1267
c              HEAT REJECTION EQUIPMENT                                         PLANTd1268
      DO  Neq=1,Ntw                                                             PLANTd1269
c              pointer to this tower's data                                     PLANTd1270
        Jtw = Itw + (Neq-1)*Ltw                                                 PLANTd1271
        Jpe = <tw;Jpe>                                                          PLANTd1272
c              jump to correct tower algorithm                                  PLANTd1273
        SELECT CASE (<pe:ALGORITHM>)                                            PLANTd1274
          CASE (401)         ! Open towers                                      PLANTd1275
            CALL CoolingTwr_1_Design                                            PLANTd1276
          CASE (402)         ! Fluid coolers                                    PLANTd1277
            Call FluidCooler_1_Design                                           PLANTd1278
          CASE (403)         ! Drycoolers                                       PLANTd1279
            Call DryCooler_1_Design                                             PLANTd1280
        END SELECT                                                              PLANTd1281
        IF( IwinReturn .ne. 0 )  RETURN                                         PLANTd1282
      ENDDO                                                                     PLANTd1283
c                                                                               PLANTd1295
c              THERMAL STORAGE COMPONENTS                                       PLANTd1296
      DO  Neq=1,Ntk                                                             PLANTd1297
        Jtk = Itk + (Neq-1)*Ltk                                                 PLANTd1298
        SELECT CASE (<tk:ALGORITHM>)                                            PLANTd1299
        CASE (181)                   ! Cold Btu bucket                          PLANTd1300
          CALL TES_ColdTank_1_Design                                            PLANTd1301
        CASE (281)                   ! Hot Btu bucket                           PLANTd1302
          CALL TES_HotTank_1_Design                                             PLANTd1303
        END SELECT                                                              PLANTd1304
        IF( IwinReturn .ne. 0 )  RETURN                                         PLANTd1305
      ENDDO                                                                     PLANTd1306
c              increment primary loop capacity by discharge rates               PLANTd1307
      DO  Neq=1,Ntk                                                             PLANTd1308
        Jtk = Itk + (Neq-1)*Ltk                                                 PLANTd1309
        Jlp = <tk:DCHRG-LOOP>                                                   PLANTd1310
        SELECT CASE (<tk:ALGORITHM>)                                            PLANTd1311
        CASE (181)                   ! All cold storage                         PLANTd1312
          <lp;PRIMARY_CCAP> = <lp;PRIMARY_CCAP> + <tk:MAX-DCHRG-RAT>            PLANTd1313
        CASE (281)                   ! All hot storage                          PLANTd1314
          <lp;PRIMARY_HCAP> = <lp;PRIMARY_HCAP> + <tk:MAX-DCHRG-RAT>            PLANTd1315
        END SELECT                                                              PLANTd1316
      ENDDO                                                                     PLANTd1317
c                                                                               PLANTd1318
c              GROUND-LOOP HEAT-EXCHANGERS                                      PLANTd1319
      DO  Neq=1,Ngl                                                             PLANTd1320
        DBTYAV   = UNFILD                                                       -044d1   2
c              pointer to this component's data                                 PLANTd1321
        Jgl = Igl + (Neq-1)*Lgl                                                 PLANTd1322
        Jpe = <gl;Jpe>                                                          PLANTd1323
        SELECT CASE (<pe:ALGORITHM>)                                            PLANTd1324
          CASE (491)         ! Scheduled/ground temperature                     PLANTd1325
                 CALL GLHX_Scheduled_Design                                     PLANTd1326
          CASE (492,494)     ! Vertical well field                              -044d  134
c              If vertical-well-new and far field ground temperature            -044d1   3
C              was not specified then caculate it                               -044d1   4
                IF(<pe:ALGORITHM> .EQ. 494) THEN                                -044d1   5
                  IF(<gl:REF-GRND-TEMP> .EQ. UNFILD) THEN                       -044d1   6
                    IF(DBTYAV .EQ. UNFILD) THEN                                 -044d1   7
                      DBTYAV   = 0.0                                            -044d1   8
                      DO IMO=1,12                                               -044d1   9
                        DO IDAY=1,MONLEN(IMO)                                   -044d1  10
                          DO IHR=1,24                                           -044d1  11
                            CALL WEATHI                                         -044d1  12
                            DBTYAV = DBTYAV + DBT                               -044d1  13
                          ENDDO                                                 -044d1  14
                        ENDDO                                                   -044d1  15
                      ENDDO                                                     -044d1  16
                      DBTYAV = DBTYAV/8760.                                     -044d1  17
                      IF(IREPRT(3,34) .EQ. 1) THEN                              -044d1  18
                        WRITE (IOUTPT,9008) DBTYAV                              -044d1  19
                      ENDIF                                                     -044d1  20
                    ENDIF                                                       -044d1  21
                    <gl:REF-GRND-TEMP> = DBTYAV                                 -044d1  22
                  ENDIF                                                         -044d1  23
                  <gl:REF-GRND-TEMP> = <gl:REF-GRND-TEMP> +                     -044d1  24
     $                                 <gl:REF-GRND-ADJ>                        -044d1  25
                ENDIF                                                           -044d1  26
                CALL GLHX_Vertical_Design(1)                                    PLANTd1328
          CASE (493)         ! Horizontal trenches                              PLANTd1329
                CALL GLHX_Horizontal_Design(1)                                  PLANTd1330
        END SELECT                                                              PLANTd1331
        IF( IwinReturn .ne. 0 )  RETURN                                         PLANTd1332
      ENDDO                                                                     PLANTd1333
c                                                                               PLANTd1334
c              STEAM METERS                                                     PLANTd1335
      DO  Neq=1,Nsm                                                             PLANTd1336
c              pointer to this meter's data                                     PLANTd1337
        Jsm = Ism + (Neq-1)*Lsm                                                 PLANTd1338
c              pointer to attached loop                                         PLANTd1339
        Jlp = <sm:LOOP>                                                         PLANTd1340
c              meter capacity (positive value)                                  PLANTd1341
        IF (<sm:CAP> .EQ. 0.)  THEN                                             MeterEU101
          Cap = -<lp;DES_HCAP> * <sm:CAP-RATIO>                                 MeterEU102
        ELSE                                                                    MeterEU103
          Cap = <sm:CAP>                                                        MeterEU104
        ENDIF                                                                   MeterEU105
c              hot water flow                                                   MeterEU106
        GPM = ABS(Cap/(<lp;BTUH/GPM-F>*<lp:DESIGN-DT>))                         MeterEU107
c              total primary loop equipment capacity                            MeterEU108
        <lp;PRIMARY_HCAP> = <lp;PRIMARY_HCAP> - Cap                             MeterEU109
        IF (<sm:CAP> .EQ. 0.)  THEN                                             MeterEU110
c              include interior loads placed directly on meter                  MeterEU111
          Nmisc = <sm;NUM_INT>                                                  MeterEU112
          DO  II=1,Nmisc                                                        MeterEU113
            CALL SCHMNX(<sm:INT-SCH>, SchMax,SchMin)                            -045d    5
            Qmisc = <sm:INT-BTU/HR>*SchMax                                      MeterEU115
            Cap   = Cap + Qmisc                                                 MeterEU116
          ENDDO                                                                 MeterEU117
c              and exterior                                                     MeterEU118
          Nmisc = <sm;NUM_EXT>                                                  MeterEU119
          DO  II=1,Nmisc                                                        MeterEU120
            CALL SCHMNX(<sm:EXT-SCH>, SchMax,SchMin)                            -045d    6
            Qmisc = <sm:EXT-BTU/HR> * SchMax                                    MeterEU122
            Cap   = Cap + Qmisc                                                 MeterEU123
          ENDDO                                                                 MeterEU124
        ENDIF                                                                   MeterEU125
        <sm:CAP> = Cap                                                          MeterEU126
c              save design variables for use in PrimaryEquip                    PLANTd1348
        Jme = Jsm                                                               PLANTd1349
        <me;DES_GPM>    = GPM                                                   PLANTd1350
        <me;DES_HEAD>   = <sm:HX-HEAD>                                          PLANTd1351
        <me;DES_STATIC> = <sm:HX-STATIC>                                        PLANTd1352
c              end of steam meter design calcs                                  PLANTd1353
      ENDDO                                                                     PLANTd1354
c                                                                               PLANTd1355
c              CHILLED-WATER METERS                                             PLANTd1356
      DO  Neq=1,Ncm                                                             PLANTd1357
c              pointer to this meter's data                                     PLANTd1358
        Jcm = Icm + (Neq-1)*Lcm                                                 PLANTd1359
c              pointer to attached loop                                         PLANTd1360
        Jlp = <cm:LOOP>                                                         PLANTd1361
c              meter capacity                                                   PLANTd1362
        IF (<cm:CAP> .EQ. 0.)  THEN                                             MeterEU127
          Cap = <lp;DES_CCAP> * <cm:CAP-RATIO>                                  MeterEU128
        ELSE                                                                    MeterEU129
          Cap = <cm:CAP>                                                        MeterEU130
        ENDIF                                                                   MeterEU131
c              loop flow thru meter HX                                          MeterEU132
        <cm;DES_GPM> = Cap/(<lp;BTUH/GPM-F>*<lp:DESIGN-DT>)                     MeterEU133
c              total primary loop equipment capacity                            MeterEU134
        <lp;PRIMARY_CCAP> = <lp;PRIMARY_CCAP> + Cap                             MeterEU135
        IF (<cm:CAP> .EQ. 0.)  THEN                                             MeterEU136
c              include interior loads placed directly on meter                  MeterEU137
          Nmisc = <cm;NUM_INT>                                                  MeterEU138
          DO  II=1,Nmisc                                                        MeterEU139
            CALL SCHMNX(<cm:INT-SCH>, SchMax,SchMin)                            -045d    7
            Qmisc = <cm:INT-BTU/HR>*SchMax                                      MeterEU141
            Cap   = Cap + Qmisc                                                 MeterEU142
          ENDDO                                                                 MeterEU143
c              and exterior                                                     MeterEU144
          Nmisc = <cm;NUM_EXT>                                                  MeterEU145
          DO  II=1,Nmisc                                                        MeterEU146
            CALL SCHMNX(<cm:EXT-SCH>, SchMax,SchMin)                            -045d    8
            Qmisc = <cm:EXT-BTU/HR> * SchMax                                    MeterEU148
            Cap   = Cap + Qmisc                                                 MeterEU149
          ENDDO                                                                 MeterEU150
        ENDIF                                                                   MeterEU151
        <cm:CAP> = Cap                                                          MeterEU152
c              save design variables for use in PrimaryEquip                    PLANTd1369
        Jme = Jcm                                                               PLANTd1370
        <me;DES_GPM>    = <cm;DES_GPM>                                          PLANTd1371
        <me;DES_HEAD>   = <cm:HX-HEAD>                                          PLANTd1372
        <me;DES_STATIC> = <cm:HX-STATIC>                                        PLANTd1373
c              end of chw meter design calcs                                    PLANTd1374
      ENDDO                                                                     PLANTd1375
c                                                                               PLANTd1376
c                                                                               PLANTd1377
c============= CHECKS ON PRIMARY LOOP EQUIPMENT CAPACITY VS. LOAD ============= PLANTd1378
      DO  NL=1,Nlp                                                              PLANTd1379
        Jlp = Ilp + (NL-1)*Llp                                                  PLANTd1380
        IF (<lp:SUBTYPE> .EQ. PRIMARY                                           PLANTd1381
     &                          .AND.  <lp:TYPE> .NE. Deleted)  THEN            PLANTd1382
          II = 1                                                                Bug40  196
          IF ((<lp:TYPE> .EQ. 2  .OR. <lp:TYPE> .EQ. 4  .OR.                    Bug40  197
     &         <lp:TYPE> .EQ. 7  .OR. <lp:TYPE> .EQ. 8)  .AND.                  Bug40  198
     &        (<lp;COIL_HEAT> .LT. -1.  .OR.  <lp:PROCESS-LOAD> .NE. 0.         Bug40  199
     &                            .OR.  <lp:PROCESS-GPM> .NE. 0.))  THEN        Bug40  200
c              at least one heating device must be attached                     PLANTd1384
c              see if a STEAM-METER is attached to this loop                    -035   135
            NSMatt = 0                                                          -035   136
            DO  Neq=1,Nsm                                                       -035   137
              Jsm = Ism + (Neq-1)*Lsm                                           -035   138
              IF(Jlp .eq. <sm:LOOP>) NSMatt = 1                                 -035   139
            ENDDO                                                               -035   140
            DO  Neq=1,Ntk                                                       ERV    191
              Jtk = Itk + (Neq-1)*Ltk                                           ERV    192
              IF (Jlp .EQ. <tk:DCHRG-LOOP>) NSMatt = 1                          ERV    193
            ENDDO                                                               ERV    194
c              ERROR if no equipment or meter supplies loop                     -035   141
            IF (<lp;HT_NUM_EQUIP> .EQ. 0  .AND.  NSMatt .EQ. 0)  THEN           -035   142
              CALL MSGSIM(-1,II,II,II,II)                                       PLANTd1386
              WRITE (IOUTPT,9108) (<lp:NAME>,II=1,8)                            PLANTd1387
              call MessageBox( NULL, 'Loop has no primary equipment -'          PLANTd1388
     &          //' ABORTING'//char(0),'PLANTdes Errors'//char(0), MB_OK        PLANTd1389
     &          + MB_ICONSTOP + MB_TASKMODAL )                                  PLANTd1390
              RETURN                                                            PLANTd1392
            ENDIF                                                               PLANTd1393
c              if no primary loop capacity, set to very large number            PLANTd1394
            IF (<lp;PRIMARY_HCAP> .EQ. 0.)  <lp;PRIMARY_HCAP> = -1.E10          PLANTd1395
            IF (<lp;PRIMARY_HCAP> .GT.                                          -034    68
     &                       <lp;COIL_HEAT>*0.95+<lp;START_PUMPQ>)  THEN        -034    69
              CALL MSGSIM(-2,II,II,II,II)                                       PLANTd1397
              WRITE (IOUTPT,9102) (<lp:NAME>,II=1,8), <lp;PRIMARY_HCAP>,        PLANTd1398
     &                             <lp;COIL_HEAT>                               PLANTd1399
            ENDIF                                                               PLANTd1400
c              loop capacity ratio for use during startup hours                 PLANTd1401
            IF (<lp;COIL_HEAT> .NE. 0.)  THEN                                   Bug40  201
              <lp;DES_HCAPR> = MIN(0.999,                                       -044e5   3
     &                             <lp;PRIMARY_HCAP>/<lp;COIL_HEAT>)            -044e5   4
            ELSE                                                                Bug40  203
              <lp;DES_HCAPR> = 1.                                               Bug40  204
            ENDIF                                                               Bug40  205
          ENDIF                                                                 PLANTd1403
          II = 1                                                                Bug40  206
          IF ((<lp:TYPE> .EQ. 1  .OR. <lp:TYPE> .EQ. 2  .OR.                    Bug40  207
     &         <lp:TYPE> .EQ. 7  .OR. <lp:TYPE> .EQ. 9)  .AND.                  Bug40  208
     &        (<lp;COIL_COOL> .GT. 1.  .OR.  <lp:PROCESS-LOAD> .NE. 0.          Bug40  209
     &                            .OR.  <lp:PROCESS-GPM> .NE. 0.))  THEN        Bug40  210
c              at least one cooling device must be attached                     PLANTd1405
c              see if a CHW-METER is attached to this loop                      -035   143
            NCMatt = 0                                                          -035   144
            DO  Neq=1,Ncm                                                       -035   145
              Jcm = Icm + (Neq-1)*Lcm                                           -035   146
              IF(Jlp .eq. <cm:LOOP>) NCMatt = 1                                 -035   147
            ENDDO                                                               -035   148
            DO  Neq=1,Ntk                                                       ERV    195
              Jtk = Itk + (Neq-1)*Ltk                                           ERV    196
              IF (Jlp .EQ. <tk:DCHRG-LOOP>) NCMatt = 1                          ERV    197
            ENDDO                                                               ERV    198
c              ERROR if no equipment or meter supplies loop                     -035   149
            IF (<lp;CL_NUM_EQUIP> .EQ. 0  .AND.  NCMatt .EQ. 0)  THEN           -035   150
              CALL MSGSIM(-1,II,II,II,II)                                       PLANTd1407
              WRITE (IOUTPT,9112) (<lp:NAME>,II=1,8)                            PLANTd1408
              call MessageBox( NULL, 'Loop has no primary equipment -'          PLANTd1409
     &          //' ABORTING'//char(0),'PLANTdes Errors'//char(0), MB_OK        PLANTd1410
     &          + MB_ICONSTOP + MB_TASKMODAL )                                  PLANTd1411
              RETURN                                                            PLANTd1413
            ENDIF                                                               PLANTd1414
c              if no primary loop capacity, set to very large number            PLANTd1415
            IF (<lp;PRIMARY_CCAP> .EQ. 0.)  <lp;PRIMARY_CCAP> = 1.E10           PLANTd1416
            IF (<lp;PRIMARY_CCAP> .LT. <lp;COIL_COOL>*0.95)  THEN               PLANTd1417
              CALL MSGSIM(-2,II,II,II,II)                                       PLANTd1418
              WRITE (IOUTPT,9103) (<lp:NAME>,II=1,8), <lp;PRIMARY_CCAP>,        PLANTd1419
     &                             <lp;COIL_COOL>                               PLANTd1420
            ENDIF                                                               PLANTd1421
c              loop capacity ratio for use during startup hours                 PLANTd1422
            IF (<lp;COIL_COOL> .NE. 0.)  THEN                                   Bug40  211
              <lp;DES_CCAPR> = MIN(0.999,                                       -044e5   5
     &                             <lp;PRIMARY_CCAP>/<lp;COIL_COOL>)            -044e5   6
            ELSE                                                                Bug40  213
              <lp;COIL_COOL> = 1.                                               Bug40  214
            ENDIF                                                               Bug40  215
          ENDIF                                                                 PLANTd1424
        ELSEIF (<lp:SUBTYPE> .EQ. SECONDARY)  THEN                              PLANTd1460
c              secondary loop capacity ratio for use during startup hours       PLANTd1461
          IF (<lp;COIL_HEAT> .LT. -1.)                                          PLANTd1462
     &      <lp;DES_HCAPR> = MIN(0.999,  <lp;COIL_HEAT>/<lp;DES_HCAP>)          -044e5   7
          IF (<lp;COIL_COOL> .GT.  1.)                                          PLANTd1465
     &       <lp;DES_CCAPR> = MIN(0.999, <lp;COIL_COOL>/<lp;DES_CCAP>)          -044e5   8
                                                                                -044e5   9
        ENDIF                                                                   PLANTd1468
      ENDDO                                                                     PLANTd1469
c                                                                               PLANTd1470
c              Print design information                                         PLANTd1471
      CALL PlantReports                                                         PLANTd1472
c                                                                               PLANTd1473
      RETURN                                                                    PLANTd1474
c                                                                               PLANTd1475
c              dump formats                                                     PLANTd1476
 9000 FORMAT(' ',8A4                                                            PLANTd1477
     &      / 17X,   ' HEATING  CAPACITY       GPM     DESDT      HEAD'         PLANTd1478
     &      /              25X,    F10.0,    F10.1,    F10.1,     F10.1)        PLANTd1479
 9001 FORMAT(' ',8A4                                                            PLANTd1480
     &      / 17X,   ' PREHEAT  CAPACITY       GPM     DESDT      HEAD'         PLANTd1481
     &      /              25X,    F10.0,    F10.1,    F10.1,     F10.1)        PLANTd1482
 9002 FORMAT(' ',8A4                                                            PLANTd1483
     &      / 17X,   ' COOLING  CAPACITY       GPM     DESDT      HEAD'         PLANTd1484
     &      /              25X,    F10.0,    F10.1,    F10.1,     F10.1)        PLANTd1485
 9003 FORMAT(' ',8A4                                                            PLANTd1486
     &      / 17X,   '    COND  CAPACITY       GPM      HEAD          '         PLANTd1487
     &      /              25X,    F10.0,    F10.1,    F10.1           )        PLANTd1488
 9004 FORMAT(' ',8A4                                                            PLANTd1489
     &      / 17X,   ' WS ECON  CAPACITY   CAP6544      HEAD          '         PLANTd1490
     &      /              25X,    F10.0,    F10.1,    F10.1           )        PLANTd1491
 9005 FORMAT(' ',8A4                                                            PLANTd1492
     &      / 17X,   ' BASEBRD  CAPACITY       GPM     DESDT      HEAD'         PLANTd1493
     &      /              25X,    F10.0,    F10.1,    F10.1,     F10.1)        PLANTd1494
 9006 FORMAT(' ',8A4                                                            PLANTd1495
     &      / 17X,   ' CAPACITY      EVAP        HW        CW     HTREC'        PLANTd1496
     &      /     17X,    F10.0     F10.1     F10.1     F10.1     F10.1)        PLANTd1497
 9007 FORMAT(' ',8A4                                                            PLANTd1498
     &      / 17X,   ' CAPACITY       GPM'                                      PLANTd1499
     &      /     17X,    F10.0     F10.1)                                      PLANTd1500
 9008 FORMAT(1X,'For GLHX vertical wells (new) the average annual DBT',         -044d1  27
     $          ' is ',F6.2)                                                    -044d1  28
c                                                                               PLANTd1501
c              message formats                                                  PLANTd1502
 9100 FORMAT(14X,'Secondary loop: ',8A4,' has a direct'                /        PLANTd1503
     &       14X,'transfer from the primary, but specified with a'     /        PLANTd1504
     &       14X,'different glycol fraction.  Secondary glycol'        /        PLANTd1505
     &       14X,'concentration set to be the same as the primary: ',           PLANTd1506
     &            F5.2                                                 )        PLANTd1507
 9102 FORMAT(14X,'Loop: ',8A4,' heating capacity is smaller'           /        PLANTd1511
     &       14X,'than the secondary demand. Primary=',F10.0           /        PLANTd1512
     &       14X,' Secondary=',F10.0                                   )        PLANTd1513
 9103 FORMAT(14X,'Loop: ',8A4,' cooling capacity is smaller'           /        PLANTd1514
     &       14X,'than the secondary demand. Primary=',F10.0           /        PLANTd1515
     &       14X,'Secondary=',F10.0                                    )        PLANTd1516
 9104 FORMAT(14X,8A4,' must have a pump if'                            /        PLANTd1517
     &       14X,'loop: ',8A4,' does not.'                             )        PLANTd1518
 9105 FORMAT(14X,'Chiller: ',8A4,' must have a condenser'              /        PLANTd1519
     &       14X,'pump since loop: ',8A4,' does not, and'              /        PLANTd1520
     &       14X,'the other chillers do.'                              )        PLANTd1521
 9106 FORMAT(14X,'UNUSED')                                                      PLANTd1522
 9107 FORMAT(14X,'Plant equipment: ',8A4,' has a different'            /        PLANTd1523
     &       14X,'pressure drop on loop: ',8A4,' than the'             /        PLANTd1524
     &       14X,'other equipment.  This is unusual unless the loop'   /        PLANTd1525
     &       14X,'uses flow meters or other dynamic flow control'      /        PLANTd1526
     &       14X,'devices to allocate the flow on an hourly basis to'  /        PLANTd1527
     &       14X,'the active equipment.'                               )        PLANTd1528
 9108 FORMAT(14X,'Loop: ',8a4,' has no attached primary'               /        PLANTd1529
     &       14X,'heating equipment.'                                  )        PLANTd1530
 9109 FORMAT(14X,'Chiller: ',8a4,' has heat recovery attached'         /        PLANTd1531
     &       14X,'to loop: ',8a4,' which is not a primary loop.'       )        PLANTd1532
 9110 FORMAT(14X,'DHW Loop: ',8a4,' cannot use a'                      /        PLANTd1533
     &       14X,'LOAD-RESET temperature control strategy.'            /        PLANTd1534
     &       14X,'Changed to FIXED.'                                   )        PLANTd1535
 9112 FORMAT(14X,'Loop: ',8a4,' has no attached primary'               /        PLANTd1539
     &       14X,'cooling equipment.'                                  )        PLANTd1540
 9113 FORMAT(14X,'DHW Loop: ',8A4,' has a hotter '                     /        -045b  119
     &       14X,'design inlet temperature than outlet temperature.'   /        -045b  120
     &       14X,'Inlet: ',F5.1,'   Outlet: ',F5.1                     )        -045b  121
c                                                                               PLANTd1541
c                                                                               PLANTd1542
      END                                                                       PLANTd1543
      SUBROUTINE PLANTi                                                         PLANTi   2
c                                                                               PLANTi   3
c              Beginning of hour central plant calculations.                    PLANTi   4
c                                                                               PLANTi   5
c              LOOP_CTRL_MODE = -1  off                                         PLANTi   6
c                                0  floating                                    PLANTi   7
c                                1  heating mode                                PLANTi   8
c                                2  cooling mode                                PLANTi   9
c                                                                               PLANTi  10
c                                                                               PLANTi  11
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /LOOP  / Nloop(16,2), NextType(40), NLP2,                         -41a     1
     &                 WLHPoff, RealCall, RegenFlag, Sim2x, LoopSimCount        ChlrHP   2
      LOGICAL          WLHPoff, RealCall, RegenFlag, Sim2x                      ChlrHP   3
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PTRSYS/ nzone , iz    , nczd  , zp2 ,         mtw  ,             -045a    1
     $                 nsys  , is    , nss   , nsp ,  ns   , icode,             HR      11
     $                 nsz   , isz   , nzd   , zp1 ,  nz   ,                    HR      12
     $                 nspace, lpr   ,                                          HR      13
     $                 nattch, iatt  ,                                          HR      14
     $                 P2, IDAYHR, IDBWBT,                                      HR      15
     $                 IRPPLT, IRPSUM, IRPSYS, IRPZON, MR1, MR2                 HR      16
      INTEGER          ZP1, ZP2, P2                                             /PTRSYS/14
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /TWRDAT/ TWRload,TCAP,TWRrej,CWgpm,TWRgpm,TWRsupply,              /TWRDAT/ 2
     &                 TWRset,Ttower,RANGE,APP,twr1FRA,GPMra,GPMcap,            /TWRDAT/ 3
     &                 GPMcell,NumCells,MinCells,MaxCells,Ttop,GPMtop,          /TWRDAT/ 4
     &                 Tbot,GPMbot,CFMra,FankWr,FankW,TWRaux,QpanLoss,          -034     2
     &                 QcoilLoss, SpraykW, Twet1, Tstart                        /TWRDAT/ 6
      DIMENSION        TWRSAV(25)                                               /TWRDAT/ 7
      EQUIVALENCE     (TWRSAV(1),TWRload)                                       /TWRDAT/ 8
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
      COMMON  /ZEROP/  LpmHR,LlpHR,LchHR,LblHR,LdwHR,LtwHR,LpvHR,LgnHR,         PV       5
     &                 LtkHR,LhxHR,LecHR,LlmHR,LemHR,LfmHR,LsmHR,LcmHR,         /ZEROP/  3
     &                 LglHR,LpeHR,                                             /ZEROP/  4
     &                 LpmMO,LlpMO,LchMO,LblMO,LdwMO,LtwMO,LpvMO,LgnMO,         PV       6
     &                 LtkMO,LhxMO,LecMO,LlmMO,LemMO,LfmMO,LsmMO,LcmMO,         /ZEROP/  6
     &                 LglMO,LpeMO,                                             /ZEROP/  7
     &                 LpmYR,LlpYR,LchYR,LblYR,LdwYR,LtwYR,LpvYR,LgnYR,         PV       7
     &                 LtkYR,LhxYR,LecYR,LlmYR,LemYR,LfmYR,LsmYR,LcmYR,         /ZEROP/  9
     &                 LglYR,LpeYR                                              /ZEROP/ 10
c                                                                               PLANTi  25
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
c                                                                               PLANTi  28
c                                                                               PLANTi  34
c              set flag to indicate that any calls are estimates                PLANTi  35
      RealCall = .FALSE.                                                        PLANTi  36
c                                                                               PLANTi  37
c              Initialize the control sequences                                 PLANTi  38
      CALL LoadManagement(1)                                                    PLANTi  39
c                                                                               PLANTi  40
c              Initialize hourly load variables for system coils                PLANTi  41
      DO  NS=1,NSYS                                                             PLANTi  42
c              base pointer to this system's data                               PLANTi  43
        NSP = IS + (NS-1)*NSS                                                   PLANTi  44
c              zero this systems circulation-loop loads                         PLANTi  45
        IF (<SYS_LOOP_FLAG> .NE. 0)  THEN                                       PLANTi  46
          CALL FILLN(0., <CW_COIL_GPM>, 11)                                     PLANTi  47
          ISZ = <ISZONES>                                                       PLANTi  48
          NSZ = <NZONES>                                                        PLANTi  49
          DO  NZ=1,NSZ                                                          PLANTi  50
            ZP1 = ISZ + (NZ-1)*NZD                                              PLANTi  51
            IF (<ZONE_LOOP_FLAG> .NE. 0)                                        PLANTi  52
     &        CALL FILLN(0., <WSE_COIL_GPMZ>, 7)                                PLANTi  53
          ENDDO                                                                 PLANTi  54
        ENDIF                                                                   PLANTi  55
      ENDDO                                                                     PLANTi  56
c              initialize hourly chiller EDTT variables                         PLANTi  57
      DO  Neq=1,Nch                                                             PLANTi  58
        Jch = Ich + (Neq-1)*Lch                                                 PLANTi  59
        CALL FILLN(0., <=HRBJch>, LchHR)                                        PLANTi  60
        <ch;LastMode> = <ch;Mode>                                               ChlrHP 856
      ENDDO                                                                     PLANTi  61
c              determine if fluid coolers are running with wet coils            PLANTi  62
      DO  Neq=1,Ntw                                                             PLANTi  63
        Jtw = Itw + (Neq-1)*Ltw                                                 PLANTi  64
        <tw;WET_COIL_FLAG> = SchSnap(1, <tw:WET-COIL-SCH>, DBT, 1.)             Time    44
      ENDDO                                                                     PLANTi  74
c                                                                               PLANTi  75
c              Initialize the loops                                             PLANTi  76
      IF (Nlp .EQ. 0)  RETURN                                                   PLANTi  77
c                                                                               PLANTi  78
c              update all loop schedules and setpoints, and calculate           PLANTi  79
c              pipe losses to outdoors or tunnels                               PLANTi  80
      DO 10  NL=1,Nlp                                                           PLANTi  81
c              pointer to this loop's data                                      PLANTi  82
        Jlp = Ilp + (NL-1)*Llp                                                  PLANTi  83
        LoopType = <lp:TYPE>                                                    PLANTi  84
c              skip if this loop not used                                       PLANTi  85
        IF (LoopType .EQ. Deleted)  GOTO 10                                     PLANTi  86
c              initialize loop load and flow                                    PLANTi  87
        IF (<lp;RUNNING> .GT. 0)  THEN                                          GLHX1  731
c              hours loop has been running                                      GLHX1  732
          <lp;HOURS_RUNNING> = MAX(0, <lp;HOURS_RUNNING>) + 1                   GLHX1  733
        ELSE                                                                    GLHX1  734
c              hours loop has been off (negative number)                        GLHX1  735
          <lp;HOURS_RUNNING> = MIN(0, <lp;HOURS_RUNNING>) - 1                   GLHX1  736
        ENDIF                                                                   GLHX1  737
        IF (<lp;HOURS_RUNNING> .GT. 0)  THEN                                    GLHX1  738
c              loop was running last hour                                       GLHX1  739
          DO  II=1,6                                                            GLHX1  740
            <lp;VARS_PAST> = <lp;VARS>                                          GLHX1  741
          ENDDO                                                                 GLHX1  742
          IF (<lp;HOURS_RUNNING> .EQ. 1)  THEN                                  GLHX1  743
c              save start-up variables                                          GLHX1  744
            DO  II=1,6                                                          GLHX1  745
              <lp;START_VARS> = <lp;VARS>                                       GLHX1  746
            ENDDO                                                               GLHX1  747
          ENDIF                                                                 GLHX1  748
        ELSE  ! loop was off last hour - use last start-up values               GLHX1  749
          DO  II=1,6                                                            GLHX1  750
            <lp;VARS_PAST> = <lp;START_VARS>                                    GLHX1  751
          ENDDO                                                                 GLHX1  752
        ENDIF                                                                   GLHX1  753
        <lp;Q_NET>    = 0.                                                      PLANTi 105
        <lp;GPM>      = 0.                                                      PLANTi 106
c              transfer re-entrant variables to hourly                          PLANTi 107
        <lp;SUPPLY_AVG>  = <lp;SUPPLY_AVG'>                                     PLANTi 108
        <lp;RETURN_AVG>  = <lp;RETURN_AVG'>                                     PLANTi 109
        <lp;ACCUM_OVRLD> = <lp;ACCUM_OVR'>                                      PLANTi 110
        <lp;ACCUM_OVR'>  = 0.                                                   PLANTi 111
c              switching temperature - can be indoors or outdoors               PLANTi 112
        IF (<lp:SNAP-LOCN> .EQ. ZONE)  THEN                                     PLANTi 113
          ZP1   = <lp:SNAP-ZONE>                                                PLANTi 114
          Tsnap = <TNOW>                                                        PLANTi 115
        ELSE                                                                    PLANTi 116
          Tsnap = DBT                                                           PLANTi 117
        ENDIF                                                                   PLANTi 118
c              initialize heating and cooling setpoints                         PLANTi 119
        TLOOPh = -888.E20                                                       -041e   32
        TLOOPc =  888.E20                                                       -041e   33
c                                                                               -041k   19
c              Check if loop enabled and get setpoint(s)                        -041k   20
        LoopCtrl = OffMode                                                      -041k   21
        SELECT CASE (LoopType)                                                  -041k   22
          CASE (1,9)  ! CHW, CW (cooling only)                                  -041k   23
c              check if enabled                                                 -041k   24
            SELECT CASE (<lp:OPERATION>)                                        -041k   25
              CASE (0)                                                          -041k   26
c                 should not ever be here                                       -041k   27
              CASE (1,2,5)  ! Standby, Demand, Subhour                          -041k   28
                Call CoolingMode                                                -048   152
              CASE (3)  ! Snap on temperature                                   -041k   30
                IF (Tsnap .ge. <lp:SNAP-T>)  Call CoolingMode                   -048   153
              CASE (4)  ! Scheduled                                             -041k   32
                IF(SchSnap(1, <lp:COOL-SCH>, Tsnap, 1.) .ne. 0.)                -041k   33
     &                                       Call CoolingMode                   -048   154
            END SELECT                                                          -041k   35
          CASE (4,8)  ! HW, DHW (heating only)                                  -041k   36
c              check if enabled                                                 -041k   37
            SELECT CASE (<lp:OPERATION>)                                        -041k   38
              CASE (0)  ! DHW with no recirc pump                               -041k   39
                Call HeatingMode                                                -048   155
              CASE (1,2,5)  ! Standby, Demand, Subhour                          -041k   41
                Call HeatingMode                                                -048   156
              CASE (3)  ! Snap on temperature                                   -041k   43
                IF (Tsnap .lt. <lp:SNAP-T>)  Call HeatingMode                   -048   157
              CASE (4)  ! Scheduled                                             -041k   45
                IF (SchSnap(-1, <lp:HEAT-SCH>, Tsnap, 1.) .ne. 0.)              -041k   46
     &                                       Call HeatingMode                   -048   158
            END SELECT                                                          -041k   48
          CASE (2)  ! 2-pipe                                                    -041k   49
            SELECT CASE (<lp:OPERATION>)                                        -041k   50
              CASE (1,2,5)  ! Standby, Demand, Subhour                          -041k   51
c                 snap according to temperature                                 -041k   52
                IF (Tsnap .lt. <lp:SNAP-T>)  THEN                               -041k   53
                  Call HeatingMode                                              -048   159
                ELSE                                                            -041k   55
                  Call CoolingMode                                              -048   160
                ENDIF                                                           -041k   57
              CASE (3)  ! Snap on temperature                                   -041k   58
c                 makes no sense - was reset to DEMAND                          -041k   59
              CASE (4)  ! Scheduled                                             -041k   60
                IF (SchSnap(-1, <lp:HEAT-SCH>, Tsnap, 1.) .ne. 0)               -041k   61
     &            Call HeatingMode                                              -048   161
                IF (SchSnap( 1, <lp:COOL-SCH>, Tsnap, 1.) .ne. 0)  THEN         -041k   63
                  IF (LoopCtrl .eq. OffMode)  THEN                              -041k   64
                    Call CoolingMode                                            -048   162
                  ELSE                                                          -041k   66
c                       2-pipe system should never have both heating and        -041k   67
c                       cooling activated simultaneously                        -041k   68
                    Call MsgSim(-1,II,II,II,II)                                 -041k   69
                    Write (iOutpt,9100) (<lp:NAME>,II=1,8), IMO,IDAY,IHR        -041k   70
                    call MessageBox( NULL, '2-Pipe has heat & cool on -'        -041k   71
     &              //' ABORTING'//char(0),'PLANTi Errors'//char(0),            -041k   72
     &              MB_OK + MB_ICONSTOP + MB_TASKMODAL )                        -041k   73
                    Return                                                      -041k   75
                  ENDIF                                                         -041k   76
                ENDIF                                                           -041k   77
            END SELECT  ! lp:OPERATION                                          -041k   78
          CASE (7)  ! WLHP                                                      -041k   79
            SELECT CASE (<lp:OPERATION>)                                        -041k   80
              CASE (1,2,5)  ! Standby, Demand, Subhour                          -041k   81
                Call HeatingMode                                                -048   163
                Call CoolingMode                                                -048   164
              CASE (3)  ! Snap on temperature                                   -041k   84
c                 makes no sense - was reset to DEMAND                          -041k   85
              CASE (4)  ! Scheduled                                             -041k   86
                IF (SchSnap(-1, <lp:HEAT-SCH>, Tsnap, 1.) +                     -041k   87
     &              SchSnap( 1, <lp:COOL-SCH>, Tsnap, 1.) .ne. 0)  THEN         -041k   88
                  Call HeatingMode                                              -048   165
                  Call CoolingMode                                              -048   166
                ENDIF                                                           -041k   91
            END SELECT  ! lp:OPERATION                                          -041k   92
c              wlhp control points should be separated by at least 5F           -041k   93
c              for stability                                                    -041k   94
            IF ((TloopH + <lp:SETPT-RNG> + 5.0) .gt. TloopC)  THEN              -041k   95
              Tave   = (TloopH + TloopC) * 0.5                                  -041k   96
              dT     = (<lp:SETPT-RNG> + 5.0) * 0.5                             -041k   97
              TloopH = Tave - dT                                                -041k   98
              TloopC = Tave + Dt                                                -041k   99
            ENDIF                                                               -041k  100
        END SELECT  ! LoopType                                                  -041k  101
c                                                                               -041k  102
c              Look to see if pump scheduled off                                -041k  103
        IF (SchVal(<lp:PUMP-SCH>, 1.) .eq. 0.  .and.                            -041k  104
     &                           LoopType .ne. DHW)  LoopCtrl = OffMode         -041k  105
c              LOAD-MANAGEMENT can override local loop controls                 -041k  106
c              Set OffMode here, OnMode later                                   -041k  107
        IF (<lp;OVERRIDE> .eq. OffMode)  LoopCtrl = OffMode                     -041k  108
c                                                                               -041k  109
c              store mode, flag if switched mode since last hour                PLANTi 246
        IF (LoopCtrl .NE. <lp;CTRL_MODE>  .AND.                                 -031     3
     &                              <lp;CTRL_MODE> .NE. FLOATING)  THEN         -031     4
          <lp;SNAP_FLAG> = 1                                                    PLANTi 248
        ELSE                                                                    PLANTi 249
          <lp;SNAP_FLAG> = 0                                                    PLANTi 250
        ENDIF                                                                   PLANTi 251
        <lp;CTRL_MODE> = LoopCtrl                                               PLANTi 252
        <lp;SCH_MODE>  = LoopCtrl                                               PLANTi 253
c              store setpoints                                                  PLANTi 254
        <lp;HEAT_SETPT> = TLOOPh                                                PLANTi 255
        <lp;COOL_SETPT> = TLOOPc                                                PLANTi 256
   10 CONTINUE                                                                  PLANTi 257
c              for secondary loops, force the control mode                      PLANTi 258
c              to comply with the primaries                                     PLANTi 259
      IF (NLP2 .GT. 0)  THEN                                                    PLANTi 260
        DO  NL=1,Nlp                                                            PLANTi 261
c              pointer to this loop's data                                      PLANTi 262
          Jlp = Ilp + (NL-1)*Llp                                                PLANTi 263
          IF (<lp:TYPE> .NE. WLHP                                               PLANTi 264
     &                      .AND.  <lp:SUBTYPE> .EQ. SECONDARY)  THEN           PLANTi 265
c              get the mode of the primary loop                                 PLANTi 266
            Jlp2 = Jlp                                                          PLANTi 267
            Jlp  = <lp:PRIMARY>                                                 PLANTi 268
            LoopCtrl = <lp;CTRL_MODE>                                           PLANTi 269
            Jlp  = Jlp2                                                         PLANTi 270
c              force the secondary to have the same mode, except if             PLANTi 271
c              secondary is off                                                 PLANTi 272
            IF (<lp;CTRL_MODE> .NE. OFFMODE)  THEN                              PLANTi 273
              <lp;CTRL_MODE> = LoopCtrl                                         PLANTi 274
              <lp;SCH_MODE>  = LoopCtrl                                         PLANTi 275
            ENDIF                                                               PLANTi 276
          ENDIF                                                                 PLANTi 277
        ENDDO                                                                   PLANTi 278
      ENDIF                                                                     PLANTi 279
c              end of setpoint calculations                                     PLANTi 280
c              now initialize loops                                             PLANTi 281
c                                                                               PLANTi 282
c              HW, CHW, and 2-PIPE loops.  Also DHW serving coils               PLANTi 283
      DO  NL=1,Nlp                                                              PLANTi 285
        Jlp = Ilp + (NL-1)*Llp                                                  PLANTi 286
        LoopType = <lp:TYPE>                                                    PLANTi 287
        IF (<lp:SUBTYPE> .EQ. PRIMARY  .AND.                                    PLANTi 288
     &         (LoopType .EQ. HW  .OR.  LoopType .EQ. CHW                       PLANTi 289
     &                            .OR.  LoopType .EQ. PIPE2                     PLANTi 290
     &                            .OR.  LoopType .EQ. DHW))  THEN               PLANTi 291
c              Set the loop's maximum capacity ratio - normally, this           PLANTi 292
c              is calculated in PrimaryEquip.  The following are overrides      PLANTi 293
c              for startup hours, or when the loop has changed modes.           PLANTi 294
          LoopCtrl = <lp;CTRL_MODE>                                             PLANTi 295
          IF (LoopCtrl .EQ. OFFMODE)  THEN                                      PLANTi 296
c              loop is off this hour                                            PLANTi 297
            <lp;HCAP_RATIO> = 0.                                                PLANTi 298
            <lp;CCAP_RATIO> = 0.                                                PLANTi 299
            <lp;HCapNext>   = 0.                                                BUGS    56
            <lp;CCapNext>   = 0.                                                BUGS    57
          ELSEIF (LoopCtrl .EQ. HEATMODE)  THEN                                 PLANTi 300
c              loop is in heating mode                                          PLANTi 301
            <lp;CCAP_RATIO> = 0.                                                PLANTi 302
            <lp;CCapNext>   = 0.                                                BUGS    58
            <lp;HCAP_RATIO> = <lp;HCapNext>                                     BUGS    59
c              check for startup or snap condition                              PLANTi 303
            IF (<lp;HOURS_RUNNING> .LT. 0  .OR.  <lp;SNAP_FLAG> .EQ. 1)         GLHX1  754
     &         <lp;HCAP_RATIO> = <lp;DES_HCAPR>                                 PLANTi 305
             IF (<lp;HCAP_RATIO> .EQ. 0.)                                       -035   151
     &           <lp;HCAP_RATIO> = <lp;DES_HCAPR>                               -035   152
          ELSE                                                                  PLANTi 306
c              loop is in cooling mode                                          PLANTi 307
            <lp;HCAP_RATIO> = 0.                                                PLANTi 308
            <lp;HCapNext>   = 0.                                                BUGS    60
            <lp;CCAP_RATIO> = <lp;CCapNext>                                     BUGS    61
c              check for startup or snap condition                              PLANTi 309
            IF (<lp;HOURS_RUNNING> .LT. 0  .OR.  <lp;SNAP_FLAG> .EQ. 1)         GLHX1  755
     &         <lp;CCAP_RATIO> = <lp;DES_CCAPR>                                 PLANTi 311
             IF (<lp;CCAP_RATIO> .EQ. 0.)                                       -035   153
     &           <lp;CCAP_RATIO> = <lp;DES_CCAPR>                               -035   154
          ENDIF                                                                 PLANTi 312
c              constrain secondaries according to their primary                 PLANTi 313
          IF (<lp;NUM_2ND_LOOPS> .GT. 0)  THEN                                  PLANTi 314
            CAPRh1 = <lp;HCAP_RATIO>                                            PLANTi 315
            CAPRc1 = <lp;CCAP_RATIO>                                            PLANTi 316
            ICTRL1 = <lp;CTRL_MODE>                                             PLANTi 317
            Jlp1   = Jlp                                                        PLANTi 318
            N2nd   = <lp;NUM_2ND_LOOPS>                                         PLANTi 319
            DO  L2=1,N2nd                                                       PLANTi 320
              Jlp = Jlp1                                                        PLANTi 321
              Jlp = <lp;PTR_2ND_LOOPS>                                          PLANTi 322
              ICTRL2 = <lp;CTRL_MODE>                                           -031     5
              IF (ICTRL2 .EQ. OFFMODE)  THEN                                    -031     6
c              secondary loop is off this hour                                  PLANTi 325
                <lp;HCAP_RATIO> = 0.                                            PLANTi 326
                <lp;CCAP_RATIO> = 0.                                            PLANTi 327
              ELSE                                                              PLANTi 328
c              get capacity ratios of attached primary                          PLANTi 329
c              secondary must be off if primary is off                          PLANTi 330
                IF (ICTRL1 .EQ. OFFMODE)  THEN                                  PLANTi 331
                  ICTRL2 = OFFMODE                                              -031     7
                  <lp;CTRL_MODE> = OFFMODE                                      PLANTi 333
                  <lp;SCH_MODE>  = OFFMODE                                      PLANTi 334
                ENDIF                                                           PLANTi 335
                IF (ICTRL2 .EQ. HEATMODE)  THEN                                 -031     8
c              loop is in heating mode                                          PLANTi 337
                  <lp;CCAP_RATIO> = 0.                                          PLANTi 338
c              check for startup or snap condition                              PLANTi 339
                  IF (<lp;HOURS_RUNNING> .LT. 0  .OR.                           -035   155
     &                                      <lp;SNAP_FLAG> .EQ. 1)  THEN        -035   156
                    <lp;HCAP_RATIO> = MIN(<lp;DES_HCAPR>, CAPRh1)               -035   157
                  ELSE                                                          -035   158
                    <lp;HCAP_RATIO> = CAPRh1                                    -035   159
                  ENDIF                                                         -035   160
                ELSE                                                            PLANTi 345
c              loop is in cooling mode                                          PLANTi 346
                  <lp;HCAP_RATIO> = 0.                                          PLANTi 347
c              check for startup or snap condition                              PLANTi 348
                  IF (<lp;HOURS_RUNNING> .LT. 0  .OR.                           -035   161
     &                                      <lp;SNAP_FLAG> .EQ. 1)  THEN        -035   162
                    <lp;CCAP_RATIO> = MIN(<lp;DES_CCAPR>, CAPRc1)               -035   163
                  ELSE                                                          -035   164
                    <lp;CCAP_RATIO> = CAPRc1                                    -035   165
                  ENDIF                                                         -035   166
                ENDIF                                                           PLANTi 354
              ENDIF                                                             PLANTi 355
c              end of secondary loop capacity constraints                       PLANTi 356
            ENDDO                                                               PLANTi 357
          ENDIF                                                                 PLANTi 358
c              end of primary loop capacity constraints                         PLANTi 359
        ENDIF                                                                   PLANTi 360
      ENDDO                                                                     PLANTi 361
c                                                                               PLANTi 362
c              spare loop type                                                  PLANTi 363
  300 CONTINUE                                                                  PLANTi 364
c                                                                               PLANTi 365
c              wlhp loop                                                        PLANTi 366
  700 IF (Nloop(WLHP,1) .EQ. 0)  GOTO 800                                       PLANTi 367
c              Estimate temperature of primary loops based on last hours        PLANTi 455
c              load and flow, and this hours wetbulb and control temp.          PLANTi 456
c              This newly estimated temperature is used in the equipment        PLANTi 457
c              simulations (capacity and eir).                                  PLANTi 458
c              The last hour's loop temperatures are used in TEMDEV to          PLANTi 459
c              calculate losses                                                 PLANTi 460
      DO  NL=1,Nlp                                                              PLANTi 461
c              pointer to this loop's data                                      PLANTi 462
        Jlp = Ilp + (NL-1)*Llp                                                  PLANTi 463
        IF (<lp:TYPE> .EQ. WLHP  .AND.  <lp;CTRL_MODE> .NE. OFFMODE             PLANTi 464
     &                           .AND.  <lp:SUBTYPE> .EQ. PRIMARY) THEN         PLANTi 465
          CALL FILLN(0., LOOPDAT(1), IVTLIM(2,14))                              PLANTi 466
c              estimated loop load and flow                                     PLANTi 467
          QloopNet = <lp;Q_PAST_ENDU> + <lp;PUMP_Q_PAST>                        PLANTi 468
     &             + <lp;SUPPLY_LOSS> + <lp;RETURN_LOSS>                        PLANTi 469
     &             + <lp;ACCUM_OVRLD>                                           PLANTi 470
          GPMs     = <lp;GPM_PAST>                                              PLANTi 471
          GPMr = GPMs                                                           PLANTi 475
c              past hour's average temperature                                  PLANTi 476
          TavgPast = (<lp;SUPPLY_AVG>+<lp;RETURN_AVG>) * 0.5                    PLANTi 477
c              temperature change if loop floats                                PLANTi 478
          dTfloat = QloopNet / <lp;BTU/F>                                       PLANTi 479
c              ending temperature if loop floats                                PLANTi 480
          Tend = TavgPast + dTfloat                                             PLANTi 481
c              average temperature if loop floats                               PLANTi 482
          Tave = TavgPast + dTfloat*0.5                                         PLANTi 483
c              compare floating temperature to control setpoints                PLANTi 484
          IF (<lp:/WELLFLAG/> .GT. 0)  THEN                                     ChlrHP 899
c              only a well can do this                                          ChlrHP 900
            <lp;RUNNING>      = 1                                               ChlrHP 901
            <lp;CTRL_MODE>    = COOLMODE                                        ChlrHP 902
            <lp;SCH_MODE>     = COOLMODE                                        ChlrHP 903
            Tsupply           = <lp;COOL_SETPT>                                 ChlrHP 904
            <lp;RUN_FRACTION> = <lp;RUN_FRAC_PAST>                              ChlrHP 905
            CALL PrimaryEquip                                                   ChlrHP 906
            Tave = Tsupply                                                      ChlrHP 907
          ELSEIF (Tend .LE. <lp;HEAT_SETPT>+<lp;SETPT_RNG2>)  THEN              ChlrHP 908
c              loop is controlling to heating setpoint                          PLANTi 486
c              throttling range                                                 PLANTi 487
            THR  = MAX(-0.5, MIN(0.5, 0.5-QloopNet/<lp;DES_HCAP>))              PLANTi 488
     &           * <lp:SETPT-RNG>                                               PLANTi 489
            Tset = <lp;HEAT_SETPT> + THR                                        PLANTi 490
c              see what the primary equipment can do                            PLANTi 491
            <lp;RUNNING>      = 1                                               PLANTi 492
            <lp;CTRL_MODE>    = HEATMODE                                        PLANTi 493
            <lp;SCH_MODE>     = HEATMODE                                        PLANTi 494
            <lp;RUN_FRACTION> = <lp;RUN_FRAC_PAST>                              GLHX1  758
            Tsupply           = Tset                                            PLANTi 497
            CALL PrimaryEquip                                                   PLANTi 498
c              float temperature down if insufficient capacity - note that      PLANTi 499
c              glhx always returns enough capacity, although it will float      PLANTi 500
c              the temperature                                                  PLANTi 501
            IF (QloopNet .LT. TotalLoopCap                                      PLANTi 502
     &                                  .AND.  QloopNet .NE. 0.)  THEN          PLANTi 503
              dTfloat = (QloopNet-TotalLoopCap) / <lp;BTU/F>                    PLANTi 504
              Tend    = TavgPast + dTfloat                                      PLANTi 505
              Tave    = MAX(TavgPast + dTfloat*0.5,                             PLANTi 506
     &                        <lp:MIN-ALARM-T>+0.01)                            PLANTi 507
            ELSE                                                                PLANTi 508
              Tave    = Tsupply                                                 PLANTi 509
            ENDIF                                                               PLANTi 510
          ELSEIF (Tend .GE. <lp;COOL_SETPT>-<lp;SETPT_RNG2>                     PLANTi 511
     &        .OR.  <lp;GLHX_Flag> .EQ. 1)  THEN                                PLANTi 512
c              loop is controlling to cooling setpoint                          PLANTi 513
c              find out what the tower can do (estimates Tsupply)               PLANTi 514
            <lp;RUNNING>      = 1                                               GLHX1  759
            <lp;CTRL_MODE>    = COOLMODE                                        GLHX1  760
            <lp;SCH_MODE>     = COOLMODE                                        GLHX1  761
            Tsupply           = <lp;COOL_SETPT>                                 GLHX1  762
            <lp;RUN_FRACTION> = <lp;RUN_FRAC_PAST>                              GLHX1  763
            CALL PrimaryEquip                                                   PLANTi 521
            Tave = Tsupply                                                      PLANTi 522
          ELSE                                                                  PLANTi 523
c                   loop is floating                                            PLANTi 524
          ENDIF                                                                 PLANTi 525
c              estimate condenser supply temperature at equipment               PLANTi 526
c              condensers and/or secondary loops                                PLANTi 527
          CALL PipeDT(<lp;SupplyLossPtr>, Tave, GPMs, -77777., 1,               PLANTi 528
     &                dTf, xxx, xxx)                                            PLANTi 529
          Ts1 = Tave + dTf                                                      PLANTi 530
c              if this is a start-up hour estimate, keep loop temperature       PLANTi 531
c              within alarm limits so heat pumps can run                        PLANTi 532
          IF (<lp;HOURS_RUNNING> .LT. 0)  THEN                                  ChlrHP 909
            IF (<lp:MAX-ALARM-T> .NE. 0.)                                       ChlrHP 910
     &        Ts1 = MIN(<lp:MAX-ALARM-T>-0.01, Ts1)                             ChlrHP 911
            IF (<lp:MIN-ALARM-T> .NE. 0.)                                       ChlrHP 912
     &        Ts1 = MAX(<lp:MIN-ALARM-T>+0.01, Ts1)                             ChlrHP 913
          ENDIF                                                                 ChlrHP 914
          <lp;COIL_EWTest> = Ts1                                                PLANTi 536
c              Check if loop temperature within limits                          Sync    41
          IF (<lp:MIN-ALARM-T> .NE. 0.                                          Bug40  230
     &                        .AND.  Ts1 .LT. <lp:MIN-ALARM-T>)  THEN           Bug40  231
            IF (<lp;NumLoAlarm> .EQ. 0)  THEN                                   Bug40  232
              CALL MSGSIM(-2,II,II,II,II)                                       Bug40  233
              WRITE(IOUTPT,9101) (<lp:NAME>,II=1,8), Ts1,                       Bug40  234
     &                         <lp:MIN-ALARM-T>, IMO,IDAY,IHR                   Bug40  235
            ENDIF                                                               Bug40  236
            <lp;NumLoAlarm> = <lp;NumLoAlarm> + 1                               Bug40  237
          ELSEIF (<lp:MAX-ALARM-T> .NE. 0.                                      Bug40  238
     &                        .AND.  Ts1 .GT. <lp:MAX-ALARM-T>)  THEN           Bug40  239
            IF (<lp;NumHiAlarm> .EQ. 0)  THEN                                   Bug40  240
              CALL MSGSIM(-2,II,II,II,II)                                       Bug40  241
              WRITE(IOUTPT,9101) (<lp:NAME>,II=1,8), Ts1,                       Bug40  242
     &                         <lp:MAX-ALARM-T>, IMO,IDAY,IHR                   Bug40  243
            ENDIF                                                               Bug40  244
            <lp;NumHiAlarm> = <lp;NumHiAlarm> + 1                               Bug40  245
          ENDIF                                                                 Bug40  246
c              constrain secondaries according to their primary                 PLANTi 537
          IF (<lp;NUM_2ND_LOOPS> .GT. 0)  THEN                                  PLANTi 538
            ICTRL1 = <lp;CTRL_MODE>                                             PLANTi 540
            Jlp1   = Jlp                                                        PLANTi 541
            N2nd   = <lp;NUM_2ND_LOOPS>                                         PLANTi 542
            DO  L2=1,N2nd                                                       PLANTi 543
              Jlp = Jlp1                                                        PLANTi 544
              Jlp = <lp;PTR_2ND_LOOPS>                                          PLANTi 545
c              secondary must be off if primary is off                          PLANTi 546
              IF (ICTRL1 .EQ. OFFMODE)  THEN                                    PLANTi 547
                <lp;CTRL_MODE> = OFFMODE                                        PLANTi 548
                <lp;SCH_MODE>  = OFFMODE                                        PLANTi 549
              ELSE                                                              Bug40  247
                <lp;CTRL_MODE> = FLOATING                                       Bug40  248
                <lp;SCH_MODE>  = FLOATING                                       Bug40  249
              ENDIF                                                             Bug40  250
              IF (<lp;CTRL_MODE> .NE. OFFMODE)  THEN                            PLANTi 551
                Ts2 = Ts1                                                       PLANTi 552
                IF (<lp:PUMP> .GT. 0)  Ts2 = Ts2 + <lp;PUMP_DT_PAST>            PLANTi 553
c              estimate supply temperature at equipment condensers              PLANTi 554
                CALL PipeDT(<lp;SupplyLossPtr>,Ts2,<lp;GPM_PAST>,               PLANTi 555
     &                       -77777., 1, dTf, xxx, xxx)                         PLANTi 556
                <lp;COIL_EWTest> = Ts2 + dTf                                    PLANTi 557
                <lp;COIL_EWTest> = Ts2 + dTf                                    Bug40  251
c                 Check if loop temperature within limits                       Bug40  252
                IF (<lp:MIN-ALARM-T> .NE. 0.                                    Bug40  253
     &              .AND.  <lp;COIL_EWTest> .LT. <lp:MIN-ALARM-T>)  THEN        Bug40  254
                  IF (<lp;NumLoAlarm> .EQ. 0)  THEN                             Bug40  255
                    CALL MSGSIM(-2,II,II,II,II)                                 Bug40  256
                    WRITE(IOUTPT,9101) (<lp:NAME>,II=1,8),                      Bug40  257
     &                <lp;COIL_EWTest>, <lp:MIN-ALARM-T>, IMO,IDAY,IHR          Bug40  258
                  ENDIF                                                         Bug40  259
                  <lp;NumLoAlarm> = <lp;NumLoAlarm> + 1                         Bug40  260
                ELSEIF (<lp:MAX-ALARM-T> .NE. 0.                                Bug40  261
     &              .AND.  <lp;COIL_EWTest> .GT. <lp:MAX-ALARM-T>)  THEN        Bug40  262
                  IF (<lp;NumHiAlarm> .EQ. 0)  THEN                             Bug40  263
                    CALL MSGSIM(-2,II,II,II,II)                                 Bug40  264
                    WRITE(IOUTPT,9101) (<lp:NAME>,II=1,8),                      Bug40  265
     &                 <lp;COIL_EWTest>, <lp:MAX-ALARM-T>, IMO,IDAY,IHR         Bug40  266
                  ENDIF                                                         Bug40  267
                  <lp;NumHiAlarm> = <lp;NumHiAlarm> + 1                         Bug40  268
                ENDIF                                                           Bug40  269
              ENDIF                                                             PLANTi 558
c              end of secondary loop calcs                                      PLANTi 559
            ENDDO                                                               PLANTi 560
          ENDIF                                                                 PLANTi 561
c              end of primary loop calcs                                        PLANTi 562
        ENDIF                                                                   PLANTi 563
      ENDDO                                                                     PLANTi 564
c                                                                               PLANTi 565
c              DHW loops                                                        PLANTi 566
c              Process flows for DHW loops are those which go down the          PLANTi 567
c              drain.  These are calculated exactly here.  There may also       PLANTi 568
c              be heating coil loads which are not known until the end          PLANTi 569
c              of the hour.  Coil loads are approximated here using last        PLANTi 570
c              hours value.                                                     PLANTi 571
  800 IF (Nloop(DHW,1) .EQ. 0)  GOTO 900                                        PLANTi 572
      DO  NL=1,Nlp                                                              PLANTi 573
c              pointer to this loop's data                                      PLANTi 574
        Jlp = Ilp + (NL-1)*Llp                                                  PLANTi 575
        IF (<lp:TYPE> .EQ. DHW  .AND.  <lp:SUBTYPE> .EQ. PRIMARY)  THEN         PLANTi 576
          CALL FILLN(0., LOOPDAT(1), IVTLIM(2,14))                              PLANTi 577
c              Get inlet temperature                                            PLANTi 578
          IF ( <lp:DHW-INLET-SCH> .NE. 0 )  THEN                                PLANTi 579
c              inlet temperature is scheduled                                   PLANTi 580
            Tinlet = SchVal(<lp:DHW-INLET-SCH>, 0.)                             Time    50
          ELSEIF (<lp:DHW-INLET-T> .NE. UNFILD)  THEN                           PLANTi 582
c              inlet temperature is fixed                                       PLANTi 583
            Tinlet = <lp:DHW-INLET-T>                                           PLANTi 584
          ELSE                                                                  PLANTi 585
c              inlet temperature defaults to the ground temperature             PLANTi 586
c              convert from Rankin to Fahrenheit                                PLANTi 587
            Tinlet = TGNDR - 460.                                               PLANTi 588
          ENDIF                                                                 PLANTi 589
          <lp;INLET_T> = Tinlet                                                 PLANTi 590
c              get supply temperature                                           PLANTi 591
          Tsupply = <lp;HEAT_SETPT>                                             PLANTi 592
c              assume return is same as last hours                              PLANTi 593
          Treturn = <lp;RETURN_T>                                               PLANTi 594
c              process flow                                                     Time    51
c ??           ** include space dhw use once available **                       Time    52
          GPMdhw     = 0.                                                       Proces 142
          NumProcess = <lp;NumProcess>                                          Proces 143
          DO  II=1,NumProcess                                                   Proces 144
            GPMprocess = <lp:PROCESS-GPM>                                       -045b  122
     &                 * SchVal(<lp:PROC-LOAD-SCH>, 1.)                         -045b  123
c                  if a mixing temperature is specified, reduce flow            -045b  124
            IF (<lp:PROCESS-T> .ne. Unfild) THEN                                -045b  125
              Rmix       = (<lp:PROCESS-T>-Tinlet) / (Tsupply-Tinlet)           -045b  126
              GPMprocess = GPMprocess * Max(0., Min(1., Rmix))                  -045b  127
            ENDIF                                                               -045b  128
            GPMdhw = GPMdhw + GPMprocess                                        -045b  129
          ENDDO                                                                 Proces 147
          <lp;PROCESS_GPM> = GPMdhw                                             PLANTi 604
c              dhw load                                                         PLANTi 605
          Qdhw = <lp;BTUH/GPM-F> * <lp;PROCESS_GPM>                             PLANTi 606
     &                           * (Tinlet-Tsupply)                             PLANTi 607
          <lp;PROCESS_Q> = Qdhw                                                 Bug40  270
c              get loads from secondary loops                                   PLANTi 608
          IF (<lp;NUM_2ND_LOOPS> .GT. 0)  THEN                                  PLANTi 609
            N2nd = <lp;NUM_2ND_LOOPS>                                           PLANTi 610
c              save primary loop pointer                                        PLANTi 611
            Jlp1 = Jlp                                                          PLANTi 612
            DO  L2=1,N2nd                                                       PLANTi 613
c              pointer to secondary loop                                        PLANTi 614
              Jlp = Jlp1                                                        PLANTi 615
              Jlp = <lp;PTR_2ND_LOOPS>                                          PLANTi 616
c              process flow                                                     Time    54
c ??           ** include space dhw use once available **                       Time    55
              GPMdhw2    = 0.                                                   Proces 148
              NumProcess = <lp;NumProcess>                                      Proces 149
              DO  II=1,NumProcess                                               Proces 150
                GPMprocess = <lp:PROCESS-GPM>                                   -048d    1
     &                     * SchVal(<lp:PROC-LOAD-SCH>, 1.)                     -048d    2
c                  if a mixing temperature is specified, reduce flow            -048d    3
                IF (<lp:PROCESS-T> .ne. Unfild) THEN                            -048d    4
                  Rmix       = (<lp:PROCESS-T>-Tinlet)/(Tsupply-Tinlet)         -048d    5
                  GPMprocess = GPMprocess * Max(0., Min(1., Rmix))              -048d    6
                ENDIF                                                           -048d    7
                GPMdhw2 = GPMdhw2 + GPMprocess                                  -048d    8
              ENDDO                                                             Proces 153
              GPMdhw  = GPMdhw + GPMdhw2                                        PLANTi 627
              <lp;PROCESS_GPM> = GPMdhw2                                        PLANTi 628
c              dhw load                                                         PLANTi 629
              Qdhw2 = <lp;BTUH/GPM-F> * <lp;PROCESS_GPM>                        PLANTi 630
     &                                * (Tinlet-Tsupply)                        PLANTi 631
              Qdhw  = Qdhw + Qdhw2                                              PLANTi 632
              <lp;PROCESS_Q> = Qdhw2                                            PLANTi 633
              IF (<lp;CTRL_MODE> .NE. OFFMODE)  THEN                            Bug40  271
                <lp;CTRL_MODE> = FLOATING                                       Bug40  272
                <lp;SCH_MODE>  = FLOATING                                       Bug40  273
              ENDIF                                                             Bug40  274
            ENDDO                                                               PLANTi 634
            Jlp = Jlp1                                                          -041d   12
          ENDIF                                                                 PLANTi 635
c              Net loop load and flow - this includes last hours coil load      PLANTi 636
c              Note that LOOP_PROCESS_Q is last hours value.                    Bug40  275
          QloopNet = <lp;Q_PAST_ENDU> + (Qdhw - <lp;PROCESS_Q>)                 PLANTi 640
     &             + <lp;PUMP_Q_PAST>                                           PLANTi 641
     &             + <lp;SUPPLY_LOSS> + <lp;RETURN_LOSS>                        Bug40  276
     &             + <lp;ACCUM_OVRLD>                                           PLANTi 642
c              force QloopNet to be slightly negative for this estimation       PLANTi 643
          QloopNet = MIN(-.1, QloopNet)                                         PLANTi 644
c              save this hours process load                                     PLANTi 645
c              base return flow on last hours coil flow                         PLANTi 647
          GPMr = <lp;GPMr_PAST>                                                 PLANTi 648
          IF (<lp;HOURS_RUNNING> .LT. 0)                                        GLHX1  765
     &      GPMr = MAX(GPMr, <lp:RECIRC-GPM>, <lp:MIN-GPM>)                     PLANTi 650
c              for supply, include the water that goes down the drain           PLANTi 651
          GPMs = GPMr + GPMdhw                                                  PLANTi 652
c              Simulate equipment to determine the demand for                   PLANTi 653
c              recoverable heat from airside equipment or zones.                PLANTi 654
          <lp;RUNNING>   = 1                                                    PLANTi 655
          iSave          = <lp;CTRL_MODE>                                       -041     5
          <lp;CTRL_MODE> = HEATMODE                                             PLANTi 656
          <lp;SCH_MODE>  = HEATMODE                                             PLANTi 657
          CALL PrimaryEquip                                                     PLANTi 658
          <lp;CTRL_MODE> = iSave                                                -041     6
          <lp;SCH_MODE>  = iSave                                                -041     7
        ENDIF                                                                   PLANTi 659
      ENDDO                                                                     PLANTi 660
c                                                                               PLANTi 661
c              CW loops                                                         PLANTi 662
c              Estimate temperature of primary loops based on last hours        PLANTi 663
c              load and flow, and this hours wetbulb and control temp.          PLANTi 664
c              This newly estimated temperature is used in the equipment        PLANTi 665
c              simulations (capacity and eir), and also in TEMDEV (with         PLANTi 666
c              last hours flow) to calculate losses                             PLANTi 667
  900 CONTINUE                                                                  PLANTi 668
      IF (Nloop(CW,1) .EQ. 0)  GOTO 1000                                        PLANTi 669
      DO  NL=1,Nlp                                                              PLANTi 670
c              pointer to this loop's data                                      PLANTi 671
        Jlp = Ilp + (NL-1)*Llp                                                  PLANTi 672
c              primary condenser loops first                                    PLANTi 673
        IF (<lp:TYPE> .EQ. CW  .AND.  <lp:SUBTYPE> .EQ. PRIMARY)  THEN          PLANTi 674
          CALL FILLN(0., LOOPDAT(1), IVTLIM(2,14))                              PLANTi 675
c              estimated loop load and flow                                     PLANTi 676
          QloopNet = <lp;Q_PAST_ENDU> + <lp;PUMP_Q_PAST>                        PLANTi 677
     &             + <lp;SUPPLY_LOSS> + <lp;RETURN_LOSS>                        PLANTi 678
     &             + <lp;ACCUM_OVRLD>                                           PLANTi 679
          GPMs     = <lp;GPM_PAST>                                              PLANTi 680
          GPMr     = GPMs                                                       PLANTi 681
c              now find out what the tower can do (estimates Tsupply)           PLANTi 682
          <lp;RUNNING>      = 1                                                 GLHX1  766
          ICTRL1            = <lp;CTRL_MODE>                                    Proces 154
          <lp;CTRL_MODE>    = COOLMODE                                          GLHX1  767
          <lp;SCH_MODE>     = COOLMODE                                          GLHX1  768
          Tsupply           = <lp;COOL_SETPT>                                   GLHX1  769
          <lp;RUN_FRACTION> = <lp;RUN_FRAC_PAST>                                GLHX1  770
          CALL PrimaryEquip                                                     PLANTi 686
c              estimate condenser supply temperature at equipment               PLANTi 687
c              condensers and/or secondary loops                                PLANTi 688
          CALL PipeDT(<lp;SupplyLossPtr>, Tsupply, GPMs, -77777., 1,            PLANTi 689
     &                dTf, xxx, xxx)                                            PLANTi 690
          Ts1 = Tsupply + dTf                                                   PLANTi 691
          <lp;COIL_EWTest> = Ts1                                                PLANTi 692
          <lp;CTRL_MODE>   = ICTRL1                                             Proces 155
          <lp;SCH_MODE>    = ICTRL1                                             Proces 156
c              constrain secondaries according to their primary                 PLANTi 693
          IF (<lp;NUM_2ND_LOOPS> .GT. 0)  THEN                                  PLANTi 694
            Jlp1   = Jlp                                                        PLANTi 697
            N2nd   = <lp;NUM_2ND_LOOPS>                                         PLANTi 698
            DO  L2=1,N2nd                                                       PLANTi 699
              Jlp      = Jlp1                                                   PLANTi 700
              Jlp      = <lp;PTR_2ND_LOOPS>                                     PLANTi 701
c              secondary must be off if primary is off                          PLANTi 702
              IF (ICTRL1 .EQ. OFFMODE)  THEN                                    PLANTi 703
                <lp;CTRL_MODE> = OFFMODE                                        PLANTi 704
                <lp;SCH_MODE>  = OFFMODE                                        PLANTi 705
              ELSE                                                              Bug40  277
                <lp;CTRL_MODE> = FLOATING                                       Bug40  278
                <lp;SCH_MODE>  = FLOATING                                       Bug40  279
              ENDIF                                                             Bug40  280
              IF (<lp;CTRL_MODE> .NE. OFFMODE)  THEN                            PLANTi 707
                Ts2 = Ts1                                                       PLANTi 708
                IF (<lp:PUMP> .GT. 0)  Ts2 = Ts2 + <lp;PUMP_DT_PAST>            PLANTi 709
c              estimate supply temperature at equipment condensers              PLANTi 710
                CALL PipeDT(<lp;SupplyLossPtr>,Ts2,<lp;GPM_PAST>,               PLANTi 711
     &                      -77777., 1, dTf, xxx, xxx)                          PLANTi 712
                <lp;COIL_EWTest> = Ts2 + dTf                                    PLANTi 713
              ENDIF                                                             PLANTi 714
c              end of secondary loop calcs                                      PLANTi 715
            ENDDO                                                               PLANTi 716
          ENDIF                                                                 PLANTi 717
c              end of primary loop calcs                                        PLANTi 718
        ENDIF                                                                   PLANTi 719
      ENDDO                                                                     PLANTi 720
c                                                                               PLANTi 721
 1000 CONTINUE                                                                  PLANTi 722
c                                                                               PLANTi 723
c              set flag to indicate that future calls are real                  PLANTi 724
      RealCall = .TRUE.                                                         PLANTi 725
c                                                                               PLANTi 726
c                                                                               PLANTi 727
c ****         run function : LOOP1-2                                           PLANTi 728
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        PLANTi 729
c                                                                               PLANTi 730
      RETURN                                                                    PLANTi 731
c                                                                               -041k  110
c              Message formats                                                  -048   167
 9100 FORMAT(14X,'2-pipe loop ',8A4,' has both heating and'            /        -048   168
     &       14X,'cooling enabled simultaneously on ',i2,'/',i2,','    ,        -048   169
     &           ' hour ',I2                                           /        -048   170
     &       14X,'Simulation aborted.'                                 )        -048   171
 9101 FORMAT(14X,'WLHP loop: ',8A4,'has exceeded a hi/low'             /        -048   172
     &14x,'alarm limit and will shut down associated HVAC equipment'   /        -048   173
     &14x,'for the hour.  Loop T: ',f6.2,'  Limit: ',f6.2              /        -048   174
     &14x,'Verify that alarm limits are reasonable, verify primary'    /        -048   175
     &14x,'equipment sizing, especially ground-loop heat-exchangers,'  /        -048   176
     &14x,'and verify that the HP performance curves are suitable for' /        -048   177
     &14x,'the intended operating range.  See Report PS-D for total'   /        -048   178
     &14x,'number of hours alarm limits are exceeded.'                 /        -048   179
     &14x,'First occurrence: ',I2,'/',I2,'/',I2                        )        -048   180
                                                                                -048   181
                                                                                -048   182
      CONTAINS                                                                  -048   183
c ============== CoolingMode ================================================== -048   184
      Subroutine CoolingMode                                                    -048   185
c                                                                               -041k  114
      LoopCtrl = CoolMode                                                       -041k  115
c                                                                               -041k  116
c              Cooling setpoint                                                 -041k  117
      SELECT CASE (<lp:CL-SETPT-CTRL>)                                          -041k  118
        CASE (0)  ! well water                                                  -041k  119
          LoopCtrl = Floating                                                   -041k  120
        CASE (1)  ! fixed                                                       -041k  121
          TloopC = <lp:CL-SETPT-T>                                              -041k  122
        CASE (2)  ! oa reset                                                    -041k  123
          TloopC = DRSVAL(<lp:CL-RESET-SCH>)                                    -045d    9
        CASE (3)  ! scheduled                                                   -041k  131
          TloopC = SchVal(<lp:CL-SETPT-SCH>, <lp:CL-SETPT-T>)                   -041k  132
        CASE (4)  ! load reset                                                  -041k  133
          TloopC = Min(<lp:DESIGN-COOL-T>,<lp:MAX-RESET-T>)                     -042b    2
      END SELECT                                                                -041k  135
c                                                                               -041k  147
      End Subroutine CoolingMode                                                -048   186
c                                                                               -041k  149
c                                                                               -041k  150
c ============== HeatingMode ================================================== -048   187
      Subroutine HeatingMode                                                    -048   188
c                                                                               -041k  153
      LoopCtrl        = HeatMode                                                -041k  154
      IF (LoopType .eq. DHW  .and.                                              -044d1  29
     $   (<lp:PUMP> .gt. 0  .or.  <lp:RECIRC-GPM> .gt. 0))                      -044d1  30
     &  <lp;RunDHWPump> = SchVal(<lp:PUMP-SCH>, 1.)                             -041k  156
c                                                                               -041k  157
c              Heating setpoint                                                 -041k  158
      SELECT CASE (<lp:HT-SETPT-CTRL>)                                          -041k  159
        CASE (0)  ! well water                                                  -041k  160
          LoopCtrl = Floating                                                   -041k  161
        CASE (1)  ! fixed                                                       -041k  162
          TloopH = <lp:HT-SETPT-T>                                              -041k  163
        CASE (2)  ! oa reset                                                    -041k  164
          TloopH = DRSVAL(<lp:HT-RESET-SCH>)                                    -045d   10
        CASE (3)  ! scheduled                                                   -041k  172
          TloopH = SchVal(<lp:HT-SETPT-SCH>, <lp:HT-SETPT-T>)                   -041k  173
        CASE (4)  ! load reset                                                  -041k  174
          IF (LoopType .ne. WLHP .and. LoopType .ne. DHW)  THEN                 -041k  175
            TloopH = <lp:MIN-RESET-T>                                           -041k  176
          ELSE                                                                  -041k  177
c              wlhp and dhw cannot reset temperature on load                    -041k  178
c                - makes no sense                                               -041k  179
            TloopH = <lp:DESIGN-HEAT-T>                                         -041k  180
          ENDIF                                                                 -041k  181
      END SELECT                                                                -041k  182
c                                                                               -041k  187
      End Subroutine HeatingMode                                                -048   189
c                                                                               PLANTi 738
      END                                                                       PLANTi 739
      SUBROUTINE PlantReports                                                   PLTREP   2
c                                                                               PLTREP   3
c              Outputs all of the report data to the report file                PLTREP   4
c              for circulation loops, pumps, and primary plant                  PLTREP   5
c              equipment.  Also prepares the central plant summary              PLTREP   6
c              reports.                                                         PLTREP   7
c                                                                               PLTREP   8
c              Mode =  0  Initialize all reports                                PLTREP   9
c                      1  Design records                                        PLTREP  10
c                     29  Monthly records                                       PLTREP  11
c                     39  Yearly records                                        PLTREP  12
c                                                                               PLTREP  13
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /BEPS  / BGAREA, BNAREA, PctSysOvrld, PctPltOvrld,                /BEPS/   2
     &                 SiteEnergy, SourceEnergy                                 /BEPS/   3
      DIMENSION        BEPS(6)                                                  /BEPS/   4
      EQUIVALENCE      (BEPS(1),BGAREA)                                         /BEPS/   5
      COMMON  /CTRL  / VERS(2),IRPFLG(4),IOVRLL(7),IWRTFL,IPROG,                /CTRL/   2
     1                 IFATAL,NAMPRG(3,7),MTRICR                                /CTRL/   3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /INTS  / IZERO,IONE,ITWO,ITHREE,IFOUR,IFIVE,ISIX,                 /INTS/   2
     &                 ISEVEN,IEIGHT,ININE,ITEN,                                /INTS/   3
     &                 I11,I12,I13,I14,I15,I16,I17,I18,I19,I20,                 /INTS/   4
     &                 I21,I22,I23,I24,I25,I26,I27,I28,I29,I30,                 /INTS/   5
     &                 I31,I32,I33,I34,I35,I36,I37,I38,I39,I40,                 /INTS/   6
     &                 I41,I42,I43,I44,I45,I46,I47,I48,I49,I50,                 /INTS/   7
     &                 I51,I52,I53,I54,I55,I56,I57,I58,I59,I60,                 /INTS/   8
     &                 I61,I62,I63,I64,I65,I66,I67,I68,I69,I70,                 /INTS/   9
     &                 I71,I72,I73,I74,I75,I76,I77,I78,I79,I80,                 /INTS/  10
     &                 I81,I82,I83,I84,I85,I86,I87,I88,I89,I90,                 /INTS/  11
     &                 I91,I92,I93,I94,I95,I96,I97,I98,I99,I100                 /INTS/  12
      INTEGER          INTS(101)                                                /INTS/  13
      EQUIVALENCE      (INTS(1),IZERO)                                          /INTS/  14
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PLTREP/ EndUses(20,2,4), EndUsePeaks(20,2,4),                    /PLTREP/ 2
     &                 EndPeakDay(20,2,4), EndPeakHour(20,2,4),                 /PLTREP/ 3
     &                 EndUseAtPeak(20,2,4),                                    HVAC29   1
     &                 PSA(13,2)                                                /PLTREP/ 4
      INTEGER          EndPeakDay, EndPeakHour                                  /PLTREP/ 5
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /REPORT/ IREPRT(4,37),IPRG,IUNIQV(100),IUNIQS(100),IUNIQL         /REPORT/ 2
      COMMON  /REPRT1/ IREFG, Iuniq                                             /REPRT1/ 2
      COMMON  /PTRSYS/ nzone , iz    , nczd  , zp2 ,         mtw  ,             -045a    1
     $                 nsys  , is    , nss   , nsp ,  ns   , icode,             HR      11
     $                 nsz   , isz   , nzd   , zp1 ,  nz   ,                    HR      12
     $                 nspace, lpr   ,                                          HR      13
     $                 nattch, iatt  ,                                          HR      14
     $                 P2, IDAYHR, IDBWBT,                                      HR      15
     $                 IRPPLT, IRPSUM, IRPSYS, IRPZON, MR1, MR2                 HR      16
      INTEGER          ZP1, ZP2, P2                                             /PTRSYS/14
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TDVdat/ NameTDV, TDVmax(3), TDVmin(3), TDVavg(3),                /TDVdat/ 2
     &                 TDVsrc(3,8760), KtvTDV2(4)                               /TDVdat/ 3
      Character        NameTDV*4                                                /TDVdat/ 4
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON /UNITT/   VKONV(300), DUMLOG(4), JUNITT(4,300,2)                   /UNITT/  2
c                                                                               PLTREP  28
      COMMON  /EMKY  / UtilityMeter, BldgMeter, SubMeter, SellMeter,            /EMKY/   2
     &                 NumElecMeterTypes(4)                                     /EMKY/   3
      INTEGER          UtilityMeter, BldgMeter, SubMeter, SellMeter             /EMKY/   4
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /SimAlg/ Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/ 2
     &                 Electrical,                                              /SIMALG/ 3
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/ 4
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/ 5
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   2
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/ 7
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/ 8
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/ 9
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/10
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    3
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    4
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    5
     &                 Ground_LoopVert_H2,Ground_LoopHoriz_H,                   -044d    6
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/14
      INTEGER          Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/15
     &                 Electrical,                                              /SIMALG/16
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/17
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/18
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   3
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/20
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/21
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/22
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/23
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    7
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    8
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    9
     &                 Ground_LoopVert_H2, Ground_LoopHoriz_H,                  -044d   10
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/27
c                                                                               PLTREP  32
c                                                                               PLTREP  33
      LOGICAL   HeaderFlag                                                      PLTREP  34
      INTEGER   NumPltRep(30), Blank, NoDesign(3)                               PLTREP  35
      INTEGER   TitlePSE(9),TitlePSF(9),TitlePSH(9),                            -044     3
     &          TitleTDV3(9),                                                   -044     4
     &          ElecMeter(8), FuelMeter(8), StmMeter(8), CHWMeter(8)            PLTREP  37
      INTEGER   BLRtypes(4,7), CHLRtypes(4,14), TWRtypes(4,6),                  -045m   54
     &          DHWtypes(4,4), GENtypes(4,5), TEStypes(4,4),                    PV       8
     &          PVtypes(4,5)                                                    PV       9
      INTEGER   PMPCTRL(3,6), ATTACH(4,6), EquipPumpType(3,3)                   PLTREP  40
      INTEGER   MeterType(4,5), FuelType(4,7), BEPSUunit(11)                    PLTREP  41
      DIMENSION BEPStot(13), BEPSUtot(11)                                       PLTREP  42
      INTEGER   Report25(7), Report59(7), Report74(7), Report75(7),             PLTREP  43
     &          Report83(7), Report84(7), Report85(7), Report85pv(7),           PV      10
     &          Report86(7)                                                     PV      11
c     INTEGER   PSC25(4),    PSC59(4),    PSC74(4),    PSC75(4),                PLTREP  45
c    &          PSC83(4),    PSC84(4),    PSC87(4)                              PLTREP  46
c                                                                               PLTREP  47
c              Report generator numbers for plant output reports                PLTREP  48
c              Note that PS-H has multiple report numbers (loops,               PLTREP  49
c              boilers, etc.) that are set in the initial record write.         PLTREP  50
c              Same with PS-E and PS-F.  All other reports have a               PLTREP  51
c              unique number.                                                   PLTREP  52
c              verification (1-15)   summary (16,30)                            PLTREP  53
      DATA NumPltRep /12,  0,  0,  0,  0,  0,  0,  0,  0,  0,                   PLTREP  54
     1                 0,  0,  0,  0,  0,                                       PLTREP  55
     2                20, 21, 22, 23, 67, 68, 24, 25, 26,  0,                   PLTREP  56
     3                34, 69,  0,  0,  0/                                       PLTREP  57
c                                                                               PLTREP  58
c              Indexes to the IR variables used to generate the Jpe             PLTREP  59
c              reports (PS-H)                                                   PLTREP  60
c                1 Load  2 Elec  3 Fuel   4 GPM   5 AuxE  6 AuxQ                PLTREP  61
c                7 Rcvr  8 Dchg  9 Chrg  10 Loss                                PLTREP  62
c                    Col1 Col2 Col3 Col4 Bin1 Bin2 Bin3                         PLTREP  63
      DATA Report25  / 1,   2,   5,   6,   1,   2,   0 /  ! Tower               PLTREP  64
      DATA Report59  / 1,   2,   3,   5,   1,   2,   3 /  ! Boiler              PLTREP  65
      DATA Report74  / 1,   7,   2,   5,   1,   2,   0 /  ! Elec Chlr           PLTREP  66
      DATA Report75  / 1,   7,   3,   5,   1,   2,   3 /  ! Abs/Eng Chlr        PLTREP  67
      DATA Report83  / 1,   2,   3,   5,   1,   2,   3 /  ! DW Heater           PLTREP  68
      DATA Report84  / 8,   9,  10,   5,   8,   9,   0 /  ! Storage             PLTREP  69
      DATA Report85  / 1,   3,   5,   7,   1,   3,   7 /  ! Cogeneration        PLTREP  70
      DATA Report85pv/ 1,   2,   5,   7,   1,   2,   7 /  ! PV Array            PV      12
      DATA Report86  / 1,   2,   3,   0,   1,   2,   0 /  ! PV Module           PV      13
c              Indexes to the Jpe PS-H variables used in PS-C                   PLTREP  71
c                    Col1 Col2 Col3 Col4                                        PLTREP  72
c     DATA PSC25     / 0,   0,   0,   0 /                 ! Tower               PLTREP  73
c     DATA PSC59     / 0,   0,   0,   0 /                 ! Boiler              PLTREP  74
c     DATA PSC74     / 0,   0,   0,   0 /                 ! Elec Chlr           PLTREP  75
c     DATA PSC75     / 0,   0,   0,   0 /                 ! Abs/Eng Chlr        PLTREP  76
c     DATA PSC83     / 0,   0,   0,   0 /                 ! DW Heater           PLTREP  77
c     DATA PSC84     / 0,   0,   0,   0 /                 ! Storage             PLTREP  78
c     DATA PSC85     / 0,   0,   0,   0 /                 ! Cogeneration        PLTREP  79
c                                                                               PLTREP  80
      DATA TitlePSE  /4HPS-E,4H Ene,4Hrgy ,4HEnd-,                              PLTREP  81
     &                4HUse ,4HSumm,4Hary ,4Hfor ,                              PLTREP  82
     &                4Hall                      /                              PLTREP  83
      DATA ElecMeter /4HElec,4Htric,4H Met,4Hers ,                              PLTREP  84
     &                4H    ,4H    ,4H    ,4H    /                              PLTREP  85
      DATA FuelMeter /4HFuel,4H Met,4Hers ,4H    ,                              PLTREP  86
     &                4H    ,4H    ,4H    ,4H    /                              PLTREP  87
      DATA StmMeter  /4HStea,4Hm Me,4Hters,4H    ,                              PLTREP  88
     &                4H    ,4H    ,4H    ,4H    /                              PLTREP  89
      DATA CHWMeter  /4HCHW ,4HMete,4Hrs  ,4H    ,                              PLTREP  90
     &                4H    ,4H    ,4H    ,4H    /                              PLTREP  91
      DATA TitlePSF  /4HPS-F,4H Ene,4Hrgy ,4HEnd-,                              PLTREP  92
     &                4HUse ,4HSumm,4Hary ,4Hfor ,                              PLTREP  93
     &                4H                         /                              PLTREP  94
      DATA TitlePSH  /4HPS-H,4H Loa,4Hds a,4Hnd E,                              PLTREP  95
     &                4Hnerg,4Hy Us,4Hage ,4Hfor ,                              PLTREP  96
     &                4H                         /                              PLTREP  97
      DATA TitleTDV3 /4HTDV3,4H TDV,4H Ene,4Hrgy ,                              -044     5
     &                4HEnd-,4HUse ,4HSumm,4Hary ,                              -044     6
     &                4Hfor /                                                   -044     7
      DATA Blank     /4H    /                                                   PLTREP  98
      DATA NoDesign  /4H    ,4H    ,4H    /                                     PLTREP  99
      DATA IHYR /3HYR /                                                         PLTREP 100
c                                                                               PLTREP 101
c                    command names according to symbol type                     PLTREP 102
c                                                                               PLTREP 103
      DATA BLRtypes                                                             PLTREP 104
     &    / 4HHW-B,4HOILE,4HR   ,4H    ,  4HHW-B,4HOILE,4HR-W/,4HDRFT,          HVAC29  33
     &      4HELEC,4H-HW-,4HBOIL,4HER  ,  4HSTM-,4HBOIL,4HER  ,4H    ,          HVAC29  34
     &      4HSTM-,4HBOIL,4HER-W,4H/DFT,  4HELEC,4H-STM,4H-BOI,4HLER ,          -045m   55
     &      4HHW-C,4HONDE,4HNSIN,4HG   /                                        -045m   56
      DATA CHLRtypes                                                            PLTREP 108
     &    / 4HELEC,4H-OPE,4HN-CE,4HNT  ,  4HELEC,4H-OPE,4HN-RE,4HC   ,          PLTREP 109
     &      4HELEC,4H-HER,4HM-CE,4HNT  ,  4HELEC,4H-HER,4HM-RE,4HC   ,          PLTREP 110
     &      4HELEC,4H-HTR,4HEC  ,4H    ,  4HABSO,4HR-1 ,4H    ,4H    ,          Proces 157
     &      4HABSO,4HR-2 ,4H    ,4H    ,  4HGAS-,4HABSO,4HR   ,4H    ,          PLTREP 112
     &      4HENGI,4HNE-C,4HHLR ,4H    ,  4HHEAT,4H-PUM,4HP   ,4H    ,          FreeCl  69
     &      4HLOOP,4H-TO-,4HLOOP,4H-HP ,  4HELEC,4H-SCR,4HEW  ,4H    ,          FreeCl  70
     &      4HFREE,4H-COO,4HLING,4H    ,  4H    ,4H    ,4     ,4H    /          FreeCl  71
      DATA TWRtypes                                                             PLTREP 115
     &    / 4HOPEN,4H-TWR,4H    ,4H    ,  4HOPEN,4H-TWR,4H-W/H,4HX   ,          PLTREP 116
     &      4HFLUI,4HD-CO,4HOLER,4H    ,  4HDRYC,4HOOLE,4HR   ,4H    ,          PLTREP 117
     &      4HAIR-,4HCOND,4HENSE,4HR   ,  4HEVAP,4H-CON,4HDENS,4HER  /          PLTREP 118
      DATA DHWtypes                                                             PLTREP 119
     &    / 4HGAS ,4HDW-H,4HEATE,4HR   ,  4HELEC,4H DW-,4HHEAT,4HER  ,          PLTREP 120
     &      4HHEAT,4H-PUM,4HP DW,4H-HTR,  4HSPAR,4HE   ,4H    ,4H    /          PLTREP 121
      DATA GENtypes                                                             PLTREP 122
     &    / 4HDIES,4HEL-E,4HNGIN,4HE   ,  4HGAS-,4HTURB,4HINE ,4H    ,          PLTREP 123
     &      4HSTEA,4HM-TU,4HRBIN,4HE   ,  4HPV I,4HNVER,4HTER ,4H    ,          PV      14
     &      4HFUEL,4H-CEL,4HL   ,4H    /                                        PLTREP 125
      DATA TEStypes                                                             PLTREP 126
     &    / 4HCOLD,4H-WAT,4HER-T,4HANK ,  4HHOT-,4HWATE,4HR-TA,4HNK  ,          PLTREP 127
     &      4Hspar,4He   ,4H    ,4H    ,  4Hspar,4He   ,4H    ,4H    /          PLTREP 128
      DATA PVtypes                                                              PV      15
     &    / 4HEFG-,4HSi  ,4H    ,4H    ,  4Hmc-S,4Hi   ,4H    ,4H    ,          PV      16
     &      4HSi-f,4Hilm ,4H    ,4H    ,  4HCdTe,4H    ,4H    ,4H    ,          PV      17
     &      4Ha-Si,4H    ,4H    ,4H    /                                        PV      18
      DATA PMPCTRL                                                              PLTREP 129
     &    / 4H   O,4HNE-S,4HPEED,         4H   T,4HWO-S,4HPEED,                 PLTREP 130
     &      4H   V,4HAR-S,4HPEED,         4H    ,4H  ST,4HAGED,                 PLTREP 131
     &      4H2-SP,4HD&ST,4HAGED,         4H  VF,4HD&ST,4HAGED       /          PLTREP 132
      DATA ATTACH                                                               PLTREP 133
     &    / 4HPRIM,4HARY ,4HLOOP,4H    ,  4HSECO,4HNDAR,4HY LO,4HOP  ,          PLTREP 134
     &      4HEVAP,4HORAT,4HOR  ,4H    ,  4HCOND,4HENSE,4HR   ,4H    ,          PLTREP 135
     &      4HHOT ,4HWATE,4HR   ,4H    ,  4HHEAT,4H-REC,4HOVER,4H    /          PLTREP 136
      DATA EquipPumpType                                                        PLTREP 137
     &    / 4HPRIM,4HARY ,4H    ,         4HSECO,4HNDAR,4HY   ,                 PLTREP 138
     &      4H(RUN,4H-ARO,4HUND) /                                              PLTREP 139
      DATA MeterType                                                            PLTREP 140
     &    / 4HELEC,4HTRIC,4HITY ,4H    ,  4HFUEL,4H    ,4H    ,4H    ,          PLTREP 141
     &      4HSTEA,4HM   ,4H    ,4H    ,  4HCHIL,4HLED-,4HWATE,4HR   ,          PLTREP 142
     &      4HELEC,4HTRIC,4H SAL,4HE   /                                        PLTREP 143
      DATA FuelType                                                             PLTREP 144
     &    / 4HNATU,4HRAL-,4HGAS ,4H    ,  4HLPG ,4H    ,4H    ,4H    ,          PLTREP 145
     &      4HFUEL,4H-OIL,4H    ,4H    ,  4HDIES,4HEL-O,4HIL  ,4H    ,          PLTREP 146
     &      4HCOAL,4H    ,4H    ,4H    ,  4HMETH,4HANOL,4H    ,4H    ,          PLTREP 147
     &      4HOTHE,4HR-FU,4HEL  ,4H    /                                        PLTREP 148
      DATA IELEC, IFUEL, ISTM, ICHW  /1,2,3,4/                                  PLTREP 149
c                                                                               PLTREP 150
c                                                                               PLTREP 151
c              General reports have data stored in dimensioned arrays.          PLTREP 152
c              For those reports, the unique report number required by          PLTREP 153
c              the report generator (IUNIQ) is stored in IREPRT(3,x).           PLTREP 154
c                                                                               PLTREP 155
c              Reports specific to a piece of equipment (loop, pump,            PLTREP 156
c              boiler, etc.) have data stored in EDTT variables.  For           PLTREP 157
c              those reports, IUNIQ is stored as an EDTT variable.              PLTREP 158
c                                                                               PLTREP 159
c              Reports for fuels must have units that change according          PLTREP 160
c              to the fuel type (NATURAL-GAS, etc.).  For those reports,        PLTREP 161
c              the consumption units are converted from Btuh in this            PLTREP 162
c              subroutine.  If metric units are being used, the                 PLTREP 163
c              Btu/metric-unit adjustment was made in READSS.  This             PLTREP 164
c              routine must output the correct units, however, as the           PLTREP 165
c              report generator cannot accommodate units that change            PLTREP 166
c              from one fuel type to the next.                                  PLTREP 167
c                                                                               PLTREP 168
c              The title for each report is as follows:                         PLTREP 169
c                 Words (A4 format)                                             PLTREP 170
c                       1-9          Fixed part of Title                        PLTREP 171
c                      10-17         Component name (loop, chiller, etc.)       PLTREP 172
c                      18-20         Design day designation                     PLTREP 173
c                                                                               PLTREP 174
c              Set the units                                                    PLTREP 175
      IF (MTRICR .EQ. 1)  THEN                                                  PLTREP 176
c              metric                                                           PLTREP 177
        IUNIT = 1                                                               PLTREP 178
      ELSE                                                                      PLTREP 179
c              english                                                          PLTREP 180
        IUNIT = 2                                                               PLTREP 181
      ENDIF                                                                     PLTREP 182
c                                                                               PLTREP 183
c              Jump according to simulation control mode                        PLTREP 184
      SELECT CASE (SimCtrl)                                                     PLTREP 185
c                                                                               PLTREP 186
c                                                                               PLTREP 187
c============= REPORT INITIALIZATION ========================================== PLTREP 188
      CASE (0)                                                                  PLTREP 189
c                                                                               PLTREP 190
c              Verification reports                                             PLTREP 191
      DO  I=1,14                                                                PLTREP 192
        IF (IREPRT(3,I) .GT. 0  .AND.  NumPltRep(I) .GT. 0)  THEN               PLTREP 193
          WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, NumPltRep(I), IONE                PLTREP 194
c              store the unique report number for this report                   PLTREP 195
          IREPRT(3,I) = IUNIQ                                                   PLTREP 196
c              increment the unique report number for the next report           PLTREP 197
          IUNIQ = IUNIQ + 1                                                     PLTREP 198
        ENDIF                                                                   PLTREP 199
      ENDDO                                                                     PLTREP 200
c              Skip summary report initialization if no run is to be            PLTREP 201
c              made                                                             PLTREP 202
      IF ((IREPRT(3,15) .EQ. 1).or.(IREPRT(2,15) .EQ. 1)) RETURN                -033    17
c                                                                               PLTREP 204
c              Summary reports                                                  PLTREP 205
c              General plant reports                                            PLTREP 206
c              PS-A                                                             PLTREP 207
      IF (IREPRT(3,16) .GT. 0)  THEN                                            PLTREP 208
        WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, NumPltRep(16), IONE                 PLTREP 209
c              store the unique report number for this report                   PLTREP 210
        IREPRT(3,16) = IUNIQ                                                    PLTREP 211
c              increment the unique report number for the next report           PLTREP 212
        IUNIQ = IUNIQ + 1                                                       PLTREP 213
      ENDIF                                                                     PLTREP 214
c                                                                               PLTREP 215
c              PS-B                                                             PLTREP 216
      IF (IREPRT(3,17) .GT. 0)  THEN                                            PLTREP 217
        WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, NumPltRep(17), IONE                 PLTREP 218
c              store the unique report number for this report                   PLTREP 219
        IREPRT(3,17) = IUNIQ                                                    PLTREP 220
c              increment the unique report number for the next report           PLTREP 221
        IUNIQ = IUNIQ + 1                                                       PLTREP 222
      ENDIF                                                                     PLTREP 223
c                                                                               PLTREP 224
c              PS-C, only for buildings with circulation-loops                  PLTREP 225
      IF (IREPRT(3,18) .GT. 0  .AND.  Nlp .GT. 0)  THEN                         PLTREP 226
        WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, NumPltRep(18), IONE                 PLTREP 227
c              store the unique report number for this report                   PLTREP 228
        IREPRT(3,18) = IUNIQ                                                    PLTREP 229
c              increment the unique report number for the next report           PLTREP 230
        IUNIQ = IUNIQ + 1                                                       PLTREP 231
      ELSE                                                                      PLTREP 232
        IREPRT(3,18) = 0                                                        PLTREP 233
      ENDIF                                                                     PLTREP 234
c                                                                               PLTREP 235
c              PS-D, only for buildings with circulation-loops                  PLTREP 236
      IF (IREPRT(3,19) .GT. 0  .AND.  Nlp .GT. 0)  THEN                         PLTREP 237
        WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, NumPltRep(19), IONE                 PLTREP 238
c              store the unique report number for this report                   PLTREP 239
        IREPRT(3,19) = IUNIQ                                                    PLTREP 240
c              increment the unique report number for the next report           PLTREP 241
        IUNIQ = IUNIQ + 1                                                       PLTREP 242
      ELSE                                                                      PLTREP 243
        IREPRT(3,19) = 0                                                        PLTREP 244
      ENDIF                                                                     PLTREP 245
c                                                                               PLTREP 246
c              PS-E, one report for each meter type                             PLTREP 247
      IF (IREPRT(3,20) .GT. 0)  THEN                                            PLTREP 248
        IREPRT(3,20) = IUNIQ                                                    PLTREP 249
c              electric meters                                                  PLTREP 250
        IF (Nem .GT. 0)  THEN                                                   PLTREP 251
          WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, I67, IONE                         PLTREP 252
          IUNIQ = IUNIQ + 1                                                     PLTREP 253
          IF (KtvTDV2(1) .gt. 0)  THEN  ! TDV2 report                           -044     8
            WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, I98, IONE                       -044     9
            Ktv        = KtvTDV2(1)                                             -044    10
            <tv;Iuniq> = IUNIQ                                                  -044    11
            IUNIQ      = IUNIQ + 1                                              -044    12
          ENDIF                                                                 -044    13
        ENDIF                                                                   PLTREP 254
c              fuel meters                                                      PLTREP 255
        IF (Nfm .GT. 0)  THEN                                                   PLTREP 256
          WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, I76, IONE                         PLTREP 257
          IUNIQ = IUNIQ + 1                                                     PLTREP 258
          IF (KtvTDV2(2) .gt. 0)  THEN  ! TDV2 report                           -044    14
            WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, I99, IONE                       -044    15
            Ktv        = KtvTDV2(2)                                             -044    16
            <tv;Iuniq> = IUNIQ                                                  -044    17
            IUNIQ      = IUNIQ + 1                                              -044    18
          ENDIF                                                                 -044    19
        ENDIF                                                                   PLTREP 259
c              purchased steam meters                                           PLTREP 260
        IF (Nsm .GT. 0)  THEN                                                   PLTREP 261
          WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, I77, IONE                         PLTREP 262
          IUNIQ = IUNIQ + 1                                                     PLTREP 263
        ENDIF                                                                   PLTREP 264
c             purchased chilled-water meters                                    PLTREP 265
        IF (Ncm .GT. 0)  THEN                                                   PLTREP 266
          WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, I78, IONE                         PLTREP 267
          IUNIQ = IUNIQ + 1                                                     PLTREP 268
        ENDIF                                                                   PLTREP 269
      ENDIF                                                                     PLTREP 270
c                                                                               PLTREP 271
c              PS-F, one report for each meter                                  PLTREP 272
      IF (IREPRT(3,21) .GT. 0)  THEN                                            PLTREP 273
c              electric meters                                                  PLTREP 274
        DO IM=1,Nem                                                             PLTREP 275
          Jem = Iem + (IM-1)*Lem                                                PLTREP 276
          IF (<em:REPORT> .NE. 0)  THEN                                         PLTREP 277
            WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, I68, IONE                       PLTREP 278
            <em:REPORT> = IUNIQ                                                 PLTREP 279
            IUNIQ = IUNIQ + 1                                                   PLTREP 280
            IF (<em;Ktv> .gt. 0)  THEN  ! TDV3 report                           -044    20
              WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, I96, IONE                     -044    21
              Ktv        = <em;Ktv>                                             -044    22
              <tv;Iuniq> = IUNIQ                                                -044    23
              IUNIQ      = IUNIQ + 1                                            -044    24
            ENDIF                                                               -044    25
          ENDIF                                                                 PLTREP 281
        ENDDO                                                                   PLTREP 282
c              fuel meters                                                      PLTREP 283
        DO IM=1,Nfm                                                             PLTREP 284
          Jfm = Ifm + (IM-1)*Lfm                                                PLTREP 285
          IF (<fm:REPORT> .NE. 0)  THEN                                         PLTREP 286
            WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, I79, IONE                       PLTREP 287
            <fm:REPORT> = IUNIQ                                                 PLTREP 288
            IUNIQ = IUNIQ + 1                                                   PLTREP 289
            IF (<fm;Ktv> .gt. 0)  THEN  ! TDV3 report                           -044    26
              WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, I97, IONE                     -044    27
              Ktv        = <fm;Ktv>                                             -044    28
              <tv;Iuniq> = IUNIQ                                                -044    29
              IUNIQ      = IUNIQ + 1                                            -044    30
            ENDIF                                                               -044    31
          ENDIF                                                                 PLTREP 290
        ENDDO                                                                   PLTREP 291
c              steam meters                                                     PLTREP 292
        DO IM=1,Nsm                                                             PLTREP 293
          Jsm = Ism + (IM-1)*Lsm                                                PLTREP 294
          IF (<sm:REPORT> .NE. 0)  THEN                                         PLTREP 295
            WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, I80, IONE                       PLTREP 296
            <sm:REPORT> = IUNIQ                                                 PLTREP 297
            IUNIQ = IUNIQ + 1                                                   PLTREP 298
          ENDIF                                                                 PLTREP 299
        ENDDO                                                                   PLTREP 300
c              chilled-water meters                                             PLTREP 301
        DO IM=1,Ncm                                                             PLTREP 302
          Jcm = Icm + (IM-1)*Lcm                                                PLTREP 303
          IF (<cm:REPORT> .NE. 0)  THEN                                         PLTREP 304
            WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, I81, IONE                       PLTREP 305
            <cm:REPORT> = IUNIQ                                                 PLTREP 306
            IUNIQ = IUNIQ + 1                                                   PLTREP 307
          ENDIF                                                                 PLTREP 308
        ENDDO                                                                   PLTREP 309
      ENDIF                                                                     PLTREP 310
c                                                                               PLTREP 311
c              BEPS                                                             PLTREP 312
      IF (IREPRT(3,26) .GT. 0)  THEN                                            PLTREP 313
        WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, NumPltRep(26), IONE                 PLTREP 314
c              store the unique report number for this report                   PLTREP 315
        IREPRT(3,26) = IUNIQ                                                    PLTREP 316
        IUNIQ = IUNIQ + 1                                                       -044    32
        IF (ITDV .gt. 0)  THEN  ! TDV1 report                                   -044    33
          WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, I95, IONE                         -044    34
          IUNIQ = IUNIQ + 1                                                     -044    35
        ENDIF                                                                   -044    36
      ENDIF                                                                     PLTREP 319
c                                                                               PLTREP 320
c              BEPU                                                             PLTREP 321
      IF (IREPRT(3,27) .GT. 0)  THEN                                            PLTREP 322
        WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, NumPltRep(27), IONE                 PLTREP 323
c              store the unique report number for this report                   PLTREP 324
        IREPRT(3,27) = IUNIQ                                                    PLTREP 325
c              increment the unique report number for the next report           PLTREP 326
        IUNIQ = IUNIQ + 1                                                       PLTREP 327
      ENDIF                                                                     PLTREP 328
c                                                                               PLTREP 329
c              PS-H Summary reports specific to each component                  PLTREP 330
c              Circulation loops                                                PLTREP 331
      DO  NL=1,Nlp                                                              PLTREP 332
        Jlp = Ilp + (NL-1)*Llp                                                  PLTREP 333
        IF (<lp:TYPE> .NE. WLHP)  THEN                                          PLTREP 334
          NREPRT = I73                                                          PLTREP 335
        ELSE                                                                    PLTREP 336
          NREPRT = I82                                                          PLTREP 337
        ENDIF                                                                   PLTREP 338
        IF (<lp:REPORTS> .GT. 0  .AND.  <lp:TYPE> .NE. Deleted                  PLTREP 339
     &                           .AND.  IREPRT(3,23) .GT. 0) THEN               PLTREP 340
          WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, NREPRT, IONE                      PLTREP 341
          <lp;PS-H_IUNIQ> = IUNIQ                                               PLTREP 342
          IUNIQ = IUNIQ + 1                                                     PLTREP 343
        ENDIF                                                                   PLTREP 344
      ENDDO                                                                     PLTREP 345
c              pumps                                                            PLTREP 346
      NREPRT = I61                                                              PLTREP 347
      DO  Neq=1,Npm                                                             PLTREP 348
        Jpm = Ipm + (Neq-1)*Lpm                                                 PLTREP 349
        IF (<pm:REPORTS> .GT. 0  .AND.  IREPRT(3,23) .GT. 0)  THEN              Proces 158
          WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, NREPRT, IONE                      PLTREP 352
          <pm;PS-H_IUNIQ> = IUNIQ                                               PLTREP 353
          IUNIQ = IUNIQ + 1                                                     PLTREP 354
        ENDIF                                                                   PLTREP 355
      ENDDO                                                                     PLTREP 356
c              boilers                                                          PLTREP 357
      NREPRT = I59                                                              PLTREP 358
      DO  Neq=1,Nbl                                                             PLTREP 359
        Jbl = Ibl + (Neq-1)*Lbl                                                 PLTREP 360
        Jpe = <bl;Jpe>                                                          PLTREP 361
        <pe:REPORTS>      = <bl:REPORTS>                                        PLTREP 362
        <pe;PS-H_FMT_MON> = IFOUR                                               PLTREP 363
        <pe;PS-H_FMT_YR>  = IFIVE                                               PLTREP 364
        <pe;PS-H_CLOSE>   = IONE                                                PLTREP 365
        DO  IC=1,7                                                              PLTREP 366
          <pe;PS-H_VAR_INDX> = Report59(IC)                                     PLTREP 367
          IF (IC .LT. 5  .AND.  Report59(IC) .GT. 0)                            PLTREP 368
     &      <pe;PS-H_COLUMNS> = IC                                              PLTREP 369
          IF (IC .GT. 4  .AND.  Report59(IC) .GT. 0)                            PLTREP 370
     &      <pe;PS-H_BINS> = IC-4                                               PLTREP 371
        ENDDO                                                                   PLTREP 372
        IF (<pe:REPORTS> .GT. 0  .AND.  IREPRT(3,23) .GT. 0) THEN               PLTREP 373
          WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, NREPRT, IONE                      PLTREP 374
          <pe;PS-H_IUNIQ> = IUNIQ                                               PLTREP 375
          IUNIQ = IUNIQ + 1                                                     PLTREP 376
        ENDIF                                                                   PLTREP 377
      ENDDO                                                                     PLTREP 378
c              chillers                                                         PLTREP 379
      DO  Neq=1,Nch                                                             PLTREP 380
        Jch = Ich + (Neq-1)*Lch                                                 PLTREP 381
        Jpe = <ch;Jpe>                                                          PLTREP 382
        <pe:REPORTS> = <ch:REPORTS>                                             PLTREP 383
        <pe;PS-H_CLOSE> = IONE                                                  PLTREP 384
        IF (<ch:ALGORITHM> .EQ. Chiller_Elec1  .OR.                             ChlrHP 921
     &      <ch:ALGORITHM> .EQ. Chiller_HP1    .OR.                             ChlrHP 922
     &      <ch:ALGORITHM> .EQ. Chiller_LoopHP1  .OR.                           FreeCl  72
     &      <ch:ALGORITHM> .EQ. Chiller_FreeCool1)  THEN                        FreeCl  73
          <pe;PS-H_FMT_MON> = ISEVEN                                            PLTREP 386
          <pe;PS-H_FMT_YR>  = IEIGHT                                            PLTREP 387
          DO  IC=1,7                                                            PLTREP 388
            <pe;PS-H_VAR_INDX> = Report74(IC)                                   PLTREP 389
            IF (IC .LT. 5  .AND.  Report74(IC) .GT. 0)                          PLTREP 390
     &        <pe;PS-H_COLUMNS> = IC                                            PLTREP 391
            IF (IC .GT. 4  .AND.  Report74(IC) .GT. 0)                          PLTREP 392
     &        <pe;PS-H_BINS> = IC-4                                             PLTREP 393
          ENDDO                                                                 PLTREP 394
          NREPRT = I74                                                          PLTREP 395
        ELSEIF (<ch:ALGORITHM> .EQ. Chiller_Absor1  .OR.                        PLTREP 396
     &          <ch:ALGORITHM> .EQ. Chiller_Engine1)  THEN                      PLTREP 397
          <pe;PS-H_FMT_MON> = ISEVEN                                            PLTREP 398
          <pe;PS-H_FMT_YR>  = IEIGHT                                            PLTREP 399
          DO  IC=1,7                                                            PLTREP 400
            <pe;PS-H_VAR_INDX> = Report75(IC)                                   PLTREP 401
            IF (IC .LT. 5  .AND.  Report75(IC) .GT. 0)                          PLTREP 402
     &        <pe;PS-H_COLUMNS> = IC                                            PLTREP 403
            IF (IC .GT. 4  .AND.  Report75(IC) .GT. 0)                          PLTREP 404
     &        <pe;PS-H_BINS> = IC-4                                             PLTREP 405
          ENDDO                                                                 PLTREP 406
          NREPRT = I75                                                          PLTREP 407
        ELSEIF (<ch:ALGORITHM> .EQ. Chiller_Gas1)  THEN                         PLTREP 408
          <pe;PS-H_FMT_MON> = ISEVEN                                            PLTREP 409
          <pe;PS-H_FMT_YR>  = IEIGHT                                            PLTREP 410
          DO  IC=1,7                                                            PLTREP 411
            <pe;PS-H_VAR_INDX> = Report75(IC)                                   PLTREP 412
            IF (IC .LT. 5  .AND.  Report75(IC) .GT. 0)                          PLTREP 413
     &        <pe;PS-H_COLUMNS> = IC                                            PLTREP 414
            IF (IC .GT. 4  .AND.  Report75(IC) .GT. 0)                          PLTREP 415
     &        <pe;PS-H_BINS> = IC-4                                             PLTREP 416
          ENDDO                                                                 PLTREP 417
          NREPRT = I75                                                          PLTREP 418
        ENDIF                                                                   PLTREP 419
        IF (<pe:REPORTS> .GT. 0  .AND.  IREPRT(3,23) .GT. 0)  THEN              PLTREP 420
          WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, NREPRT, IONE                      PLTREP 421
c ?quck   <pe;PS-H_IUNIQ> = IUNIQ                                               PLTREP 422
          <ch;PS-H_IUNIQ> = IUNIQ                                               PLTREP 423
          IUNIQ = IUNIQ + 1                                                     PLTREP 424
        ENDIF                                                                   PLTREP 425
      ENDDO                                                                     PLTREP 426
c              cooling towers                                                   PLTREP 427
      NREPRT = I25                                                              PLTREP 428
      DO  Neq=1,Ntw                                                             PLTREP 429
        Jtw = Itw + (Neq-1)*Ltw                                                 PLTREP 430
        Jpe = <tw;Jpe>                                                          PLTREP 431
        <pe:REPORTS>      = <tw:REPORTS>                                        PLTREP 432
        <pe;PS-H_FMT_MON> = IFOUR                                               PLTREP 433
        <pe;PS-H_FMT_YR>  = IFIVE                                               PLTREP 434
        <pe;PS-H_CLOSE>   = IONE                                                PLTREP 435
        DO  IC=1,7                                                              PLTREP 436
          <pe;PS-H_VAR_INDX> = Report25(IC)                                     PLTREP 437
          IF (IC .LT. 5  .AND.  Report25(IC) .GT. 0)                            PLTREP 438
     &      <pe;PS-H_COLUMNS> = IC                                              PLTREP 439
          IF (IC .GT. 4  .AND.  Report25(IC) .GT. 0)                            PLTREP 440
     &      <pe;PS-H_BINS> = IC-4                                               PLTREP 441
        ENDDO                                                                   PLTREP 442
        IF (<pe:REPORTS> .GT. 0  .AND.  IREPRT(3,23) .GT. 0)  THEN              PLTREP 443
          WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, NREPRT, IONE                      PLTREP 444
c ?quck   <pe;PS-H_IUNIQ> = IUNIQ                                               PLTREP 445
          <tw;PS-H_IUNIQ> = IUNIQ                                               PLTREP 446
          IUNIQ = IUNIQ + 1                                                     PLTREP 447
        ENDIF                                                                   PLTREP 448
      ENDDO                                                                     PLTREP 449
c              tower free cooling                                               PLTREP 450
c?                                                                              PLTREP 451
c     NREPRT = I75                                                              PV      19
c     DO  Neq=1,NFC                                                             PV      20
c       JFC = IFC + (Neq-1)*LFC                                                 PV      21
c       IF (<TFC-REPORTS> .GT. 0  .AND.  IREPRT(3,23) .GT. 0)  THEN             PV      22
c          WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, NREPRT, IONE                     PV      23
c         <TFC_PS-H_IUNIQ> = IUNIQ                                              PV      24
c         IUNIQ = IUNIQ + 1                                                     PV      25
c       ENDIF                                                                   PV      26
c     ENDDO                                                                     PV      27
c              domestic water heaters                                           PLTREP 461
      NREPRT = I83                                                              PLTREP 462
      DO  Neq=1,Ndw                                                             PLTREP 463
        Jdw = Idw + (Neq-1)*Ldw                                                 PLTREP 464
        Jpe = <dw;Jpe>                                                          PLTREP 465
        <pe:REPORTS>      = <dw:REPORTS>                                        PLTREP 466
        <pe;PS-H_FMT_MON> = IFOUR                                               PLTREP 467
        <pe;PS-H_FMT_YR>  = IFIVE                                               PLTREP 468
        <pe;PS-H_CLOSE>   = IONE                                                PLTREP 469
        DO  IC=1,7                                                              PLTREP 470
          <pe;PS-H_VAR_INDX> = Report83(IC)                                     PLTREP 471
          IF (IC .LT. 5  .AND.  Report83(IC) .GT. 0)                            PLTREP 472
     &      <pe;PS-H_COLUMNS> = IC                                              PLTREP 473
          IF (IC .GT. 4  .AND.  Report83(IC) .GT. 0)                            PLTREP 474
     &      <pe;PS-H_BINS> = IC-4                                               PLTREP 475
        ENDDO                                                                   PLTREP 476
        IF (<pe:REPORTS> .GT. 0  .AND.  IREPRT(3,23) .GT. 0)  THEN              PLTREP 477
          WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, NREPRT, IONE                      PLTREP 478
c ?quck   <pe;PS-H_IUNIQ> = IUNIQ                                               PLTREP 479
          <dw;PS-H_IUNIQ> = IUNIQ                                               PLTREP 480
          IUNIQ = IUNIQ + 1                                                     PLTREP 481
        ENDIF                                                                   PLTREP 482
      ENDDO                                                                     PLTREP 483
c              electric generators                                              PLTREP 484
      NREPRT = I85                                                              PLTREP 485
      DO  Neq=1,Ngn                                                             PLTREP 486
        Jgn = Ign + (Neq-1)*Lgn                                                 PLTREP 487
        Jpe = <gn;Jpe>                                                          PLTREP 488
        <pe:REPORTS>      = <gn:REPORTS>                                        PLTREP 489
        IF (<gn:TYPE> .NE. 4)  THEN                                             PV      28
          <pe;PS-H_FMT_MON> = IFOUR                                             PV      29
          <pe;PS-H_FMT_YR>  = IFIVE                                             PV      30
          <pe;PS-H_CLOSE>   = IONE                                              PV      31
          DO  IC=1,7                                                            PV      32
            <pe;PS-H_VAR_INDX> = Report85(IC)                                   PV      33
            IF (IC .LT. 5  .AND.  Report85(IC) .GT. 0)                          PV      34
     &        <pe;PS-H_COLUMNS> = IC                                            PV      35
            IF (IC .GT. 4  .AND.  Report85(IC) .GT. 0)                          PV      36
     &        <pe;PS-H_BINS> = IC-4                                             PV      37
          ENDDO                                                                 PV      38
        ELSE                                                                    PV      39
c              Photovoltaic Array                                               PV      40
          <pe;PS-H_FMT_MON> = ININE                                             PV      41
          <pe;PS-H_FMT_YR>  = ITEN                                              PV      42
          <pe;PS-H_CLOSE>   = Izero                                             -041N   11
          DO  IC=1,7                                                            PV      44
            <pe;PS-H_VAR_INDX> = Report85pv(IC)                                 PV      45
            IF (IC .LT. 5  .AND.  Report85pv(IC) .GT. 0)                        PV      46
     &        <pe;PS-H_COLUMNS> = IC                                            PV      47
            IF (IC .GT. 4  .AND.  Report85pv(IC) .GT. 0)                        PV      48
     &        <pe;PS-H_BINS> = IC-4                                             PV      49
          ENDDO                                                                 PV      50
        ENDIF                                                                   PV      51
        IF (<pe:REPORTS> .GT. 0  .AND.  IREPRT(3,23) .GT. 0) THEN               PLTREP 500
          WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, NREPRT, IONE                      PLTREP 501
          <pe;PS-H_IUNIQ> = IUNIQ                                               PLTREP 502
          IUNIQ = IUNIQ + 1                                                     PLTREP 503
        ENDIF                                                                   PLTREP 504
      ENDDO                                                                     PLTREP 505
c              PV modules                                                       PV      52
      NREPRT = I86                                                              PV      53
      DO  Neq=1,Npv                                                             PV      54
        Jpv = Ipv + (Neq-1)*Lpv                                                 PV      55
        Jpe = <pv;Jpe>                                                          PV      56
        <pe:REPORTS>      = <pv:REPORTS>                                        PV      57
        <pe;PS-H_FMT_MON> = IFOUR                                               PV      58
        <pe;PS-H_FMT_YR>  = IFIVE                                               PV      59
        <pe;PS-H_CLOSE>   = Izero                                               -041N   12
        DO  IC=1,7                                                              PV      61
          <pe;PS-H_VAR_INDX> = Report86(IC)                                     PV      62
          IF (IC .LT. 5  .AND.  Report86(IC) .GT. 0)                            PV      63
     &      <pe;PS-H_COLUMNS> = IC                                              PV      64
          IF (IC .GT. 4  .AND.  Report86(IC) .GT. 0)                            PV      65
     &      <pe;PS-H_BINS> = IC-4                                               PV      66
        ENDDO                                                                   PV      67
        IF (<pe:REPORTS> .GT. 0  .AND.  IREPRT(3,23) .GT. 0)  THEN              PV      68
          WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, NREPRT, IONE                      PV      69
          <pe;PS-H_IUNIQ> = IUNIQ                                               PV      70
          IUNIQ = IUNIQ + 1                                                     PV      71
        ENDIF                                                                   PV      72
      ENDDO                                                                     PV      73
c              thermal storage                                                  PLTREP 506
      NREPRT = I84                                                              PLTREP 507
      DO  Neq=1,Ntk                                                             PLTREP 508
        Jtk = Itk + (Neq-1)*Ltk                                                 PLTREP 509
        Jpe = <tk;Jpe>                                                          PLTREP 510
        <pe:REPORTS>      = <tk:REPORTS>                                        PLTREP 511
        <pe;PS-H_FMT_MON> = IFIVE                                               PLTREP 512
        <pe;PS-H_FMT_YR>  = ISIX                                                PLTREP 513
        <pe;PS-H_CLOSE>   = IZERO                                               PLTREP 514
        DO  IC=1,7                                                              PLTREP 515
          <pe;PS-H_VAR_INDX> = Report84(IC)                                     PLTREP 516
          IF (IC .LT. 5  .AND.  Report84(IC) .GT. 0)                            PLTREP 517
     &      <pe;PS-H_COLUMNS> = IC                                              PLTREP 518
          IF (IC .GT. 4  .AND.  Report84(IC) .GT. 0)                            PLTREP 519
     &      <pe;PS-H_BINS> = IC-4                                               PLTREP 520
        ENDDO                                                                   PLTREP 521
        IF (<pe:REPORTS> .GT. 0  .AND.  IREPRT(3,23) .GT. 0)  THEN              PLTREP 522
          WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, NREPRT, IONE                      PLTREP 523
c ??quck  <pe;PS-H_IUNIQ> = IUNIQ                                               PLTREP 524
          <tk;PS-H_IUNIQ> = IUNIQ                                               PLTREP 525
          IUNIQ = IUNIQ + 1                                                     PLTREP 526
        ENDIF                                                                   PLTREP 527
      ENDDO                                                                     PLTREP 528
c              Ground-loop heat exchangers                                      -044e5  10
      NREPRT = 101                                                              -044e5  11
      DO Neq=1,Ngl                                                              -044e5  12
        Jgl = Igl + (Neq-1)*Lgl                                                 -044e5  13
        IF (<gl:REPORTS> .GT. 0  .AND.  IREPRT(3,23) .GT. 0) THEN               -044e5  14
          WRITE(IREPFL)  IFOUR, IUNIQ, IFOUR, NREPRT, IONE                      -044e5  15
          <gl;PS-H_IUNIQ> = IUNIQ                                               -044e5  16
          IUNIQ = IUNIQ + 1                                                     -044e5  17
        ENDIF                                                                   -044e5  18
      ENDDO                                                                     -044e5  19
c              Ice rinks                                                        -044e5  20
      DO  NS=1,NSYS                                                             IcRink 841
        NSP = IS + (NS-1)*NSS                                                   IcRink 842
        IF (<sy;IceRink> .GT. 0)  THEN                                          IcRink 843
          ISZ = <ISZONES>                                                       IcRink 844
          NSZ = <NZONES>                                                        IcRink 845
          DO  NZ=1,NSZ                                                          IcRink 846
            ZP1 = ISZ + (NZ-1)*NZD                                              IcRink 847
            ZP2 = <ZP2>                                                         IcRink 848
            IF (<zn:ICE-RINK> .GT. 0)  CALL IceRink(52, <zn:ICE-RINK>)          IcRink 849
          ENDDO                                                                 IcRink 850
        ENDIF                                                                   IcRink 851
      ENDDO                                                                     IcRink 852
c                                                                               PLTREP 529
c                                                                               PLTREP 530
c============= WRITE INITIAL RECORDS ========================================== PLTREP 531
      CASE (1)                                                                  PLTREP 532
c              Now write the initial records for each report,                   PLTREP 533
c              which includes all verification and design information           PLTREP 534
c                                                                               PLTREP 535
c              PV-A                                                             PLTREP 536
      IF (IREPRT(3,1) .GT. 0)  THEN                                             PLTREP 537
        IUNIQ = IREPRT(3,1)                                                     PLTREP 538
c              circulation loops                                                PLTREP 539
        IF (Nlp .GT. 0)  THEN                                                   PLTREP 540
          WRITE (IREPFL) IFOUR,IUNIQ,IONE,IONE,IZERO                            PLTREP 541
          DO  NL=1,Nlp                                                          PLTREP 542
            Jlp   = Ilp + (NL-1)*Llp                                            PLTREP 543
            IF (<lp:TYPE> .EQ. Deleted)  CYCLE                                  PLTREP 544
            WRITE(IREPFL) I22,IUNIQ,IONE,ITWO,I18,                              PLTREP 545
     &        (<lp:NAME>,II=1,8),                                               PLTREP 546
     &        <lp;DES_HCAP>,<lp;DES_CCAP>,<lp;DES_GPM>,                         PLTREP 547
     &        <lp;DES_HEAD>,<lp:SUPPLY-UA>,                                     PLTREP 548
     &        <lp:SLOSS-DT>,<lp:RETURN-UA>,<lp:RLOSS-DT>,                       PLTREP 549
     &        <lp:FLUID-VOL>, <lp;BTUH/GPM-F>/(60.*8.34)                        PLTREP 550
          ENDDO                                                                 PLTREP 551
        ENDIF                                                                   PLTREP 552
c              pumps                                                            PLTREP 553
        IF (Npm .GT. 0)  THEN                                                   PLTREP 554
          WRITE (IREPFL) IFOUR,IUNIQ,IONE,ITHREE,IZERO                          PLTREP 555
          DO  Neq=1,Npm                                                         PLTREP 556
            Jpm = Ipm + (Neq-1)*Lpm                                             PLTREP 557
            IF (<pm;TOTAL_GPM> .EQ. 0.)  CYCLE                                  PLTREP 558
            NumPump = INT(<pm:NUMBER>+.1)                                       PLTREP 559
c              pointer to attached loop or primary equipment                    PLTREP 560
            Jlp = <pm;ATTACH>                                                   PLTREP 561
c              capacity control index                                           PLTREP 562
            ICAP = <pm:CAP-CTRL>                                                HVAC29  36
            IF (NumPump .GT. 1)  ICAP = ICAP + 3                                HVAC29  37
            WRITE(IREPFL) I30,IUNIQ,IONE,IFOUR,I26,                             PLTREP 564
     &        (<pm:NAME>,II=1,8), NumPump,                                      PLTREP 565
     &        (<lp:NAME>,II=1,8),                                               PLTREP 566
     &        <pm;TOTAL_GPM>,<pm:HEAD>,<pm:HEAD-SETPT>,                         PLTREP 567
     &        (PMPCTRL(II,ICAP),II=1,3),<pm;TOTAL_KW>,                          PLTREP 568
     &        <pm:MECH-EFF>,<pm:MOTOR-EFF>                                      PLTREP 569
            IF (<pm;ATTACH_TYPE> .GT. 2)  THEN                                  PLTREP 570
              WRITE (IREPFL) I11,IUNIQ,IONE,IFIVE,ISEVEN,                       PLTREP 571
     &          (ATTACH(II,<pm;ATTACH_TYPE>),II=1,4),                           PLTREP 572
     &          (EquipPumpType(I,<pm;TYPE>),I=1,3)                              PLTREP 573
            ELSE                                                                PLTREP 574
              WRITE (IREPFL) I11,IUNIQ,IONE,IFIVE,ISEVEN,                       PLTREP 575
     &          (ATTACH(II,<pm;ATTACH_TYPE>),II=1,4),                           PLTREP 576
     &          (Blank,II=1,3)                                                  PLTREP 577
            ENDIF                                                               PLTREP 578
          ENDDO                                                                 PLTREP 579
        ENDIF                                                                   PLTREP 580
        IF (Nbl+Nch .GT. 0)                                                     PLTREP 581
     &    WRITE (IREPFL) IFOUR,IUNIQ,IONE,ISIX,IZERO                            PLTREP 582
c              boilers                                                          PLTREP 583
        DO  Neq=1,Nbl                                                           PLTREP 584
          Jbl = Ibl + (Neq-1)*Lbl                                               PLTREP 585
          Jpe = <bl;Jpe>                                                        PLTREP 586
c              pointer to hw loop                                               PLTREP 587
          Jlp = <bl:HW-LOOP>                                                    PLTREP 588
          WRITE(IREPFL)  I29,IUNIQ,IONE,ISEVEN,I25,                             PLTREP 589
     &      (<bl:NAME>,II=1,8),                                                 PLTREP 590
     &      (BLRtypes(II,<bl:TYPE>),II=1,4),                                    PLTREP 591
     &      (<lp:NAME>,II=1,8),                                                 PLTREP 592
     &      <bl:CAP>,<pe;DES_GPM>,                                              PLTREP 593
     &      <bl:EIR>,<bl:HIR>,<bl:AUX-KW>                                       PLTREP 594
        ENDDO                                                                   PLTREP 595
c              chillers                                                         PLTREP 596
        DO  Neq=1,Nch                                                           PLTREP 597
          Jch = Ich + (Neq-1)*Lch                                               PLTREP 598
          Jpe = <ch;Jpe>                                                        PLTREP 599
c              pointer to chilled-water loop                                    PLTREP 600
          Jlp = <ch:CHW-LOOP>                                                   PLTREP 601
          WRITE(IREPFL)  I29, IUNIQ,IONE,ISEVEN,I25,                            PLTREP 602
     &      (<ch:NAME>,II=1,8),                                                 PLTREP 603
     &      (CHLRtypes(II,<ch:TYPE>),II=1,4),                                   PLTREP 604
     &      (<lp:NAME>,II=1,8),<ch:CAP>,<pe;DES_GPM>,                           PLTREP 605
     &      <ch:EIR>,<ch:HIR>,<ch:AUX-KW>                                       PLTREP 606
          IF (<ch:CW-LOOP> .NE. 0)  THEN                                        PLTREP 607
c              condenser water loop                                             PLTREP 608
            Jlp = <ch:CW-LOOP>                                                  PLTREP 609
            WRITE(IREPFL)  I14, IUNIQ,IONE,IEIGHT,ITEN,                         PLTREP 610
     &        (<lp:NAME>,II=1,8),<ch;DES_QCOND>,                                PLTREP 611
     &        <ch;DES_CW_GPM>                                                   PLTREP 612
          ENDIF                                                                 PLTREP 613
          IF (<ch:HW-LOOP> .NE. 0)  THEN                                        PLTREP 614
c              hot water loop                                                   PLTREP 615
            Jlp = <ch:HW-LOOP>                                                  PLTREP 616
            WRITE(IREPFL)  I14, IUNIQ,IONE,IEIGHT,ITEN,                         PLTREP 617
     &        (<lp:NAME>,II=1,8),<ch;DES_FUEL>,                                 PLTREP 618
     &        <ch;DES_HW_GPM>                                                   PLTREP 619
          ENDIF                                                                 PLTREP 620
          IF (<ch:HTREC-LOOP> .NE. 0)  THEN                                     PLTREP 621
c              heat recovery loop                                               PLTREP 622
            Jlp = <ch:HTREC-LOOP>                                               PLTREP 623
            WRITE(IREPFL)  I14, IUNIQ,IONE,IEIGHT,ITEN,                         PLTREP 624
     &        (<lp:NAME>,II=1,8),<ch;DES_QHTREC>,                               PLTREP 625
     &        <ch;DES_HTR_GPM>                                                  PLTREP 626
          ENDIF                                                                 PLTREP 627
        ENDDO                                                                   PLTREP 628
c              cooling towers                                                   PLTREP 629
        IF (Ntw .GT. 0)  THEN                                                   PLTREP 630
          WRITE (IREPFL) IFOUR,IUNIQ,IONE,ININE,IZERO                           PLTREP 631
          DO  Neq=1,Ntw                                                         PLTREP 632
            Jtw = Itw + (Neq-1)*Ltw                                             PLTREP 633
            Jpe = <tw;Jpe>                                                      PLTREP 634
c              pointer to condenser-water loop                                  PLTREP 635
            Jlp = <tw:CW-LOOP>                                                  PLTREP 636
            WRITE(IREPFL)  I30,IUNIQ,IONE,ITEN,I26,                             PLTREP 637
     &        (<tw:NAME>,II=1,8),                                               PLTREP 638
     &        (TWRtypes(II,<tw:TYPE>),II=1,4),                                  PLTREP 639
     &        (<lp:NAME>,II=1,8),<tw:CAPACITY>,<pe;DES_GPM>,                    PLTREP 640
     &        INT(<tw:NUM-CELLS>),<tw:FAN-KW/CELL>,<tw;SPRAY_KW/CELL>,          PLTREP 641
     &        <tw:AUX-KW>                                                       PLTREP 642
          ENDDO                                                                 PLTREP 643
        ENDIF                                                                   PLTREP 644
c              domestic water heaters                                           PLTREP 645
        IF (Ndw .GT. 0)  THEN                                                   PLTREP 646
          WRITE (IREPFL) IFOUR,IUNIQ,IONE,I11,IZERO                             PLTREP 647
          DO  Neq=1,Ndw                                                         PLTREP 648
            Jdw = Idw + (Neq-1)*Ldw                                             PLTREP 649
            Jpe = <dw;Jpe>                                                      PLTREP 650
c              pointer to DHW loop                                              PLTREP 651
            Jlp = <dw:DHW-LOOP>                                                 PLTREP 652
            WRITE(IREPFL)  I31,IUNIQ,IONE,I12,I27,                              Bug40  290
     &        (<dw:NAME>,II=1,8),                                               Bug40  291
     &        (DHWtypes(II,<dw:TYPE>),II=1,4),                                  PLTREP 654
     &        (<lp:NAME>,II=1,8),                                               PLTREP 655
     &        <dw:CAP>,<pe;DES_GPM>,<dw:EIR>,                                   PLTREP 656
     &        <dw:HIR>,<dw:AUX-KW>,<dw:VOLUME>,<dw:TANK-UA>                     PLTREP 657
          ENDDO                                                                 PLTREP 658
        ENDIF                                                                   PLTREP 659
c              generators                                                       PLTREP 660
C       DO  Neq=1,Ngn                                                           PLTREP 661
C         Jgn = Ign + (Neq-1)*Lgn                                               PLTREP 662
c              design recoverable heat                                          PLTREP 663
C         Qhtrec = 0.                                                           PLTREP 664
C         IF (<gn:EXH-LOOP> .GT. 0)  THEN                                       PLTREP 665
C           Jpe = <gn;Jpe_Exhaust>                                              PLTREP 666
C           Qhtrec = Qhtrec + <pe;DES_RECOVER_Q>                                PLTREP 667
C         ENDIF                                                                 PLTREP 668
C         IF (<gn:JAC-LOOP> .GT. 0  .AND.                                       PLTREP 669
C    &        <gn:JAC-LOOP> .NE. <gn:EXH-LOOP> )  THEN                          PLTREP 670
C           Jpe = <gn;Jpe_Jacket>                                               PLTREP 671
C           Qhtrec = Qhtrec + <pe;DES_RECOVER_Q>                                PLTREP 672
C         ENDIF                                                                 PLTREP 673
c              pointer to elec meter                                            PLTREP 674
C         IF (<gn:ELEC-METER> .GT. 0)  THEN                                     PLTREP 675
C           Jem = <gn:ELEC-METER>                                               PLTREP 676
C         ELSE                                                                  PLTREP 677
C           Jem = <gn:SURPLUS-METER>                                            PLTREP 678
C         ENDIF                                                                 PLTREP 679
C         WRITE(IREPFL)  I28,IUNIQ,IONE,I?????,I24,                             PLTREP 680
C    &      (<gn:NAME>,II=1,8),                                                 PLTREP 681
C    &      (GENtypes(II,<gn:TYPE>),II=1,4),                                    PLTREP 682
C    &      (<em:NAME>,II=1,8),                                                 PLTREP 683
C    &      <gn:CAP>,<gn:HIR>,<gn:AUX-KW>,Qhtrec                                PLTREP 684
C       ENDDO                                                                   PLTREP 685
c              thermal storage                                                  PLTREP 686
        IF (Ntk .GT. 0)  THEN                                                   PLTREP 687
          WRITE (IREPFL) IFOUR,IUNIQ,IONE,I13,IZERO                             PLTREP 688
          DO  Neq=1,Ntk                                                         PLTREP 689
            Jtk = Itk + (Neq-1)*Ltk                                             PLTREP 690
            Jpe = <tk;Jpe>                                                      PLTREP 691
c              pointer to discharge loop                                        PLTREP 692
            Jlp = <tk:DCHRG-LOOP>                                               PLTREP 693
            WRITE(IREPFL) I19,IUNIQ,IONE,I14,I15,                               PLTREP 694
     &        (TEStypes(II,<tk:TYPE>),II=1,4),                                  PLTREP 695
     &        (<lp:NAME>,II=1,8), <tk:MAX-DCHRG-RAT>, <pe;DES_GPM>,             PLTREP 696
     &                            <tk:CAP>                                      PLTREP 697
            Jlp = <tk:CHRG-LOOP>                                                PLTREP 698
            WRITE(IREPFL) I14,IUNIQ,IONE,I15,ITEN,                              PLTREP 699
     &        (<lp:NAME>,II=1,8), <tk:MAX-CHRG-RATE>,                           PLTREP 700
     &        <tk:MAX-CHRG-RATE> / (<lp;BTUH/GPM-F>*<lp:DESIGN-DT>)             PLTREP 701
          ENDDO                                                                 PLTREP 702
        ENDIF                                                                   PLTREP 703
        WRITE (IREPFL) ITWO, IUNIQ, ISEVEN                                      PLTREP 704
c              end of PV-A                                                      PLTREP 705
      ENDIF                                                                     PLTREP 706
c                                                                               PLTREP 707
c              Skip summary reports if no run is to be made                     PLTREP 708
      IF ((IREPRT(3,15) .EQ. 1).or.(IREPRT(2,15) .EQ. 1)) RETURN                -033    18
c                                                                               PLTREP 710
c              PS-A                                                             PLTREP 711
      IF (IREPRT(3,16) .GT. 0)  THEN                                            PLTREP 712
        IUNIQ = IREPRT(3,16)                                                    PLTREP 713
        WRITE (IREPFL) IFOUR, IUNIQ, IONE, IONE, IZERO                          PLTREP 714
        WRITE (IREPFL) IFOUR, IUNIQ, IONE, ITWO, IZERO                          PLTREP 715
      ENDIF                                                                     PLTREP 716
c                                                                               PLTREP 717
c              PS-B                                                             PLTREP 718
      IF (IREPRT(3,17) .GT. 0)  THEN                                            PLTREP 719
        IUNIQ = IREPRT(3,17)                                                    PLTREP 720
        WRITE (IREPFL) I16, IUNIQ, IONE, IONE, I12,                             PLTREP 721
     &    (MONDSC(I),I=1,12)                                                    PLTREP 722
      ENDIF                                                                     PLTREP 723
c                                                                               PLTREP 724
c              PS-C                                                             PLTREP 725
      IF (IREPRT(3,18) .GT. 0)  THEN                                            PLTREP 726
        IUNIQ = IREPRT(3,18)                                                    PLTREP 727
        WRITE (IREPFL) IFOUR, IUNIQ, IONE, IONE, IZERO                          PLTREP 728
      ENDIF                                                                     PLTREP 729
c                                                                               PLTREP 730
c              PS-D - no initial records                                        PLTREP 731
c                                                                               PLTREP 732
c              PS-E, one report for each meter type                             PLTREP 733
      IF (IREPRT(3,20) .GT. 0)  THEN                                            PLTREP 734
        IUNIQ = IREPRT(3,20)                                                    PLTREP 735
c              electric meters                                                  PLTREP 736
        IF (Nem .GT. 0)  THEN                                                   PLTREP 737
          WRITE(IREPFL) I22,IUNIQ,ISIX,                                         PLTREP 738
     &      TitlePSE, ElecMeter, NoDesign                                       PLTREP 739
          WRITE(IREPFL)  IFOUR, IUNIQ, IONE, IONE, IZERO                        PLTREP 740
          IUNIQ = IUNIQ + 1                                                     PLTREP 741
          IF (KtvTDV2(1) .gt. 0)  THEN  ! TDV2 report                           -044    37
            WRITE(IREPFL)  IFOUR, IUNIQ, IONE, IONE, IZERO                      -044    38
            IUNIQ = IUNIQ + 1                                                   -044    39
          ENDIF                                                                 -044    40
        ENDIF                                                                   PLTREP 742
c              fuel meters                                                      PLTREP 743
        IF (Nfm .GT. 0)  THEN                                                   PLTREP 744
          WRITE(IREPFL) I22,IUNIQ,ISIX,                                         PLTREP 745
     &      TitlePSE, FuelMeter, NoDesign                                       PLTREP 746
          WRITE(IREPFL)  IFOUR, IUNIQ, IONE, IONE, IZERO                        PLTREP 747
          IUNIQ = IUNIQ + 1                                                     PLTREP 748
          IF (KtvTDV2(2) .gt. 0)  THEN  ! TDV2 report                           -044    41
            WRITE(IREPFL)  IFOUR, IUNIQ, IONE, IONE, IZERO                      -044    42
            IUNIQ = IUNIQ + 1                                                   -044    43
          ENDIF                                                                 -044    44
        ENDIF                                                                   PLTREP 749
c              purchased steam meters                                           PLTREP 750
        IF (Nsm .GT. 0)  THEN                                                   PLTREP 751
          WRITE(IREPFL) I22,IUNIQ,ISIX,                                         PLTREP 752
     &      TitlePSE, StmMeter, NoDesign                                        PLTREP 753
          WRITE(IREPFL)  IFOUR, IUNIQ, IONE, IONE, IZERO                        PLTREP 754
          IUNIQ = IUNIQ + 1                                                     PLTREP 755
        ENDIF                                                                   PLTREP 756
c             purchased chilled-water meters                                    PLTREP 757
        IF (Ncm .GT. 0)  THEN                                                   PLTREP 758
          WRITE(IREPFL) I22,IUNIQ,ISIX,                                         PLTREP 759
     &      TitlePSE, CHWMeter, NoDesign                                        PLTREP 760
          WRITE(IREPFL)  IFOUR, IUNIQ, IONE, IONE, IZERO                        PLTREP 761
        ENDIF                                                                   PLTREP 762
      ENDIF                                                                     PLTREP 763
c                                                                               PLTREP 764
c              PS-F, one report for each meter                                  PLTREP 765
      IF (IREPRT(3,21) .GT. 0)  THEN                                            PLTREP 766
c              electric meters                                                  PLTREP 767
        DO IM=1,Nem                                                             PLTREP 768
          Jem = Iem + (IM-1)*Lem                                                PLTREP 769
          IF (<em:REPORT> .NE. 0)  THEN                                         PLTREP 770
            WRITE(IREPFL) I22,<em:REPORT>,ISIX,                                 PLTREP 771
     &        TitlePSF, (<em:NAME>,II=1,8), NoDesign                            PLTREP 772
            WRITE(IREPFL)  IFOUR, <em:REPORT>, IONE, IONE, IZERO                PLTREP 773
            IF (<em;Ktv> .gt. 0)  THEN  ! TDV3 report                           -044    45
              Ktv = <em;Ktv>                                                    -044    46
              WRITE(IREPFL) I22, <tv;Iuniq>, ISIX,                              -044    47
     &          TitleTDV3, (<em:NAME>,II=1,8), NoDesign                         -044    48
              WRITE(IREPFL)  IFOUR, <tv;Iuniq>, IONE, IONE, IZERO               -044    49
            ENDIF                                                               -044    50
          ENDIF                                                                 PLTREP 774
        ENDDO                                                                   PLTREP 775
c              fuel meters                                                      PLTREP 776
        DO IM=1,Nfm                                                             PLTREP 777
          Jfm = Ifm + (IM-1)*Lfm                                                PLTREP 778
          IF (<fm:REPORT> .NE. 0)  THEN                                         PLTREP 779
            WRITE(IREPFL) I22,<fm:REPORT>,ISIX,                                 PLTREP 780
     &        TitlePSF, (<fm:NAME>,II=1,8), NoDesign                            PLTREP 781
            WRITE(IREPFL)  IFOUR, <fm:REPORT>, IONE, IONE, IZERO                PLTREP 782
            IF (<fm;Ktv> .gt. 0)  THEN  ! TDV3 report                           -044    51
              Ktv = <fm;Ktv>                                                    -044    52
              WRITE(IREPFL) I22, <tv;Iuniq>, ISIX,                              -044    53
     &          TitleTDV3, (<fm:NAME>,II=1,8), NoDesign                         -044    54
              WRITE(IREPFL)  IFOUR, <tv;Iuniq>, IONE, IONE, IZERO               -044    55
            ENDIF                                                               -044    56
          ENDIF                                                                 PLTREP 783
        ENDDO                                                                   PLTREP 784
c              steam meters                                                     PLTREP 785
        DO IM=1,Nsm                                                             PLTREP 786
          Jsm = Ism + (IM-1)*Lsm                                                PLTREP 787
          IF (<sm:REPORT> .NE. 0)  THEN                                         PLTREP 788
            WRITE(IREPFL) I22,<sm:REPORT>,ISIX,                                 PLTREP 789
     &        TitlePSF, (<sm:NAME>,II=1,8), NoDesign                            PLTREP 790
            WRITE(IREPFL)  IFOUR, <sm:REPORT>, IONE, IONE, IZERO                PLTREP 791
          ENDIF                                                                 PLTREP 792
        ENDDO                                                                   PLTREP 793
c              chilled-water meters                                             PLTREP 794
        DO IM=1,Ncm                                                             PLTREP 795
          Jcm = Icm + (IM-1)*Lcm                                                PLTREP 796
          IF (<cm:REPORT> .NE. 0)  THEN                                         PLTREP 797
            WRITE(IREPFL) I22,<cm:REPORT>,ISIX,                                 PLTREP 798
     &        TitlePSF, (<cm:NAME>,II=1,8), NoDesign                            PLTREP 799
            WRITE(IREPFL)  IFOUR, <cm:REPORT>, IONE, IONE, IZERO                PLTREP 800
          ENDIF                                                                 PLTREP 801
        ENDDO                                                                   PLTREP 802
      ENDIF                                                                     PLTREP 803
c                                                                               PLTREP 804
c              BEPS                                                             PLTREP 805
      IF (IREPRT(3,26) .GT. 0)  THEN                                            PLTREP 806
        IUNIQ = IREPRT(3,26)                                                    PLTREP 807
        WRITE (IREPFL) IFOUR, IUNIQ, IONE, IONE, IZERO                          PLTREP 808
        IF (ITDV .gt. 0)  WRITE (IREPFL) IFOUR, IUNIQ+1, IONE,IONE,IZERO        -044    57
      ENDIF                                                                     PLTREP 809
c                                                                               PLTREP 810
c              BEPU                                                             PLTREP 811
      IF (IREPRT(3,27) .GT.  0)  THEN                                           PLTREP 812
        IUNIQ = IREPRT(3,27)                                                    PLTREP 813
        WRITE (IREPFL) IFOUR, IUNIQ, IONE, IONE, IZERO                          PLTREP 814
      ENDIF                                                                     PLTREP 815
c                                                                               PLTREP 816
c              Summary reports specific to each component                       PLTREP 817
c              circulation loops                                                PLTREP 818
      DO  NL=1,Nlp                                                              PLTREP 819
        Jlp   = Ilp + (NL-1)*Llp                                                PLTREP 820
        IUNIQ = <lp;PS-H_IUNIQ>                                                 PLTREP 821
        IF (IUNIQ .GT. 0)  THEN                                                 PLTREP 822
          WRITE(IREPFL) I22,IUNIQ,ISIX,                                         PLTREP 823
     &      TitlePSH, (<lp:NAME>,II=1,8), NoDesign                              PLTREP 824
          WRITE(IREPFL) I14,IUNIQ,IONE,IONE,ITEN,                               PLTREP 825
     &      <lp;DES_HCAP>, <lp;DES_CCAP>, <lp;DES_GPM>,                         PLTREP 826
     &      <lp;DES_HEAD>, <lp:SUPPLY-UA>,                                      PLTREP 827
     &      <lp:SLOSS-DT>, <lp:RETURN-UA>, <lp:RLOSS-DT>,                       PLTREP 828
     &      <lp:FLUID-VOL>, <lp;BTUH/GPM-F>/(60.*8.34)                          PLTREP 829
          WRITE(IREPFL) IFOUR,IUNIQ,IONE,ITWO,IZERO                             PLTREP 830
        ENDIF                                                                   PLTREP 831
      ENDDO                                                                     PLTREP 832
c              pumps                                                            PLTREP 833
      DO  Neq=1,Npm                                                             PLTREP 834
        Jpm   = Ipm + (Neq-1)*Lpm                                               PLTREP 835
        IUNIQ = <pm;PS-H_IUNIQ>                                                 PLTREP 836
        IF (IUNIQ .GT. 0)  THEN                                                 PLTREP 837
          NumPump = INT(<pm:NUMBER>+.1)                                         PLTREP 838
          WRITE(IREPFL) I22,IUNIQ,ISIX,                                         PLTREP 839
     &      TitlePSH, (<pm:NAME>,II=1,8), NoDesign                              PLTREP 840
          WRITE(IREPFL) IFIVE,IUNIQ,IONE,IONE,IONE,                             PLTREP 841
     &      NumPump                                                             PLTREP 842
c              pointer to attached loop or primary equipment                    PLTREP 843
          Jlp = <pm;ATTACH>                                                     PLTREP 844
c              capacity control index                                           PLTREP 845
          ICAP = <pm:CAP-CTRL> * MIN(NumPump, 2)                                PLTREP 846
          WRITE(IREPFL) I21,IUNIQ,IONE,ITWO,I17,                                PLTREP 847
     &      (<lp:NAME>,II=1,8),                                                 PLTREP 848
     &      <pm;TOTAL_GPM>, <pm:HEAD>, <pm:HEAD-SETPT>,                         PLTREP 849
     &      (PMPCTRL(II,ICAP),II=1,3), <pm;TOTAL_KW>,                           PLTREP 850
     &      <pm:MECH-EFF>, <pm:MOTOR-EFF>                                       PLTREP 851
          IF (<pm;ATTACH_TYPE> .GT. 2)  THEN                                    PLTREP 852
            WRITE (IREPFL) I11,IUNIQ,IONE,ISIX,ISEVEN,                          PLTREP 853
     &        (ATTACH(II,<pm;ATTACH_TYPE>),II=1,4),                             PLTREP 854
     &        (EquipPumpType(I,<pm;TYPE>),I=1,3)                                PLTREP 855
          ELSE                                                                  PLTREP 856
            WRITE (IREPFL) I11,IUNIQ,IONE,ISIX,ISEVEN,                          PLTREP 857
     &        (ATTACH(II,<pm;ATTACH_TYPE>),II=1,4),                             PLTREP 858
     &        (Blank,II=1,3)                                                    PLTREP 859
          ENDIF                                                                 PLTREP 860
          WRITE(IREPFL) IFOUR,IUNIQ,IONE,ITHREE,IZERO                           PLTREP 861
        ENDIF                                                                   PLTREP 862
      ENDDO                                                                     PLTREP 863
c              boilers                                                          PLTREP 864
      DO  Neq=1,Nbl                                                             PLTREP 865
        Jbl   = Ibl + (Neq-1)*Lbl                                               PLTREP 866
        Jpe   = <bl;Jpe>                                                        PLTREP 867
        IUNIQ = <pe;PS-H_IUNIQ>                                                 PLTREP 868
        IF (IUNIQ .GT. 0)  THEN                                                 PLTREP 869
          WRITE(IREPFL) I22,IUNIQ,ISIX,                                         PLTREP 870
     &      TitlePSH, (<bl:NAME>,II=1,8), NoDesign                              PLTREP 871
          WRITE(IREPFL)  IFOUR,IUNIQ,IONE,IONE,IZERO                            PLTREP 872
c              pointer to hw loop                                               PLTREP 873
          Jlp = <bl:HW-LOOP>                                                    PLTREP 874
          WRITE(IREPFL)  I21,IUNIQ,IONE,ITWO,I17,                               PLTREP 875
     &      (BLRtypes(II,<bl:TYPE>),II=1,4),                                    PLTREP 876
     &      (<lp:NAME>,II=1,8),                                                 PLTREP 877
     &      <bl:CAP>, <pe;DES_GPM>,                                             PLTREP 878
     &      <bl:EIR>, <bl:HIR>, <bl:AUX-KW>                                     PLTREP 879
          WRITE(IREPFL) IFOUR,IUNIQ,IONE,ITHREE,IZERO                           PLTREP 880
        ENDIF                                                                   PLTREP 881
      ENDDO                                                                     PLTREP 882
c              chillers                                                         PLTREP 883
      DO  Neq=1,Nch                                                             PLTREP 884
        Jch   = Ich + (Neq-1)*Lch                                               PLTREP 885
        Jpe   = <ch;Jpe>                                                        PLTREP 886
c ?quck IUNIQ = <pe;PS-H_IUNIQ>                                                 PLTREP 887
        IUNIQ = <ch;PS-H_IUNIQ>                                                 PLTREP 888
        IF (IUNIQ .GT. 0)  THEN                                                 PLTREP 889
          WRITE(IREPFL) I22,IUNIQ,ISIX,                                         PLTREP 890
     &      TitlePSH, (<ch:NAME>,II=1,8), NoDesign                              PLTREP 891
          WRITE(IREPFL)  IFOUR,IUNIQ,IONE,IONE,IZERO                            PLTREP 892
c              pointer to chilled-water loop                                    PLTREP 893
          Jlp = <ch:CHW-LOOP>                                                   PLTREP 894
          IF (<ch:HIR> .GT. 0.)  THEN                                           PLTREP 895
            WRITE(IREPFL)  I21, IUNIQ,IONE,ITWO,I17,                            PLTREP 896
     &        (CHLRtypes(II,<ch:TYPE>),II=1,4),                                 PLTREP 897
     &        (<lp:NAME>,II=1,8), <ch:CAP>, <pe;DES_GPM>,                       PLTREP 898
     &        <ch:EIR>, <ch:HIR>, <ch:AUX-KW>                                   PLTREP 899
          ELSE                                                                  PLTREP 900
            WRITE(IREPFL)  I20, IUNIQ,IONE,ITWO,I16,                            PLTREP 901
     &        (CHLRtypes(II,<ch:TYPE>),II=1,4),                                 PLTREP 902
     &        (<lp:NAME>,II=1,8), <ch:CAP>, <pe;DES_GPM>,                       PLTREP 903
     &        <ch:EIR>, <ch:AUX-KW>                                             PLTREP 904
          ENDIF                                                                 PLTREP 905
          IF (<ch:CW-LOOP> .NE. 0)  THEN                                        PLTREP 906
c              condenser water loop                                             PLTREP 907
            Jlp = <ch:CW-LOOP>                                                  PLTREP 908
            WRITE(IREPFL)  I14, IUNIQ,IONE,ITHREE,ITEN,                         PLTREP 909
     &        (<lp:NAME>,II=1,8), <ch;DES_QCOND>,                               PLTREP 910
     &        <ch;DES_CW_GPM>                                                   PLTREP 911
          ENDIF                                                                 PLTREP 912
          IF (<ch:HW-LOOP> .NE. 0)  THEN                                        PLTREP 913
c              hot water loop                                                   PLTREP 914
            Jlp = <ch:HW-LOOP>                                                  PLTREP 915
            WRITE(IREPFL)  I14, IUNIQ,IONE,IFOUR,ITEN,                          PLTREP 916
     &        (<lp:NAME>,II=1,8), <ch;DES_FUEL>,                                PLTREP 917
     &        <ch;DES_HW_GPM>                                                   PLTREP 918
          ENDIF                                                                 PLTREP 919
          IF (<ch:HTREC-LOOP> .NE. 0)  THEN                                     PLTREP 920
c              heat recovery loop                                               PLTREP 921
            Jlp = <ch:HTREC-LOOP>                                               PLTREP 922
            WRITE(IREPFL)  I14, IUNIQ,IONE,IFIVE,ITEN,                          PLTREP 923
     &        (<lp:NAME>,II=1,8), <ch;DES_QHTREC>,                              PLTREP 924
     &        <ch;DES_HTR_GPM>                                                  PLTREP 925
          ENDIF                                                                 PLTREP 926
          WRITE(IREPFL) IFOUR,IUNIQ,IONE,ISIX,IZERO                             PLTREP 927
        ENDIF                                                                   PLTREP 928
      ENDDO                                                                     PLTREP 929
c              cooling towers                                                   PLTREP 930
      DO  Neq=1,Ntw                                                             PLTREP 931
        Jtw   = Itw + (Neq-1)*Ltw                                               PLTREP 932
        Jpe   = <tw;Jpe>                                                        PLTREP 933
c ?quck IUNIQ = <pe;PS-H_IUNIQ>                                                 PLTREP 934
        IUNIQ = <tw;PS-H_IUNIQ>                                                 PLTREP 935
        IF (IUNIQ .GT. 0)  THEN                                                 PLTREP 936
          WRITE(IREPFL) I22,IUNIQ,ISIX,                                         PLTREP 937
     &      TitlePSH, (<tw:NAME>,II=1,8), NoDesign                              PLTREP 938
          WRITE(IREPFL) IFOUR,IUNIQ,IONE,IONE,IZERO                             PLTREP 939
c              pointer to condenser-water loop                                  PLTREP 940
          Jlp = <tw:CW-LOOP>                                                    PLTREP 941
          WRITE(IREPFL) I22,IUNIQ,IONE,ITWO,I18,                                PLTREP 942
     &      (TWRtypes(II,<tw:TYPE>),II=1,4),                                    PLTREP 943
     &      (<lp:NAME>,II=1,8), <tw:CAPACITY>, <pe;DES_GPM>,                    PLTREP 944
     &      INT(<tw:NUM-CELLS>), <tw:FAN-KW/CELL>, <tw;SPRAY_KW/CELL>,          PLTREP 945
     &      <tw:AUX-KW>                                                         PLTREP 946
          WRITE(IREPFL) IFOUR,IUNIQ,IONE,ITHREE,IZERO                           PLTREP 947
        ENDIF                                                                   PLTREP 948
      ENDDO                                                                     PLTREP 949
c              tower free cooling                                               PLTREP 950
c     DO  Neq=1,NFC                                                             PV      74
c       JFC = IFC + (Neq-1)*LFC                                                 PV      75
c       IF (<TFC_PS-H_IUNIQ> .GT. 0)  THEN                                      PV      76
c         WRITE(IREPFL) I22,IUNIQ,ISIX,                                         PV      77
c    &      TitlePSH, (<TFC-NAME>,II=1,8), NoDesign                             PV      78
c       ENDIF                                                                   PV      79
c     ENDDO                                                                     PV      80
c              domestic water heaters                                           PLTREP 958
      DO  Neq=1,Ndw                                                             PLTREP 959
        Jdw   = Idw + (Neq-1)*Ldw                                               PLTREP 960
        Jpe   = <dw;Jpe>                                                        PLTREP 961
c ?quck IUNIQ = <pe;PS-H_IUNIQ>                                                 PLTREP 962
        IUNIQ = <dw;PS-H_IUNIQ>                                                 PLTREP 963
        IF (IUNIQ .GT. 0)  THEN                                                 PLTREP 964
          WRITE(IREPFL) I22,IUNIQ,ISIX,                                         PLTREP 965
     &      TitlePSH, (<dw:NAME>,II=1,8), NoDesign                              PLTREP 966
          WRITE(IREPFL) IFOUR,IUNIQ,IONE,IONE,IZERO                             PLTREP 967
c              pointer to DHW loop                                              PLTREP 968
          Jlp = <dw:DHW-LOOP>                                                   PLTREP 969
          WRITE(IREPFL) I23,IUNIQ,IONE,ITWO,I19,                                PLTREP 970
     &      (DHWtypes(II,<dw:TYPE>),II=1,4),                                    PLTREP 971
     &      (<lp:NAME>,II=1,8),                                                 PLTREP 972
     &      <dw:CAP>, <pe;DES_GPM>,                                             PLTREP 973
     &      <dw:EIR>, <dw:HIR>, <dw:AUX-KW>, <dw:VOLUME>, <dw:TANK-UA>          PLTREP 974
          WRITE(IREPFL) IFOUR,IUNIQ,IONE,ITHREE,IZERO                           PLTREP 975
        ENDIF                                                                   PLTREP 976
      ENDDO                                                                     PLTREP 977
c              generators                                                       PLTREP 978
      DO  Neq=1,Ngn                                                             PLTREP 979
        Jgn   = Ign + (Neq-1)*Lgn                                               PLTREP 980
        Jpe   = <gn;Jpe>                                                        PLTREP 981
        IUNIQ = <pe;PS-H_IUNIQ>                                                 PLTREP 982
        IF (IUNIQ .GT. 0)  THEN                                                 PLTREP 983
          WRITE(IREPFL) I22,IUNIQ,ISIX,                                         PLTREP 984
     &      TitlePSH, (<gn:NAME>,II=1,8), NoDesign                              PLTREP 985
          IF (<gn:TYPE> .NE. 4)  THEN                                           PV      81
            WRITE(IREPFL)  IFOUR,IUNIQ,IONE,IONE,IZERO                          PV      82
c              design recoverable heat                                          PV      83
            Qhtrec = 0.                                                         PV      84
            IF (<gn:EXH-LOOP> .GT. 0)  THEN                                     PV      85
              Jpe = <gn;Jpe_Exhaust>                                            PV      86
              Qhtrec = Qhtrec + <pe;DES_RECOVER_Q>                              PV      87
            ENDIF                                                               PV      88
            IF (<gn:JAC-LOOP> .GT. 0  .AND.                                     PV      89
     &          <gn:JAC-LOOP> .NE. <gn:EXH-LOOP>)  THEN                         PV      90
              Jpe = <gn;Jpe_Jacket>                                             PV      91
              Qhtrec = Qhtrec + <pe;DES_RECOVER_Q>                              PV      92
            ENDIF                                                               PV      93
c              pointer to elec meter                                            PV      94
            Jem = <gn:ELEC-METER>                                               PV      95
            WRITE(IREPFL)  I20,IUNIQ,IONE,ITWO,I16,                             PV      96
     &        (GENtypes(II,<gn:TYPE>),II=1,4),                                  PV      97
     &        (<em:NAME>,II=1,8),                                               PV      98
     &        <gn:CAP>,<gn:HIR>,<gn:AUX-KW>,Qhtrec                              PV      99
            WRITE(IREPFL) IFOUR,IUNIQ,IONE,ITHREE,IZERO                         PV     100
          ELSE                                                                  PV     101
c              Photovoltaic Array                                               PV     102
            WRITE(IREPFL)  IFOUR,IUNIQ,IONE,ISIX,IZERO                          PV     103
c              design recoverable heat                                          PV     104
            Qhtrec = 0.                                                         PV     105
c              pointer to elec meter                                            PV     106
            Jem = <gn:ELEC-METER>                                               PV     107
            WRITE(IREPFL)  I21,IUNIQ,IONE,ISEVEN,I17,                           PV     108
     &        (GENtypes(II,<gn:TYPE>),II=1,4),                                  PV     109
     &        (<em:NAME>,II=1,8),                                               PV     110
     &        <gn:CAP>,<gn:NUM-INVERTERS>,<gn:EIR>,<gn:AUX-KW>,Qhtrec           PV     111
            WRITE(IREPFL) IFOUR,IUNIQ,IONE,IEIGHT,IZERO                         PV     112
          ENDIF                                                                 PV     113
        ENDIF                                                                   PLTREP1005
      ENDDO                                                                     PLTREP1006
c              PV modules                                                       PV     114
      DO  Neq=1,Npv                                                             PV     115
        Jpv   = Ipv + (Neq-1)*Lpv                                               PV     116
        Jpe   = <pv;Jpe>                                                        PV     117
        IUNIQ = <pe;PS-H_IUNIQ>                                                 PV     118
        IF (IUNIQ .GT. 0)  THEN                                                 PV     119
          WRITE(IREPFL) I22,IUNIQ,ISIX,                                         PV     120
     &      TitlePSH, (<pv:NAME>,II=1,8), NoDesign                              PV     121
          WRITE(IREPFL)  IFOUR,IUNIQ,IONE,IONE,IZERO                            PV     122
c              pointer to pv array                                              PV     123
          DO Neq1=1,Ngn                                                         PV     124
            Jgn = Ign + (Neq-1)*Lgn                                             PV     125
            IF (<gn:PV-MODULE> .EQ. Jpv)  EXIT                                  PV     126
          ENDDO                                                                 PV     127
          Cap = <pv:VOLTS-MAX-PWR> * <pv:AMPS-MAX-PWR> * 0.001                  PV     128
          WRITE(IREPFL)  I20,IUNIQ,IONE,ITWO,I16,                               PV     129
     &      (PVtypes(II,<pv:TYPE>),II=1,4),                                     PV     130
     &      (<gn:NAME>,II=1,8),                                                 PV     131
     &      Cap, <pv:EFFICIENCY>, <pv:VOLTS-MAX-PWR>, <pv:AMPS-MAX-PWR>         PV     132
          WRITE(IREPFL) IFOUR,IUNIQ,IONE,ITHREE,IZERO                           PV     133
        ENDIF                                                                   PV     134
      ENDDO                                                                     PV     135
c              thermal storage                                                  PLTREP1007
      DO  Neq=1,Ntk                                                             PLTREP1008
        Jtk   = Itk + (Neq-1)*Ltk                                               PLTREP1009
        Jpe   = <tk;Jpe>                                                        PLTREP1010
c ?quck IUNIQ = <pe;PS-H_IUNIQ>                                                 PLTREP1011
        IUNIQ = <tk;PS-H_IUNIQ>                                                 PLTREP1012
        IF (IUNIQ .GT. 0)  THEN                                                 PLTREP1013
          WRITE(IREPFL) I22,IUNIQ,ISIX,                                         PLTREP1014
     &      TitlePSH, (<tk:NAME>,II=1,8), NoDesign                              PLTREP1015
          WRITE(IREPFL) IFOUR,IUNIQ,IONE,IONE,IZERO                             PLTREP1016
c              pointer to discharge loop                                        PLTREP1017
          Jlp = <tk:DCHRG-LOOP>                                                 PLTREP1018
          WRITE(IREPFL) I19,IUNIQ,IONE,ITWO,I15,                                PLTREP1019
     &      (TEStypes(II,<tk:TYPE>),II=1,4),                                    PLTREP1020
     &      (<lp:NAME>,II=1,8), <tk:MAX-DCHRG-RAT>, <pe;DES_GPM>,               PLTREP1021
     &                          <tk:CAP>                                        PLTREP1022
          Jlp = <tk:CHRG-LOOP>                                                  PLTREP1023
          WRITE(IREPFL) I14,IUNIQ,IONE,ITHREE,ITEN,                             PLTREP1024
     &      (<lp:NAME>,II=1,8), <tk:MAX-CHRG-RATE>,                             PLTREP1025
     &      <tk:MAX-CHRG-RATE> / (<lp;BTUH/GPM-F>*<lp:DESIGN-DT>)               PLTREP1026
          WRITE(IREPFL)  IFOUR, IUNIQ,IONE,IFOUR,IZERO                          PLTREP1027
        ENDIF                                                                   PLTREP1028
      ENDDO                                                                     PLTREP1029
c              Ground-loop heat exchangers                                      -044e5  21
      DO Neq=1,Ngl                                                              -044e5  22
        Jgl = Igl + (Neq-1)*Lgl                                                 -044e5  23
        Jpe = <gl;Jpe>                                                          -044e5  24
        IF (<gl;PS-H_IUNIQ> .EQ. 0)  Cycle                                      -044e5  25
        WRITE(IREPFL) I22,<gl;PS-H_IUNIQ>,ISIX,                                 -044e5  26
     &    TitlePSH, (<gl:NAME>,II=1,8), NoDesign                                -044e5  27
      ENDDO                                                                     -044e5  28
c              Ice Rinks                                                        IcRink 853
      DO  NS=1,NSYS                                                             IcRink 854
        NSP = IS + (NS-1)*NSS                                                   IcRink 855
        IF (<sy;IceRink> .GT. 0)  THEN                                          IcRink 856
          ISZ = <ISZONES>                                                       IcRink 857
          NSZ = <NZONES>                                                        IcRink 858
          DO  NZ=1,NSZ                                                          IcRink 859
            ZP1 = ISZ + (NZ-1)*NZD                                              IcRink 860
            ZP2 = <ZP2>                                                         IcRink 861
            IF (<zn:ICE-RINK> .GT. 0)  THEN                                     IcRink 862
              CALL IceRink(53, <zn:ICE-RINK>)                                   IcRink 863
              CALL IceRink(54, <zn:ICE-RINK>)                                   IcRink 864
            ENDIF                                                               IcRink 865
          ENDDO                                                                 IcRink 866
        ENDIF                                                                   IcRink 867
      ENDDO                                                                     IcRink 868
c                                                                               PLTREP1030
c              End of report initialization                                     PLTREP1031
      RETURN                                                                    PLTREP1032
c                                                                               PLTREP1033
c                                                                               PLTREP1034
c============= MONTHLY RECORDS ================================================ PLTREP1035
      CASE (29)                                                                 PLTREP1036
c              Write monthly report records                                     PLTREP1037
c                                                                               PLTREP1038
c              PS-A                                                             PLTREP1039
      IF (IREPRT(3,16) .GT. 0)  THEN                                            PLTREP1040
        IUNIQ = IREPRT(3,16)                                                    PLTREP1041
        WRITE (IREPFL) I18, IUNIQ, IONE, ITHREE, I14,                           PLTREP1042
     &    MONDSC(IMO), (PSA(I,1), I=1,13)                                       PLTREP1043
      ENDIF                                                                     PLTREP1044
c                                                                               PLTREP1045
c              PS-B, PS-C, PS-D                                                 PLTREP1046
c              no monthly records are written, only yearly                      PLTREP1047
c                                                                               PLTREP1048
c              PS-E, one report for each meter type                             HVAC29  38
      IF (IREPRT(3,20) .GT. 0)  THEN                                            HVAC29  39
        IUNIQ = IREPRT(3,20)                                                    HVAC29  40
c              electric meters                                                  HVAC29  41
        IF (Nem .GT. 0)  THEN                                                   HVAC29  42
          IF (EndUsePeaks(20,1,IELEC) .GT. 0.) THEN                             -047k   29
            Pct = 100. / EndUsePeaks(20,1,IELEC)                                -047k   30
          ELSE                                                                  -047k   31
            Pct = 0.                                                            -047k   32
          ENDIF                                                                 -047k   33
          WRITE(IREPFL)  I81, IUNIQ, IONE, ITWO, I77,                           HVAC29  45
     &      MONDSC(IMO), (EndUses(IE,1,IELEC),IE=1,12),                         HVAC29  46
     $                    EndUses(20,1,IELEC),                                  HVAC29  47
     &                   (EndUsePeaks(IE,1,IELEC),IE=1,12),                     HVAC29  48
     &                    EndUsePeaks(20,1,IELEC),                              HVAC29  49
     &      (EndPeakDay(IE,1,IELEC),EndPeakHour(IE,1,IELEC),IE=1,12),           HVAC29  50
     &       EndPeakDay(20,1,IELEC),EndPeakHour(20,1,IELEC),                    HVAC29  51
     &      (EndUseAtPeak(IE,1,IELEC),IE=1,12),                                 HVAC29  52
     &      (EndUseAtPeak(IE,1,IELEC)*Pct,IE=1,12)                              HVAC29  53
          IUNIQ = IUNIQ + 1                                                     HVAC29  54
          IF (KtvTDV2(1) .gt. 0)  THEN  ! TDV2 report                           -044    58
            Ktv = KtvTDV2(1)                                                    -044    59
            WRITE(IREPFL) I70, IUNIQ, IONE, ITWO, I66,                          -044    60
     &        MONDSC(IMO),                                                      -044    61
     &        (<tv.EndUseMo>,IE=1,12),<tv.TotMo>,                               -044    62
     &        (<tv.EndUseMoM>,IE=1,12),<tv.TotMoM>,                             -044    63
     &        (<tv.EndUseMoDy>, <tv.EndUseMoHr>,IE=1,12),                       -044    64
     &         <tv.TotMoDy>, <tv.TotMoHr>,                                      -044    65
     &        (<tv.EndUseMo>/Max(0.0001,EndUses(IE,1,IELEC)),IE=1,12),          -044    66
     &         <tv.TotMo>/Max(0.0001,EndUses(20,1,IELEC))                       -044    67
            IUNIQ = IUNIQ + 1                                                   -044    68
          ENDIF  ! KtvTDV2(1)                                                   -044    69
        ENDIF                                                                   HVAC29  55
c              fuel meters                                                      HVAC29  56
        IF (Nfm .GT. 0)  THEN                                                   HVAC29  57
          IF (EndUsePeaks(20,1,IFUEL) .GT. 0.) THEN                             -047k   34
            Pct = 100. / EndUsePeaks(20,1,IFUEL)                                -047k   35
          ELSE                                                                  -047k   36
            Pct = 0.                                                            -047k   37
          ENDIF                                                                 -047k   38
          WRITE(IREPFL)  I81, IUNIQ, IONE, ITWO, I77,                           HVAC29  60
     &      MONDSC(IMO), (EndUses(IE,1,IFUEL),IE=1,12),                         HVAC29  61
     &                    EndUses(20,1,IFUEL),                                  HVAC29  62
     &                   (EndUsePeaks(IE,1,IFUEL),IE=1,12),                     HVAC29  63
     &                    EndUsePeaks(20,1,IFUEL),                              HVAC29  64
     &      (EndPeakDay(IE,1,IFUEL),EndPeakHour(IE,1,IFUEL),IE=1,12),           HVAC29  65
     &       EndPeakDay(20,1,IFUEL),EndPeakHour(20,1,IFUEL),                    HVAC29  66
     &      (EndUseAtPeak(IE,1,IFUEL),IE=1,12),                                 HVAC29  67
     &      (EndUseAtPeak(IE,1,IFUEL)*Pct,IE=1,12)                              HVAC29  68
          IUNIQ = IUNIQ + 1                                                     HVAC29  69
          IF (KtvTDV2(2) .gt. 0)  THEN  ! TDV2 report                           -044    70
            Ktv = KtvTDV2(2)                                                    -044    71
            WRITE(IREPFL) I70, IUNIQ, IONE, ITWO, I66,                          -044    72
     &        MONDSC(IMO),                                                      -044    73
     &        (<tv.EndUseMo>,IE=1,12),<tv.TotMo>,                               -044    74
     &        (<tv.EndUseMoM>,IE=1,12),<tv.TotMoM>,                             -044    75
     &        (<tv.EndUseMoDy>, <tv.EndUseMoHr>,IE=1,12),                       -044    76
     &         <tv.TotMoDy>, <tv.TotMoHr>,                                      -044    77
     &        (<tv.EndUseMo>/Max(0.0001,EndUses(IE,1,IFUEL)),IE=1,12),          -044    78
     &         <tv.TotMo>/Max(0.0001,EndUses(20,1,IFUEL))                       -044    79
            IUNIQ = IUNIQ + 1                                                   -044    80
          ENDIF  ! KtvTDV2(2)                                                   -044    81
        ENDIF                                                                   HVAC29  70
c              purchased steam meters                                           HVAC29  71
        IF (Nsm .GT. 0)  THEN                                                   HVAC29  72
          IF (EndUsePeaks(20,1,ISTM) .GT. 0.) THEN                              -047k   39
            Pct = 100. / EndUsePeaks(20,1,ISTM)                                 -047k   40
          ELSE                                                                  -047k   41
            Pct = 0.                                                            -047k   42
          ENDIF                                                                 -047k   43
          WRITE(IREPFL)  I81, IUNIQ, IONE, ITWO, I77,                           HVAC29  75
     &      MONDSC(IMO), (EndUses(IE,1,ISTM),IE=1,12),                          HVAC29  76
     &                    EndUses(20,1,ISTM),                                   HVAC29  77
     &                   (EndUsePeaks(IE,1,ISTM),IE=1,12),                      HVAC29  78
     &                    EndUsePeaks(20,1,ISTM),                               HVAC29  79
     &      (EndPeakDay(IE,1,ISTM),EndPeakHour(IE,1,ISTM),IE=1,12),             HVAC29  80
     &       EndPeakDay(20,1,ISTM),EndPeakHour(20,1,ISTM),                      HVAC29  81
     &      (EndUseAtPeak(IE,1,ISTM),IE=1,12),                                  HVAC29  82
     &      (EndUseAtPeak(IE,1,ISTM)*Pct,IE=1,12)                               HVAC29  83
          IUNIQ = IUNIQ + 1                                                     HVAC29  84
        ENDIF                                                                   HVAC29  85
c             purchased chilled-water meters                                    HVAC29  86
        IF (Ncm .GT. 0)  THEN                                                   HVAC29  87
          IF (EndUsePeaks(20,1,ICHW) .GT. 0.) THEN                              -047k   44
            Pct = 100. / EndUsePeaks(20,1,ICHW)                                 -047k   45
          ELSE                                                                  -047k   46
            Pct = 0.                                                            -047k   47
          ENDIF                                                                 -047k   48
          WRITE(IREPFL)  I81, IUNIQ, IONE, ITWO, I77,                           HVAC29  90
     &      MONDSC(IMO), (EndUses(IE,1,ICHW),IE=1,12),                          HVAC29  91
     &                    EndUses(20,1,ICHW),                                   HVAC29  92
     &                   (EndUsePeaks(IE,1,ICHW),IE=1,12),                      HVAC29  93
     &                    EndUsePeaks(20,1,ICHW),                               HVAC29  94
     &      (EndPeakDay(IE,1,ICHW),EndPeakHour(IE,1,ICHW),IE=1,12),             HVAC29  95
     &       EndPeakDay(20,1,ICHW),EndPeakHour(20,1,ICHW),                      HVAC29  96
     &      (EndUseAtPeak(IE,1,ICHW),IE=1,12),                                  HVAC29  97
     &      (EndUseAtPeak(IE,1,ICHW)*Pct,IE=1,12)                               HVAC29  98
        ENDIF                                                                   HVAC29  99
      ENDIF                                                                     HVAC29 100
c                                                                               HVAC29 101
c              PS-F, one report for each meter                                  HVAC29 102
      IF (IREPRT(3,21) .GT. 0)  THEN                                            HVAC29 103
c              electric meters                                                  HVAC29 104
        DO  IM=1,Nem                                                            HVAC29 105
          Jem = Iem + (IM-1)*Lem                                                HVAC29 106
          IF (<em:REPORT> .NE. 0)  THEN                                         HVAC29 107
c              conversion for peak percent                                      HVAC29 108
            IF (<em;TOTALMOM> .NE. 0.)  THEN                                    HVAC29 109
              Pct = 100.0 / <em;TOTALMOM>                                       HVAC29 110
            ELSE                                                                HVAC29 111
              Pct = 0.                                                          HVAC29 112
            ENDIF                                                               HVAC29 113
            WRITE(IREPFL) I85, <em:REPORT>, IONE, ITWO, I81,                    HVAC29 114
     &        MONDSC(IMO),                                                      HVAC29 115
     &        (JUNITT(I,<em:UNIT-INDEX>,IUNIT),I=1,2),                          HVAC29 116
     &         (<em;METERSMO>,IE=1,12),<em;TOTALMO>,                            HVAC29 117
     &        (JUNITT(I,<em:DEM-INDEX>,IUNIT),I=1,2),                           HVAC29 118
     &        (<em;METERSMOM>,IE=1,12),<em;TOTALMOM>,                           HVAC29 119
     &        (<em;METERSMOMDY>, <em;METERSMOMHR>,IE=1,12),                     HVAC29 120
     &         <em;TOTALMOMDY>, <em;TOTALMOMHR>,                                HVAC29 121
     &        (<em;EndUsePeakMo>,IE=1,12),                                      HVAC29 122
     &        (<em;EndUsePeakMo>*Pct,IE=1,12)                                   HVAC29 123
            IF (<em;Ktv> .gt. 0)  THEN  ! TDV3 report                           -044    82
              Ktv = <em;Ktv>                                                    -044    83
              WRITE(IREPFL) I73, <tv;Iuniq>, IONE, ITWO, I69,                   -044    84
     &          MONDSC(IMO),                                                    -044    85
     &          (<tv.EndUseMo>,IE=1,12),<tv.TotMo>,                             -044    86
     &          (<tv.EndUseMoM>,IE=1,12),<tv.TotMoM>,                           -044    87
     &          (<tv.EndUseMoDy>, <tv.EndUseMoHr>,IE=1,12),                     -044    88
     &           <tv.TotMoDy>, <tv.TotMoHr>,                                    -044    89
     &          (<tv.EndUseMo>/Max(0.0001,<em;METERSMO>),IE=1,12),              -044    90
     &           <tv.TotMo>/Max(0.0001,<em;TOTALMO>),                           -044    91
     &           <tv.TDVmaxMo>, <tv.TDVminMo>,                                  -044    92
     &           <tv.TDVavgMo>/Max(1.,<tv.TDVhrsMo>)                            -044    93
            ENDIF  ! em;Ktv                                                     -044    94
          ENDIF                                                                 HVAC29 124
        ENDDO                                                                   HVAC29 125
c              fuel meters                                                      HVAC29 126
        DO  IM=1,Nfm                                                            HVAC29 127
          Jfm = Ifm + (IM-1)*Lfm                                                HVAC29 128
          IF (<fm:REPORT> .NE. 0)  THEN                                         HVAC29 129
c              conversion for peak percent                                      HVAC29 130
            IF (<fm;TOTALMOM> .NE. 0.)  THEN                                    HVAC29 131
              Pct = 100.0 / <fm;TOTALMOM>                                       HVAC29 132
            ELSE                                                                HVAC29 133
              Pct = 0.                                                          HVAC29 134
            ENDIF                                                               HVAC29 135
            WRITE(IREPFL) I85, <fm:REPORT>, IONE, ITWO, I81,                    HVAC29 136
     &        MONDSC(IMO),                                                      HVAC29 137
     &        (JUNITT(I,<fm:UNIT-INDEX>,IUNIT),I=1,2),                          HVAC29 138
     &        (<fm;METERSMO>*<fm:BTU/UNIT>,IE=1,12),                            HVAC29 139
     &         <fm;TOTALMO>*<fm:BTU/UNIT>,                                      HVAC29 140
     &        (JUNITT(I,<fm:DEM-INDEX>,IUNIT),I=1,2),                           HVAC29 141
     &        (<fm;METERSMOM>*<fm:BTU/UNIT>,IE=1,12),                           HVAC29 142
     &         <fm;TOTALMOM>*<fm:BTU/UNIT>,                                     HVAC29 143
     &        (<fm;METERSMOMDY>, <fm;METERSMOMHR>,IE=1,12),                     HVAC29 144
     &         <fm;TOTALMOMDY>, <fm;TOTALMOMHR>,                                HVAC29 145
     &        (<fm;EndUsePeakMo>*<fm:BTU/UNIT>,IE=1,12),                        HVAC29 146
     &        (<fm;EndUsePeakMo>*Pct,IE=1,12)                                   HVAC29 147
            IF (<fm;Ktv> .gt. 0)  THEN  ! TDV3 report                           -044    95
              Ktv = <fm;Ktv>                                                    -044    96
              WRITE(IREPFL) I73, <tv;Iuniq>, IONE, ITWO, I69,                   -044    97
     &          MONDSC(IMO),                                                    -044    98
     &          (<tv.EndUseMo>,IE=1,12),<tv.TotMo>,                             -044    99
     &          (<tv.EndUseMoM>,IE=1,12),<tv.TotMoM>,                           -044   100
     &          (<tv.EndUseMoDy>, <tv.EndUseMoHr>,IE=1,12),                     -044   101
     &           <tv.TotMoDy>, <tv.TotMoHr>,                                    -044   102
     &          (<tv.EndUseMo> / Max(0.0001,<fm;METERSMO>),IE=1,12),            -044   103
     &           <tv.TotMo>/Max(0.0001,<fm;TOTALMO>),                           -044   104
     &           <tv.TDVmaxMo>, <tv.TDVminMo>,                                  -044   105
     &           <tv.TDVavgMo>/Max(1.,<tv.TDVhrsMo>)                            -044   106
            ENDIF  ! fm;Ktv                                                     -044   107
          ENDIF                                                                 HVAC29 148
        ENDDO                                                                   HVAC29 149
c              steam meters                                                     HVAC29 150
        DO  IM=1,Nsm                                                            HVAC29 151
          Jsm = Ism + (IM-1)*Lsm                                                HVAC29 152
          IF (<sm:REPORT> .NE. 0)  THEN                                         HVAC29 153
c              conversion for peak percent                                      HVAC29 154
            IF (<sm;TOTALMOM> .NE. 0.)  THEN                                    HVAC29 155
              Pct = 100.0 / <sm;TOTALMOM>                                       HVAC29 156
            ELSE                                                                HVAC29 157
              Pct = 0.                                                          HVAC29 158
            ENDIF                                                               HVAC29 159
            WRITE(IREPFL) I85, <sm:REPORT>, IONE, ITWO, I81,                    HVAC29 160
     &        MONDSC(IMO),                                                      HVAC29 161
     &        (JUNITT(I,<sm:UNIT-INDEX>,IUNIT),I=1,2),                          HVAC29 162
     &        (<sm;METERSMO>*<sm:BTU/UNIT>,IE=1,12),                            HVAC29 163
     &         <sm;TOTALMO>*<sm:BTU/UNIT>,                                      HVAC29 164
     &        (JUNITT(I,<sm:DEM-INDEX>,IUNIT),I=1,2),                           HVAC29 165
     &        (<sm;METERSMOM>*<sm:BTU/UNIT>,IE=1,12),                           HVAC29 166
     &         <sm;TOTALMOM>*<sm:BTU/UNIT>,                                     HVAC29 167
     &        (<sm;METERSMOMDY>, <sm;METERSMOMHR>,IE=1,12),                     HVAC29 170
     &         <sm;TOTALMOMDY>, <sm;TOTALMOMHR>,                                HVAC29 171
     &        (<sm;EndUsePeakMo>*<sm:BTU/UNIT>,IE=1,12),                        HVAC29 172
     &        (<sm;EndUsePeakMo>*Pct,IE=1,12)                                   HVAC29 173
          ENDIF                                                                 HVAC29 174
        ENDDO                                                                   HVAC29 175
c              chilled-water meters                                             HVAC29 176
        DO  IM=1,Ncm                                                            HVAC29 177
          Jcm = Icm + (IM-1)*Lcm                                                HVAC29 178
          IF (<cm:REPORT> .NE. 0)  THEN                                         HVAC29 179
c              conversion for peak percent                                      HVAC29 180
            IF (<cm;TOTALMOM> .NE. 0.)  THEN                                    HVAC29 181
              Pct = 100.0 / <cm;TOTALMOM>                                       HVAC29 182
            ELSE                                                                HVAC29 183
              Pct = 0.                                                          HVAC29 184
            ENDIF                                                               HVAC29 185
            WRITE(IREPFL) I85, <cm:REPORT>, IONE, ITWO, I81,                    HVAC29 186
     &        MONDSC(IMO),                                                      HVAC29 187
     &        (JUNITT(I,<cm:UNIT-INDEX>,IUNIT),I=1,2),                          HVAC29 188
     &        (<cm;METERSMO>*<cm:BTU/UNIT>,IE=1,12),                            HVAC29 189
     &         <cm;TOTALMO>*<cm:BTU/UNIT>,                                      HVAC29 190
     &        (JUNITT(I,<cm:DEM-INDEX>,IUNIT),I=1,2),                           HVAC29 191
     &        (<cm;METERSMOM>*<cm:BTU/UNIT>,IE=1,12),                           HVAC29 192
     &         <cm;TOTALMOM>*<cm:BTU/UNIT>,                                     HVAC29 193
     &        (<cm;METERSMOMDY>, <cm;METERSMOMHR>,IE=1,12),                     HVAC29 196
     &         <cm;TOTALMOMDY>, <cm;TOTALMOMHR>,                                HVAC29 197
     &        (<cm;EndUsePeakMo>*<cm:BTU/UNIT>,IE=1,12),                        HVAC29 198
     &        (<cm;EndUsePeakMo>*Pct,IE=1,12)                                   HVAC29 199
          ENDIF                                                                 HVAC29 200
        ENDDO                                                                   HVAC29 201
      ENDIF                                                                     HVAC29 202
c                                                                               PLTREP1193
c              BEPS, BEPU - no monthly records                                  PLTREP1194
c                                                                               PLTREP1195
c              circulation loops                                                PLTREP1196
      DO  NL=1,Nlp                                                              PLTREP1197
        Jlp = Ilp + (NL-1)*Llp                                                  PLTREP1198
        IUNIQ = <lp;PS-H_IUNIQ>                                                 PLTREP1199
        IF (IUNIQ .GT. 0)  THEN                                                 PLTREP1200
          LoopType = <lp:TYPE>                                                  PLTREP1201
          WRITE(IREPFL) IFOUR,IUNIQ,IONE,ITHREE,IZERO                           PLTREP1202
          IF (LoopType .NE. WLHP)  THEN                                         PLTREP1203
            IF (LoopType .NE. CHW  .AND.  LoopType .NE. CW)  THEN               PLTREP1204
              WRITE(IREPFL) I45  ,IUNIQ,IONE,IFOUR,I41,MONDSC(IMO),             PLTREP1205
     &          <lp;COILHMO>,     <lp;LOSSHMO>,     <lp;TOTALHMO>,              PLTREP1206
     &          <lp;OVRLDHMO>,    (<lp;QHPLRMO>,II=1,12),                       PLTREP1207
     &          <lp;COILHMOM>,    <lp;LOSSHMOM>,    <lp;TOTALHMOM>,             PLTREP1208
     &          <lp;OVRLDHMOM>,  (<lp;GPMHPLRMO>,II=1,12),                      PLTREP1209
     &          <lp;COILHMOMDY>,  <lp;COILHMOMHR>,  <lp;LOSSHMOMDY>,            PLTREP1210
     &          <lp;LOSSHMOMHR>,  <lp;TOTALHMOMDY>, <lp;TOTALHMOMHR>,           PLTREP1211
     &          <lp;OVRLDHMOMDY>, <lp;OVRLDHMOMHR>                              PLTREP1212
            ENDIF                                                               PLTREP1213
            IF (LoopType .EQ. CHW  .OR.  LoopType .EQ. CW                       PLTREP1214
     &                             .OR.  LoopType .EQ. PIPE2)  THEN             PLTREP1215
              WRITE(IREPFL) I45  ,IUNIQ,IONE,IFIVE,I41,MONDSC(IMO),             PLTREP1216
     &          <lp;COILCMO>,    <lp;LOSSCMO>,      <lp;TOTALCMO>,              PLTREP1217
     &          <lp;OVRLDCMO>,    (<lp;QCPLRMO>,II=1,12),                       PLTREP1218
     &          <lp;COILCMOM>,    <lp;LOSSCMOM>,    <lp;TOTALCMOM>,             PLTREP1219
     &          <lp;OVRLDCMOM>,   (<lp;GPMCPLRMO>,II=1,12),                     PLTREP1220
     &          <lp;COILCMOMDY>,  <lp;COILCMOMHR>,  <lp;LOSSCMOMDY>,            PLTREP1221
     &          <lp;LOSSCMOMHR>,  <lp;TOTALCMOMDY>, <lp;TOTALCMOMHR>,           PLTREP1222
     &          <lp;OVRLDCMOMDY>, <lp;OVRLDCMOMHR>                              PLTREP1223
            ENDIF                                                               PLTREP1224
          ELSE                                                                  PLTREP1225
c              wlhp has its own report                                          PLTREP1226
c              heating dominated and coincident cooling                         PLTREP1227
            WRITE(IREPFL) I49  ,IUNIQ,IONE,IFOUR,I45,MONDSC(IMO),               PLTREP1228
     &        <lp;COILHMO>,     <lp;COILHCMO>, <lp;LOSSHMO>,                    PLTREP1229
     &        <lp;TOTALHMO>,    <lp;OVRLDHMO>,                                  PLTREP1230
     &                                         (<lp;QHPLRMO>,II=1,12),          PLTREP1231
     &        <lp;COILHMOM>,    <lp;COILHCMOM>, <lp;LOSSHMOM>,                  PLTREP1232
     &        <lp;TOTALHMOM>,   <lp;OVRLDHMOM>,                                 PLTREP1233
     &                                         (<lp;GPMHPLRMO>,II=1,12),        PLTREP1234
     &        <lp;COILHMOMDY>,  <lp;COILHMOMHR>,                                PLTREP1235
     &        <lp;COILHCMOMDY>, <lp;COILHCMOMHR>,                               PLTREP1236
     &        <lp;LOSSHMOMDY>,  <lp;LOSSHMOMHR>,                                PLTREP1237
     &        <lp;TOTALHMOMDY>, <lp;TOTALHMOMHR>,                               PLTREP1238
     &        <lp;OVRLDHMOMDY>, <lp;OVRLDHMOMHR>                                PLTREP1239
c              cooling dominated and coincident heating                         PLTREP1240
            WRITE(IREPFL) I49  ,IUNIQ,IONE,IFIVE,I45,MONDSC(IMO),               PLTREP1241
     &        <lp;COILCHMO>,    <lp;COILCMO>,   <lp;LOSSCMO>,                   PLTREP1242
     &        <lp;TOTALCMO>,    <lp;OVRLDCMO>,                                  PLTREP1243
     &                                         (<lp;QCPLRMO>,II=1,12),          PLTREP1244
     &        <lp;COILCHMOM>,   <lp;COILCMOM>,  <lp;LOSSCMOM>,                  PLTREP1245
     &        <lp;TOTALCMOM>,   <lp;OVRLDCMOM>,                                 PLTREP1246
     &                                         (<lp;GPMCPLRMO>,II=1,12),        PLTREP1247
     &        <lp;COILCHMOMDY>, <lp;COILCHMOMHR>,                               PLTREP1248
     &        <lp;COILCMOMDY>,  <lp;COILCMOMHR>,                                PLTREP1249
     &        <lp;LOSSCMOMDY>,  <lp;LOSSCMOMHR>,                                PLTREP1250
     &        <lp;TOTALCMOMDY>, <lp;TOTALCMOMHR>,                               PLTREP1251
     &        <lp;OVRLDCMOMDY>, <lp;OVRLDCMOMHR>                                PLTREP1252
c              heating and cooling while floating                               PLTREP1253
            WRITE(IREPFL) I30  ,IUNIQ,IONE,ISIX,I26,MONDSC(IMO),                PLTREP1254
     &        <lp;COILFHMO>,    <lp;COILFCMO>,  <lp;LOSSFMO>,                   PLTREP1255
     &                                          <lp;FLOATMO>,                   PLTREP1256
     &        <lp;COILFHMOM>,   <lp;COILFCMOM>, <lp;LOSSFMOM>,                  PLTREP1257
     &                                         (<lp;GPMFPLRMO>,II=1,12),        PLTREP1258
     &        <lp;COILFHMOMDY>, <lp;COILFHMOMHR>,                               PLTREP1259
     &        <lp;COILFCMOMDY>, <lp;COILFCMOMHR>,                               PLTREP1260
     &        <lp;LOSSFMOMDY>,  <lp;LOSSFMOMHR>                                 PLTREP1261
          ENDIF                                                                 PLTREP1262
        ENDIF                                                                   PLTREP1263
      ENDDO                                                                     PLTREP1264
c              pumps                                                            PLTREP1265
      DO  Neq=1,Npm                                                             PLTREP1266
        Jpm = Ipm + (Neq-1)*Lpm                                                 PLTREP1267
        IUNIQ = <pm;PS-H_IUNIQ>                                                 PLTREP1268
        IF (IUNIQ .GT. 0)                                                       PLTREP1269
     &    WRITE(IREPFL) I49,IUNIQ,IONE,IFOUR,I45,MONDSC(IMO),                   PLTREP1270
     &        <pm;QHMO>,     <pm;KWHMO>,  (<pm;GPMPLRMO>,II=1,12),              PLTREP1271
     &        <pm;QHMOM>,    <pm;KWHMOM>, (<pm;RPMPLRMO>,II=1,12),              PLTREP1272
     &        <pm;QHMOMDY>,  <pm;QHMOMHR>, <pm;KWHMOMDY>,                       PLTREP1273
     &        <pm;KWHMOMHR>,(<pm;KWHPLRMO>,II=1,12)                             PLTREP1274
      ENDDO                                                                     PLTREP1275
c                                                                               PLTREP1276
c              Reports using Jpe                                                PLTREP1277
      CALL PlantReports_Jpe(20)                                                 PLTREP1278
c                                                                               PLTREP1279
c              chillers                                                         PLTREP1280
      DO  Neq=1,Nch                                                             PLTREP1281
        Jch = Ich + (Neq-1)*Lch                                                 PLTREP1282
        Jpe = <ch;Jpe>                                                          PLTREP1283
c ?quck IUNIQ = <pe;PS-H_IUNIQ>                                                 PLTREP1284
        IUNIQ = <ch;PS-H_IUNIQ>                                                 PLTREP1285
        IF (IUNIQ .GT. 0)  THEN                                                 PLTREP1286
          IF (<ch:HIR> .GT. 0.)  THEN                                           PLTREP1287
            WRITE(IREPFL) I57,IUNIQ,IONE,ISEVEN,I53,MONDSC(IMO),                PLTREP1288
     &        <ch;QMO>, <ch;QRECVRMO>, <ch;KWHMO>, <ch;FUELMO>,                 PLTREP1289
     &                                         (<ch;QPLRMO>,II=1,12),           PLTREP1290
     &        <ch;QMOM>, <ch;QRECVRMOM>, <ch;KWHMOM>, <ch;FUELMOM>,             PLTREP1291
     &                                         (<ch;KWHPLRMO>,II=1,12),         PLTREP1292
     &        <ch;QMOMDY>, <ch;QMOMHR>,                                         PLTREP1293
     &        <ch;QRECVRMOMDY>, <ch;QRECVRMOMHR>,                               PLTREP1294
     &        <ch;KWHMOMDY>, <ch;KWHMOMHR>,                                     PLTREP1295
     &        <ch;FUELMOMDY>,<ch;FUELMOMHR>, (<ch;FUELPLRMO>,II=1,12)           PLTREP1296
          ELSE                                                                  PLTREP1297
            WRITE(IREPFL) I45,IUNIQ,IONE,ISEVEN,I41,MONDSC(IMO),                PLTREP1298
     &        <ch;QMO>, <ch;QRECVRMO>, <ch;KWHMO>, <ch;AUXMO>,                  PLTREP1299
     &                                         (<ch;QPLRMO>,II=1,12),           PLTREP1300
     &        <ch;QMOM>, <ch;QRECVRMOM>, <ch;KWHMOM>, <ch;AUXMOM>,              PLTREP1301
     &                                       (<ch;KWHPLRMO>,II=1,12),           PLTREP1302
     &        <ch;QMOMDY>,      <ch;QMOMHR>,                                    PLTREP1303
     &        <ch;QRECVRMOMDY>, <ch;QRECVRMOMHR>,                               PLTREP1304
     &        <ch;KWHMOMDY>,    <ch;KWHMOMHR>,                                  PLTREP1305
     &        <ch;AUXMOMDY>,    <ch;AUXMOMHR>                                   PLTREP1306
          ENDIF                                                                 PLTREP1307
        ENDIF                                                                   PLTREP1308
      ENDDO                                                                     PLTREP1309
c              cooling towers                                                   PLTREP1310
      DO  Neq=1,Ntw                                                             PLTREP1311
        Jtw = Itw + (Neq-1)*Ltw                                                 PLTREP1312
        Jpe = <tw;Jpe>                                                          PLTREP1313
c ?quck IUNIQ = <pe;PS-H_IUNIQ>                                                 PLTREP1314
        IUNIQ = <tw;PS-H_IUNIQ>                                                 PLTREP1315
        IF (IUNIQ .GT. 0)                                                       PLTREP1316
     &    WRITE(IREPFL) I45,IUNIQ,IONE,IFOUR,I41,MONDSC(IMO),                   PLTREP1317
     &        <tw;QMO>,   <tw;KWHMO>, <tw;AUXMO>, <tw;AUXHEATMO>,               PLTREP1318
     &                                          (<tw;QPLRMO>,II=1,12),          PLTREP1319
     &        <tw;QMOM>,  <tw;KWHMOM>, <tw;AUXMOM>, <tw;AUXHEATMOM>,            PLTREP1320
     &                                        (<tw;KWHPLRMO>,II=1,12),          PLTREP1321
     &        <tw;QMOMDY>,   <tw;QMOMHR>, <tw;KWHMOMDY>, <tw;KWHMOMHR>,         PLTREP1322
     &        <tw;AUXMOMDY>, <tw;AUXMOMHR>,                                     PLTREP1323
     &        <tw;AUXHEATMOMDY>, <tw;AUXHEATMOMHR>                              PLTREP1324
      ENDDO                                                                     PLTREP1325
c              tower free cooling                                               PLTREP1326
c     DO  Neq=1,NFC                                                             PV     136
c       JFC = IFC + (Neq-1)*LFC                                                 PV     137
c       IUNIQ = <TFC_PS-H_IUNIQ>                                                PV     138
c       IF (IUNIQ .GT. 0)                                                       PV     139
c    &    WRITE(IREPFL) IONE,IUNIQ,IONE,ITHREE,IONE,MONDSC(IMO),                PV     140
c    &                  QUCK                                                    PV     141
c     ENDDO                                                                     PV     142
c              domestic water heaters                                           PLTREP1334
      DO  Neq=1,Ndw                                                             PLTREP1335
        Jdw = Idw + (Neq-1)*Ldw                                                 PLTREP1336
        Jpe = <dw;Jpe>                                                          PLTREP1337
c ?quck IUNIQ = <pe;PS-H_IUNIQ>                                                 PLTREP1338
        IUNIQ = <dw;PS-H_IUNIQ>                                                 PLTREP1339
        IF (IUNIQ .GT. 0)                                                       PLTREP1340
     &    WRITE(IREPFL) I57,IUNIQ,IONE,IFOUR,I53,MONDSC(IMO),                   PLTREP1341
     &      <dw;QMO>, <dw;KWHMO>, <dw;FUELMO>, <dw;AUXMO>,                      PLTREP1342
     &                                          (<dw;QPLRMO>,II=1,12),          PLTREP1343
     &      <dw;QMOM>, <dw;KWHMOM>, <dw;FUELMOM>, <dw;AUXMOM>,                  PLTREP1344
     &                                        (<dw;KWHPLRMO>,II=1,12),          PLTREP1345
     &      <dw;QMOMDY>, <dw;QMOMHR>, <dw;KWHMOMDY>, <dw;KWHMOMHR>,             PLTREP1346
     &      <dw;FUELMOMDY>,<dw;FUELMOMHR>,<dw;AUXMOMDY>,<dw;AUXMOMHR>,          PLTREP1347
     &                                       (<dw;FUELPLRMO>,II=1,12)           PLTREP1348
      ENDDO                                                                     PLTREP1349
c              thermal storage                                                  PLTREP1350
      DO  Neq=1,Ntk                                                             PLTREP1351
        Jtk = Itk + (Neq-1)*Ltk                                                 PLTREP1352
        Jpe = <tk;Jpe>                                                          PLTREP1353
c ?quck IUNIQ = <pe;PS-H_IUNIQ>                                                 PLTREP1354
        IUNIQ = <tk;PS-H_IUNIQ>                                                 PLTREP1355
        IF (IUNIQ .GT. 0)                                                       PLTREP1356
     &    WRITE(IREPFL) I44,IUNIQ,IONE,IFIVE,I40,MONDSC(IMO),                   PLTREP1357
     &      <tk;DCHRG_MO>, <tk;CHRG_MO>, <tk;LOSS_MO>, <tk;AUX_MO>,             PLTREP1358
     &                                      (<tk;DCHRG_PLR_MO>,II=1,12),        PLTREP1359
     &      <tk;DCHRG_MOM>, <tk;CHRG_MOM>, <tk;LOSS_MOM>, <tk;AUX_MOM>,         PLTREP1360
     &                                      (<tk;CHRG_PLR_MO>,II=1,12),         PLTREP1361
     &      <tk;DCHRG_MOM_DY>,<tk;DCHRG_MOM_HR>,                                PLTREP1362
     &      <tk;CHRG_MOM_DY>,<tk;CHRG_MOM_HR>,                                  PLTREP1363
     &      <tk;LOSS_MOM_DY>,<tk;LOSS_MOM_HR>,                                  PLTREP1364
     &      <tk;AUX_MOM_DY>,<tk;AUX_MOM_HR>                                     PLTREP1365
      ENDDO                                                                     PLTREP1366
c              Ground-loop heat exchangers                                      -044e5  29
      DO Neq=1,Ngl                                                              -044e5  30
        Jgl = Igl + (Neq-1)*Lgl                                                 -044e5  31
        Jpe = <gl;Jpe>                                                          -044e5  32
        IF (<gl;PS-H_IUNIQ> .EQ. 0)  Cycle                                      -044e5  33
        IF (<gl;PrintDesign> .EQ. 0) THEN                                       -044e5  34
          <gl;PrintDesign> = 1                                                  -044e5  35
          IF (<gl:PIPE-IN-DIA> .gt. 0.) THEN                                    -044e5  36
            Velocity = <pe;DES_GPM>/<gl;NUM_WELLS> * 8.34/(62.4*60.)            -044e5  37
     &               / (3.1415927 * (<gl:PIPE-IN-DIA>/2.)**2)                   -044e5  38
          ELSE                                                                  -044e5  39
            Velocity = -888.                                                    -044e5  40
          ENDIF                                                                 -044e5  41
          WRITE(IREPFL) Ieight,<gl;PS-H_IUNIQ>,Ione,Ione,Ifour,                 -044e5  42
     &      <pe;DES_GPM>/Max(1.0,<gl;NUM_WELLS>),                               -045    41
     &      Velocity, <pe;DES_HEAD>, <gl;Rborehole>                             -044e5  44
          WRITE(IREPFL) I26,<gl;PS-H_IUNIQ>,Ione,Itwo,I22,                      -044e5  45
     &      ((10.*I),I=2,12), ((10.*I),I=2,12)                                  -044e5  46
        ENDIF                                                                   -044e5  47
        WRITE(IREPFL) I43,<gl;PS-H_IUNIQ>,Ione,Ithree,I39, MONDSC(IMO),         -044e5  48
     &    <gl.Cool_Mo>,   <gl.Heat_Mo>, (<gl.CoolT_Mo>,II=1,13),                -044e5  49
     &                    <gl.CoolTmax_Mo>, <gl.CoolTmin_Mo>,                   -044e5  50
     &    <gl.Cool_MoM>,  <gl.Heat_MoM>, (<gl.HeatT_Mo>,II=1,13),               -044e5  51
     &                    <gl.HeatTmax_Mo>, <gl.HeatTmin_Mo>,                   -044e5  52
     &    <gl.Cool_MoDy>, <gl.Cool_MoHr>,                                       -044e5  53
     &    <gl.Heat_MoDy>, <gl.Heat_MoHr>                                        -044e5  54
      ENDDO                                                                     -044e5  55
c              Ice Rinks                                                        IcRink 869
      DO  NS=1,NSYS                                                             IcRink 870
        NSP = IS + (NS-1)*NSS                                                   IcRink 871
        IF (<sy;IceRink> .GT. 0)  THEN                                          IcRink 872
          ISZ = <ISZONES>                                                       IcRink 873
          NSZ = <NZONES>                                                        IcRink 874
          DO  NZ=1,NSZ                                                          IcRink 875
            ZP1 = ISZ + (NZ-1)*NZD                                              IcRink 876
            ZP2 = <ZP2>                                                         IcRink 877
            IF (<zn:ICE-RINK> .GT. 0)  CALL IceRink(55, <zn:ICE-RINK>)          IcRink 878
          ENDDO                                                                 IcRink 879
        ENDIF                                                                   IcRink 880
      ENDDO                                                                     IcRink 881
c                                                                               PLTREP1367
c              end of monthly report records                                    PLTREP1368
      RETURN                                                                    PLTREP1369
c                                                                               PLTREP1370
c                                                                               PLTREP1371
c============= YEARLY RECORDS ================================================= PLTREP1372
      CASE (39)                                                                 PLTREP1373
c                                                                               PLTREP1374
c              PS-A                                                             PLTREP1375
      IF (IREPRT(3,16) .GT. 0)  THEN                                            PLTREP1376
        IUNIQ = IREPRT(3,16)                                                    PLTREP1377
        WRITE (IREPFL) I17, IUNIQ, IONE, IFOUR, I13,                            PLTREP1378
     &    (PSA(I,2), I=1,13)                                                    PLTREP1379
        WRITE (IREPFL) ITWO, IUNIQ, ISEVEN                                      PLTREP1380
      ENDIF                                                                     PLTREP1381
c                                                                               PLTREP1382
c              PS-B                                                             PLTREP1383
      IF (IREPRT(3,17) .GT. 0)  THEN                                            PLTREP1384
        IUNIQ = IREPRT(3,17)                                                    PLTREP1385
        II = 1                                                                  PLTREP1386
        DO  IM=1,Nem                                                            PLTREP1387
          Jem = Iem + (IM-1)*Lem                                                PLTREP1388
          IF (<em:TYPE> .NE. SellMeter)  THEN                                   PLTREP1389
            WRITE (IREPFL) I66, IUNIQ, IONE, ITWO, I62,                         PLTREP1390
     &          <em:NAME>,(MeterType(I,1),I=1,4),                               PLTREP1391
     &          (JUNITT(I,<em:UNIT-INDEX>,IUNIT),I=1,3),                        PLTREP1392
     &          (<em;PSB-ENGY>,MO=1,12),<em;PSB-ENGYYR>,                        PLTREP1393
     &          (JUNITT(I,<em:DEM-INDEX>,IUNIT),I=1,2),                         PLTREP1394
     &          (<em;PSB-PEAK>,MO=1,12),<em;PSB-PEAKYR>,                        PLTREP1395
     &          (<em;PSB-DAY>,<em;PSB-HR>,MO=1,12),                             PLTREP1396
     &           <em;PSB-MOYR>, <em;PSB-DAYYR>                                  PLTREP1397
          ELSE                                                                  PLTREP1398
            WRITE (IREPFL) I66, IUNIQ, IONE, ITWO, I62,                         PLTREP1399
     &          <em:NAME>,(MeterType(I,5),I=1,4),                               PLTREP1400
     &          (JUNITT(I,<em:UNIT-INDEX>,IUNIT),I=1,3),                        PLTREP1401
     &          (-<em;PSB-ENGY>,MO=1,12),-<em;PSB-ENGYYR>,                      PLTREP1402
     &          (JUNITT(I,<em:DEM-INDEX>,IUNIT),I=1,2),                         PLTREP1403
     &          (-<em;PSB-PEAK>,MO=1,12),-<em;PSB-PEAKYR>,                      PLTREP1404
     &          (<em;PSB-DAY>,<em;PSB-HR>,MO=1,12),                             PLTREP1405
     &           <em;PSB-MOYR>, <em;PSB-DAYYR>                                  PLTREP1406
          ENDIF                                                                 PLTREP1407
        ENDDO                                                                   PLTREP1408
        DO  IM=1,Nfm                                                            PLTREP1409
          Jfm = Ifm + (IM-1)*Lfm                                                PLTREP1410
          WRITE (IREPFL) I66, IUNIQ, IONE, ITWO, I62,                           PLTREP1411
     &        <fm:NAME>,(FuelType(I,<fm:TYPE>),I=1,4),                          PLTREP1412
     &        (JUNITT(I,<fm:UNIT-INDEX>,IUNIT),I=1,3),                          PLTREP1413
     &        (<fm;PSB-ENGY>*<fm:BTU/UNIT>,MO=1,12),                            PLTREP1414
     &         <fm;PSB-ENGYYR>*<fm:BTU/UNIT>,                                   PLTREP1415
     &        (JUNITT(I,<fm:DEM-INDEX>,IUNIT),I=1,2),                           PLTREP1416
     &        (<fm;PSB-PEAK>*<fm:BTU/UNIT>,MO=1,12),                            PLTREP1417
     &         <fm;PSB-PEAKYR>*<fm:BTU/UNIT>,                                   PLTREP1418
     &        (<fm;PSB-DAY>,<fm;PSB-HR>,MO=1,12),                               PLTREP1419
     &         <fm;PSB-MOYR>, <fm;PSB-DAYYR>                                    PLTREP1420
        ENDDO                                                                   PLTREP1421
        DO  IM=1,Nsm                                                            PLTREP1422
          Jsm = Ism + (IM-1)*Lsm                                                PLTREP1423
          WRITE (IREPFL) I66, IUNIQ, IONE, ITWO, I62,                           PLTREP1424
     &        <sm:NAME>,(MeterType(I,3),I=1,4),                                 PLTREP1425
     &        (JUNITT(I,<sm:UNIT-INDEX>,IUNIT),I=1,3),                          PLTREP1426
     &        (<sm;PSB-ENGY>*<sm:BTU/UNIT>,MO=1,12),                            PLTREP1427
     &         <sm;PSB-ENGYYR>*<sm:BTU/UNIT>,                                   PLTREP1428
     &        (JUNITT(I,<sm:DEM-INDEX>,IUNIT),I=1,2),                           PLTREP1429
     &        (<sm;PSB-PEAK>*<sm:BTU/UNIT>,MO=1,12),                            PLTREP1430
     &         <sm;PSB-PEAKYR>*<sm:BTU/UNIT>,                                   PLTREP1431
     &        (<sm;PSB-DAY>,<sm;PSB-HR>,MO=1,12),                               PLTREP1432
     &         <sm;PSB-MOYR>, <sm;PSB-DAYYR>                                    PLTREP1433
        ENDDO                                                                   PLTREP1434
        DO  IM=1,Ncm                                                            PLTREP1435
          Jcm = Icm + (IM-1)*Lcm                                                PLTREP1436
          WRITE (IREPFL) I66, IUNIQ, IONE, ITWO, I62,                           PLTREP1437
     &        <cm:NAME>,(MeterType(I,4),I=1,4),                                 PLTREP1438
     &        (JUNITT(I,<cm:UNIT-INDEX>,IUNIT),I=1,3),                          PLTREP1439
     &        (<cm;PSB-ENGY>*<cm:BTU/UNIT>,MO=1,12),                            PLTREP1440
     &         <cm;PSB-ENGYYR>*<cm:BTU/UNIT>,                                   PLTREP1441
     &        (JUNITT(I,<cm:DEM-INDEX>,IUNIT),I=1,2),                           PLTREP1442
     &        (<cm;PSB-PEAK>*<cm:BTU/UNIT>,MO=1,12),                            PLTREP1443
     &         <cm;PSB-PEAKYR>*<cm:BTU/UNIT>,                                   PLTREP1444
     &        (<cm;PSB-DAY>,<cm;PSB-HR>,MO=1,12),                               PLTREP1445
     &         <cm;PSB-MOYR>, <cm;PSB-DAYYR>                                    PLTREP1446
        ENDDO                                                                   PLTREP1447
        WRITE (IREPFL) ITWO, IUNIQ, ISEVEN                                      PLTREP1448
      ENDIF                                                                     PLTREP1449
c                                                                               PLTREP1450
c              PS-C                                                             PLTREP1451
      IF (IREPRT(3,18) .GT. 0)  THEN                                            PLTREP1452
        IUNIQ = IREPRT(3,18)                                                    PLTREP1453
c              boilers                                                          PLTREP1454
        DO  Neq=1,Nbl                                                           PLTREP1455
          Jbl = Ibl + (Neq-1)*Lbl                                               PLTREP1456
          Jpe = <bl;Jpe>                                                        PLTREP1457
          IF (<bl:HIR> .GT. 0.)  THEN                                           -044e    5
            WRITE(IREPFL) I60,IUNIQ,IONE,ISIX,I56,                              PLTREP1459
     &        (<bl:NAME>,II=1,8),                                               PLTREP1460
     &        <pe;YEAR_1>,         <pe;YEAR_2>, <pe;YEAR_3>,                    PLTREP1461
     &                                       (<pe;YEAR_BINS_1>,II=1,12),        PLTREP1462
     &        <pe;YEAR_MAX_1>, <pe;YEAR_MAX_2>, <pe;YEAR_MAX_3>,                PLTREP1463
     &                                       (<pe;YEAR_BINS_2>,II=1,12),        PLTREP1464
     &        <pe;YEAR_MONTH_1>,<pe;YEAR_DAY_1>,                                PLTREP1465
     &        <pe;YEAR_MONTH_2>,<pe;YEAR_DAY_2>,                                PLTREP1466
     &        <pe;YEAR_MONTH_3>,<pe;YEAR_DAY_3>,                                PLTREP1467
     &                                       (<pe;YEAR_BINS_3>,II=1,12)         PLTREP1468
          ELSE                                                                  PLTREP1477
            WRITE(IREPFL) I44,IUNIQ,IONE,IEIGHT,I40,                            PLTREP1478
     &        (<bl:NAME>,II=1,8),                                               PLTREP1479
     &        <pe;YEAR_1>,    <pe;YEAR_2>,   (<pe;YEAR_BINS_1>,II=1,12),        PLTREP1480
     &        <pe;YEAR_MAX_1>,   <pe;YEAR_MAX_2>,                               PLTREP1481
     &                                       (<pe;YEAR_BINS_2>,II=1,12),        PLTREP1482
     &        <pe;YEAR_MONTH_1>, <pe;YEAR_DAY_1>,                               PLTREP1483
     &        <pe;YEAR_MONTH_2>, <pe;YEAR_DAY_2>                                PLTREP1484
          ENDIF                                                                 PLTREP1485
        ENDDO                                                                   PLTREP1486
c              chillers                                                         PLTREP1487
        DO  Neq=1,Nch                                                           PLTREP1488
          Jch = Ich + (Neq-1)*Lch                                               PLTREP1489
          IF (<ch:HIR> .GT. 0.)  THEN                                           -044e    6
c              absorption or engine chillers                                    -044e    7
            WRITE(IREPFL) I64,IUNIQ,IONE,ITWO,I60,                              -044e    8
     &        (<ch:NAME>,II=1,8),                                               -044e    9
     &        <ch;QYR>, <ch;QRECVRYR>, <ch;KWHYR>, <ch;FUELYR>,                 -044e   10
     &                                           (<ch;QPLRYR>,II=1,12),         -044e   11
     &        <ch;QYRM>,<ch;QRECVRYRM>,<ch;KWHYRM>,<ch;FUELYRM>,                -044e   12
     &                                         (<ch;KWHPLRYR>,II=1,12),         -044e   13
     &        <ch;QYRMMO>, <ch;QYRMDY>,                                         -044e   14
     &        <ch;QRECVRYRMMO>, <ch;QRECVRYRMDY>,                               -044e   15
     &        <ch;KWHYRMMO>, <ch;KWHYRMDY>,                                     -044e   16
     &        <ch;FUELYRMMO>, <ch;FUELYRMDY>, (<ch;FUELPLRYR>,II=1,12)          -044e   17
          ELSE                                                                  -044e   18
c              electric chillers                                                -044e   19
            WRITE(IREPFL) I48,IUNIQ,IONE,ITHREE,I44,                            -044e   20
     &        (<ch:NAME>,II=1,8),                                               -044e   21
     &        <ch;QYR>, <ch;QRECVRYR>, <ch;KWHYR>,                              -044e   22
     &                                           (<ch;QPLRYR>,II=1,12),         -044e   23
     &        <ch;QYRM>,<ch;QRECVRYRM>,<ch;KWHYRM>,                             -044e   24
     &                                         (<ch;KWHPLRYR>,II=1,12),         -044e   25
     &        <ch;QYRMMO>, <ch;QYRMDY>,                                         -044e   26
     &        <ch;QRECVRYRMMO>, <ch;QRECVRYRMDY>,                               -044e   27
     &        <ch;KWHYRMMO>, <ch;KWHYRMDY>                                      -044e   28
          ENDIF                                                                 -044e   29
        ENDDO                                                                   PLTREP1541
c              cooling towers                                                   PLTREP1542
        DO  Neq=1,Ntw                                                           PLTREP1543
          Jtw = Itw + (Neq-1)*Ltw                                               PLTREP1544
          WRITE(IREPFL) I44,IUNIQ,IONE,IFIVE,I40,                               PLTREP1545
     &      (<tw:NAME>,II=1,8),                                                 PLTREP1546
     &      <tw;QYR>, <tw;KWHYR>,     (<tw;QPLRYR>,II=1,12),                    PLTREP1547
     &      <tw;QYRM>, <tw;KWHYRM>,   (<tw;KWHPLRYR>,II=1,12),                  PLTREP1548
     &      <tw;QYRMMO>, <tw;QYRMDY>, <tw;KWHYRMMO>, <tw;KWHYRMDY>              PLTREP1549
        ENDDO                                                                   PLTREP1550
c              domestic water heaters                                           PLTREP1551
        DO  Neq=1,Ndw                                                           PLTREP1552
          Jdw = Idw + (Neq-1)*Ldw                                               PLTREP1553
          IF (<dw:HIR> .GT. 0.)  THEN                                           -044e5  56
            WRITE(IREPFL) I60,IUNIQ,IONE,ISIX,I56,                              PLTREP1555
     &        (<dw:NAME>,II=1,8),                                               PLTREP1556
     &        <dw;QYR>, <dw;KWHYR>, <dw;FUELYR>, (<dw;QPLRYR>,II=1,12),         PLTREP1557
     &        <dw;QYRM>, <dw;KWHYRM>, <dw;FUELYRM>,                             PLTREP1558
     &                                        (<dw;KWHPLRYR>,II=1,12),          PLTREP1559
     &        <dw;QYRMMO>,<dw;QYRMDY>,<dw;KWHYRMMO>,<dw;KWHYRMDY>,              PLTREP1560
     &        <dw;FUELYRMMO>,<dw;FUELYRMDY>,  (<dw;FUELPLRYR>,II=1,12)          PLTREP1561
          ELSE                                                                  PLTREP1568
            WRITE(IREPFL) I44,IUNIQ,IONE,IEIGHT,I40,                            PLTREP1569
     &        (<dw:NAME>,II=1,8),                                               PLTREP1570
     &        <dw;QYR>, <dw;KWHYR>,   (<dw;QPLRYR>,II=1,12),                    PLTREP1571
     &        <dw;QYRM>, <dw;KWHYRM>, (<dw;KWHPLRYR>,II=1,12),                  PLTREP1572
     &        <dw;QYRMMO>,<dw;QYRMDY>, <dw;KWHYRMMO>,<dw;KWHYRMDY>              PLTREP1573
          ENDIF                                                                 PLTREP1574
        ENDDO                                                                   PLTREP1575
c              generators                                                       PLTREP1576
        DO  Neq=1,Ngn                                                           PLTREP1577
          Jgn = Ign + (Neq-1)*Lgn                                               PLTREP1578
          Jpe = <gn;Jpe>                                                        PLTREP1579
          IF (<gn:HIR> .GT. 0.)  THEN                                           PV     143
            WRITE(IREPFL) I60,IUNIQ,IONE,I12,I56,                               PV     144
     &        (<gn:NAME>,II=1,8),                                               PV     145
     &        <pe;YEAR_4>, -<pe;YEAR_1>, <pe;YEAR_2>,                           PV     146
     &                                     (<pe;YEAR_BINS_1>,II=1,12),          PV     147
     &        <pe;YEAR_MAX_4>, -<pe;YEAR_MAX_1>, <pe;YEAR_MAX_2>,               PV     148
     &                                     (<pe;YEAR_BINS_2>,II=1,12),          PV     149
     &        <pe;YEAR_MONTH_4>,<pe;YEAR_DAY_4>,                                PV     150
     &        <pe;YEAR_MONTH_1>,<pe;YEAR_DAY_1>,                                PV     151
     &        <pe;YEAR_MONTH_2>,<pe;YEAR_DAY_2>,                                PV     152
     &                                     (<pe;YEAR_BINS_3>,II=1,12)           PV     153
          ELSE                                                                  PV     154
            WRITE(IREPFL) I52,IUNIQ,IONE,I13,I48,                               PV     155
     &        (<gn:NAME>,II=1,8),                                               PV     156
     &        -<pe;YEAR_1>,                (<pe;YEAR_BINS_1>,II=1,12),          PV     157
     &        -<pe;YEAR_MAX_1>,            (<pe;YEAR_BINS_2>,II=1,12),          PV     158
     &        <pe;YEAR_MONTH_1>,<pe;YEAR_DAY_1>,                                PV     159
     &                                     (<pe;YEAR_BINS_3>,II=1,12)           PV     160
          ENDIF                                                                 PV     161
        ENDDO                                                                   PLTREP1590
c              thermal storage                                                  PLTREP1591
        DO  Neq=1,Ntk                                                           PLTREP1592
          Jtk = Itk + (Neq-1)*Ltk                                               PLTREP1593
          SELECT CASE (<tk:ALGORITHM>)                                          PLTREP1594
          CASE (181)                                                            PLTREP1595
c              cold storage                                                     PLTREP1596
            WRITE(IREPFL) I32,IUNIQ,IONE,ITEN,I28,                              PLTREP1597
     &        (<tk:NAME>,II=1,8), <tk;DCHRG_YR>, <tk;AUX_YR>,                   PLTREP1598
     &                                      (<tk;DCHRG_PLR_YR>,II=1,12),        PLTREP1599
     &        <tk;DCHRG_YRM>,    <tk;AUX_YRM>,                                  PLTREP1600
     &        <tk;DCHRG_YRM_MO>, <tk;DCHRG_YRM_DY>,                             PLTREP1601
     &        <tk;AUX_YRM_MO>  , <tk;AUX_YRM_DY>                                PLTREP1602
          CASE (281)                                                            PLTREP1603
c              hot storage                                                      PLTREP1604
            WRITE(IREPFL) I32,IUNIQ,IONE,I11,I28,                               PLTREP1605
     &        (<tk:NAME>,II=1,8), <tk;DCHRG_YR>, <tk;AUX_YR>,                   PLTREP1606
     &                                      (<tk;DCHRG_PLR_YR>,II=1,12),        PLTREP1607
     &        <tk;DCHRG_YRM>,    <tk;AUX_YRM>,                                  PLTREP1608
     &        <tk;DCHRG_YRM_MO>, <tk;DCHRG_YRM_DY>,                             PLTREP1609
     &        <tk;AUX_YRM_MO>  , <tk;AUX_YRM_DY>                                PLTREP1610
          END SELECT                                                            PLTREP1611
        ENDDO                                                                   PLTREP1612
c              Ground-loop heat exchangers                                      -044e5  57
        DO Neq=1,Ngl                                                            -044e5  58
          Jgl = Igl + (Neq-1)*Lgl                                               -044e5  59
          WRITE(IREPFL) I20,IUNIQ,Ione,Iseven,I16, (<gl:NAME>,II=1,8),          -044e5  60
     &      <gl.Cool_Yr>,   <gl.Heat_Yr>,                                       -044e5  61
     &      <gl.Cool_YrM>,  <gl.Heat_YrM>,                                      -044e5  62
     &      <gl.Cool_YrMo>, <gl.Cool_YrDy>,                                     -044e5  63
     &      <gl.Heat_YrMo>, <gl.Heat_YrDy>                                      -044e5  64
        ENDDO                                                                   -044e5  65
c              pumps                                                            PLTREP1613
        DO  Neq=1,Npm                                                           PLTREP1614
          Jpm = Ipm + (Neq-1)*Lpm                                               PLTREP1615
          IF (<pm;TOTAL_GPM> .GT. 0.)                                           PLTREP1616
     &      WRITE(IREPFL) I52,IUNIQ,IONE,ININE,I48,                             PLTREP1617
     &        (<pm:NAME>,II=1,8),                                               PLTREP1618
     &        <pm;KWHYR>,  (<pm;GPMPLRYR>,II=1,12),                             PLTREP1619
     &        <pm;KWHYRM>, (<pm;RPMPLRYR>,II=1,12),                             PLTREP1620
     &        <pm;KWHYRMMO>,<pm;KWHYRMDY>,(<pm;KWHPLRYR>,II=1,12)               PLTREP1621
        ENDDO                                                                   PLTREP1622
        WRITE (IREPFL) ITWO, IUNIQ, ISEVEN                                      PLTREP1623
      ENDIF                                                                     PLTREP1624
c                                                                               PLTREP1625
c              PS-D                                                             PLTREP1626
      IF (IREPRT(3,19) .GT. 0)  THEN                                            PLTREP1627
        IUNIQ = IREPRT(3,19)                                                    PLTREP1628
c              circulation loops                                                PLTREP1629
        HeaderFlag = .FALSE.                                                    PLTREP1630
        DO  NL=1,Nlp                                                            PLTREP1631
          Jlp = Ilp + (NL-1)*Llp                                                PLTREP1632
          IF (<lp:TYPE> .EQ. Deleted)  CYCLE                                    PLTREP1633
          LoopType = <lp:TYPE>                                                  PLTREP1634
          IF (LoopType .NE. WLHP)  THEN                                         PLTREP1635
            IF (.NOT. HeaderFlag)  THEN                                         PLTREP1636
              WRITE(IREPFL) IFOUR, IUNIQ, IONE, IONE, IZERO                     PLTREP1637
              HeaderFlag = .TRUE.                                               PLTREP1638
            ENDIF                                                               PLTREP1639
            IF (LoopType .NE. CHW  .AND.  LoopType .NE. CW)                     PLTREP1640
     &        WRITE(IREPFL) I52,IUNIQ,IONE,ITWO,I48,                            PLTREP1641
     &          (<lp:NAME>,II=1,8),                                             PLTREP1642
     &          <lp;COILHYR>,    <lp;LOSSHYR>,   <lp;TOTALHYR>,                 PLTREP1643
     &          <lp;OVRLDHYR>,   (<lp;QHPLRYR>,II=1,12),                        PLTREP1644
     &          <lp;COILHYRM>,   <lp;LOSSHYRM>,  <lp;TOTALHYRM>,                PLTREP1645
     &          <lp;OVRLDHYRM>,  (<lp;GPMHPLRYR>,II=1,12),                      PLTREP1646
     &          <lp;COILHYRMMO>, <lp;COILHYRMDY>,<lp;LOSSHYRMMO>,               PLTREP1647
     &          <lp;LOSSHYRMDY>, <lp;TOTALHYRMMO>,<lp;TOTALHYRMDY>,             PLTREP1648
     &          <lp;OVRLDHYRMMO>,<lp;OVRLDHYRMDY>                               PLTREP1649
            IF (LoopType .EQ. CHW  .OR.  LoopType .EQ. CW                       PLTREP1650
     &                             .OR.  LoopType .EQ. PIPE2)                   PLTREP1651
     &        WRITE(IREPFL) I52,IUNIQ,IONE,ITHREE,I48,                          PLTREP1652
     &          (<lp:NAME>,II=1,8),                                             PLTREP1653
     &          <lp;COILCYR>,   <lp;LOSSCYR>,  <lp;TOTALCYR>,                   PLTREP1654
     &          <lp;OVRLDCYR>,  (<lp;QCPLRYR>,II=1,12),                         PLTREP1655
     &          <lp;COILCYRM>,  <lp;LOSSCYRM>, <lp;TOTALCYRM>,                  PLTREP1656
     &          <lp;OVRLDCYRM>, (<lp;GPMCPLRYR>,II=1,12),                       PLTREP1657
     &          <lp;COILCYRMMO>, <lp;COILCYRMDY>,<lp;LOSSCYRMMO>,               PLTREP1658
     &          <lp;LOSSCYRMDY>, <lp;TOTALCYRMMO>,<lp;TOTALCYRMDY>,             PLTREP1659
     &          <lp;OVRLDCYRMMO>,<lp;OVRLDCYRMDY>                               PLTREP1660
c              overload hours                                                   PLTREP1661
            IF (<lp;HR_HEAT_OVRLD> .GT. 0)                                      PLTREP1662
     &        WRITE(IREPFL) IFIVE, IUNIQ,IONE,IFOUR,IONE,                       PLTREP1663
     &          <lp;HR_HEAT_OVRLD>                                              PLTREP1664
            IF (<lp;HR_COOL_OVRLD> .GT. 0)                                      PLTREP1665
     &        WRITE(IREPFL) IFIVE, IUNIQ,IONE,IFIVE,IONE,                       PLTREP1666
     &          <lp;HR_COOL_OVRLD>                                              PLTREP1667
          ENDIF                                                                 PLTREP1668
        ENDDO                                                                   PLTREP1669
c              see if any wlhp loops                                            PLTREP1670
        HeaderFlag = .FALSE.                                                    PLTREP1671
        DO  NL=1,Nlp                                                            PLTREP1672
          Jlp = Ilp + (NL-1)*Llp                                                PLTREP1673
          IF (<lp:TYPE> .EQ. WLHP)  THEN                                        PLTREP1674
            IF (.NOT. HeaderFlag)  THEN                                         PLTREP1675
              WRITE(IREPFL) IFOUR, IUNIQ, IONE, ISIX, IZERO                     PLTREP1676
              HeaderFlag = .TRUE.                                               PLTREP1677
            ENDIF                                                               PLTREP1678
            WRITE(IREPFL) I12, IUNIQ,IONE,ISEVEN,IEIGHT,                        PLTREP1679
     &        (<lp:NAME>,II=1,8)                                                PLTREP1680
c              heating dominated and coincident cooling                         PLTREP1681
            WRITE(IREPFL) I48  ,IUNIQ,IONE,IEIGHT,I44,                          PLTREP1682
     &        <lp;COILHYR>,     <lp;COILHCYR>,  <lp;LOSSHYR>,                   PLTREP1683
     &        <lp;TOTALHYR>,    <lp;OVRLDHYR>,                                  PLTREP1684
     &                                          (<lp;QHPLRYR>,II=1,12),         PLTREP1685
     &        <lp;COILHYRM>,    <lp;COILHCYRM>, <lp;LOSSHYRM>,                  PLTREP1686
     &        <lp;TOTALHYRM>,   <lp;OVRLDHYRM>,                                 PLTREP1687
     &                                        (<lp;GPMHPLRYR>,II=1,12),         PLTREP1688
     &        <lp;COILHYRMMO>,  <lp;COILHYRMDY>,                                PLTREP1689
     &        <lp;COILHCYRMMO>, <lp;COILHCYRMDY>,                               PLTREP1690
     &        <lp;LOSSHYRMMO>,  <lp;LOSSHYRMDY>,                                PLTREP1691
     &        <lp;TOTALHYRMMO>, <lp;TOTALHYRMDY>,                               PLTREP1692
     &        <lp;OVRLDHYRMMO>, <lp;OVRLDHYRMDY>                                PLTREP1693
c              cooling dominated and coincident heating                         PLTREP1694
            WRITE(IREPFL) I48  ,IUNIQ,IONE,ININE,I44,                           PLTREP1695
     &        <lp;COILCHYR>,    <lp;COILCYR>, <lp;LOSSCYR>,                     PLTREP1696
     &        <lp;TOTALCYR>,    <lp;OVRLDCYR>,                                  PLTREP1697
     &                                          (<lp;QCPLRYR>,II=1,12),         PLTREP1698
     &        <lp;COILCHYRM>,   <lp;COILCYRM>, <lp;LOSSCYRM>,                   PLTREP1699
     &        <lp;TOTALCYRM>,   <lp;OVRLDCYRM>,                                 PLTREP1700
     &                                        (<lp;GPMCPLRYR>,II=1,12),         PLTREP1701
     &        <lp;COILCHYRMMO>, <lp;COILCHYRMDY>,                               PLTREP1702
     &        <lp;COILCYRMMO>,  <lp;COILCYRMDY>,                                PLTREP1703
     &        <lp;LOSSCYRMMO>,  <lp;LOSSCYRMDY>,                                PLTREP1704
     &        <lp;TOTALCYRMMO>, <lp;TOTALCYRMDY>,                               PLTREP1705
     &        <lp;OVRLDCYRMMO>, <lp;OVRLDCYRMDY>                                PLTREP1706
c              heating and cooling while floating                               PLTREP1707
            WRITE(IREPFL) I29  ,IUNIQ,IONE,ITEN,I25,                            PLTREP1708
     &        <lp;COILFHYR>,    <lp;COILFCYR>,  <lp;LOSSFYR>,                   PLTREP1709
     &                                         <lp;FLOATYR>,                    PLTREP1710
     &        <lp;COILFHYRM>,   <lp;COILFCYRM>, <lp;LOSSFYRM>,                  PLTREP1711
     &                                        (<lp;GPMFPLRYR>,II=1,12),         PLTREP1712
     &        <lp;COILFHYRMMO>, <lp;COILFHYRMDY>,                               PLTREP1713
     &        <lp;COILFCYRMMO>, <lp;COILFCYRMDY>,                               PLTREP1714
     &        <lp;LOSSFYRMMO>,  <lp;LOSSFYRMDY>                                 PLTREP1715
c              grand totals                                                     PLTREP1716
            WRITE(IREPFL) I24  ,IUNIQ,IONE,I11,I20,                             PLTREP1717
     &        (<lp;COILHYR>+<lp;COILCHYR>+<lp;COILFHYR>),                       PLTREP1718
     &        (<lp;COILHCYR>+<lp;COILCYR>+<lp;COILFCYR>),                       PLTREP1719
     &        (<lp;GPMHPLRYR>+<lp;GPMCPLRYR>+<lp;GPMFPLRYR>,II=1,12),           PLTREP1720
     &        <lp;COILHYRM>,    <lp;COILCYRM>,                                  PLTREP1721
     &        <lp;COILHYRMMO>,  <lp;COILHYRMDY>,                                PLTREP1722
     &        <lp;COILCHYRMMO>, <lp;COILCHYRMDY>                                PLTREP1723
c              overload hours                                                   PLTREP1724
            IF (<lp;HR_HEAT_OVRLD> .GT. 0)                                      PLTREP1725
     &        WRITE(IREPFL) IFIVE, IUNIQ,IONE,IFOUR,IONE,                       PLTREP1726
     &          <lp;HR_HEAT_OVRLD>                                              PLTREP1727
            IF (<lp;HR_COOL_OVRLD> .GT. 0)                                      PLTREP1728
     &        WRITE(IREPFL) IFIVE, IUNIQ,IONE,IFIVE,IONE,                       PLTREP1729
     &          <lp;HR_COOL_OVRLD>                                              PLTREP1730
          ENDIF                                                                 PLTREP1731
        ENDDO                                                                   PLTREP1732
        IF (HeaderFlag)  THEN                                                   Bug40  292
          WRITE(IREPFL) ISIX, IUNIQ,IONE,I13,ITWO,                              Bug40  293
     &      <lp;NumHiAlarm>, <lp;NumLoAlarm>                                    Bug40  294
          WRITE(IREPFL) IFOUR, IUNIQ, IONE, I12, IZERO                          Bug40  295
        ENDIF                                                                   Bug40  296
        WRITE (IREPFL) ITWO, IUNIQ, ISEVEN                                      PLTREP1735
      ENDIF                                                                     PLTREP1736
c                                                                               PLTREP1737
c              PS-E, one report for each meter type                             PLTREP1738
      IF (IREPRT(3,20) .GT. 0)  THEN                                            HVAC29 203
        IUNIQ = IREPRT(3,20)                                                    HVAC29 204
c              electric meters                                                  HVAC29 205
        IF (Nem .GT. 0)  THEN                                                   HVAC29 206
          IF (EndUsePeaks(20,2,IELEC) .GT. 0.) THEN                             -047k   49
            Pct = 100. / EndUsePeaks(20,2,IELEC)                                -047k   50
          ELSE                                                                  -047k   51
            Pct = 0.                                                            -047k   52
          ENDIF                                                                 -047k   53
          WRITE(IREPFL)  I80, IUNIQ, IONE, ITHREE, I76,                         HVAC29 209
     &      (EndUses(IE,2,IELEC),IE=1,12),EndUses(20,2,IELEC),                  HVAC29 210
     &      (EndUsePeaks(IE,2,IELEC),IE=1,12),EndUsePeaks(20,2,IELEC),          HVAC29 211
     &      (EndPeakDay(IE,2,IELEC),EndPeakHour(IE,2,IELEC),IE=1,12),           HVAC29 212
     &       EndPeakDay(20,2,IELEC),EndPeakHour(20,2,IELEC),                    HVAC29 213
     &      (EndUseAtPeak(IE,2,IELEC),IE=1,12),                                 HVAC29 214
     &      (EndUseAtPeak(IE,2,IELEC)*Pct,IE=1,12)                              HVAC29 215
          WRITE (IREPFL) ITWO, IUNIQ, ISEVEN                                    HVAC29 216
          IUNIQ = IUNIQ + 1                                                     HVAC29 217
          IF (KtvTDV2(1) .gt. 0)  THEN  ! TDV2 report                           -044   108
            Ktv = KtvTDV2(1)                                                    -044   109
            WRITE(IREPFL) I69, IUNIQ, IONE, ITHREE, I65,                        -044   110
     &        (<tv.EndUseYr>,IE=1,12),<tv.TotYr>,                               -044   111
     &        (<tv.EndUseYrM>,IE=1,12),<tv.TotYrM>,                             -044   112
     &        (<tv.EndUseYrMo>, <tv.EndUseYrDy>,IE=1,12),                       -044   113
     &         <tv.TotYrMo>, <tv.TotYrDy>,                                      -044   114
     &        (<tv.EndUseYr>/Max(0.0001,EndUses(IE,2,IELEC)),IE=1,12),          -044   115
     &         <tv.TotYr>/Max(0.0001,EndUses(20,2,IELEC))                       -044   116
            WRITE (IREPFL) ITWO, IUNIQ, ISEVEN                                  -044   117
            IUNIQ = IUNIQ + 1                                                   -044   118
          ENDIF                                                                 -044   119
        ENDIF                                                                   HVAC29 218
c              fuel meters                                                      HVAC29 219
        IF (Nfm .GT. 0)  THEN                                                   HVAC29 220
          IF (EndUsePeaks(20,2,IFUEL) .GT. 0.) THEN                             -047k   54
            Pct = 100. / EndUsePeaks(20,2,IFUEL)                                -047k   55
          ELSE                                                                  -047k   56
            Pct = 0.                                                            -047k   57
          ENDIF                                                                 -047k   58
          WRITE(IREPFL)  I80, IUNIQ, IONE, ITHREE, I76,                         HVAC29 223
     &      (EndUses(IE,2,IFUEL),IE=1,12),EndUses(20,2,IFUEL),                  HVAC29 224
     &      (EndUsePeaks(IE,2,IFUEL),IE=1,12),EndUsePeaks(20,2,IFUEL),          HVAC29 225
     &      (EndPeakDay(IE,2,IFUEL),EndPeakHour(IE,2,IFUEL),IE=1,12),           HVAC29 226
     &       EndPeakDay(20,2,IFUEL),EndPeakHour(20,2,IFUEL),                    HVAC29 227
     &      (EndUseAtPeak(IE,2,IFUEL),IE=1,12),                                 HVAC29 228
     &      (EndUseAtPeak(IE,2,IFUEL)*Pct,IE=1,12)                              HVAC29 229
c              cogeneration sales                                               HVAC29 230
          IF (EndUses(13,2,IFUEL) .GT. 0.)                                      HVAC29 231
     &      WRITE(IREPFL) IFIVE, IUNIQ, IONE, IFOUR, IONE,                      HVAC29 232
     &        EndUses(13,2,IFUEL)                                               HVAC29 233
          WRITE (IREPFL) ITWO, IUNIQ, ISEVEN                                    HVAC29 234
          IUNIQ = IUNIQ + 1                                                     HVAC29 235
          IF (KtvTDV2(2) .gt. 0)  THEN  ! TDV2 report                           -044   120
            Ktv = KtvTDV2(2)                                                    -044   121
            WRITE(IREPFL) I69, IUNIQ, IONE, ITHREE, I65,                        -044   122
     &        (<tv.EndUseYr>,IE=1,12),<tv.TotYr>,                               -044   123
     &        (<tv.EndUseYrM>,IE=1,12),<tv.TotYrM>,                             -044   124
     &        (<tv.EndUseYrMo>, <tv.EndUseYrDy>,IE=1,12),                       -044   125
     &         <tv.TotYrMo>, <tv.TotYrDy>,                                      -044   126
     &        (<tv.EndUseYr>/Max(0.0001,EndUses(IE,2,IFUEL)),IE=1,12),          -044   127
     &         <tv.TotYr>/Max(0.0001,EndUses(20,2,IFUEL))                       -044   128
c                  cogeneration sales                                           -044   129
            IE = 13                                                             -044   130
            IF (<tv.EndUseYr> .GT. 0.)                                          -044   131
     &        WRITE(IREPFL) IFIVE, IUNIQ, IONE, IFOUR, IONE,                    -044   132
     &          <tv.EndUseYr>                                                   -044   133
            WRITE (IREPFL) ITWO, IUNIQ, ISEVEN                                  -044   134
            IUNIQ = IUNIQ + 1                                                   -044   135
          ENDIF                                                                 -044   136
        ENDIF                                                                   HVAC29 236
c              purchased steam meters                                           HVAC29 237
        IF (Nsm .GT. 0)  THEN                                                   HVAC29 238
          IF (EndUsePeaks(20,2,ISTM) .GT. 0.) THEN                              -047k   59
            Pct = 100. / EndUsePeaks(20,2,ISTM)                                 -047k   60
          ELSE                                                                  -047k   61
            Pct = 0.                                                            -047k   62
          ENDIF                                                                 -047k   63
          WRITE(IREPFL)  I80, IUNIQ, IONE, ITHREE, I76,                         HVAC29 241
     &      (EndUses(IE,2,ISTM),IE=1,12),EndUses(20,2,ISTM),                    HVAC29 242
     &      (EndUsePeaks(IE,2,ISTM),IE=1,12),EndUsePeaks(20,2,ISTM),            HVAC29 243
     &      (EndPeakDay(IE,2,ISTM),EndPeakHour(IE,2,ISTM),IE=1,12),             HVAC29 244
     &       EndPeakDay(20,2,ISTM),EndPeakHour(20,2,ISTM),                      HVAC29 245
     &      (EndUseAtPeak(IE,2,ISTM),IE=1,12),                                  HVAC29 246
     &      (EndUseAtPeak(IE,2,ISTM)*Pct,IE=1,12)                               HVAC29 247
          WRITE (IREPFL) ITWO, IUNIQ, ISEVEN                                    HVAC29 248
          IUNIQ = IUNIQ + 1                                                     HVAC29 249
        ENDIF                                                                   HVAC29 250
c             purchased chilled-water meters                                    HVAC29 251
        IF (Ncm .GT. 0)  THEN                                                   HVAC29 252
          IF (EndUsePeaks(20,2,ICHW) .GT. 0.) THEN                              -047k   64
            Pct = 100. / EndUsePeaks(20,2,ICHW)                                 -047k   65
          ELSE                                                                  -047k   66
            Pct = 0.                                                            -047k   67
          ENDIF                                                                 -047k   68
          WRITE(IREPFL)  I80, IUNIQ, IONE, ITHREE, I76,                         HVAC29 255
     &      (EndUses(IE,2,ICHW),IE=1,12),EndUses(20,2,ICHW),                    HVAC29 256
     &      (EndUsePeaks(IE,2,ICHW),IE=1,12),EndUsePeaks(20,2,ICHW),            HVAC29 257
     &      (EndPeakDay(IE,2,ICHW),EndPeakHour(IE,2,ICHW),IE=1,12),             HVAC29 258
     &       EndPeakDay(20,2,ICHW),EndPeakHour(20,2,ICHW),                      HVAC29 259
     &      (EndUseAtPeak(IE,2,ICHW),IE=1,12),                                  HVAC29 260
     &      (EndUseAtPeak(IE,2,ICHW)*Pct,IE=1,12)                               HVAC29 261
          WRITE (IREPFL) ITWO, IUNIQ, ISEVEN                                    HVAC29 262
        ENDIF                                                                   HVAC29 263
      ENDIF                                                                     HVAC29 264
c                                                                               HVAC29 265
c              PS-F, one report for each meter                                  HVAC29 266
      IF (IREPRT(3,21) .GT. 0)  THEN                                            HVAC29 267
c              electric meters                                                  HVAC29 268
        DO  IM=1,Nem                                                            HVAC29 269
          Jem = Iem + (IM-1)*Lem                                                HVAC29 270
          IF (<em:REPORT> .NE. 0)  THEN                                         HVAC29 271
c              conversion for peak percent                                      HVAC29 272
            IF (<em;TOTALYRM> .NE. 0.)  THEN                                    HVAC29 273
              Pct = 100.0 / <em;TOTALYRM>                                       HVAC29 274
            ELSE                                                                HVAC29 275
              Pct = 0.                                                          HVAC29 276
            ENDIF                                                               HVAC29 277
            WRITE(IREPFL) I84, <em:REPORT>, IONE, ITHREE, I80,                  HVAC29 278
     &        (JUNITT(I,<em:UNIT-INDEX>,IUNIT),I=1,2),                          HVAC29 279
     &        (<em;METERSYR>,IE=1,12), <em;TOTALYR>,                            HVAC29 280
     &        (JUNITT(I,<em:DEM-INDEX>,IUNIT),I=1,2),                           HVAC29 281
     &        (<em;METERSYRM>,IE=1,12), <em;TOTALYRM>,                          HVAC29 282
     &        (<em;METERSYRMMO>,<em;METERSYRMDY>,IE=1,12),                      HVAC29 283
     &         <em;TOTALYRMMO>,<em;TOTALYRMDY>,                                 HVAC29 284
     &        (<em;EndUsePeakYr>,IE=1,12),                                      HVAC29 285
     &        (<em;EndUsePeakYr>*Pct,IE=1,12)                                   HVAC29 286
            WRITE(IREPFL) ISIX, <em:REPORT>, IONE, IFIVE, ITWO,                 HVAC29 287
     &        <em;LOSSYR>, JUNITT(1,<em:UNIT-INDEX>,IUNIT)                      HVAC29 288
            WRITE (IREPFL) ITWO, <em:REPORT>, ISEVEN                            HVAC29 289
            IF (<em;Ktv> .gt. 0)  THEN  ! TDV3 report                           -044   137
              Ktv = <em;Ktv>                                                    -044   138
              WRITE(IREPFL) I72, <tv;Iuniq>, IONE, ITHREE, I68,                 -044   139
     &          (<tv.EndUseYr>,IE=1,12),<tv.TotYr>,                             -044   140
     &          (<tv.EndUseYrM>,IE=1,12),<tv.TotYrM>,                           -044   141
     &          (<tv.EndUseYrMo>, <tv.EndUseYrDy>,IE=1,12),                     -044   142
     &           <tv.TotYrMo>, <tv.TotYrDy>,                                    -044   143
     &          (<tv.EndUseYr>/Max(0.0001,<em;METERSYR>),IE=1,12),              -044   144
     &           <tv.TotYr>/Max(0.0001,<em;TOTALYR>),                           -044   145
     &           <tv.TDVmaxYr>, <tv.TDVminYr>,                                  -044   146
     &           <tv.TDVavgYr>/Max(1.,<tv.TDVhrsYr>)                            -044   147
              WRITE(IREPFL) IFIVE, <tv;Iuniq>, IONE, IFOUR, IONE,               -044   148
     &          <tv.LossYr>                                                     -044   149
              WRITE (IREPFL) ITWO, <tv;Iuniq>, ISEVEN                           -044   150
            ENDIF  ! em;Ktv                                                     -044   151
          ENDIF                                                                 HVAC29 290
        ENDDO                                                                   HVAC29 291
c              fuel meters                                                      HVAC29 292
        DO  IM=1,Nfm                                                            HVAC29 293
          Jfm = Ifm + (IM-1)*Lfm                                                HVAC29 294
          IF (<fm:REPORT> .NE. 0)  THEN                                         HVAC29 295
c              conversion for peak percent                                      HVAC29 296
            IF (<fm;TOTALYRM> .NE. 0.)  THEN                                    HVAC29 297
              Pct = 100.0 / <fm;TOTALYRM>                                       HVAC29 298
            ELSE                                                                HVAC29 299
              Pct = 0.                                                          HVAC29 300
            ENDIF                                                               HVAC29 301
            WRITE(IREPFL) I84, <fm:REPORT>, IONE, ITHREE, I80,                  HVAC29 302
     &        (JUNITT(I,<fm:UNIT-INDEX>,IUNIT),I=1,2),                          HVAC29 303
     &        (<fm;METERSYR>*<fm:BTU/UNIT>,IE=1,12),                            HVAC29 304
     &         <fm;TOTALYR>*<fm:BTU/UNIT>,                                      HVAC29 305
     &        (JUNITT(I,<fm:DEM-INDEX>,IUNIT),I=1,2),                           HVAC29 306
     &        (<fm;METERSYRM>*<fm:BTU/UNIT>,IE=1,12),                           HVAC29 307
     &         <fm;TOTALYRM>*<fm:BTU/UNIT>,                                     HVAC29 308
     &        (<fm;METERSYRMMO>,<fm;METERSYRMDY>,IE=1,12),                      HVAC29 309
     &         <fm;TOTALYRMMO>,<fm;TOTALYRMDY>,                                 HVAC29 310
     &        (<fm;EndUsePeakYr>*<fm:BTU/UNIT>,IE=1,12),                        HVAC29 311
     &        (<fm;EndUsePeakYr>*Pct,IE=1,12)                                   HVAC29 312
c              cogeneration sales                                               HVAC29 313
            IE = 13                                                             HVAC29 314
            IF (<fm;METERSYR> .GT. 0.)                                          HVAC29 315
     &        WRITE(IREPFL) ISEVEN, <fm:REPORT>, IONE, IFIVE, ITHREE,           HVAC29 316
     &          <fm;METERSYR>*<fm:BTU/UNIT>,                                    HVAC29 317
     &          (JUNITT(I,<fm:UNIT-INDEX>,IUNIT),I=1,2)                         HVAC29 318
            WRITE (IREPFL) ITWO, <fm:REPORT>, ISEVEN                            HVAC29 319
            IF (<fm;Ktv> .gt. 0)  THEN  ! TDV3 report                           -044   152
              Ktv = <fm;Ktv>                                                    -044   153
              WRITE(IREPFL) I72, <tv;Iuniq>, IONE, ITHREE, I68,                 -044   154
     &          (<tv.EndUseYr>,IE=1,12),<tv.TotYr>,                             -044   155
     &          (<tv.EndUseYrM>,IE=1,12),<tv.TotYrM>,                           -044   156
     &          (<tv.EndUseYrMo>, <tv.EndUseYrDy>,IE=1,12),                     -044   157
     &           <tv.TotYrMo>, <tv.TotYrDy>,                                    -044   158
     &          (<tv.EndUseYr> / Max(0.0001,<fm;METERSYR>),IE=1,12),            -044   159
     &           <tv.TotYr>/Max(0.0001,<fm;TOTALYR>),                           -044   160
     &           <tv.TDVmaxYr>, <tv.TDVminYr>,                                  -044   161
     &           <tv.TDVavgYr>/Max(1.,<tv.TDVhrsYr>)                            -044   162
c                  cogeneration sales                                           -044   163
              IE = 13                                                           -044   164
              IF (<tv.EndUseYr> .GT. 0.)                                        -044   165
     &          WRITE(IREPFL) IFIVE, <tv;Iuniq>, IONE, IFOUR, IONE,             -044   166
     &            <tv.EndUseYr>                                                 -044   167
              WRITE (IREPFL) ITWO, <tv;Iuniq>, ISEVEN                           -044   168
            ENDIF  ! fm;Ktv                                                     -044   169
          ENDIF                                                                 HVAC29 320
        ENDDO                                                                   HVAC29 321
c              steam meters                                                     HVAC29 322
        DO  IM=1,Nsm                                                            HVAC29 323
          Jsm = Ism + (IM-1)*Lsm                                                HVAC29 324
          IF (<sm:REPORT> .NE. 0)  THEN                                         HVAC29 325
c              conversion for peak percent                                      HVAC29 326
            IF (<sm;TOTALYRM> .NE. 0.)  THEN                                    HVAC29 327
              Pct = 100.0 / <sm;TOTALYRM>                                       HVAC29 328
            ELSE                                                                HVAC29 329
              Pct = 0.                                                          HVAC29 330
            ENDIF                                                               HVAC29 331
            WRITE(IREPFL) I84, <sm:REPORT>, IONE, ITHREE, I80,                  HVAC29 332
     &        (JUNITT(I,<sm:UNIT-INDEX>,IUNIT),I=1,2),                          HVAC29 333
     &        (<sm;METERSYR>*<sm:BTU/UNIT>,IE=1,12),                            HVAC29 334
     &         <sm;TOTALYR>*<sm:BTU/UNIT>,                                      HVAC29 335
     &        (JUNITT(I,<sm:DEM-INDEX>,IUNIT),I=1,2),                           HVAC29 336
     &        (<sm;METERSYRM>*<sm:BTU/UNIT>,IE=1,12),                           HVAC29 337
     &         <sm;TOTALYRM>*<sm:BTU/UNIT>,                                     HVAC29 338
     &        (<sm;METERSYRMMO>,<sm;METERSYRMDY>,IE=1,12),                      HVAC29 339
     &         <sm;TOTALYRMMO>,<sm;TOTALYRMDY>,                                 HVAC29 340
     &        (<sm;EndUsePeakYr>*<sm:BTU/UNIT>,IE=1,12),                        HVAC29 341
     &        (<sm;EndUsePeakYr>*Pct,IE=1,12)                                   HVAC29 342
            WRITE (IREPFL) ITWO, <sm:REPORT>, ISEVEN                            HVAC29 343
          ENDIF                                                                 HVAC29 344
        ENDDO                                                                   HVAC29 345
c              chilled-water meters                                             HVAC29 346
        DO  IM=1,Ncm                                                            HVAC29 347
          Jcm = Icm + (IM-1)*Lcm                                                HVAC29 348
          IF (<cm:REPORT> .NE. 0)  THEN                                         HVAC29 349
c              conversion for peak percent                                      HVAC29 350
            IF (<cm;TOTALYRM> .NE. 0.)  THEN                                    HVAC29 351
              Pct = 100.0 / <cm;TOTALYRM>                                       HVAC29 352
            ELSE                                                                HVAC29 353
              Pct = 0.                                                          HVAC29 354
            ENDIF                                                               HVAC29 355
            WRITE(IREPFL) I84, <cm:REPORT>, IONE, ITHREE, I80,                  HVAC29 356
     &        (JUNITT(I,<cm:UNIT-INDEX>,IUNIT),I=1,2),                          HVAC29 357
     &        (<cm;METERSYR>*<cm:BTU/UNIT>,IE=1,12),                            HVAC29 358
     &         <cm;TOTALYR>*<cm:BTU/UNIT>,                                      HVAC29 359
     &        (JUNITT(I,<cm:DEM-INDEX>,IUNIT),I=1,2),                           HVAC29 360
     &        (<cm;METERSYRM>*<cm:BTU/UNIT>,IE=1,12),                           HVAC29 361
     &         <cm;TOTALYRM>*<cm:BTU/UNIT>,                                     HVAC29 362
     &        (<cm;METERSYRMMO>,<cm;METERSYRMDY>,IE=1,12),                      HVAC29 363
     &         <cm;TOTALYRMMO>,<cm;TOTALYRMDY>,                                 HVAC29 364
     &        (<cm;EndUsePeakYr>*<cm:BTU/UNIT>,IE=1,12),                        HVAC29 365
     &        (<cm;EndUsePeakYr>*Pct,IE=1,12)                                   HVAC29 366
            WRITE (IREPFL) ITWO, <cm:REPORT>, ISEVEN                            HVAC29 367
          ENDIF                                                                 HVAC29 368
        ENDDO                                                                   HVAC29 369
      ENDIF                                                                     HVAC29 370
c                                                                               PLTREP1887
c              BEPS report                                                      PLTREP1888
      IF (IREPRT(3,26) .GT. 0)  THEN                                            PLTREP1889
        IUNIQ = IREPRT(3,26)                                                    PLTREP1890
        DO  I=1,13                                                              PLTREP1891
          BEPStot(I) = 0.                                                       PLTREP1892
        ENDDO                                                                   PLTREP1893
        BEPsource = 0.                                                          PLTREP1894
        II = 1                                                                  PLTREP1895
c              electric meters                                                  PLTREP1896
        DO  IM=1,Nem                                                            PLTREP1897
          Jem = Iem + (IM-1)*Lem                                                PLTREP1898
          IF (<em:TYPE> .EQ. UtilityMeter)  THEN                                PLTREP1899
            WRITE (IREPFL) I22, IUNIQ, IONE, ITWO, I18,                         PLTREP1900
     &          <em:NAME>, (MeterType(I,1),I=1,4),                              PLTREP1901
     &         (<em;NetUseYr>*BTUKW,IE=1,12), <em;NetTotalYr>*BTUKW             PLTREP1902
            DO  IE=1,12                                                         PLTREP1903
              BEPStot(IE) = BEPStot(IE) + <em;NetUseYr>*BTUKW                   PLTREP1904
            ENDDO                                                               PLTREP1905
            BEPStot(13) = BEPStot(13) + <em;NetTotalYr>*BTUKW                   PLTREP1906
c              sum the source energy                                            PLTREP1907
            BEPsource = BEPsource                                               PLTREP1908
     &                + <em;NetTotalYr>*BTUKW/<em:SOURCE-EFF>                   PLTREP1909
          ELSEIF (<em:TYPE> .EQ. SellMeter)  THEN                               PLTREP1910
            WRITE (IREPFL) I22, IUNIQ, IONE, ITWO, I18,                         PLTREP1911
     &          <em:NAME>, (MeterType(I,5),I=1,4),                              PLTREP1912
     &         (0.,IE=1,12), -<em;NetTotalYr>*BTUKW                             PLTREP1913
            BEPStot(13) = BEPStot(13) - <em;NetTotalYr>*BTUKW                   PLTREP1914
c              sum the source energy                                            PLTREP1915
            BEPsource = BEPsource                                               PLTREP1916
     &                - <em;NetTotalYr>*BTUKW/<em:SOURCE-EFF>                   PLTREP1917
          ENDIF                                                                 PLTREP1918
        ENDDO                                                                   PLTREP1919
c              fuel meters                                                      PLTREP1920
        DO  IM=1,Nfm                                                            PLTREP1921
          Jfm = Ifm + (IM-1)*Lfm                                                PLTREP1922
          WRITE (IREPFL) I22, IUNIQ, IONE, ITWO, I18,                           PLTREP1923
     &      <fm:NAME>,(FuelType(I,<fm:TYPE>),I=1,4),                            PLTREP1924
     &     (<fm;METERSYR>,IE=1,12), <fm;TOTALYR>                                PLTREP1925
c              cogeneration sales                                               PLTREP1926
          IE = 13                                                               PLTREP1927
          IF (<fm;METERSYR> .GT. 0.)                                            PLTREP1928
     &      WRITE (IREPFL) IFIVE, IUNIQ, IONE, ISIX, IONE,                      PLTREP1929
     &        <fm;METERSYR>                                                     PLTREP1930
c              sum over all meters                                              PLTREP1931
          DO  IE=1,12                                                           PLTREP1932
            BEPStot(IE) = BEPStot(IE) + <fm;METERSYR>                           PLTREP1933
          ENDDO                                                                 PLTREP1934
          BEPStot(13) = BEPStot(13) + <fm;TOTALYR>                              PLTREP1935
c              sum the source energy                                            PLTREP1936
          BEPsource = BEPsource + <fm;TOTALYR>/<fm:SOURCE-EFF>                  PLTREP1937
        ENDDO                                                                   PLTREP1938
c              steam meters                                                     PLTREP1939
        DO  IM=1,Nsm                                                            PLTREP1940
          Jsm = Ism + (IM-1)*Lsm                                                PLTREP1941
          WRITE (IREPFL) I22, IUNIQ, IONE, ITWO, I18,                           PLTREP1942
     &      <sm:NAME>, (MeterType(I,3),I=1,4),                                  PLTREP1943
     &     (<sm;METERSYR>,IE=1,12), <sm;TOTALYR>                                PLTREP1944
          DO  IE=1,12                                                           PLTREP1945
            BEPStot(IE) = BEPStot(IE) + <sm;METERSYR>                           PLTREP1946
          ENDDO                                                                 PLTREP1947
          BEPStot(13) = BEPStot(13) + <sm;TOTALYR>                              PLTREP1948
c              sum the source energy                                            PLTREP1949
          BEPsource = BEPsource + <sm;TOTALYR>/<sm:SOURCE-EFF>                  PLTREP1950
        ENDDO                                                                   PLTREP1951
c              chilled-water meters                                             PLTREP1952
        DO  IM=1,Ncm                                                            PLTREP1953
          Jcm = Icm + (IM-1)*Lcm                                                PLTREP1954
          WRITE (IREPFL) I22, IUNIQ, IONE, ITWO, I18,                           PLTREP1955
     &      <cm:NAME>, (MeterType(I,4),I=1,4),                                  PLTREP1956
     &     (<cm;METERSYR>,IE=1,12),  <cm;TOTALYR>                               PLTREP1957
          DO  IE=1,12                                                           PLTREP1958
            BEPStot(IE) = BEPStot(IE) + <cm;METERSYR>                           PLTREP1959
          ENDDO                                                                 PLTREP1960
          BEPStot(13) = BEPStot(13) + <cm;TOTALYR>                              PLTREP1961
c              sum the source energy                                            PLTREP1962
          BEPsource = BEPsource + <cm;TOTALYR>/<cm:SOURCE-EFF>                  PLTREP1963
        ENDDO                                                                   PLTREP1964
        WRITE (IREPFL) I17, IUNIQ, IONE, ITHREE, I13,                           PLTREP1965
     &    (BEPStot(IE),IE=1,13)                                                 PLTREP1966
        WRITE (IREPFL) I14, IUNIQ, IONE, IFOUR, ITEN,                           -047e   30
     &    BEPStot(13), BEPStot(13)/BGAREA, BEPStot(13)/BNAREA,                  PLTREP1968
     &    BEPsource,   BEPsource/BGAREA,   BEPsource/BNAREA,                    PLTREP1969
     &    PctSysOvrld, PctPltOvrld, <pr.HrsOvrldClYr>, <pr.HrsOvrldHtYr>        -047e   31
        IF (Ntk .GT. 0)  WRITE (IREPFL) IFOUR, IUNIQ, IONE, IFIVE, IZERO        PLTREP1971
        WRITE (IREPFL) ITWO, IUNIQ, ISEVEN                                      PLTREP1972
        IF (ITDV .gt. 0)  THEN  ! TDV1 report                                   -044   170
          IUNIQ   = IUNIQ + 1                                                   -044   171
          BEPsite = 0.          ! sum of TDV site energy                        -044   172
          DO  IE=1,12                                                           -044   173
            BEPsite     = BEPsite + BEPStot(IE) * <mm;IncludeTDV>               -044   174
            BEPStot(IE) = 0.                                                    -044   175
          ENDDO                                                                 -044   176
          BEPStot(13) = 0.      ! sum of TDV source energy                      -044   177
          II = 1                                                                -044   178
c              electric meters                                                  -044   179
          DO  IM=1,Nem                                                          -044   180
            Jem = Iem + (IM-1)*Lem                                              -044   181
            IF (<em:TYPE> .EQ. UtilityMeter)  THEN                              -044   182
              Ktv = <em;Ktv>                                                    -044   183
              WRITE (IREPFL) I22, IUNIQ, IONE, ITWO, I18,                       -044   184
     &          <em:NAME>, (MeterType(I,1),I=1,4),                              -044   185
     &         (<tv.NetEndUseYr>,IE=1,12), <tv.NetTotYr>                        -044   186
              DO  IE=1,12                                                       -044   187
                BEPStot(IE) = BEPStot(IE) + <tv.NetEndUseYr>                    -044   188
              ENDDO                                                             -044   189
              BEPStot(13) = BEPStot(13) + <tv.NetTotYr>                         -044   190
            ELSEIF (<em:TYPE> .EQ. SellMeter)  THEN                             -044   191
              WRITE (IREPFL) I22, IUNIQ, IONE, ITWO, I18,                       -044   192
     &          <em:NAME>, (MeterType(I,5),I=1,4),                              -044   193
     &          (0.,IE=1,12), -<tv.NetTotYr>                                    -044   194
              BEPStot(13) = BEPStot(13) - <tv.NetTotYr>                         -044   195
            ENDIF                                                               -044   196
          ENDDO                                                                 -044   197
c              fuel meters                                                      -044   198
          DO  IM=1,Nfm                                                          -044   199
            Jfm = Ifm + (IM-1)*Lfm                                              -044   200
            Ktv = <fm;Ktv>                                                      -044   201
            WRITE (IREPFL) I22, IUNIQ, IONE, ITWO, I18,                         -044   202
     &        <fm:NAME>,(FuelType(I,<fm:TYPE>),I=1,4),                          -044   203
     &        (<tv.EndUseYr>,IE=1,12),<tv.TotYr>                                -044   204
c              cogeneration sales                                               -044   205
            IE = 13                                                             -044   206
            IF (<tv.EndUseYr> .GT. 0.)                                          -044   207
     &        WRITE (IREPFL) IFIVE, IUNIQ, IONE, ISIX, IONE,                    -044   208
     &          <tv.EndUseYr>                                                   -044   209
c              sum over all meters                                              -044   210
            DO  IE=1,12                                                         -044   211
              BEPStot(IE) = BEPStot(IE) + <tv.EndUseYr>                         -044   212
            ENDDO                                                               -044   213
            BEPStot(13) = BEPStot(13) + <tv.TotYr>                              -044   214
          ENDDO                                                                 -044   215
          WRITE (IREPFL) I17, IUNIQ, IONE, ITHREE, I13,                         -044   216
     &      (BEPStot(IE),IE=1,13)                                               -044   217
          WRITE (IREPFL) I14, IUNIQ, IONE, IFOUR, ITEN,                         -047e   32
     &      BEPsite, BEPsite/BGAREA, BEPsite/BNAREA,                            -044   219
     &      BEPStot(13), BEPStot(13)/BGAREA, BEPStot(13)/BNAREA,                -044   220
     &      PctSysOvrld, PctPltOvrld, <pr.HrsOvrldClYr>,                        -047e   33
     &      <pr.HrsOvrldHtYr>                                                   -047e   34
          IF (Ntk .GT. 0)  WRITE (IREPFL) IFOUR,IUNIQ,IONE,IFIVE,IZERO          -044   222
          WRITE (IREPFL) ITWO, IUNIQ, ISEVEN                                    -044   223
        ENDIF  ! ITDV                                                           -044   224
      ENDIF                                                                     PLTREP1973
c                                                                               PLTREP1974
c              BEPU                                                             PLTREP1975
      IF (IREPRT(3,27) .GT. 0)  THEN                                            PLTREP1976
        IUNIQ = IREPRT(3,27)                                                    PLTREP1977
        DO  I=1,11                                                              PLTREP1978
          BEPSUtot(I) = 0.                                                      PLTREP1979
        ENDDO                                                                   PLTREP1980
        II = 1                                                                  PLTREP1981
c              electric meters                                                  PLTREP1982
        DO  IM=1,Nem                                                            PLTREP1983
          Jem = Iem + (IM-1)*Lem                                                PLTREP1984
          IF (<em:TYPE> .EQ. UtilityMeter)  THEN                                PLTREP1985
            WRITE(IREPFL) I24, IUNIQ, IONE, ITWO, I20,                          PLTREP1986
     &          <em:NAME>, (MeterType(I,1),I=1,4),                              PLTREP1987
     &          (JUNITT(I,<em:UNIT-INDEX>,IUNIT),I=1,2),                        PLTREP1988
     &          (<em;NetUseYr>,IE=1,12), <em;NetTotalYr>                        PLTREP1989
            BEPSUtot(1)  = BEPSUtot(1) + <em;NetTotalYr>                        PLTREP1990
            BEPSUunit(1) = <em:UNIT-INDEX>                                      PLTREP1991
          ELSEIF (<em:TYPE> .EQ. SellMeter)  THEN                               PLTREP1992
            WRITE(IREPFL) I24, IUNIQ, IONE, ITWO, I20,                          PLTREP1993
     &          <em:NAME>, (MeterType(I,1),I=1,4),                              PLTREP1994
     &          (JUNITT(I,<em:UNIT-INDEX>,IUNIT),I=1,2),                        PLTREP1995
     &          (0.,IE=1,12), -<em;NetTotalYr>                                  PLTREP1996
            BEPSUtot(1)  = BEPSUtot(1) - <em;NetTotalYr>                        PLTREP1997
            BEPSUunit(1) = <em:UNIT-INDEX>                                      PLTREP1998
          ENDIF                                                                 PLTREP1999
        ENDDO                                                                   PLTREP2000
c              fuel meters                                                      PLTREP2001
        DO  IM=1,Nfm                                                            PLTREP2002
          Jfm = Ifm + (IM-1)*Lfm                                                PLTREP2003
          WRITE(IREPFL) I24, IUNIQ, IONE, ITWO, I20,                            PLTREP2004
     &        <fm:NAME>,(FuelType(I,<fm:TYPE>),I=1,4),                          PLTREP2005
     &        (JUNITT(I,<fm:UNIT-INDEX>,IUNIT),I=1,2),                          PLTREP2006
     &        (<fm;METERSYR>*<fm:BTU/UNIT>,IE=1,12),                            PLTREP2007
     &         <fm;TOTALYR>*<fm:BTU/UNIT>                                       PLTREP2008
c              cogeneration sales                                               PLTREP2009
          IE = 13                                                               PLTREP2010
          IF (<fm;METERSYR> .GT. 0.)                                            PLTREP2011
     &      WRITE (IREPFL) ISEVEN, IUNIQ, IONE, IEIGHT, ITHREE,                 PLTREP2012
     &        <fm;METERSYR>*<fm:BTU/UNIT>,                                      PLTREP2013
     &        (JUNITT(I,<fm:UNIT-INDEX>,IUNIT),I=1,2)                           PLTREP2014
c              sum over all meters                                              PLTREP2015
          BEPSUtot(<fm:TYPE>+1)  = BEPSUtot(<fm:TYPE>+1)                        PLTREP2016
     &                                    + <fm;TOTALYR>*<fm:BTU/UNIT>          PLTREP2017
          BEPSUunit(<fm:TYPE>+1) = <fm:UNIT-INDEX>                              PLTREP2018
        ENDDO                                                                   PLTREP2019
c              steam meters                                                     PLTREP2020
        DO  IM=1,Nsm                                                            PLTREP2021
          Jsm = Ism + (IM-1)*Lsm                                                PLTREP2022
          WRITE(IREPFL) I24, IUNIQ, IONE, ITWO, I20,                            PLTREP2023
     &        <sm:NAME>,(MeterType(I,3),I=1,4),                                 PLTREP2024
     &        (JUNITT(I,<sm:UNIT-INDEX>,IUNIT),I=1,2),                          PLTREP2025
     &        (<sm;METERSYR>*<sm:BTU/UNIT>,IE=1,12),                            PLTREP2026
     &         <sm;TOTALYR>*<sm:BTU/UNIT>                                       PLTREP2027
          BEPSUtot(9)  = BEPSUtot(9) + <sm;TOTALYR>*<sm:BTU/UNIT>               PLTREP2028
          BEPSUunit(9) = <sm:UNIT-INDEX>                                        PLTREP2029
        ENDDO                                                                   PLTREP2030
c              chilled-water meters                                             PLTREP2031
        DO  IM=1,Ncm                                                            PLTREP2032
          Jcm = Icm + (IM-1)*Lcm                                                PLTREP2033
          WRITE(IREPFL) I24, IUNIQ, IONE, ITWO, I20,                            PLTREP2034
     &        <cm:NAME>,(MeterType(I,4),I=1,4),                                 PLTREP2035
     &        (JUNITT(I,<cm:UNIT-INDEX>,IUNIT),I=1,2),                          PLTREP2036
     &        (<cm;METERSYR>*<cm:BTU/UNIT>,IE=1,12),                            PLTREP2037
     &         <cm;TOTALYR>*<cm:BTU/UNIT>                                       PLTREP2038
          BEPSUtot(10)  = BEPSUtot(10) + <cm;TOTALYR>*<cm:BTU/UNIT>             PLTREP2039
          BEPSUunit(10) = <cm:UNIT-INDEX>                                       PLTREP2040
        ENDDO                                                                   PLTREP2041
c              print the summary                                                PLTREP2042
        WRITE (IREPFL) IFOUR, IUNIQ, IONE, IFIVE, IZERO                         PLTREP2043
c              electric                                                         PLTREP2044
        IF (BEPSUtot(1) .NE. 0.)                                                PLTREP2045
     &    WRITE (IREPFL) I16, IUNIQ, IONE, ITHREE, I12,                         PLTREP2046
     &      (MeterType(I,1),I=1,3), BEPSUtot(1),                                PLTREP2047
     &                          (JUNITT(I,BEPSUunit(1),IUNIT),I=1,2),           PLTREP2048
     &      BEPSUtot(1)/BGAREA,                                                 PLTREP2049
     &                          (JUNITT(I,BEPSUunit(1),IUNIT),I=1,2),           PLTREP2050
     &      BEPSUtot(1)/BNAREA,                                                 PLTREP2051
     &                          (JUNITT(I,BEPSUunit(1),IUNIT),I=1,2)            PLTREP2052
c              fuel - meters of the same fuel type are combined                 PLTREP2053
        DO  J=2,8                                                               PLTREP2054
          IF (BEPSUtot(J) .NE. 0.)                                              PLTREP2055
     &      WRITE (IREPFL) I16, IUNIQ, IONE, ITHREE, I12,                       PLTREP2056
     &        (FuelType(I,J-1),I=1,3), BEPSUtot(J),                             PLTREP2057
     &                            (JUNITT(I,BEPSUunit(J),IUNIT),I=1,2),         PLTREP2058
     &        BEPSUtot(J)/BGAREA,                                               PLTREP2059
     &                            (JUNITT(I,BEPSUunit(J),IUNIT),I=1,2),         PLTREP2060
     &        BEPSUtot(J)/BNAREA,                                               PLTREP2061
     &                            (JUNITT(I,BEPSUunit(J),IUNIT),I=1,2)          PLTREP2062
        ENDDO                                                                   PLTREP2063
c              steam                                                            PLTREP2064
        IF (BEPSUtot(9) .NE. 0.)                                                PLTREP2065
     &    WRITE (IREPFL) I16, IUNIQ, IONE, ITHREE, I12,                         PLTREP2066
     &      (MeterType(I,3),I=1,3), BEPSUtot(9),                                PLTREP2067
     &                          (JUNITT(I,BEPSUunit(9),IUNIT),I=1,2),           PLTREP2068
     &      BEPSUtot(9)/BGAREA,                                                 PLTREP2069
     &                          (JUNITT(I,BEPSUunit(9),IUNIT),I=1,2),           PLTREP2070
     &      BEPSUtot(9)/BNAREA,                                                 PLTREP2071
     &                          (JUNITT(I,BEPSUunit(9),IUNIT),I=1,2)            PLTREP2072
c              chilled-water                                                    PLTREP2073
        IF (BEPSUtot(10) .NE. 0.)                                               PLTREP2074
     &    WRITE (IREPFL) I16, IUNIQ, IONE, ITHREE, I12,                         PLTREP2075
     &      (MeterType(I,4),I=1,3), BEPSUtot(10),                               PLTREP2076
     &                           (JUNITT(I,BEPSUunit(10),IUNIT),I=1,2),         PLTREP2077
     &      BEPSUtot(10)/BGAREA,                                                PLTREP2078
     &                           (JUNITT(I,BEPSUunit(10),IUNIT),I=1,2),         PLTREP2079
     &      BEPSUtot(10)/BNAREA,                                                PLTREP2080
     &                           (JUNITT(I,BEPSUunit(10),IUNIT),I=1,2)          PLTREP2081
        WRITE (IREPFL) IEIGHT, IUNIQ, IONE, IFOUR, IFOUR,                       -047e   35
     &    PctSysOvrld, PctPltOvrld, <pr.HrsOvrldClYr>, <pr.HrsOvrldHtYr>        -047e   36
        IF (Ntk .GT. 0)  WRITE (IREPFL) IFOUR, IUNIQ, IONE, ISIX, IZERO         PLTREP2084
        WRITE (IREPFL) ITWO, IUNIQ, ISEVEN                                      PLTREP2085
      ENDIF                                                                     PLTREP2086
c                                                                               PLTREP2087
c              circulation loops                                                PLTREP2088
      DO  NL=1,Nlp                                                              PLTREP2089
        Jlp = Ilp + (NL-1)*Llp                                                  PLTREP2090
        IUNIQ = <lp;PS-H_IUNIQ>                                                 PLTREP2091
        IF (IUNIQ .GT. 0)  THEN                                                 PLTREP2092
          LoopType = <lp:TYPE>                                                  PLTREP2093
          IF (LoopType .NE. WLHP)  THEN                                         PLTREP2094
            WRITE(IREPFL) IFOUR,IUNIQ,IONE,ISIX,IZERO                           PLTREP2095
            IF (LoopType .NE. CHW  .AND.  LoopType .NE. CW)                     PLTREP2096
     &        WRITE(IREPFL) I45  ,IUNIQ,IONE,ISEVEN,I41,IHYR,                   PLTREP2097
     &          <lp;COILHYR>,    <lp;LOSSHYR>,   <lp;TOTALHYR>,                 PLTREP2098
     &          <lp;OVRLDHYR>,   (<lp;QHPLRYR>,II=1,12),                        PLTREP2099
     &          <lp;COILHYRM>,   <lp;LOSSHYRM>,  <lp;TOTALHYRM>,                PLTREP2100
     &          <lp;OVRLDHYRM>,  (<lp;GPMHPLRYR>,II=1,12),                      PLTREP2101
     &          <lp;COILHYRMMO>, <lp;COILHYRMDY>,<lp;LOSSHYRMMO>,               PLTREP2102
     &          <lp;LOSSHYRMDY>, <lp;TOTALHYRMMO>,<lp;TOTALHYRMDY>,             PLTREP2103
     &          <lp;OVRLDHYRMMO>,<lp;OVRLDHYRMDY>                               PLTREP2104
            IF (LoopType .EQ. CHW  .OR.  LoopType .EQ. CW                       PLTREP2105
     &                             .OR.  LoopType .EQ. PIPE2)                   PLTREP2106
     &        WRITE(IREPFL) I45  ,IUNIQ,IONE,IEIGHT,I41,IHYR,                   PLTREP2107
     &          <lp;COILCYR>,   <lp;LOSSCYR>,  <lp;TOTALCYR>,                   PLTREP2108
     &          <lp;OVRLDCYR>,  (<lp;QCPLRYR>,II=1,12),                         PLTREP2109
     &          <lp;COILCYRM>,  <lp;LOSSCYRM>, <lp;TOTALCYRM>,                  PLTREP2110
     &          <lp;OVRLDCYRM>, (<lp;GPMCPLRYR>,II=1,12),                       PLTREP2111
     &          <lp;COILCYRMMO>, <lp;COILCYRMDY>,<lp;LOSSCYRMMO>,               PLTREP2112
     &          <lp;LOSSCYRMDY>, <lp;TOTALCYRMMO>,<lp;TOTALCYRMDY>,             PLTREP2113
     &          <lp;OVRLDCYRMMO>,<lp;OVRLDCYRMDY>                               PLTREP2114
            WRITE(IREPFL) IFOUR,IUNIQ,IONE,ITHREE,IZERO                         -041h    7
            IF (<lp;PeakTHYr> .ne. 0.)                                          -041h    8
     &        WRITE(IREPFL) ISEVEN,IUNIQ,IONE,I11,ITHREE,                       -041h    9
     &          <lp;PeakTHYr>, <lp;PeakDBTHYr>, <lp;PeakWBTHYr>                 -041h   10
            IF (<lp;PeakTCYr> .ne. 0.)                                          -041h   11
     &        WRITE(IREPFL) ISEVEN,IUNIQ,IONE,I12,ITHREE,                       -041h   12
     &          <lp;PeakTCYr>, <lp;PeakDBTCYr>, <lp;PeakWBTCYr>                 -041h   13
c              overload hours                                                   PLTREP2115
            IF (<lp;HR_HEAT_OVRLD> + <lp;HR_COOL_OVRLD> .GT. 0)  THEN           PLTREP2116
              WRITE(IREPFL) IFOUR,IUNIQ,IONE,ITHREE,IZERO                       PLTREP2117
              IF (<lp;HR_HEAT_OVRLD> .GT. 0)                                    PLTREP2118
     &          WRITE(IREPFL) IFIVE, IUNIQ,IONE,ININE,IONE,                     PLTREP2119
     &            <lp;HR_HEAT_OVRLD>                                            PLTREP2120
              IF (<lp;HR_COOL_OVRLD> .GT. 0)                                    PLTREP2121
     &          WRITE(IREPFL) IFIVE, IUNIQ,IONE,ITEN,IONE,                      PLTREP2122
     &            <lp;HR_COOL_OVRLD>                                            PLTREP2123
            ENDIF                                                               PLTREP2124
          ELSE                                                                  PLTREP2125
c              wlhp has its own report                                          PLTREP2126
            WRITE(IREPFL) IFOUR,IUNIQ,IONE,ISEVEN,IZERO                         PLTREP2127
c              heating dominated and coincident cooling                         PLTREP2128
            WRITE(IREPFL) I49  ,IUNIQ,IONE,IEIGHT,I45,IHYR,                     PLTREP2129
     &        <lp;COILHYR>,     <lp;COILHCYR>,  <lp;LOSSHYR>,                   PLTREP2130
     &        <lp;TOTALHYR>,    <lp;OVRLDHYR>,                                  PLTREP2131
     &                                          (<lp;QHPLRYR>,II=1,12),         PLTREP2132
     &        <lp;COILHYRM>,    <lp;COILHCYRM>, <lp;LOSSHYRM>,                  PLTREP2133
     &        <lp;TOTALHYRM>,   <lp;OVRLDHYRM>,                                 PLTREP2134
     &                                        (<lp;GPMHPLRYR>,II=1,12),         PLTREP2135
     &        <lp;COILHYRMMO>,  <lp;COILHYRMDY>,                                PLTREP2136
     &        <lp;COILHCYRMMO>, <lp;COILHCYRMDY>,                               PLTREP2137
     &        <lp;LOSSHYRMMO>,  <lp;LOSSHYRMDY>,                                PLTREP2138
     &        <lp;TOTALHYRMMO>, <lp;TOTALHYRMDY>,                               PLTREP2139
     &        <lp;OVRLDHYRMMO>, <lp;OVRLDHYRMDY>                                PLTREP2140
c              cooling dominated and coincident heating                         PLTREP2141
            WRITE(IREPFL) I49  ,IUNIQ,IONE,ININE,I45,IHYR,                      PLTREP2142
     &        <lp;COILCHYR>,    <lp;COILCYR>,   <lp;LOSSCYR>,                   PLTREP2143
     &        <lp;TOTALCYR>,    <lp;OVRLDCYR>,                                  PLTREP2144
     &                                          (<lp;QCPLRYR>,II=1,12),         PLTREP2145
     &        <lp;COILCHYRM>,   <lp;COILCYRM>,  <lp;LOSSCYRM>,                  PLTREP2146
     &        <lp;TOTALCYRM>,   <lp;OVRLDCYRM>,                                 PLTREP2147
     &                                        (<lp;GPMCPLRYR>,II=1,12),         PLTREP2148
     &        <lp;COILCHYRMMO>, <lp;COILCHYRMDY>,                               PLTREP2149
     &        <lp;COILCYRMMO>,  <lp;COILCYRMDY>,                                PLTREP2150
     &        <lp;LOSSCYRMMO>,  <lp;LOSSCYRMDY>,                                PLTREP2151
     &        <lp;TOTALCYRMMO>, <lp;TOTALCYRMDY>,                               PLTREP2152
     &        <lp;OVRLDCYRMMO>, <lp;OVRLDCYRMDY>                                PLTREP2153
c              heating and cooling while floating                               PLTREP2154
            WRITE(IREPFL) I30  ,IUNIQ,IONE,ITEN,I26,IHYR,                       PLTREP2155
     &        <lp;COILFHYR>,    <lp;COILFCYR>,  <lp;LOSSFYR>,                   PLTREP2156
     &                                         <lp;FLOATYR>,                    PLTREP2157
     &        <lp;COILFHYRM>,   <lp;COILFCYRM>, <lp;LOSSFYRM>,                  PLTREP2158
     &                                        (<lp;GPMFPLRYR>,II=1,12),         PLTREP2159
     &        <lp;COILFHYRMMO>, <lp;COILFHYRMDY>,                               PLTREP2160
     &        <lp;COILFCYRMMO>, <lp;COILFCYRMDY>,                               PLTREP2161
     &        <lp;LOSSFYRMMO>,  <lp;LOSSFYRMDY>                                 PLTREP2162
c              grand totals                                                     PLTREP2163
            WRITE(IREPFL) I24  ,IUNIQ,IONE,I11,I20,                             PLTREP2164
     &        (<lp;COILHYR>+<lp;COILCHYR>+<lp;COILFHYR>),                       PLTREP2165
     &        (<lp;COILHCYR>+<lp;COILCYR>+<lp;COILFCYR>),                       PLTREP2166
     &        (<lp;GPMHPLRYR>+<lp;GPMCPLRYR>+<lp;GPMFPLRYR>,II=1,12),           PLTREP2167
     &        <lp;COILHYRM>,    <lp;COILCYRM>,                                  PLTREP2168
     &        <lp;COILHYRMMO>,  <lp;COILHYRMDY>,                                PLTREP2169
     &        <lp;COILCHYRMMO>, <lp;COILCHYRMDY>                                PLTREP2170
            WRITE(IREPFL) IFOUR,IUNIQ,IONE,ITHREE,IZERO                         -041h   14
            WRITE(IREPFL) ISEVEN,IUNIQ,IONE,I16,ITHREE,                         -041h   15
     &        <lp;PeakTHYr>, <lp;PeakDBTHYr>, <lp;PeakWBTHYr>                   -041h   16
            WRITE(IREPFL) ISEVEN,IUNIQ,IONE,I17,ITHREE,                         -041h   17
     &        <lp;PeakTCYr>, <lp;PeakDBTCYr>, <lp;PeakWBTCYr>                   -041h   18
c              overload hours                                                   PLTREP2171
            IF (<lp;HR_HEAT_OVRLD> + <lp;HR_COOL_OVRLD> .GT. 0)  THEN           PLTREP2172
              WRITE(IREPFL) IFOUR,IUNIQ,IONE,ITHREE,IZERO                       PLTREP2173
              IF (<lp;HR_HEAT_OVRLD> .GT. 0)                                    PLTREP2174
     &          WRITE(IREPFL) IFIVE, IUNIQ,IONE,I12,IONE,                       PLTREP2175
     &            <lp;HR_HEAT_OVRLD>                                            PLTREP2176
              IF (<lp;HR_COOL_OVRLD> .GT. 0)                                    PLTREP2177
     &          WRITE(IREPFL) IFIVE, IUNIQ,IONE,I13,IONE,                       PLTREP2178
     &            <lp;HR_COOL_OVRLD>                                            PLTREP2179
            ENDIF                                                               PLTREP2180
            WRITE(IREPFL) ISIX, IUNIQ,IONE,I15,ITWO,                            Bug40  297
     &        <lp;NumHiAlarm>, <lp;NumLoAlarm>                                  Bug40  298
            WRITE(IREPFL) IFOUR, IUNIQ, IONE, I14, IZERO                        PLTREP2181
          ENDIF                                                                 PLTREP2182
          WRITE(IREPFL) ITWO,IUNIQ,ISEVEN                                       PLTREP2183
        ENDIF                                                                   PLTREP2184
      ENDDO                                                                     PLTREP2185
c              pumps                                                            PLTREP2186
      DO  Neq=1,Npm                                                             PLTREP2187
        Jpm   = Ipm + (Neq-1)*Lpm                                               PLTREP2188
        IUNIQ = <pm;PS-H_IUNIQ>                                                 PLTREP2189
        IF (IUNIQ .GT. 0)  THEN                                                 PLTREP2190
          WRITE(IREPFL) I49,IUNIQ,IONE,IFIVE,I45,IHYR,                          PLTREP2191
     &      <pm;QHYR>,  <pm;KWHYR>,  (<pm;GPMPLRYR>,II=1,12),                   PLTREP2192
     &      <pm;QHYRM>, <pm;KWHYRM>, (<pm;RPMPLRYR>,II=1,12),                   PLTREP2193
     &      <pm;QHYRMMO>,<pm;QHYRMDY>,<pm;KWHYRMMO>,                            PLTREP2194
     &      <pm;KWHYRMDY>,(<pm;KWHPLRYR>,II=1,12)                               PLTREP2195
          WRITE(IREPFL) IFIVE,IUNIQ,IONE,ISEVEN,IONE,<pm;HRS_OVRLD>             PLTREP2196
          WRITE(IREPFL) ITWO,IUNIQ,ISEVEN                                       PLTREP2197
        ENDIF                                                                   PLTREP2198
      ENDDO                                                                     PLTREP2199
c                                                                               PLTREP2200
c              Reports using Jpe                                                PLTREP2201
      CALL PlantReports_Jpe(2)                                                  PLTREP2202
c              chillers                                                         PLTREP2203
      DO  Neq=1,Nch                                                             PLTREP2204
        Jch   = Ich + (Neq-1)*Lch                                               PLTREP2205
        Jpe   = <ch;Jpe>                                                        PLTREP2206
c ?quck IUNIQ = <pe;PS-H_IUNIQ>                                                 PLTREP2207
        IUNIQ = <ch;PS-H_IUNIQ>                                                 PLTREP2208
        IF (IUNIQ .GT. 0)  THEN                                                 PLTREP2209
          IF (<ch:HIR> .GT. 0.)  THEN                                           PLTREP2210
            WRITE(IREPFL) I57,IUNIQ,IONE,IEIGHT,I53,IHYR,                       PLTREP2211
     &        <ch;QYR>, <ch;QRECVRYR>, <ch;KWHYR>, <ch;FUELYR>,                 PLTREP2212
     &                                       (<ch;QPLRYR>,II=1,12),             PLTREP2213
     &        <ch;QYRM>, <ch;QRECVRYRM>, <ch;KWHYRM>, <ch;FUELYRM>,             PLTREP2214
     &                                       (<ch;KWHPLRYR>,II=1,12),           PLTREP2215
     &        <ch;QYRMMO>, <ch;QYRMDY>,                                         PLTREP2216
     &        <ch;QRECVRYRMMO>, <ch;QRECVRYRMDY>,                               PLTREP2217
     &        <ch;KWHYRMMO>, <ch;KWHYRMDY>,                                     PLTREP2218
     &        <ch;FUELYRMMO>, <ch;FUELYRMDY>,(<ch;FUELPLRYR>,II=1,12)           PLTREP2219
          ELSE                                                                  PLTREP2220
            WRITE(IREPFL) I45,IUNIQ,IONE,IEIGHT,I41,IHYR,                       PLTREP2221
     &        <ch;QYR>, <ch;QRECVRYR>, <ch;KWHYR>, <ch;AUXYR>,                  PLTREP2222
     &                                         (<ch;QPLRYR>,II=1,12),           PLTREP2223
     &        <ch;QYRM>, <ch;QRECVRYRM>, <ch;KWHYRM>, <ch;AUXYRM>,              PLTREP2224
     &                                       (<ch;KWHPLRYR>,II=1,12),           PLTREP2225
     &        <ch;QYRMMO>, <ch;QYRMDY>,                                         PLTREP2226
     &        <ch;QRECVRYRMMO>,<ch;QRECVRYRMDY>,                                PLTREP2227
     &        <ch;KWHYRMMO>, <ch;KWHYRMDY>,                                     PLTREP2228
     &        <ch;AUXYRMMO>,<ch;AUXYRMDY>                                       PLTREP2229
          ENDIF                                                                 PLTREP2230
c              normalized (ARI) chiller capacity and conditions                 -041h   19
          CapNormal = <ch;QYRM>                                                 -041h   20
     &              / CVAL(<ch:CAP-FT>,<ch;PeakCHWSYr>,<ch;PeakTcondYr>)        -041h   21
          WRITE(IREPFL) ININE,IUNIQ,IONE,ININE,IFIVE,                           -041h   22
     &      CapNormal, <ch;PeakCHWSYr>, <ch;PeakTcondYr>,                       -041h   23
     &                 <ch;PeakDBTYr>, <ch;PeakWBTYr>                           -041h   24
          WRITE(IREPFL) ITWO,IUNIQ,ISEVEN                                       PLTREP2231
        ENDIF                                                                   PLTREP2232
      ENDDO                                                                     PLTREP2233
c              cooling towers                                                   PLTREP2234
      DO  Neq=1,Ntw                                                             PLTREP2235
        Jtw   = Itw + (Neq-1)*Ltw                                               PLTREP2236
        Jpe   = <tw;Jpe>                                                        PLTREP2237
c ?quck IUNIQ = <pe;PS-H_IUNIQ>                                                 PLTREP2238
        IUNIQ = <tw;PS-H_IUNIQ>                                                 PLTREP2239
        IF (IUNIQ .GT. 0)  THEN                                                 PLTREP2240
          WRITE(IREPFL) I45,IUNIQ,IONE,IFIVE,I41,IHYR,                          PLTREP2241
     &      <tw;QYR>, <tw;KWHYR>, <tw;AUXYR>, <tw;AUXHEATYR>,                   PLTREP2242
     &                                         (<tw;QPLRYR>,II=1,12),           PLTREP2243
     &      <tw;QYRM>, <tw;KWHYRM>, <tw;AUXYRM>, <tw;AUXHEATYRM>,               PLTREP2244
     &                                       (<tw;KWHPLRYR>,II=1,12),           PLTREP2245
     &      <tw;QYRMMO>, <tw;QYRMDY>, <tw;KWHYRMMO>, <tw;KWHYRMDY>,             PLTREP2246
     &      <tw;AUXYRMMO>, <tw;AUXYRMDY>,                                       PLTREP2247
     &      <tw;AUXHEATYRMMO>, <tw;AUXHEATYRMDY>                                PLTREP2248
          WRITE(IREPFL) IEIGHT,IUNIQ,IONE,ISIX,IFOUR,                           PLTREP2249
     &      <tw;MAX_T>, <tw;MAX_MO>, <tw;MAX_DAY>, <tw;MAX_HR>                  PLTREP2250
          WRITE(IREPFL) ITWO,IUNIQ,ISEVEN                                       PLTREP2251
        ENDIF                                                                   PLTREP2252
      ENDDO                                                                     PLTREP2253
c              tower free cooling                                               PLTREP2254
c     DO  Neq=1,NFC                                                             PV     162
c       JFC = IFC + (Neq-1)*LFC                                                 PV     163
c       IUNIQ = <TFC_PS-H_IUNIQ>                                                PV     164
c       IF (IUNIQ .GT. 0)  THEN                                                 PV     165
c         WRITE(IREPFL) IONE,IUNIQ,IONE,ITHREE,IONE,IHYR,                       PV     166
c    &                  QUCK                                                    PV     167
c         WRITE(IREPFL) ITWO,IUNIQ,ISEVEN                                       PV     168
c       ENDIF                                                                   PV     169
c     ENDDO                                                                     PV     170
c              domestic water heaters                                           PLTREP2264
      DO  Neq=1,Ndw                                                             PLTREP2265
        Jdw   = Idw + (Neq-1)*Ldw                                               PLTREP2266
        Jpe   = <dw;Jpe>                                                        PLTREP2267
c ?quck IUNIQ = <pe;PS-H_IUNIQ>                                                 PLTREP2268
        IUNIQ = <dw;PS-H_IUNIQ>                                                 PLTREP2269
        IF (IUNIQ .GT. 0)  THEN                                                 PLTREP2270
          WRITE(IREPFL) I57,IUNIQ,IONE,IFIVE,I53,IHYR,                          PLTREP2271
     &      <dw;QYR>, <dw;KWHYR>, <dw;FUELYR>, <dw;AUXYR>,                      PLTREP2272
     &                                          (<dw;QPLRYR>,II=1,12),          PLTREP2273
     &      <dw;QYRM>, <dw;KWHYRM>, <dw;FUELYRM>, <dw;AUXYRM>,                  PLTREP2274
     &                                        (<dw;KWHPLRYR>,II=1,12),          PLTREP2275
     &      <dw;QYRMMO>,<dw;QYRMDY>,<dw;KWHYRMMO>,<dw;KWHYRMDY>,                PLTREP2276
     &      <dw;FUELYRMMO>,<dw;FUELYRMDY>,<dw;AUXYRMMO>,<dw;AUXYRMDY>,          PLTREP2277
     &                                       (<dw;FUELPLRYR>,II=1,12)           PLTREP2278
          WRITE(IREPFL) ITWO,IUNIQ,ISEVEN                                       PLTREP2279
        ENDIF                                                                   PLTREP2280
      ENDDO                                                                     PLTREP2281
c              thermal storage                                                  PLTREP2282
      DO  Neq=1,Ntk                                                             PLTREP2283
        Jtk   = Itk + (Neq-1)*Ltk                                               PLTREP2284
        Jpe   = <tk;Jpe>                                                        PLTREP2285
c ?quck IUNIQ = <pe;PS-H_IUNIQ>                                                 PLTREP2286
        IUNIQ = <tk;PS-H_IUNIQ>                                                 PLTREP2287
        IF (IUNIQ .GT. 0)  THEN                                                 PLTREP2288
          WRITE(IREPFL) I44,IUNIQ,IONE,ISIX,I40,IHYR,                           PLTREP2289
     &      <tk;DCHRG_YR>, <tk;CHRG_YR>, <tk;LOSS_YR>, <tk;AUX_YR>,             PLTREP2290
     &                                      (<tk;DCHRG_PLR_YR>,II=1,12),        PLTREP2291
     &      <tk;DCHRG_YRM>, <tk;CHRG_YRM>, <tk;LOSS_YRM>, <tk;AUX_YRM>,         PLTREP2292
     &                                      (<tk;CHRG_PLR_YR>,II=1,12),         PLTREP2293
     &      <tk;DCHRG_YRM_MO>,<tk;DCHRG_YRM_DY>,                                PLTREP2294
     &      <tk;CHRG_YRM_MO> ,<tk;CHRG_YRM_DY>,                                 PLTREP2295
     &      <tk;LOSS_YRM_MO> ,<tk;LOSS_YRM_DY>,                                 PLTREP2296
     &      <tk;AUX_YRM_MO>  , <tk;AUX_YRM_DY>                                  PLTREP2297
          WRITE(IREPFL) IFIVE,IUNIQ,IONE,ISEVEN,IONE,                           PLTREP2298
     &      ABS(<tk;Q_TANK>-<tk;Q_BASE>)                                        PLTREP2299
          WRITE(IREPFL) ITWO,IUNIQ,ISEVEN                                       PLTREP2300
        ENDIF                                                                   PLTREP2301
      ENDDO                                                                     PLTREP2302
c                                                                               -041N   13
c              Elec-generators, PV modules                                      -041N   14
      DO  Neq=1,Ngn                                                             -041N   15
        Jgn   = Ign + (Neq-1)*Lgn                                               -041N   16
        Jpe   = <gn;Jpe>                                                        -041N   17
        Iuniq = <pe;PS-H_IUNIQ>                                                 -041N   18
        IF (<gn:TYPE> .eq. 4  .and.  Iuniq .gt. 0)  THEN                        -041N   19
          WRITE (Irepfl) Ifour, Iuniq, Ione, I11, Izero                         -041N   20
          WRITE (Irepfl) Itwo,Iuniq,Iseven                                      -041N   21
        ENDIF                                                                   -041N   22
      ENDDO                                                                     -041N   23
      DO  Neq=1,Npv                                                             -041N   24
        Jpv = Ipv + (Neq-1)*Lpv                                                 -041N   25
        Jpe = <pv;Jpe>                                                          -041N   26
        IF (<pe;PS-H_IUNIQ> .gt. 0)  THEN                                       -041N   27
          Iuniq = <pe;PS-H_IUNIQ>                                               -041N   28
          WRITE (Irepfl) Ifour, Iuniq, Ione, Isix, Izero                        -041N   29
          WRITE (Irepfl) Itwo,Iuniq,Iseven                                      -041N   30
        ENDIF                                                                   -041N   31
      ENDDO                                                                     -041N   32
c              Ground-loop heat exchangers                                      -044e5  66
      DO Neq=1,Ngl                                                              -044e5  67
        Jgl = Igl + (Neq-1)*Lgl                                                 -044e5  68
        IF (<gl;PS-H_IUNIQ> .EQ. 0)  Cycle                                      -044e5  69
        WRITE(IREPFL) I43,<gl;PS-H_IUNIQ>,Ione,Ifour,I39, IHYR,                 -044e5  70
     &    <gl.Cool_Yr>,   <gl.Heat_Yr>, (<gl.CoolT_Yr>,II=1,13),                -044e5  71
     &                    <gl.CoolTmax_Yr>, <gl.CoolTmin_Yr>,                   -044e5  72
     &    <gl.Cool_YrM>,  <gl.Heat_YrM>, (<gl.HeatT_Yr>,II=1,13),               -044e5  73
     &                    <gl.HeatTmax_Yr>, <gl.HeatTmin_Yr>,                   -044e5  74
     &    <gl.Cool_YrMo>, <gl.Cool_YrDy>,                                       -044e5  75
     &    <gl.Heat_YrMo>, <gl.Heat_YrDy>                                        -044e5  76
        WRITE(IREPFL) Ifour,<gl;PS-H_IUNIQ>,Ione,Ifive,Izero                    -044e5  77
        WRITE(IREPFL) Itwo,<gl;PS-H_IUNIQ>,Iseven                               -044e5  78
      ENDDO                                                                     -044e5  79
c              Ice Rinks                                                        IcRink 882
      DO  NS=1,NSYS                                                             IcRink 883
        NSP = IS + (NS-1)*NSS                                                   IcRink 884
        IF (<sy;IceRink> .GT. 0)  THEN                                          IcRink 885
          ISZ = <ISZONES>                                                       IcRink 886
          NSZ = <NZONES>                                                        IcRink 887
          DO  NZ=1,NSZ                                                          IcRink 888
            ZP1 = ISZ + (NZ-1)*NZD                                              IcRink 889
            ZP2 = <ZP2>                                                         IcRink 890
            IF (<zn:ICE-RINK> .GT. 0)  CALL IceRink(57, <zn:ICE-RINK>)          IcRink 891
          ENDDO                                                                 IcRink 892
        ENDIF                                                                   IcRink 893
      ENDDO                                                                     IcRink 894
c                                                                               PLTREP2303
c              End of all reports                                               PLTREP2304
      END SELECT                                                                PLTREP2305
c                                                                               PLTREP2306
      RETURN                                                                    PLTREP2307
      END                                                                       PLTREP2308
      SUBROUTINE PlantReports_Jpe(Mode)                                         PTRJPE   2
c                                                                               PTRJPE   3
c              Outputs the monthly and yearly records for the                   PTRJPE   4
c              components using the Jpe block                                   PTRJPE   5
c                                                                               PTRJPE   6
c              Mode =  1  Write monthly report records to PS-H                  PTRJPE   7
c                      2  Write yearly report records to PS-H                   PTRJPE   8
c                      3  Write Jpe records to PS-C                             PTRJPE   9
c                                                                               PTRJPE  10
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /INTS  / IZERO,IONE,ITWO,ITHREE,IFOUR,IFIVE,ISIX,                 /INTS/   2
     &                 ISEVEN,IEIGHT,ININE,ITEN,                                /INTS/   3
     &                 I11,I12,I13,I14,I15,I16,I17,I18,I19,I20,                 /INTS/   4
     &                 I21,I22,I23,I24,I25,I26,I27,I28,I29,I30,                 /INTS/   5
     &                 I31,I32,I33,I34,I35,I36,I37,I38,I39,I40,                 /INTS/   6
     &                 I41,I42,I43,I44,I45,I46,I47,I48,I49,I50,                 /INTS/   7
     &                 I51,I52,I53,I54,I55,I56,I57,I58,I59,I60,                 /INTS/   8
     &                 I61,I62,I63,I64,I65,I66,I67,I68,I69,I70,                 /INTS/   9
     &                 I71,I72,I73,I74,I75,I76,I77,I78,I79,I80,                 /INTS/  10
     &                 I81,I82,I83,I84,I85,I86,I87,I88,I89,I90,                 /INTS/  11
     &                 I91,I92,I93,I94,I95,I96,I97,I98,I99,I100                 /INTS/  12
      INTEGER          INTS(101)                                                /INTS/  13
      EQUIVALENCE      (INTS(1),IZERO)                                          /INTS/  14
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
c                                                                               PTRJPE  17
      DATA IHYR /3HYR /                                                         PTRJPE  18
c                                                                               PTRJPE  19
      GOTO (1,2000,3000), Mode                                                  PTRJPE  20
c                                                                               PTRJPE  21
c                                                                               PTRJPE  22
c============= WRITE MONTHLY RECORDS TO PS-H ================================== PTRJPE  23
    1 CONTINUE                                                                  PTRJPE  24
c              loop through all the blocks and write the monthly records        PTRJPE  25
      DO  Neq=1,Npe                                                             PTRJPE  26
        Jpe   = Ipe + (Neq-1)*Lpe                                               PTRJPE  27
        Iuniq = <pe;PS-H_IUNIQ>                                                 PTRJPE  28
        IF (Iuniq .GT. 0)  THEN                                                 PTRJPE  29
c              number of columns and bins in this report                        PTRJPE  30
          NumCols = <pe;PS-H_COLUMNS>                                           PTRJPE  31
          NumBins = <pe;PS-H_BINS>                                              PTRJPE  32
c              Number of variables in record                                    PTRJPE  33
          NumVars = NumCols*4 + NumBins*12 + 1                                  PTRJPE  34
          Len     = NumVars + 4                                                 PTRJPE  35
          IF (NumBins .EQ. 3)  THEN                                             PTRJPE  36
            WRITE(IREPFL)                                                       PTRJPE  37
     &      Len, Iuniq, IONE, <pe;PS-H_FMT_MON>, NumVars, MONDSC(IMO),          PTRJPE  38
     &      (<pe;MONTH>,     IC=1,NumCols), (<pe;MONTH_BINS_1>,II=1,12),        PTRJPE  39
     &      (<pe;MONTH_MAX>, IC=1,NumCols), (<pe;MONTH_BINS_2>,II=1,12),        PTRJPE  40
     &      (<pe;MONTH_DAY>, <pe;MONTH_HOUR>, IC=1,NumCols),                    PTRJPE  41
     &                                      (<pe;MONTH_BINS_3>,II=1,12)         PTRJPE  42
          ELSEIF (NumBins .EQ. 2)  THEN                                         PTRJPE  43
            WRITE(IREPFL)                                                       PTRJPE  44
     &      Len, Iuniq, IONE, <pe;PS-H_FMT_MON>, NumVars, MONDSC(IMO),          PTRJPE  45
     &      (<pe;MONTH>,     IC=1,NumCols), (<pe;MONTH_BINS_1>,II=1,12),        PTRJPE  46
     &      (<pe;MONTH_MAX>, IC=1,NumCols), (<pe;MONTH_BINS_2>,II=1,12),        PTRJPE  47
     &      (<pe;MONTH_DAY>, <pe;MONTH_HOUR>, IC=1,NumCols)                     PTRJPE  48
          ELSE                                                                  PTRJPE  49
            WRITE(IREPFL)                                                       PTRJPE  50
     &      Len, Iuniq, IONE, <pe;PS-H_FMT_MON>, NumVars, MONDSC(IMO),          PTRJPE  51
     &      (<pe;MONTH>,     IC=1,NumCols), (<pe;MONTH_BINS_1>,II=1,12),        PTRJPE  52
     &      (<pe;MONTH_MAX>, IC=1,NumCols),                                     PTRJPE  53
     &      (<pe;MONTH_DAY>, <pe;MONTH_HOUR>, IC=1,NumCols)                     PTRJPE  54
          ENDIF                                                                 PTRJPE  55
        ENDIF                                                                   PTRJPE  56
      ENDDO                                                                     PTRJPE  57
c                                                                               PTRJPE  58
      RETURN                                                                    PTRJPE  59
c                                                                               PTRJPE  60
c                                                                               PTRJPE  61
c============= WRITE YEARLY RECORDS TO PS-H =================================== PTRJPE  62
 2000 CONTINUE                                                                  PTRJPE  63
c              loop through all the blocks and write the yearly records         PTRJPE  64
      DO  Neq=1,Npe                                                             PTRJPE  65
        Jpe   = Ipe + (Neq-1)*Lpe                                               PTRJPE  66
        Iuniq = <pe;PS-H_IUNIQ>                                                 PTRJPE  67
        IF (Iuniq .GT. 0)  THEN                                                 PTRJPE  68
c              number of columns and bins in this report                        PTRJPE  69
          NumCols = <pe;PS-H_COLUMNS>                                           PTRJPE  70
          NumBins = <pe;PS-H_BINS>                                              PTRJPE  71
c              Number of variables in record                                    PTRJPE  72
          NumVars = NumCols*4 + NumBins*12 + 1                                  PTRJPE  73
          Len     = NumVars + 4                                                 PTRJPE  74
          IF (NumBins .EQ. 3)  THEN                                             PTRJPE  75
            WRITE(IREPFL)                                                       PTRJPE  76
     &      Len, Iuniq, IONE, <pe;PS-H_FMT_YR>, NumVars, IHYR,                  PTRJPE  77
     &      (<pe;YEAR>,     IC=1,NumCols),  (<pe;YEAR_BINS_1>,II=1,12),         PTRJPE  78
     &      (<pe;YEAR_MAX>, IC=1,NumCols),  (<pe;YEAR_BINS_2>,II=1,12),         PTRJPE  79
     &      (<pe;YEAR_MONTH>, <pe;YEAR_DAY>, IC=1,NumCols),                     PTRJPE  80
     &                                      (<pe;YEAR_BINS_3>,II=1,12)          PTRJPE  81
          ELSEIF (NumBins .EQ. 2)  THEN                                         PTRJPE  82
            WRITE(IREPFL)                                                       PTRJPE  83
     &      Len, Iuniq, IONE, <pe;PS-H_FMT_YR>, NumVars, IHYR,                  PTRJPE  84
     &      (<pe;YEAR>,     IC=1,NumCols),  (<pe;YEAR_BINS_1>,II=1,12),         PTRJPE  85
     &      (<pe;YEAR_MAX>, IC=1,NumCols),  (<pe;YEAR_BINS_2>,II=1,12),         PTRJPE  86
     &      (<pe;YEAR_MONTH>, <pe;YEAR_DAY>, IC=1,NumCols)                      PTRJPE  87
          ELSE                                                                  PTRJPE  88
            WRITE(IREPFL)                                                       PTRJPE  89
     &      Len, Iuniq, IONE, <pe;PS-H_FMT_YR>, NumVars, IHYR,                  PTRJPE  90
     &      (<pe;YEAR>,     IC=1,NumCols),  (<pe;YEAR_BINS_1>,II=1,12),         PTRJPE  91
     &      (<pe;YEAR_MAX>, IC=1,NumCols),                                      PTRJPE  92
     &      (<pe;YEAR_MONTH>, <pe;YEAR_DAY>, IC=1,NumCols)                      PTRJPE  93
          ENDIF                                                                 PTRJPE  94
                                                                                -045m   57
c              Special output after yearly summary                              -045m   58
          SELECT CASE (<pe:ALGORITHM>)                                          -045m   59
          CASE (201)  ! boiler                                                  -045m   60
            Jbl = <pe;Jparent>                                                  -045m   61
            IC  = 1                                                             -045m   62
            WRITE(IREPFL) ISIX,IUNIQ,IONE,ISIX,ITWO,                            -045m   63
     &        <pe;YEAR_MAX>, <bl;PeakHWRYr>                                     -045m   64
          CASE (202)  ! condensing boiler                                       -045m   65
c              boiler capacity at rated HWR                                     -045m   66
            Jbl = <pe;Jparent>                                                  -045m   67
            IC  = 1                                                             -045m   68
            RatedCap = <pe;YEAR_MAX>                                            -045m   69
     &               * CVAL(<bl:HIR-FPLR>,1.,<bl;PeakHWRYr>)                    -045m   70
     &               / CVAL(<bl:HIR-FPLR>,1.,<bl:RATED-HWR-T>)                  -045m   71
            WRITE(IREPFL) ISIX,IUNIQ,IONE,ISIX,ITWO,                            -045m   72
     &        RatedCap, <bl;PeakHWRYr>                                          -045m   73
          END SELECT                                                            -045m   74
                                                                                -045m   75
          IF (<pe;PS-H_CLOSE> .EQ. 1)  WRITE(IREPFL) ITWO,IUNIQ,ISEVEN          PTRJPE  95
        ENDIF                                                                   PTRJPE  96
      ENDDO                                                                     PTRJPE  97
c                                                                               PTRJPE  98
      RETURN                                                                    PTRJPE  99
c                                                                               PTRJPE 100
c                                                                               PTRJPE 101
c============= WRITE YEARLY RECORDS TO PS-C =================================== PTRJPE 102
 3000 CONTINUE                                                                  PTRJPE 103
c                                                                               PTRJPE 104
      RETURN                                                                    PTRJPE 105
c                                                                               PTRJPE 106
      END                                                                       PTRJPE 107
      SUBROUTINE PlantStatistics                                                PLTSTA   2
c                                                                               PLTSTA   3
c                                                                               PLTSTA   4
c              Calculates all report statistics for circulation loops,          PLTSTA   5
c              pumps, and primary plant equipment                               PLTSTA   6
c                                                                               PLTSTA   7
c              SimCtrl = 19  Hourly statistics                                  PLTSTA   8
c                        29  Sum monthly statistics into yearly, print          PLTSTA   9
c                            monthly records, and rezero monthly                PLTSTA  10
c                        39  Do final processing of yearly statistics           PLTSTA  11
c                            and print final records                            PLTSTA  12
c                                                                               PLTSTA  13
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /BEPS  / BGAREA, BNAREA, PctSysOvrld, PctPltOvrld,                /BEPS/   2
     &                 SiteEnergy, SourceEnergy                                 /BEPS/   3
      DIMENSION        BEPS(6)                                                  /BEPS/   4
      EQUIVALENCE      (BEPS(1),BGAREA)                                         /BEPS/   5
      COMMON  /COGENn/ CogenMode, CogenIterateIndex, TrackMode,                 /COGEN/  2
     &                 QCogenWaste                                              /COGEN/  3
      INTEGER          CogenMode, CogenIterateIndex, TrackMode                  /COGEN/  4
      COMMON  /CTRL  / VERS(2),IRPFLG(4),IOVRLL(7),IWRTFL,IPROG,                /CTRL/   2
     1                 IFATAL,NAMPRG(3,7),MTRICR                                /CTRL/   3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PLTREP/ EndUses(20,2,4), EndUsePeaks(20,2,4),                    /PLTREP/ 2
     &                 EndPeakDay(20,2,4), EndPeakHour(20,2,4),                 /PLTREP/ 3
     &                 EndUseAtPeak(20,2,4),                                    HVAC29   1
     &                 PSA(13,2)                                                /PLTREP/ 4
      INTEGER          EndPeakDay, EndPeakHour                                  /PLTREP/ 5
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /TDVdat/ NameTDV, TDVmax(3), TDVmin(3), TDVavg(3),                /TDVdat/ 2
     &                 TDVsrc(3,8760), KtvTDV2(4)                               /TDVdat/ 3
      Character        NameTDV*4                                                /TDVdat/ 4
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /PTRSYS/ nzone , iz    , nczd  , zp2 ,         mtw  ,             -045a    1
     $                 nsys  , is    , nss   , nsp ,  ns   , icode,             HR      11
     $                 nsz   , isz   , nzd   , zp1 ,  nz   ,                    HR      12
     $                 nspace, lpr   ,                                          HR      13
     $                 nattch, iatt  ,                                          HR      14
     $                 P2, IDAYHR, IDBWBT,                                      HR      15
     $                 IRPPLT, IRPSUM, IRPSYS, IRPZON, MR1, MR2                 HR      16
      INTEGER          ZP1, ZP2, P2                                             /PTRSYS/14
      COMMON  /TESDAT/ Qcharge, Qdischarge, Qloss, Qfreeze, Qtank,              /TESDAT/ 2
     &                 CapMax, AuxkW, TtankEnv, Ttank, NumChrgHours,            /TESDAT/ 3
     &                 NumHoursToStart, ChrgHours, DChrgHours,                  /TESDAT/ 4
     &                 StoredKWh, StoredFuel                                    /TESDAT/ 5
      DIMENSION        TESSAV(15)                                               /TESDAT/ 6
      EQUIVALENCE     (TESSAV(1), Qcharge)                                      /TESDAT/ 7
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON /UNITT/   VKONV(300), DUMLOG(4), JUNITT(4,300,2)                   /UNITT/  2
      COMMON  /ZEROP/  LpmHR,LlpHR,LchHR,LblHR,LdwHR,LtwHR,LpvHR,LgnHR,         PV       5
     &                 LtkHR,LhxHR,LecHR,LlmHR,LemHR,LfmHR,LsmHR,LcmHR,         /ZEROP/  3
     &                 LglHR,LpeHR,                                             /ZEROP/  4
     &                 LpmMO,LlpMO,LchMO,LblMO,LdwMO,LtwMO,LpvMO,LgnMO,         PV       6
     &                 LtkMO,LhxMO,LecMO,LlmMO,LemMO,LfmMO,LsmMO,LcmMO,         /ZEROP/  6
     &                 LglMO,LpeMO,                                             /ZEROP/  7
     &                 LpmYR,LlpYR,LchYR,LblYR,LdwYR,LtwYR,LpvYR,LgnYR,         PV       7
     &                 LtkYR,LhxYR,LecYR,LlmYR,LemYR,LfmYR,LsmYR,LcmYR,         /ZEROP/  9
     &                 LglYR,LpeYR                                              /ZEROP/ 10
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               PLTSTA  28
      COMMON  /EMKY  / UtilityMeter, BldgMeter, SubMeter, SellMeter,            /EMKY/   2
     &                 NumElecMeterTypes(4)                                     /EMKY/   3
      INTEGER          UtilityMeter, BldgMeter, SubMeter, SellMeter             /EMKY/   4
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /SimAlg/ Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/ 2
     &                 Electrical,                                              /SIMALG/ 3
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/ 4
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/ 5
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   2
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/ 7
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/ 8
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/ 9
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/10
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    3
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    4
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    5
     &                 Ground_LoopVert_H2,Ground_LoopHoriz_H,                   -044d    6
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/14
      INTEGER          Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/15
     &                 Electrical,                                              /SIMALG/16
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/17
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/18
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   3
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/20
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/21
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/22
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/23
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    7
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    8
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    9
     &                 Ground_LoopVert_H2, Ground_LoopHoriz_H,                  -044d   10
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/27
      COMMON  /TESKY / ColdTank, HotTank                                        /TESKY/  2
      INTEGER          ColdTank, HotTank                                        /TESKY/  3
c                                                                               PLTSTA  33
      DIMENSION EndUseTotal(19)                                                 PLTSTA  34
      INTEGER   SubType                                                         PLTSTA  35
c                                                                               PLTSTA  36
      INDXPL(part,full)=                                                        INDXPL   2
     &      MAX(1,MIN(11,INT((ABS(part)+.001)                                   INDXPL   3
     &                                / MAX(1.E-6,ABS(full))*10.)+1))           INDXPL   4
c                                                                               PLTSTA  38
      DATA IELEC, IFUEL, ISTM, ICHW  /1,2,3,4/                                  PLTSTA  39
c                                                                               PLTSTA  40
c                                                                               PLTSTA  41
c              All electricity is in kWh.  All other energy uses are in         PLTSTA  42
c              Btuh, and are converted to the actual units of consumption       PLTSTA  43
c              just prior to output                                             PLTSTA  44
c                                                                               PLTSTA  45
c              Unlike other types of loops, a heating loop may be used          PLTSTA  46
c              to actually produce energy for another end-use.  These           PLTSTA  47
c              types are:                                                       PLTSTA  48
c                 PctHeat  = fraction for space heating                         PLTSTA  49
c                 PctCool    fraction for space cooling (absorption             PLTSTA  50
c                              or desiccant)                                    PLTSTA  51
c                 PctDHW     fraction for DHW (thru HX)                         PLTSTA  52
c                 PctElec    fraction for electric (steam turbine)              PLTSTA  53
c                            (not fully implemented)                            PLTSTA  54
c                 PctStore   fraction stored for later use (tank)               PLTSTA  55
c                 PctEquip   miscellaneous loads, including process             PLTSTA  56
c                            loads                                              PLTSTA  57
c                 PctAux     auxiliary heating loads for tower sumps            PLTSTA  58
c                            and TES freeze protection                          PLTSTA  59
c                                                                               PLTSTA  62
c              EndUses(IEU,IMO,ITYPE)                                           PLTSTA  63
c                 IEU =  1   Lights                                             PLTSTA  64
c                        2   Task Lights                                        PLTSTA  65
c                        3   Equipment                                          PLTSTA  66
c                        4   Heating                                            PLTSTA  67
c                        5   Cooling                                            PLTSTA  68
c                        6   Heat rejection                                     PLTSTA  69
c                        7   Auxiliary                                          PLTSTA  70
c                        8   Vent fans                                          PLTSTA  71
c                        9   Refrigeration                                      PLTSTA  72
c                       10   Heat pump supplemental                             PLTSTA  73
c                       11   Domestic hot water                                 PLTSTA  74
c                       12   Exterior use                                       PLTSTA  75
c                       13   spare                                              PLTSTA  76
c                       14   spare                                              PLTSTA  77
c                       15   spare                                              PLTSTA  78
c                       16   spare                                              PLTSTA  79
c                       17   spare                                              PLTSTA  80
c                       18   spare                                              PLTSTA  81
c                       19   adjustment factor for TES charge/discharge         PLTSTA  82
c                       20   Total of the above                                 PLTSTA  83
c                                                                               PLTSTA  84
c                 IMO =  1   Monthly sum                                        PLTSTA  85
c                        2   Yearly sum                                         PLTSTA  86
c               ITYPE =  1   Electric                                           PLTSTA  87
c                        2   Fuel                                               PLTSTA  88
c                        3   Steam                                              PLTSTA  89
c                        4   Chilled Water                                      PLTSTA  90
c                                                                               PLTSTA  91
c                                                                               PLTSTA  92
c              Check if hourly, monthly or yearly statistics                    PLTSTA  93
      SELECT CASE (SimCtrl)                                                     PLTSTA  94
c                                                                               PLTSTA  95
c============= HOURLY STATISTICS ============================================== PLTSTA  96
      CASE (19)                                                                 PLTSTA  97
c              Process hourly data into monthly statistics on a                 PLTSTA  98
c              primary loop-by-loop basis                                       PLTSTA  99
      DO 200  NL=1,Nlp                                                          PLTSTA 100
        Jlp = Ilp + (NL-1)*Llp                                                  PLTSTA 101
        IF (<lp:TYPE> .EQ. Deleted)  CYCLE                                      PLTSTA 102
        IF (<lp:SUBTYPE> .EQ. SECONDARY)  CYCLE                                 PLTSTA 103
c              initialize BEPS sums                                             PLTSTA 104
        PctHeat  = 0.                                                           PLTSTA 105
        PctCool  = 0.                                                           PLTSTA 106
        PctDHW   = 0.                                                           PLTSTA 107
        PctElec  = 0.                                                           PLTSTA 108
        PctStore = 0.                                                           PLTSTA 109
        PctEquip = 0.                                                           PLTSTA 110
        PctAux   = 0.                                                           PLTSTA 111
c              process all secondary loops feeding this primary, then           PLTSTA 112
c              the primary                                                      PLTSTA 113
c              number of secondary loops                                        PLTSTA 114
        N2nd = <lp;NUM_2ND_LOOPS>                                               PLTSTA 115
        L2   = 0                                                                PLTSTA 116
        Jlp1 = Jlp                                                              PLTSTA 117
   10   Jlp  = Jlp1                                                             PLTSTA 118
        IF (L2 .LT. N2nd)  THEN                                                 PLTSTA 119
          SubType = SECONDARY                                                   PLTSTA 120
          L2      = L2 + 1                                                      PLTSTA 121
          Jlp     = <lp;PTR_2ND_LOOPS>                                          PLTSTA 122
        ELSE                                                                    PLTSTA 123
          SubType = PRIMARY                                                     PLTSTA 124
        ENDIF                                                                   PLTSTA 125
        LoopType = <lp:TYPE>                                                    PLTSTA 126
        LoopCtrl = <lp;CTRL_MODE>                                               PLTSTA 127
c              loop auxiliary elec                                              PLTSTA 128
        Jem = <lp:AUX-METER>                                                    PLTSTA 129
        <em;AUX> = <em;AUX> + <lp;AUX_KW>                                       PLTSTA 130
c              WLHP systems have their own statistics                           PLTSTA 131
        IF (LoopType .EQ. WLHP)  GOTO 70                                        PLTSTA 132
c              sum the end-use loads incurred by primary equipment              PLTSTA 133
        IF (<lp;Q_NET> .LT. 0.)  THEN                                           -41a   108
          PctHeat  = PctHeat  + <lp;COIL_HEAT>                                  PLTSTA 135
          PctCool  = PctCool  + <lp;PRIM_HEAT>                                  ChlrHP 924
c              desiccant regeneration heat load                                 PLTSTA 137
     &                        + <lp;COIL_COOL>                                  PLTSTA 138
          IF (LoopType .EQ. DHW)  THEN                                          PLTSTA 139
            PctDHW = PctDHW + <lp;PROCESS_Q>                                    PLTSTA 140
          ELSE                                                                  PLTSTA 141
            PctEquip = PctEquip + <lp;PROCESS_Q>                                PLTSTA 142
          ENDIF                                                                 PLTSTA 143
          PctElec  = PctElec  + <lp;CogenQ>                                     PLTSTA 144
          PctStore = PctStore + <lp;TES_CHRG_HEAT>                              PLTSTA 145
          PctAux   = PctAux   + <lp;AUX_HEAT>                                   PLTSTA 146
c              Transfer desiccant load to heating for reports.  Note            PLTSTA 147
c              that this works only because simultaneous heating                PLTSTA 148
c              and cooling loads can never coexist in any loop type             PLTSTA 149
c              except WLHP, which is handled separately below                   PLTSTA 150
          <lp;COIL_HEAT> = <lp;COIL_HEAT> + <lp;COIL_COOL>                      PLTSTA 151
          <lp;COIL_COOL> = 0.                                                   PLTSTA 152
        ELSEIF (<lp;Q_NET> .GT. 0.)  THEN                                       -41a   109
          PctCool  = PctCool  + <lp;COIL_COOL>                                  PLTSTA 154
          PctEquip = PctEquip + <lp;PROCESS_Q>                                  PLTSTA 155
          PctStore = PctStore + <lp;TES_CHRG_COOL>                              PLTSTA 156
        ENDIF                                                                   PLTSTA 157
c              sum process load into the primary load for reports               PLTSTA 158
        IF (<lp;PROCESS_Q> .LT. 0.)  THEN                                       PLTSTA 159
          <lp;COIL_HEAT> = <lp;COIL_HEAT> + <lp;PROCESS_Q>                      PLTSTA 160
     &                                    + <lp;AUX_HEAT>                       PLTSTA 161
        ELSE                                                                    PLTSTA 162
          <lp;COIL_COOL> = <lp;COIL_COOL> + <lp;PROCESS_Q>                      PLTSTA 163
        ENDIF                                                                   PLTSTA 164
c              check if loop in heating mode or floating                        PLTSTA 165
        IF (LoopType .NE. CHW  .AND.  LoopType .NE. CW  .AND.                   PLTSTA 166
     &     (LoopType .NE. PIPE2  .OR.  <lp;Q_NET> .LE. 0.))  THEN               -41a   110
c              piping losses                                                    PLTSTA 168
          Qloss = <lp;SUPPLY_LOSS> + <lp;RETURN_LOSS>                           PLTSTA 169
          <lp;LOSSHMO> = <lp;LOSSHMO> + Qloss                                   PLTSTA 170
          IF (Qloss .LT. <lp;LOSSHMOM>)  THEN                                   PLTSTA 171
            <lp;LOSSHMOM>   = Qloss                                             PLTSTA 172
            <lp;LOSSHMOMDY> = IDAY                                              PLTSTA 173
            <lp;LOSSHMOMHR> = ISCHR                                             PLTSTA 174
          ENDIF                                                                 PLTSTA 175
          X = <lp;COIL_HEAT> + <lp;2ND_HEAT>                                    ChlrHP 925
     &      + <lp;PRIM_HEAT> + <lp;CogenQ>                                      ChlrHP 926
     &      + <lp;TES_CHRG_HEAT>                                                PLTSTA 178
          <lp;COILHMO> = <lp;COILHMO> + X                                       PLTSTA 179
          IF (X .LT. <lp;COILHMOM>)  THEN                                       PLTSTA 180
            <lp;COILHMOM>   = X                                                 PLTSTA 181
            <lp;COILHMOMDY> = IDAY                                              PLTSTA 182
            <lp;COILHMOMHR> = ISCHR                                             PLTSTA 183
          ENDIF                                                                 PLTSTA 184
          IF (<lp;Q_NET> .LT. 0.)  THEN                                         -41a   111
c              net loop load                                                    PLTSTA 186
            <lp;TOTALHMO> = <lp;TOTALHMO> + <lp;Q_NET>                          PLTSTA 187
            IF (<lp;Q_NET> .LT. <lp;TOTALHMOM>)  THEN                           PLTSTA 188
              <lp;TOTALHMOM>   = <lp;Q_NET>                                     PLTSTA 189
              <lp;TOTALHMOMDY> = IDAY                                           PLTSTA 190
              <lp;TOTALHMOMHR> = ISCHR                                          PLTSTA 191
              <lp;PeakTHMo>    = <lp;SUPPLY_T>                                  -041h   26
              <lp;PeakDBTHMo>  = DBT                                            -041h   27
              <lp;PeakWBTHMo>  = WBT                                            -041h   28
            ENDIF                                                               -041h   29
c              overload                                                         PLTSTA 193
            IF (<lp;Q_OVERLOAD> .LT. -1.)  THEN                                 PLTSTA 194
              <lp;OVRLDHMO> = <lp;OVRLDHMO> + <lp;Q_OVERLOAD>                   PLTSTA 195
              <lp;HR_HEAT_OVRLD> = <lp;HR_HEAT_OVRLD> + 1                       PLTSTA 196
              IF (<lp;Q_OVERLOAD> .LT. <lp;OVRLDHMOM>)  THEN                    PLTSTA 197
                <lp;OVRLDHMOM>   = <lp;Q_OVERLOAD>                              PLTSTA 198
                <lp;OVRLDHMOMDY> = IDAY                                         PLTSTA 199
                <lp;OVRLDHMOMHR> = ISCHR                                        PLTSTA 200
              ENDIF                                                             PLTSTA 201
            ENDIF                                                               PLTSTA 202
c              part load bins for heating                                       PLTSTA 203
            II = INDXPL(<lp;Q_NET>,<lp;DES_HCAP>)                               PLTSTA 204
            <lp;QHPLRMO> = <lp;QHPLRMO> + 1                                     PLTSTA 205
            II = 12                                                             PLTSTA 206
            <lp;QHPLRMO> = <lp;QHPLRMO> + 1                                     PLTSTA 207
          ENDIF                                                                 PLTSTA 208
c              part load bins for flow                                          PLTSTA 209
          IF (<lp;GPM> .GT. 0.)  THEN                                           -41a   112
            II = INDXPL(<lp;GPM>,<lp;DES_GPM>)                                  -41a   113
            <lp;GPMHPLRMO> = <lp;GPMHPLRMO> + 1                                 -41a   114
            II = 12                                                             -41a   115
            <lp;GPMHPLRMO> = <lp;GPMHPLRMO> + 1                                 -41a   116
          ENDIF                                                                 -41a   117
        ELSE                                                                    PLTSTA 220
c              loops other than wlhp in cooling mode                            PLTSTA 221
c              piping losses                                                    PLTSTA 222
          Qloss = <lp;SUPPLY_LOSS> + <lp;RETURN_LOSS>                           PLTSTA 223
          <lp;LOSSCMO> = <lp;LOSSCMO> + Qloss                                   PLTSTA 224
          IF (Qloss .GT. <lp;LOSSCMOM>)  THEN                                   PLTSTA 225
            <lp;LOSSCMOM>   = Qloss                                             PLTSTA 226
            <lp;LOSSCMOMDY> = IDAY                                              PLTSTA 227
            <lp;LOSSCMOMHR> = IDAY                                              PLTSTA 228
          ENDIF                                                                 PLTSTA 229
          X = <lp;COIL_COOL> + <lp;2ND_COOL>                                    PLTSTA 230
     &      + <lp;TES_CHRG_COOL> + <lp;PRIM_HTREJ> + <lp;CogenQ>                PLTSTA 231
          <lp;COILCMO> = <lp;COILCMO> + X                                       PLTSTA 232
          IF (X .GT. <lp;COILCMOM>)  THEN                                       PLTSTA 233
            <lp;COILCMOM>   = X                                                 PLTSTA 234
            <lp;COILCMOMDY> = IDAY                                              PLTSTA 235
            <lp;COILCMOMHR> = ISCHR                                             PLTSTA 236
          ENDIF                                                                 PLTSTA 237
          IF (<lp;Q_NET> .GT. 0.)  THEN                                         -41a   118
c              net loop load                                                    PLTSTA 239
            <lp;TOTALCMO> = <lp;TOTALCMO> + <lp;Q_NET>                          PLTSTA 240
            IF (<lp;Q_NET> .GT. <lp;TOTALCMOM>)  THEN                           PLTSTA 241
              <lp;TOTALCMOM>   = <lp;Q_NET>                                     PLTSTA 242
              <lp;TOTALCMOMDY> = IDAY                                           PLTSTA 243
              <lp;TOTALCMOMHR> = ISCHR                                          PLTSTA 244
              <lp;PeakTCMo>    = <lp;SUPPLY_T>                                  -041h   30
              <lp;PeakDBTCMo>  = DBT                                            -041h   31
              <lp;PeakWBTCMo>  = WBT                                            -041h   32
            ENDIF                                                               PLTSTA 245
c              overload                                                         PLTSTA 246
            IF (<lp;Q_OVERLOAD> .GT. 1.)  THEN                                  PLTSTA 247
              <lp;OVRLDCMO> = <lp;OVRLDCMO> + <lp;Q_OVERLOAD>                   PLTSTA 248
              <lp;HR_COOL_OVRLD> = <lp;HR_COOL_OVRLD> + 1                       PLTSTA 249
              IF (<lp;Q_OVERLOAD> .GT. <lp;OVRLDCMOM>)  THEN                    PLTSTA 250
                <lp;OVRLDCMOM>   = <lp;Q_OVERLOAD>                              PLTSTA 251
                <lp;OVRLDCMOMDY> = IDAY                                         PLTSTA 252
                <lp;OVRLDCMOMHR> = ISCHR                                        PLTSTA 253
              ENDIF                                                             PLTSTA 254
            ENDIF                                                               PLTSTA 255
c              part load bins for cooling                                       PLTSTA 256
            II = INDXPL(<lp;Q_NET>,<lp;DES_CCAP>)                               PLTSTA 257
            <lp;QCPLRMO> = <lp;QCPLRMO> + 1                                     PLTSTA 258
            II = 12                                                             PLTSTA 259
            <lp;QCPLRMO> = <lp;QCPLRMO> + 1                                     PLTSTA 260
          ENDIF                                                                 PLTSTA 261
c              part load bins for flow                                          PLTSTA 262
          IF (<lp;GPMr> .GT. 0.)  THEN                                          -41a   119
            II = INDXPL(<lp;GPMr>,<lp;DES_GPM>)                                 -41a   120
            <lp;GPMCPLRMO> = <lp;GPMCPLRMO> + 1                                 -41a   121
            II = 12                                                             -41a   122
            <lp;GPMCPLRMO> = <lp;GPMCPLRMO> + 1                                 -41a   123
          ENDIF                                                                 -41a   124
        ENDIF                                                                   PLTSTA 269
        GOTO 99                                                                 PLTSTA 270
   70   CONTINUE                                                                PLTSTA 271
c              wlhp has its own report format                                   PLTSTA 272
c              sum the end-use loads incurred by primary equipment              PLTSTA 273
        PctHeat    = PctHeat + <lp;COIL_HEAT>                                   PLTSTA 274
        IF (<lp;PROCESS_Q> .LT. 0.)  THEN                                       PLTSTA 275
          PctEquip = PctEquip + <lp;PROCESS_Q>                                  PLTSTA 276
c              sum process load into the primary load for reports               PLTSTA 277
          <lp;COIL_HEAT> = <lp;COIL_HEAT> + <lp;PROCESS_Q>                      PLTSTA 278
        ELSE                                                                    PLTSTA 279
          <lp;COIL_COOL> = <lp;COIL_COOL> + <lp;PROCESS_Q>                      PLTSTA 280
        ENDIF                                                                   PLTSTA 281
        PctStore = PctStore + <lp;TES_CHRG_HEAT>                                PLTSTA 282
c              piping losses                                                    PLTSTA 283
        Qloss = <lp;SUPPLY_LOSS> + <lp;RETURN_LOSS>                             PLTSTA 284
        IF (<lp;Q_NET> .LT. 0.)  THEN                                           -41a   125
c              loop is dominated by heating                                     PLTSTA 286
          <lp;LOSSHMO> = <lp;LOSSHMO> + Qloss                                   PLTSTA 287
          IF (Qloss .LT. <lp;LOSSHMOM>)  THEN                                   PLTSTA 288
            <lp;LOSSHMOM>   = Qloss                                             PLTSTA 289
            <lp;LOSSHMOMDY> = IDAY                                              PLTSTA 290
            <lp;LOSSHMOMHR> = ISCHR                                             PLTSTA 291
          ENDIF                                                                 PLTSTA 292
c              heating demands during heating                                   PLTSTA 293
          X = <lp;COIL_HEAT>     + <lp;2ND_HEAT>                                ChlrHP 927
     &      + <lp;TES_CHRG_HEAT> + <lp;PRIM_HEAT>                               ChlrHP 928
     &      + Min(0., <lp;PRIM_HTREJ>)                                          -041k  189
          <lp;COILHMO> = <lp;COILHMO> + X                                       PLTSTA 296
          IF (X .LT. <lp;COILHMOM>)  THEN                                       PLTSTA 297
            <lp;COILHMOM>   = X                                                 PLTSTA 298
            <lp;COILHMOMDY> = IDAY                                              PLTSTA 299
            <lp;COILHMOMHR> = ISCHR                                             PLTSTA 300
          ENDIF                                                                 PLTSTA 301
c              cooling demands during heating                                   PLTSTA 302
          X = <lp;COIL_COOL> + <lp;2ND_COOL>                                    PLTSTA 303
     &      + <lp;TES_CHRG_COOL> + Max(0.,<lp;PRIM_HTREJ>) + <lp;CogenQ>        -041k  190
          <lp;COILHCMO> = <lp;COILHCMO> + X                                     PLTSTA 305
          IF (X .GT. <lp;COILHCMOM>)  THEN                                      PLTSTA 306
            <lp;COILHCMOM>   = X                                                PLTSTA 307
            <lp;COILHCMOMDY> = IDAY                                             PLTSTA 308
            <lp;COILHCMOMHR> = ISCHR                                            PLTSTA 309
          ENDIF                                                                 PLTSTA 310
c              net loop load during heating                                     PLTSTA 311
          <lp;TOTALHMO> = <lp;TOTALHMO> + <lp;Q_NET>                            PLTSTA 312
          IF (<lp;Q_NET> .LT. <lp;TOTALHMOM>)  THEN                             PLTSTA 313
            <lp;TOTALHMOM>   = <lp;Q_NET>                                       PLTSTA 314
            <lp;TOTALHMOMDY> = IDAY                                             PLTSTA 315
            <lp;TOTALHMOMHR> = ISCHR                                            PLTSTA 316
            <lp;PeakTHMo>    = <lp;SUPPLY_T>                                    -041h   33
            <lp;PeakDBTHMo>  = DBT                                              -041h   34
            <lp;PeakWBTHMo>  = WBT                                              -041h   35
          ENDIF                                                                 PLTSTA 317
c              heating overload                                                 PLTSTA 318
          IF (<lp;Q_OVERLOAD> .LT. -1.)  THEN                                   PLTSTA 319
            <lp;OVRLDHMO> = <lp;OVRLDHMO> + <lp;Q_OVERLOAD>                     PLTSTA 320
            <lp;HR_HEAT_OVRLD> = <lp;HR_HEAT_OVRLD> + 1                         PLTSTA 321
            IF (<lp;Q_OVERLOAD> .LT. <lp;OVRLDHMOM>)  THEN                      PLTSTA 322
              <lp;OVRLDHMOM>   = <lp;Q_OVERLOAD>                                PLTSTA 323
              <lp;OVRLDHMOMDY> = IDAY                                           PLTSTA 324
              <lp;OVRLDHMOMHR> = ISCHR                                          PLTSTA 325
            ENDIF                                                               PLTSTA 326
          ENDIF                                                                 PLTSTA 327
c              part load bins for heating and flow                              PLTSTA 328
          II = INDXPL(<lp;Q_NET>,<lp;DES_HCAP>)                                 PLTSTA 329
          <lp;QHPLRMO> = <lp;QHPLRMO> + 1                                       PLTSTA 330
          II = 12                                                               PLTSTA 331
          <lp;QHPLRMO> = <lp;QHPLRMO> + 1                                       PLTSTA 332
          II = INDXPL(<lp;GPMr>,<lp;DES_GPM>)                                   PLTSTA 333
          <lp;GPMHPLRMO> = <lp;GPMHPLRMO> + 1                                   PLTSTA 334
          II = 12                                                               PLTSTA 335
          <lp;GPMHPLRMO> = <lp;GPMHPLRMO> + 1                                   PLTSTA 336
        ELSEIF (<lp;Q_NET> .GT. 0.)  THEN                                       -41a   126
c              piping losses                                                    PLTSTA 338
          Qloss = <lp;SUPPLY_LOSS> + <lp;RETURN_LOSS>                           PLTSTA 339
          <lp;LOSSCMO> = <lp;LOSSCMO> + Qloss                                   PLTSTA 340
          IF (Qloss .GT. <lp;LOSSCMOM>)  THEN                                   PLTSTA 341
            <lp;LOSSCMOM>   = Qloss                                             PLTSTA 342
            <lp;LOSSCMOMDY> = IDAY                                              PLTSTA 343
            <lp;LOSSCMOMHR> = IDAY                                              PLTSTA 344
          ENDIF                                                                 PLTSTA 345
c              cooling demands during cooling                                   PLTSTA 346
          X = <lp;COIL_COOL> + <lp;2ND_COOL>                                    PLTSTA 347
     &      + <lp;TES_CHRG_COOL>  + <lp;PRIM_HTREJ> + <lp;CogenQ>               PLTSTA 348
          <lp;COILCMO> = <lp;COILCMO> + X                                       PLTSTA 349
          IF (X .GT. <lp;COILCMOM>)  THEN                                       PLTSTA 350
            <lp;COILCMOM>   = X                                                 PLTSTA 351
            <lp;COILCMOMDY> = IDAY                                              PLTSTA 352
            <lp;COILCMOMHR> = ISCHR                                             PLTSTA 353
          ENDIF                                                                 PLTSTA 354
c              heating demands during cooling                                   PLTSTA 355
          X = <lp;COIL_HEAT>     + <lp;2ND_HEAT>                                ChlrHP 929
     &      + <lp;TES_CHRG_HEAT> + <lp;PRIM_HEAT>                               ChlrHP 930
          <lp;COILCHMO> = <lp;COILCHMO> + X                                     PLTSTA 358
          IF (X .LT. <lp;COILCHMOM>)  THEN                                      PLTSTA 359
            <lp;COILCHMOM>   = X                                                PLTSTA 360
            <lp;COILCHMOMDY> = IDAY                                             PLTSTA 361
            <lp;COILCHMOMHR> = ISCHR                                            PLTSTA 362
          ENDIF                                                                 PLTSTA 363
c              net loop load during cooling                                     PLTSTA 364
          <lp;TOTALCMO> = <lp;TOTALCMO> + <lp;Q_NET>                            PLTSTA 365
          IF (<lp;Q_NET> .GT. <lp;TOTALCMOM>)  THEN                             PLTSTA 366
            <lp;TOTALCMOM>   = <lp;Q_NET>                                       PLTSTA 367
            <lp;TOTALCMOMDY> = IDAY                                             PLTSTA 368
            <lp;TOTALCMOMHR> = ISCHR                                            PLTSTA 369
            <lp;PeakTCMo>    = <lp;SUPPLY_T>                                    -041h   36
            <lp;PeakDBTCMo>  = DBT                                              -041h   37
            <lp;PeakWBTCMo>  = WBT                                              -041h   38
          ENDIF                                                                 PLTSTA 370
c              cooling overload (load tower couldn't handle and                 PLTSTA 371
c              maintain setpoint)                                               PLTSTA 372
          IF (<lp;Q_OVERLOAD> .GT. 1.)  THEN                                    PLTSTA 373
            <lp;OVRLDCMO>      = <lp;OVRLDCMO> + <lp;Q_OVERLOAD>                PLTSTA 374
            <lp;HR_COOL_OVRLD> = <lp;HR_COOL_OVRLD> + 1                         PLTSTA 375
            IF (<lp;Q_OVERLOAD> .GT. <lp;OVRLDCMOM>)  THEN                      PLTSTA 376
              <lp;OVRLDCMOM>   = <lp;Q_OVERLOAD>                                PLTSTA 377
              <lp;OVRLDCMOMDY> = IDAY                                           PLTSTA 378
              <lp;OVRLDCMOMHR> = ISCHR                                          PLTSTA 379
            ENDIF                                                               PLTSTA 380
          ENDIF                                                                 PLTSTA 381
c              part load bins for cooling                                       PLTSTA 382
          II = INDXPL(<lp;Q_NET>,<lp;DES_CCAP>)                                 PLTSTA 383
          <lp;QCPLRMO> = <lp;QCPLRMO> + 1                                       PLTSTA 384
          II = 12                                                               PLTSTA 385
          <lp;QCPLRMO> = <lp;QCPLRMO> + 1                                       PLTSTA 386
          II = INDXPL(<lp;GPMr>,<lp;DES_GPM>)                                   PLTSTA 387
          <lp;GPMCPLRMO> = <lp;GPMCPLRMO> + 1                                   PLTSTA 388
          II = 12                                                               PLTSTA 389
          <lp;GPMCPLRMO> = <lp;GPMCPLRMO> + 1                                   PLTSTA 390
        ELSEIF (<lp;GPMr> .GT. 0.)  THEN                                        -41a   127
c              piping losses (assuming heat from pipe                           PLTSTA 392
c              back into space is the most important)                           PLTSTA 393
          Qloss = <lp;SUPPLY_LOSS> + <lp;RETURN_LOSS>                           PLTSTA 394
          <lp;LOSSFMO> = <lp;LOSSFMO> + Qloss                                   PLTSTA 395
          IF (Qloss .LT. <lp;LOSSFMOM>)  THEN                                   PLTSTA 396
            <lp;LOSSFMOM>   = Qloss                                             PLTSTA 397
            <lp;LOSSFMOMDY> = IDAY                                              PLTSTA 398
            <lp;LOSSFMOMHR> = IDAY                                              PLTSTA 399
          ENDIF                                                                 PLTSTA 400
c              cooling demands during floating                                  PLTSTA 401
          X = <lp;COIL_COOL> + <lp;2ND_COOL>                                    PLTSTA 402
     &      + <lp;TES_CHRG_COOL> + <lp;PRIM_HTREJ> + <lp;CogenQ>                PLTSTA 403
          <lp;COILFCMO> = <lp;COILFCMO> + X                                     PLTSTA 404
          IF (X .GT. <lp;COILFCMOM>)  THEN                                      PLTSTA 405
            <lp;COILFCMOM>   = X                                                PLTSTA 406
            <lp;COILFCMOMDY> = IDAY                                             PLTSTA 407
            <lp;COILFCMOMHR> = ISCHR                                            PLTSTA 408
          ENDIF                                                                 PLTSTA 409
c              heating demands during floating                                  PLTSTA 410
          X = <lp;COIL_HEAT> + <lp;2ND_HEAT>                                    PLTSTA 411
     &                       + <lp;TES_CHRG_HEAT>                               PLTSTA 412
          <lp;COILFHMO> = <lp;COILFHMO> + X                                     PLTSTA 413
          IF (X .LT. <lp;COILFHMOM>)  THEN                                      PLTSTA 414
            <lp;COILFHMOM>   = X                                                PLTSTA 415
            <lp;COILFHMOMDY> = IDAY                                             PLTSTA 416
            <lp;COILFHMOMHR> = ISCHR                                            PLTSTA 417
          ENDIF                                                                 PLTSTA 418
c              part load bins for floating                                      PLTSTA 419
          <lp;FLOATMO> = <lp;FLOATMO> + 1                                       PLTSTA 420
          II = INDXPL(<lp;GPMr>,<lp;DES_GPM>)                                   PLTSTA 421
          <lp;GPMFPLRMO> = <lp;GPMFPLRMO> + 1                                   PLTSTA 422
          II = 12                                                               PLTSTA 423
          <lp;GPMFPLRMO> = <lp;GPMFPLRMO> + 1                                   PLTSTA 424
        ENDIF                                                                   PLTSTA 425
c                                                                               PLTSTA 426
   99   CONTINUE                                                                PLTSTA 427
c                                                                               PLTSTA 428
c              transfer re-entrant variables to hourly                          PLTSTA 429
        <lp;SUPPLY_AVG>  = <lp;SUPPLY_AVG'>                                     PLTSTA 430
        <lp;RETURN_AVG>  = <lp;RETURN_AVG'>                                     PLTSTA 431
        <lp;ACCUM_OVRLD> = <lp;ACCUM_OVR'>                                      PLTSTA 432
c                                                                               PLTSTA 433
c              repeat for next secondary loop, and finally for primary          PLTSTA 434
        IF (SubType .EQ. SECONDARY)  GOTO 10                                    PLTSTA 435
c                                                                               PLTSTA 436
c              Loop statistics are complete.  Calculate proportions             PLTSTA 437
c              for each of the end-use loads for use in the primary             PLTSTA 438
c              equipment statistics                                             PLTSTA 439
        IF (<lp;Q_NET> .NE. 0.)  THEN                                           -41a   128
          IF (LoopType .NE. WLHP)  THEN                                         PLTSTA 441
            Sum = PctHeat+PctCool+PctDHW+PctElec                                ENDUSE   1
     &                                  +PctStore+PctEquip+PctAux               ENDUSE   2
            IF (Sum .EQ. 0.)  THEN                                              ENDUSE   3
              SELECT CASE (<lp:ASSIGN-LOSSES>)                                  ENDUSE   4
                CASE (3)  ! equipment                                           ENDUSE   5
                  PctEquip = 1.                                                 ENDUSE   6
                CASE (4)  ! space heating/cooling                               ENDUSE   7
                  IF (LoopCtrl .EQ. COOLMODE)  THEN                             ENDUSE   8
                    PctCool = 1.                                                ENDUSE   9
                  ELSE                                                          ENDUSE  10
                    PctHeat = 1.                                                ENDUSE  11
                  ENDIF                                                         ENDUSE  12
                CASE (11) ! dhw                                                 ENDUSE  13
                  PctDHW = 1.                                                   ENDUSE  14
              END SELECT                                                        ENDUSE  15
              Sum = 1.                                                          ENDUSE  16
            ENDIF                                                               ENDUSE  17
            Denominator = 1. / Sum                                              ENDUSE  18
            PctHeat  = PctHeat  * Denominator                                   PLTSTA 443
            PctCool  = PctCool  * Denominator                                   PLTSTA 444
            PctDHW   = PctDHW   * Denominator                                   PLTSTA 445
            PctElec  = PctElec  * Denominator                                   PLTSTA 446
            PctStore = PctStore * Denominator                                   PLTSTA 447
            PctEquip = PctEquip * Denominator                                   PLTSTA 448
            PctAux   = PctAux   * Denominator                                   PLTSTA 449
          ELSE                                                                  PLTSTA 450
            IF (<lp;Q_NET> .LT. 0.)  THEN                                       -41a   129
              IF (PctHeat+PctEquip .EQ. 0.)  PctHeat = 1.                       -034    76
              Denominator = 1.0 / (PctHeat + PctEquip)                          PLTSTA 452
              PctHeat  = PctHeat  * Denominator                                 PLTSTA 453
              PctStore = PctStore * Denominator                                 PLTSTA 454
              PctEquip = PctEquip * Denominator                                 PLTSTA 455
            ELSE                                                                PLTSTA 456
              PctHeat  = 0.                                                     PLTSTA 457
              PctStore = 0.                                                     PLTSTA 458
              PctEquip = 0.                                                     PLTSTA 459
            ENDIF                                                               PLTSTA 460
          ENDIF                                                                 PLTSTA 461
        ELSE                                                                    ENDUSE  19
          PctHeat  = 0.                                                         PLTSTA 482
          PctCool  = 0.                                                         PLTSTA 483
          PctDHW   = 0.                                                         PLTSTA 484
          PctElec  = 0.                                                         PLTSTA 485
          PctStore = 0.                                                         PLTSTA 486
          PctEquip = 0.                                                         PLTSTA 487
          PctAux   = 0.                                                         PLTSTA 488
          SELECT CASE (<lp:ASSIGN-LOSSES>)                                      -041j   27
            CASE (3)  ! equipment                                               -041j   28
              PctEquip = 1.                                                     -041j   29
            CASE (4)  ! space heating/cooling                                   -041j   30
              IF (LoopCtrl .EQ. COOLMODE)  THEN                                 -041j   31
                PctCool = 1.                                                    -041j   32
              ELSE                                                              -041j   33
                PctHeat = 1.                                                    -041j   34
              ENDIF                                                             -041j   35
            CASE (11) ! dhw                                                     -041j   36
              PctDHW = 1.                                                       -041j   37
          END SELECT                                                            -041j   38
        ENDIF                                                                   PLTSTA 489
c                                                                               PLTSTA 490
        IF (<lp;Q_NET> .LT. 0.)  THEN                                           -41a   130
c              net heating in report PS-A                                       PLTSTA 492
          PSA(1,1) = PSA(1,1)                                                   PLTSTA 493
     &             + <lp;Q_NET>*(PctHeat+PctDHW+PctEquip+PctAux)                PLTSTA 494
        ELSEIF (<lp;Q_NET> .GT. 0.  .AND.                                       -41a   131
     &    (LoopType .EQ. CHW  .OR.  LoopType .EQ. WLHP                          -41a   132
     &                        .OR.  LoopType .EQ. PIPE2))  THEN                 -41a   133
c              net cooling in report PS-A                                       PLTSTA 497
            PSA(2,1) = PSA(2,1) + <lp;Q_NET>                                    PLTSTA 498
        ENDIF                                                                   PLTSTA 499
c                                                                               PLTSTA 500
c              Now process statistics for each primary equipment                PLTSTA 501
c              unit on this loop (note that we are looking at the               PLTSTA 502
c              primary loop only at this point, not secondaries)                PLTSTA 503
        Neq = <lp;NUM_EQUIP&TES>                                                PLTSTA 504
        DO 110  IQ=1,Neq                                                        PLTSTA 505
c              pointer to attached equipment                                    PLTSTA 506
          Jpe = <lp;Jpe>                                                        PLTSTA 507
          SELECT CASE (<pe:ALGORITHM>)                                          -044e5  80
                                                                                -044e5  81
c              Cooling equipment                                                -044e5  82
          CASE (100:180)                                                        -044e5  83
c              all chillers in cooling mode                                     PLTSTA 524
            Jch = <pe;Jparent>                                                  PLTSTA 525
c              energy end uses and meters                                       PLTSTA 526
            Jem        = <ch:AUX-METER>                                         PLTSTA 527
            <em;AUX>   = <em;AUX>  + <ch;AUX>                                   PLTSTA 528
            Jem        = <ch:ELEC-METER>                                        PLTSTA 529
            CoolkW     = <ch;KW>                                                PLTSTA 530
            HeatkW     = <ch;KWh>                                               ChlrHP 961
            <em;COOL>  = <em;COOL>  + CoolkW * PctCool                          PLTSTA 531
            <em;HEAT>  = <em;HEAT>  + HeatkW * PctHeat                          ChlrHP 962
            <em;EQUIP> = <em;EQUIP> + CoolkW * PctEquip                         PLTSTA 532
     &                              + HeatkW * PctEquip                         ChlrHP 963
            <em;HTREJ> = <em;HTREJ> + <ch;HtRejKW>                              -033    19
            Jfm       = <ch:FUEL-METER>                                         PLTSTA 533
            IF (Jfm .GT. 0)  THEN                                               PLTSTA 534
              CoolFuel   = <ch;FUEL>                                            PLTSTA 535
              <fm;COOL>  = <fm;COOL>  + CoolFuel * PctCool                      PLTSTA 536
              <fm;EQUIP> = <fm;EQUIP> + CoolFuel * PctEquip                     PLTSTA 537
            ELSE                                                                PLTSTA 538
              CoolFuel   = 0.                                                   PLTSTA 539
            ENDIF                                                               PLTSTA 540
c              portion that goes into storage                                   PLTSTA 541
            IF (PctStore .GT. 0.)  THEN                                         PLTSTA 542
              ME = IQ                                                           PLTSTA 543
              Ntes = <lp;NUM_CHRG_TES>                                          PLTSTA 544
              DO  IT=1,Ntes                                                     PLTSTA 545
                Jtk = <lp;CHRG_TES>                                             PLTSTA 546
                Prorate = <tk;Q_CHRG> / <lp;TES_CHRG_COOL>                      PLTSTA 547
                <tk;ELEC_KW> = <tk;ELEC_KW> +  CoolkW*PctStore*Prorate          PLTSTA 548
     &                                      +  HeatkW*PctStore*Prorate          ChlrHP 964
                <tk;FUEL_Q>  = <tk;FUEL_Q> + CoolFuel*PctStore*Prorate          PLTSTA 549
              ENDDO                                                             PLTSTA 550
c              add to total, so energy correct for the hour                     PLTSTA 551
              <em;TES_ADJUST> = <em;TES_ADJUST> + CoolkW*PctStore               PLTSTA 552
     &                                          + HeatkW*PctStore               ChlrHP 965
              IF (Jfm .GT. 0)                                                   PLTSTA 553
     &          <fm;TES_ADJUST> = <fm;TES_ADJUST> + CoolFuel*PctStore           PLTSTA 554
            ENDIF                                                               PLTSTA 555
c              combine for total electric and fuel usage                        PLTSTA 556
            <ch;KW>   = <ch;KW> + <ch;AUX> + <ch;KWh> + <ch;HtRejKW>            -033    20
            <ch;AUX>  = <ch;AUX> + <ch;HtRejKW>                                 -033    21
            <ch;FUEL> = <ch;FUEL> + <ch;FUELh>                                  PLTSTA 558
c              monthly statistics                                               PLTSTA 559
c              equipment load                                                   PLTSTA 560
            IF (<pe;GPM> .NE. 0.) THEN                                          -044c4 397
              <ch;QMO> = <ch;QMO> + MAX(0., <pe;LOAD>)                          ChlrHP 966
              IF (<pe;LOAD> .GT. <ch;QMOM>)  THEN                               PLTSTA 563
                <ch;QMOM>   = <pe;LOAD>                                         PLTSTA 564
                <ch;QMOMDY> = IDAY                                              PLTSTA 565
                <ch;QMOMHR> = ISCHR                                             PLTSTA 566
                <ch;PeakCHWSMo>  = <pe;SUPPLY_T>                                -041h   39
                <ch;PeakTcondMo> = <ch;Tcond>                                   -041h   40
                <ch;PeakDBTMo>   = DBT                                          -041h   41
                <ch;PeakWBTMo>   = WBT                                          -041h   42
              ENDIF                                                             PLTSTA 567
              IF (<ch:TYPE> .NE. 11)  THEN  ! not loop-to-loop hp               ChlrHP 967
                II = INDXPL(<pe;LOAD>,<pe;OPER_CAPACITY>)                       ChlrHP 968
                <ch;QPLRMO> = <ch;QPLRMO> + 1                                   ChlrHP 969
                II = 12                                                         ChlrHP 970
                <ch;QPLRMO> = <ch;QPLRMO> + 1                                   ChlrHP 971
              ENDIF                                                             ChlrHP 972
              <pe;HOURS_OFF> = 0                                                PLTSTA 572
            ELSE                                                                PLTSTA 573
c           increment hours chiller not running                                 PLTSTA 574
              <pe;HOURS_OFF> = <pe;HOURS_OFF> + 1                               PLTSTA 575
            ENDIF                                                               PLTSTA 576
c              elec consumption                                                 PLTSTA 577
            IF (<ch;KW> .NE. 0.)  THEN                                          PLTSTA 578
              <ch;KWHMO> = <ch;KWHMO> + <ch;KW>                                 PLTSTA 579
              IF (<ch;KW> .GT. <ch;KWHMOM>)  THEN                               PLTSTA 580
                <ch;KWHMOM>   = <ch;KW>                                         PLTSTA 581
                <ch;KWHMOMDY> = IDAY                                            PLTSTA 582
                <ch;KWHMOMHR> = ISCHR                                           PLTSTA 583
              ENDIF                                                             PLTSTA 584
              II = INDXPL(<ch;KW>,<ch;DES_KW>)                                  PLTSTA 585
              <ch;KWHPLRMO> = <ch;KWHPLRMO> + 1                                 PLTSTA 586
              II = 12                                                           PLTSTA 587
              <ch;KWHPLRMO> = <ch;KWHPLRMO> + 1                                 PLTSTA 588
            ENDIF                                                               PLTSTA 589
c              fuel consumption                                                 PLTSTA 590
            IF (<ch;FUEL> .NE. 0.)  THEN                                        PLTSTA 591
              <ch;FUELMO> = <ch;FUELMO> + <ch;FUEL>                             PLTSTA 592
              IF (<ch;DES_FUEL> .GT. 0.)  THEN                                  PLTSTA 593
c              fuel for gas-fired                                               PLTSTA 594
                IF (<ch;FUEL> .GT. <ch;FUELMOM>)  THEN                          PLTSTA 595
                  <ch;FUELMOM>   = <ch;FUEL>                                    PLTSTA 596
                  <ch;FUELMOMDY> = IDAY                                         PLTSTA 597
                  <ch;FUELMOMHR> = ISCHR                                        PLTSTA 598
                ENDIF                                                           PLTSTA 599
                Jpe = <ch;Jpe_HEAT>                                             PLTSTA 600
                IF (<ch;FUELh> .NE. 0.)  THEN                                   PLTSTA 601
                  <pe;HOURS_OFF> = 0                                            PLTSTA 602
                ELSE                                                            PLTSTA 603
c              increment hours chiller not heating                              PLTSTA 604
                 <pe;HOURS_OFF> = <pe;HOURS_OFF> + 1                            PLTSTA 605
                ENDIF                                                           PLTSTA 606
                Jpe = <ch;Jpe>                                                  PLTSTA 607
              ELSE                                                              PLTSTA 608
c              loop heat for hw/steam absorption                                PLTSTA 609
                IF (<ch;FUEL> .LT. <ch;FUELMOM>)  THEN                          PLTSTA 610
                  <ch;FUELMOM>   = <ch;FUEL>                                    PLTSTA 611
                  <ch;FUELMOMDY> = IDAY                                         PLTSTA 612
                  <ch;FUELMOMHR> = ISCHR                                        PLTSTA 613
                ENDIF                                                           PLTSTA 614
              ENDIF                                                             PLTSTA 615
              II = INDXPL(<ch;FUEL>,<ch;DES_FUEL>)                              PLTSTA 616
              <ch;FUELPLRMO> = <ch;FUELPLRMO> + 1                               PLTSTA 617
              II = 12                                                           PLTSTA 618
              <ch;FUELPLRMO> = <ch;FUELPLRMO> + 1                               PLTSTA 619
            ENDIF                                                               PLTSTA 620
c              aux elec consumption                                             PLTSTA 621
            <ch;AUXMO> = <ch;AUXMO> + <ch;AUX>                                  PLTSTA 622
            IF (<ch;AUX> .GT. <ch;AUXMOM>)  THEN                                PLTSTA 623
              <ch;AUXMOM>   = <ch;AUX>                                          PLTSTA 624
              <ch;AUXMOMDY> = IDAY                                              PLTSTA 625
              <ch;AUXMOMHR> = ISCHR                                             PLTSTA 626
            ENDIF                                                               PLTSTA 627
c              heat recovery (all chillers)                                     PLTSTA 628
c              and/or heating load (gas chiller/heaters)                        PLTSTA 629
            <ch;QRECVRMO> = <ch;QRECVRMO> + <ch;Q_RECVR>                        PLTSTA 630
            IF (<ch;Q_RECVR> .LT. <ch;QRECVRMOM>)  THEN                         PLTSTA 631
              <ch;QRECVRMOM>   = <ch;Q_RECVR>                                   PLTSTA 632
              <ch;QRECVRMOMDY> = IDAY                                           PLTSTA 633
              <ch;QRECVRMOMHR> = ISCHR                                          PLTSTA 634
            ENDIF                                                               PLTSTA 635
c              bin hours for loop-to-loop hp                                    ChlrHP 973
            IF (<ch:TYPE> .EQ. 11  .AND.  <ch;PLR> .GT. 0)  THEN                ChlrHP 974
              II = INDXPL(<ch;PLR>,1.)                                          ChlrHP 975
              <ch;QPLRMO> = <ch;QPLRMO> + 1                                     ChlrHP 976
              II = 12                                                           ChlrHP 977
              <ch;QPLRMO> = <ch;QPLRMO> + 1                                     ChlrHP 978
            ENDIF                                                               ChlrHP 979
                                                                                -044e5  84
c              Thermal storage (cooling)                                        -044e5  85
          CASE (181:190)                                                        -044e5  86
            Jtk = <pe;Jparent>                                                  PLTSTA 639
c              energy end uses and meters                                       PLTSTA 640
c              auxiliary                                                        PLTSTA 641
            Jem        = <tk:AUX-METER>                                         PLTSTA 642
            <em;AUX>   = <em;AUX>  + <tk;AUX>                                   PLTSTA 643
c              monthly statistics                                               PLTSTA 644
c              storage discharge                                                PLTSTA 645
            IF (<pe;LOAD> .NE. 0.) THEN                                         PLTSTA 646
              <tk;DCHRG_MO> = <tk;DCHRG_MO> + <pe;LOAD>                         PLTSTA 647
              IF (<pe;LOAD> .GT. <tk;DCHRG_MOM>)  THEN                          PLTSTA 648
                <tk;DCHRG_MOM>    = <pe;LOAD>                                   PLTSTA 649
                <tk;DCHRG_MOM_DY> = IDAY                                        PLTSTA 650
                <tk;DCHRG_MOM_HR> = ISCHR                                       PLTSTA 651
              ENDIF                                                             PLTSTA 652
              II = INDXPL(<pe;LOAD>,<tk:MAX-DCHRG-RAT>)                         PLTSTA 653
              <tk;DCHRG_PLR_MO> = <tk;DCHRG_PLR_MO> + 1                         PLTSTA 654
              II = 12                                                           PLTSTA 655
              <tk;DCHRG_PLR_MO> = <tk;DCHRG_PLR_MO> + 1                         PLTSTA 656
c              allocate energy discharged to enduses according                  PLTSTA 657
c              to the meters that originally created the heat                   PLTSTA 658
              IF (<tk;Q_BASE> .EQ. <tk;Q_TANK>)  THEN                           Ver42L1 64
                FracDChrg = 0.                                                  Ver42L1 65
              ELSE                                                              Ver42L1 66
                FracDChrg = <pe;LOAD> / (<tk;Q_BASE>-<tk;Q_TANK>)               Ver42L1 67
                FracDChrg = Max(0., FracDChrg)                                  Ver42L1 68
              ENDIF                                                             Ver42L1 69
              NeqPrime = <tk;NUM_PRIM_EQ>                                       PLTSTA 660
              DO  ME=1,NeqPrime                                                 PLTSTA 661
                CoolkW       = <tk;ELEC_KW> * FracDChrg                         PLTSTA 662
                <tk;ELEC_KW> = <tk;ELEC_KW> - CoolkW                            PLTSTA 663
                Jem          = <tk;PRIM_ELEC_MTR>                               PLTSTA 664
                <em;COOL>    = <em;COOL>  + CoolkW * PctCool                    PLTSTA 665
                <em;EQUIP>   = <em;EQUIP> + CoolkW * PctEquip                   PLTSTA 666
c              deduct from total, as was counted in total when stored           PLTSTA 667
                <em;TES_ADJUST>   = <em;TES_ADJUST> - CoolkW                    PLTSTA 668
                CoolFuel     = <tk;FUEL_Q> * FracDChrg                          PLTSTA 669
                IF (CoolFuel .GT. 0.)  THEN                                     PLTSTA 670
                  <tk;FUEL_Q> = <tk;FUEL_Q> - CoolFuel                          PLTSTA 671
                  Jfm         = <tk;PRIM_FUEL_MTR>                              PLTSTA 672
                  <fm;COOL>   = <fm;COOL>  + CoolFuel * PctCool                 PLTSTA 673
                  <fm;EQUIP>  = <fm;EQUIP> + CoolFuel * PctEquip                PLTSTA 674
c              deduct from total, as was counted in total when stored           PLTSTA 675
                  <fm;TES_ADJUST>  = <fm;TES_ADJUST> - CoolFuel                 PLTSTA 676
                ENDIF                                                           PLTSTA 677
              ENDDO                                                             PLTSTA 678
              IF (<tk;CHW_METER> .GT. 0)  THEN                                  PLTSTA 679
                CoolCHW    = <tk;CHW_Q> * FracDChrg                             PLTSTA 680
                <tk;CHW_Q> = <tk;CHW_Q> - CoolCHW                               PLTSTA 681
                Jcm        = <tk;CHW_METER>                                     PLTSTA 682
                <cm;COOL>  = <cm;COOL>  + CoolCHW * PctCool                     PLTSTA 683
                <cm;EQUIP> = <cm;EQUIP> + CoolCHW * PctEquip                    PLTSTA 684
c              deduct from total, as was counted in total when stored           PLTSTA 685
                <cm;TES_ADJUST>  = <cm;TES_ADJUST> - CoolCHW                    PLTSTA 686
              ENDIF                                                             PLTSTA 687
            ENDIF                                                               PLTSTA 688
c              storage charge - combine normal charge w/ freeze                 PLTSTA 689
            Qcharge = <tk;Q_CHRG> + <tk;Q_FREEZE>                               PLTSTA 690
            IF (Qcharge .NE. 0.) THEN                                           PLTSTA 691
              <tk;CHRG_MO> = <tk;CHRG_MO> + Qcharge                             PLTSTA 692
              IF (Qcharge  .GT. <tk;CHRG_MOM>)  THEN                            PLTSTA 693
                <tk;CHRG_MOM>    = Qcharge                                      PLTSTA 694
                <tk;CHRG_MOM_DY> = IDAY                                         PLTSTA 695
                <tk;CHRG_MOM_HR> = ISCHR                                        PLTSTA 696
              ENDIF                                                             PLTSTA 697
              II = INDXPL(Qcharge,<tk:MAX-CHRG-RATE>)                           PLTSTA 698
              <tk;CHRG_PLR_MO> = <tk;CHRG_PLR_MO> + 1                           PLTSTA 699
              II = 12                                                           PLTSTA 700
              <tk;CHRG_PLR_MO> = <tk;CHRG_PLR_MO> + 1                           PLTSTA 701
            ENDIF                                                               PLTSTA 702
c              losses                                                           PLTSTA 703
            IF (<tk;Q_LOSS> .NE. 0.) THEN                                       PLTSTA 704
              <tk;LOSS_MO> = <tk;LOSS_MO> + <tk;Q_LOSS>                         PLTSTA 705
              IF (<tk;Q_LOSS> .GT. <tk;LOSS_MOM>)  THEN                         PLTSTA 706
                <tk;LOSS_MOM>    = <tk;Q_LOSS>                                  PLTSTA 707
                <tk;LOSS_MOM_DY> = IDAY                                         PLTSTA 708
                <tk;LOSS_MOM_HR> = ISCHR                                        PLTSTA 709
              ENDIF                                                             PLTSTA 710
            ENDIF                                                               PLTSTA 711
c              aux elec consumption                                             PLTSTA 712
            <tk;AUX_MO> = <tk;AUX_MO> + <tk;AUX>                                PLTSTA 713
            IF (<tk;AUX> .GT. <tk;AUX_MOM>)  THEN                               PLTSTA 714
              <tk;AUX_MOM>    = <tk;AUX>                                        PLTSTA 715
              <tk;AUX_MOM_DY> = IDAY                                            PLTSTA 716
              <tk;AUX_MOM_HR> = ISCHR                                           PLTSTA 717
            ENDIF                                                               PLTSTA 718
c              set storage variables to new values                              PLTSTA 719
            <tk;Q_TANK>    = <tk;Q_TANK'>                                       PLTSTA 720
            <tk;CHRG_HRS>  = <tk;CHRG_HRS'>                                     PLTSTA 721
            <tk;DCHRG_HRS> = <tk;DCHRG_HRS'>                                    PLTSTA 722
c              hourly-report variables for stored energy                        PLTSTA 723
            IF (<tk;HREP> .NE. 0  .AND.  IRSCH .NE. 0)  THEN                    PLTSTA 724
              CALL FILLN(0., TESSAV(1), IVTLIM(2,22))                           PLTSTA 725
              Neq = <tk;NUM_PRIM_EQ>                                            PLTSTA 726
              DO  ME=1,Neq                                                      PLTSTA 727
                StoredKWh  = StoredKWh  + <tk;ELEC_KW>                          PLTSTA 728
                StoredFuel = StoredFuel + <tk;FUEL_Q>                           PLTSTA 729
              ENDDO                                                             PLTSTA 730
              StoredKWh  = MAX(1.E-6, StoredKWh)                                PLTSTA 731
              StoredFuel = MAX(1.E-6, StoredFuel)                               PLTSTA 732
              CALL HourRepPLT(TESSAV(1), <tk;HREP>, 22, 1)                      PLTSTA 733
            ENDIF                                                               PLTSTA 734
                                                                                -044e5  87
c              Heating mode of chiller                                          -044e5  88
          CASE (199)                                                            -044e5  89
c              point back from ghost to actual chiller                          PLTSTA 738
            Jch = <pe;Jparent>                                                  PLTSTA 739
c              process only the heating fuel here.  Cooling will be             PLTSTA 740
c              processed from the cooling loop.                                 PLTSTA 741
            IF (<ch;FUELh>+<ch;KWh> .GT. 0.)  THEN                              ChlrHP 982
              Jem        = <ch:ELEC-METER>                                      PLTSTA 743
              HeatkW     = <ch;KWh>                                             PLTSTA 744
              <em;HEAT>  = <em;HEAT>  + HeatkW * PctHeat                        PLTSTA 745
              <em;COOL>  = <em;COOL>  + HeatkW * PctCool                        PLTSTA 746
              <em;EQUIP> = <em;EQUIP> + HeatkW * PctEquip                       PLTSTA 747
              <em;AUX>   = <em;AUX>   + HeatkW * PctAux                         PLTSTA 748
              <em;DHW>   = <em;DHW>   + HeatkW * PctDHW                         PLTSTA 749
              Jfm        = <ch:FUEL-METER>                                      PLTSTA 750
              HeatFuel   = <ch;FUELh>                                           PLTSTA 751
              <fm;HEAT>  = <fm;HEAT>  + HeatFuel * PctHeat                      PLTSTA 752
              <fm;COOL>  = <fm;COOL>  + HeatFuel * PctCool                      PLTSTA 753
              <fm;EQUIP> = <fm;EQUIP> + HeatFuel * PctEquip                     PLTSTA 754
              <fm;AUX>   = <fm;AUX>   + HeatFuel * PctAux                       PLTSTA 755
              <fm;DHW>   = <fm;DHW>   + HeatFuel * PctDHW                       PLTSTA 756
c              portion that goes into storage                                   PLTSTA 757
              IF (PctStore .GT. 0.)  THEN                                       PLTSTA 758
                ME = IQ                                                         PLTSTA 759
                Ntes = <lp;NUM_CHRG_TES>                                        PLTSTA 760
                DO  IT=1,Ntes                                                   PLTSTA 761
                  Jtk = <lp;CHRG_TES>                                           PLTSTA 762
                  Prorate = <tk;Q_CHRG> / <lp;TES_CHRG_HEAT>                    PLTSTA 763
                  <tk;ELEC_KW> = <tk;ELEC_KW> + HeatkW*PctStore*Prorate         PLTSTA 764
                  <tk;FUEL_Q> = <tk;FUEL_Q> + HeatFuel*PctStore*Prorate         PLTSTA 765
                ENDDO                                                           PLTSTA 766
c              add to total, so energy correct for the hour                     PLTSTA 767
                <em;TES_ADJUST> = <em;TES_ADJUST> + HeatkW*PctStore             PLTSTA 768
                <fm;TES_ADJUST> = <fm;TES_ADJUST> + HeatFuel*PctStore           PLTSTA 769
              ENDIF                                                             PLTSTA 770
c  ??          hook up steam turbine in future                                  PLTSTA 771
c             end of chiller/heater in heating mode                             PLTSTA 772
            ENDIF                                                               PLTSTA 773
                                                                                -044e5  90
c              Conventional boilers                                             -044e5  91
          CASE (200:280)                                                        -044e5  92
            Jbl = <pe;Jparent>                                                  PLTSTA 781
c              energy end uses and meters                                       PLTSTA 782
c              auxiliary                                                        PLTSTA 783
            Jem        = <bl:AUX-METER>                                         PLTSTA 784
            <em;AUX>   = <em;AUX> + <pe;AUX_KW>                                 PLTSTA 785
c              apportion the boiler energy amoung the ultimate end-uses         PLTSTA 786
            Jem        = <bl:ELEC-METER>                                        PLTSTA 787
            HeatkW     = <pe;KW>                                                PLTSTA 788
            <em;HEAT>  = <em;HEAT>  + HeatkW * PctHeat                          PLTSTA 789
            <em;COOL>  = <em;COOL>  + HeatkW * PctCool                          PLTSTA 790
            <em;EQUIP> = <em;EQUIP> + HeatkW * PctEquip                         PLTSTA 791
            <em;DHW>   = <em;DHW>   + HeatkW * PctDHW                           PLTSTA 792
            <em;AUX>   = <em;AUX>   + HeatkW * PctAux                           PLTSTA 793
            Jfm        = <bl:FUEL-METER>                                        PLTSTA 794
            HeatFuel   = <pe;FUEL>                                              PLTSTA 795
            <fm;HEAT>  = <fm;HEAT>  + HeatFuel * PctHeat                        PLTSTA 796
            <fm;COOL>  = <fm;COOL>  + HeatFuel * PctCool                        PLTSTA 797
            <fm;EQUIP> = <fm;EQUIP> + HeatFuel * PctEquip                       PLTSTA 798
            <fm;AUX>   = <fm;AUX>   + HeatFuel * PctAux                         PLTSTA 799
            <fm;DHW>   = <fm;DHW>   + HeatFuel * PctDHW                         PLTSTA 800
c              portion that goes into storage                                   PLTSTA 801
            IF (PctStore .GT. 0.)  THEN                                         PLTSTA 802
              ME = IQ                                                           PLTSTA 803
              Ntes = <lp;NUM_CHRG_TES>                                          PLTSTA 804
              DO  IT=1,Ntes                                                     PLTSTA 805
                Jtk = <lp;CHRG_TES>                                             PLTSTA 806
                Prorate = <tk;Q_CHRG> / <lp;TES_CHRG_HEAT>                      PLTSTA 807
                <tk;ELEC_KW> = <tk;ELEC_KW> + HeatkW*PctStore*Prorate           PLTSTA 808
                <tk;FUEL_Q> = <tk;FUEL_Q> + HeatFuel*PctStore*Prorate           PLTSTA 809
              ENDDO                                                             PLTSTA 810
c              add to total, so energy correct for the hour                     PLTSTA 811
              <em;TES_ADJUST> = <em;TES_ADJUST> + HeatkW*PctStore               PLTSTA 812
              <fm;TES_ADJUST> = <fm;TES_ADJUST> + HeatFuel*PctStore             PLTSTA 813
            ENDIF                                                               PLTSTA 814
c              steam turbine - allocate heat to auxiliary category              PLTSTA 815
            <em;AUX> = <em;AUX> + HeatkW * PctElec                              PLTSTA 816
            <fm;AUX> = <fm;AUX> + HeatFuel * PctElec                            PLTSTA 817
c              monthly statistics                                               PLTSTA 818
            CALL PlantStatistics_Jpe(1)                                         PLTSTA 819
c              HWR at which peak occurs                                         -045m   76
            IC = 1                                                              -045m   77
            IF (<pe;LOAD> .eq. <pe;MONTH_MAX>) THEN                             -045m   78
              <bl;PeakHWRMo> = <pe;RETURN_T>                                    -045m   79
            ENDIF                                                               -045m   80
                                                                                -044e5  93
c              Thermal storage (heating)                                        -044e5  94
          CASE (281:290)                                                        -044e5  95
            Jtk = <pe;Jparent>                                                  PLTSTA 823
c              energy end uses and meters                                       PLTSTA 824
c              auxiliary                                                        PLTSTA 825
            Jem        = <tk:AUX-METER>                                         PLTSTA 826
            <em;AUX>   = <em;AUX>  + <tk;AUX>                                   PLTSTA 827
c              monthly statistics                                               PLTSTA 828
c              storage discharge                                                PLTSTA 829
            IF (<pe;LOAD> .NE. 0.) THEN                                         PLTSTA 830
              <tk;DCHRG_MO> = <tk;DCHRG_MO> + <pe;LOAD>                         PLTSTA 831
              IF (<pe;LOAD> .LT. <tk;DCHRG_MOM>)  THEN                          PLTSTA 832
                <tk;DCHRG_MOM>    = <pe;LOAD>                                   PLTSTA 833
                <tk;DCHRG_MOM_DY> = IDAY                                        PLTSTA 834
                <tk;DCHRG_MOM_HR> = ISCHR                                       PLTSTA 835
              ENDIF                                                             PLTSTA 836
              II = INDXPL(<pe;LOAD>,<tk:MAX-DCHRG-RAT>)                         PLTSTA 837
              <tk;DCHRG_PLR_MO> = <tk;DCHRG_PLR_MO> + 1                         PLTSTA 838
              II = 12                                                           PLTSTA 839
              <tk;DCHRG_PLR_MO> = <tk;DCHRG_PLR_MO> + 1                         PLTSTA 840
c              allocate energy discharged to enduses according                  PLTSTA 841
c              to the meters that originally created the heat                   PLTSTA 842
              IF (<tk;Q_BASE> .EQ. <tk;Q_TANK>)  THEN                           Ver42L1 70
                FracDChrg = 0.                                                  Ver42L1 71
              ELSE                                                              Ver42L1 72
                FracDChrg = <pe;LOAD> / (<tk;Q_BASE>-<tk;Q_TANK>)               Ver42L1 73
                FracDChrg = Max(0., FracDChrg)                                  Ver42L1 74
              ENDIF                                                             Ver42L1 75
              NeqPrime = <tk;NUM_PRIM_EQ>                                       PLTSTA 844
              DO  ME=1,NeqPrime                                                 PLTSTA 845
                HeatkW       = <tk;ELEC_KW> * FracDChrg                         PLTSTA 846
                <tk;ELEC_KW> = <tk;ELEC_KW> - HeatkW                            PLTSTA 847
                Jem          = <tk;PRIM_ELEC_MTR>                               PLTSTA 848
                <em;HEAT>    = <em;HEAT>  + HeatkW * PctHeat                    PLTSTA 849
                <em;COOL>    = <em;COOL>  + HeatkW * PctCool                    PLTSTA 850
                <em;EQUIP>   = <em;EQUIP> + HeatkW * PctEquip                   PLTSTA 851
                <em;AUX>     = <em;AUX>   + HeatkW * PctAux                     PLTSTA 852
                <em;DHW>     = <em;DHW>   + HeatkW * PctDHW                     PLTSTA 853
c              deduct from total, as was counted in total when stored           PLTSTA 854
                <em;TES_ADJUST> = <em;TES_ADJUST> - HeatkW                      PLTSTA 855
                HeatFuel     = <tk;FUEL_Q> * FracDChrg                          PLTSTA 856
                <tk;FUEL_Q>  = <tk;FUEL_Q> - HeatFuel                           PLTSTA 857
                Jfm          = <tk;PRIM_FUEL_MTR>                               PLTSTA 858
                <fm;HEAT>    = <fm;HEAT>  + HeatFuel * PctHeat                  PLTSTA 859
                <fm;COOL>    = <fm;COOL>  + HeatFuel * PctCool                  PLTSTA 860
                <fm;EQUIP>   = <fm;EQUIP> + HeatFuel * PctEquip                 PLTSTA 861
                <fm;AUX>     = <fm;AUX>   + HeatFuel * PctAux                   PLTSTA 862
                <fm;DHW>     = <fm;DHW>   + HeatFuel * PctDHW                   PLTSTA 863
c              deduct from total, as was counted in total when stored           PLTSTA 864
                <fm;TES_ADJUST> = <fm;TES_ADJUST> - HeatFuel                    PLTSTA 865
              ENDDO                                                             PLTSTA 866
              IF (<tk;STEAM_METER> .GT. 0)  THEN                                PLTSTA 867
                HeatStm = <tk;STEAM_Q> * FracDChrg                              PLTSTA 868
                <tk;STEAM_Q> = <tk;STEAM_Q> - HeatStm                           PLTSTA 869
                Jsm = <tk;STEAM_METER>                                          PLTSTA 870
                <sm;HEAT>    = <sm;HEAT>  + HeatStm * PctHeat                   PLTSTA 871
                <sm;COOL>    = <sm;COOL>  + HeatStm * PctCool                   PLTSTA 872
                <sm;EQUIP>   = <sm;EQUIP> + HeatStm * PctEquip                  PLTSTA 873
                <sm;AUX>     = <sm;AUX>   + HeatStm * PctAux                    PLTSTA 874
                <sm;DHW>     = <sm;DHW>   + HeatStm * PctDHW                    PLTSTA 875
c              deduct from total, as was counted in total when stored           PLTSTA 876
                <sm;TES_ADJUST> = <sm;TES_ADJUST> - HeatStm                     PLTSTA 877
              ENDIF                                                             PLTSTA 878
            ENDIF                                                               PLTSTA 879
c              storage charge - combine normal charge w/ freeze                 PLTSTA 880
            Qcharge = <tk;Q_CHRG> + <tk;Q_FREEZE>                               PLTSTA 881
            IF (Qcharge .NE. 0.) THEN                                           PLTSTA 882
              <tk;CHRG_MO> = <tk;CHRG_MO> + Qcharge                             PLTSTA 883
              IF (Qcharge  .LT. <tk;CHRG_MOM>)  THEN                            PLTSTA 884
                <tk;CHRG_MOM>    = Qcharge                                      PLTSTA 885
                <tk;CHRG_MOM_DY> = IDAY                                         PLTSTA 886
                <tk;CHRG_MOM_HR> = ISCHR                                        PLTSTA 887
              ENDIF                                                             PLTSTA 888
              II = INDXPL(Qcharge,<tk:MAX-CHRG-RATE>)                           PLTSTA 889
              <tk;CHRG_PLR_MO> = <tk;CHRG_PLR_MO> + 1                           PLTSTA 890
              II = 12                                                           PLTSTA 891
              <tk;CHRG_PLR_MO> = <tk;CHRG_PLR_MO> + 1                           PLTSTA 892
            ENDIF                                                               PLTSTA 893
c              losses                                                           PLTSTA 894
            IF (<tk;Q_LOSS> .NE. 0.) THEN                                       PLTSTA 895
              <tk;LOSS_MO> = <tk;LOSS_MO> + <tk;Q_LOSS>                         PLTSTA 896
              IF (<tk;Q_LOSS> .GT. <tk;LOSS_MOM>)  THEN                         PLTSTA 897
                <tk;LOSS_MOM>    = <tk;Q_LOSS>                                  PLTSTA 898
                <tk;LOSS_MOM_DY> = IDAY                                         PLTSTA 899
                <tk;LOSS_MOM_HR> = ISCHR                                        PLTSTA 900
              ENDIF                                                             PLTSTA 901
            ENDIF                                                               PLTSTA 902
c              aux elec consumption                                             PLTSTA 903
            <tk;AUX_MO> = <tk;AUX_MO> + <tk;AUX>                                PLTSTA 904
            IF (<tk;AUX> .GT. <tk;AUX_MOM>)  THEN                               PLTSTA 905
              <tk;AUX_MOM>    = <tk;AUX>                                        PLTSTA 906
              <tk;AUX_MOM_DY> = IDAY                                            PLTSTA 907
              <tk;AUX_MOM_HR> = ISCHR                                           PLTSTA 908
            ENDIF                                                               PLTSTA 909
c              set storage variables to new values                              PLTSTA 910
            <tk;Q_TANK>    = <tk;Q_TANK'>                                       PLTSTA 911
            <tk;CHRG_HRS>  = <tk;CHRG_HRS'>                                     PLTSTA 912
            <tk;DCHRG_HRS> = <tk;DCHRG_HRS'>                                    PLTSTA 913
c              hourly-report variables for stored energy                        PLTSTA 914
            IF (<tk;HREP> .NE. 0  .AND.  IRSCH .NE. 0)  THEN                    PLTSTA 915
              CALL FILLN(0., TESSAV(1), IVTLIM(2,22))                           PLTSTA 916
              Neq = <tk;NUM_PRIM_EQ>                                            PLTSTA 917
              DO  ME=1,Neq                                                      PLTSTA 918
                StoredKWh  = StoredKWh  + <tk;ELEC_KW>                          PLTSTA 919
                StoredFuel = StoredFuel + <tk;FUEL_Q>                           PLTSTA 920
              ENDDO                                                             PLTSTA 921
              StoredKWh  = MAX(1.E-6,  StoredKWh)                               PLTSTA 922
              StoredFuel = MAX(1.E-10, StoredFuel)                              PLTSTA 923
              CALL HourRepPLT(TESSAV(1), <tk;HREP>, 22, 1)                      PLTSTA 924
            ENDIF                                                               PLTSTA 925
c              end of thermal storage statistics                                PLTSTA 926
                                                                                -044e5  96
c              Ground-loop heat-exchangers (heating)                            -044e5  97
          CASE (291:294)                                                        -044e5  98
            Jgl = <pe;Jparent>                                                  -044e5  99
c              monthly statistics                                               -044e5 100
            IF (<pe;GPM> .eq. 0.) Cycle                                         -044e5 101
c              equipment load                                                   -044e5 102
            <gl.Heat_Mo> = <gl.Heat_Mo> + <pe;LOAD>                             -044e5 103
            IF (<pe;LOAD> .lt. <gl.Heat_MoM>) THEN                              -044e5 104
              <gl.Heat_MoM>  = <pe;LOAD>                                        -044e5 105
              <gl.Heat_MoDy> = IDAY                                             -044e5 106
              <gl.Heat_MoHr> = ISCHR                                            -044e5 107
            ENDIF                                                               -044e5 108
c              temperature bins                                                 -044e5 109
            II = Max(1, Min(12, Int(<pe;SUPPLY_T>/10.)))                        -044e5 110
            <gl.HeatT_Mo> = <gl.HeatT_Mo> + 1                                   -044e5 111
            II = 13                                                             -044e5 112
            <gl.HeatT_Mo> = <gl.HeatT_Mo> + 1                                   -044e5 113
c              max/min temperatures                                             -044e5 114
            <gl.HeatTmax_Mo> = Max(<gl.HeatTmax_Mo>, <pe;SUPPLY_T>)             -044e5 115
            <gl.HeatTmin_Mo> = Min(<gl.HeatTmin_Mo>, <pe;SUPPLY_T>)             -044e5 116
                                                                                -044e5 117
c             DW heaters                                                        -044e5 118
          CASE (301,302)                                                        -044e5 119
          Jdw = <pe;Jparent>                                                    -044e5 120
c              energy end uses and meters                                       PLTSTA 933
c              auxiliary                                                        PLTSTA 934
          Jem       = <dw:AUX-METER>                                            PLTSTA 935
          <em;AUX>  = <em;AUX>  + <dw;AUX>                                      PLTSTA 936
c              apportion the DW Heater energy amoung the ultimate end-uses      PLTSTA 937
          Jem        = <dw:ELEC-METER>                                          PLTSTA 938
          DHWkW      = <dw;KW>                                                  PLTSTA 939
          <em;HEAT>  = <em;HEAT>  + DHWkW * PctHeat                             PLTSTA 940
          <em;EQUIP> = <em;EQUIP> + DHWkW * PctEquip                            PLTSTA 941
          <em;AUX>   = <em;AUX>   + DHWkW * PctAux                              PLTSTA 942
          <em;DHW>   = <em;DHW>   + DHWkW * PctDHW                              PLTSTA 943
          Jfm        = <dw:FUEL-METER>                                          PLTSTA 944
          DHWFuel    = <dw;FUEL>                                                PLTSTA 945
          <fm;HEAT>  = <fm;HEAT>  + DHWFuel * PctHeat                           PLTSTA 946
          <fm;EQUIP> = <fm;EQUIP> + DHWFuel * PctEquip                          PLTSTA 947
          <fm;AUX>   = <fm;AUX>   + DHWFuel * PctAux                            PLTSTA 948
          <fm;DHW>   = <fm;DHW>   + DHWFuel * PctDHW                            PLTSTA 949
c              combine for total electric                                       PLTSTA 950
          <dw;KW>  = <dw;KW>  + <dw;AUX>                                        PLTSTA 951
c              monthly statistics                                               PLTSTA 952
c              equipment load                                                   PLTSTA 953
          IF (<pe;LOAD> .NE. 0.) THEN                                           PLTSTA 954
            <dw;QMO> = <dw;QMO> + <pe;LOAD>                                     PLTSTA 955
            IF (<pe;LOAD> .LT. <dw;QMOM>)  THEN                                 PLTSTA 956
              <dw;QMOM>   = <pe;LOAD>                                           PLTSTA 957
              <dw;QMOMDY> = IDAY                                                PLTSTA 958
              <dw;QMOMHR> = ISCHR                                               PLTSTA 959
            ENDIF                                                               PLTSTA 960
            II = INDXPL(<pe;LOAD>,<pe;OPER_CAPACITY>)                           PLTSTA 961
            <dw;QPLRMO> = <dw;QPLRMO> + 1                                       PLTSTA 962
            II = 12                                                             PLTSTA 963
            <dw;QPLRMO> = <dw;QPLRMO> + 1                                       PLTSTA 964
          ENDIF                                                                 PLTSTA 965
c              elec consumption                                                 PLTSTA 966
          IF (<dw;KW> .NE. 0.)  THEN                                            PLTSTA 967
            <dw;KWHMO> = <dw;KWHMO> + <dw;KW>                                   PLTSTA 968
            IF (<dw;KW> .GT. <dw;KWHMOM>)  THEN                                 PLTSTA 969
              <dw;KWHMOM>   = <dw;KW>                                           PLTSTA 970
              <dw;KWHMOMDY> = IDAY                                              PLTSTA 971
              <dw;KWHMOMHR> = ISCHR                                             PLTSTA 972
            ENDIF                                                               PLTSTA 973
            II = INDXPL(<dw;KW>,<dw;DES_KW>)                                    PLTSTA 974
            <dw;KWHPLRMO> = <dw;KWHPLRMO> + 1                                   PLTSTA 975
            II = 12                                                             PLTSTA 976
            <dw;KWHPLRMO> = <dw;KWHPLRMO> + 1                                   PLTSTA 977
          ENDIF                                                                 PLTSTA 978
c              fuel consumption                                                 PLTSTA 979
          IF (<dw;FUEL> .NE. 0.)  THEN                                          PLTSTA 980
            <dw;FUELMO> = <dw;FUELMO> + <dw;FUEL>                               PLTSTA 981
            IF (<dw;FUEL> .GT. <dw;FUELMOM>)  THEN                              PLTSTA 982
              <dw;FUELMOM>   = <dw;FUEL>                                        PLTSTA 983
              <dw;FUELMOMDY> = IDAY                                             PLTSTA 984
              <dw;FUELMOMHR> = ISCHR                                            PLTSTA 985
            ENDIF                                                               PLTSTA 986
            II = INDXPL(<dw;FUEL>,<dw;DES_FUEL>)                                PLTSTA 987
            <dw;FUELPLRMO> = <dw;FUELPLRMO> + 1                                 PLTSTA 988
            II = 12                                                             PLTSTA 989
            <dw;FUELPLRMO> = <dw;FUELPLRMO> + 1                                 PLTSTA 990
          ENDIF                                                                 PLTSTA 991
c              aux elec consumption                                             PLTSTA 992
          <dw;AUXMO> = <dw;AUXMO> + <dw;AUX>                                    PLTSTA 993
          IF (<dw;AUX> .GT. <dw;AUXMOM>)  THEN                                  PLTSTA 994
            <dw;AUXMOM>   = <dw;AUX>                                            PLTSTA 995
            <dw;AUXMOMDY> = IDAY                                                PLTSTA 996
            <dw;AUXMOMHR> = ISCHR                                               PLTSTA 997
          ENDIF                                                                 PLTSTA 998
                                                                                -044e5 121
c             Cooling towers                                                    -044e5 122
          CASE (401:404)                                                        -044e5 123
          Jtw = <pe;Jparent>                                                    -044e5 124
c              auxiliary                                                        PLTSTA1004
          Jem        = <tw:AUX-METER>                                           PLTSTA1005
          <em;AUX>   = <em;AUX>  + <tw;AUX>                                     PLTSTA1006
          Jem        = <tw:ELEC-METER>                                          PLTSTA1007
          <em;HTREJ> = <em;HTREJ> + <tw;KW>                                     PLTSTA1008
c              combine for total elec usage                                     PLTSTA1009
          <tw;KW>    = <tw;KW> + <tw;AUX>                                       PLTSTA1010
c              monthly statistics                                               PLTSTA1011
c              equipment load                                                   PLTSTA1012
          IF (<pe;GPM> .NE. 0.) THEN                                            PLTSTA1013
            <tw;QMO> = <tw;QMO> + <pe;LOAD>                                     PLTSTA1014
            IF (<pe;LOAD> .GT. <tw;QMOM>)  THEN                                 PLTSTA1015
              <tw;QMOM>   = <pe;LOAD>                                           PLTSTA1016
              <tw;QMOMDY> = IDAY                                                PLTSTA1017
              <tw;QMOMHR> = ISCHR                                               PLTSTA1018
            ENDIF                                                               PLTSTA1019
            II = INDXPL(<pe;GPM>,<pe;OPER_CAPACITY>)                            PLTSTA1020
            <tw;QPLRMO> = <tw;QPLRMO> + 1                                       PLTSTA1021
            II = 12                                                             PLTSTA1022
            <tw;QPLRMO> = <tw;QPLRMO> + 1                                       PLTSTA1023
c              maximum tower temperature                                        PLTSTA1024
            IF (<pe;SUPPLY_T> .GT. <tw;MAX_T>)  THEN                            PLTSTA1025
              <tw;MAX_T>   = <pe;SUPPLY_T>                                      PLTSTA1026
              <tw;MAX_MO>  = IMO                                                PLTSTA1027
              <tw;MAX_DAY> = IDAY                                               PLTSTA1028
              <tw;MAX_HR>  = IHR                                                PLTSTA1029
            ENDIF                                                               PLTSTA1030
          ENDIF                                                                 PLTSTA1031
c              elec consumption                                                 PLTSTA1032
          IF (<tw;KW> .NE. 0.)  THEN                                            PLTSTA1033
            <tw;KWHMO> = <tw;KWHMO> + <tw;KW>                                   PLTSTA1034
            IF (<tw;KW> .GT. <tw;KWHMOM>)  THEN                                 PLTSTA1035
              <tw;KWHMOM>   = <tw;KW>                                           PLTSTA1036
              <tw;KWHMOMDY> = IDAY                                              PLTSTA1037
              <tw;KWHMOMHR> = ISCHR                                             PLTSTA1038
            ENDIF                                                               PLTSTA1039
            II = INDXPL(<tw;KW>,<tw;DES_KW>)                                    PLTSTA1040
            <tw;KWHPLRMO> = <tw;KWHPLRMO> + 1                                   PLTSTA1041
            II = 12                                                             PLTSTA1042
            <tw;KWHPLRMO> = <tw;KWHPLRMO> + 1                                   PLTSTA1043
          ENDIF                                                                 PLTSTA1044
c              aux elec consumption                                             PLTSTA1045
          <tw;AUXMO> = <tw;AUXMO> + <tw;AUX>                                    PLTSTA1046
          IF (<tw;AUX> .GT. <tw;AUXMOM>)  THEN                                  PLTSTA1047
            <tw;AUXMOM>   = <tw;AUX>                                            PLTSTA1048
            <tw;AUXMOMDY> = IDAY                                                PLTSTA1049
            <tw;AUXMOMHR> = ISCHR                                               PLTSTA1050
          ENDIF                                                                 PLTSTA1051
c              aux heat consumption                                             PLTSTA1052
          <tw;AUXHEATMO> = <tw;AUXHEATMO> + <tw;AUX_HEAT>                       PLTSTA1053
          IF (<tw;AUX_HEAT> .LT. <tw;AUXHEATMOM>)  THEN                         PLTSTA1054
            <tw;AUXHEATMOM>   = <tw;AUX_HEAT>                                   PLTSTA1055
            <tw;AUXHEATMOMDY> = IDAY                                            PLTSTA1056
            <tw;AUXHEATMOMHR> = ISCHR                                           PLTSTA1057
          ENDIF                                                                 PLTSTA1058
                                                                                -044e5 125
c              Ground-loop heat-exchangers (cooling)                            -044e5 126
          CASE (491:494)                                                        -044e5 127
            Jgl = <pe;Jparent>                                                  -044e5 128
c              monthly statistics                                               -044e5 129
c              equipment load                                                   -044e5 130
            IF (<pe;GPM> .eq. 0.) Cycle                                         -044e5 131
            <gl.Cool_Mo> = <gl.Cool_Mo> + <pe;LOAD>                             -044e5 132
            IF (<pe;LOAD> .gt. <gl.Cool_MoM>) THEN                              -044e5 133
              <gl.Cool_MoM>  = <pe;LOAD>                                        -044e5 134
              <gl.Cool_MoDy> = IDAY                                             -044e5 135
              <gl.Cool_MoHr> = ISCHR                                            -044e5 136
            ENDIF                                                               -044e5 137
c              temperature bins                                                 -044e5 138
            II = Max(1, Min(12, Int(<pe;SUPPLY_T>/10.)))                        -044e5 139
            <gl.CoolT_Mo> = <gl.CoolT_Mo> + 1                                   -044e5 140
            II = 13                                                             -044e5 141
            <gl.CoolT_Mo> = <gl.CoolT_Mo> + 1                                   -044e5 142
c              max/min temperatures                                             -044e5 143
            <gl.CoolTmax_Mo> = Max(<gl.CoolTmax_Mo>, <pe;SUPPLY_T>)             -044e5 144
            <gl.CoolTmin_Mo> = Min(<gl.CoolTmin_Mo>, <pe;SUPPLY_T>)             -044e5 145
                                                                                -044e5 146
          END SELECT  ! pe:ALGORITHM                                            -044e5 147
  110   CONTINUE                                                                PLTSTA1062
c              steam meter                                                      PLTSTA1063
        IF (<lp;STEAM_METER> .GT. 0)  THEN                                      PLTSTA1064
          Jsm = <lp;STEAM_METER>                                                PLTSTA1065
          Jme = Jsm                                                             PLTSTA1066
          IF (<me;LOAD> .GT. 0.)  THEN                                          PLTSTA1067
c              apportion the meter energy amoung the ultimate end-uses          PLTSTA1068
            Qmeter     = <me;LOAD>                                              PLTSTA1069
            <sm;HEAT>  = <sm;HEAT>  + Qmeter * PctHeat                          PLTSTA1070
            <sm;COOL>  = <sm;COOL>  + Qmeter * PctCool                          PLTSTA1071
            <sm;EQUIP> = <sm;EQUIP> + Qmeter * PctEquip                         PLTSTA1072
            <sm;AUX>   = <sm;AUX>   + Qmeter * PctAux                           PLTSTA1073
            <sm;DHW>   = <sm;DHW>   + Qmeter * PctDHW                           PLTSTA1074
          ENDIF                                                                 PLTSTA1075
c              portion that goes into storage                                   PLTSTA1076
          IF (PctStore .GT. 0.)  THEN                                           PLTSTA1077
            <tk;STEAM_Q> = <tk;STEAM_Q> + Qmeter * PctStore                     PLTSTA1078
c              put storage portion into total, even though not allocated        PLTSTA1079
c              to end-use until used.                                           PLTSTA1080
            <sm;TES_ADJUST> = <sm;TES_ADJUST> + Qmeter*PctStore                 PLTSTA1081
          ENDIF                                                                 PLTSTA1082
        ENDIF                                                                   PLTSTA1083
c              CHW meter                                                        PLTSTA1084
        IF (<lp;CHW_METER> .GT. 0)  THEN                                        PLTSTA1085
          Jcm = <lp;CHW_METER>                                                  PLTSTA1086
          Jme = Jcm                                                             PLTSTA1087
          IF (<me;LOAD> .GT. 0.)  THEN                                          PLTSTA1088
c              apportion the meter energy amoung the ultimate end-uses          PLTSTA1089
            Qmeter     = <me;LOAD>                                              PLTSTA1090
            <cm;COOL>  = <cm;COOL>  + Qmeter * PctCool                          PLTSTA1091
            <cm;EQUIP> = <cm;EQUIP> + Qmeter * PctEquip                         PLTSTA1092
          ENDIF                                                                 PLTSTA1093
c              portion that goes into storage                                   PLTSTA1094
          IF (PctStore .GT. 0.)  THEN                                           PLTSTA1095
            <tk;CHW_Q> = <tk;CHW_Q> + Qmeter * PctStore                         PLTSTA1096
c              put storage portion into total, even though not allocated        PLTSTA1097
c              to end-use until used.                                           PLTSTA1098
            <cm;TES_ADJUST> = <cm;TES_ADJUST> + Qmeter*PctStore                 PLTSTA1099
          ENDIF                                                                 PLTSTA1100
        ENDIF                                                                   PLTSTA1101
c             end of hourly circulation loop data                               PLTSTA1102
  200 CONTINUE                                                                  PLTSTA1103
c                                                                               PLTSTA1104
c              circulation pumps                                                PLTSTA1105
      DO  Neq=1,Npm                                                             PLTSTA1106
        Jpm = Ipm + (Neq-1)*Lpm                                                 PLTSTA1107
        IF (<pm;KW> .GT. 0.)  THEN                                              PLTSTA1108
c              monthly statistics                                               PLTSTA1109
c              energy end-uses and meters                                       PLTSTA1110
          Jem = <pm:ELEC-METER>                                                 PLTSTA1111
          <em;AUX> = <em;AUX> + <pm;KW>                                         PLTSTA1112
c              pump heat                                                        PLTSTA1113
          <pm;QHMO> = <pm;QHMO> + <pm;HEAT>                                     PLTSTA1114
          IF (<pm;HEAT> .GT. <pm;QHMOM>)  THEN                                  PLTSTA1115
            <pm;QHMOM>   = <pm;HEAT>                                            PLTSTA1116
            <pm;QHMOMDY> = IDAY                                                 PLTSTA1117
            <pm;QHMOMHR> = ISCHR                                                PLTSTA1118
          ENDIF                                                                 PLTSTA1119
c              power consumption                                                PLTSTA1120
          <pm;KWHMO> = <pm;KWHMO> + <pm;KW>                                     PLTSTA1121
          IF (<pm;KW> .GT. <pm;KWHMOM>)  THEN                                   PLTSTA1122
            <pm;KWHMOM>  = <pm;KW>                                              PLTSTA1123
            <pm;KWHMOMDY> = IDAY                                                PLTSTA1124
            <pm;KWHMOMHR> = ISCHR                                               PLTSTA1125
          ENDIF                                                                 PLTSTA1126
c              part load bins for flow, speed, and kW - note that flow          PLTSTA1127
c              and kW are relative to sum of all pumps                          PLTSTA1128
          II = INDXPL(<pm;GPM>,<pm;TOTAL_GPM>)                                  PLTSTA1129
          <pm;GPMPLRMO> = <pm;GPMPLRMO> + 1                                     PLTSTA1130
          II = 12                                                               PLTSTA1131
          <pm;GPMPLRMO> = <pm;GPMPLRMO> + 1                                     PLTSTA1132
          II = INDXPL(<pm;RPMR>,1.)                                             PLTSTA1133
          <pm;RPMPLRMO> = <pm;RPMPLRMO> + 1                                     PLTSTA1134
          II = 12                                                               PLTSTA1135
          <pm;RPMPLRMO> = <pm;RPMPLRMO> + 1                                     PLTSTA1136
          II = INDXPL(<pm;KW>,<pm;TOTAL_KW>)                                    PLTSTA1137
          <pm;KWHPLRMO> = <pm;KWHPLRMO> + 1                                     PLTSTA1138
          II = 12                                                               PLTSTA1139
          <pm;KWHPLRMO> = <pm;KWHPLRMO> + 1                                     PLTSTA1140
        ENDIF                                                                   PLTSTA1141
      ENDDO                                                                     PLTSTA1142
c                                                                               PLTSTA1143
c              generators - just do auxiliary elec now, do fuel end-uses        PLTSTA1144
c              after the elec meters, and before fuel meters                    PLTSTA1145
      DO  Neq=1,Ngn                                                             PLTSTA1146
        Jgn = Ign + (Neq-1)*Lgn                                                 PLTSTA1147
        Jpe = <gn;Jpe>                                                          PLTSTA1148
c              auxiliary electrical                                             PLTSTA1149
        IF (<gn:AUX-METER> .GT. 0)  THEN                                        PLTSTA1150
          Jem        = <gn:AUX-METER>                                           PLTSTA1151
          <em;AUX>   = <em;AUX> + <pe;AUX_KW>                                   PLTSTA1152
        ENDIF                                                                   PLTSTA1153
      ENDDO                                                                     PLTSTA1154
c                                                                               PLTSTA1155
c              Sum end-uses into monthly values and totals                      PLTSTA1156
c              Electric meters, except surplus sale                             PLTSTA1157
      DO  IE = 1,19                                                             PLTSTA1158
        EndUseTotal(IE) = 0.                                                    PLTSTA1159
      ENDDO                                                                     PLTSTA1160
c              do submeters first, then building level, finally utility         PLTSTA1161
      DO  MeterType=3,1,-1                                                      PLTSTA1162
        IF (NumElecMeterTypes(MeterType) .GT. 0)  THEN                          PLTSTA1163
          DO  IM=1,Nem                                                          PLTSTA1164
            Jem = Iem + (IM-1)*Lem                                              PLTSTA1165
            IF (<em:TYPE> .EQ. MeterType)  THEN                                 PLTSTA1166
c              save parent/child pointers                                       PLTSTA1167
              Jchild  = Jem                                                     PLTSTA1168
              Jparent = <em;PARENT>                                             PLTSTA1169
c               get the total for this meter (total may be nonzero              PLTSTA1170
c               because of TES adjustments)                                     PLTSTA1171
              Total = <em;TOTAL>                                                PLTSTA1172
              DO  IE=1,19                                                       PLTSTA1173
                Total = Total + <em;METERS>                                     PLTSTA1174
              ENDDO                                                             PLTSTA1175
c               include transformer losses in aux category and total            PLTSTA1176
              TransformerLoss  = Transformer_Loss(Total)                        PLTSTA1177
              Total            = Total       + TransformerLoss                  PLTSTA1178
              <em;AUX>         = <em;AUX>    + TransformerLoss                  PLTSTA1179
              <em;LOSSMO>      = <em;LOSSMO> + TransformerLoss                  PLTSTA1180
c              separate accounting for hourly reports only                      PLTSTA1181
              <em;TRANSFORMER> = TransformerLoss                                PLTSTA1182
c                                                                               PLTSTA1183
c              now statistics for each end-use category                         PLTSTA1184
              DO  IE=1,19                                                       PLTSTA1185
                EndUseEngy    = <em;METERS>                                     PLTSTA1186
                <em;METERSMO> = <em;METERSMO> + EndUseEngy                      PLTSTA1187
                IF (EndUseEngy .GT. <em;METERSMOM>)  THEN                       PLTSTA1188
                  <em;METERSMOM>   = EndUseEngy                                 PLTSTA1189
                  <em;METERSMOMDY> = IDAY                                       PLTSTA1190
                  <em;METERSMOMHR> = ISCHR                                      PLTSTA1191
                ENDIF                                                           PLTSTA1192
                IF (MeterType .EQ. UtilityMeter)  THEN                          PLTSTA1193
c                   sum of all elec utility meters for the hour by              PLTSTA1194
c                   enduse                                                      PLTSTA1195
                  EndUseTotal(IE) = EndUseTotal(IE) + EndUseEngy                PLTSTA1196
                ELSE                                                            PLTSTA1197
c                 transfer sub-meter energy to parent meter                     PLTSTA1198
                  Jem = Jparent                                                 PLTSTA1199
                  <em;METERS> = <em;METERS> + EndUseEngy                        PLTSTA1200
                  Jem = Jchild                                                  PLTSTA1201
                ENDIF                                                           PLTSTA1202
              ENDDO                                                             PLTSTA1203
              <em;TOTAL>   = Total                                              PLTSTA1204
              <em;TOTALMO> = <em;TOTALMO> + Total                               PLTSTA1205
              IF (Total .GT. <em;TOTALMOM>)  THEN                               PLTSTA1206
                <em;TOTALMOM>   = Total                                         PLTSTA1207
                <em;TOTALMOMDY> = IDAY                                          PLTSTA1208
                <em;TOTALMOMHR> = ISCHR                                         PLTSTA1209
                DO  IE=1,19                                                     HVAC29 371
                  <em;EndUsePeakMo> = <em;METERS>                               HVAC29 372
                ENDDO                                                           HVAC29 373
              ENDIF                                                             PLTSTA1210
              IF (ITDV .gt. 0)  ! time-dependent valuation                      -044   227
     &          Call TDV(11, <em;Ktv>, <em;LIGHT>, 1., <em.TDVsrc>)             -044   228
c                                                                               PLTSTA1211
c              Cogeneration                                                     PLTSTA1212
              IF (<em;NumCogen> .GT. 0)  THEN                                   PLTSTA1213
c                 include amount of unallocated cogeneration carried            PLTSTA1214
c                 over from previous hour                                       PLTSTA1215
                Total = Total + <em;CogenCarry>                                 PLTSTA1216
c                 Baseload power assigned to meter in EquipCtrl                 PLTSTA1217
                Jme    = Jem                                                    PLTSTA1218
                BaseKW = <me;LOAD>                                              PLTSTA1219
c                 get total cogeneration output to this meter                   PLTSTA1220
                CogenKW = 0.                                                    PLTSTA1221
                Neq     = <em;NumCogen>                                         PLTSTA1222
                DO  IQ=1,Neq                                                    PLTSTA1223
                  Jpe     = <em;CogenJpePtrs>                                   PLTSTA1224
                  CogenKW = CogenKW + <pe;LOAD>                                 PLTSTA1225
                ENDDO                                                           PLTSTA1226
                IF (CogenKW .GT. 0.)  THEN                                      PLTSTA1227
c                   Figure out what to do with cogeneration output              PLTSTA1228
                  IF (Total .GT. CogenKW+BaseKW                                 PLTSTA1229
     &                      .AND.  <em;CogenElecCap> .GT. CogenKW)  THEN        PLTSTA1230
c                     When the total meter consumption is greater than          PLTSTA1231
c                     the cogeneration output, and the enabled                  PLTSTA1232
c                     cogeneration capacity is greater than the                 PLTSTA1233
c                     cogeneration output, then the meter load was not          PLTSTA1234
c                     as fully allocated as it could have been.  Carry          PLTSTA1235
c                     the remainder of the meter load, up to the                PLTSTA1236
c                     cogeneration capacity, to the next hour, rather           PLTSTA1237
c                     than passing it on to the utility.                        PLTSTA1238
                    <em;CogenCarry> = MIN(Total-(CogenKW+BaseKW),               PLTSTA1239
     &                                    <em;CogenElecCap>-CogenKW)            PLTSTA1240
                    Total = Total - <em;CogenCarry>                             PLTSTA1241
                  ELSE                                                          PLTSTA1242
                    <em;CogenCarry> = 0.                                        PLTSTA1243
                  ENDIF                                                         PLTSTA1244
                  IF (CogenKW .GT. Total)  THEN                                 PLTSTA1245
c                     Amount of cogeneration sold - prorate to each             PLTSTA1246
C                     generator                                                 PLTSTA1247
                    SurplusKW = CogenKW - Total                                 PLTSTA1248
                    Prorate   = SurplusKW / CogenKW                             PLTSTA1249
                    DO  IQ=1,Neq                                                PLTSTA1250
                      Jpe     = <em;CogenJpePtrs>                               PLTSTA1251
                      Jgn     = <pe;Jparent>                                    PLTSTA1252
                      <gn;SurplusKW> = <pe;LOAD> * Prorate                      PLTSTA1253
                    ENDDO                                                       PLTSTA1254
                  ENDIF                                                         PLTSTA1255
                ENDIF                                                           PLTSTA1256
c                  net meter demand after cogeneration - used in PS-A,          PLTSTA1257
c                  PS-B and economics                                           PLTSTA1258
                <em;AdjustedTotal> = Total - CogenKW                            -042L3   1
                AdjustedKW         = MAX(0., <em;AdjustedTotal>)                -042L3   2
c                  prorate to each of the end-uses                              PLTSTA1261
                IF (Total .NE. 0.)  THEN                                        PLTSTA1262
                  Prorate = AdjustedKW / Total                                  PLTSTA1263
                  DO  IE=1,19                                                   PLTSTA1264
                    EndUseEngy    = <em;METERS> * Prorate                       PLTSTA1265
                    <em;NetUseMo> = <em;NetUseMo> + EndUseEngy                  PLTSTA1266
                    IF (EndUseEngy .GT. <em;NetUseMoM>)  THEN                   PLTSTA1267
                      <em;NetUseMoM>   = EndUseEngy                             PLTSTA1268
                      <em;NetUseMoMDy> = IDAY                                   PLTSTA1269
                      <em;NetUseMoMHr> = ISCHR                                  PLTSTA1270
                    ENDIF                                                       PLTSTA1271
                  ENDDO                                                         PLTSTA1272
                  <em;NetTotalMo> = <em;NetTotalMo> + <em;AdjustedTotal>        -042L3   3
                  IF (<em;AdjustedTotal> .GT. <em;NetTotalMoM>)  THEN           -042L3   4
                    <em;NetTotalMoM>   = <em;AdjustedTotal>                     -042L3   5
                    <em;NetTotalMoMDy> = IDAY                                   PLTSTA1276
                    <em;NetTotalMoMHr> = ISCHR                                  PLTSTA1277
                  ENDIF                                                         PLTSTA1278
c                     adjust 5-minute bins assuming same prorate factor         PLTSTA1279
                  DO  IP=1,13                                                   PLTSTA1280
                    <em;5-MIN_BINS> = <em;5-MIN_BINS> * Prorate                 PLTSTA1281
                  ENDDO                                                         PLTSTA1282
                ENDIF                                                           PLTSTA1283
                IF (ITDV .gt. 0)  ! time-dependent valuation                    -044   229
     &            Call TDV(12, <em;Ktv>,<em;LIGHT>,Prorate,<em.TDVsrc>)         -044   230
c                           ^ tabulate net usage                                -044   231
              ELSE                                                              PLTSTA1284
                <em;AdjustedTotal> = Total                                      PLTSTA1285
              ENDIF  ! Cogeneration adjustments                                 PLTSTA1286
c                                                                               PLTSTA1287
c              hourly-report variables                                          PLTSTA1288
              IF (<em;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                        PLTSTA1289
     &          CALL HourRepPLT(<em;LIGHT>, <em;HREP>, 23, 0)                   PLTSTA1290
            ENDIF  !for this meter matching TYPE                                PLTSTA1291
          ENDDO                                                                 PLTSTA1292
        ENDIF      ! for this elec-meter TYPE                                   PLTSTA1293
      ENDDO        ! for all elec-meter TYPEs                                   PLTSTA1294
c              summary report for all electric utility meters, except           PLTSTA1295
c              surplus sale                                                     PLTSTA1296
      Total = 0.                                                                PLTSTA1297
      DO  IE=1,19                                                               PLTSTA1298
        EndUseEngy  = EndUseTotal(IE)                                           PLTSTA1299
        Total       = Total + EndUseEngy                                        PLTSTA1300
        EndUses(IE,1,IELEC) = EndUses(IE,1,IELEC) + EndUseEngy                  PLTSTA1301
        IF (EndUseEngy .GT. EndUsePeaks(IE,1,IELEC))  THEN                      PLTSTA1302
          EndUsePeaks(IE,1,IELEC) = EndUseEngy                                  PLTSTA1303
          EndPeakDay(IE,1,IELEC)  = IDAY                                        PLTSTA1304
          EndPeakHour(IE,1,IELEC) = ISCHR                                       PLTSTA1305
        ENDIF                                                                   PLTSTA1306
      ENDDO                                                                     PLTSTA1307
      EndUses(20,1,IELEC) = EndUses(20,1,IELEC) + Total                         PLTSTA1308
      IF (Total .GT. EndUsePeaks(20,1,IELEC))  THEN                             PLTSTA1309
        EndUsePeaks(20,1,IELEC) = Total                                         PLTSTA1310
        EndPeakDay(20,1,IELEC)  = IDAY                                          PLTSTA1311
        EndPeakHour(20,1,IELEC) = ISCHR                                         PLTSTA1312
        DO  IE=1,19                                                             HVAC29 374
          EndUseAtPeak(IE,1,IELEC) = EndUseTotal(IE)                            HVAC29 375
        ENDDO                                                                   HVAC29 376
      ENDIF                                                                     PLTSTA1313
      IF (ITDV .gt. 0)  ! time-dependent valuation                              -044   232
     &  Call TDV(11, KtvTDV2(1), xx, xx, xx)                                    -044   233
c                                                                               PLTSTA1314
c              Electric meters for sale of cogeneration                         PLTSTA1315
      IF (NumElecMeterTypes(SellMeter) .GT. 0)  THEN                            PLTSTA1316
        DO  IM=1,Nem                                                            PLTSTA1317
          Jem = Iem + (IM-1)*Lem                                                PLTSTA1318
          IF (<em:TYPE> .NE. SellMeter)  CYCLE                                  PLTSTA1319
          Total = 0.                                                            PLTSTA1320
          IF (<em;NumCogen> .GT. 0)  THEN                                       PLTSTA1321
c              cogenerators dedicated to this meter                             PLTSTA1322
            Neq = <em;NumCogen>                                                 PLTSTA1323
            DO  IQ=1,Neq                                                        PLTSTA1324
              Jpe   = <em;CogenJpePtrs>                                         PLTSTA1325
              Total = Total + <pe;LOAD>                                         PLTSTA1326
            ENDDO                                                               PLTSTA1327
          ENDIF                                                                 PLTSTA1328
c              surplus power from cogenerators dedicated to                     PLTSTA1329
c              other meters                                                     PLTSTA1330
          DO  Neq=1,Ngn                                                         PLTSTA1331
            Jgn = Ign + (Neq-1)*Lgn                                             PLTSTA1332
            IF (<gn:SURPLUS-METER> .EQ. Jem)                                    PLTSTA1333
     &        Total = Total + <gn;SurplusKW>                                    PLTSTA1334
          ENDDO                                                                 PLTSTA1335
c              include transformer losses in aux category and total             PLTSTA1336
          TransformerLoss  = Transformer_Loss(Total)                            PLTSTA1337
          AdjustedKW       = Total       - TransformerLoss                      PLTSTA1338
          <em;AUX>         = <em;AUX>    + TransformerLoss                      PLTSTA1339
          <em;LOSSMO>      = <em;LOSSMO> + TransformerLoss                      PLTSTA1340
c              monthly statistics                                               PLTSTA1341
          <em;CogenSurplus> = AdjustedKW                                        PLTSTA1342
          <em;TOTAL>        = Total                                             PLTSTA1343
          <em;TOTALMO>      = <em;TOTALMO> + Total                              PLTSTA1344
          IF (Total .GT. <em;TOTALMOM>)  THEN                                   PLTSTA1345
            <em;TOTALMOM>   = Total                                             PLTSTA1346
            <em;TOTALMOMDY> = IDAY                                              PLTSTA1347
            <em;TOTALMOMHR> = ISCHR                                             PLTSTA1348
          ENDIF                                                                 PLTSTA1349
          <em;AdjustedTotal>   = AdjustedKW                                     PLTSTA1350
          <em;NetTotalMo>      = <em;NetTotalMo> + AdjustedKW                   PLTSTA1351
          IF (AdjustedKW .GT. <em;NetTotalMoM>)  THEN                           PLTSTA1352
            <em;NetTotalMoM>   = AdjustedKW                                     PLTSTA1353
            <em;NetTotalMoMDy> = IDAY                                           PLTSTA1354
            <em;NetTotalMoMHr> = ISCHR                                          PLTSTA1355
          ENDIF                                                                 PLTSTA1356
          IF (ITDV .gt. 0)  ! time-dependent valuation                          -044   234
     &      Call TDV(13, <em;Ktv>, Total, xx, <em.TDVsrc>)                      -044   235
c                     ^ cogen sale                                              -044   236
c              hourly-report variables                                          PLTSTA1357
          IF (<em;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                            PLTSTA1358
     &        CALL HourRepPLT(<em;LIGHT>, <em;HREP>, 23, 0)                     PLTSTA1359
        ENDDO                                                                   PLTSTA1360
      ENDIF  ! Cogeneration sale                                                PLTSTA1361
c                                                                               PLTSTA1362
c              generators - allocate fuel to fuel meter end-uses before         PLTSTA1363
c              fuel meter statistics                                            PLTSTA1364
      DO  Neq=1,Ngn                                                             PLTSTA1365
        Jgn = Ign + (Neq-1)*Lgn                                                 PLTSTA1366
        Jpe = <gn;Jpe>                                                          PLTSTA1367
        IF (<pe;LOAD> .GT. 0.)  THEN                                            PLTSTA1368
c              demand meter                                                     PLTSTA1369
          Jem = <gn:ELEC-METER>                                                 PLTSTA1370
          IF (<em:TYPE> .NE. SellMeter)  THEN                                   PLTSTA1371
c              power and fuel used for building end-uses                        PLTSTA1372
            BldgKW   = <pe;LOAD> - <gn;SurplusKW>                               PLTSTA1373
            BldgFuel = <pe;FUEL> * BldgKW/<pe;LOAD>                             PLTSTA1374
          ELSE                                                                  PLTSTA1375
            BldgKW   = 0.                                                       PLTSTA1376
            BldgFuel = 0.                                                       PLTSTA1377
          ENDIF                                                                 PLTSTA1378
          IF (<gn:FUEL-METER> .GT. 0)  THEN                                     PLTSTA1379
c              allocate building loads provided by cogeneration                 PLTSTA1380
c              to fuel end-uses                                                 PLTSTA1381
            Jfm = <gn:FUEL-METER>                                               PLTSTA1382
            Jem = <gn:ELEC-METER>                                               PLTSTA1383
            IF (<em;TOTAL> .GT. 0.)  THEN                                       PLTSTA1384
              Prorate = 1.0 / <em;TOTAL>                                        PLTSTA1385
              DO  IE=1,19                                                       PLTSTA1386
                <fm;METERS> = <fm;METERS> + BldgFuel*<em;METERS>*Prorate        PLTSTA1387
              ENDDO                                                             PLTSTA1388
            ENDIF                                                               PLTSTA1389
c              allocate fuel used for surplus cogeneration                      PLTSTA1390
            SurplusFuel = <pe;FUEL> - BldgFuel                                  PLTSTA1391
            <fm;CogenSurplus> = <fm;CogenSurplus> + SurplusFuel                 PLTSTA1392
          ENDIF                                                                 PLTSTA1393
        ENDIF                                                                   PLTSTA1394
        CALL PlantStatistics_Jpe(1)                                             PLTSTA1395
      ENDDO                                                                     PLTSTA1396
c                                                                               PV     171
c              Photovoltaic modules                                             PV     172
      DO Neq=1,Npv                                                              PV     173
        Jpv = Ipv + (Neq-1)*Lpv                                                 PV     174
        Jpe = <pv;Jpe>                                                          PV     175
        CALL PlantStatistics_Jpe(1)                                             PV     176
      ENDDO                                                                     PV     177
c                                                                               PLTSTA1397
c              fuel meters                                                      PLTSTA1398
      DO  IE = 1,19                                                             PLTSTA1399
        EndUseTotal(IE) = 0.                                                    PLTSTA1400
      ENDDO                                                                     PLTSTA1401
      DO  IM=1,Nfm                                                              PLTSTA1402
        Jfm = Ifm + (IM-1)*Lfm                                                  PLTSTA1403
        Total = <fm;TOTAL>                                                      PLTSTA1404
        DO  IE=1,19                                                             PLTSTA1405
          EndUseEngy  = <fm;METERS>                                             PLTSTA1406
          Total = Total + EndUseEngy                                            PLTSTA1407
          <fm;METERSMO> = <fm;METERSMO> + EndUseEngy                            PLTSTA1408
          IF (EndUseEngy .GT. <fm;METERSMOM>)  THEN                             PLTSTA1409
            <fm;METERSMOM>   = EndUseEngy                                       PLTSTA1410
            <fm;METERSMOMDY> = IDAY                                             PLTSTA1411
            <fm;METERSMOMHR> = ISCHR                                            PLTSTA1412
          ENDIF                                                                 PLTSTA1413
c              sum of all fuel meters for the hour by enduse                    PLTSTA1414
          EndUseTotal(IE) = EndUseTotal(IE) + EndUseEngy                        PLTSTA1415
        ENDDO                                                                   PLTSTA1416
        <fm;TOTAL>   = Total                                                    PLTSTA1417
        <fm;TOTALMO> = <fm;TOTALMO> + Total                                     PLTSTA1418
        IF (Total .GT. <fm;TOTALMOM>)  THEN                                     PLTSTA1419
          <fm;TOTALMOM>   = Total                                               PLTSTA1420
          <fm;TOTALMOMDY> = IDAY                                                PLTSTA1421
          <fm;TOTALMOMHR> = ISCHR                                               PLTSTA1422
          DO  IE=1,19                                                           HVAC29 377
            <fm;EndUsePeakMo> = <fm;METERS>                                     HVAC29 378
          ENDDO                                                                 HVAC29 379
        ENDIF                                                                   PLTSTA1423
        IF (ITDV .gt. 0)  ! time-dependent valuation                            -044   237
     &    Call TDV(11, <fm;Ktv>, <fm;LIGHT>, 1., <fm.TDVsrc>)                   -044   238
c              hourly-report variables                                          PLTSTA1424
        IF (<fm;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                              PLTSTA1425
     &    CALL HourRepPLT(<fm;LIGHT>, <fm;HREP>, 24, 0)                         PLTSTA1426
      ENDDO                                                                     PLTSTA1427
c              summary report for all fuel meters                               PLTSTA1428
      Total = 0.                                                                PLTSTA1429
      DO  IE=1,19                                                               PLTSTA1430
        EndUseEngy  = EndUseTotal(IE)                                           PLTSTA1431
        Total = Total + EndUseEngy                                              PLTSTA1432
        EndUses(IE,1,IFUEL) = EndUses(IE,1,IFUEL) + EndUseEngy                  PLTSTA1433
        IF (EndUseEngy .GT. EndUsePeaks(IE,1,IFUEL))  THEN                      PLTSTA1434
          EndUsePeaks(IE,1,IFUEL) = EndUseEngy                                  PLTSTA1435
          EndPeakDay(IE,1,IFUEL)  = IDAY                                        PLTSTA1436
          EndPeakHour(IE,1,IFUEL) = ISCHR                                       PLTSTA1437
        ENDIF                                                                   PLTSTA1438
      ENDDO                                                                     PLTSTA1439
      EndUses(20,1,IFUEL) = EndUses(20,1,IFUEL) + Total                         PLTSTA1440
      IF (Total .GT. EndUsePeaks(20,1,IFUEL))  THEN                             PLTSTA1441
        EndUsePeaks(20,1,IFUEL) = Total                                         PLTSTA1442
        EndPeakDay(20,1,IFUEL)  = IDAY                                          PLTSTA1443
        EndPeakHour(20,1,IFUEL) = ISCHR                                         PLTSTA1444
        DO  IE=1,19                                                             HVAC29 380
          EndUseAtPeak(IE,1,IFUEL) = EndUseTotal(IE)                            HVAC29 381
        ENDDO                                                                   HVAC29 382
      ENDIF                                                                     PLTSTA1445
      IF (ITDV .gt. 0)  ! time-dependent valuation                              -044   239
     &  Call TDV(11, KtvTDV2(2), xx, xx, xx)                                    -044   240
c                                                                               PLTSTA1446
c              steam meters                                                     PLTSTA1447
      DO  IE = 1,19                                                             PLTSTA1448
        EndUseTotal(IE) = 0.                                                    PLTSTA1449
      ENDDO                                                                     PLTSTA1450
      DO  IM=1,Nsm                                                              PLTSTA1451
        Jsm = Ism + (IM-1)*Lsm                                                  PLTSTA1452
        Total = <sm;TOTAL>                                                      PLTSTA1453
        DO  IE=1,19                                                             PLTSTA1454
          EndUseEngy  = <sm;METERS>                                             PLTSTA1455
          Total = Total + EndUseEngy                                            PLTSTA1456
          <sm;METERSMO> = <sm;METERSMO> + EndUseEngy                            PLTSTA1457
          IF (EndUseEngy .GT. <sm;METERSMOM>)  THEN                             PLTSTA1458
            <sm;METERSMOM>   = EndUseEngy                                       PLTSTA1459
            <sm;METERSMOMDY> = IDAY                                             PLTSTA1460
            <sm;METERSMOMHR> = ISCHR                                            PLTSTA1461
          ENDIF                                                                 PLTSTA1462
c              sum of all steam meters for the hour by enduse                   PLTSTA1463
          EndUseTotal(IE) = EndUseTotal(IE) + EndUseEngy                        PLTSTA1464
        ENDDO                                                                   PLTSTA1465
        <sm;TOTAL>   = Total                                                    PLTSTA1466
        <sm;TOTALMO> = <sm;TOTALMO> + Total                                     PLTSTA1467
        IF (Total .GT. <sm;TOTALMOM>)  THEN                                     PLTSTA1468
          <sm;TOTALMOM>   = Total                                               PLTSTA1469
          <sm;TOTALMOMDY> = IDAY                                                PLTSTA1470
          <sm;TOTALMOMHR> = ISCHR                                               PLTSTA1471
          DO  IE=1,19                                                           HVAC29 383
            <sm;EndUsePeakMo> = <sm;METERS>                                     HVAC29 384
          ENDDO                                                                 HVAC29 385
        ENDIF                                                                   PLTSTA1472
c              hourly-report variables                                          PLTSTA1473
        IF (<sm;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                              PLTSTA1474
     &    CALL HourRepPLT(<sm;LIGHT>, <sm;HREP>, 25, 0)                         PLTSTA1475
      ENDDO                                                                     PLTSTA1476
c              summary report for all steam meters                              PLTSTA1477
      Total = 0.                                                                PLTSTA1478
      DO  IE=1,19                                                               PLTSTA1479
        EndUseEngy  = EndUseTotal(IE)                                           PLTSTA1480
        Total = Total + EndUseEngy                                              PLTSTA1481
        EndUses(IE,1,ISTM) = EndUses(IE,1,ISTM) + EndUseEngy                    PLTSTA1482
        IF (EndUseEngy .GT. EndUsePeaks(IE,1,ISTM))  THEN                       PLTSTA1483
          EndUsePeaks(IE,1,ISTM) = EndUseEngy                                   PLTSTA1484
          EndPeakDay(IE,1,ISTM)  = IDAY                                         PLTSTA1485
          EndPeakHour(IE,1,ISTM) = ISCHR                                        PLTSTA1486
        ENDIF                                                                   PLTSTA1487
      ENDDO                                                                     PLTSTA1488
      EndUses(20,1,ISTM) = EndUses(20,1,ISTM) + Total                           PLTSTA1489
      IF (Total .GT. EndUsePeaks(20,1,ISTM))  THEN                              PLTSTA1490
        EndUsePeaks(20,1,ISTM) = Total                                          PLTSTA1491
        EndPeakDay(20,1,ISTM)  = IDAY                                           PLTSTA1492
        EndPeakHour(20,1,ISTM) = ISCHR                                          PLTSTA1493
        DO  IE=1,19                                                             HVAC29 386
          EndUseAtPeak(IE,1,ISTM) = EndUseTotal(IE)                             HVAC29 387
        ENDDO                                                                   HVAC29 388
      ENDIF                                                                     PLTSTA1494
c                                                                               PLTSTA1495
c              chilled-water meters                                             PLTSTA1496
      DO  IE = 1,19                                                             PLTSTA1497
        EndUseTotal(IE) = 0.                                                    PLTSTA1498
      ENDDO                                                                     PLTSTA1499
      DO  IM=1,Ncm                                                              PLTSTA1500
        Jcm = Icm + (IM-1)*Lcm                                                  PLTSTA1501
        Total = <cm;TOTAL>                                                      PLTSTA1502
        DO  IE=1,19                                                             PLTSTA1503
          EndUseEngy  = <cm;METERS>                                             PLTSTA1504
          Total       = Total + EndUseEngy                                      PLTSTA1505
          <cm;METERSMO> = <cm;METERSMO> + EndUseEngy                            PLTSTA1506
          IF (EndUseEngy .GT. <cm;METERSMOM>)  THEN                             PLTSTA1507
            <cm;METERSMOM>   = EndUseEngy                                       PLTSTA1508
            <cm;METERSMOMDY> = IDAY                                             PLTSTA1509
            <cm;METERSMOMHR> = ISCHR                                            PLTSTA1510
          ENDIF                                                                 PLTSTA1511
c              sum of all chw meters for the hour by enduse                     PLTSTA1512
          EndUseTotal(IE) = EndUseTotal(IE) + EndUseEngy                        PLTSTA1513
        ENDDO                                                                   PLTSTA1514
        <cm;TOTAL>   = Total                                                    PLTSTA1515
        <cm;TOTALMO> = <cm;TOTALMO> + Total                                     PLTSTA1516
        IF (Total .GT. <cm;TOTALMOM>)  THEN                                     PLTSTA1517
          <cm;TOTALMOM>   = Total                                               PLTSTA1518
          <cm;TOTALMOMDY> = IDAY                                                PLTSTA1519
          <cm;TOTALMOMHR> = ISCHR                                               PLTSTA1520
          DO  IE=1,19                                                           HVAC29 389
            <cm;EndUsePeakMo> = <cm;METERS>                                     HVAC29 390
          ENDDO                                                                 HVAC29 391
        ENDIF                                                                   PLTSTA1521
c              hourly-report variables                                          PLTSTA1522
        IF (<cm;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                              PLTSTA1523
     &    CALL HourRepPLT(<cm;LIGHT>, <cm;HREP>, 26, 0)                         PLTSTA1524
      ENDDO                                                                     PLTSTA1525
c              summary report for all chilled-water meters                      PLTSTA1526
      Total = 0.                                                                PLTSTA1527
      DO  IE=1,19                                                               PLTSTA1528
        EndUseEngy  = EndUseTotal(IE)                                           PLTSTA1529
        Total       = Total + EndUseEngy                                        PLTSTA1530
        EndUses(IE,1,ICHW) = EndUses(IE,1,ICHW) + EndUseEngy                    PLTSTA1531
        IF (EndUseEngy .GT. EndUsePeaks(IE,1,ICHW))  THEN                       PLTSTA1532
          EndUsePeaks(IE,1,ICHW) = EndUseEngy                                   PLTSTA1533
          EndPeakDay(IE,1,ICHW)  = IDAY                                         PLTSTA1534
          EndPeakHour(IE,1,ICHW) = ISCHR                                        PLTSTA1535
        ENDIF                                                                   PLTSTA1536
      ENDDO                                                                     PLTSTA1537
      EndUses(20,1,ICHW) = EndUses(20,1,ICHW) + Total                           PLTSTA1538
      IF (Total .GT. EndUsePeaks(20,1,ICHW))  THEN                              PLTSTA1539
        EndUsePeaks(20,1,ICHW) = Total                                          PLTSTA1540
        EndPeakDay(20,1,ICHW)  = IDAY                                           PLTSTA1541
        EndPeakHour(20,1,ICHW) = ISCHR                                          PLTSTA1542
        DO  IE=1,19                                                             HVAC29 392
          EndUseAtPeak(IE,1,ICHW) = EndUseTotal(IE)                             HVAC29 393
        ENDDO                                                                   HVAC29 394
      ENDIF                                                                     PLTSTA1543
c                                                                               PLTSTA1544
c              PS-A statistics that can't be done monthly                       PLTSTA1545
c              recovered energy                                                 PLTSTA1546
      QRecover = 0.                                                             PLTSTA1547
      DO  NL=1,Nlp                                                              PLTSTA1548
        Jlp = Ilp + (NL-1)*Llp                                                  PLTSTA1549
        QRecover = QRecover + <lp;CogenHtrec> + <lp;Q_HTREC>                    PLTSTA1550
      ENDDO                                                                     PLTSTA1551
      PSA(4,1) = PSA(4,1) + QRecover                                            PLTSTA1552
c              wasted recoverable - assumes only cogen in this category         PLTSTA1553
      PSA(5,1) = PSA(5,1) + QCogenWaste                                         PLTSTA1554
c                                                                               IcRink 896
c              Update history of weighting factor blocks                        IcRink 897
      CALL WeightHsty                                                           IcRink 898
c                                                                               IcRink 899
c              Check for Energy Recovery Ventilators and                        ERV    199
c              ice skating rinks                                                ERV    200
      DO  NS=1,NSYS                                                             IcRink 901
        NSP = IS + (NS-1)*NSS                                                   IcRink 902
        IF (<sy;ERVentilator> .GT. 0)                                           ERV    201
     &    CALL ERVentilator(42, <sy;ERVentilator>, xx,xx,xx,xx,xx,xx)           ERV    202
        IF (<sy;IceRink> .GT. 0)  THEN                                          IcRink 903
          ISZ = <ISZONES>                                                       IcRink 904
          NSZ = <NZONES>                                                        IcRink 905
          DO  NZ=1,NSZ                                                          IcRink 906
            ZP1 = ISZ + (NZ-1)*NZD                                              IcRink 907
            ZP2 = <ZP2>                                                         IcRink 908
            IF (<zn:ICE-RINK> .GT. 0)  CALL IceRink(42, <zn:ICE-RINK>)          IcRink 909
          ENDDO                                                                 IcRink 910
        ENDIF                                                                   IcRink 911
      ENDDO                                                                     IcRink 912
c                                                                               PLTSTA1555
c              End of hourly processing                                         PLTSTA1556
      RETURN                                                                    PLTSTA1557
c                                                                               PLTSTA1558
c                                                                               PLTSTA1559
c============= MONTHLY STATISTICS ============================================= PLTSTA1560
      CASE (29)                                                                 PLTSTA1561
c              Print monthly report records, compile yearly statistics,         PLTSTA1562
c              and zero monthly variables for use next month                    PLTSTA1563
c                                                                               PLTSTA1564
c              Finish monthly statistics for Jpe components                     PLTSTA1565
      CALL PlantStatistics_Jpe(2)                                               PLTSTA1566
c                                                                               PLTSTA1567
c              Statistics for PS-A                                              PLTSTA1568
c              total electrical                                                 PLTSTA1569
      PSA(3,1) = PSA(3,1) + EndUses(20,1,IELEC)                                 PLTSTA1570
c              fuel used for cooling                                            PLTSTA1571
      PSA(6,1) = PSA(6,1) + EndUses(5,1,IFUEL)                                  PLTSTA1572
c              electric used for cooling, including heat rejection              PLTSTA1573
      PSA(7,1) = PSA(7,1) + EndUses(5,1,IELEC) + EndUses(6,1,IELEC)             PLTSTA1574
c              fuel used for heating                                            PLTSTA1575
      PSA(8,1) = PSA(8,1) + EndUses(4,1,IFUEL) + EndUses(10,1,IFUEL)            PLTSTA1576
     &                    + EndUses(11,1,IFUEL)                                 PLTSTA1577
c              electric used for heating                                        PLTSTA1578
      PSA(9,1) = PSA(9,1) + EndUses(4,1,IELEC) + EndUses(10,1,IELEC)            PLTSTA1579
     &                    + EndUses(11,1,IELEC)                                 PLTSTA1580
c              fuel used for electric generation                                PLTSTA1581
      IC = 2                                                                    PLTSTA1582
      DO  Neq=1,Ngn                                                             PLTSTA1583
        Jgn = Ign + (Neq-1)*Lgn                                                 PLTSTA1584
        IF (<gn:FUEL-METER> .GT. 0)  THEN                                       PLTSTA1585
          Jpe = <gn;Jpe>                                                        PLTSTA1586
          PSA(10,1) = PSA(10,1) + <pe;MONTH>                                    PLTSTA1587
        ENDIF                                                                   PLTSTA1588
      ENDDO                                                                     PLTSTA1589
c              total fuel                                                       PLTSTA1590
      PSA(11,1) = PSA(11,1) + EndUses(20,1,IFUEL)                               PLTSTA1591
c              electric site and source energy                                  PLTSTA1592
      SiteKW   = 0.                                                             PLTSTA1593
      SourceKW = 0.                                                             PLTSTA1594
      DO  IM=1,Nem                                                              PLTSTA1595
        Jem = Iem + (IM-1)*Lem                                                  PLTSTA1596
        SELECT CASE (<em:TYPE>)                                                 PLTSTA1597
          CASE (1)  ! UtilityMeter                                              PLTSTA1598
            IF (<em;NumCogen> .EQ. 0)  THEN                                     PLTSTA1599
c              net end-use is same as total if no cogen                         PLTSTA1600
              DO  IE=1,20                                                       PLTSTA1601
                <em;NetUseMo>    = <em;METERSMO>                                PLTSTA1602
                <em;NetUseMoM>   = <em;METERSMOM>                               PLTSTA1603
                <em;NetUseMoMDy> = <em;METERSMOMDY>                             PLTSTA1604
                <em;NetUseMoMHr> = <em;METERSMOMHR>                             PLTSTA1605
              ENDDO                                                             PLTSTA1606
              IF (ITDV .gt. 0)  Call TDV(14, <em;Ktv>, xx,xx,xx)                -044   241
c                                         ^ transfer net                        -044   242
            ENDIF                                                               PLTSTA1607
            SiteKW   = SiteKW   + <em;NetTotalMo>*BTUKW                         PLTSTA1608
            SourceKW = SourceKW + <em;NetTotalMo>*BTUKW/<em:SOURCE-EFF>         PLTSTA1609
          CASE (2,3)  !  Building/Submeter                                      PLTSTA1610
c              net end-use is same as total if no cogen                         PLTSTA1611
            DO  IE=1,20                                                         PLTSTA1612
              <em;NetUseMo>    = <em;METERSMO>                                  PLTSTA1613
              <em;NetUseMoM>   = <em;METERSMOM>                                 PLTSTA1614
              <em;NetUseMoMDy> = <em;METERSMOMDY>                               PLTSTA1615
              <em;NetUseMoMHr> = <em;METERSMOMHR>                               PLTSTA1616
            ENDDO                                                               PLTSTA1617
            IF (ITDV .gt. 0)  Call TDV(14, <em;Ktv>, xx,xx,xx)                  -044   243
c                                       ^ transfer net                          -044   244
          CASE (4)  ! SellMeter                                                 PLTSTA1618
            SiteKW   = SiteKW   - <em;NetTotalMo>*BTUKW                         PLTSTA1619
            SourceKW = SourceKW - <em;NetTotalMo>*BTUKW/<em:SOURCE-EFF>         PLTSTA1620
        END SELECT                                                              PLTSTA1621
      ENDDO                                                                     PLTSTA1622
c              total site energy - all meters                                   PLTSTA1623
      PSA(12,1) = PSA(12,1) + SiteKW                                            PLTSTA1624
     &                      + EndUses(20,1,IFUEL)                               PLTSTA1625
     &                      + EndUses(20,1,ISTM)                                PLTSTA1626
     &                      + EndUses(20,1,ICHW)                                PLTSTA1627
c              total source energy - all meters                                 PLTSTA1628
      PSA(13,1) = SourceKW                                                      PLTSTA1629
      DO  IM=1,Nfm                                                              PLTSTA1630
        Jfm = Ifm + (IM-1)*Lfm                                                  PLTSTA1631
        PSA(13,1) = PSA(13,1) + <fm;TOTALMO>/<fm:SOURCE-EFF>                    PLTSTA1632
      ENDDO                                                                     PLTSTA1633
      DO  IM=1,Nsm                                                              PLTSTA1634
        Jsm = Ism + (IM-1)*Lsm                                                  PLTSTA1635
        PSA(13,1) = PSA(13,1) + <sm;TOTALMO>/<sm:SOURCE-EFF>                    PLTSTA1636
      ENDDO                                                                     PLTSTA1637
      DO  IM=1,Ncm                                                              PLTSTA1638
        Jcm = Icm + (IM-1)*Lcm                                                  PLTSTA1639
        PSA(13,1) = PSA(13,1) + <cm;TOTALMO>/<cm:SOURCE-EFF>                    PLTSTA1640
      ENDDO                                                                     PLTSTA1641
c                                                                               PLTSTA1642
c              Print monthly records                                            PLTSTA1643
      CALL PlantReports                                                         PLTSTA1644
c                                                                               PLTSTA1645
c              Next, compile yearly statistics                                  PLTSTA1646
c              circulation loops                                                PLTSTA1647
      DO  NL=1,Nlp                                                              PLTSTA1648
        Jlp = Ilp + (NL-1)*Llp                                                  PLTSTA1649
        LoopType = <lp:TYPE>                                                    -047k   69
        IF (LoopType .EQ. Deleted)  CYCLE                                       -047k   70
c              heating mode                                                     PLTSTA1651
        <lp;COILHYR> = <lp;COILHYR> + <lp;COILHMO>                              PLTSTA1652
        IF (<lp;COILHMOM> .LT. <lp;COILHYRM>)  THEN                             PLTSTA1653
          <lp;COILHYRM>   = <lp;COILHMOM>                                       PLTSTA1654
          <lp;COILHYRMMO> = IMO                                                 PLTSTA1655
          <lp;COILHYRMDY> = <lp;COILHMOMDY>                                     PLTSTA1656
        ENDIF                                                                   PLTSTA1657
c              losses during heating                                            PLTSTA1658
        <lp;LOSSHYR> = <lp;LOSSHYR> + <lp;LOSSHMO>                              PLTSTA1659
        IF (<lp;LOSSHMOM> .LT. <lp;LOSSHYRM>)  THEN                             PLTSTA1660
          <lp;LOSSHYRM>   = <lp;LOSSHMOM>                                       PLTSTA1661
          <lp;LOSSHYRMMO> = IMO                                                 PLTSTA1662
          <lp;LOSSHYRMDY> = <lp;LOSSHMOMDY>                                     PLTSTA1663
        ENDIF                                                                   PLTSTA1664
c              net load                                                         PLTSTA1665
        <lp;TOTALHYR> = <lp;TOTALHYR> + <lp;TOTALHMO>                           PLTSTA1666
        IF (<lp;TOTALHMOM> .LT. <lp;TOTALHYRM>)  THEN                           PLTSTA1667
          <lp;TOTALHYRM>   = <lp;TOTALHMOM>                                     PLTSTA1668
          <lp;TOTALHYRMMO> = IMO                                                PLTSTA1669
          <lp;TOTALHYRMDY> = <lp;TOTALHMOMDY>                                   PLTSTA1670
          <lp;PeakTHYr>    = <lp;PeakTHMo>                                      -041h   43
          <lp;PeakDBTHYr>  = <lp;PeakDBTHMo>                                    -041h   44
          <lp;PeakWBTHYr>  = <lp;PeakWBTHMo>                                    -041h   45
        ENDIF                                                                   PLTSTA1671
c              overload                                                         PLTSTA1672
        <lp;OVRLDHYR> = <lp;OVRLDHYR> + <lp;OVRLDHMO>                           PLTSTA1673
        IF (<lp;OVRLDHMOM> .LT. <lp;OVRLDHYRM>)  THEN                           PLTSTA1674
          <lp;OVRLDHYRM>   = <lp;OVRLDHMOM>                                     PLTSTA1675
          <lp;OVRLDHYRMMO> = IMO                                                PLTSTA1676
          <lp;OVRLDHYRMDY> = <lp;OVRLDHMOMDY>                                   PLTSTA1677
        ENDIF                                                                   PLTSTA1678
c              part load bins for heating and flow                              PLTSTA1679
        DO  II=1,12                                                             PLTSTA1680
          <lp;QHPLRYR>   = <lp;QHPLRYR>   + <lp;QHPLRMO>                        PLTSTA1681
          <lp;GPMHPLRYR> = <lp;GPMHPLRYR> + <lp;GPMHPLRMO>                      PLTSTA1682
        ENDDO                                                                   PLTSTA1683
c              loops in cooling mode                                            PLTSTA1684
        <lp;COILCYR> = <lp;COILCYR> + <lp;COILCMO>                              PLTSTA1685
        IF (<lp;COILCMOM> .GT. <lp;COILCYRM>)  THEN                             PLTSTA1686
          <lp;COILCYRM>   = <lp;COILCMOM>                                       PLTSTA1687
          <lp;COILCYRMMO> = IMO                                                 PLTSTA1688
          <lp;COILCYRMDY> = <lp;COILCMOMDY>                                     PLTSTA1689
        ENDIF                                                                   PLTSTA1690
c              losses during cooling                                            PLTSTA1691
        <lp;LOSSCYR> = <lp;LOSSCYR> + <lp;LOSSCMO>                              PLTSTA1692
        IF (<lp;LOSSCMOM> .GT. <lp;LOSSCYRM>)  THEN                             PLTSTA1693
          <lp;LOSSCYRM>   = <lp;LOSSCMOM>                                       PLTSTA1694
          <lp;LOSSCYRMMO> = IMO                                                 PLTSTA1695
          <lp;LOSSCYRMDY> = <lp;LOSSCMOMDY>                                     PLTSTA1696
        ENDIF                                                                   PLTSTA1697
c              net load                                                         PLTSTA1698
        <lp;TOTALCYR> = <lp;TOTALCYR> + <lp;TOTALCMO>                           PLTSTA1699
        IF (<lp;TOTALCMOM> .GT. <lp;TOTALCYRM>)  THEN                           PLTSTA1700
          <lp;TOTALCYRM>   = <lp;TOTALCMOM>                                     PLTSTA1701
          <lp;TOTALCYRMMO> = IMO                                                PLTSTA1702
          <lp;TOTALCYRMDY> = <lp;TOTALCMOMDY>                                   PLTSTA1703
          <lp;PeakTCYr>    = <lp;PeakTCMo>                                      -041h   46
          <lp;PeakDBTCYr>  = <lp;PeakDBTCMo>                                    -041h   47
          <lp;PeakWBTCYr>  = <lp;PeakWBTCMo>                                    -041h   48
        ENDIF                                                                   PLTSTA1704
c              overload                                                         PLTSTA1705
        <lp;OVRLDCYR> = <lp;OVRLDCYR> + <lp;OVRLDCMO>                           PLTSTA1706
        IF (<lp;OVRLDCMOM> .GT. <lp;OVRLDCYRM>)  THEN                           PLTSTA1707
          <lp;OVRLDCYRM>   = <lp;OVRLDCMOM>                                     PLTSTA1708
          <lp;OVRLDCYRMMO> = IMO                                                PLTSTA1709
          <lp;OVRLDCYRMDY> = <lp;OVRLDCMOMDY>                                   PLTSTA1710
        ENDIF                                                                   PLTSTA1711
c              part load bins for cooling and flow                              PLTSTA1712
        DO  II=1,12                                                             PLTSTA1713
          <lp;QCPLRYR>   = <lp;QCPLRYR>   + <lp;QCPLRMO>                        PLTSTA1714
          <lp;GPMCPLRYR> = <lp;GPMCPLRYR> + <lp;GPMCPLRMO>                      PLTSTA1715
        ENDDO                                                                   PLTSTA1716
        IF (LoopType .EQ. WLHP)  THEN                                           PLTSTA1717
c              cooling demands during heating                                   PLTSTA1718
          <lp;COILHCYR> = <lp;COILHCYR> + <lp;COILHCMO>                         PLTSTA1719
          IF (<lp;COILHCMOM> .GT. <lp;COILHCYRM>)  THEN                         PLTSTA1720
            <lp;COILHCYRM>   = <lp;COILHCMOM>                                   PLTSTA1721
            <lp;COILHCYRMMO> = IMO                                              PLTSTA1722
            <lp;COILHCYRMDY> = <lp;COILHCMOMDY>                                 PLTSTA1723
          ENDIF                                                                 PLTSTA1724
c              heating demands during cooling                                   PLTSTA1725
          <lp;COILCHYR> = <lp;COILCHYR> + <lp;COILCHMO>                         PLTSTA1726
          IF (<lp;COILCHMOM> .LT. <lp;COILCHYRM>)  THEN                         PLTSTA1727
            <lp;COILCHYRM>   = <lp;COILCHMOM>                                   PLTSTA1728
            <lp;COILCHYRMMO> = IMO                                              PLTSTA1729
            <lp;COILCHYRMDY> = <lp;COILCHMOMDY>                                 PLTSTA1730
          ENDIF                                                                 PLTSTA1731
c              piping losses during floating                                    PLTSTA1732
          <lp;LOSSFYR> = <lp;LOSSFYR> + <lp;LOSSFMO>                            PLTSTA1733
          IF (<lp;LOSSFMOM> .LT. <lp;LOSSFYRM>)  THEN                           PLTSTA1734
            <lp;LOSSFYRM>   = <lp;LOSSFMOM>                                     PLTSTA1735
            <lp;LOSSFYRMMO> = IMO                                               PLTSTA1736
            <lp;LOSSFYRMDY> = <lp;LOSSFMOMDY>                                   PLTSTA1737
          ENDIF                                                                 PLTSTA1738
c              cooling demands during floating                                  PLTSTA1739
          <lp;COILFCYR> = <lp;COILFCYR> + <lp;COILFCMO>                         PLTSTA1740
          IF (<lp;COILFCMOM> .GT. <lp;COILFCYRM>)  THEN                         PLTSTA1741
            <lp;COILFCYRM>   = <lp;COILFCMOM>                                   PLTSTA1742
            <lp;COILFCYRMMO> = IMO                                              PLTSTA1743
            <lp;COILFCYRMDY> = <lp;COILFCMOMDY>                                 PLTSTA1744
          ENDIF                                                                 PLTSTA1745
c              heating demands during floating                                  PLTSTA1746
          <lp;COILFHYR> = <lp;COILFHYR> + <lp;COILFHMO>                         PLTSTA1747
          IF (<lp;COILFHMOM> .LT. <lp;COILFHYRM>)  THEN                         PLTSTA1748
            <lp;COILFHYRM>   = <lp;COILFHMOM>                                   PLTSTA1749
            <lp;COILFHYRMMO> = IMO                                              PLTSTA1750
            <lp;COILFHYRMDY> = <lp;COILFHMOMDY>                                 PLTSTA1751
          ENDIF                                                                 PLTSTA1752
c              part load bins for floating                                      PLTSTA1753
          <lp;FLOATYR> = <lp;FLOATYR> + <lp;FLOATMO>                            PLTSTA1754
          DO  II=1,12                                                           PLTSTA1755
            <lp;GPMFPLRYR> = <lp;GPMFPLRYR> + <lp;GPMFPLRMO>                    PLTSTA1756
          ENDDO                                                                 PLTSTA1757
        ENDIF                                                                   PLTSTA1758
c              zero monthly values for next month's use                         PLTSTA1759
        CALL FILLN(0., <=MOBJlp>, LlpMO)                                        PLTSTA1760
c              end of circulation-loop statistics                               PLTSTA1761
      ENDDO                                                                     PLTSTA1762
c                                                                               PLTSTA1763
c              pumps                                                            PLTSTA1764
c              pump heat                                                        PLTSTA1765
      DO  Neq=1,Npm                                                             PLTSTA1766
        Jpm = Ipm + (Neq-1)*Lpm                                                 PLTSTA1767
        IF (<pm;TOTAL_GPM> .EQ. 0.)  CYCLE                                      PLTSTA1768
        <pm;QHYR> = <pm;QHYR> + <pm;QHMO>                                       PLTSTA1769
        IF (<pm;QHMOM> .GT. <pm;QHYRM>)  THEN                                   PLTSTA1770
          <pm;QHYRM>   = <pm;QHMOM>                                             PLTSTA1771
          <pm;QHYRMMO> = IMO                                                    PLTSTA1772
          <pm;QHYRMDY> = <pm;QHMOMDY>                                           PLTSTA1773
        ENDIF                                                                   PLTSTA1774
c              power consumption                                                PLTSTA1775
        <pm;KWHYR> = <pm;KWHYR> + <pm;KWHMO>                                    PLTSTA1776
        IF (<pm;KWHMOM> .GT. <pm;KWHYRM>)  THEN                                 PLTSTA1777
          <pm;KWHYRM>   = <pm;KWHMOM>                                           PLTSTA1778
          <pm;KWHYRMMO> = IMO                                                   PLTSTA1779
          <pm;KWHYRMDY> = <pm;KWHMOMDY>                                         PLTSTA1780
        ENDIF                                                                   PLTSTA1781
c              part load bins for flow, speed, and kW - note that flow          PLTSTA1782
c              and kW are relative to sum of all pumps                          PLTSTA1783
        DO  II=1,12                                                             PLTSTA1784
          <pm;GPMPLRYR> = <pm;GPMPLRYR> + <pm;GPMPLRMO>                         PLTSTA1785
          <pm;RPMPLRYR> = <pm;RPMPLRYR> + <pm;RPMPLRMO>                         PLTSTA1786
          <pm;KWHPLRYR> = <pm;KWHPLRYR> + <pm;KWHPLRMO>                         PLTSTA1787
        ENDDO                                                                   PLTSTA1788
c              zero monthly values for reuse next month                         PLTSTA1789
        CALL FILLN(0., <=MOBJpm>, LpmMO)                                        PLTSTA1790
c              end of pump statistics                                           PLTSTA1791
      ENDDO                                                                     PLTSTA1792
c                                                                               PLTSTA1793
c              chillers                                                         PLTSTA1794
      DO  Neq=1,Nch                                                             PLTSTA1795
        Jch = Ich + (Neq-1)*Lch                                                 PLTSTA1796
        Jpe = <ch;Jpe>                                                          -041h   49
c              equipment load                                                   PLTSTA1797
        <ch;QYR> = <ch;QYR> + <ch;QMO>                                          PLTSTA1798
        IF (<ch;QMOM> .GT. <ch;QYRM>)  THEN                                     PLTSTA1799
          <ch;QYRM>   = <ch;QMOM>                                               PLTSTA1800
          <ch;QYRMMO> = IMO                                                     PLTSTA1801
          <ch;QYRMDY> = <ch;QMOMDY>                                             PLTSTA1802
          <ch;PeakCHWSYr>  = <ch;PeakCHWSMo>                                    -041h   50
          <ch;PeakTcondYr> = <ch;PeakTcondMo>                                   -041h   51
          <ch;PeakDBTYr>   = <ch;PeakDBTMo>                                     -041h   52
          <ch;PeakWBTYr>   = <ch;PeakWBTMo>                                     -041h   53
        ENDIF                                                                   PLTSTA1803
c              elec consumption                                                 PLTSTA1804
        <ch;KWHYR> = <ch;KWHYR> + <ch;KWHMO>                                    PLTSTA1805
        IF (<ch;KWHMOM> .GT. <ch;KWHYRM>)  THEN                                 PLTSTA1806
          <ch;KWHYRM>   = <ch;KWHMOM>                                           PLTSTA1807
          <ch;KWHYRMMO> = IMO                                                   PLTSTA1808
          <ch;KWHYRMDY> = <ch;KWHMOMDY>                                         PLTSTA1809
        ENDIF                                                                   PLTSTA1810
c              fuel consumption                                                 PLTSTA1811
        IF (<ch;DES_FUEL> .NE. 0.)  THEN                                        PLTSTA1812
          <ch;FUELYR> = <ch;FUELYR> + <ch;FUELMO>                               PLTSTA1813
          IF (<ch;DES_FUEL> .GT. 0.)  THEN                                      PLTSTA1814
            IF (<ch;FUELMOM> .GT. <ch;FUELYRM>)  THEN                           PLTSTA1815
              <ch;FUELYRM>   = <ch;FUELMOM>                                     PLTSTA1816
              <ch;FUELYRMMO> = IMO                                              PLTSTA1817
              <ch;FUELYRMDY> = <ch;FUELMOMDY>                                   PLTSTA1818
            ENDIF                                                               PLTSTA1819
          ELSE                                                                  PLTSTA1820
            IF (<ch;FUELMOM> .LT. <ch;FUELYRM>)  THEN                           PLTSTA1821
              <ch;FUELYRM>   = <ch;FUELMOM>                                     PLTSTA1822
              <ch;FUELYRMMO> = IMO                                              PLTSTA1823
              <ch;FUELYRMDY> = <ch;FUELMOMDY>                                   PLTSTA1824
            ENDIF                                                               PLTSTA1825
          ENDIF                                                                 PLTSTA1826
        ENDIF                                                                   PLTSTA1827
c              aux elec consumption                                             PLTSTA1828
        <ch;AUXYR> = <ch;AUXYR> + <ch;AUXMO>                                    PLTSTA1829
        IF (<ch;AUXMOM> .GT. <ch;AUXYRM>)  THEN                                 PLTSTA1830
          <ch;AUXYRM>   = <ch;AUXMOM>                                           PLTSTA1831
          <ch;AUXYRMMO> = IMO                                                   PLTSTA1832
          <ch;AUXYRMDY> = <ch;AUXMOMDY>                                         PLTSTA1833
        ENDIF                                                                   PLTSTA1834
c              heat recovery (all chillers)                                     PLTSTA1835
c              and/or heating load (dual-mode chillers)                         ChlrHP 983
c              QRECVR elec consumption                                          PLTSTA1837
        <ch;QRECVRYR> = <ch;QRECVRYR> + <ch;QRECVRMO>                           PLTSTA1838
        IF (<ch;QRECVRMOM> .LT. <ch;QRECVRYRM>)  THEN                           PLTSTA1839
          <ch;QRECVRYRM>   = <ch;QRECVRMOM>                                     PLTSTA1840
          <ch;QRECVRYRMMO> = IMO                                                PLTSTA1841
          <ch;QRECVRYRMDY> = <ch;QRECVRMOMDY>                                   PLTSTA1842
        ENDIF                                                                   PLTSTA1843
c              part load bins for flow, elec, and fuel                          PLTSTA1844
        DO  II=1,12                                                             PLTSTA1845
          <ch;QPLRYR>    = <ch;QPLRYR> + <ch;QPLRMO>                            PLTSTA1846
          <ch;KWHPLRYR>  = <ch;KWHPLRYR> + <ch;KWHPLRMO>                        PLTSTA1847
          <ch;FUELPLRYR> = <ch;FUELPLRYR> + <ch;FUELPLRMO>                      PLTSTA1848
        ENDDO                                                                   PLTSTA1849
c              zero monthly values for reuse next month                         PLTSTA1850
        CALL FILLN(0., <=MOBJch>, LchMO)                                        PLTSTA1851
c              end of chiller statistics                                        PLTSTA1852
      ENDDO                                                                     PLTSTA1853
                                                                                -045m   81
c              boilers                                                          -045m   82
      DO  Neq=1,Nbl                                                             -045m   83
        Jbl = Ibl + (Neq-1)*Lbl                                                 -045m   84
        Jpe = <bl;Jpe>                                                          -045m   85
c              HWR at which peak occurs                                         -045m   86
        IC = 1                                                                  -045m   87
        IF (<pe;MONTH_MAX> .eq. <pe;YEAR_MAX>) THEN                             -045m   88
          <bl;PeakHWRYr> = <bl;PeakHWRMo>                                       -045m   89
        ENDIF                                                                   -045m   90
      ENDDO                                                                     -045m   91
c                                                                               PLTSTA1854
c              cooling towers                                                   PLTSTA1855
      DO  Neq=1,Ntw                                                             PLTSTA1856
        Jtw = Itw + (Neq-1)*Ltw                                                 PLTSTA1857
c              equipment load                                                   PLTSTA1858
        <tw;QYR> = <tw;QYR> + <tw;QMO>                                          PLTSTA1859
        IF (<tw;QMOM> .GT. <tw;QYRM>)  THEN                                     PLTSTA1860
          <tw;QYRM>   = <tw;QMOM>                                               PLTSTA1861
          <tw;QYRMMO> = IMO                                                     PLTSTA1862
          <tw;QYRMDY> = <tw;QMOMDY>                                             PLTSTA1863
        ENDIF                                                                   PLTSTA1864
c              elec consumption                                                 PLTSTA1865
        <tw;KWHYR> = <tw;KWHYR> + <tw;KWHMO>                                    PLTSTA1866
        IF (<tw;KWHMOM> .GT. <tw;KWHYRM>)  THEN                                 PLTSTA1867
          <tw;KWHYRM>   = <tw;KWHMOM>                                           PLTSTA1868
          <tw;KWHYRMMO> = IMO                                                   PLTSTA1869
          <tw;KWHYRMDY> = <tw;KWHMOMDY>                                         PLTSTA1870
        ENDIF                                                                   PLTSTA1871
c              aux elec consumption                                             PLTSTA1872
        <tw;AUXYR> = <tw;AUXYR> + <tw;AUXMO>                                    PLTSTA1873
        IF (<tw;AUXMOM> .GT. <tw;AUXYRM>)  THEN                                 PLTSTA1874
          <tw;AUXYRM>   = <tw;AUXMOM>                                           PLTSTA1875
          <tw;AUXYRMMO> = IMO                                                   PLTSTA1876
          <tw;AUXYRMDY> = <tw;AUXMOMDY>                                         PLTSTA1877
        ENDIF                                                                   PLTSTA1878
c              aux heat consumption                                             PLTSTA1879
        <tw;AUXHEATYR> = <tw;AUXHEATYR> + <tw;AUXHEATMO>                        PLTSTA1880
        IF (<tw;AUXHEATMOM> .LT. <tw;AUXHEATYRM>)  THEN                         PLTSTA1881
          <tw;AUXHEATYRM>   = <tw;AUXHEATMOM>                                   PLTSTA1882
          <tw;AUXHEATYRMMO> = IMO                                               PLTSTA1883
          <tw;AUXHEATYRMDY> = <tw;AUXHEATMOMDY>                                 PLTSTA1884
        ENDIF                                                                   PLTSTA1885
c              part load bins for flow, elec                                    PLTSTA1886
        DO  II=1,12                                                             PLTSTA1887
          <tw;QPLRYR>    = <tw;QPLRYR> + <tw;QPLRMO>                            PLTSTA1888
          <tw;KWHPLRYR>  = <tw;KWHPLRYR> + <tw;KWHPLRMO>                        PLTSTA1889
        ENDDO                                                                   PLTSTA1890
c              zero monthly values for reuse next month                         PLTSTA1891
        CALL FILLN(0., <=MOBJtw>, LtwMO)                                        PLTSTA1892
c              end of tower statistics                                          PLTSTA1893
      ENDDO                                                                     PLTSTA1894
c                                                                               PLTSTA1895
c              tower free cooling                                               PLTSTA1896
c     DO  Neq=1,NFC                                                             PV     178
c       JFC = IFC + (Neq-1)*LFC                                                 PV     179
c     ENDDO                                                                     PV     180
c                                                                               PLTSTA1900
c              domestic water heaters                                           PLTSTA1901
      DO  Neq=1,Ndw                                                             PLTSTA1902
        Jdw = Idw + (Neq-1)*Ldw                                                 PLTSTA1903
c              equipment load                                                   PLTSTA1904
        <dw;QYR> = <dw;QYR> + <dw;QMO>                                          PLTSTA1905
        IF (<dw;QMOM> .LT. <dw;QYRM>)  THEN                                     PLTSTA1906
          <dw;QYRM>   = <dw;QMOM>                                               PLTSTA1907
          <dw;QYRMMO> = IMO                                                     PLTSTA1908
          <dw;QYRMDY> = <dw;QMOMDY>                                             PLTSTA1909
        ENDIF                                                                   PLTSTA1910
c              elec consumption                                                 PLTSTA1911
        <dw;KWHYR> = <dw;KWHYR> + <dw;KWHMO>                                    PLTSTA1912
        IF (<dw;KWHMOM> .GT. <dw;KWHYRM>)  THEN                                 PLTSTA1913
          <dw;KWHYRM>   = <dw;KWHMOM>                                           PLTSTA1914
          <dw;KWHYRMMO> = IMO                                                   PLTSTA1915
          <dw;KWHYRMDY> = <dw;KWHMOMDY>                                         PLTSTA1916
        ENDIF                                                                   PLTSTA1917
c              fuel consumption                                                 PLTSTA1918
        <dw;FUELYR> = <dw;FUELYR> + <dw;FUELMO>                                 PLTSTA1919
        IF (<dw;FUELMOM> .GT. <dw;FUELYRM>)  THEN                               PLTSTA1920
          <dw;FUELYRM>   = <dw;FUELMOM>                                         PLTSTA1921
          <dw;FUELYRMMO> = IMO                                                  PLTSTA1922
          <dw;FUELYRMDY> = <dw;FUELMOMDY>                                       PLTSTA1923
        ENDIF                                                                   PLTSTA1924
c              aux elec consumption                                             PLTSTA1925
        <dw;AUXYR> = <dw;AUXYR> + <dw;AUXMO>                                    PLTSTA1926
        IF (<dw;AUXMOM> .GT. <dw;AUXYRM>)  THEN                                 PLTSTA1927
          <dw;AUXYRM>   = <dw;AUXMOM>                                           PLTSTA1928
          <dw;AUXYRMMO> = IMO                                                   PLTSTA1929
          <dw;AUXYRMDY> = <dw;AUXMOMDY>                                         PLTSTA1930
        ENDIF                                                                   PLTSTA1931
c              part load bins for flow, elec, and fuel                          PLTSTA1932
        DO  II=1,12                                                             PLTSTA1933
          <dw;QPLRYR>    = <dw;QPLRYR> + <dw;QPLRMO>                            PLTSTA1934
          <dw;KWHPLRYR>  = <dw;KWHPLRYR> + <dw;KWHPLRMO>                        PLTSTA1935
          <dw;FUELPLRYR> = <dw;FUELPLRYR> + <dw;FUELPLRMO>                      PLTSTA1936
        ENDDO                                                                   PLTSTA1937
c              zero monthly values for reuse next month                         PLTSTA1938
        CALL FILLN(0., <=MOBJdw>, LdwMO)                                        PLTSTA1939
c              end of DW Heater statistics                                      PLTSTA1940
      ENDDO                                                                     PLTSTA1941
c                                                                               PLTSTA1942
c              thermal storage                                                  PLTSTA1943
      DO  Neq=1,Ntk                                                             PLTSTA1944
        Jtk = Itk + (Neq-1)*Ltk                                                 PLTSTA1945
        IF (<tk:TYPE> .EQ. ColdTank)  THEN                                      PLTSTA1946
c           storage discharge                                                   PLTSTA1947
          <tk;DCHRG_YR> = <tk;DCHRG_YR> + <tk;DCHRG_MO>                         PLTSTA1948
          IF (<tk;DCHRG_MOM> .GT. <tk;DCHRG_YRM>)  THEN                         PLTSTA1949
            <tk;DCHRG_YRM> = <tk;DCHRG_MOM>                                     PLTSTA1950
            <tk;DCHRG_YRM_MO> = IMO                                             PLTSTA1951
            <tk;DCHRG_YRM_DY> = <tk;DCHRG_MOM_DY>                               PLTSTA1952
          ENDIF                                                                 PLTSTA1953
c           storage charge                                                      PLTSTA1954
          <tk;CHRG_YR> = <tk;CHRG_YR> + <tk;CHRG_MO>                            PLTSTA1955
          IF (<tk;CHRG_MOM> .GT. <tk;CHRG_YRM>)  THEN                           PLTSTA1956
            <tk;CHRG_YRM> = <tk;CHRG_MOM>                                       PLTSTA1957
            <tk;CHRG_YRM_MO> = IMO                                              PLTSTA1958
            <tk;CHRG_YRM_DY> = <tk;CHRG_MOM_DY>                                 PLTSTA1959
          ENDIF                                                                 PLTSTA1960
c           storage losses                                                      PLTSTA1961
          <tk;LOSS_YR> = <tk;LOSS_YR> + <tk;LOSS_MO>                            PLTSTA1962
          IF (<tk;LOSS_MOM> .GT. <tk;LOSS_YRM>)  THEN                           PLTSTA1963
            <tk;LOSS_YRM> = <tk;LOSS_MOM>                                       PLTSTA1964
            <tk;LOSS_YRM_MO> = IMO                                              PLTSTA1965
            <tk;LOSS_YRM_DY> = <tk;LOSS_MOM_DY>                                 PLTSTA1966
          ENDIF                                                                 PLTSTA1967
        ELSE                                                                    PLTSTA1968
c           storage discharge                                                   PLTSTA1969
          <tk;DCHRG_YR> = <tk;DCHRG_YR> + <tk;DCHRG_MO>                         PLTSTA1970
          IF (<tk;DCHRG_MOM> .LT. <tk;DCHRG_YRM>)  THEN                         PLTSTA1971
            <tk;DCHRG_YRM> = <tk;DCHRG_MOM>                                     PLTSTA1972
            <tk;DCHRG_YRM_MO> = IMO                                             PLTSTA1973
            <tk;DCHRG_YRM_DY> = <tk;DCHRG_MOM_DY>                               PLTSTA1974
          ENDIF                                                                 PLTSTA1975
c           storage charge                                                      PLTSTA1976
          <tk;CHRG_YR> = <tk;CHRG_YR> + <tk;CHRG_MO>                            PLTSTA1977
          IF (<tk;CHRG_MOM> .LT. <tk;CHRG_YRM>)  THEN                           PLTSTA1978
            <tk;CHRG_YRM> = <tk;CHRG_MOM>                                       PLTSTA1979
            <tk;CHRG_YRM_MO> = IMO                                              PLTSTA1980
            <tk;CHRG_YRM_DY> = <tk;CHRG_MOM_DY>                                 PLTSTA1981
          ENDIF                                                                 PLTSTA1982
c           storage losses                                                      PLTSTA1983
          <tk;LOSS_YR> = <tk;LOSS_YR> + <tk;LOSS_MO>                            PLTSTA1984
          IF (<tk;LOSS_MOM> .LT. <tk;LOSS_YRM>)  THEN                           PLTSTA1985
            <tk;LOSS_YRM> = <tk;LOSS_MOM>                                       PLTSTA1986
            <tk;LOSS_YRM_MO> = IMO                                              PLTSTA1987
            <tk;LOSS_YRM_DY> = <tk;LOSS_MOM_DY>                                 PLTSTA1988
          ENDIF                                                                 PLTSTA1989
        ENDIF                                                                   PLTSTA1990
c           storage auxiliary                                                   PLTSTA1991
        <tk;AUX_YR> = <tk;AUX_YR> + <tk;AUX_MO>                                 PLTSTA1992
        IF (<tk;AUX_MOM> .GT. <tk;AUX_YRM>)  THEN                               PLTSTA1993
          <tk;AUX_YRM> = <tk;AUX_MOM>                                           PLTSTA1994
          <tk;AUX_YRM_MO> = IMO                                                 PLTSTA1995
          <tk;AUX_YRM_DY> = <tk;AUX_MOM_DY>                                     PLTSTA1996
        ENDIF                                                                   PLTSTA1997
c              part load bins for flow, elec, and fuel                          PLTSTA1998
        DO  II=1,12                                                             PLTSTA1999
          <tk;DCHRG_PLR_YR> = <tk;DCHRG_PLR_YR> + <tk;DCHRG_PLR_MO>             PLTSTA2000
          <tk;CHRG_PLR_YR>  = <tk;CHRG_PLR_YR>  + <tk;CHRG_PLR_MO>              PLTSTA2001
        ENDDO                                                                   PLTSTA2002
c              zero monthly values for reuse next month                         PLTSTA2003
        CALL FILLN(0., <=MOBJtk>, LtkMO)                                        PLTSTA2004
c              end of TES statistics                                            PLTSTA2005
      ENDDO                                                                     PLTSTA2006
                                                                                -044e5 148
c              Ground-loop heat-exchangers                                      -044e5 149
      DO  Neq=1,Ngl                                                             -044e5 150
        Jgl = Igl + (Neq-1)*Lgl                                                 -044e5 151
c              heating load                                                     -044e5 152
        <gl.Heat_Yr> = <gl.Heat_Yr> + <gl.Heat_Mo>                              -044e5 153
        IF (<gl.Heat_MoM> .lt. <gl.Heat_YrM>) THEN                              -044e5 154
          <gl.Heat_YrM>  = <gl.Heat_MoM>                                        -044e5 155
          <gl.Heat_YrMo> = IMO                                                  -044e5 156
          <gl.Heat_YrDy> = <gl.Heat_MoDy>                                       -044e5 157
        ENDIF                                                                   -044e5 158
c              cooling load                                                     -044e5 159
        <gl.Cool_Yr> = <gl.Cool_Yr> + <gl.Cool_Mo>                              -044e5 160
        IF (<gl.Cool_MoM> .gt. <gl.Cool_YrM>) THEN                              -044e5 161
          <gl.Cool_YrM>  = <gl.Cool_MoM>                                        -044e5 162
          <gl.Cool_YrMo> = IMO                                                  -044e5 163
          <gl.Cool_YrDy> = <gl.Cool_MoDy>                                       -044e5 164
        ENDIF                                                                   -044e5 165
c              temperature bins for heating, cooling                            -044e5 166
        DO  II=1,13                                                             -044e5 167
          <gl.HeatT_Yr> = <gl.HeatT_Yr> + <gl.HeatT_Mo>                         -044e5 168
          <gl.CoolT_Yr> = <gl.CoolT_Yr> + <gl.CoolT_Mo>                         -044e5 169
        ENDDO                                                                   -044e5 170
        <gl.HeatTmax_Yr> = Max(<gl.HeatTmax_Yr>, <gl.HeatTmax_Mo>)              -044e5 171
        <gl.HeatTmin_Yr> = Min(<gl.HeatTmin_Yr>, <gl.HeatTmin_Mo>)              -044e5 172
        <gl.CoolTmax_Yr> = Max(<gl.CoolTmax_Yr>, <gl.CoolTmax_Mo>)              -044e5 173
        <gl.CoolTmin_Yr> = Min(<gl.CoolTmin_Yr>, <gl.CoolTmin_Mo>)              -044e5 174
c              zero monthly values for reuse next month                         -044e5 175
        CALL FILLN(0., <=MOBJgl>, LglMO)                                        -044e5 176
        <gl.HeatTmax_Mo> = -888.                                                -044e5 177
        <gl.HeatTmin_Mo> =  888.                                                -044e5 178
        <gl.CoolTmax_Mo> = -888.                                                -044e5 179
        <gl.CoolTmin_Mo> =  888.                                                -044e5 180
      ENDDO  ! Ngl                                                              -044e5 181
c                                                                               PLTSTA2007
c                                                                               PLTSTA2008
c              Sum end-uses into yearly values and totals                       PLTSTA2009
c              month pointer into PS-B arrays                                   PLTSTA2010
      MO = IMO                                                                  PLTSTA2011
c              electric meters                                                  PLTSTA2012
      DO  IM=1,Nem                                                              PLTSTA2013
        Jem = Iem + (IM-1)*Lem                                                  PLTSTA2014
        IF (<em;TOTALMOM> .GT. <em;TOTALYRM>)  THEN                             HVAC29 395
          DO  IE=1,19                                                           HVAC29 396
            <em;EndUsePeakYr> = <em;EndUsePeakMo>                               HVAC29 397
          ENDDO                                                                 HVAC29 398
        ENDIF                                                                   HVAC29 399
        DO  IE=1,20                                                             PLTSTA2015
          <em;METERSYR> = <em;METERSYR> + <em;METERSMO>                         PLTSTA2016
          IF (<em;METERSMOM> .GT. <em;METERSYRM>)  THEN                         PLTSTA2017
            <em;METERSYRM>   = <em;METERSMOM>                                   PLTSTA2018
            <em;METERSYRMMO> = IMO                                              PLTSTA2019
            <em;METERSYRMDY> = <em;METERSMOMDY>                                 PLTSTA2020
          ENDIF                                                                 PLTSTA2021
          <em;NetUseYr> = <em;NetUseYr> + <em;NetUseMo>                         PLTSTA2022
          IF (<em;NetUseMoM> .GT. <em;NetUseYrM>)  THEN                         PLTSTA2023
            <em;NetUseYrM>   = <em;NetUseMoM>                                   PLTSTA2024
            <em;NetUseYrMMo> = IMO                                              PLTSTA2025
            <em;NetUseYrMDy> = <em;NetUseMoMDy>                                 PLTSTA2026
          ENDIF                                                                 PLTSTA2027
        ENDDO                                                                   PLTSTA2028
        <em;LOSSYR> = <em;LOSSYR> + <em;LOSSMO>                                 PLTSTA2029
        IF (ITDV .gt. 0)  Call TDV(29, <em;Ktv>, xx,xx,xx)                      -044   245
c              PS-B meter variables                                             PLTSTA2030
c              monthly values                                                   PLTSTA2031
        <em;PSB-ENGY> = <em;NetTotalMo>                                         PLTSTA2032
        <em;PSB-PEAK> = <em;NetTotalMoM>                                        PLTSTA2033
        <em;PSB-DAY>  = <em;NetTotalMoMDy>                                      PLTSTA2034
        <em;PSB-HR>   = <em;NetTotalMoMHr>                                      PLTSTA2035
c              yearly values                                                    PLTSTA2036
        <em;PSB-ENGYYR> = <em;PSB-ENGYYR> + <em;NetTotalMo>                     PLTSTA2037
        IF (<em;NetTotalMoM> .GT. <em;PSB-PEAKYR>)  THEN                        PLTSTA2038
          <em;PSB-PEAKYR> = <em;NetTotalMoM>                                    PLTSTA2039
          <em;PSB-MOYR>   = IMO                                                 PLTSTA2040
          <em;PSB-DAYYR>  = <em;NetTotalMoMDy>                                  PLTSTA2041
        ENDIF                                                                   PLTSTA2042
c              zero monthly values for reuse next month                         PLTSTA2043
        CALL FILLN(0., <=MOBJem>, LemMO)                                        PLTSTA2044
      ENDDO                                                                     PLTSTA2045
c              PS-E summary report for all electric meters                      PLTSTA2046
      IF (Nem .GT. 0)  THEN                                                     PLTSTA2047
        IF (EndUsePeaks(20,1,IELEC) .GT. EndUsePeaks(20,2,IELEC))  THEN         HVAC29 400
          DO  IE=1,19                                                           HVAC29 401
            EndUseAtPeak(IE,2,IELEC) = EndUseAtPeak(IE,1,IELEC)                 HVAC29 402
          ENDDO                                                                 HVAC29 403
        ENDIF                                                                   HVAC29 404
        DO  IE=1,20                                                             PLTSTA2048
          EndUses(IE,2,IELEC) =                                                 PLTSTA2049
     &                      EndUses(IE,2,IELEC) + EndUses(IE,1,IELEC)           PLTSTA2050
          IF (EndUsePeaks(IE,1,IELEC)                                           PLTSTA2051
     &                              .GT. EndUsePeaks(IE,2,IELEC))  THEN         PLTSTA2052
            EndUsePeaks(IE,2,IELEC) = EndUsePeaks(IE,1,IELEC)                   PLTSTA2053
c              note that day and hour for the yearly sum                        PLTSTA2054
c              are really month and day                                         PLTSTA2055
            EndPeakDay(IE,2,IELEC)  = IMO                                       PLTSTA2056
            EndPeakHour(IE,2,IELEC) = EndPeakDay(IE,1,IELEC)                    PLTSTA2057
          ENDIF                                                                 PLTSTA2058
c              zero monthly values for reuse next month                         PLTSTA2059
          EndUses(IE,1,IELEC)      = 0.                                         Ver42L1 76
          EndUsePeaks(IE,1,IELEC)  = 0.                                         Ver42L1 77
          EndUseAtPeak(IE,1,IELEC) = 0.                                         Ver42L1 78
          EndPeakDay(IE,1,IELEC)   = 0                                          Ver42L1 79
          EndPeakHour(IE,1,IELEC)  = 0                                          Ver42L1 80
        ENDDO                                                                   PLTSTA2062
        IF (ITDV .gt. 0)  ! time-dependent valuation                            -044   246
     &    Call TDV(29, KtvTDV2(1), xx, xx, xx)                                  -044   247
      ENDIF                                                                     PLTSTA2063
c              fuel meters                                                      PLTSTA2064
      DO  IM=1,Nfm                                                              PLTSTA2065
        Jfm = Ifm + (IM-1)*Lfm                                                  PLTSTA2066
        IF (<fm;TOTALMOM> .GT. <fm;TOTALYRM>)  THEN                             HVAC29 405
          DO  IE=1,19                                                           HVAC29 406
            <fm;EndUsePeakYr> = <fm;EndUsePeakMo>                               HVAC29 407
          ENDDO                                                                 HVAC29 408
        ENDIF                                                                   HVAC29 409
        DO  IE=1,20                                                             PLTSTA2067
          <fm;METERSYR> = <fm;METERSYR> + <fm;METERSMO>                         PLTSTA2068
          IF (<fm;METERSMOM> .GT. <fm;METERSYRM>)  THEN                         PLTSTA2069
            <fm;METERSYRM>   = <fm;METERSMOM>                                   PLTSTA2070
            <fm;METERSYRMMO> = IMO                                              PLTSTA2071
            <fm;METERSYRMDY> = <fm;METERSMOMDY>                                 PLTSTA2072
          ENDIF                                                                 PLTSTA2073
        ENDDO                                                                   PLTSTA2074
        IF (ITDV .gt. 0)  Call TDV(29, <fm;Ktv>, xx,xx,xx)                      -044   248
c              PS-B meter variables                                             PLTSTA2075
c              monthly values                                                   PLTSTA2076
        <fm;PSB-ENGY> = <fm;TOTALMO>                                            PLTSTA2077
        <fm;PSB-PEAK> = <fm;TOTALMOM>                                           PLTSTA2078
        <fm;PSB-DAY>  = <fm;TOTALMOMDY>                                         PLTSTA2079
        <fm;PSB-HR>   = <fm;TOTALMOMHR>                                         PLTSTA2080
c              yearly values                                                    PLTSTA2081
        <fm;PSB-ENGYYR> = <fm;PSB-ENGYYR> + <fm;TOTALMO>                        PLTSTA2082
        IF (<fm;TOTALMOM> .GT. <fm;PSB-PEAKYR>)  THEN                           PLTSTA2083
          <fm;PSB-PEAKYR> = <fm;TOTALMOM>                                       PLTSTA2084
          <fm;PSB-MOYR>   = IMO                                                 PLTSTA2085
          <fm;PSB-DAYYR>  = <fm;TOTALMOMDY>                                     PLTSTA2086
        ENDIF                                                                   PLTSTA2087
c              zero monthly values for reuse next month                         PLTSTA2088
        CALL FILLN(0., <=MOBJfm>, LfmMO)                                        PLTSTA2089
      ENDDO                                                                     PLTSTA2090
c              PS-E summary report for all fuel meters                          PLTSTA2091
      IF (Nfm .GT. 0)  THEN                                                     PLTSTA2092
        IF (EndUsePeaks(20,1,IFUEL) .GT. EndUsePeaks(20,2,IFUEL))  THEN         HVAC29 410
          DO  IE=1,19                                                           HVAC29 411
            EndUseAtPeak(IE,2,IFUEL) = EndUseAtPeak(IE,1,IFUEL)                 HVAC29 412
          ENDDO                                                                 HVAC29 413
        ENDIF                                                                   HVAC29 414
        DO  IE=1,20                                                             PLTSTA2093
          EndUses(IE,2,IFUEL) =                                                 PLTSTA2094
     &                      EndUses(IE,2,IFUEL) + EndUses(IE,1,IFUEL)           PLTSTA2095
          IF (EndUsePeaks(IE,1,IFUEL)                                           PLTSTA2096
     &                              .GT. EndUsePeaks(IE,2,IFUEL))  THEN         PLTSTA2097
            EndUsePeaks(IE,2,IFUEL) = EndUsePeaks(IE,1,IFUEL)                   PLTSTA2098
c              note that day and hour for the yearly sum                        PLTSTA2099
c              are really month and day                                         PLTSTA2100
            EndPeakDay(IE,2,IFUEL)  = IMO                                       PLTSTA2101
            EndPeakHour(IE,2,IFUEL) = EndPeakDay(IE,1,IFUEL)                    PLTSTA2102
          ENDIF                                                                 PLTSTA2103
c              zero monthly values for reuse next month                         PLTSTA2104
          EndUses(IE,1,IFUEL)      = 0.                                         Ver42L1 81
          EndUsePeaks(IE,1,IFUEL)  = 0.                                         Ver42L1 82
          EndUseAtPeak(IE,1,IFUEL) = 0.                                         Ver42L1 83
          EndPeakDay(IE,1,IFUEL)   = 0                                          Ver42L1 84
          EndPeakHour(IE,1,IFUEL)  = 0                                          Ver42L1 85
        ENDDO                                                                   PLTSTA2107
        IF (ITDV .gt. 0)  ! time-dependent valuation                            -044   249
     &    Call TDV(29, KtvTDV2(2), xx, xx, xx)                                  -044   250
      ENDIF                                                                     PLTSTA2108
c              steam meters                                                     PLTSTA2109
      DO  IM=1,Nsm                                                              PLTSTA2110
        Jsm = Ism + (IM-1)*Lsm                                                  PLTSTA2111
        IF (<sm;TOTALMOM> .GT. <sm;TOTALYRM>)  THEN                             HVAC29 415
          DO  IE=1,19                                                           HVAC29 416
            <sm;EndUsePeakYr> = <sm;EndUsePeakMo>                               HVAC29 417
          ENDDO                                                                 HVAC29 418
        ENDIF                                                                   HVAC29 419
        DO  IE=1,20                                                             PLTSTA2112
          <sm;METERSYR> = <sm;METERSYR> + <sm;METERSMO>                         PLTSTA2113
          IF (<sm;METERSMOM> .GT. <sm;METERSYRM>)  THEN                         PLTSTA2114
            <sm;METERSYRM>   = <sm;METERSMOM>                                   PLTSTA2115
            <sm;METERSYRMMO> = IMO                                              PLTSTA2116
            <sm;METERSYRMDY> = <sm;METERSMOMDY>                                 PLTSTA2117
          ENDIF                                                                 PLTSTA2118
        ENDDO                                                                   PLTSTA2119
c              PS-B meter variables                                             PLTSTA2120
c              monthly values                                                   PLTSTA2121
        <sm;PSB-ENGY> = <sm;TOTALMO>                                            PLTSTA2122
        <sm;PSB-PEAK> = <sm;TOTALMOM>                                           PLTSTA2123
        <sm;PSB-DAY>  = <sm;TOTALMOMDY>                                         PLTSTA2124
        <sm;PSB-HR>   = <sm;TOTALMOMHR>                                         PLTSTA2125
c              yearly values                                                    PLTSTA2126
        <sm;PSB-ENGYYR> = <sm;PSB-ENGYYR> + <sm;TOTALMO>                        PLTSTA2127
        IF (<sm;TOTALMOM> .GT. <sm;PSB-PEAKYR>)  THEN                           PLTSTA2128
          <sm;PSB-PEAKYR> = <sm;TOTALMOM>                                       PLTSTA2129
          <sm;PSB-MOYR>   = IMO                                                 PLTSTA2130
          <sm;PSB-DAYYR>  = <sm;TOTALMOMDY>                                     PLTSTA2131
        ENDIF                                                                   PLTSTA2132
c              zero monthly values for reuse next month                         PLTSTA2133
        CALL FILLN(0., <=MOBJsm>, LsmMO)                                        PLTSTA2134
      ENDDO                                                                     PLTSTA2135
c              PS-E summary report for all steam meters                         PLTSTA2136
      IF (Nsm .GT. 0)  THEN                                                     PLTSTA2137
        IF (EndUsePeaks(20,1,ISTM) .GT. EndUsePeaks(20,2,ISTM))  THEN           HVAC29 420
          DO  IE=1,19                                                           HVAC29 421
            EndUseAtPeak(IE,2,ISTM) = EndUseAtPeak(IE,1,ISTM)                   HVAC29 422
          ENDDO                                                                 HVAC29 423
        ENDIF                                                                   HVAC29 424
        DO  IE=1,20                                                             PLTSTA2138
          EndUses(IE,2,ISTM) =                                                  PLTSTA2139
     &                      EndUses(IE,2,ISTM) + EndUses(IE,1,ISTM)             PLTSTA2140
          IF (EndUsePeaks(IE,1,ISTM)                                            PLTSTA2141
     &                              .GT. EndUsePeaks(IE,2,ISTM))  THEN          PLTSTA2142
            EndUsePeaks(IE,2,ISTM) = EndUsePeaks(IE,1,ISTM)                     PLTSTA2143
c              note that day and hour for the yearly sum                        PLTSTA2144
c              are really month and day                                         PLTSTA2145
            EndPeakDay(IE,2,ISTM)  = IMO                                        PLTSTA2146
            EndPeakHour(IE,2,ISTM) = EndPeakDay(IE,1,ISTM)                      PLTSTA2147
          ENDIF                                                                 PLTSTA2148
c              zero monthly values for reuse next month                         PLTSTA2149
          EndUses(IE,1,ISTM)      = 0.                                          Ver42L1 86
          EndUsePeaks(IE,1,ISTM)  = 0.                                          Ver42L1 87
          EndUseAtPeak(IE,1,ISTM) = 0.                                          Ver42L1 88
          EndPeakDay(IE,1,ISTM)   = 0                                           Ver42L1 89
          EndPeakHour(IE,1,ISTM)  = 0                                           Ver42L1 90
        ENDDO                                                                   PLTSTA2152
      ENDIF                                                                     PLTSTA2153
c              chilled-water meters                                             PLTSTA2154
      DO  IM=1,Ncm                                                              PLTSTA2155
        Jcm = Icm + (IM-1)*Lcm                                                  PLTSTA2156
        IF (<cm;TOTALMOM> .GT. <cm;TOTALYRM>)  THEN                             HVAC29 425
          DO  IE=1,19                                                           HVAC29 426
            <cm;EndUsePeakYr> = <cm;EndUsePeakMo>                               HVAC29 427
          ENDDO                                                                 HVAC29 428
        ENDIF                                                                   HVAC29 429
        DO  IE=1,20                                                             PLTSTA2157
          <cm;METERSYR> = <cm;METERSYR> + <cm;METERSMO>                         PLTSTA2158
          IF (<cm;METERSMOM> .GT. <cm;METERSYRM>)  THEN                         PLTSTA2159
            <cm;METERSYRM>   = <cm;METERSMOM>                                   PLTSTA2160
            <cm;METERSYRMMO> = IMO                                              PLTSTA2161
            <cm;METERSYRMDY> = <cm;METERSMOMDY>                                 PLTSTA2162
          ENDIF                                                                 PLTSTA2163
        ENDDO                                                                   PLTSTA2164
c              PS-B meter variables                                             PLTSTA2165
c              monthly values                                                   PLTSTA2166
        <cm;PSB-ENGY> = <cm;TOTALMO>                                            PLTSTA2167
        <cm;PSB-PEAK> = <cm;TOTALMOM>                                           PLTSTA2168
        <cm;PSB-DAY>  = <cm;TOTALMOMDY>                                         PLTSTA2169
        <cm;PSB-HR>   = <cm;TOTALMOMHR>                                         PLTSTA2170
c              yearly values                                                    PLTSTA2171
        <cm;PSB-ENGYYR> = <cm;PSB-ENGYYR> + <cm;TOTALMO>                        PLTSTA2172
        IF (<cm;TOTALMOM> .GT. <cm;PSB-PEAKYR>)  THEN                           PLTSTA2173
          <cm;PSB-PEAKYR> = <cm;TOTALMOM>                                       PLTSTA2174
          <cm;PSB-MOYR>   = IMO                                                 PLTSTA2175
          <cm;PSB-DAYYR>  = <cm;TOTALMOMDY>                                     PLTSTA2176
        ENDIF                                                                   PLTSTA2177
c              zero monthly values for reuse next month                         PLTSTA2178
        CALL FILLN(0., <=MOBJcm>, LcmMO)                                        PLTSTA2179
      ENDDO                                                                     PLTSTA2180
c              PS-E summary report for all chilled-water meters                 PLTSTA2181
      IF (Ncm .GT. 0)  THEN                                                     PLTSTA2182
        IF (EndUsePeaks(20,1,ICHW) .GT. EndUsePeaks(20,2,ICHW))  THEN           HVAC29 430
          DO  IE=1,19                                                           HVAC29 431
            EndUseAtPeak(IE,2,ICHW) = EndUseAtPeak(IE,1,ICHW)                   HVAC29 432
          ENDDO                                                                 HVAC29 433
        ENDIF                                                                   HVAC29 434
        DO  IE=1,20                                                             PLTSTA2183
          EndUses(IE,2,ICHW) =                                                  PLTSTA2184
     &                      EndUses(IE,2,ICHW) + EndUses(IE,1,ICHW)             PLTSTA2185
          IF (EndUsePeaks(IE,1,ICHW)                                            PLTSTA2186
     &                              .GT. EndUsePeaks(IE,2,ICHW))  THEN          PLTSTA2187
            EndUsePeaks(IE,2,ICHW) = EndUsePeaks(IE,1,ICHW)                     PLTSTA2188
c              note that day and hour for the yearly sum                        PLTSTA2189
c              are really month and day                                         PLTSTA2190
            EndPeakDay(IE,2,ICHW)  = IMO                                        PLTSTA2191
            EndPeakHour(IE,2,ICHW) = EndPeakDay(IE,1,ICHW)                      PLTSTA2192
          ENDIF                                                                 PLTSTA2193
c              zero monthly values for reuse next month                         PLTSTA2194
          EndUses(IE,1,ICHW)      = 0.                                          Ver42L1 91
          EndUsePeaks(IE,1,ICHW)  = 0.                                          Ver42L1 92
          EndUseAtPeak(IE,1,ICHW) = 0.                                          Ver42L1 93
          EndPeakDay(IE,1,ICHW)   = 0                                           Ver42L1 94
          EndPeakHour(IE,1,ICHW)  = 0                                           Ver42L1 95
        ENDDO                                                                   PLTSTA2197
      ENDIF                                                                     PLTSTA2198
c              PS-A yearly variables                                            PLTSTA2199
      DO  I=1,13                                                                PLTSTA2200
        PSA(I,2) = PSA(I,2) + PSA(I,1)                                          PLTSTA2201
        PSA(I,1) = 0.                                                           PLTSTA2202
      ENDDO                                                                     PLTSTA2203
c                                                                               PLTSTA2204
c              Zero monthly statistics for Jpe components for reuse next month  PLTSTA2205
      CALL PlantStatistics_Jpe(3)                                               PLTSTA2206
c                                                                               IcRink 913
c              Check for ice skating rinks                                      IcRink 914
      DO  NS=1,NSYS                                                             IcRink 915
        NSP = IS + (NS-1)*NSS                                                   IcRink 916
        IF (<sy;IceRink> .GT. 0)  THEN                                          IcRink 917
          ISZ = <ISZONES>                                                       IcRink 918
          NSZ = <NZONES>                                                        IcRink 919
          DO  NZ=1,NSZ                                                          IcRink 920
            ZP1 = ISZ + (NZ-1)*NZD                                              IcRink 921
            ZP2 = <ZP2>                                                         IcRink 922
            IF (<zn:ICE-RINK> .GT. 0)  CALL IceRink(45, <zn:ICE-RINK>)          IcRink 923
          ENDDO                                                                 IcRink 924
        ENDIF                                                                   IcRink 925
      ENDDO                                                                     IcRink 926
c                                                                               PLTSTA2207
c              end of monthly processing                                        PLTSTA2208
      RETURN                                                                    PLTSTA2209
c                                                                               PLTSTA2210
c                                                                               PLTSTA2211
c============= YEARLY STATISTICS ============================================== PLTSTA2212
      CASE (39)                                                                 PLTSTA2213
c              Do final statistics and write final records                      PLTSTA2214
c                                                                               PLTSTA2215
c              BEPS percent overload for systems equipment                      PLTSTA2216
      PctSysOvrld = FLOAT(<NHRSOVERP>)/FLOAT(<NHRSONP>+1)*100.                  PLTSTA2217
c              BEPS percent overload for plant equipment                        PLTSTA2218
      NumOn   = 0                                                               PLTSTA2219
      NumOver = 0                                                               PLTSTA2220
      II    = 12                                                                PLTSTA2221
      DO  NL=1,Nlp                                                              PLTSTA2222
        Jlp = Ilp + (NL-1)*Llp                                                  PLTSTA2223
        NumOn   = NumOn   + <lp;GPMHPLRYR>    + <lp;GPMCPLRYR>                  PLTSTA2224
        NumOver = NumOver + <lp;HR_HEAT_OVRLD> + <lp;HR_COOL_OVRLD>             PLTSTA2225
      ENDDO                                                                     PLTSTA2226
      IF (NumOn .GT. 0)  PctPltOvrld = FLOAT(NumOver/NumOn)*100.                PLTSTA2227
c              source and site energy for economics                             PLTSTA2228
      SiteEnergy   = PSA(12,2)                                                  PLTSTA2229
      SourceEnergy = PSA(13,2)                                                  PLTSTA2230
c              if metric, convert building area                                 PLTSTA2231
c              Set the units - english or metric                                PLTSTA2232
      IF (MTRICR .EQ. 1)  THEN                                                  PLTSTA2233
        BGAREA = BGAREA*VKONV(9)                                                PLTSTA2234
        BNAREA = BNAREA*VKONV(9)                                                PLTSTA2235
      ENDIF                                                                     PLTSTA2236
c                                                                               PLTSTA2237
c              print yearly records                                             PLTSTA2238
      Call PlantReports                                                         PLTSTA2239
c                                                                               PLTSTA2240
c              Loop through each component                                      PLTSTA2241
c              circulation-loops                                                PLTSTA2242
      DO  NL=1,Nlp                                                              PLTSTA2243
        Jlp = Ilp + (NL-1)*Llp                                                  PLTSTA2244
        IF (<lp:COST-DATA> .GT. 0)  THEN                                        PLTSTA2245
c              transfer component name and run hours to MATERIALS-COST          PLTSTA2246
          JMC = <lp:COST-DATA>                                                  PLTSTA2247
          DO  II=1,8                                                            PLTSTA2248
            <MC-NAME> = <lp:NAME>                                               PLTSTA2249
          ENDDO                                                                 PLTSTA2250
c              Store hours used for each MATERIALS-COST command for             PLTSTA2251
c              economics calculations                                           PLTSTA2252
          II = 12                                                               PLTSTA2253
          <OPER_HOURS/YEAR> = FLOAT(<lp;GPMHPLRYR>+<lp;GPMCPLRYR>)              PLTSTA2254
        ENDIF                                                                   PLTSTA2255
c              zero yearly values for another run                               PLTSTA2256
        CALL FILLN(0., <=YRBJlp>, LlpYR)                                        PLTSTA2257
      ENDDO                                                                     PLTSTA2258
c              pumps                                                            PLTSTA2259
      DO  Neq=1,Npm                                                             PLTSTA2260
        Jpm = Ipm + (Neq-1)*Lpm                                                 PLTSTA2261
        IF (<pm:COST-DATA> .GT. 0)  THEN                                        PLTSTA2262
          JMC = <pm:COST-DATA>                                                  PLTSTA2263
          DO  II=1,8                                                            PLTSTA2264
            <MC-NAME> = <pm:NAME>                                               PLTSTA2265
          ENDDO                                                                 PLTSTA2266
          II = 12                                                               PLTSTA2267
          <OPER_HOURS/YEAR> = FLOAT(<pm;GPMPLRYR>)                              PLTSTA2268
        ENDIF                                                                   PLTSTA2269
c              zero yearly values for another run                               PLTSTA2270
        CALL FILLN(0., <=YRBJpm>, LpmYR)                                        PLTSTA2271
      ENDDO                                                                     PLTSTA2272
c              boilers                                                          PLTSTA2273
      DO  Neq=1,Nbl                                                             PLTSTA2274
        Jbl = Ibl + (Neq-1)*Lbl                                                 PLTSTA2275
        Jpe = <bl;Jpe>                                                          PLTSTA2276
        IF (<bl:COST-DATA> .GT. 0)  THEN                                        PLTSTA2277
          JMC = <bl:COST-DATA>                                                  PLTSTA2278
          DO  II=1,8                                                            PLTSTA2279
            <MC-NAME> = <bl:NAME>                                               PLTSTA2280
          ENDDO                                                                 PLTSTA2281
          II = 12                                                               PLTSTA2282
          <OPER_HOURS/YEAR> = FLOAT(<pe;MONTH_BINS_1>)                          PLTSTA2283
        ENDIF                                                                   PLTSTA2284
c              zero yearly values for another run                               PLTSTA2285
        CALL FILLN(0., <=YRBJbl>, LblYR)                                        PLTSTA2286
      ENDDO                                                                     PLTSTA2287
c              chillers                                                         PLTSTA2288
      DO  Neq=1,Nch                                                             PLTSTA2289
        Jch = Ich + (Neq-1)*Lch                                                 PLTSTA2290
        IF (<ch:COST-DATA> .GT. 0)  THEN                                        PLTSTA2291
          JMC = <ch:COST-DATA>                                                  PLTSTA2292
          DO  II=1,8                                                            PLTSTA2293
            <MC-NAME> = <ch:NAME>                                               PLTSTA2294
          ENDDO                                                                 PLTSTA2295
          II = 12                                                               PLTSTA2296
          <OPER_HOURS/YEAR> = FLOAT(<ch;QPLRYR>)                                PLTSTA2297
        ENDIF                                                                   PLTSTA2298
c              zero yearly values for another run                               PLTSTA2299
        CALL FILLN(0., <=YRBJch>, LchYR)                                        PLTSTA2300
      ENDDO                                                                     PLTSTA2301
c              cooling towers                                                   PLTSTA2302
      DO  Neq=1,Ntw                                                             PLTSTA2303
        Jtw = Itw + (Neq-1)*Ltw                                                 PLTSTA2304
        IF (<tw:COST-DATA> .GT. 0)  THEN                                        PLTSTA2305
          JMC = <tw:COST-DATA>                                                  PLTSTA2306
          DO  II=1,8                                                            PLTSTA2307
            <MC-NAME> = <tw:NAME>                                               PLTSTA2308
          ENDDO                                                                 PLTSTA2309
          II = 12                                                               PLTSTA2310
          <OPER_HOURS/YEAR> = FLOAT(<tw;QPLRYR>)                                PLTSTA2311
        ENDIF                                                                   PLTSTA2312
c              zero yearly values for another run                               PLTSTA2313
        CALL FILLN(0., <=YRBJtw>, LtwYR)                                        PLTSTA2314
      ENDDO                                                                     PLTSTA2315
c              free cooling                                                     PLTSTA2316
c     DO  Neq=1,NFC                                                             PV     181
c       JFC = IFC + (Neq-1)*LFC                                                 PV     182
c       IF (<TFC-COST-DATA> .GT. 0)  THEN                                       PV     183
c         JMC = <TFC-COST-DATA>                                                 PV     184
c         DO  II=1,8                                                            PV     185
c           <MC-NAME> = <TFC-NAME>                                              PV     186
c         ENDDO                                                                 PV     187
c         II = 12                                                               PV     188
c ??         <OPER_HOURS/YEAR> = FLOAT(                                         PV     189
c       ENDIF                                                                   PV     190
c              zero yearly values for another run                               PV     191
c       CALL FILLN(0., <=YRBJFC>, LfcYR)                                        PV     192
c     ENDDO                                                                     PV     193
c              domestic water heaters                                           PLTSTA2330
      DO  Neq=1,Ndw                                                             PLTSTA2331
        Jdw = Idw + (Neq-1)*Ldw                                                 PLTSTA2332
        IF (<dw:COST-DATA> .GT. 0)  THEN                                        PLTSTA2333
          JMC = <dw:COST-DATA>                                                  PLTSTA2334
          DO  II=1,8                                                            PLTSTA2335
            <MC-NAME> = <dw:NAME>                                               PLTSTA2336
          ENDDO                                                                 PLTSTA2337
          II = 12                                                               PLTSTA2338
          <OPER_HOURS/YEAR> = FLOAT(<dw;QPLRYR>)                                PLTSTA2339
        ENDIF                                                                   PLTSTA2340
c              zero yearly values for another run                               PLTSTA2341
        CALL FILLN(0., <=YRBJdw>, LdwYR)                                        PLTSTA2342
      ENDDO                                                                     PLTSTA2343
c              electric generators                                              PLTSTA2344
      DO  Neq=1,Ngn                                                             PLTSTA2345
        Jgn = Ign + (Neq-1)*Lgn                                                 PLTSTA2346
        Jpe = <gn;Jpe>                                                          PLTSTA2347
        IF (<gn:COST-DATA> .GT. 0)  THEN                                        PLTSTA2348
          JMC = <gn:COST-DATA>                                                  PLTSTA2349
          DO  II=1,8                                                            PLTSTA2350
            <MC-NAME> = <gn:NAME>                                               PLTSTA2351
          ENDDO                                                                 PLTSTA2352
          II = 12                                                               PLTSTA2353
          <OPER_HOURS/YEAR> = FLOAT(<pe;MONTH_BINS_1>)                          PLTSTA2354
        ENDIF                                                                   PLTSTA2355
c              zero yearly values for another run                               PLTSTA2356
        CALL FILLN(0., <=YRBJgn>, LgnYR)                                        PLTSTA2357
      ENDDO                                                                     PLTSTA2358
c              PV modules                                                       PV     194
      DO  Neq=1,Npv                                                             PV     195
        Jpv = Ipv + (Neq-1)*Lpv                                                 PV     196
        Jpe = <pv;Jpe>                                                          PV     197
        IF (<pv:COST-DATA> .GT. 0)  THEN                                        PV     198
          JMC = <pv:COST-DATA>                                                  PV     199
          DO  II=1,8                                                            PV     200
            <MC-NAME> = <pv:NAME>                                               PV     201
          ENDDO                                                                 PV     202
          II = 12                                                               PV     203
          <OPER_HOURS/YEAR> = FLOAT(<pe;MONTH_BINS_1>)                          PV     204
        ENDIF                                                                   PV     205
c              zero yearly values for another run                               PV     206
        CALL FILLN(0., <=YRBJpv>, LpvYR)                                        PV     207
      ENDDO                                                                     PV     208
c              thermal storage                                                  PLTSTA2359
      DO  Neq=1,Ntk                                                             PLTSTA2360
        Jtk = Itk + (Neq-1)*Ltk                                                 PLTSTA2361
        IF (<tk:COST-DATA> .GT. 0)  THEN                                        PLTSTA2362
          JMC = <tk:COST-DATA>                                                  PLTSTA2363
          DO  II=1,8                                                            PLTSTA2364
            <MC-NAME> = <tk:NAME>                                               PLTSTA2365
          ENDDO                                                                 PLTSTA2366
          II = 12                                                               PLTSTA2367
c         <OPER_HOURS/YEAR> = FLOAT(<tk;DCHRG_PLR_YR>                           PLTSTA2368
        ENDIF                                                                   PLTSTA2369
c              zero yearly values for another run                               PLTSTA2370
        CALL FILLN(0., <=YRBJtk>, LtkYR)                                        PLTSTA2371
      ENDDO                                                                     PLTSTA2372
c              ground-loop heat-exchangers                                      -044e5 182
      DO  Neq=1,Ngl                                                             -044e5 183
        Jgl = Igl + (Neq-1)*Lgl                                                 -044e5 184
        IF (<gl:COST-DATA> .GT. 0)  THEN                                        -044e5 185
          JMC = <gl:COST-DATA>                                                  -044e5 186
          DO  II=1,8                                                            -044e5 187
            <MC-NAME> = <gl:NAME>                                               -044e5 188
          ENDDO                                                                 -044e5 189
          II = 13                                                               -044e5 190
          <OPER_HOURS/YEAR> = <gl.HeatT_Yr> + <gl.CoolT_Yr>                     -044e5 191
        ENDIF                                                                   -044e5 192
c              zero yearly values for another run                               -044e5 193
        CALL FILLN(0., <=YRBJgl>, LglYR)                                        -044e5 194
        <gl.HeatTmax_Yr> = -888.                                                -044e5 195
        <gl.HeatTmin_Yr> =  888.                                                -044e5 196
        <gl.CoolTmax_Yr> = -888.                                                -044e5 197
        <gl.CoolTmin_Yr> =  888.                                                -044e5 198
      ENDDO                                                                     -044e5 199
c                                                                               PLTSTA2373
c              zero yearly Jpe values for another run                           PLTSTA2374
      CALL PlantStatistics_Jpe(4)                                               PLTSTA2375
c                                                                               PLTSTA2376
      END SELECT                                                                PLTSTA2377
c                                                                               PLTSTA2378
c                                                                               PLTSTA2379
      RETURN                                                                    PLTSTA2380
      END                                                                       PLTSTA2381
      SUBROUTINE PlantStatistics_Jpe(Istat)                                     PTSJPE   2
c                                                                               PTSJPE   3
c              Calculates all report statistics in the Jpe block                PTSJPE   4
c                                                                               PTSJPE   5
c              Istat = 1  Hourly statistics                                     PTSJPE   6
c                         Called individually for each component                PTSJPE   7
c                      2  Sum monthly statistics into yearly                    PTSJPE   8
c                         Called once for all components                        PTSJPE   9
c                      3  Zero monthly statistics for use next month            PTSJPE  10
c                         Called once for all components                        PTSJPE  11
c                      4  Do final processing of yearly statistics              PTSJPE  12
c                         Called once for all components                        PTSJPE  13
c                                                                               PTSJPE  14
c              Variables designated for statistics and reports were             PTSJPE  15
c              set up in PlantReports, and are contained in the                 PTSJPE  16
c              pe;HOURLY_VARS edtt array                                        PTSJPE  17
c                                                                               PTSJPE  18
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /ZEROP/  LpmHR,LlpHR,LchHR,LblHR,LdwHR,LtwHR,LpvHR,LgnHR,         PV       5
     &                 LtkHR,LhxHR,LecHR,LlmHR,LemHR,LfmHR,LsmHR,LcmHR,         /ZEROP/  3
     &                 LglHR,LpeHR,                                             /ZEROP/  4
     &                 LpmMO,LlpMO,LchMO,LblMO,LdwMO,LtwMO,LpvMO,LgnMO,         PV       6
     &                 LtkMO,LhxMO,LecMO,LlmMO,LemMO,LfmMO,LsmMO,LcmMO,         /ZEROP/  6
     &                 LglMO,LpeMO,                                             /ZEROP/  7
     &                 LpmYR,LlpYR,LchYR,LblYR,LdwYR,LtwYR,LpvYR,LgnYR,         PV       7
     &                 LtkYR,LhxYR,LecYR,LlmYR,LemYR,LfmYR,LsmYR,LcmYR,         /ZEROP/  9
     &                 LglYR,LpeYR                                              /ZEROP/ 10
c                                                                               PTSJPE  24
      INDXPL(part,full)=                                                        INDXPL   2
     &      MAX(1,MIN(11,INT((ABS(part)+.001)                                   INDXPL   3
     &                                / MAX(1.E-6,ABS(full))*10.)+1))           INDXPL   4
c                                                                               PTSJPE  26
c              Check if hourly, monthly or yearly statistics                    PTSJPE  27
      GOTO (1,2000,3000,4000), Istat                                            PTSJPE  28
c                                                                               PTSJPE  29
c============= HOURLY STATISTICS ============================================== PTSJPE  30
    1 CONTINUE                                                                  PTSJPE  31
c                                                                               PTSJPE  32
c              Number of columns                                                PTSJPE  33
      NumCols = <pe;PS-H_COLUMNS>                                               PTSJPE  34
c              Process Jpe variables into the design                            PTSJPE  35
      DO  IC=1,NumCols                                                          PTSJPE  36
c              index to variable that goes in this column                       PTSJPE  37
        IR = <pe;PS-H_VAR_INDX>                                                 PTSJPE  38
        ColumnVariable = <pe;HOURLY_VARS>                                       PTSJPE  39
        IF (ColumnVariable  .NE. 0.)  THEN                                      PTSJPE  40
          <pe;MONTH> = <pe;MONTH> + ColumnVariable                              PTSJPE  41
          IF (<pe;DESIGN_VARS> .LT. 0.)  THEN                                   PTSJPE  42
            IF (ColumnVariable .LT. <pe;MONTH_MAX>)  THEN                       PTSJPE  43
              <pe;MONTH_MAX> = ColumnVariable                                   PTSJPE  44
              <pe;MONTH_DAY> = IDAY                                             PTSJPE  45
              <pe;MONTH_HOUR> = ISCHR                                           PTSJPE  46
            ENDIF                                                               PTSJPE  47
          ELSE                                                                  PTSJPE  48
            IF (ColumnVariable .GT. <pe;MONTH_MAX>)  THEN                       PTSJPE  49
              <pe;MONTH_MAX>  = ColumnVariable                                  PTSJPE  50
              <pe;MONTH_DAY>  = IDAY                                            PTSJPE  51
              <pe;MONTH_HOUR> = ISCHR                                           PTSJPE  52
            ENDIF                                                               PTSJPE  53
          ENDIF                                                                 PTSJPE  54
        ENDIF                                                                   PTSJPE  55
      ENDDO                                                                     PTSJPE  56
c                                                                               PTSJPE  57
c              now process bins                                                 PTSJPE  58
c              skip to end if no more bins                                      PTSJPE  59
      IC = 5                                                                    PTSJPE  60
      IF (<pe;PS-H_VAR_INDX> .EQ. 0)  GOTO 200                                  PTSJPE  61
c              index to variable that goes in this bin                          PTSJPE  62
      IR = <pe;PS-H_VAR_INDX>                                                   PTSJPE  63
      BinVariable = <pe;HOURLY_VARS>                                            PTSJPE  64
      IF (BinVariable .NE. 0.)  THEN                                            PTSJPE  65
        II = INDXPL(BinVariable,<pe;DESIGN_VARS>)                               PTSJPE  66
        <pe;MONTH_BINS_1> = <pe;MONTH_BINS_1> + 1                               PTSJPE  67
      ENDIF                                                                     PTSJPE  68
c              second bin                                                       PTSJPE  69
      IC = 6                                                                    PTSJPE  70
      IF (<pe;PS-H_VAR_INDX> .EQ. 0)  GOTO 200                                  PTSJPE  71
c              index to variable that goes in this bin                          PTSJPE  72
      IR = <pe;PS-H_VAR_INDX>                                                   PTSJPE  73
      BinVariable = <pe;HOURLY_VARS>                                            PTSJPE  74
      IF (BinVariable .NE. 0.)  THEN                                            PTSJPE  75
        II = INDXPL(BinVariable,<pe;DESIGN_VARS>)                               PTSJPE  76
        <pe;MONTH_BINS_2> = <pe;MONTH_BINS_2> + 1                               PTSJPE  77
      ENDIF                                                                     PTSJPE  78
c              third bin                                                        PTSJPE  79
      IC = 7                                                                    PTSJPE  80
      IF (<pe;PS-H_VAR_INDX> .EQ. 0)  GOTO 200                                  PTSJPE  81
c              index to variable that goes in this bin                          PTSJPE  82
      IR = <pe;PS-H_VAR_INDX>                                                   PTSJPE  83
      BinVariable = <pe;HOURLY_VARS>                                            PTSJPE  84
      IF (BinVariable .NE. 0.)  THEN                                            PTSJPE  85
        II = INDXPL(BinVariable,<pe;DESIGN_VARS>)                               PTSJPE  86
        <pe;MONTH_BINS_3> = <pe;MONTH_BINS_3> + 1                               PTSJPE  87
      ENDIF                                                                     PTSJPE  88
c                                                                               PTSJPE  89
c              increment hours shut down                                        PTSJPE  90
  200 IF (<pe;LOAD> .EQ. 0.  .and.  <pe;GPM> .EQ. 0.)  THEN                     -044c4 398
        <pe;HOURS_OFF> = <pe;HOURS_OFF> + 1                                     PTSJPE  92
      ELSE                                                                      PTSJPE  93
        <pe;HOURS_OFF> = 0                                                      PTSJPE  94
      ENDIF                                                                     PTSJPE  95
c                                                                               PTSJPE  96
      RETURN                                                                    PTSJPE  97
c                                                                               PTSJPE  98
c============= MONTHLY STATISTICS ============================================= PTSJPE  99
 2000 CONTINUE                                                                  PTSJPE 100
c                                                                               PTSJPE 101
c              Loop thru all Jpe blocks and sum into yearly statistics          PTSJPE 102
      DO  Neq=1,Npe                                                             PTSJPE 103
        Jpe = Ipe + (Neq-1)*Lpe                                                 PTSJPE 104
c              Number of columns                                                PTSJPE 105
        NumCols = <pe;PS-H_COLUMNS>                                             PTSJPE 106
        DO  IC=1,NumCols                                                        PTSJPE 107
c              index to variable that goes in this column                       PTSJPE 108
          IR = <pe;PS-H_VAR_INDX>                                               PTSJPE 109
c              total consumption                                                PTSJPE 110
          ColumnVariable = <pe;MONTH>                                           PTSJPE 111
          <pe;YEAR> = <pe;YEAR> + ColumnVariable                                PTSJPE 112
c              peak consumption                                                 PTSJPE 113
          ColumnVariable = <pe;MONTH_MAX>                                       PTSJPE 114
          IF (<pe;DESIGN_VARS> .LT. 0.)  THEN                                   PTSJPE 115
            IF (ColumnVariable .LT. <pe;YEAR_MAX>)  THEN                        PTSJPE 116
              <pe;YEAR_MAX>   = ColumnVariable                                  PTSJPE 117
              <pe;YEAR_MONTH> = IMO                                             PTSJPE 118
              <pe;YEAR_DAY>   = <pe;MONTH_DAY>                                  PTSJPE 119
            ENDIF                                                               PTSJPE 120
          ELSE                                                                  PTSJPE 121
            IF (ColumnVariable .GT. <pe;YEAR_MAX>)  THEN                        PTSJPE 122
              <pe;YEAR_MAX>   = ColumnVariable                                  PTSJPE 123
              <pe;YEAR_MONTH> = IMO                                             PTSJPE 124
              <pe;YEAR_DAY>   = <pe;MONTH_DAY>                                  PTSJPE 125
            ENDIF                                                               PTSJPE 126
          ENDIF                                                                 PTSJPE 127
        ENDDO                                                                   PTSJPE 128
c                                                                               PTSJPE 129
c              now process bins - monthly total and yearly bins                 PTSJPE 130
        IItotal1 = 0                                                            PTSJPE 131
        IItotal2 = 0                                                            PTSJPE 132
        IItotal3 = 0                                                            PTSJPE 133
        DO  II=1,11                                                             PTSJPE 134
          <pe;YEAR_BINS_1> = <pe;YEAR_BINS_1> + <pe;MONTH_BINS_1>               PTSJPE 135
          IItotal1         = IItotal1         + <pe;MONTH_BINS_1>               PTSJPE 136
          <pe;YEAR_BINS_2> = <pe;YEAR_BINS_2> + <pe;MONTH_BINS_2>               PTSJPE 137
          IItotal2         = IItotal2         + <pe;MONTH_BINS_2>               PTSJPE 138
          <pe;YEAR_BINS_3> = <pe;YEAR_BINS_3> + <pe;MONTH_BINS_3>               PTSJPE 139
          IItotal3         = IItotal3         + <pe;MONTH_BINS_3>               PTSJPE 140
        ENDDO                                                                   PTSJPE 141
        II = 12                                                                 PTSJPE 142
        <pe;MONTH_BINS_1> = IItotal1                                            PTSJPE 143
        <pe;YEAR_BINS_1>  = <pe;YEAR_BINS_1> + IItotal1                         PTSJPE 144
        <pe;MONTH_BINS_2> = IItotal2                                            PTSJPE 145
        <pe;YEAR_BINS_2>  = <pe;YEAR_BINS_2> + IItotal2                         PTSJPE 146
        <pe;MONTH_BINS_3> = IItotal3                                            PTSJPE 147
        <pe;YEAR_BINS_3>  = <pe;YEAR_BINS_3> + IItotal3                         PTSJPE 148
      ENDDO                                                                     PTSJPE 149
c                                                                               PTSJPE 150
      RETURN                                                                    PTSJPE 151
c                                                                               PTSJPE 152
c                                                                               PTSJPE 153
c============= REZERO MONTHLY BLOCKS ========================================== PTSJPE 154
 3000 CONTINUE                                                                  PTSJPE 155
c                                                                               PTSJPE 156
c              zero monthly values for reuse next month                         PTSJPE 157
      DO  Neq=1,Npe                                                             PTSJPE 158
        Jpe = Ipe + (Neq-1)*Lpe                                                 PTSJPE 159
        CALL FILLN(0., <=MOBJpe>, LpeMO)                                        PTSJPE 160
      ENDDO                                                                     PTSJPE 161
c                                                                               PTSJPE 162
      RETURN                                                                    PTSJPE 163
c                                                                               PTSJPE 164
c                                                                               PTSJPE 165
c============= YEARLY STATISTICS ============================================== PTSJPE 166
 4000 CONTINUE                                                                  PTSJPE 167
c                                                                               PTSJPE 168
c              zero yearly values for reuse next month                          PTSJPE 169
      DO  Neq=1,Npe                                                             PTSJPE 170
        Jpe = Ipe + (Neq-1)*Lpe                                                 PTSJPE 171
        CALL FILLN(0., <=YRBJpe>, LpeYR)                                        PTSJPE 172
      ENDDO                                                                     PTSJPE 173
c                                                                               PTSJPE 174
      RETURN                                                                    PTSJPE 175
      END                                                                       PTSJPE 176
      SUBROUTINE PrimaryEquip                                                   PRIMEQ   2
c                                                                               PRIMEQ   3
c              Allocates load to primary equipment and calls equipment          PRIMEQ   4
c              simulations.                                                     PRIMEQ   5
c                                                                               PRIMEQ   6
c              Called sequentially for each primary loop                        PRIMEQ   7
c                                                                               PRIMEQ   8
c                                                                               PRIMEQ   9
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /EQUIPD/ EQload, EQrun, EQhgb, OperCap, Frac,                     /EQUIPD/ 2
     &                 PLR, EQsupplyT, Tcond,                                   Chlr1    1
     &                 EIRPLR, EIRFT, EQEIR, EQelec, EQfanKW, EQaux,            /EQUIPD/ 4
     &                 HIRPLR, HIRFT, EQHIR, EQfuel, EQcond, EQrecvr,           /EQUIPD/ 5
     &                 HWflow, HWhead, CHWflow, CHWhead, CWflow, CWhead,        /EQUIPD/ 6
     &                 HTRECflow,HTREChead, Qenvir, EQstart, EQloadH,           -041d    1
     &                 EQstartH, PLRh, FracH, EQfuelH, EQelecH                  /EQUIPD/ 8
      REAL             EQUIPDAT(36)                                             /EQUIPD/10
      EQUIVALENCE      (EQUIPDAT(1), EQload), (Tambient, Tcond)                 FreeCl   1
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /LOOP  / Nloop(16,2), NextType(40), NLP2,                         -41a     1
     &                 WLHPoff, RealCall, RegenFlag, Sim2x, LoopSimCount        ChlrHP   2
      LOGICAL          WLHPoff, RealCall, RegenFlag, Sim2x                      ChlrHP   3
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /TWRDAT/ TWRload,TCAP,TWRrej,CWgpm,TWRgpm,TWRsupply,              /TWRDAT/ 2
     &                 TWRset,Ttower,RANGE,APP,twr1FRA,GPMra,GPMcap,            /TWRDAT/ 3
     &                 GPMcell,NumCells,MinCells,MaxCells,Ttop,GPMtop,          /TWRDAT/ 4
     &                 Tbot,GPMbot,CFMra,FankWr,FankW,TWRaux,QpanLoss,          -034     2
     &                 QcoilLoss, SpraykW, Twet1, Tstart                        /TWRDAT/ 6
      DIMENSION        TWRSAV(25)                                               /TWRDAT/ 7
      EQUIVALENCE     (TWRSAV(1),TWRload)                                       /TWRDAT/ 8
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               PRIMEQ  25
      COMMON  /CHLRKY/ ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 2
     &                 WaterCool, AirCool                                       /CHLRKY/ 3
      INTEGER          ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 4
     &                 WaterCool, AirCool                                       /CHLRKY/ 5
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
      COMMON  /SimAlg/ Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/ 2
     &                 Electrical,                                              /SIMALG/ 3
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/ 4
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/ 5
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   2
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/ 7
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/ 8
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/ 9
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/10
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    3
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    4
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    5
     &                 Ground_LoopVert_H2,Ground_LoopHoriz_H,                   -044d    6
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/14
      INTEGER          Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/15
     &                 Electrical,                                              /SIMALG/16
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/17
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/18
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   3
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/20
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/21
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/22
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/23
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    7
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    8
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    9
     &                 Ground_LoopVert_H2, Ground_LoopHoriz_H,                  -044d   10
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/27
      COMMON  /TWRKY / Open, OpenHX, FluidCool,                                 /TWRKY/  2
     &                 Bypass, Speed1, Speed2, SpeedV, Damper,                  /TWRKY/  3
     &                 RunMinCells, RunMaxCells,                                /TWRKY/  4
     &                 ElecPanHtr, NoPanHtr, HWPanHtr,                          /TWRKY/  5
     &                 CycleWithFan, StayOn                                     /TWRKY/  6
      INTEGER          Open, OpenHX, FluidCool,                                 /TWRKY/  7
     &                 Bypass, Speed1, Speed2, SpeedV, Damper,                  /TWRKY/  8
     &                 RunMinCells, RunMaxCells,                                /TWRKY/  9
     &                 ElecPanHtr, NoPanHtr, HWPanHtr,                          /TWRKY/ 10
     &                 CycleWithFan, StayOn                                     /TWRKY/ 11
c                                                                               PRIMEQ  31
      REAL      LoopLoad, LoadMet                                               PRIMEQ  33
      INTEGER   EquipClass                                                      PRIMEQ  34
      LOGICAL   LoadSatisfied                                                   PRIMEQ  35
c                                                                               PRIMEQ  36
c                                                                               PRIMEQ  42
c              Note that heating loads are treated as negative values,          PRIMEQ  43
c              and cooling or heat rejection loads are positive.  For           PRIMEQ  44
c              the purposes of allocating loads, heating loads are              PRIMEQ  45
c              temporarily converted to positive values.                        PRIMEQ  46
c                                                                               PRIMEQ  47
      LoopType      = <lp:TYPE>                                                 PRIMEQ  49
      LoopCtrl      = <lp;CTRL_MODE>                                            PRIMEQ  50
      QhtrecDW      = 0                                                         PRIMEQ  51
      Jlpsave       = Jlp                                                       BUGS    62
c                                                                               BUGS    63
c              Get loop load and flow                                           BUGS    64
      IF (RealCall)  THEN                                                       BUGS    65
c              Normal call - note that if this is an estimation call,           BUGS    66
c              these variables were set in the calling routine                  BUGS    67
        QloopNet = <lp;Q_NET>                                                   BUGS    68
        GPMs     = <lp;GPM>                                                     BUGS    69
        GPMr     = <lp;GPMr>                                                    BUGS    70
        Tsupply  = <lp;SUPPLY_T>                                                BUGS    71
        Treturn  = <lp;RETURN_T>                                                BUGS    72
      ELSE   ! estimated return temperature                                     BUGS    73
        IF (GPMr .GT. 0.  .AND.  LoopType .NE. DHW)  THEN                       BUGS    74
          Treturn = Tsupply + QloopNet/(<lp;BTUH/GPM-F>*GPMr)                   BUGS    75
        ELSE                                                                    BUGS    76
          Treturn = Tsupply                                                     BUGS    77
        ENDIF                                                                   BUGS    78
      ENDIF                                                                     BUGS    79
                                                                                -048d    9
c              If DHW adjust return T for makeup water                          -048d   10
      IF (LoopType .eq. DHW  .and.  GPMs .GT. 0.)                               -048d   11
     &  Treturn = (Treturn*GPMr + <lp;INLET_T>*(GPMs-GPMr)) / GPMs              -048d   12
c                                                                               FreeCl  74
c              Initialize equipment                                             FreeCl  75
      Neq = <lp;NUM_EQUIP&TES>                                                  FreeCl  76
      DO  IQ=1,Neq                                                              FreeCl  77
        Jpe               = <lp;Jpe>     ! equipment pointer                    FreeCl  78
        <pe;MAX_CAPACITY> = 0.                                                  FreeCl  79
        <pe;LOAD>         = 0.                                                  FreeCl  80
        <pe;GPM>          = 0.                                                  FreeCl  81
        <pe;SUPPLY_T>     = Tsupply                                             FreeCl  82
      ENDDO                                                                     FreeCl  83
c              initialize steam and chilled-water meters, if any                FreeCl  84
      IF (<lp;STEAM_METER> .GT. 0)  THEN                                        FreeCl  85
        Jme       = <lp;STEAM_METER>                                            FreeCl  86
        <me;LOAD> = 0.                                                          FreeCl  87
        <me;GPM>  = 0.                                                          FreeCl  88
      ENDIF                                                                     FreeCl  89
      IF (<lp;CHW_METER> .GT. 0)  THEN                                          FreeCl  90
        Jme       = <lp;CHW_METER>                                              FreeCl  91
        <me;LOAD> = 0.                                                          FreeCl  92
        <me;GPM>  = 0.                                                          FreeCl  93
      ENDIF                                                                     FreeCl  94
      Jme = 0                                                                   FreeCl  95
c                                                                               -042j2 205
c              Adjust net load for heat recovery or free cooling.               -042j2 206
c              First, free cooling                                              -042j2 207
      IF (<lp;FreeCoolChlr> .GT. 0 .AND.  GPMs .GT. 0.)  THEN                   -042j2 208
c              CHW loop with free cooling                                       -042j2 209
        Jch     = <lp;FreeCoolChlr>                                             -042j2 210
        Jpe     = <ch;Jpe>                                                      -042j2 211
        SimCtrl = 11                                                            -042j2 212
        CALL Chiller_FreeCool                                                   -042j2 213
        <lp;Q_HTREC> = <pe;LOAD>                                                -042j2 214
      ELSEIF (<lp;FreeCoolChlr> .LT. 0  .AND.  RealCall)  THEN                  -042j2 215
c              CW loop with free cooling                                        -042j2 216
        ICWctrl            = <lp:CL-SETPT-CTRL>                                 -042j2 217
        <lp:CL-SETPT-CTRL> = 1               ! Fixed                            -042j2 218
        CWrng              = <lp:SETPT-RNG>                                     -042j2 219
        <lp:SETPT-RNG>     = 0.1                                                -042j2 220
      ENDIF                                                                     -042j2 221
c              Next, equipment which passively provides heat, such              FreeCl 113
c              as chillers                                                      FreeCl 114
      Qhtrec = <lp;Q_HTREC> + <lp;CogenHtrec>                                   BUGS    83
      IF (Qhtrec .NE. 0.) THEN                                                  BUGS    84
        IF (QloopNet .NE. 0.)  THEN                                             BUGS    85
c              Assume heat recovery can handle entire load if >= 98%            BUGS    86
          IF (Qhtrec/QloopNet .GT. 0.98)  Qhtrec = QloopNet                     BUGS    87
          QloopNet = QloopNet - Qhtrec                                          BUGS    88
        ELSE                                                                    BUGS    89
          Qhtrec   = 0.                                                         BUGS    90
        ENDIF                                                                   BUGS    91
      ENDIF                                                                     BUGS    92
c              Next, equipment that can actively provide heat,                  BUGS    93
c              such as cogeneration, when not controlled via                    BUGS    94
c              an EQUIP-CTRL command                                            BUGS    95
      IF (<lp;NumHtRcvr> .GT. 0  .AND.  LoopCtrl .EQ. HEATMODE                  BUGS    96
     &  .AND. QloopNet .LT. 0. .AND.  <lp;HT_EQUIP_CTRL> .EQ. 0)  THEN          BUGS    97
        CALL EquipCtrlDefaultHtrec(-QloopNet,CapRcvr)                           BUGS    98
        Qrcvr    = MAX(-CapRcvr, QloopNet)                                      BUGS    99
        QloopNet = QloopNet - Qrcvr                                             BUGS   100
        Qhtrec   = Qhtrec   + Qrcvr                                             BUGS   101
      ELSE                                                                      BUGS   102
        Qrcvr    = 0.                                                           BUGS   103
      ENDIF                                                                     BUGS   104
c              Return temperature after heat recovery or free cooling           BUGS   105
      IF (GPMs .NE. 0.)  THEN                                                   BUGS   106
        Thtrec = Treturn - Qhtrec/(<lp;BTUH/GPM-F>*GPMs)                        BUGS   107
      ELSE                                                                      BUGS   108
        Thtrec = Treturn                                                        BUGS   109
      ENDIF                                                                     BUGS   110
c                                                                               BUGS   111
c              Set flag to indicate loop is rejecting heat to towers            BUGS   112
      IF ((LoopType .EQ. CW  .OR.  LoopType .EQ. WLHP)                          BUGS   113
     &                              .AND.  LoopCtrl .EQ. COOLMODE)  THEN        BUGS   114
        HeatRejMode = .TRUE.                                                    BUGS   115
      ELSE                                                                      BUGS   116
        HeatRejMode = .FALSE.                                                   BUGS   117
      ENDIF                                                                     BUGS   118
c              Set return temperature                                           FreeCl 115
      DO  IQ=1,Neq                                                              FreeCl 116
        Jpe           = <lp;Jpe>     ! equipment pointer                        FreeCl 117
        <pe;RETURN_T> = Thtrec                                                  FreeCl 118
      ENDDO                                                                     FreeCl 119
c                                                                               BUGS   142
c              Skip if loop is off                                              BUGS   143
      IF (LoopCtrl .EQ. OffMode)   GOTO 500                                     BUGS   144
c              store supply temperature for next hour estimate                  PV2     22
      IF (LoopType .EQ. CHW)  <lp;COIL_EWTest> = Tsupply                        PV2     23
c              Set the load to be distributed                                   BUGS   145
      IF (HeatRejMode)  THEN                                                    BUGS   146
c              the load on a condenser loop is the loop flow                    BUGS   147
        LoopLoad = GPMs                                                         BUGS   148
      ELSE                                                                      BUGS   149
c              make negative heating loads positive                             BUGS   150
        LoopLoad = ABS(QloopNet)                                                BUGS   151
      ENDIF                                                                     BUGS   152
c              skip to flow allocation if floating                              BUGS   153
      IF (LoopCtrl .EQ. Floating)  GOTO 200                                     BUGS   154
c              Free cooling is all or nothing                                   FreeCl 120
      IF (<lp;FreeCoolChlr> .GT. 0 .AND. <lp;Q_HTREC> .GT. 0.)  GOTO 200        FreeCl 121
c              Force loop load to be non-zero unless heat recovery meets        BUGS   155
c              entire demand                                                    BUGS   156
      IF (Qhtrec .EQ. 0.)  LoopLoad = MAX(LoopLoad, 1.0)                        BUGS   157
c                                                                               PRIMEQ 147
c                                                                               PRIMEQ 148
c============= GET OPERATING CAPACITIES OF PRIMARY EQUIPMENT ================== PRIMEQ 149
c              SimCtrl = 11  Hourly equipment operating capacities              PRIMEQ 150
      SimCtrl = 11                                                              PRIMEQ 151
c              Determine the hourly operating capacity for each                 PRIMEQ 152
c              piece of equipment attached to this loop                         PRIMEQ 153
      Neq = <lp;NUM_EQUIP&TES>                                                  PRIMEQ 154
      DO  IQ=1,Neq                                                              PRIMEQ 155
c              pointer to equipment                                             PRIMEQ 156
        Jpe = <lp;Jpe>                                                          PRIMEQ 157
        EquipClass = <pe:ALGORITHM>/100                                         PRIMEQ 158
        SELECT CASE (EquipClass)                                                PRIMEQ 159
c                                                                               PRIMEQ 160
          CASE (1)             ! COOLING EQUIPMENT                              PRIMEQ 161
            IF (LoopCtrl .EQ. COOLMODE)  THEN                                   PRIMEQ 162
              SELECT CASE (<pe:ALGORITHM>)                                      PRIMEQ 163
                CASE (101)     ! Centrifugal/reciprocating                      PRIMEQ 164
                  Jch = <pe;Jparent>                                            PRIMEQ 165
                  CALL Chiller_Elec_1                                           PRIMEQ 166
                CASE (102)     ! Spare electric chiller                         PRIMEQ 167
                CASE (103)     ! Absorption (hot water/steam)                   PRIMEQ 168
                  Jch = <pe;Jparent>                                            PRIMEQ 169
                  CALL Chiller_Absor_1                                          PRIMEQ 170
                CASE (104)     ! Gas absorption                                 PRIMEQ 171
                  Jch = <pe;Jparent>                                            PRIMEQ 172
                  CALL Chiller_Gas_1(2)                                         PRIMEQ 173
                CASE (105)     ! Engine driven                                  PRIMEQ 174
                  Jch = <pe;Jparent>                                            PRIMEQ 175
                  CALL Chiller_Engine_1                                         PRIMEQ 176
                CASE (106)     ! Heat-pump chiller                              ChlrHP 984
                  Jch = <pe;Jparent>                                            ChlrHP 985
                  CALL Chiller_HP_1(2)                                          ChlrHP 986
                CASE (107)     ! Loop-to-loop heat-pump                         ChlrHP 987
                  Jch = <pe;Jparent>                                            ChlrHP 988
                  CALL Chiller_LoopHP_1(2)                                      ChlrHP 989
                CASE (181)     ! TES cold Btu bucket                            PRIMEQ 177
                  Jtk = <pe;Jparent>                                            PRIMEQ 178
                  CALL TES_ColdTank_1(2)                                        PRIMEQ 179
              END SELECT                                                        PRIMEQ 180
            ELSEIF (LoopCtrl .EQ. HEATMODE)  THEN                               PRIMEQ 181
              Jch = <pe;Jparent>                                                ChlrHP 990
              SELECT CASE (<ch:ALGORITHM>)                                      ChlrHP 991
                CASE (104)     ! Chiller/heater                                 ChlrHP 992
                  IF (<pe:ALGORITHM> .EQ. 199)  CALL Chiller_Gas_1(1)           ChlrHP 993
                CASE (106)     ! Heat-pump chiller                              ChlrHP 994
                  CALL Chiller_HP_1(1)                                          ChlrHP 995
                CASE (107)     ! Loop-to-loop heat-pump                         ChlrHP 996
                  IF (<pe:ALGORITHM> .EQ. 199)  CALL Chiller_LoopHP_1(1)        ChlrHP 997
              END SELECT                                                        ChlrHP 998
            ENDIF                                                               PRIMEQ 187
c                                                                               PRIMEQ 188
          CASE (2)             ! HEATING EQUIPMENT                              PRIMEQ 189
            IF (LoopCtrl .EQ. HEATMODE)  THEN                                   PRIMEQ 190
              SELECT CASE (<pe:ALGORITHM>)                                      PRIMEQ 191
                CASE (201)     ! Hot water boiler                               PRIMEQ 192
                  Jbl = <pe;Jparent>                                            PRIMEQ 193
                  CALL Boiler_HW_1                                              PRIMEQ 194
                CASE (202)     ! Condensing                                     -045k   12
                  Jbl = <pe;Jparent>                                            -045o    1
                  CALL Boiler_HW_Cond                                           -045k   13
                CASE (281)     ! TES hot Btu bucket                             PRIMEQ 196
                  Jtk = <pe;Jparent>                                            PRIMEQ 197
                  CALL TES_HotTank_1(2)                                         PRIMEQ 198
                CASE (291)     ! Ground-loop HX - Scheduled temp                PRIMEQ 199
                  Jgl = <pe;Jparent>                                            PRIMEQ 200
                  CALL GLHX_Scheduled(1)                                        PRIMEQ 201
                CASE (292,294) ! Ground-loop HX - Vertical well field           -044d  138
                  Jgl = <pe;Jparent>                                            PRIMEQ 203
                  CALL GLHX_Vertical(1,1)                                       PRIMEQ 204
                CASE (293)     ! Ground-loop HX - Horizontal trenches           PRIMEQ 205
                  Jgl = <pe;Jparent>                                            PRIMEQ 206
                  CALL GLHX_Horizontal(1,1)                                     PRIMEQ 207
              END SELECT                                                        PRIMEQ 208
            ENDIF                                                               PRIMEQ 209
c                                                                               PRIMEQ 210
          CASE (3)             ! DW HEATING EQUIPMENT                           PRIMEQ 211
            SELECT CASE (<pe:ALGORITHM>)                                        PRIMEQ 212
              CASE (301)       ! Conventional                                   PRIMEQ 213
                Jdw = <pe;Jparent>                                              PRIMEQ 214
                CALL DW_Heater_1                                                PRIMEQ 215
              CASE (302)       ! Heat Pump                                      PRIMEQ 216
                Jdw = <pe;Jparent>                                              PRIMEQ 217
                CALL DW_Heater_2                                                PRIMEQ 218
            END SELECT                                                          PRIMEQ 219
c                                                                               PRIMEQ 220
          CASE (4)             ! HEAT REJECTION                                 PRIMEQ 221
c              Note that the loop GPM is allocated to towers, not load.         PRIMEQ 222
c              This is because a tower may have a very large capacity           PRIMEQ 223
c              when the wetbulb is low, however the load the tower can          PRIMEQ 224
c              handle may be limited by the maximum flowrate the tower          PRIMEQ 225
c              can accept.                                                      PRIMEQ 226
            SELECT CASE (<pe:ALGORITHM>)                                        ChlrHP 999
              CASE (401)     ! Open towers                                      ChlrHP1000
                IF (LoopCtrl .EQ. COOLMODE)  THEN                               ChlrHP1001
                  Jtw = <pe;Jparent>                                            ChlrHP1002
                  CALL CoolingTwr_1                                             ChlrHP1003
                ENDIF                                                           ChlrHP1004
              CASE (402)     ! Fluid Coolers                                    ChlrHP1005
                IF (LoopCtrl .EQ. COOLMODE)  THEN                               ChlrHP1006
                  Jtw = <pe;Jparent>                                            ChlrHP1007
                  Call FluidCooler_1                                            ChlrHP1008
                ENDIF                                                           ChlrHP1009
              CASE (403)     ! Dry Coolers                                      ChlrHP1010
                IF (LoopCtrl .EQ. COOLMODE)  THEN                               ChlrHP1011
                  Jtw = <pe;Jparent>                                            ChlrHP1012
                  Call DryCooler_1                                              ChlrHP1013
                ENDIF                                                           ChlrHP1014
              CASE (491)     ! Ground-loop HX - Scheduled temp                  ChlrHP1015
                IF (HeatRejMode) THEN                                           -047k   71
                  Jgl = <pe;Jparent>                                            -047k   72
                  CALL GLHX_Scheduled(2)                                        -047k   73
                ENDIF                                                           -047k   74
                                                                                -047k   75
              CASE (492,494) ! Ground-loop HX - Vertical well field             -047k   76
                IF (HeatRejMode) THEN                                           -047k   77
                  Jgl = <pe;Jparent>                                            -047k   78
                  CALL GLHX_Vertical(2,1)                                       -047k   79
                ENDIF                                                           -047k   80
                                                                                -047k   81
              CASE (493)     ! Ground-loop HX - Horizontal trenches             -047k   82
                IF (HeatRejMode) THEN                                           -047k   83
                  Jgl = <pe;Jparent>                                            -047k   84
                  CALL GLHX_Horizontal(2,1)                                     -047k   85
                ENDIF                                                           -047k   86
                                                                                -047k   87
            END SELECT                                                          ChlrHP1024
        END SELECT  ! EquipClass                                                PRIMEQ 249
      ENDDO  ! operating capacity loop                                          PRIMEQ 250
c                                                                               PRIMEQ 251
c                                                                               PRIMEQ 252
c============= ALLOCATE LOAD TO PRIMARY EQUIPMENT ============================= PRIMEQ 253
c              Allocation may be by default, or thru an EQUIPMENT-CTRL          PRIMEQ 254
c                                                                               PRIMEQ 268
      IF (LoopCtrl .EQ. HEATMODE)  THEN                                         PRIMEQ 269
        IF (<lp;HT_EQUIP_CTRL> .GT. 0)  THEN                                    PRIMEQ 270
c              Allocate load using EQUIPMENT-CTRL                               PRIMEQ 271
          Jec = <lp;HT_EQUIP_CTRL>                                              PRIMEQ 272
          CALL EquipCtrl(LoopLoad, TotalLoopCap, LoadSatisfied)                 PRIMEQ 273
c              amount of LoopLoad contributed by heat recovery equip            PRIMEQ 274
          IF (<lp;NumHtRcvr> .GT. 0)  THEN                                      PRIMEQ 275
            Neq = <lp;NumHtRcvr>                                                PRIMEQ 276
            DO  IQ=1,Neq                                                        PRIMEQ 277
              Jpe    = <lp;Jpe_HtRcvr>                                          PRIMEQ 278
              Qrcvr  = Qrcvr - <pe;LOAD>                                        PRIMEQ 279
            ENDDO                                                               PRIMEQ 280
            QloopNet = QloopNet - Qrcvr                                         PRIMEQ 281
            Qhtrec   = Qhtrec   + Qrcvr                                         PRIMEQ 282
          ENDIF                                                                 PRIMEQ 283
        ELSE                                                                    PRIMEQ 284
c              Allocate load by default                                         PRIMEQ 285
          CALL EquipCtrlDefault(Neq, LoopLoad, TotalLoopCap,                    PRIMEQ 286
     &                                         LoadSatisfied)                   PRIMEQ 287
        ENDIF                                                                   PRIMEQ 288
c              steam meter pointer                                              PRIMEQ 289
        Jme = <lp;STEAM_METER>                                                  PRIMEQ 290
      ELSEIF (LoopCtrl .EQ. COOLMODE)  THEN                                     PRIMEQ 291
        IF (<lp;CL_EQUIP_CTRL> .GT. 0)  THEN                                    PRIMEQ 292
c              Allocate load using EQUIPMENT-CTRL                               PRIMEQ 293
          Jec = <lp;CL_EQUIP_CTRL>                                              PRIMEQ 294
          CALL EquipCtrl(LoopLoad, TotalLoopCap, LoadSatisfied)                 PRIMEQ 295
        ELSE                                                                    PRIMEQ 296
c              Allocate load by default                                         PRIMEQ 297
          CALL EquipCtrlDefault(Neq, LoopLoad, TotalLoopCap,                    PRIMEQ 298
     &                                         LoadSatisfied)                   PRIMEQ 299
        ENDIF                                                                   PRIMEQ 300
c              chw meter pointer                                                PRIMEQ 301
        Jme = <lp;CHW_METER>                                                    PRIMEQ 302
      ENDIF    !LoopCtrl                                                        PRIMEQ 303
c                                                                               PRIMEQ 304
c              meter load - dont assign any more to meter                       PRIMEQ 305
c              if already assigned in EquipCtrl                                 PRIMEQ 306
      IF (.NOT. LoadSatisfied  .AND.  Jme .GT. 0                                PRIMEQ 307
     &                         .AND.  <me;LOAD> .EQ. 0.)  THEN                  PRIMEQ 308
        <me;LOAD> = MAX(0., MIN(<me;MAX_CAPACITY>,                              PRIMEQ 309
     &                              LoopLoad-TotalLoopCap))                     PRIMEQ 310
c              increment total loop capacity enabled                            PRIMEQ 311
        TotalLoopCap = TotalLoopCap + <me;MAX_CAPACITY>                         PRIMEQ 312
        IF (TotalLoopCap .GE. LoopLoad)  LoadSatisfied = .TRUE.                 PRIMEQ 313
      ENDIF                                                                     PRIMEQ 314
c                                                                               PRIMEQ 315
c              thermal storage demands                                          PRIMEQ 316
      IF (<lp;TES_CHRG_GPM> .GT. 0.  .and.  .NOT. LoadSatisfied)  THEN          -042    37
c              loop is overloaded - cut down on TES charging demands            -042    38
c              charging load and overload                                       -042    39
        Qchrg = <lp;TES_CHRG_HEAT> + <lp;TES_CHRG_COOL>                         -042    40
        Qover = LoopLoad - TotalLoopCap                                         -042    41
        IF (Qchrg .lt. 0.)  THEN                                                -042    42
          Qover = Max(Qover, Qchrg)                                             -042    43
        ELSE                                                                    -042    44
          Qover = Min(Qover, Qchrg)                                             -042    45
        ENDIF                                                                   -042    46
c              adjust loop quantities                                           -042    47
        LoopLoad   = LoopLoad - Qover                                           -042    48
        QloopNet   = QloopNet - Qover                                           -042    49
        <lp;Q_NET> = QloopNet                                                   -042    50
c              adjust TES loads                                                 -042    51
        IF (Qchrg .lt. 0.)  THEN                                                -042    52
          <lp;TES_CHRG_HEAT> = <lp;TES_CHRG_HEAT> - Qover                       -042    53
        ELSE                                                                    -042    54
          <lp;TES_CHRG_COOL> = <lp;TES_CHRG_COOL> - Qover                       -042    55
        ENDIF                                                                   -042    56
c              note that lp;CHRG_CAP_RATI might have been reduced               -042    57
c              from 1.0 in LoopSim based on a flow overload                     -042    58
        dQchrg             = 1.0 - Qover/Qchrg                                  -042    59
        <lp;CHRG_CAP_RATI> = <lp;CHRG_CAP_RATI> * dQchrg                        -042    60
c              adjust flows                                                     -042    61
        dGPM      = <lp;TES_CHRG_GPM> * (Qover/Qchrg)                           -042    62
        GPMs      = GPMs      - dGPM                                            -042    63
        GPMr      = GPMr      - dGPM                                            -042    64
        <lp;GPM>  = <lp;GPM>  - dGPM                                            -042    65
        <lp;GPMr> = <lp;GPMr> - dGPM                                            -042    66
        <lp;TES_CHRG_GPM> = <lp;TES_CHRG_GPM> - dGPM                            -042    67
        IF (LoopLoad*0.99 .LT. TotalLoopCap)  LoadSatisfied = .TRUE.            -042    68
      ENDIF                                                                     -042    69
c                                                                               PRIMEQ 346
c                                                                               PRIMEQ 347
c============= ALLOCATE FLOW TO PRIMARY EQUIPMENT ============================= PRIMEQ 348
c              First, get design flow thru equipment that is operating          PRIMEQ 349
c              and determine if the equipment imposes any static head           PRIMEQ 350
c              on the loop                                                      PRIMEQ 351
  200 DesEqGPM    = 0.                                                          BUGS   158
      DesEqMaxGPM = 0.                                                          PRIMEQ 353
      HeadMax     = 0.                                                          PRIMEQ 354
      StaticMax   = 0.                                                          PRIMEQ 355
      Neq         = <lp;NUM_EQUIP>                                              PRIMEQ 356
      DO  IQ=1,Neq                                                              PRIMEQ 357
        Jpe = <lp;Jpe>                                                          PRIMEQ 358
c              note that currently all equipment is forced to                   PRIMEQ 359
c              have an isolation valve                                          PRIMEQ 360
        IF (<pe;LOAD> .NE. 0.  .OR.  <pe:ISOLATION> .EQ. No)  THEN              PRIMEQ 361
          DesEqGPM    = DesEqGPM    + <pe;DES_GPM>                              PRIMEQ 362
          DesEqMaxGPM = DesEqMaxGPM + <pe;MAX_GPM>                              PRIMEQ 363
          IF (<pe;Jpm> .EQ. 0)  THEN                                            PRIMEQ 364
c              loop gets the primary equipment head if no attached pump         PRIMEQ 365
            HeadMax   = MAX(HeadMax  ,   <pe;DES_HEAD>)                         PRIMEQ 366
            StaticMax = MAX(StaticMax, <pe;DES_STATIC>)                         PRIMEQ 367
          ENDIF                                                                 PRIMEQ 368
        ENDIF                                                                   PRIMEQ 369
      ENDDO                                                                     PRIMEQ 370
c              flow to be allocated                                             PRIMEQ 371
      GPMallocate = GPMs                                                        Sync    68
c              Now allocate the flow (towers were already allocated on          PRIMEQ 373
c              the basis of flow)                                               PRIMEQ 374
      IF (.NOT. HeatRejMode)  THEN                                              PRIMEQ 375
c              if cold storage tank                                             PRIMEQ 376
        IF (<lp;COLD_STORAGE> .GT. 0)  THEN                                     PRIMEQ 377
          Jpe = <lp;COLD_STORAGE>                                               PRIMEQ 378
          IF (<pe;LOAD> .GT. 0.)  THEN                                          PRIMEQ 379
c              calc flow separately from other equipment as                     PRIMEQ 380
c              load may not have been prorated                                  PRIMEQ 381
            GPM         = GPMallocate * <pe;LOAD> / LoopLoad                    PRIMEQ 382
            <pe;GPM>    = GPM                                                   PRIMEQ 383
            GPMallocate = GPMallocate - GPM                                     PRIMEQ 384
            HeadMax     = MAX(HeadMax  ,   <pe;DES_HEAD>)                       PRIMEQ 385
            StaticMax   = MAX(StaticMax, <pe;DES_STATIC>)                       PRIMEQ 386
          ENDIF                                                                 PRIMEQ 387
        ENDIF                                                                   PRIMEQ 388
c              if hot storage tank                                              PRIMEQ 389
        IF (<lp;HOT_STORAGE> .GT. 0)  THEN                                      PRIMEQ 390
          Jpe = <lp;HOT_STORAGE>                                                PRIMEQ 391
          IF (<pe;LOAD> .GT. 0.)  THEN                                          PRIMEQ 392
c              calc flow separately from other equipment as                     PRIMEQ 393
c              load may not have been prorated                                  PRIMEQ 394
            GPM         = GPMallocate * <pe;LOAD> / LoopLoad                    PRIMEQ 395
            <pe;GPM>    = GPM                                                   PRIMEQ 396
            GPMallocate = GPMallocate - GPM                                     PRIMEQ 397
            HeadMax     = MAX(HeadMax  ,   <pe;DES_HEAD>)                       PRIMEQ 398
            StaticMax   = MAX(StaticMax, <pe;DES_STATIC>)                       PRIMEQ 399
          ENDIF                                                                 PRIMEQ 400
        ENDIF                                                                   PRIMEQ 401
c              steam or chw meter                                               PRIMEQ 402
        IF (Jme .GT. 0  .AND.  <me;LOAD> .GT. 0.)  THEN                         PRIMEQ 403
c              calc flow separately from other equipment as                     PRIMEQ 404
c              load may not have been prorated                                  PRIMEQ 405
          GPM    = GPMallocate * <me;LOAD> / LoopLoad                           PRIMEQ 406
          <me;GPM>    = GPM                                                     PRIMEQ 407
          GPMallocate = GPMallocate - GPM                                       PRIMEQ 408
          HeadMax     = MAX(HeadMax  ,   <me;DES_HEAD>)                         PRIMEQ 409
          StaticMax   = MAX(StaticMax, <me;DES_STATIC>)                         PRIMEQ 410
        ENDIF                                                                   PRIMEQ 411
        IF (GPMallocate .LT. 1.E-6)  THEN                                       -041j   39
c              nothing to allocate - heat recovery, storage or meter            -041j   40
c              must have provided all                                           -041j   41
        ELSEIF (DesEqGPM .gt. 0.)  THEN                                         -041j   42
          Prorate = GPMallocate / DesEqGPM                                      -041j   43
          DO  IQ=1,Neq                                                          -041j   44
            Jpe = <lp;Jpe>                                                      -041j   45
            IF (<pe;LOAD> .NE. 0.  .OR.  <pe:ISOLATION> .EQ. No)                -041j   46
     &        <pe;GPM> = <pe;DES_GPM> * Prorate                                 -041j   47
          ENDDO                                                                 -041j   48
        ENDIF                                                                   -041j   49
      ELSE                                                                      PRIMEQ 499
c              For towers, flow has already been allocated.  Check to see       PRIMEQ 500
c              if all flow was succesfully allocated.  It may not be if         PRIMEQ 501
c              the loop temperature setpoint is close to or below the           PRIMEQ 502
c              wetbulb, causing the tower capacity(s) to be small.  If so,      PRIMEQ 503
c              reallocate the flow based on the design tower flows.             PRIMEQ 504
        IF (.NOT. LoadSatisfied)  THEN                                          PRIMEQ 505
          DesEqGPM    = 0.                                                      PRIMEQ 506
          DesEqMaxGPM = 0.                                                      PRIMEQ 507
          HeadMax     = 0.                                                      PRIMEQ 508
          StaticMax   = 0.                                                      PRIMEQ 509
          Neq         = <lp;NUM_EQUIP>                                          PRIMEQ 510
          DO  IQ=1,Neq                                                          PRIMEQ 511
            Jpe = <lp;Jpe>                                                      PRIMEQ 512
            IF (<pe;LOAD> .EQ. 0.)  CYCLE                                       GLHX1  786
c              note that currently all equipment is forced to                   PRIMEQ 513
c              have an isolation valve                                          PRIMEQ 514
            DesEqGPM    = DesEqGPM    + <pe;DES_GPM>                            PRIMEQ 515
            DesEqMaxGPM = DesEqMaxGPM + <pe;MAX_GPM>                            PRIMEQ 516
            IF (<pe;Jpm> .EQ. 0)  THEN                                          PRIMEQ 517
c              loop gets the primary equipment head if no attached pump         PRIMEQ 518
              HeadMax   = MAX(HeadMax  ,   <pe;DES_HEAD>)                       PRIMEQ 519
              StaticMax = MAX(StaticMax, <pe;DES_STATIC>)                       PRIMEQ 520
            ENDIF                                                               PRIMEQ 521
          ENDDO                                                                 PRIMEQ 522
c              prorate flow to all towers                                       PRIMEQ 523
          DO  IQ=1,Neq                                                          PRIMEQ 524
            Jpe = <lp;Jpe>                                                      PRIMEQ 525
            IF (<pe;LOAD> .EQ. 0.)  CYCLE                                       GLHX1  787
            <pe;LOAD> = GPMs * <pe;DES_GPM>/DesEqGPM                            PRIMEQ 526
          ENDDO                                                                 PRIMEQ 527
c              end of tower flow re-allocation                                  PRIMEQ 528
        ENDIF                                                                   PRIMEQ 529
c              now allocate the load to the towers based on flow, and           PRIMEQ 530
c              switch the flow to the correct variable                          PRIMEQ 531
        IF (GPMs .GT. 0.)  THEN                                                 PRIMEQ 532
          DO  IQ=1,Neq                                                          GLHX1  788
            Jpe       = <lp;Jpe>                                                GLHX1  789
            <pe;GPM>  = <pe;LOAD>                                               GLHX1  790
            <pe;LOAD> = QloopNet * <pe;GPM>/GPMs                                GLHX1  791
          ENDDO                                                                 GLHX1  792
        ENDIF                                                                   PRIMEQ 548
      ENDIF  !HeatRejMode                                                       PRIMEQ 549
      <lp;SUP-SIDE_HEAD> = HeadMax                                              PRIMEQ 550
      <lp;SUP-SIDE_STAT> = StaticMax                                            PRIMEQ 551
c                                                                               PRIMEQ 552
c                                                                               PRIMEQ 553
c============= SIMULATE PUMPS ATTACHED TO LOOP ================================ PRIMEQ 554
c                                                                               PRIMEQ 555
c              skip if an estimation call as estimated load already             PRIMEQ 556
c              includes pump heat                                               PRIMEQ 557
      IF (.NOT. RealCall)  GOTO 500                                             BUGS   160
c              SimCtrl = 12  Hourly simulation                                  PRIMEQ 559
      SimCtrl = 12                                                              PRIMEQ 560
c                                                                               PRIMEQ 561
c              Now that primary equipment is selected, the primary              PRIMEQ 562
c              circulation pump(s), if any, can be simulated.  Note that        PRIMEQ 563
c              a pump(s) must exist to power the primary loop.  This            PRIMEQ 564
c              pump(s) may be attached directly to the primary loop, or         PRIMEQ 565
c              attached to each (and every) piece of primary plant              PRIMEQ 566
c              equipment on this loop (either supply side or demand side,       PRIMEQ 567
c              but never both).                                                 PRIMEQ 568
c              First, calculate the loop flow ratio and the friction in         PRIMEQ 569
c              the piping                                                       PRIMEQ 570
      PLRpipe  = MIN(1., MAX(0., GPMr/(<lp;DES_GPM>*<lp;RUN_FRACTION>)))        GLHX1  793
      PipeHead = <lp:PIPE-HEAD>*PLRpipe**1.8                                    PRIMEQ 572
c              Simulate circulation pump(s)                                     PRIMEQ 573
      IF (<lp:PUMP> .NE. 0)  THEN                                               PRIMEQ 574
c              loop has pumps directly attached                                 PRIMEQ 575
        Jpm = <lp:PUMP>                                                         PRIMEQ 576
c              primary equipment flow ratio relative to design                  PRIMEQ 577
        IF (DesEqGPM .GT. 0.)  THEN                                             PRIMEQ 578
          PLReq = MIN(1.,                                                       -041j   50
     &                MAX(0., GPMr/(DesEqGPM*<lp;RUN_FRACTION>)))               GLHX1  795
        ELSE                                                                    PRIMEQ 580
          PLReq = PLRpipe                                                       -041j   51
        ENDIF                                                                   PRIMEQ 582
c              supply-side primary equipment friction head created by flow      PRIMEQ 583
        PrimHead = (<lp;SUP-SIDE_HEAD>+<lp;HTREC_HEAD>)*PLReq**1.8              PRIMEQ 584
c                                                                               PRIMEQ 585
c              Calculate head required of pump to meet the setpoint             PRIMEQ 586
        IF (<lp:HD-SETPT-CTRL> .NE. FIXED)  THEN                                PRIMEQ 587
c              No fixed setpoint - set hourly to match the reqt. of the         PRIMEQ 588
c              worst case coil or secondary loop.  This scheme assumes          PRIMEQ 589
c              proportional + integral control so there is no throttling        PRIMEQ 590
c              range                                                            PRIMEQ 591
c                  worst demand                                                 PRIMEQ 592
          HDset = <lp;DEM-SIDE_HEAD> + <lp;DEM-SIDE_STAT>                       PRIMEQ 593
c                  piping losses                                                PRIMEQ 594
     &          + PipeHead           + <lp:STATIC-HEAD>                         PRIMEQ 595
c                  supply-side primary equipment                                PRIMEQ 596
     &          + PrimHead           + <lp;SUP-SIDE_STAT>                       PRIMEQ 597
c                  heat recovery/free cooling static                            PRIMEQ 598
     &                               + <lp;HTREC_STATIC>                        PRIMEQ 599
        ELSE                                                                    PRIMEQ 600
c              The pump is controlled to a fixed setpoint.  The setpoint        PRIMEQ 601
c              was calculated in the design routine, and is based on the        PRIMEQ 602
c              design heads of all components downstream of the sensor.         PRIMEQ 603
c              First, calculate the throttling range of the controller          PRIMEQ 604
          THR = <lp:HD-SETPT-RNG> * (0.5-PLRpipe)                               PRIMEQ 605
c              Calculate the head requested of the pump based on the            PRIMEQ 606
c              location of the sensor                                           PRIMEQ 607
          IF (<lp:HD-SENS-LOCN> .EQ. AtCoils)  THEN                             PRIMEQ 608
c              The differential pressure sensor is located toward the           PRIMEQ 609
c              coil end of the loop.                                            PRIMEQ 610
            HDset = <pm:HEAD-SETPT> + THR                                       PRIMEQ 611
c                    piping losses                                              PRIMEQ 612
     &            + PipeHead        + <lp:STATIC-HEAD>                          PRIMEQ 613
c                    supply-side primary equipment                              PRIMEQ 614
     &            + PrimHead        + <lp;SUP-SIDE_STAT>                        PRIMEQ 615
c                  heat recovery/free cooling static                            PRIMEQ 616
     &                              + <lp;HTREC_STATIC>                         PRIMEQ 617
          ELSEIF (<lp:HD-SENS-LOCN> .EQ. EnterLoop)  THEN                       PRIMEQ 618
c              sensor is located at beginning of loop                           PRIMEQ 619
            HDset = <pm:HEAD-SETPT> + THR                                       PRIMEQ 620
c                    supply-side primary equipment                              PRIMEQ 621
     &            + PrimHead        + <lp;SUP-SIDE_STAT>                        PRIMEQ 622
c                  heat recovery/free cooling static                            PRIMEQ 623
     &                              + <lp;HTREC_STATIC>                         PRIMEQ 624
          ELSE                                                                  PRIMEQ 625
c              sensor is located at pump                                        PRIMEQ 626
            HDset = <pm:HEAD-SETPT> + THR                                       PRIMEQ 627
          ENDIF                                                                 PRIMEQ 628
        ENDIF                                                                   PRIMEQ 629
c              simulate pump                                                    PRIMEQ 630
        PMPgpm    = <lp;PumpGPM>                                                GLHX1  796
        PMPset    = HDset                                                       PRIMEQ 632
c              net loop friction                                                PRIMEQ 633
c                  worst coil/2ndary     piping    primary equip                PRIMEQ 634
        Friction  = <lp;DEM-SIDE_HEAD> + PipeHead + PrimHead                    PRIMEQ 635
        PMPfric   = Friction                                                    PRIMEQ 636
c              net loop static                                                  PRIMEQ 637
        PMPstatic = <lp;DEM-SIDE_STAT> + <lp:STATIC-HEAD>                       PRIMEQ 638
     &                                 + <lp;SUP-SIDE_STAT>                     PRIMEQ 639
     &                                 + <lp;HTREC_STATIC>                      PRIMEQ 640
        HDpump    = Friction + <lp;DEM-SIDE_STAT> + <lp:STATIC-HEAD>            PRIMEQ 641
        PMPfrac   = <lp;RUN_FRACTION>                                           GLHX1  797
        CALL PUMP                                                               PRIMEQ 644
c              transfer pump quantities to loop common block                    PRIMEQ 645
        Qpump  = PMPQ                                                           PRIMEQ 646
        dTpump = PMPdT                                                          PRIMEQ 647
c              adjust loop flows if pump(s) could not meet                      PRIMEQ 648
c              flow/head requirements                                           PRIMEQ 649
        IF (PMPgpm .LT. <lp;PumpGPM>)  THEN                                     GLHX1  798
          dGPM = (PMPgpm-<lp;PumpGPM>) * <lp;RUN_FRACTION>                      GLHX1  799
          GPMr = GPMr + dGPM                                                    GLHX1  800
          GPMs = GPMs + dGPM                                                    GLHX1  801
        ENDIF                                                                   GLHX1  802
c              end of calcs for pumps attached directly to primary              PRIMEQ 653
      ELSE                                                                      PRIMEQ 654
c              attached equipment pumps power the primary                       PRIMEQ 655
        IF (<lp;NUM_DEM_PUMPS> .GT. 0)  THEN                                    PRIMEQ 656
c              to be here, a condenser water loop must be powered by            PRIMEQ 657
c              pumps attached to individual chiller chillers (NOT               PRIMEQ 658
c              individual towers).  Call the routine to simulate                PRIMEQ 659
c              pumps attached on the demand-side of a loop                      PRIMEQ 660
          CALL PUMPdemand                                                       PRIMEQ 661
          Qpump  =  QpumpEq                                                     PRIMEQ 662
          dTpump =  dTpumpEq                                                    PRIMEQ 663
c              rezero equipment level pump variables for use in                 PRIMEQ 664
c              equipment simulations (for recirculation pumps)                  PRIMEQ 665
          QpumpEq  =  0.                                                        PRIMEQ 666
          dTpumpEq = 0.                                                         PRIMEQ 667
        ENDIF                                                                   PRIMEQ 668
      ENDIF                                                                     PRIMEQ 669
c                                                                               PRIMEQ 670
c              Correct equipment loads for pump heat just calculated            PRIMEQ 671
c              PUMP_Q_PAST was last hours pump heat used as an estimate         PRIMEQ 672
c              in PLANT for this hours pump heat so that the load               PRIMEQ 673
c              could be calculated and distributed to equipment.  Now           PRIMEQ 674
c              that the pump energy is known exactly, adjust the load           PRIMEQ 675
c              on each equipment unit.  If supply-side pumps are used,          PRIMEQ 676
c              the pump heat will be added to the individual equipment          PRIMEQ 677
c              loads from within the equipment simulation algorithms            PRIMEQ 678
c              (Qpump below is zero in this case)                               PRIMEQ 679
      IF (ABS(QloopNet) .GE. 1.0  .and.                                         -041j   52
     &  (LoopType .NE. DHW  .OR.  <lp;RunDHWPump> .EQ. 1.))  THEN               -041j   53
        dQpump    = Qpump - <lp;PUMP_Q_PAST>                                    PRIMEQ 681
        dQloopNet = MAX(0., (QloopNet+dQpump) / QloopNet)                       PRIMEQ 682
        IF (LoopCtrl .EQ. HEATMODE)  THEN                                       PRIMEQ 683
          QloopNet = MIN(0., QloopNet + dQpump)                                 PRIMEQ 684
        ELSE                                                                    PRIMEQ 685
          QloopNet = MAX(0., QloopNet + dQpump)                                 PRIMEQ 686
        ENDIF                                                                   PRIMEQ 687
        QloopPump = Qpump                                                       PRIMEQ 688
c              If pump heat is enough to satisfy a very small heating           PRIMEQ 689
c              load, change the control mode to floating                        PRIMEQ 690
        IF (QloopNet .EQ. 0.)  THEN                                             PRIMEQ 691
          LoopCtrl       = FLOATING                                             PRIMEQ 692
          <lp;CTRL_MODE> = FLOATING                                             PRIMEQ 693
          dQloopNet      = 0.                                                   PRIMEQ 694
        ENDIF                                                                   PRIMEQ 695
c              correct equipment loads for pump heat                            PRIMEQ 696
        IF (LoopLoad .NE. 0.)  THEN                                             PRIMEQ 697
          Neq = <lp;NUM_EQUIP&TES>                                              ERV    203
          DO  IQ=1,Neq                                                          PRIMEQ 698
            Jpe = <lp;Jpe>                                                      PRIMEQ 699
            <pe;LOAD> = <pe;LOAD> * dQloopNet                                   PRIMEQ 700
          ENDDO                                                                 PRIMEQ 701
c              steam or chw meter                                               PRIMEQ 702
          IF (Jme .GT. 0)  <me;LOAD> = <me;LOAD> * dQloopNet                    PRIMEQ 703
        ENDIF                                                                   PRIMEQ 704
      ENDIF                                                                     PRIMEQ 705
c                                                                               PRIMEQ 711
c                                                                               PRIMEQ 712
c============= SIMULATE PRIMARY EQUIPMENT ===================================== PRIMEQ 713
c              SimCtrl = 12  Hourly simulation                                  PRIMEQ 714
  500 SimCtrl = 12                                                              PRIMEQ 715
c              All equipment attached to this loop must be simulated,           PRIMEQ 716
c              whether loaded or not, in order to account for                   PRIMEQ 717
c              auxiliary loads.  Note that 2-pipe and WLHP loops                PRIMEQ 718
c              have both heating and cooling/heat rejection equipment           PRIMEQ 719
c              attached, and both must be simulated.                            PRIMEQ 720
      LoadMet = 0.                                                              PRIMEQ 721
      LoadMet = 0.                                                              BUGS   161
      Teq     = 0.           ! weighted equipment outlet temperature            BUGS   162
      GPMeq   = 0.           ! weighted equipment flow                          BUGS   163
      Neq     = <lp;NUM_EQUIP&TES>                                              PRIMEQ 723
      DO  IQ=1,Neq                                                              PRIMEQ 724
c              pointer to equipment                                             PRIMEQ 725
        Jpe = <lp;Jpe>                                                          PRIMEQ 726
        EquipClass = <pe:ALGORITHM>/100                                         PRIMEQ 735
        SELECT CASE (EquipClass)                                                PRIMEQ 736
c                                                                               PRIMEQ 737
          CASE (1)           ! COOLING EQUIPMENT                                PRIMEQ 738
            SELECT CASE (<pe:ALGORITHM>)                                        PRIMEQ 739
              CASE (101)     ! Centrifugal/reciprocating                        PRIMEQ 740
                Jch = <pe;Jparent>                                              PRIMEQ 741
                CALL Chiller_Elec_1                                             PRIMEQ 742
              CASE (102)     ! Spare electric chiller                           PRIMEQ 743
              CASE (103)     ! Absorption (hot water/steam)                     PRIMEQ 744
                Jch = <pe;Jparent>                                              PRIMEQ 745
                CALL Chiller_Absor_1                                            PRIMEQ 746
              CASE (104)     ! Gas absorption                                   PRIMEQ 747
                Jch = <pe;Jparent>                                              PRIMEQ 748
                CALL Chiller_Gas_1(2)                                           PRIMEQ 749
              CASE (105)     ! Engine driven                                    PRIMEQ 750
                Jch = <pe;Jparent>                                              PRIMEQ 751
                CALL Chiller_Engine_1                                           PRIMEQ 752
              CASE (106)     ! Heat-pump chiller                                ChlrHP1025
                Jch = <pe;Jparent>                                              ChlrHP1026
                CALL Chiller_HP_1(LoopCtrl)                                     ChlrHP1027
              CASE (107)     ! Loop-to-loop heat-pump                           ChlrHP1028
                Jch = <pe;Jparent>                                              ChlrHP1029
                CALL Chiller_LoopHP_1(LoopCtrl)                                 ChlrHP1030
              CASE (108)     ! Free Cooling                                     FreeCl 122
                Jch = <pe;Jparent>                                              FreeCl 123
                CALL Chiller_FreeCool                                           FreeCl 124
              CASE (181)     ! TES cold Btu bucket                              PRIMEQ 753
                Jtk = <pe;Jparent>                                              PRIMEQ 754
                CALL TES_ColdTank_1(3)                                          PRIMEQ 755
              CASE (199)     ! Heating mode of chiller                          ChlrHP1031
                Jch = <pe;Jparent>                                              ChlrHP1032
                SELECT CASE (<ch:ALGORITHM>)                                    ChlrHP1033
                  CASE (104)     ! Chiller/heater                               ChlrHP1034
                    CALL Chiller_Gas_1(1)                                       ChlrHP1035
                  CASE (107)     ! Loop-to-loop heat-pump                       ChlrHP1036
                    CALL Chiller_LoopHP_1(1)                                    ChlrHP1037
                END SELECT                                                      ChlrHP1038
            END SELECT                                                          PRIMEQ 759
c                                                                               PRIMEQ 760
          CASE (2)           ! HEATING EQUIPMENT                                PRIMEQ 761
            SELECT CASE (<pe:ALGORITHM>)                                        PRIMEQ 762
              CASE (201)     ! Hot water boiler                                 PRIMEQ 763
                Jbl = <pe;Jparent>                                              PRIMEQ 764
                CALL Boiler_HW_1                                                PRIMEQ 765
              CASE (202)     ! Condensing                                       -045k   14
                Jbl = <pe;Jparent>                                              -045o    2
                CALL Boiler_HW_Cond                                             -045k   15
              CASE (281)     ! TES hot Btu bucket                               PRIMEQ 767
                Jtk = <pe;Jparent>                                              PRIMEQ 768
                CALL TES_HotTank_1(3)                                           PRIMEQ 769
              CASE (291)     ! Ground-loop HX - Scheduled temp                  PRIMEQ 770
                Jgl = <pe;Jparent>                                              PRIMEQ 771
                CALL GLHX_Scheduled(1)                                          PRIMEQ 772
              CASE (292,294) ! Ground-loop HX - Vertical well field             -044d  140
                Jgl = <pe;Jparent>                                              PRIMEQ 774
                CALL GLHX_Vertical(1,2)                                         PRIMEQ 775
              CASE (293)     ! Ground-loop HX - Horizontal trenches             PRIMEQ 776
                Jgl = <pe;Jparent>                                              PRIMEQ 777
                CALL GLHX_Horizontal(1,2)                                       PRIMEQ 778
            END SELECT                                                          PRIMEQ 779
c                                                                               PRIMEQ 780
          CASE (3)             ! DW HEATING EQUIPMENT                           PRIMEQ 781
            SELECT CASE (<pe:ALGORITHM>)                                        PRIMEQ 782
              CASE (301)     ! Conventional                                     PRIMEQ 783
                Jdw = <pe;Jparent>                                              PRIMEQ 784
                CALL DW_Heater_1                                                PRIMEQ 785
              CASE (302)     ! Heat Pump                                        PRIMEQ 786
                Jdw = <pe;Jparent>                                              PRIMEQ 787
                CALL DW_Heater_2                                                PRIMEQ 788
            END SELECT                                                          PRIMEQ 789
c              sum the recovered heat for heat recovered directly               PRIMEQ 790
c              to a DW-HEATER tank                                              PRIMEQ 791
            QhtrecDW = QhtrecDW + <dw;Q_RECVR>                                  PRIMEQ 792
c                                                                               PRIMEQ 793
          CASE (4)           ! HEAT REJECTION                                   PRIMEQ 794
c              Note that the loop GPM is allocated to towers, not load.         PRIMEQ 795
c              This is because a tower may have a very large capacity           PRIMEQ 796
c              when the wetbulb is low, however the load the tower can          PRIMEQ 797
c              handle may be limited by the maximum flowrate the tower          PRIMEQ 798
c              can accept.                                                      PRIMEQ 799
            SELECT CASE (<pe:ALGORITHM>)                                        PRIMEQ 800
              CASE (401)     ! Open towers                                      PRIMEQ 801
                Jtw = <pe;Jparent>                                              PRIMEQ 802
                CALL CoolingTwr_1                                               PRIMEQ 803
              CASE (402)     ! Fluid Coolers                                    PRIMEQ 804
                Jtw = <pe;Jparent>                                              PRIMEQ 805
                Call FluidCooler_1                                              PRIMEQ 806
              CASE (403)     ! Dry Coolers                                      PRIMEQ 807
                Jtw = <pe;Jparent>                                              PRIMEQ 808
                Call DryCooler_1                                                PRIMEQ 809
              CASE (491)     ! Ground-loop HX - Scheduled temp                  PRIMEQ 810
                Jgl = <pe;Jparent>                                              PRIMEQ 811
                CALL GLHX_Scheduled(2)                                          PRIMEQ 812
              CASE (492,494) ! Ground-loop HX - Vertical well field             -044d  141
                Jgl = <pe;Jparent>                                              PRIMEQ 814
                CALL GLHX_Vertical(2,2)                                         PRIMEQ 815
              CASE (493)     ! Ground-loop HX - Horizontal trenches             PRIMEQ 818
                Jgl = <pe;Jparent>                                              PRIMEQ 819
                CALL GLHX_Horizontal(2,2)                                       PRIMEQ 820
            END SELECT                                                          PRIMEQ 823
        END SELECT  ! EquipClass                                                PRIMEQ 824
c                                                                               PRIMEQ 825
c              sum the loads                                                    PRIMEQ 826
        LoadMet = LoadMet + <pe;LOAD>                                           PRIMEQ 827
c              average temperature from all components                          PRIMEQ 828
        GPMeq = GPMeq + <pe;GPM>                                                BUGS   164
        Teq   = Teq   + <pe;GPM> * <pe;SUPPLY_T>                                BUGS   165
      ENDDO    ! equipment simulations                                          PRIMEQ 830
c                                                                               PRIMEQ 831
      IF (LoopCtrl .NE. COOLMODE)  THEN                                         PRIMEQ 832
c              include meter energy                                             PRIMEQ 833
        IF (Jme .GT. 0)  LoadMet = LoadMet - <me;LOAD>                          PRIMEQ 834
c              make maximum heating equipment capacity negative                 PRIMEQ 835
        TotalLoopCap = -TotalLoopCap                                            PRIMEQ 836
      ELSE                                                                      PRIMEQ 837
c              include meter energy                                             PRIMEQ 838
        IF (Jme .GT. 0)  LoadMet = LoadMet + <me;LOAD>                          PRIMEQ 839
      ENDIF                                                                     PRIMEQ 840
c              Weighted supply temperature from all components.  Note           PRIMEQ 841
c              that, for heat-rejection devices, dTpump is zero if the          PRIMEQ 842
c              condenser pumps are attached directly to the components.         PRIMEQ 843
c              In this case, eq;SUPPLY_T was adjusted within the                PRIMEQ 844
c              component routine.                                               PRIMEQ 845
      IF (GPMs .GT. 0.)  THEN                                                   PRIMEQ 846
        IF (LoopCtrl .NE. FLOATING)  THEN                                       GLHX1  803
          IF (GPMeq .NE. 0.)  THEN                                              BUGS   166
            Tsupply = Teq/GPMeq + dTpump                                        BUGS   167
            IF (LoopType .NE. DHW)                                              -41a   134
     &        Treturn = Tsupply + <lp;Q_NET> / (<lp;BTUH/GPM-F>*GPMs)           -41a   135
          ENDIF                                                                 BUGS   169
        ELSE                                                                    GLHX1  806
          IF (GPMeq .NE. 0.)  THEN                                              BUGS   170
            Tsupply = Teq/GPMeq + dTpump                                        BUGS   171
            Treturn = Tsupply                                                   GLHX1  809
          ELSE                                                                  GLHX1  810
            Tsupply = (<lp;SUPPLY_AVG'>+<lp;RETURN_AVG'>) * 0.5                 GLHX1  811
            Treturn = Tsupply                                                   GLHX1  812
          ENDIF                                                                 GLHX1  813
        ENDIF                                                                   GLHX1  814
      ENDIF                                                                     PRIMEQ 849
c                                                                               PRIMEQ 850
c              skip rest if only an estimate for loop temperature               PRIMEQ 851
      IF (.NOT. RealCall)  THEN                                                 PRIMEQ 852
        <lp;SUPPLY_T> = Tsupply                                                 PRIMEQ 853
        GOTO 1000                                                               PRIMEQ 854
      ENDIF                                                                     PRIMEQ 855
      IF (<lp;FreeCoolChlr> .LT. 0)  THEN                                       -042j2 222
c              Restore CW variables after free cooling                          -042j2 223
        <lp:CL-SETPT-CTRL> = ICWctrl                                            -042j2 224
        <lp:SETPT-RNG>     = CWrng                                              -042j2 225
      ENDIF                                                                     -042j2 226
c                                                                               PRIMEQ 856
c              check if any attached equipment pumps - supply-side loop         PRIMEQ 857
c              pumps or equipment recirculation pumps (demand-side pump         PRIMEQ 858
c              loads were already accounted for)                                PRIMEQ 859
      IF (LoopCtrl .NE. OFFMODE  .AND.  QpumpEq .GT. 0.)  THEN                  ChlrHP1039
c              adjust loop loads for any attached equipment pumps               PRIMEQ 861
        IF (QloopNet .LT. -1.)  THEN                                            PRIMEQ 862
          QloopNet = MIN(0., QloopNet+QpumpEq)                                  PRIMEQ 863
c              pass excess pump heat onto the next hour                         PRIMEQ 864
          <lp;ACCUM_OVR'> = MAX(0., QloopNet+QpumpEq)                           PRIMEQ 865
        ELSEIF (QloopNet .GT. 1.)  THEN                                         PRIMEQ 866
          QloopNet = QloopNet + QpumpEq                                         PRIMEQ 867
        ENDIF                                                                   PRIMEQ 868
c              include local pump heat in total                                 PRIMEQ 869
        Qpump  = Qpump + QpumpEq                                                PRIMEQ 870
c              loop temperature rise due to all pumps                           PRIMEQ 871
        dTpump = Qpump / (<lp;BTUH/GPM-F> * GPMr)                               PRIMEQ 872
      ENDIF                                                                     PRIMEQ 873
c              loop flow may be less than original if attached equipment        PRIMEQ 874
c              pumps could not meet loop flow requirements                      PRIMEQ 875
      IF (<lp:PUMP> .EQ. 0)  THEN                                               PRIMEQ 876
        GPM = MIN(GPMpumpEq, GPMr)                                              PRIMEQ 877
        IF (GPMs .EQ. GPMr)  GPMs = GPM                                         PRIMEQ 878
        GPMr = GPM                                                              PRIMEQ 879
      ENDIF                                                                     PRIMEQ 880
c                                                                               PRIMEQ 881
c                                                                               PRIMEQ 882
c============= CHECK FOR OVERLOADED CONDITION ================================= PRIMEQ 883
c              skip if no load                                                  PRIMEQ 884
      IF (ABS(QloopNet) .LT. 1.)  THEN                                          -031     9
        IF (<lp;HCAP_RATIO> .GT. 0.)  <lp;HCapNext> = 1.                        BUGS   172
        IF (<lp;CCAP_RATIO> .GT. 0.)  <lp;CCapNext> = 1.                        BUGS   173
        GOTO 800                                                                -031    12
      ENDIF                                                                     -031    13
c              Accumulated overload from previous hours                         PRIMEQ 886
      Qaccum = <lp;ACCUM_OVRLD>                                                 PRIMEQ 887
      IF (LoopCtrl .EQ. HEATMODE)  THEN                                         PRIMEQ 888
c              loop is heating                                                  PRIMEQ 889
        IF (LoadMet .LE. QloopNet*0.999)  THEN                                  PRIMEQ 890
c              no overload                                                      PRIMEQ 891
        ELSEIF (QloopNet .LT. -1.)  THEN                                        PRIMEQ 892
c              overloaded                                                       PRIMEQ 893
          Qover = QloopNet - LoadMet                                            PRIMEQ 894
c              don't recount an overload passed from previous hour              PRIMEQ 895
          QoverNew = MIN(0., Qover-Qaccum)                                      PRIMEQ 896
          IF (QoverNew .LT. -1.)  THEN                                          PRIMEQ 897
c              for wlhp, float temperature to the alarm T.  This will           PRIMEQ 898
c              cause heat pumps to shut down next hour                          PRIMEQ 899
            IF (LoopType .EQ. WLHP)  THEN                                       PRIMEQ 900
              dTover = QoverNew / <lp;BTU/F>                                    PRIMEQ 901
              Tover  = Tsupply + dTover                                         PRIMEQ 902
              Tover  = MAX(Tover, <lp:MIN-ALARM-T>-.01)                         PRIMEQ 903
              dTover = Tover - Tsupply                                          PRIMEQ 904
c              adjust overload by amount absorbed by float                      PRIMEQ 905
              Qadj     = dTover * <lp;BTU/F>                                    PRIMEQ 906
              QoverNew = QoverNew - Qadj                                        PRIMEQ 907
              Qover    = Qover    - Qadj                                        PRIMEQ 908
c              adjust all loop temperatures for use next hour                   PRIMEQ 909
              Tsupply   = Tsupply   + dTover                                    PRIMEQ 910
              Treturn   = Treturn   + dTover                                    PRIMEQ 911
              TavgS     = TavgS     + dTover                                    PRIMEQ 912
              TavgR     = TavgR     + dTover                                    PRIMEQ 913
              TcoilEnt  = TcoilEnt  + dTover                                    PRIMEQ 914
              TcoilExit = TcoilExit + dTover                                    PRIMEQ 915
              <lp;SUPPLY_T>    = <lp;SUPPLY_T>    + dTover                      PRIMEQ 916
              <lp;RETURN_T>    = <lp;RETURN_T>    + dTover                      PRIMEQ 917
              <lp;COIL_EWT>    = <lp;COIL_EWT>    + dTover                      PRIMEQ 918
              <lp;COIL_LWT>    = <lp;COIL_LWT>    + dTover                      PRIMEQ 919
              <lp;SUPPLY_AVG'> = <lp;SUPPLY_AVG'> + dTover                      PRIMEQ 920
              <lp;RETURN_AVG'> = <lp;RETURN_AVG'> + dTover                      PRIMEQ 921
            ENDIF                                                               PRIMEQ 922
            <lp;Q_OVERLOAD> = QoverNew                                          PRIMEQ 923
          ELSE                                                                  PRIMEQ 924
            <lp;Q_OVERLOAD> = 0.                                                PRIMEQ 925
          ENDIF                                                                 PRIMEQ 926
c              pass overload onto next hour, including overload                 PRIMEQ 927
c              accumulated over previous hours                                  PRIMEQ 928
          <lp;ACCUM_OVR'> = Qover                                               PRIMEQ 929
c              decrease loop load by overload                                   PRIMEQ 930
          QloopNet = LoadMet                                                    PRIMEQ 931
        ENDIF                                                                   PRIMEQ 932
c              save current capacity ratio for hourly reports                   PRIMEQ 933
        CapRatio = <lp;HCAP_RATIO>                                              PRIMEQ 934
c              check if capacity of heating coils should be limited             PRIMEQ 935
c              next hour                                                        PRIMEQ 936
        IF (<lp;HCAP_RATIO> .GT. 0.  .AND.                                      PRIMEQ 937
     &     (<lp;HCAP_RATIO> .LT. 1.  .OR.  Qover .LT. -1.))  THEN               PRIMEQ 938
c              estimate what the loop load would be if not restricted           PRIMEQ 939
          Qest = (<lp;COIL_HEAT>    + <lp;COIL_COOL>                            PRIMEQ 940
     &                              + <lp;PROCESS_Q>                            PRIMEQ 941
     &         + <lp;2ND_HEAT>      + <lp;2ND_COOL>                             PRIMEQ 942
     &         + <lp;PRIM_HEAT>     + <lp;CogenQ>                               ChlrHP1040
     &         + <lp;TES_CHRG_HEAT> + <lp;PRIM_HTREJ>                           PRIMEQ 944
     &                              + <lp;AUX_HEAT>) / <lp;HCAP_RATIO>          PRIMEQ 945
     &         + <lp;SUPPLY_LOSS>   + <lp;RETURN_LOSS>                          PRIMEQ 946
     &         + QloopPump          + QpumpEq                                   PRIMEQ 947
c              set the loop capacity ratio relative to this load                PRIMEQ 948
c              TotalLoopCap is the maximum primary equipment capacity           PRIMEQ 949
c              as calcd in EquipCtrlDefault or EquipCtrl                        PRIMEQ 950
          IF (Qest .LT. -1.)  THEN                                              PRIMEQ 951
            <lp;HCapNext> = MIN(1., (TotalLoopCap+Qhtrec)/Qest)                 ERV    204
            <lp;HCapNext> = MAX(0.1, <lp;HCapNext>)                             ERV    205
          ELSE                                                                  PRIMEQ 953
            <lp;HCapNext> = 1.                                                  BUGS   175
          ENDIF                                                                 PRIMEQ 955
        ENDIF                                                                   PRIMEQ 956
      ELSEIF (.NOT. HeatRejMode)  THEN                                          PRIMEQ 957
c              loop is cooling                                                  PRIMEQ 958
        IF (LoadMet .GT. (QloopNet*0.999 - QpumpEq))  THEN                      PRIMEQ 959
c              no overload                                                      PRIMEQ 960
        ELSEIF (QloopNet .GT. 1.)  THEN                                         PRIMEQ 961
c              overloaded                                                       PRIMEQ 962
          Qover = QloopNet - LoadMet                                            PRIMEQ 963
c              don't recount an overload passed from previous hour              PRIMEQ 964
          QoverNew = MAX(0., Qover-Qaccum)                                      PRIMEQ 965
          IF (QoverNew .GT. 1.)  THEN                                           PRIMEQ 966
            <lp;Q_OVERLOAD> = QoverNew                                          PRIMEQ 967
          ELSE                                                                  PRIMEQ 968
            <lp;Q_OVERLOAD> = 0.                                                PRIMEQ 969
          ENDIF                                                                 PRIMEQ 970
c              pass overload onto next hour, including overload                 PRIMEQ 971
c              accumulated over previous hours                                  PRIMEQ 972
          <lp;ACCUM_OVR'> = Qover                                               PRIMEQ 973
c              decrease loop load by overload                                   PRIMEQ 974
          QloopNet = LoadMet                                                    PRIMEQ 975
        ENDIF                                                                   PRIMEQ 976
c              save current capacity ratio for hourly reports                   PRIMEQ 977
        CapRatio = <lp;CCAP_RATIO>                                              PRIMEQ 978
c              check if capacity of cooling coils should be limited             PRIMEQ 979
c              next hour                                                        PRIMEQ 980
        IF (<lp;CCAP_RATIO> .GT. 0.  .AND.                                      PRIMEQ 981
     &     (<lp;CCAP_RATIO> .LT. 1.  .OR.  Qover .GT. 1.))  THEN                PRIMEQ 982
c              estimate what the loop load would be if not restricted           PRIMEQ 983
          Qest = (<lp;COIL_HEAT>    + <lp;COIL_COOL>                            PRIMEQ 984
     &         +  <lp;2ND_HEAT>     + <lp;2ND_COOL>                             PRIMEQ 985
     &         + <lp;TES_CHRG_COOL> + <lp;PRIM_HTREJ> + <lp;CogenQ>)            PRIMEQ 986
     &                                                 / <lp;CCAP_RATIO>        PRIMEQ 987
     &         + <lp;SUPPLY_LOSS>   + <lp;RETURN_LOSS>                          PRIMEQ 988
     &         + QloopPump          + QpumpEq                                   PRIMEQ 989
c              set the loop capacity ratio relative to this load                PRIMEQ 990
c              TotalLoopCap is the maximum primary equipment capacity           PRIMEQ 991
c               as calcd in EquipCtrlDefault or EquipCtrl                       PRIMEQ 992
          IF (Qest .GT. 1.)  THEN                                               PRIMEQ 993
            <lp;CCapNext> = MIN(1., TotalLoopCap / Qest)                        BUGS   176
          ELSE                                                                  PRIMEQ 995
            <lp;CCapNext> = 1.                                                  BUGS   177
          ENDIF                                                                 PRIMEQ 997
        ENDIF                                                                   PRIMEQ 998
      ELSE                                                                      PRIMEQ 999
c              condenser loop - hours above loop throttling range               PRIMEQ1000
        IF (Tsupply .GT. <lp;COOL_SETPT>+<lp:SETPT-RNG>*0.5)  THEN              PRIMEQ1001
c              convert loop capacity from gpm to Btu                            PRIMEQ1002
          TotalLoopCap    = QloopNet * (TotalLoopCap / GPMs)                    PRIMEQ1003
          <lp;Q_OVERLOAD> = MAX(0., QloopNet-TotalLoopCap)                      PRIMEQ1004
        ENDIF                                                                   PRIMEQ1005
      ENDIF                                                                     PRIMEQ1006
c                                                                               PRIMEQ1007
c              put heat recovery back into net loop load                        PRIMEQ1008
  800 IF (Qhtrec .NE. 0.) THEN                                                  PRIMEQ1009
        QloopNet = QloopNet + Qhtrec                                            PRIMEQ1010
        IF (LoopCtrl .EQ. FLOATING)  THEN                                       PRIMEQ1011
c              if here, LoopCtrl was set to be floating on the basis            PRIMEQ1012
c              of the net loop load after heat recovery.  Reset to              PRIMEQ1013
c              original mode                                                    PRIMEQ1014
          LoopCtrl = <lp;CTRL_MODE>                                             PRIMEQ1015
        ENDIF                                                                   PRIMEQ1016
      ENDIF                                                                     PRIMEQ1017
c              include heat recovered into individual DHW tanks                 PRIMEQ1018
      Qhtrec       = Qhtrec + QhtrecDW                                          PRIMEQ1019
      <lp;Q_NET>   = QloopNet                                                   PRIMEQ1020
      <lp;PUMP_Q>  = Qpump                                                      PRIMEQ1021
      <lp;PUMP_DT> = dTpump                                                     PRIMEQ1022
c                                                                               PRIMEQ1023
c              hourly-report variables - this is the second                     PRIMEQ1024
c              call for primary loops                                           PRIMEQ1025
      IF (<lp;HREP> .NE. 0 .AND. IRSCH .NE. 0)                                  PRIMEQ1026
     &  CALL HourRepPLT(LOOPDAT(1), <lp;HREP>, 14, 1)                           PRIMEQ1027
c                                                                               PRIMEQ1028
      IF (LoopType .EQ. WLHP  .AND.  LoopCtrl .EQ. HEATMODE                     PRIMEQ1029
     &                            .AND.  <lp;Q_OVERLOAD>  .NE. 0.               PRIMEQ1030
     &                            .AND.  <lp;NUM_2ND_LOOPS> .GT. 0) THEN        PRIMEQ1031
c              a WLHP system overloaded in the heating mode - adjust            PRIMEQ1032
c              associated secondary temperatures                                PRIMEQ1033
        Jlp1 = Jlp                                                              PRIMEQ1034
        N2nd = <lp;NUM_2ND_LOOPS>                                               PRIMEQ1035
        DO  L2=1,N2nd                                                           PRIMEQ1036
          Jlp = Jlp1                                                            PRIMEQ1037
          Jlp = <lp;PTR_2ND_LOOPS>                                              PRIMEQ1038
          IF (<lp;RUNNING> .GT. 0)  THEN                                        PRIMEQ1039
            Tsupply   = Tsupply   + dTover                                      PRIMEQ1040
            TavgS     = TavgS     + dTover                                      PRIMEQ1041
            TcoilEnt  = TcoilEnt  + dTover                                      PRIMEQ1042
            TcoilExit = TcoilExit + dTover                                      PRIMEQ1043
            TavgR     = TavgR     + dTover                                      PRIMEQ1044
            Treturn   = Treturn   + dTover                                      PRIMEQ1045
            <lp;SUPPLY_T>    = <lp;SUPPLY_T>    + dTover                        PRIMEQ1046
            <lp;SUPPLY_AVG'> = <lp;SUPPLY_AVG'> + dTover                        PRIMEQ1047
            <lp;COIL_EWT>    = <lp;COIL_EWT>    + dTover                        PRIMEQ1048
            <lp;COIL_LWT>    = <lp;COIL_LWT>    + dTover                        PRIMEQ1049
            <lp;RETURN_AVG'> = <lp;RETURN_AVG'> + dTover                        PRIMEQ1050
            <lp;RETURN_T>    = <lp;RETURN_T>    + dTover                        PRIMEQ1051
            IF (<lp;HREP> .NE. 0 .AND. IRSCH .NE. 0)                            PRIMEQ1052
     &        CALL HourRepPLT(LOOPDAT(1), <lp;HREP>, 14, 1)                     PRIMEQ1053
          ENDIF                                                                 PRIMEQ1054
        ENDDO                                                                   PRIMEQ1055
c              restore primary loop pointer                                     PRIMEQ1056
        Jlp = Jlp1                                                              PRIMEQ1057
      ENDIF                                                                     PRIMEQ1058
c                                                                               PRIMEQ1059
 1000 RETURN                                                                    PRIMEQ1060
 9101 FORMAT(14X,'An EQUIP-CTRL sequence will be overridden because'   /        -035   174
     &       14X,'the selected equipment cannot meet the resulting'    /        -035   175
     &       14X,'flow requirements.'                                  /        -035   176
     &       14X,'Loop: ',8A4,' First occurrence: ',I2,'/',I2,'/',I2   )        -035   177
      END                                                                       PRIMEQ1061
      SUBROUTINE Pump                                                           PUMP     2
c                                                                               PUMP     3
c              Simulates the performance of one or more pumps, with             PUMP     4
c              either constant or variable flow, and constant speed,            PUMP     5
c              2-speed, staged, or variable speed capacity control              PUMP     6
c                                                                               PUMP     7
c                                                                               PUMP     8
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /DESHRQ/ NDESDY, IDDTYP(2), DESHRQ(360)                           Time     1
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /LOOP  / Nloop(16,2), NextType(40), NLP2,                         -41a     1
     &                 WLHPoff, RealCall, RegenFlag, Sim2x, LoopSimCount        ChlrHP   2
      LOGICAL          WLHPoff, RealCall, RegenFlag, Sim2x                      ChlrHP   3
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
      COMMON  /ZEROP/  LpmHR,LlpHR,LchHR,LblHR,LdwHR,LtwHR,LpvHR,LgnHR,         PV       5
     &                 LtkHR,LhxHR,LecHR,LlmHR,LemHR,LfmHR,LsmHR,LcmHR,         /ZEROP/  3
     &                 LglHR,LpeHR,                                             /ZEROP/  4
     &                 LpmMO,LlpMO,LchMO,LblMO,LdwMO,LtwMO,LpvMO,LgnMO,         PV       6
     &                 LtkMO,LhxMO,LecMO,LlmMO,LemMO,LfmMO,LsmMO,LcmMO,         /ZEROP/  6
     &                 LglMO,LpeMO,                                             /ZEROP/  7
     &                 LpmYR,LlpYR,LchYR,LblYR,LdwYR,LtwYR,LpvYR,LgnYR,         PV       7
     &                 LtkYR,LhxYR,LecYR,LlmYR,LemYR,LfmYR,LsmYR,LcmYR,         /ZEROP/  9
     &                 LglYR,LpeYR                                              /ZEROP/ 10
c                                                                               -041g   11
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
c                                                                               PUMP    25
c              limits for inverse curves                                        PUMP    26
      DIMENSION GPMLIM(2), GPMrLIM(2), RPMLIM(2), CURVE(6)                      PUMP    27
      DATA GPMrLIM /2.0, 0.2/                                                   PUMP    28
      DATA RPMLIM  /1.2, 0.0/                                                   PUMP    29
      DATA CURVE   /6*0./                                                       PUMP    30
      LOGICAL MeetSetpoint                                                      PUMP    31
c                                                                               PUMP    32
c                                                                               PUMP    33
c              pump cannot operate if no flow                                   PUMP    34
      IF (PMPgpm .EQ. 0.)  THEN                                                 -041j   54
        PMPQ  = 0.                                                              -041j   55
        PMPdT = 0.                                                              -041j   56
        GOTO 1000                                                               -041j   57
      ENDIF                                                                     -041j   58
c                                                                               PUMP    36
c              flag to indicate head setpoint can be met                        PUMP    37
      MeetSetpoint = .TRUE.                                                     PUMP    38
c                                                                               PUMP    39
c                                                                               PUMP    40
c ****         run function : Pump-1                                            PUMP    41
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        PUMP    42
c                                                                               PUMP    43
c              minimum required head is the sum of the friction and static headsPUMP    44
      PMPhead  = PMPfric + PMPstatic                                            PUMP    45
c              required pump head used for control                              PUMP    46
      HEADreqd = PMPset                                                         PUMP    47
c                                                                               PUMP    48
c              ratio of control head to design head                             PUMP    49
   10 HEADr = HEADreqd / <pm:HEAD>                                              PUMP    50
c              identify impellor performance                                    PUMP    51
c              determine the maximum flow ratio of the pump at the              PUMP    53
c              current system head                                              PUMP    54
      Jcv = <pm:HEAD-FGPM>                                                      -045b  130
      CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 1,PMPGPMr,Y,HEADr,                     -045b  131
     &                                               GPMrLIM(1),IERR)           -045b  132
c              but do not allow more than the max ratio                         PUMP    56
      IF (MeetSetpoint)  PMPGPMr = MIN(PMPGPMr, <pm:MAX-RATIO>)                 PUMP    57
      GPMmax = <pm:GPM> * PMPGPMr                                               PUMP    58
c              required number of pumps (real number)                           PUMP    59
      PMPnum = FLOAT(MAX(1, INT(PMPgpm/GPMmax+.9999)))                          PUMP    60
c              check if enough pumps available                                  PUMP    61
      IF (PMPnum .GT. <pm:NUMBER>)  THEN                                        PUMP    62
c              not enough pumps to meet setpoint at specified flow.             PUMP    63
c              if first pass through, ignore the setpoint and see if            PUMP    64
c              pump can meet the minimum loop head requirement                  PUMP    65
c              at specified flow                                                PUMP    66
        IF (MeetSetpoint)  THEN                                                 PUMP    67
          MeetSetpoint = .FALSE.                                                PUMP    68
          HEADreqd = PMPhead                                                    PUMP    69
          GOTO 10                                                               PUMP    70
        ELSE                                                                    PUMP    71
c              Not enough pumps to meet system flow at minimum head.            PUMP    72
C              Turn on all pumps, and solve for the head and flow that          PUMP    73
c              the pumps can satisfy.                                           PUMP    74
          PMPnum   = <pm:NUMBER>                                                PUMP    75
c              Solve for the intersection of the pump curve and system          PUMP    76
c              curve - this solution approximates the system head as the        PUMP    77
c              square of the flow.  Actually, the system head is closer         PUMP    78
c              to the 1.8 power, rather than a square                           PUMP    79
          Jcv      = <pm:HEAD-FGPM>                                             -045b  133
          CURVE(1) = <cv:COEF-1>*<pm:HEAD> - PMPstatic                          -045b  134
          GPMnom   = <pm:GPM> * PMPnum                                          PUMP    82
          CURVE(2) = <cv:COEF-2>*<pm:HEAD>/GPMnom                               -045b  135
          CURVE(3) = <cv:COEF-3>*<pm:HEAD>/(GPMnom*GPMnom)                      -045b  136
     &                     - (PMPfric)/(PMPgpm*PMPgpm)                          PUMP    85
c              set solution limits - 1/3 rated flow at low end, and             PUMP    86
c              3x rated at the high end                                         PUMP    87
          GPMLIM(1) = GPMnom * 3.                                               Sync    69
          GPMLIM(2) = GPMnom * 0.33                                             Sync    70
c              solve for loop gpm                                               PUMP    90
          CALL CURINV(CURVE(1),3, 1,GPMnew,Y,0., GPMLIM(1), IERR)               PUMP    91
c              corresponding friction head                                      PUMP    92
          PMPfric = PMPfric * (GPMnew**1.8)/(PMPgpm**1.8)                       PUMP    93
c              and total head                                                   PUMP    94
          HEADnew = PMPfric + PMPstatic                                         PUMP    95
c              count hours pump could not meet flow requirement at the          PUMP    96
c              system head (pump head setpoint does not really matter           PUMP    97
c              as long as the flow requirement is met)                          PUMP    98
          IF (RealCall)  <pm;HRS_OVRLD> = <pm;HRS_OVRLD> + 1                    PUMP    99
c              warn if pump is running beyond end of curve                      PUMP   100
c              (one time warning)                                               PUMP   101
          IF (<pm;HRS_OVRLD> .EQ. 1)  THEN                                      PUMP   102
            CALL MSGSIM(-2,II,II,II,II)                                         PUMP   103
            WRITE (IOUTPT,9000) (<pm:NAME>,II=1,8),                             PUMP   104
     &        PMPgpm, PMPhead, GPMnew, HEADnew, IMO, IDAY, IHR                  PUMP   105
          ENDIF                                                                 PUMP   106
c              actual flow and head the pump can deliver                        PUMP   107
          PMPgpm  = GPMnew                                                      PUMP   108
          PMPhead = HEADnew                                                     PUMP   109
        ENDIF                                                                   PUMP   110
      ELSEIF (.NOT. MeetSetpoint)  THEN                                         PUMP   111
c              to be here, head setpoint could not be met, but minimum          PUMP   112
c              loop head was satisfied.  all pumps must run                     PUMP   113
        PMPnum = <pm:NUMBER>                                                    PUMP   114
      ENDIF                                                                     PUMP   115
c               flow ratio of each pump                                         PUMP   116
      PMPGPMr = PMPgpm / (<pm:GPM> * PMPnum)                                    PUMP   117
c              horsepower varies according to method of capacity control        PUMP   118
      IF (<pm:CAP-CTRL> .EQ. OneSpeed  .OR.  .NOT. MeetSetpoint)  THEN          PUMP   119
        RPMr = 1.0                                                              PUMP   120
      ELSE                                                                      PUMP   121
c              2-speed or variable-speed                                        PUMP   122
c              determine speed required to match system head and flow           PUMP   123
        Jcv = <pm:HEAD-FGPM>                                                    -045b  137
        CURVE(3) = <cv:COEF-1>                                                  -045b  138
        CURVE(2) = <cv:COEF-2> * PMPGPMr                                        -045b  139
        CURVE(1) = <cv:COEF-3> * PMPGPMr*PMPGPMr - HEADr                        -045b  140
        CALL CURINV(CURVE(1),3, 1,RPMr,Y,0.0, RPMLIM(1),IERR)                   PUMP   128
c                                                                               PUMP   129
c              2-SPEED - if required pump speed .LE. low speed then OK          PUMP   130
        IF (<pm:CAP-CTRL> .EQ. TwoSpeed)  THEN                                  PUMP   131
          IF (RPMR .LE. <pm:MIN-SPEED>)  THEN                                   PUMP   132
            RPMr = <pm:MIN-SPEED>                                               PUMP   133
          ELSE                                                                  PUMP   134
            RPMr = 1.0                                                          PUMP   135
          ENDIF                                                                 PUMP   136
        ELSE                                                                    PUMP   137
c              variable-speed - do not let pump operate below min speed         PUMP   138
          RPMr = MIN(1.0, MAX(RPMr, <pm:MIN-SPEED>))                            PUMP   139
        ENDIF                                                                   PUMP   140
c              end of variable speed calcs                                      PUMP   141
      ENDIF                                                                     PUMP   142
c                                                                               PUMP   143
c              Now that GPM and RPM are known, determine kW consumption         PUMP   144
c              first, adjust nominal horsepower for speed.  Pump laws           PUMP   145
c              say HP=f(rpm)**3.  Use HP=f(rpm)**3.05 to account for            PUMP   146
c              friction within pump which changes impeller efficiency           PUMP   147
      HPRPM  = RPMr**<pm:POWER-EXP>                                             PUMP   148
c              next, adjust GPMR for pump speed, and find HP vs. GPM            PUMP   149
      XGPMR  = PMPGPMr / RPMR                                                   PUMP   150
      PMPHPR = CVAL(<pm:HP-FGPM> , XGPMR, XGPMR)                                PUMP   151
c              pump kW                                                          PUMP   152
      PMPkW  = <pm:KW> * HPRPM * PMPHPR * PMPnum * PMPfrac                      PUMP   153
c                                                                               -034    77
c              Loss from VFD                                                    -034    78
      IF (<pm:CAP-CTRL> .EQ. VarSpeed)  THEN                                    -034    79
        PLRkW      = PMPkW / (<pm:KW>*PMPnum*PMPfrac)                           -034    80
        PMPVFDloss = CVAL(<pm:VFD-LOSS-FPLR> , PLRkW, PLRkW)                    -034    81
        PMPVFDloss = PMPVFDloss * <pm;VFDkWloss> * PMPnum * PMPfrac             -034    82
      ELSE                                                                      -034    83
        PMPVFDloss = 0.                                                         -034    84
      ENDIF                                                                     -034    85
c              Ignore all the above if the pump is cycling                      Temp***  1
      IF (<pm:CAP-CTRL> .EQ. 4)  THEN                                           Temp***  2
        PMPkW = <pm:KW> * PMPgpm/<pm:GPM>                                       Temp***  3
      ENDIF                                                                     Temp***  4
c                                                                               PUMP   154
c              pump heat into loop                                              PUMP   155
      IF (PMPfrac .GT. 0.)  THEN                                                ERV    206
        PMPQ   = PMPkW * BTUKW * <pm:MOTOR-EFF>                                 ERV    207
c              loop temperature rise due to pump                                ERV    208
        PMPdT  = PMPQ / (<lp;BTUH/GPM-F> * PMPgpm * PMPfrac)                    ERV    209
      ELSE                                                                      ERV    210
        PMPQ   = 0.                                                             ERV    211
        PMPdT  = 0.                                                             ERV    212
      ENDIF                                                                     ERV    213
c                                                                               PUMP   159
c ****         run function : Pump-2                                            PUMP   160
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        PUMP   161
c                                                                               PUMP   162
c              report variables                                                 PUMP   163
      IF (SimCtrl .ne. 11)  THEN                                                -041g   12
        <pm;HEAT> = PMPQ                                                        -041g   13
        <pm;KW>   = PMPkW + PMPVFDloss                                          -041g   14
        <pm;GPM>  = PMPgpm                                                      -041g   15
        <pm;RPMR> = RPMr                                                        -041g   16
c                                                                               -041g   17
c              hourly-report variables                                          -041g   18
        IF (<pm;HREP> .NE. 0  .AND.  IRSCH .NE. 0)  THEN                        -041g   19
c              zero setpoint if not actually used for capacity control          -041g   20
          IF (<pm:NUMBER> .EQ. 1  .AND.  <pm:CAP-CTRL> .EQ. OneSpeed)           -041g   21
     &      PMPset = 0.                                                         -041g   22
c              calculate actual operating head for hourly-report                -041g   23
          PMPhead = <pm:HEAD> * CVAL(<pm:HEAD-FGPM>, XGPMR, XGPMR)              -041g   24
     &                        * RPMR*RPMR                                       -041g   25
          CALL HourRepPLT(PUMPDAT(1), <pm;HREP>, 15, 0)                         -041g   26
        ENDIF                                                                   -041g   27
      ENDIF                                                                     -041g   28
c                                                                               PUMP   179
 1000 RETURN                                                                    PUMP   180
c              error messages                                                   PUMP   181
 9000 FORMAT(14X,'Pump: ',8a4,' cannot match the system'               /        PUMP   182
     &       14X,'flow at the minimum required head.'                  /        PUMP   183
     &       14X,'Required system flow =',F7.1,' gpm at head =',F6.1   /        PUMP   184
     &       14X,'Pump balance point =',F7.1,' gpm at head of',F6.1    /        PUMP   185
     &       14X,'If the pump was sized by default, most likely this'  /        PUMP   186
     &       14X,'is caused by a primary equipment unit operating at'  /        PUMP   187
     &       14X,'greater than its design flow, and causing a pressure'/        PUMP   188
     &       14X,'drop greater than design.  Try increasing the pump'  /        PUMP   189
     &       14X,'head or head ratio to compensate.'                   /        PUMP   190
     &       14X,'First occurrence is on ',I2,'/',I2,', hour ',I2      )        PUMP   191
c                                                                               PUMP   192
      END                                                                       PUMP   193
      SUBROUTINE PUMPdes(DesFlow)                                               PUMPd    2
c                                                                               PUMPd    3
c              Calculates the design parameters for each pump                   PUMPd    4
c                                                                               PUMPd    5
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /DESDAT/ ZCFM,ICFM,ZVENT,C1,IFLAG                                 /DESDAT/ 2
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /REPORT/ IREPRT(4,37),IPRG,IUNIQV(100),IUNIQS(100),IUNIQL         /REPORT/ 2
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
c                                                                               PUMPd   16
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
c                                                                               PUMPd   18
c                                                                               PUMPd   24
      REAL MechEff, MotorEff                                                    PUMPd   25
c              limits for inverse curves                                        PUMPd   26
      DIMENSION GPMrLIM(2)                                                      PUMPd   27
      DATA GPMrLIM /2.0, 0.2/                                                   PUMPd   28
c                                                                               PUMPd   29
c              force pump number to be an integer                               PUMPd   30
      <pm:NUMBER> = MAX(1., FLOAT(INT(<pm:NUMBER>+0.5)))                        PUMPd   31
c                                                                               PUMPd   32
c              Pump head based on loop parameters - the _EQUIP_ values are      PUMPd   33
c              zero if the pump is not directly attached to a loop              PUMPd   34
      HeadLoop = <pm;EQUIP_HEAD> + <pm;STATIC_HEAD>                             PUMPd   35
c              Add in the loop head for pumps which power a loop.  This         PUMPd   36
c              head is exclusive of the pump's attached equipment               PUMPd   37
      IF (<pm;TYPE> .NE. EquipmentPump)                                         PUMPd   38
     &    HeadLoop = HeadLoop + <lp;HEAD>                                       PUMPd   39
c                                                                               PUMPd   40
c              Initialize values for pump design parameters.  The program       PUMPd   41
c              will attempt to adjust the values if input is inconsistent.      PUMPd   42
c              Design pump flow                                                 PUMPd   43
      IF (<pm:GPM> .GT. 0.)  THEN                                               PUMPd   44
        PumpGPM = <pm:GPM>                                                      PUMPd   45
      ELSE                                                                      PUMPd   46
        PumpGPM = DesFlow*<pm:GPM-RATIO> / <pm:NUMBER>                          PUMPd   47
      ENDIF                                                                     PUMPd   48
      IF (PumpGPM .EQ. 0.)  THEN                                                PUMPd   49
        CALL MSGSIM(-1,II,II,II,II)                                             PUMPd   50
        WRITE (IOUTPT, 9100)  (<pm:NAME>,II=1,8)                                PUMPd   51
        call MessageBox( NULL, 'PUMP has zero design flow -'                    PUMPd   52
     &      //' ABORTING'//char(0),'PUMPd Errors'//char(0), MB_OK               PUMPd   53
     &      + MB_ICONSTOP + MB_TASKMODAL )                                      PUMPd   54
        RETURN                                                                  PUMPd   56
      ENDIF                                                                     PUMPd   57
c              design pump head                                                 PUMPd   58
      IF (<pm:HEAD> .GT. 0.)  THEN                                              PUMPd   59
        PumpHead = <pm:HEAD>                                                    PUMPd   60
      ELSE                                                                      PUMPd   61
        PumpHead = HeadLoop*<pm:HEAD-RATIO>                                     PUMPd   62
      ENDIF                                                                     PUMPd   63
c              design pump mech eff                                             PUMPd   64
      MechEff = <pm:MECH-EFF>                                                   PUMPd   65
c              iteration counter                                                PUMPd   66
      NumIter = 0                                                               PUMPd   67
c                                                                               PUMPd   68
c              Now design the pump.                                             PUMPd   69
c              pump brake horsepower                                            PUMPd   70
   10 BHP = PumpGPM * PumpHead / (3960. * MechEff)                              PUMPd   71
c              motor efficiency                                                 PUMPd   72
      IF (<pm:MOTOR-EFF> .GT. 0.)  THEN                                         PUMPd   73
        MotorEff = <pm:MOTOR-EFF>                                               PUMPd   74
      ELSE                                                                      PUMPd   75
c              assume motor is 30% larger than BHP                              PUMPd   76
        HP       = BHP * 1.3                                                    PUMPd   77
        MotorEff = EffMotor(HP,<pm:MOTOR-CLASS>)                                PUMPd   78
      ENDIF                                                                     PUMPd   79
c              power consumption                                                PUMPd   80
      PumpkW = BHP * .746 / MotorEff                                            PUMPd   81
c                                                                               -034    87
c              Variable-frequency drive loss                                    -034    88
      IF (<pm:CAP-CTRL> .EQ. VarSpeed)                                          -034    89
     &  <pm;VFDkWloss> = PumpkW * <pm:VFD-LOSS>                                 -034    90
c                                                                               PUMPd   82
c              If kw is user-specified, check to see if consistent              PUMPd   83
c              with other user input and/or design parameters                   PUMPd   84
      IF (<pm:KW> .GT. 0.)  THEN                                                PUMPd   85
        Error = <pm:KW>/PumpkW                                                  PUMPd   86
        IF (ABS(Error - 1.0) .GT. 0.01)  THEN                                   PUMPd   87
c              inconsistent design assumptions - first try recalculating the    PUMPd   88
c              head, then the flow, then the mechanical efficiency.             PUMPd   89
          NumIter = NumIter + 1                                                 PUMPd   90
          IF (<pm:HEAD> .EQ. 0.  .AND.  <pm:GPM> .EQ. 0.)  THEN                 PUMPd   91
            Error = SQRT(Error)                                                 PUMPd   92
            PumpHead = PumpHead * Error                                         PUMPd   93
            PumpGPM  = PumpGPM  * Error                                         PUMPd   94
          ELSEIF (<pm:HEAD> .EQ. 0.)  THEN                                      PUMPd   95
            PumpHead = PumpHead * Error                                         PUMPd   96
          ELSEIF (<pm:GPM> .EQ. 0)  THEN                                        PUMPd   97
            PumpGPM = PumpGPM * Error                                           PUMPd   98
          ELSE                                                                  PUMPd   99
            MechEff = MechEff / Error                                           PUMPd  100
          ENDIF                                                                 PUMPd  101
          IF (NumIter .LT. 11)  THEN                                            PUMPd  102
            GOTO 10                                                             PUMPd  103
          ELSE                                                                  PUMPd  104
c              no solution found - shouldn't ever be here                       PUMPd  105
            CALL MSGSIM(-1,II,II,II,II)                                         PUMPd  106
            WRITE (IOUTPT, 9101)  (<pm:NAME>,II=1,8)                            PUMPd  107
            call MessageBox( NULL, 'PUMP design calcs have failed -'            PUMPd  108
     &        //' ABORTING'//char(0),'PUMPd Errors'//char(0), MB_OK             PUMPd  109
     &        + MB_ICONSTOP + MB_TASKMODAL )                                    PUMPd  110
            RETURN                                                              PUMPd  112
          ENDIF                                                                 PUMPd  113
        ENDIF                                                                   PUMPd  114
      ENDIF                                                                     PUMPd  115
c                                                                               PUMPd  116
c              Check if pump design reasonable.                                 PUMPd  117
c              First, flow                                                      PUMPd  118
      IF (PumpGPM*<pm:NUMBER> .LT. DesFlow*0.95)  THEN                          PUMPd  119
        CALL MSGSIM(-2,II,II,II,II)                                             PUMPd  120
        WRITE (IOUTPT,9102) (<pm:NAME>,II=1,8),                                 PUMPd  121
     &                      PumpGPM*<pm:NUMBER>, DesFlow                        PUMPd  122
      ENDIF                                                                     PUMPd  123
c              head                                                             PUMPd  124
      IF (PumpHead .LT. HeadLoop*0.95)  THEN                                    PUMPd  125
        CALL MSGSIM(-2,II,II,II,II)                                             PUMPd  126
        WRITE (IOUTPT,9103)  (<pm:NAME>,II=1,8), PumpHead, HeadLoop             PUMPd  127
      ENDIF                                                                     PUMPd  128
c              mechanical efficiency                                            PUMPd  129
      IF (MechEff .NE. <pm:MECH-EFF>)  THEN                                     PUMPd  130
        IF (MechEff .LT. 0.25  .OR.  MechEff .GT. 0.90)  THEN                   PUMPd  131
          CALL MSGSIM(-1,II,II,II,II)                                           PUMPd  132
          WRITE (IOUTPT,9104)  (<pm:NAME>,II=1,8), MechEff                      PUMPd  133
          call MessageBox( NULL, 'PUMP design input is unreasonable'            PUMPd  134
     &      //' Check values'//char(0),'PUMPd Error'//char(0), MB_OK            PUMPd  135
     &      + MB_ICONSTOP + MB_TASKMODAL )                                      PUMPd  136
          RETURN                                                                PUMPd  138
        ELSE                                                                    PUMPd  139
          CALL MSGSIM(-3,II,II,II,II)                                           PUMPd  140
          WRITE (IOUTPT,9105)  (<pm:NAME>,II=1,8), MechEff                      PUMPd  141
        ENDIF                                                                   PUMPd  142
      ENDIF                                                                     PUMPd  143
c              Check to make sure that max flow ratio is reasonable.            PUMPd  144
c              Get flow at 25% design head                                      PUMPd  145
      Jcv = <pm:HEAD-FGPM>                                                      -045b  141
      CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 1,PMPGPMr,Y,0.25,                      -045b  142
     &                                   GPMrLIM(1),IERR)                       -045b  143
c              compare to specified                                             PUMPd  148
      IF (<pm:MAX-RATIO> .GT. PMPGPMr)  THEN                                    PUMPd  149
        CALL MSGSIM(-2,II,II,II,II)                                             PUMPd  150
        WRITE (IOUTPT, 9106)  (<pm:NAME>,II=1,8), PMPGPMr                       PUMPd  151
        <pm:MAX-RATIO> = PMPGPMr                                                PUMPd  152
      ENDIF                                                                     PUMPd  153
c                                                                               PUMPd  154
c              store design variables                                           PUMPd  155
      <pm:GPM>       = PumpGPM                                                  PUMPd  156
      <pm:HEAD>      = PumpHead                                                 PUMPd  157
      <pm:MECH-EFF>  = MechEff                                                  PUMPd  158
      <pm:MOTOR-EFF> = MotorEff                                                 PUMPd  159
      <pm:KW>        = PumpkW                                                   PUMPd  160
c              total flow and power for all pumps                               PUMPd  161
      <pm;TOTAL_GPM> = PumpGPM * <pm:NUMBER>                                    PUMPd  162
      <pm;TOTAL_KW>  = PumpkW  * <pm:NUMBER>                                    PUMPd  163
c              design pump heat                                                 PUMPd  164
      PMPQ   = PumpkW * BTUKW * MotorEff                                        PUMPd  165
      Qpump  = PMPQ                                                             PUMPd  166
c              loop temperature rise due to pump                                PUMPd  167
      PMPdT  = PMPQ / (<lp;BTUH/GPM-F> * PumpGPM)                               PUMPd  168
      dTpump = PMPdT                                                            PUMPd  169
c                                                                               PUMPd  170
c              design flow thru attached primary equipment                      PUMPd  171
      <pm;EQUIP_GPM>   = DesFlow                                                PUMPd  172
      <pm;DESIGN_HEAT> = PMPQ                                                   PUMPd  173
      <pm;DESIGN_DT>   = PMPdT                                                  PUMPd  174
c                                                                               PUMPd  175
c              dump design variables                                            PUMPd  176
      IF (IREPRT(3,34) .NE. 0)  WRITE(IOUTPT,9000) (<pm:NAME>,II=1,8),          PUMPd  177
     1  <pm:NUMBER>, <pm:GPM>, <pm:HEAD>, <pm:KW>,                              PUMPd  178
     2  <pm:MECH-EFF>                                                           PUMPd  179
c                                                                               PUMPd  180
      RETURN                                                                    PUMPd  181
c                                                                               PUMPd  182
c              dump formats                                                     PUMPd  183
 9000 FORMAT(' ',8A4                                                   /        PUMPd  184
     &           17X,'      NUM      GPM     HEAD       KW MECH-EFF'   /        PUMPd  185
     &           17X,        I9,    F9.1,    F9.1,    F9.2,    F9.2    )        PUMPd  186
c              message formats                                                  PUMPd  187
 9100 FORMAT(14X,'Pump: ',8A4,' has zero design flow.  If attached to' /        PUMPd  188
     &       14X,'a DHW loop, make sure the recirculation flow is '    /        PUMPd  189
     &       14X,'nonzero.'                                            )        PUMPd  190
 9101 FORMAT(14X,'Pump: ',8A4,' design calcs could not'                /        PUMPd  191
     &       14X,'find a solution in 10 iterations.  Check input for'  /        PUMPd  192
     &       14X,'consistency, or allow program to calculate kW.'      )        PUMPd  193
 9102 FORMAT(14X,'Pump: ',8A4,' has a total user-specified flow'       /        PUMPd  194
     &       14X,'of ',F10.0,' gpm, but the loop flow is ',F10.0       ,        PUMPd  195
     &           ' gpm.'                                               )        PUMPd  196
 9103 FORMAT(14X,'Pump: ',8A4,' has a user-specified head'             /        PUMPd  197
     &       14X,'of ',F10.0,' feet, but the loop head is ',F10.0      ,        PUMPd  198
     &           ' feet.'                                              )        PUMPd  199
 9104 FORMAT(14X,'Pump: ',8A4,' has user specified'                    /        PUMPd  200
     &       14X,'parameters that force the mechanical efficiency to'  /        PUMPd  201
     &       14X,'be unreasonable.  Check input or allow the program'  /        PUMPd  202
     &       14X,'to calculate the kW.'                                /        PUMPd  203
     &       14X,'Calculated mechanical efficiency =',F10.3            )        PUMPd  204
 9105 FORMAT(14X,'Pump: ',8A4,' has user specified'                    /        PUMPd  205
     &       14X,'parameters that force the mechanical efficiency to'  /        PUMPd  206
     &       14X,'be recalculated as:',F10.3                           )        PUMPd  207
 9106 FORMAT(14X,'Pump: ',8A4,' has a PUMP-MAX-RATIO greater'          /        PUMPd  208
     &       14X,'than the flow corresponding to 25% of design head.'  /        PUMPd  209
     &       14X,'MAX-RATIO will be reset to ',F5.2                    )        -047k   88
c                                                                               PUMPd  211
      END                                                                       PUMPd  212
      SUBROUTINE PumpDemand                                                     PUMPDE   2
c                                                                               PUMPDE   3
c              Sets up the parameters for the hourly simulation of a            PUMPDE   4
c              pump attached to the DEMAND side of a single primary             PUMPDE   5
c              equipment unit.  Called hourly from PrimaryEquip.                PUMPDE   6
c                                                                               PUMPDE   7
c                                                                               PUMPDE   8
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
c                                                                               PUMPDE  15
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
c                                                                               PUMPDE  18
c                                                                               PUMPDE  19
c              If the loop does not have its own pump(s), then the loop         PUMPDE  20
c              is powered by pumps attached to primary equipment units.         PUMPDE  21
c              These pumps stage with their attached equipment.                 PUMPDE  22
c                                                                               PUMPDE  23
c              Dedicated pumps can operate in one of three modes:               PUMPDE  24
c                Equipment - the attached loop has its own pump(s).             PUMPDE  25
c                            An equipment pump overcomes the head of            PUMPDE  26
c                            its attached equipment only.  It is simulated      PUMPDE  27
c                            from within the equipment algorithm thru a         PUMPDE  28
c                            call to PumpSupply.                                PUMPDE  29
c                Dedicated, supply side - the attached loop is powered by       PUMPDE  30
c                            pumps attached to the primary equipment            PUMPDE  31
c                            that SUPPLY the loop.  An example                  PUMPDE  32
c                            are evaporator pumps on chillers.  These           PUMPDE  33
c                            pumps are simulated from within the equipment      PUMPDE  34
c                            algorithm thru a call to PumpSupply.               PUMPDE  35
c                Dedicated, demand side - the attached loop is powered by       PUMPDE  36
c                            pumps attached to the primary equipment            PUMPDE  37
c                            that DEMANDS from the loop.  An                    PUMPDE  38
c                            example are condenser water pumps on chillers.     PUMPDE  39
c                            These pumps are simulated here thru a call         PUMPDE  40
c                            from PrimaryEquip.                                 PUMPDE  41
C                                                                               PUMPDE  42
c              The major difference between supply-side and demand-side         PUMPDE  43
c              pumps is that the loop flow has already been established for     PUMPDE  44
c              supply side pumps at the time the equipment is simulated         PUMPDE  45
c              (the flow was previously determined by the coil valves, etc.     PUMPDE  46
c              demanding from the loop).                                        PUMPDE  47
C                                                                               PUMPDE  48
c              For demand-side pumps, the total loop flow is not known at       PUMPDE  49
c              the time the equipment is simulated.  For example, the CHW       PUMPDE  50
c              loop load and flow are known prior to calling chillers.          PUMPDE  51
c              However, the CW loop load and flow is not known until all of     PUMPDE  52
c              the chillers have been simulated, and the loop head cannot       PUMPDE  53
c              be determined until the hourly mix of cooling towers has         PUMPDE  54
C              been selected.  Therefore, each condenser pump                   PUMPDE  55
c              can only be simulated after all of the chillers have been        PUMPDE  56
c               simulated.  That is the purpose of this routine.                PUMPDE  57
c                                                                               PUMPDE  58
c              primary equipment flow ratio relative to design                  PUMPDE  59
      IF (DesEqGPM .GT. 0.)  THEN                                               PUMPDE  60
        PLReq = MIN(<pm:MAX-RATIO>, MAX(0., GPMr / DesEqGPM))                   PUMPDE  61
      ELSE                                                                      PUMPDE  62
        PLReq = 1.0                                                             PUMPDE  63
      ENDIF                                                                     PUMPDE  64
c                                                                               PUMPDE  65
c              Primary equipment friction head created by flow.                 PUMPDE  66
c              For condenser water loops - SUPPLY-SIDE_HEAD is the tower        PUMPDE  67
c              head, not the condenser head                                     PUMPDE  68
      PrimHead = (<lp;SUP-SIDE_HEAD>+<lp;HTREC_HEAD>)*PLReq**1.8                PUMPDE  69
c              pipe flow ratio                                                  PUMPDE  70
      PLRpipe  = MIN(1., MAX(0., GPMr / <lp;DES_GPM>))                          PUMPDE  71
c              throttling range                                                 PUMPDE  72
      THR      = <lp:HD-SETPT-RNG> * (0.5-PLRpipe)                              PUMPDE  73
c                                                                               PUMPDE  74
c              loop thru and simulate all attached demand-side pumps            PUMPDE  75
      Neq    = <lp;NUM_DEM_PUMPS>                                               PUMPDE  76
      DO  IQ=1,Neq                                                              PUMPDE  77
c              pointer to pump attached to equipment                            PUMPDE  78
        Jpm = <lp;DEM_SIDE_PMPS>                                                PUMPDE  79
c              check if pump is on                                              PUMPDE  80
        IF (<pm;GPM> .GT. 0.)  THEN                                             PUMPDE  81
c              Calculate head required of pump to meet setpoint                 PUMPDE  82
          IF (<lp:HD-SETPT-CTRL> .NE. FIXED)  THEN                              PUMPDE  83
c              No fixed setpoint - set hourly to match the reqt. of the         PUMPDE  84
c              worst case coil or secondary loop.  This scheme assumes          PUMPDE  85
c              proportional + integral control so there is no throttling        PUMPDE  86
c              range                                                            PUMPDE  87
c                     condenser head     condenser static                       PUMPDE  88
            HDset = <pm;EQUIP_HEAD> + <pm;STATIC_HEAD>                          PUMPDE  89
c                     piping                                                    PUMPDE  90
     &            + PipeHead        + <lp:STATIC-HEAD>                          PUMPDE  91
c                     tower/other friction                                      PUMPDE  92
     &            + PrimHead        + <lp;SUP-SIDE_STAT>                        PUMPDE  93
c                  heat recovery/free cooling static                            PUMPDE  94
     &                              + <lp;HTREC_STATIC>                         PUMPDE  95
          ELSE                                                                  PUMPDE  96
c              The pump is controlled to a fixed setpoint.  The setpoint        PUMPDE  97
c              was calculated in the design routine, and is based on the        PUMPDE  98
c              design heads of all components downstream of the sensor.         PUMPDE  99
c              Calculate the head required of the pump based on the             PUMPDE 100
c              location of the sensor                                           PUMPDE 101
            IF (<lp:HD-SENS-LOCN> .EQ. AtCoils)  THEN                           PUMPDE 102
c              The differential pressure sensor is located toward the           PUMPDE 103
c              coil end of the loop.                                            PUMPDE 104
              HDset = <pm:HEAD-SETPT> + THR                                     PUMPDE 105
     &              + PipeHead        + <lp:STATIC-HEAD>                        PUMPDE 106
     &              + PrimHead        + <lp;SUP-SIDE_STAT>                      PUMPDE 107
     &                                + <lp;HTREC_STATIC>                       PUMPDE 108
            ELSEIF (<lp:HD-SENS-LOCN> .EQ. EnterLoop)  THEN                     PUMPDE 109
c              sensor is located at beginning of loop                           PUMPDE 110
              HDset = <pm:HEAD-SETPT> + THR                                     PUMPDE 111
     &              + PrimHead        + <lp;SUP-SIDE_STAT>                      PUMPDE 112
     &                                + <lp;HTREC_STATIC>                       PUMPDE 113
            ELSE                                                                PUMPDE 114
c              sensor is located at pump                                        PUMPDE 115
              HDset = <pm:HEAD-SETPT> + THR                                     PUMPDE 116
            ENDIF                                                               PUMPDE 117
          ENDIF                                                                 PUMPDE 118
c              net loop friction - note that in hourly-reports, this            PUMPDE 119
c              figure may only be valid for one equipment unit                  PUMPDE 120
          Friction  = <pm;EQUIP_HEAD> + PipeHead + PrimHead                     PUMPDE 121
c                                                                               PUMPDE 122
c              net head on pump due to friction                                 PUMPDE 123
          PMPfric   = Friction                                                  PUMPDE 124
c              net head on pump due to static                                   PUMPDE 125
          PMPstatic = <pm;STATIC_HEAD> + <lp:STATIC-HEAD>                       PUMPDE 126
     &                                 + <lp;SUP-SIDE_STAT>                     PUMPDE 127
     &                                 + <lp;HTREC_STATIC>                      PUMPDE 128
          PMPgpm    = <pm;GPM>                                                  PUMPDE 129
          PMPset    = HDset                                                     PUMPDE 130
          PMPfrac   = 1.0                                                       PUMPDE 131
c              simulate pump                                                    PUMPDE 132
          CALL PUMP                                                             PUMPDE 133
c              sum heat and flow for loop calcs in PrimaryEquip                 PUMPDE 134
          QpumpEq   = QpumpEq   + PMPQ                                          PUMPDE 135
          GPMpumpEq = GPMpumpEq + PMPgpm                                        PUMPDE 136
        ENDIF                                                                   PUMPDE 137
      ENDDO                                                                     PUMPDE 138
c              average temperature rise of all pumps                            PUMPDE 139
      dTpumpEq = QpumpEq / (<lp;BTUH/GPM-F> * GPMpumpEq)                        PUMPDE 140
c                                                                               PUMPDE 141
      RETURN                                                                    PUMPDE 142
      END                                                                       PUMPDE 143
      SUBROUTINE PumpSupply                                                     PUMPSU   2
c                                                                               PUMPSU   3
c              Sets up the parameters for the hourly simulation of a            PUMPSU   4
c              pump attached to the SUPPLY side of a single primary             PUMPSU   5
c              equipment unit.  Called hourly from boiler, chiller, etc.        PUMPSU   6
c                                                                               PUMPSU   7
c                                                                               PUMPSU   8
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQCTRL/ HeatRejMode, LoadRangeLength                             /EQCTRL/ 2
      LOGICAL          HeatRejMode                                              /EQCTRL/ 3
      COMMON  /EQUIPD/ EQload, EQrun, EQhgb, OperCap, Frac,                     /EQUIPD/ 2
     &                 PLR, EQsupplyT, Tcond,                                   Chlr1    1
     &                 EIRPLR, EIRFT, EQEIR, EQelec, EQfanKW, EQaux,            /EQUIPD/ 4
     &                 HIRPLR, HIRFT, EQHIR, EQfuel, EQcond, EQrecvr,           /EQUIPD/ 5
     &                 HWflow, HWhead, CHWflow, CHWhead, CWflow, CWhead,        /EQUIPD/ 6
     &                 HTRECflow,HTREChead, Qenvir, EQstart, EQloadH,           -041d    1
     &                 EQstartH, PLRh, FracH, EQfuelH, EQelecH                  /EQUIPD/ 8
      REAL             EQUIPDAT(36)                                             /EQUIPD/10
      EQUIVALENCE      (EQUIPDAT(1), EQload), (Tambient, Tcond)                 FreeCl   1
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /TWRDAT/ TWRload,TCAP,TWRrej,CWgpm,TWRgpm,TWRsupply,              /TWRDAT/ 2
     &                 TWRset,Ttower,RANGE,APP,twr1FRA,GPMra,GPMcap,            /TWRDAT/ 3
     &                 GPMcell,NumCells,MinCells,MaxCells,Ttop,GPMtop,          /TWRDAT/ 4
     &                 Tbot,GPMbot,CFMra,FankWr,FankW,TWRaux,QpanLoss,          -034     2
     &                 QcoilLoss, SpraykW, Twet1, Tstart                        /TWRDAT/ 6
      DIMENSION        TWRSAV(25)                                               /TWRDAT/ 7
      EQUIVALENCE     (TWRSAV(1),TWRload)                                       /TWRDAT/ 8
c                                                                               PUMPSU  17
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
c                                                                               PUMPSU  21
c                                                                               PUMPSU  22
c              If the loop has its own pump(s), then this pump is               PUMPSU  23
c              an equipment pump only.  An equipment pump sees the              PUMPSU  24
c              flow and head of the attached primary equipment unit only;       PUMPSU  25
c              it is not affected in any way by the flow and head of the        PUMPSU  26
c              attached circulation loop.  Note, however, that the loop         PUMPSU  27
c              pump does not have to overcome the head of the primary           PUMPSU  28
c              equipment unit when the unit has its own equipment pump.         PUMPSU  29
c                                                                               PUMPSU  30
c              If the loop does not have its own pump(s), then this             PUMPSU  31
c              pump, while attached to a primary equipment unit, must           PUMPSU  32
c              overcome the head of the primary loop and its associated         PUMPSU  33
c              coils and secondary loops.  While the primary loop may           PUMPSU  34
c              be constant flow (3-way valves), the actual flow may vary        PUMPSU  35
c              according to the number of equipment units (and attached         PUMPSU  36
c              pumps) that are operating.  This effect in taken into account    PUMPSU  37
c              in the pump simulation routine.                                  PUMPSU  38
c                                                                               PUMPSU  39
c              Check if this pump powers the loop or is an equipment            PUMPSU  40
c              pump                                                             PUMPSU  41
      IF (<pm;TYPE> .EQ.  EquipmentPump)  THEN                                  PUMPSU  42
c              circulation loop has its own pump(s) - this pump                 PUMPSU  43
c              pump acts on the head of its attached equipment unit only        PUMPSU  44
        IF (PMPfrac .eq. 0)  THEN                                               -041c    1
          PMPgpm = 0.                                                           -041c    2
        ELSEIF (HeatRejMode)  THEN                                              -041c    3
c              flow for towers is set in tower routine                          -041c    4
          PMPgpm = TWRgpm                                                       -041c    5
        ELSEIF (<pm;EQUIP_CTRL> .EQ. ConstantFlow)  THEN                        -041c    6
c              constant flow                                                    -041c    7
          PMPgpm = <pm;EQUIP_GPM>                                               -041c    8
        ELSE                                                                    -041c    9
c              variable flow                                                    -041c   10
          PMPgpm = Max(<pe;GPM>, <pm;MIN_GPM>)                                  -041g   29
        ENDIF                                                                   -041c   12
c              pump (and primary equipment) flow ratio                          PUMPSU  55
        PLRflow   = PMPgpm / <pm;EQUIP_GPM>                                     PUMPSU  56
c              pump head due to friction                                        PUMPSU  57
        PMPfric   = <pm;EQUIP_HEAD> * PLRflow**1.8                              PUMPSU  58
c              pump head due to static head                                     PUMPSU  59
        PMPstatic = <pm;STATIC_HEAD>                                            PUMPSU  60
c              head setpoint for equipment pump                                 PUMPSU  61
        PMPset    = PMPfric + PMPstatic                                         PUMPSU  62
c              primary equipment head on loop                                   PUMPSU  63
        PrimHead  = 0.                                                          PUMPSU  64
      ELSE                                                                      PUMPSU  65
c              Circulation loop does not have its own pump(s) - this            PUMPSU  66
c              pump acts on flow and head of primary circulation loop.          PUMPSU  67
        IF (<lp:TYPE> .EQ. CW)  THEN                                            PUMPSU  68
c              flow for towers was set in PrimaryEquip                          PUMPSU  69
          PMPgpm = TWRgpm                                                       PUMPSU  70
        ELSEIF (<pm;EQUIP_CTRL> .EQ. ConstantFlow)  THEN                        -041     8
c              constant flow                                                    -041     9
          PMPgpm = <pm;EQUIP_GPM>                                               -041    10
        ELSE                                                                    -041    11
c              variable flow                                                    -041    12
          IF (PMPfrac .GT. 0.)  THEN                                            -041    13
            PMPgpm = Max(<pe;GPM>, <pm;MIN_GPM>)                                -041g   30
          ELSE                                                                  -041    15
            PMPgpm = 0.                                                         -041    16
          ENDIF                                                                 -041    17
        ENDIF                                                                   -041    18
c                                                                               PUMPSU  75
c              flow ratio thru this equipment unit                              PUMPSU  76
        PLRflow  = MIN(<pm:MAX-RATIO>,                                          PUMPSU  77
     &                   MAX(0., PMPgpm/<pm;EQUIP_GPM>))                        PUMPSU  78
c              primary equipment friction head created by flow                  PUMPSU  79
        PrimHead = (<pm;EQUIP_HEAD>+<lp;HTREC_HEAD>)*PLRflow**1.8               PUMPSU  80
c                                                                               PUMPSU  81
c              Calculate head required of pump to meet the setpoint             PUMPSU  82
        IF (<lp:HD-SETPT-CTRL> .NE. FIXED)  THEN                                PUMPSU  83
c              No fixed setpoint - set hourly to match the reqt. of the         PUMPSU  84
c              worst case coil or secondary loop.  This scheme assumes          PUMPSU  85
c              proportional + integral control so there is no throttling        PUMPSU  86
c              range                                                            PUMPSU  87
c                     worst demand                                              PUMPSU  88
          PMPset = <lp;DEM-SIDE_HEAD> + <lp;DEM-SIDE_STAT>                      PUMPSU  89
c                     pipe friction                                             PUMPSU  90
     &           + PipeHead           + <lp:STATIC-HEAD>                        PUMPSU  91
c                     attached primary equipment                                PUMPSU  92
     &           + PrimHead           + <pm;STATIC_HEAD>                        PUMPSU  93
c                  heat recovery/free cooling static                            PUMPSU  94
     &                                + <lp;HTREC_STATIC>                       PUMPSU  95
        ELSE                                                                    PUMPSU  96
c              The pump is controlled to a fixed setpoint.  The setpoint        PUMPSU  97
c              was calculated in the design routine, and is based on the        PUMPSU  98
c              design heads of all components downstream of the sensor.         PUMPSU  99
c              First, calculate the throttling range of the controller          PUMPSU 100
          THR    = <lp:HD-SETPT-RNG> * (0.5-PLRflow)                            PUMPSU 101
c              Calculate the head based on the location of the sensor           PUMPSU 102
          IF (<lp:HD-SENS-LOCN> .EQ. AtCoils)  THEN                             PUMPSU 103
c              The differential pressure sensor is located toward the           PUMPSU 104
c              coil end of the loop.                                            PUMPSU 105
            PMPset = <pm:HEAD-SETPT> + THR                                      PUMPSU 106
c                       pipe friction                                           PUMPSU 107
     &             + PipeHead        + <lp:STATIC-HEAD>                         PUMPSU 108
c                       attached primary equipment                              PUMPSU 109
     &             + PrimHead        + <pm;STATIC_HEAD>                         PUMPSU 110
c                  heat recovery/free cooling static                            PUMPSU 111
     &                               + <lp;HTREC_STATIC>                        PUMPSU 112
          ELSEIF (<lp:HD-SENS-LOCN> .EQ. EnterLoop)  THEN                       PUMPSU 113
c              sensor is located at beginning of loop                           PUMPSU 114
            PMPset = <pm:HEAD-SETPT> + THR                                      PUMPSU 115
c                       attached primary equipment                              PUMPSU 116
     &             + PrimHead        + <pm;STATIC_HEAD>                         PUMPSU 117
c                  heat recovery/free cooling static                            PUMPSU 118
     &                               + <lp;HTREC_STATIC>                        PUMPSU 119
          ELSE                                                                  PUMPSU 120
c              sensor is located at pump                                        PUMPSU 121
            PMPset = <pm:HEAD-SETPT> + THR                                      PUMPSU 122
          ENDIF                                                                 PUMPSU 123
        ENDIF                                                                   PUMPSU 124
c              net loop friction - note that in hourly-reports, this            PUMPSU 125
c              figure may only be valid for one equipment unit                  PUMPSU 126
        Friction = <lp;DEM-SIDE_HEAD> + PipeHead + PrimHead                     PUMPSU 127
c              net pump head due to friction                                    PUMPSU 128
        PMPfric  = Friction                                                     PUMPSU 129
c              net pump static head                                             PUMPSU 130
        PMPstatic = <lp;DEM-SIDE_STAT> + <lp:STATIC-HEAD>                       PUMPSU 131
     &                                 + <pm;STATIC_HEAD>                       PUMPSU 132
     &                                 + <lp;HTREC_STATIC>                      PUMPSU 133
c              end of flow and head calcs                                       PUMPSU 134
      ENDIF                                                                     PUMPSU 135
c              simulate pump                                                    PUMPSU 136
      CALL PUMP                                                                 PUMPSU 137
c                                                                               PUMPSU 138
c              Sum heat and flow for loop calcs in PrimaryEquip                 PUMPSU 139
      QpumpEq   = QpumpEq   + PMPQ                                              PUMPSU 140
      GPMpumpEq = GPMpumpEq + PMPgpm                                            PUMPSU 141
c                                                                               PUMPSU 142
      RETURN                                                                    PUMPSU 143
      END                                                                       PUMPSU 144
c ####################### SPLIT PLT INTO PLT1&2 HERE ###########################Split1   2
      SUBROUTINE ReadPlant(Mode)                                                READPL   2
c                                                                               READPL   3
c              Reads standard file for the primary plant equipment              READPL   4
c              and sets up pointers                                             READPL   5
c                                                                               READPL   6
c              Called from READSS   Mode = 1  Read the STANDARD file            READPL   7
c                                          2  Set up pointers and               READPL   8
c                                             attachments                       READPL   9
c                                                                               READPL  10
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /COGENn/ CogenMode, CogenIterateIndex, TrackMode,                 /COGEN/  2
     &                 QCogenWaste                                              /COGEN/  3
      INTEGER          CogenMode, CogenIterateIndex, TrackMode                  /COGEN/  4
      COMMON  /CTRL  / VERS(2),IRPFLG(4),IOVRLL(7),IWRTFL,IPROG,                /CTRL/   2
     1                 IFATAL,NAMPRG(3,7),MTRICR                                /CTRL/   3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /IAX   / IAX, IADIM, IADIMV, IAXMAX, KORE, IAXlds, IAXsys         HR       8
      COMMON  /INTS  / IZERO,IONE,ITWO,ITHREE,IFOUR,IFIVE,ISIX,                 /INTS/   2
     &                 ISEVEN,IEIGHT,ININE,ITEN,                                /INTS/   3
     &                 I11,I12,I13,I14,I15,I16,I17,I18,I19,I20,                 /INTS/   4
     &                 I21,I22,I23,I24,I25,I26,I27,I28,I29,I30,                 /INTS/   5
     &                 I31,I32,I33,I34,I35,I36,I37,I38,I39,I40,                 /INTS/   6
     &                 I41,I42,I43,I44,I45,I46,I47,I48,I49,I50,                 /INTS/   7
     &                 I51,I52,I53,I54,I55,I56,I57,I58,I59,I60,                 /INTS/   8
     &                 I61,I62,I63,I64,I65,I66,I67,I68,I69,I70,                 /INTS/   9
     &                 I71,I72,I73,I74,I75,I76,I77,I78,I79,I80,                 /INTS/  10
     &                 I81,I82,I83,I84,I85,I86,I87,I88,I89,I90,                 /INTS/  11
     &                 I91,I92,I93,I94,I95,I96,I97,I98,I99,I100                 /INTS/  12
      INTEGER          INTS(101)                                                /INTS/  13
      EQUIVALENCE      (INTS(1),IZERO)                                          /INTS/  14
      COMMON  /LOOP  / Nloop(16,2), NextType(40), NLP2,                         -41a     1
     &                 WLHPoff, RealCall, RegenFlag, Sim2x, LoopSimCount        ChlrHP   2
      LOGICAL          WLHPoff, RealCall, RegenFlag, Sim2x                      ChlrHP   3
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PtrCrv/ Icv, Ncv, Lcv                                            /PtrCrv/ 2
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      DIMENSION        iblock(25), nblock(25), lblock(25)                       READPL  22
      EQUIVALENCE      (ipm, iblock(1)), (npm, nblock(1)),                      READPL  23
     &                 (lpm, lblock(1))                                         READPL  24
      COMMON  /PTRSYS/ nzone , iz    , nczd  , zp2 ,         mtw  ,             -045a    1
     $                 nsys  , is    , nss   , nsp ,  ns   , icode,             HR      11
     $                 nsz   , isz   , nzd   , zp1 ,  nz   ,                    HR      12
     $                 nspace, lpr   ,                                          HR      13
     $                 nattch, iatt  ,                                          HR      14
     $                 P2, IDAYHR, IDBWBT,                                      HR      15
     $                 IRPPLT, IRPSUM, IRPSYS, IRPZON, MR1, MR2                 HR      16
      INTEGER          ZP1, ZP2, P2                                             /PTRSYS/14
      COMMON  /REPORT/ IREPRT(4,37),IPRG,IUNIQV(100),IUNIQS(100),IUNIQL         /REPORT/ 2
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TDVdat/ NameTDV, TDVmax(3), TDVmin(3), TDVavg(3),                /TDVdat/ 2
     &                 TDVsrc(3,8760), KtvTDV2(4)                               /TDVdat/ 3
      Character        NameTDV*4                                                /TDVdat/ 4
      COMMON /UNITT/   VKONV(300), DUMLOG(4), JUNITT(4,300,2)                   /UNITT/  2
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
      COMMON  /ZEROP/  LpmHR,LlpHR,LchHR,LblHR,LdwHR,LtwHR,LpvHR,LgnHR,         PV       5
     &                 LtkHR,LhxHR,LecHR,LlmHR,LemHR,LfmHR,LsmHR,LcmHR,         /ZEROP/  3
     &                 LglHR,LpeHR,                                             /ZEROP/  4
     &                 LpmMO,LlpMO,LchMO,LblMO,LdwMO,LtwMO,LpvMO,LgnMO,         PV       6
     &                 LtkMO,LhxMO,LecMO,LlmMO,LemMO,LfmMO,LsmMO,LcmMO,         /ZEROP/  6
     &                 LglMO,LpeMO,                                             /ZEROP/  7
     &                 LpmYR,LlpYR,LchYR,LblYR,LdwYR,LtwYR,LpvYR,LgnYR,         PV       7
     &                 LtkYR,LhxYR,LecYR,LlmYR,LemYR,LfmYR,LsmYR,LcmYR,         /ZEROP/  9
     &                 LglYR,LpeYR                                              /ZEROP/ 10
c                                                                               READPL  31
      COMMON  /CHLRKY/ ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 2
     &                 WaterCool, AirCool                                       /CHLRKY/ 3
      INTEGER          ELCHLR, DBUN, ABSOR, GASABSOR, ENGINE,                   /CHLRKY/ 4
     &                 WaterCool, AirCool                                       /CHLRKY/ 5
      COMMON  /EMKY  / UtilityMeter, BldgMeter, SubMeter, SellMeter,            /EMKY/   2
     &                 NumElecMeterTypes(4)                                     /EMKY/   3
      INTEGER          UtilityMeter, BldgMeter, SubMeter, SellMeter             /EMKY/   4
      COMMON /GLHXKY/  ScheduleOrWthFile, VertWell, HorizStraight,              /GLHXKY/ 2
     &                 HorizSlinky                                              /GLHXKY/ 3
      INTEGER          ScheduleOrWthFile, VertWell, HorizStraight,              /GLHXKY/ 4
     &                 HorizSlinky                                              /GLHXKY/ 5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /PUMPKY/ OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 2
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 3
      INTEGER          OneSpeed, TwoSpeed, VarSpeed,                            /PUMPKY/ 4
     &                 PrimaryPump, SecondaryPump, EquipmentPump                /PUMPKY/ 5
      COMMON  /SimAlg/ Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/ 2
     &                 Electrical,                                              /SIMALG/ 3
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/ 4
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/ 5
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   2
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/ 7
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/ 8
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/ 9
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/10
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    3
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    4
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    5
     &                 Ground_LoopVert_H2,Ground_LoopHoriz_H,                   -044d    6
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/14
      INTEGER          Cooling, Heating, DHWHeating, HeatRejection,             /SIMALG/15
     &                 Electrical,                                              /SIMALG/16
     &                 Chiller_Elec1,Chiller_Elec2,Chiller_Absor1,              /SIMALG/17
     &                 Chiller_Gas1,Chiller_Engine1,                            /SIMALG/18
     &                 Chiller_HP1,Chiller_LoopHP1,Chiller_FreeCool1,           FreeCl   3
     &                 Boiler_HW1,Boiler_HW2,                                   /SIMALG/20
     &                 DW_Heater1,DW_Heater2,                                   /SIMALG/21
     &                 CoolingTwr1,FluidCooler1,DryCooler1,                     /SIMALG/22
     &                 TES_ColdTank1, TES_HotTank1,                             /SIMALG/23
     &                 Ground_LoopSch, Ground_LoopVert,                         -044d    7
     &                 Ground_LoopVert2,Ground_LoopHoriz,                       -044d    8
     &                 Ground_LoopSch_H,Ground_LoopVert_H,                      -044d    9
     &                 Ground_LoopVert_H2, Ground_LoopHoriz_H,                  -044d   10
     &                 DieselGen_1,GasTurbineGen_1,StmTurbineGen_1              /SIMALG/27
      COMMON  /TESKY / ColdTank, HotTank                                        /TESKY/  2
      INTEGER          ColdTank, HotTank                                        /TESKY/  3
      COMMON  /TWRKY / Open, OpenHX, FluidCool,                                 /TWRKY/  2
     &                 Bypass, Speed1, Speed2, SpeedV, Damper,                  /TWRKY/  3
     &                 RunMinCells, RunMaxCells,                                /TWRKY/  4
     &                 ElecPanHtr, NoPanHtr, HWPanHtr,                          /TWRKY/  5
     &                 CycleWithFan, StayOn                                     /TWRKY/  6
      INTEGER          Open, OpenHX, FluidCool,                                 /TWRKY/  7
     &                 Bypass, Speed1, Speed2, SpeedV, Damper,                  /TWRKY/  8
     &                 RunMinCells, RunMaxCells,                                /TWRKY/  9
     &                 ElecPanHtr, NoPanHtr, HWPanHtr,                          /TWRKY/ 10
     &                 CycleWithFan, StayOn                                     /TWRKY/ 11
c                                                                               READPL  40
c                                                                               READPL  41
       INTEGER SubType                                                          READPL  42
       LOGICAL BoilerOnLoop                                                     Bug40  299
c                                                                               READPL  48
c              SimCtrl = 0  Beginning of run attachment calculations            READPL  49
      SimCtrl = 0                                                               READPL  50
c                                                                               READPL  51
      IF (Mode .EQ. 2)  GOTO 200                                                READPL  52
c                                                                               READPL  53
c              Refer to the comments in READSS for an explanation               READPL  54
c              of the dynamic storage techniques used by this program.          READPL  55
c              The components read in from the STANDARD file in this            READPL  56
c              routine include:                                                 READPL  57
c                                                                               READPL  58
c                                 Start  Component  Length  Number              READPL  59
c              PUMP                Ipm      Jpm       Lpm     Npm               READPL  60
c              CIRCULATION-LOOP    Ilp      Jlp       Llp     Nlp               READPL  61
c              CHILLER             Ich      Jch       Lch     Nch               READPL  62
c              BOILER              Ibl      Jbl       Lbl     Nbl               READPL  63
c              DW-HEATER           Idw      Jdw       Ldw     Ndw               READPL  64
c              COOLING-TWR         Itw      Jtw       Ltw     Ntw               READPL  65
c              TWR-FREE-COOLING    Ifc      Jfc       Lfc     Nfc               READPL  66
c              ELEC-GENERATOR      Ign      Jgn       Lgn     Ngn               READPL  67
c              THERMAL-STORAGE     Itk      Jtk       Ltk     Ntk               READPL  68
c              HEAT-EXCHANGER      Ihx      Jhx       Lhx     Nhx               READPL  69
c              EQUIP-CTRL          Iec      Jec       Lec     Nec               READPL  70
c              LOAD-MANAGEMENT     Ilm      Jlm       Llm     Nlm               READPL  71
c              ELEC-METER          Iem      Jpm       Lem     Nem               READPL  72
c              FUEL-METER          Ifm      Jpm       Lfm     Nfm               READPL  73
c              STEAM-METER         Ism      Jsm       Lsm     Nsm               READPL  74
c              CHW-METER           Icm      Jpm       Lcm     Ncm               READPL  75
c              MASTER-METERS       Imm                                          READPL  76
c              MATERIALS-COST      Imc      Jmc       Lmc     Nmc               READPL  77
c              GROUND-LOOP-HX      Igl      Jgl       Lgl     Ngl               READPL  78
c              Common edtt block   Ipe      Jpe       Lpe     Npe               READPL  79
c                                                                               READPL  80
c              Many of the plant equipment components utilize a "common"        READPL  81
c              block of EDTT variables necessary to allow general               READPL  82
c              routines to handle the input/output of dissimilar                READPL  83
c              component blocks.  This is the "Jpe" block. Each                 READPL  84
c              component points at its Jpe block, and the Jpe block             READPL  85
c              points back to its parent.                                       READPL  86
c              Length of Lpe must be at least the value in the EDTT table       READPL  87
      Lpe = 170                                                                 READPL  88
      Npe = 0                                                                   READPL  89
c                                                                               READPL  90
c              read in primary equipment blocks                                 READPL  91
c              currently 18 total, arrays set up for maximum of 25              READPL  92
      DO  I=1,19                                                                READPL  93
c              Number of commands of this type, total length of all             READPL  94
c              commands of this type                                            READPL  95
        READ (ISTNDF,END=100) N,L                                               READPL  96
c              call routine to save a buffer for the record                     READPL  97
        CALL GETAA(L)                                                           -031    14
        IF( IwinReturn .ne. 0 )  RETURN                                         READPL  99
c              call routine to read in the record                               READPL 100
        CALL READN(ISTNDF,IA(IAX-L+1),L)                                        READPL 101
        IF( IwinReturn .ne. 0 )  RETURN                                         READPL 102
      ENDDO                                                                     READPL 103
c              read in primary command pointers                                 READPL 104
      READ (ISTNDF,END=100)                                                     READPL 105
     &              LEN, IATT,(IREPRT(3,I),I=1,37),                             READPL 106
     &              IBLOCK, NBLOCK, LBLOCK                                      READPL 107
      GO TO 105                                                                 READPL 108
  100 CALL MSGSIM(3,ISTD,IBDL,I,I)                                              READPL 109
      call MessageBox( NULL, 'Error reading PLANT standard file -'              READPL 110
     &  //' ABORTING'//char(0),'READSP Errors'//char(0), MB_OK                  READPL 111
     &  + MB_ICONSTOP + MB_TASKMODAL )                                          READPL 112
      IwinReturn = 1                                                            READPL 113
      RETURN                                                                    READPL 114
  105 CONTINUE                                                                  READPL 115
c              Adjust base pointers for space in AA taken up by LOADS           HR      18
      DO  I=1,25                                                                HR      19
        Iblock(I) = Iblock(I) + IAXlds                                          HR      20
      ENDDO                                                                     HR      21
c              check to see if BDL and simulation agree on the length           READPL 116
c              of the AA array used to date                                     READPL 117
      IF (LEN+IAXlds .NE. IAX)  THEN                                            HR      22
        CALL MSGSIM(-2,II,II,II,II)                                             READPL 119
        WRITE (IOUTPT, 9100) LEN+IAXlds, IAX                                    HR      23
      ENDIF                                                                     READPL 121
      IF (IREPRT(3,32) .NE. 0)                                                  READPL 122
     &  CALL DUMPIT(20HPlant as Read        ,IA(1),IAX  )                       READPL 123
      IENDSF = IAX                                                              READPL 124
c                                                                               READPL 125
c              Store the lengths for hourly and monthly zeroing                 HR      24
c              CIRCULATION-LOOP                                                 HR      25
      IF (Nlp .GT. 0)  THEN                                                     HR      26
        Jlp = Ilp                                                               HR      27
        LlpHR = IndexPosition(<=HRBJlp>, <=HREJlp>, 2)                          HR      28
        LlpMO = IndexPosition(<=MOBJlp>, <=MOEJlp>, 2)                          HR      29
        LlpYR = IndexPosition(<=YRBJlp>, <=YREJlp>, 2)                          HR      30
      ENDIF                                                                     HR      31
c              PUMP                                                             HR      32
      IF (Npm .GT. 0)  THEN                                                     HR      33
        Jpm = Ipm                                                               HR      34
        LpmHR = IndexPosition(<=HRBJpm>, <=HREJpm>, 2)                          HR      35
        LpmMO = IndexPosition(<=MOBJpm>, <=MOEJpm>, 2)                          HR      36
        LpmYR = IndexPosition(<=YRBJpm>, <=YREJpm>, 2)                          HR      37
      ENDIF                                                                     HR      38
c              CHILLER                                                          HR      39
      IF (Nch .GT. 0)  THEN                                                     HR      40
        Jch = Ich                                                               HR      41
        LchHR = IndexPosition(<=HRBJch>, <=HREJch>, 2)                          HR      42
        LchMO = IndexPosition(<=MOBJch>, <=MOEJch>, 2)                          HR      43
        LchYR = IndexPosition(<=YRBJch>, <=YREJch>, 2)                          HR      44
      ENDIF                                                                     HR      45
c              BOILER                                                           HR      46
      IF (Nbl .GT. 0)  THEN                                                     HR      47
        Jbl = Ibl                                                               HR      48
        LblHR = IndexPosition(<=HRBJbl>, <=HREJbl>, 2)                          HR      49
        LblMO = IndexPosition(<=MOBJbl>, <=MOEJbl>, 2)                          HR      50
        LblYR = IndexPosition(<=YRBJbl>, <=YREJbl>, 2)                          HR      51
      ENDIF                                                                     HR      52
c              DW-HEATER                                                        HR      53
      IF (Ndw .GT. 0)  THEN                                                     HR      54
        Jdw = Idw                                                               HR      55
        LdwHR = IndexPosition(<=HRBJdw>, <=HREJdw>, 2)                          HR      56
        LdwMO = IndexPosition(<=MOBJdw>, <=MOEJdw>, 2)                          HR      57
        LdwYR = IndexPosition(<=YRBJdw>, <=YREJdw>, 2)                          HR      58
      ENDIF                                                                     HR      59
c              COOLING-TWR                                                      HR      60
      IF (Ntw .GT. 0)  THEN                                                     HR      61
        Jtw = Itw                                                               HR      62
        LtwHR = IndexPosition(<=HRBJtw>, <=HREJtw>, 2)                          HR      63
        LtwMO = IndexPosition(<=MOBJtw>, <=MOEJtw>, 2)                          HR      64
        LtwYR = IndexPosition(<=YRBJtw>, <=YREJtw>, 2)                          HR      65
      ENDIF                                                                     HR      66
c              Photovoltaic modules                                             HR      67
      IF (Npv .GT. 0)  THEN                                                     HR      68
        Jpv = Ipv                                                               HR      69
        LpvHR = IndexPosition(<=HRBJpv>, <=HREJpv>, 2)                          HR      70
        LpvMO = IndexPosition(<=MOBJpv>, <=MOEJpv>, 2)                          HR      71
        LpvYR = IndexPosition(<=YRBJpv>, <=YREJpv>, 2)                          HR      72
      ENDIF                                                                     HR      73
c              Electric generators                                              HR      74
      IF (Ngn .GT. 0)  THEN                                                     HR      75
        Jgn = Ign                                                               HR      76
        LgnHR = IndexPosition(<=HRBJgn>, <=HREJgn>, 2)                          HR      77
        LgnMO = IndexPosition(<=MOBJgn>, <=MOEJgn>, 2)                          HR      78
        LgnYR = IndexPosition(<=YRBJgn>, <=YREJgn>, 2)                          HR      79
      ENDIF                                                                     HR      80
c              THERMAL-STORAGE                                                  HR      81
      IF (Ntk .GT. 0)  THEN                                                     HR      82
        Jtk = Itk                                                               HR      83
        LtkHR = IndexPosition(<=HRBJtk>, <=HREJtk>, 2)                          HR      84
        LtkMO = IndexPosition(<=MOBJtk>, <=MOEJtk>, 2)                          HR      85
        LtkYR = IndexPosition(<=YRBJtk>, <=YREJtk>, 2)                          HR      86
      ENDIF                                                                     HR      87
c              ELEC-METER                                                       HR      88
      IF (Nem .GT. 0)  THEN                                                     HR      89
        Jem = Iem                                                               HR      90
        LemHR = IndexPosition(<=HRBJem>, <=HREJem>, 2)                          HR      91
        LemMO = IndexPosition(<=MOBJem>, <=MOEJem>, 2)                          HR      92
        LemYR = IndexPosition(<=YRBJem>, <=YREJem>, 2)                          HR      93
      ENDIF                                                                     HR      94
c              FUEL-METER                                                       HR      95
      IF (Nfm .GT. 0)  THEN                                                     HR      96
        Jfm = Ifm                                                               HR      97
        LfmHR = IndexPosition(<=HRBJfm>, <=HREJfm>, 2)                          HR      98
        LfmMO = IndexPosition(<=MOBJfm>, <=MOEJfm>, 2)                          HR      99
        LfmYR = IndexPosition(<=YRBJfm>, <=YREJfm>, 2)                          HR     100
      ENDIF                                                                     HR     101
c              STM-METER                                                        HR     102
      IF (Nsm .GT. 0)  THEN                                                     HR     103
        Jsm = Ism                                                               HR     104
        LsmHR = IndexPosition(<=HRBJsm>, <=HREJsm>, 2)                          HR     105
        LsmMO = IndexPosition(<=MOBJsm>, <=MOEJsm>, 2)                          HR     106
        LsmYR = IndexPosition(<=YRBJsm>, <=YREJsm>, 2)                          HR     107
      ENDIF                                                                     HR     108
c              CHW-METER                                                        HR     109
      IF (Ncm .GT. 0)  THEN                                                     HR     110
        Jcm = Icm                                                               HR     111
        LcmHR = IndexPosition(<=HRBJcm>, <=HREJcm>, 2)                          HR     112
        LcmMO = IndexPosition(<=MOBJcm>, <=MOEJcm>, 2)                          HR     113
        LcmYR = IndexPosition(<=YRBJcm>, <=YREJcm>, 2)                          HR     114
      ENDIF                                                                     HR     115
c              GROUND-LOOP-HX                                                   HR     116
      IF (Ngl .GT. 0)  THEN                                                     HR     117
        Jgl = Igl                                                               HR     118
        LglHR = IndexPosition(<=HRBJgl>, <=HREJgl>, 2)                          HR     119
        LglMO = IndexPosition(<=MOBJgl>, <=MOEJgl>, 2)                          HR     120
        LglYR = IndexPosition(<=YRBJgl>, <=YREJgl>, 2)                          HR     121
      ENDIF                                                                     HR     122
c                                                                               READPL 295
      RETURN                                                                    READPL 296
c                                                                               READPL 297
c                                                                               READPL 298
c============= SET UP THE POINTERS AND ATTACHMENTS ============================ READPL 299
  200 CONTINUE                                                                  READPL 300
c                                                                               READPL 301
c              Boiler interface                                                 READPL 302
      DO  Neq=1,Nbl                                                             READPL 303
        Jbl = Ibl + (Neq-1)*Lbl                                                 READPL 304
        CALL CreateJpe(Jbl, <bl:ALGORITHM>)                                     READPL 305
        <bl;Jpe> = Jpe                                                          READPL 306
      ENDDO                                                                     READPL 307
c              Chiller interface                                                READPL 308
c              Flag to indicate when loops should be simulated twice/hour       ChlrHP1041
c              Currently, only a loop-to-loop HP requires this                  ChlrHP1042
      Sim2x = .FALSE.                                                           ChlrHP1043
      DO  Neq=1,Nch                                                             READPL 309
        Jch = Ich + (Neq-1)*Lch                                                 READPL 310
        CALL CreateJpe(Jch, <ch:ALGORITHM>)                                     READPL 311
        <ch;Jpe> = Jpe                                                          READPL 312
c              create second block for chiller heating mode                     ChlrHP1044
        SELECT CASE (<ch:ALGORITHM>)                                            ChlrHP1045
          CASE (104)     ! Chiller/heater                                       ChlrHP1046
            CALL CreateJpe(Jch, 199)                                            ChlrHP1047
            <ch;Jpe_HEAT> = Jpe                                                 ChlrHP1048
          CASE (106)     ! Heat pump                                            ChlrHP1049
            <ch;Jpe_HEAT> = Jpe                                                 ChlrHP1050
          CASE (107)     ! Loop-to-loop heat-pump                               ChlrHP1051
            CALL CreateJpe(Jch, 199)                                            ChlrHP1052
            <ch;Jpe_HEAT> = Jpe                                                 ChlrHP1053
            Sim2x         = .TRUE.                                              ChlrHP1054
        END SELECT                                                              ChlrHP1055
      ENDDO                                                                     READPL 318
c              DHW interface                                                    READPL 319
      DO  Neq=1,Ndw                                                             READPL 320
        Jdw = Idw + (Neq-1)*Ldw                                                 READPL 321
        CALL CreateJpe(Jdw, <dw:ALGORITHM>)                                     READPL 322
        <dw;Jpe> = Jpe                                                          READPL 323
      ENDDO                                                                     READPL 324
c              Heat rejection interface                                         READPL 325
      DO  Neq=1,Ntw                                                             READPL 326
        Jtw = Itw + (Neq-1)*Ltw                                                 READPL 327
        CALL CreateJpe(Jtw, <tw:ALGORITHM>)                                     READPL 328
        <tw;Jpe> = Jpe                                                          READPL 329
      ENDDO                                                                     READPL 330
c              Elec-generator attachments                                       READPL 331
      DO  Neq=1,Ngn                                                             READPL 332
        Jgn = Ign + (Neq-1)*Lgn                                                 READPL 333
        CALL CogenerationEquip(1)                                               READPL 334
      ENDDO                                                                     READPL 335
c              Photovoltaic modules                                             PV     220
      DO  Neq=1,Npv                                                             PV     221
        Jpv = Ipv + (Neq-1)*Lpv                                                 PV     222
        CALL PV_MODULE(xx, yy)                                                  PV     223
      ENDDO                                                                     PV     224
c              Thermal storage interface                                        READPL 336
      DO  Neq=1,Ntk                                                             READPL 337
        Jtk = Itk + (Neq-1)*Ltk                                                 READPL 338
        CALL CreateJpe(Jtk, <tk:ALGORITHM>)                                     READPL 339
        <tk;Jpe> = Jpe                                                          READPL 340
      ENDDO                                                                     READPL 341
c              Ground-loop heat exchangers                                      READPL 342
c              set up the "common" Jpe edtt block for this component            READPL 343
      DO  Neq=1,Ngl                                                             READPL 344
        Jgl = Igl + (Neq-1)*Lgl                                                 READPL 345
        CALL CreateJpe(Jgl, <gl:ALGORITHM>)                                     READPL 346
        <gl;Jpe> = Jpe                                                          READPL 347
c              create second block for heating mode                             READPL 348
        Ialgorithm = <gl:ALGORITHM> - 200                                       READPL 349
        CALL CreateJpe(Jgl, Ialgorithm)                                         READPL 350
        <gl;Jpe_HEAT> = Jpe                                                     READPL 351
c              initialize max/min temperatures                                  -044e5 203
        <gl.HeatTmax_Mo> = -888.                                                -044e5 204
        <gl.HeatTmin_Mo> =  888.                                                -044e5 205
        <gl.CoolTmax_Mo> = -888.                                                -044e5 206
        <gl.CoolTmin_Mo> =  888.                                                -044e5 207
        <gl.HeatTmax_Yr> = -888.                                                -044e5 208
        <gl.HeatTmin_Yr> =  888.                                                -044e5 209
        <gl.CoolTmax_Yr> = -888.                                                -044e5 210
        <gl.CoolTmin_Yr> =  888.                                                -044e5 211
      ENDDO                                                                     READPL 352
c                                                                               READPL 353
c              Set up elec and fuel meter defaults.  End-use meters default     READPL 354
c              default to master elec and fuel meters.  System meters default   READPL 355
c              to system masters, if specified.  Otherwise, system meters       READPL 356
c              default to master end-use meters.  Zone meters default to        READPL 357
c              zone masters, if specified.  Otherwise, to same type as in       READPL 358
c              parent system.                                                   READPL 359
c              First, convert master meters from a command number to            READPL 360
c              a pointer in AA                                                  READPL 361
      <MSTR-E-MP> = Iem + (<MSTR-E-MP>-1) * Lem                                 READPL 362
      <MSTR-F-MP> = Ifm + (<MSTR-F-MP>-1) * Lfm                                 READPL 363
c              flags to indicate whether supplemental elec and fuel same        READPL 364
c              end-use as primary.  separate if meter defined                   READPL 365
      IHTREJ = <HTREJ-E-MP>                                                     READPL 366
      ISUPKW = <SUPP-E-MP>                                                      READPL 367
      ISUPFL = <SUPP-F-MP>                                                      READPL 368
c              default master end-use meters to masters                         READPL 369
      DO  IM=1,13                                                               READPL 370
        IF (<METERS-EP> .GT. 0)  THEN                                           READPL 371
            <METERS-EP> = Iem + (<METERS-EP>-1) * Lem                           READPL 372
        ELSE                                                                    READPL 373
            <METERS-EP> = <MSTR-E-MP>                                           READPL 374
        ENDIF                                                                   READPL 375
      ENDDO                                                                     READPL 376
      DO  IM=1,6                                                                READPL 377
        IF (<METERS-FP> .GT. 0)  THEN                                           READPL 378
            <METERS-FP> = Ifm + (<METERS-FP>-1) * Lfm                           READPL 379
        ELSE                                                                    READPL 380
            <METERS-FP> = <MSTR-F-MP>                                           READPL 381
        ENDIF                                                                   READPL 382
      ENDDO                                                                     READPL 383
c              system level meters                                              READPL 384
      DO  NS=1,NSYS                                                             READPL 385
        NSP = IS + (NS-1)*NSS                                                   READPL 386
        IF (<MSTR-E-MS> .GT. 0)  <MSTR-E-MS> = Iem + (<MSTR-E-MS>-1)*Lem        READPL 387
        IF (<MSTR-F-MS> .GT. 0)  <MSTR-F-MS> = Ifm + (<MSTR-F-MS>-1)*Lfm        READPL 388
        IHTREJ  = IHTREJ + <HTREJ-E-MS>                                         READPL 389
        ISUPKW  = ISUPKW + <SUPP-E-MS>                                          READPL 390
        ISUPFL  = ISUPFL + <SUPP-F-MS>                                          READPL 391
        DO  IM=1,13                                                             READPL 392
          IF (<METERS-ES> .GT. 0)  THEN                                         READPL 393
              <METERS-ES> = Iem + (<METERS-ES>-1) * Lem                         READPL 394
          ELSE                                                                  READPL 395
              <METERS-ES> = <MSTR-E-MS>                                         READPL 396
              IF (<METERS-ES> .EQ. 0)  <METERS-ES> = <METERS-EP>                READPL 397
          ENDIF                                                                 READPL 398
        ENDDO                                                                   READPL 399
        DO  IM=1,6                                                              READPL 400
          IF (<METERS-FS> .GT. 0)  THEN                                         READPL 401
              <METERS-FS> = Ifm + (<METERS-FS>-1) * Lfm                         READPL 402
          ELSE                                                                  READPL 403
              <METERS-FS> = <MSTR-F-MS>                                         READPL 404
              IF (<METERS-FS> .EQ. 0)  <METERS-FS> = <METERS-FP>                READPL 405
          ENDIF                                                                 READPL 406
        ENDDO                                                                   READPL 407
c              zone level meters                                                READPL 408
        NSZ = <NZONES>                                                          READPL 409
        ISZ = <ISZONES>                                                         READPL 410
        DO  NZ=1,NSZ                                                            READPL 411
          ZP1 = ISZ + (NZ-1)*NZD                                                READPL 412
          ZP2 = <ZP2>                                                           READPL 413
          IF (<MSTR-E-MZ> .GT. 0)                                               READPL 414
     &        <MSTR-E-MZ> = Iem + (<MSTR-E-MZ>-1)*Lem                           READPL 415
          IF (<MSTR-F-MZ> .GT. 0)                                               READPL 416
     &        <MSTR-F-MZ> = Ifm + (<MSTR-F-MZ>-1)*Lfm                           READPL 417
          IHTREJ = IHTREJ + <HTREJ-E-MZ>                                        READPL 418
          ISUPKW = ISUPKW + <SUPP-E-MZ>                                         READPL 419
          ISUPFL = ISUPFL + <SUPP-F-MZ>                                         READPL 420
          DO  IM=1,13                                                           READPL 421
            IF (<METERS-EZ> .GT. 0)  THEN                                       READPL 422
                <METERS-EZ> = Iem + (<METERS-EZ>-1) * Lem                       READPL 423
            ELSE                                                                READPL 424
                <METERS-EZ> = <MSTR-E-MZ>                                       READPL 425
                IF (<METERS-EZ> .EQ. 0)  <METERS-EZ> = <METERS-ES>              READPL 426
            ENDIF                                                               READPL 427
          ENDDO                                                                 READPL 428
          DO  IM=1,6                                                            READPL 429
            IF (<METERS-FZ> .GT. 0)  THEN                                       READPL 430
                <METERS-FZ> = Ifm + (<METERS-FZ>-1) * Lfm                       READPL 431
            ELSE                                                                READPL 432
                <METERS-FZ> = <MSTR-F-MZ>                                       READPL 433
                IF (<METERS-FZ> .EQ. 0)  <METERS-FZ> = <METERS-FS>              READPL 434
            ENDIF                                                               READPL 435
          ENDDO                                                                 READPL 436
c              end zone loop                                                    READPL 437
        ENDDO                                                                   READPL 438
c              end systems loop                                                 READPL 439
      ENDDO                                                                     READPL 440
c              Create blocks for electric and fuel TDV2 reports                 -044   252
      DO  I=1,4                                                                 -044   253
        KtvTDV2(I) = 0                                                          -044   254
      ENDDO                                                                     -044   255
      IF (ITDV .gt. 0)  THEN  ! time-dependent valuation                        -044   256
        KtvTDV2(1) = NewTDV(0, 0)                                               -044   257
        KtvTDV2(2) = NewTDV(0, 0)                                               -044   258
c              create a mask to exclude end-use categories from                 -044   259
c              time-dependent valuation                                         -044   260
        DO  IE=1,19                                                             -044   261
          <mm;IncludeTDV> = 1.                                                  -044   262
        ENDDO                                                                   -044   263
        DO  II=1,10                                                             -044   264
          IF (<mm:EXCLUDE-TDV> .eq. 0)  Exit                                    -044   265
          IE = <mm:EXCLUDE-TDV>                                                 -044   266
          <mm;IncludeTDV> = 0.                                                  -044   267
        ENDDO                                                                   -044   268
      ENDIF                                                                     -044   269
c                                                                               READPL 441
c              Set up the meters                                                READPL 442
c              electrical                                                       READPL 443
      DO  I=1,4                                                                 READPL 444
        NumElecMeterTypes(I) = 0                                                READPL 445
      ENDDO                                                                     READPL 446
      DO  NMETER=1,Nem                                                          READPL 447
        Jem = Iem + (NMETER-1)*Lem                                              READPL 448
c              count different types of meters                                  READPL 449
        NumElecMeterTypes(<em:TYPE>)                                            READPL 450
     &                            = NumElecMeterTypes(<em:TYPE>) + 1            READPL 451
c              convert energy and demand unit indexes from rounded real         READPL 452
c              to integer                                                       READPL 453
        <em:UNIT-INDEX> = INT(<em:UNIT-REAL>)                                   READPL 454
        <em:DEM-INDEX>  = INT(<em:DEM-REAL>)                                    READPL 455
c              count the number of interior and exterior misc loads             READPL 456
        DO  II=1,10                                                             Proces 164
          IF (<em:INT-KW> .NE. 0)  THEN                                         READPL 458
            <em;NUM_INT> = II                                                   READPL 459
          ENDIF                                                                 -031    15
          <em:INT-SCH> = JSCHED(<em:INT-SCH>)                                   Time    57
        ENDDO                                                                   READPL 462
        DO  II=1,10                                                             Proces 165
          IF (<em:EXT-KW> .NE. 0)  THEN                                         READPL 464
            <em;NUM_EXT> = II                                                   READPL 465
          ENDIF                                                                 -031    17
          <em:EXT-SCH> = JSCHED(<em:EXT-SCH>)                                   Time    58
        ENDDO                                                                   READPL 468
        <em:REFG-SCH> = JSCHED(<em:REFG-SCH>)                                   Proces 166
c              convert parent number to pointer                                 READPL 469
        IF (<em;PARENT> .GT. 0)                                                 READPL 470
     &      <em;PARENT>  = Iem + (<em;PARENT>-1)*Lem                            READPL 471
c              design transformer loss                                          READPL 472
        <em;DESIGN_LOSS> = <em:TRANS-SIZE> * <em:TRANS-LOSS>                    READPL 473
        <em:LOSS-FPLR>   = Jcurve(<em:LOSS-FPLR>)                               -045b  145
        IF (ITDV .gt. 0)  THEN  ! time-dependent valuation                      -044   270
c              create block for TDV3 report                                     -044   271
          IF (<em:TYPE> .eq. 1)  THEN  ! utility-level                          -044   272
            <em;Ktv> = NewTDV(1, Min(2, NMETER))                                -044   273
          ELSE  ! submeter                                                      -044   274
            <em;Ktv> = NewTDV(1, 3)                                             -044   275
          ENDIF                                                                 -044   276
        ENDIF                                                                   -044   277
                                                                                -044   278
c              default equipment-ctrl command                                   READPL 475
        IF (<em:EQUIP-CTRL> .GT. 0)  THEN                                       -041f    3
          <em:EQUIP-CTRL> = Jcomp(Iec, Lec, <em:EQUIP-CTRL>)                    -041f    4
        ELSE                                                                    -041f    5
c              Default attach if only one EQUIP-CTRL defined for meter;         -041f    6
c              otherwise no default                                             -041f    7
          DO  Nctrl=1,Nec                                                       -041f    8
            Jec = Iec + (Nctrl-1)*Lec                                           -041f    9
            IF (<ec:TYPE> .NE. 5 .OR. <ec:ELEC-METER> .NE. Nmeter) Cycle        -041f   10
            IF (<em:EQUIP-CTRL> .EQ. 0)  THEN                                   -041f   11
              <em:EQUIP-CTRL> = Jec                                             -041f   12
            ELSE  ! multiple EQUIP-CTRLs for meter                              -041f   13
              CALL MSGSIM(-3,II,II,II,II)                                       -041f   14
              WRITE (IOUTPT, 9120)  (<em:NAME>,II=1,8)                          -041f   15
              <em:EQUIP-CTRL> = 0                                               -041f   16
              Exit                                                              -041f   17
            ENDIF                                                               -041f   18
          ENDDO                                                                 -041f   19
        ENDIF                                                                   -041f   20
        <em:TRACK-SCH>   = JSCHED(<em:TRACK-SCH>)                               Time    59
c              maximum meter capacity - set large so no limit                   READPL 478
c              in EQUIP-CTRL                                                    READPL 479
        Jme = Jem                                                               READPL 480
        <me;MAX_CAPACITY> = 1.0E10                                              READPL 481
c              store indexes for attached primary equipment                     READPL 482
        IF (<em:TYPE> .EQ. UtilityMeter  .OR.                                   READPL 483
     &      <em:TYPE> .EQ. SellMeter)  THEN                                     READPL 484
c             number of generators and possible combinations                    READPL 485
          IQ = 0                                                                READPL 486
          Ncombs = 1                                                            READPL 487
          DO  Neq=1,Ngn                                                         READPL 488
            Jgn = Ign + (Neq-1)*Lgn                                             READPL 489
c              generator demand-side meter                                      READPL 490
            IF (<gn:ELEC-METER> .EQ. Jem)  THEN                                 READPL 491
c                 store pointer to component common block                       READPL 492
              IQ = IQ + 1                                                       READPL 493
              <em;CogenJpePtrs> = <gn;Jpe>                                      READPL 494
c                 increment number of combinations                              READPL 495
              Ncombs = Ncombs * 2                                               READPL 496
            ENDIF                                                               READPL 497
          ENDDO                                                                 READPL 498
          <em;NumCogen>      = IQ                                               READPL 499
          <em;NumCogenCombs> = Ncombs - 1                                       READPL 500
        ENDIF                                                                   READPL 501
      ENDDO                                                                     READPL 502
c              fuel                                                             READPL 503
      DO  NMETER=1,Nfm                                                          READPL 504
        Jfm = Ifm + (NMETER-1)*Lfm                                              READPL 505
c              convert energy and demand unit indexes from rounded real         READPL 506
c              to integer                                                       READPL 507
        <fm:UNIT-INDEX> = INT(<fm:UNIT-REAL>)                                   READPL 508
        <fm:DEM-INDEX>  = INT(<fm:DEM-REAL>)                                    READPL 509
c              invert the Btu/unit value, and adjust for metric                 READPL 510
        <fm:BTU/UNIT> = 1.0 / <fm:BTU/UNIT>                                     READPL 511
        IF (MTRICR .EQ. 1)                                                      READPL 512
     &    <fm:BTU/UNIT> = <fm:BTU/UNIT> * VKONV(<fm:UNIT-INDEX>)                READPL 513
c              count the number of interior and exterior misc loads             READPL 514
        DO  II=1,10                                                             Proces 167
          IF (<fm:INT-BTU/HR> .NE. 0)  THEN                                     READPL 516
            <fm;NUM_INT>    = II                                                READPL 517
            <fm:INT-BTU/HR> = <fm:INT-BTU/HR> * 1.E6                            READPL 518
          ENDIF                                                                 -031    19
          <fm:INT-SCH> = JSCHED(<fm:INT-SCH>)                                   Time    60
        ENDDO                                                                   READPL 521
        DO  II=1,10                                                             Proces 168
          IF (<fm:EXT-BTU/HR> .NE. 0)  THEN                                     READPL 523
            <fm;NUM_EXT>    = II                                                READPL 524
            <fm:EXT-BTU/HR> = <fm:EXT-BTU/HR> * 1.E6                            READPL 525
          ENDIF                                                                 -031    21
          <fm:EXT-SCH> = JSCHED(<fm:EXT-SCH>)                                   Time    61
        ENDDO                                                                   READPL 528
c              Create subcomponent for time-dependent valuation                 -044   279
        IF (ITDV .gt. 0)  <fm;Ktv> = NewTDV(2, Min(2, NMETER))                  -044   280
      ENDDO                                                                     READPL 529
c              steam                                                            READPL 530
      DO  NMETER=1,Nsm                                                          READPL 531
        Jsm = Ism + (NMETER-1)*Lsm                                              READPL 532
c              convert energy and demand unit indexes from rounded real         READPL 533
c              to integer                                                       READPL 534
        <sm:UNIT-INDEX> = INT(<sm:UNIT-REAL>)                                   READPL 535
        <sm:DEM-INDEX>  = INT(<sm:DEM-REAL>)                                    READPL 536
c              invert the Btu/unit value, and adjust for metric                 READPL 537
        <sm:BTU/UNIT> = 1.0 / <sm:BTU/UNIT>                                     READPL 538
        IF (MTRICR .EQ. 1)                                                      READPL 539
     &    <sm:BTU/UNIT> = <sm:BTU/UNIT> * VKONV(<sm:UNIT-INDEX>)                READPL 540
c              count the number of interior and exterior misc loads             READPL 541
        DO  II=1,10                                                             Proces 169
          IF (<sm:INT-BTU/HR> .NE. 0)  THEN                                     READPL 543
            <sm;NUM_INT>    = II                                                READPL 544
            <sm:INT-BTU/HR> = <sm:INT-BTU/HR> * 1.E6                            READPL 545
          ENDIF                                                                 -031    23
          <sm:INT-SCH> = JSCHED(<sm:INT-SCH>)                                   Time    62
        ENDDO                                                                   READPL 548
        DO  II=1,10                                                             Proces 170
          IF (<sm:EXT-BTU/HR> .NE. 0)  THEN                                     READPL 550
            <sm;NUM_EXT>    = II                                                READPL 551
            <sm:EXT-BTU/HR> = <sm:EXT-BTU/HR> * 1.E6                            READPL 552
          ENDIF                                                                 -031    25
          <sm:EXT-SCH> = JSCHED(<sm:EXT-SCH>)                                   Time    63
        ENDDO                                                                   READPL 555
c              attach to loop                                                   READPL 556
        IF (<sm:LOOP> .GT.  0)  THEN                                            READPL 557
          Jlp = Ilp + (<sm:LOOP>-1)*Llp                                         READPL 558
          <sm:LOOP> = Jlp                                                       READPL 559
          <lp;STEAM_METER> = Jsm                                                READPL 560
        ENDIF                                                                   READPL 561
      ENDDO                                                                     READPL 562
c              chilled-water                                                    READPL 563
      DO  NMETER=1,Ncm                                                          READPL 564
        Jcm = Icm + (NMETER-1)*Lcm                                              READPL 565
c              convert energy and demand unit indexes from rounded real         READPL 566
c              to integer                                                       READPL 567
        <cm:UNIT-INDEX> = INT(<cm:UNIT-REAL>)                                   READPL 568
        <cm:DEM-INDEX>  = INT(<cm:DEM-REAL>)                                    READPL 569
c              invert the Btu/unit value, and adjust for metric                 READPL 570
        <cm:BTU/UNIT> = 1.0 / <cm:BTU/UNIT>                                     READPL 571
        IF (MTRICR .EQ. 1)                                                      READPL 572
     &    <cm:BTU/UNIT> = <cm:BTU/UNIT> * VKONV(<cm:UNIT-INDEX>)                READPL 573
c              count the number of interior and exterior misc loads             READPL 574
        DO  II=1,10                                                             Proces 171
          IF (<cm:INT-BTU/HR> .NE. 0)  THEN                                     READPL 576
            <cm;NUM_INT>    = II                                                READPL 577
            <cm:INT-BTU/HR> = <cm:INT-BTU/HR> * 1.E6                            READPL 578
          ENDIF                                                                 -031    27
          <cm:INT-SCH> = JSCHED(<cm:INT-SCH>)                                   Time    64
        ENDDO                                                                   READPL 581
        DO  II=1,10                                                             Proces 172
          IF (<cm:EXT-BTU/HR> .NE. 0)  THEN                                     READPL 583
            <cm;NUM_EXT>    = II                                                READPL 584
            <cm:EXT-BTU/HR> = <cm:EXT-BTU/HR> * 1.E6                            READPL 585
          ENDIF                                                                 -031    29
          <cm:EXT-SCH> = JSCHED(<cm:EXT-SCH>)                                   Time    65
        ENDDO                                                                   READPL 588
c              attach to loop                                                   READPL 589
        IF (<cm:LOOP> .GT.  0)  THEN                                            READPL 590
          Jlp = Ilp + (<cm:LOOP>-1)*Llp                                         READPL 591
          <cm:LOOP> = Jlp                                                       READPL 592
          <lp;CHW_METER> = Jcm                                                  READPL 593
        ENDIF                                                                   READPL 594
      ENDDO                                                                     READPL 595
c              total number of meters (for output to economics)                 READPL 596
      NumMeters = Nem + Nfm + Nsm + Ncm                                         READPL 597
c                                                                               READPL 598
c              Convert all loop references to another command from a            READPL 599
C              number to a pointer within AA.                                   READPL 600
c              Set up the circulation loops.                                    READPL 601
c                                                                               READPL 602
      CALL FILLN( 0, Nloop, 20 )                                                READPL 603
      CALL FILLN( NoType, NextType, 20 )                                        READPL 604
c              total number of secondary loops                                  READPL 605
      NLP2 = 0                                                                  READPL 606
c              initial set-up for all loops                                     READPL 607
      IF (Nlp .GT. 0)  THEN                                                     READPL 608
        DO  NL=1,Nlp                                                            READPL 609
c              pointer to loop                                                  READPL 610
          Jlp = Ilp + (NL-1)*Llp                                                READPL 611
c              loop type and subtype                                            READPL 612
          LoopType = <lp:TYPE>                                                  READPL 613
          SubType  = <lp:SUBTYPE>                                               READPL 614
c              count the various types of loops                                 READPL 615
          Nloop(LoopType,SubType) = Nloop(LoopType,SubType) + 1                 READPL 616
c              half of LOOP-SETPT-RNG                                           READPL 617
          <lp;SETPT_RNG2> = <lp:SETPT-RNG> * 0.5                                READPL 618
c              force the signs to be correct                                    READPL 619
          IF (LoopType .EQ. CHW  .OR.  LoopType .EQ. CW)  THEN                  READPL 620
c              values are positive for chilled water and condenser              READPL 621
            <lp:DESIGN-DT> = ABS(<lp:DESIGN-DT>)                                READPL 622
            <lp:SLOSS-DT>  = ABS(<lp:SLOSS-DT>)                                 READPL 623
            <lp:RLOSS-DT>  = ABS(<lp:RLOSS-DT>)                                 READPL 624
            DO  II=1,10                                                         Proces 173
              IF (<lp:PROCESS-LOAD> .EQ. 0.                                     Proces 174
     &                            .AND.  <lp:PROCESS-GPM> .EQ. 0)  EXIT         Proces 175
              <lp;NumProcess>      = II                                         Proces 176
              <lp:PROC-LOAD-SCH>   = JSCHED(<lp:PROC-LOAD-SCH>)                 Proces 177
              <lp:PROC-LOAD-DT>    = ABS(<lp:PROC-LOAD-DT>)                     Proces 178
              IF (<lp:PROC-LOAD-DT> .EQ. 0.)                                    Proces 179
     &            <lp:PROC-LOAD-DT> = <lp:DESIGN-DT>                            Proces 180
              <lp:PROCESS-LOAD>    = ABS(<lp:PROCESS-LOAD>) * 1.E6              Proces 181
            ENDDO                                                               Proces 182
          ELSE                                                                  READPL 629
c              values are negative for all heating-type loops                   READPL 630
            <lp:DESIGN-DT> = -ABS(<lp:DESIGN-DT>)                               READPL 631
            <lp:SLOSS-DT>  = -ABS(<lp:SLOSS-DT>)                                READPL 632
            <lp:RLOSS-DT>  = -ABS(<lp:RLOSS-DT>)                                READPL 633
            DO  II=1,10                                                         Proces 183
              IF (<lp:PROCESS-LOAD> .EQ. 0.                                     Proces 184
     &                            .AND.  <lp:PROCESS-GPM> .EQ. 0)  EXIT         Proces 185
              <lp;NumProcess>      = II                                         Proces 186
              <lp:PROC-LOAD-SCH>   = JSCHED(<lp:PROC-LOAD-SCH>)                 Proces 187
              <lp:PROC-LOAD-DT>    = -ABS(<lp:PROC-LOAD-DT>)                    Proces 188
              IF (<lp:PROC-LOAD-DT> .EQ. 0.)                                    Proces 189
     &            <lp:PROC-LOAD-DT> = <lp:DESIGN-DT>                            Proces 190
c                 wlhp may have either a positive or negative process           Proces 191
              IF (LoopType .NE. WLHP)  THEN                                     Proces 192
                <lp:PROCESS-LOAD> = -ABS(<lp:PROCESS-LOAD>) * 1.E6              Proces 193
              ELSE                                                              Proces 194
                <lp:PROCESS-LOAD> = <lp:PROCESS-LOAD> * 1.E6                    Proces 195
              ENDIF                                                             Proces 196
            ENDDO                                                               Proces 197
          ENDIF                                                                 READPL 643
c              check if secondary loop                                          READPL 644
          IF (SubType .EQ. SECONDARY)  THEN                                     READPL 645
            NLP2 = NLP2 + 1                                                     READPL 646
c              error if no primary                                              READPL 647
            IF (<lp:PRIMARY> .EQ. 0)  THEN                                      READPL 648
              CALL MSGSIM(-1,II,II,II,II)                                       READPL 649
              WRITE (IOUTPT,9101)  (<lp:NAME>,II=1,8)                           READPL 650
              call MessageBox( NULL, 'Missing PRIMARY LOOP -'                   READPL 651
     &          //' ABORTING'//char(0),'READSP Errors'//char(0), MB_OK          READPL 652
     &          + MB_ICONSTOP + MB_TASKMODAL )                                  READPL 653
              RETURN                                                            READPL 655
            ENDIF                                                               READPL 656
c              get pointer to primary loop                                      READPL 657
            Jlp2 = Jlp                                                          READPL 658
            Jlp  = Ilp + (<lp:PRIMARY>-1)*Llp                                   READPL 659
            IF (<lp:SUBTYPE> .NE. 1)  THEN                                      Bug40  300
c                 Secondary must attach to primary                              Bug40  301
              Jlp = Jlp2                                                        Bug40  302
              CALL MSGSIM(-1,II,II,II,II)                                       Bug40  303
              WRITE (IOUTPT,9114)  (<lp:NAME>,II=1,8)                           Bug40  304
              call MessageBox( NULL, 'Seconary loop must attach to '            Bug40  305
     &          //'primary - ABORTING'                                          Bug40  306
     &          //char(0),'Loop Design Errors'//char(0),                        Bug40  307
     &          MB_OK + MB_ICONSTOP + MB_TASKMODAL )                            Bug40  308
              RETURN                                                            Bug40  310
            ENDIF                                                               Bug40  311
            IF (<lp:TYPE> .NE. LoopType)  THEN                                  Bug40  312
c                 Primary must be same type as secondary                        Bug40  313
              Jlp = Jlp2                                                        Bug40  314
              CALL MSGSIM(-1,II,II,II,II)                                       Bug40  315
              WRITE (IOUTPT,9115)  (<lp:NAME>,II=1,8)                           Bug40  316
              call MessageBox( NULL, 'Primary/Secondary loops must be '         Bug40  317
     &          //'same type - ABORTING'                                        Bug40  318
     &          //char(0),'Loop Design Errors'//char(0),                        Bug40  319
     &          MB_OK + MB_ICONSTOP + MB_TASKMODAL )                            Bug40  320
              RETURN                                                            Bug40  322
            ENDIF                                                               Bug40  323
c              number of secondary loops attached to this primary               Bug40  324
            IF (<lp;NUM_2ND_LOOPS> .EQ. 50)  THEN                               -044c2   8
              CALL MSGSIM(-1,II,II,II,II)                                       Bug40  326
              WRITE (IOUTPT,9116) (<lp:NAME>,II=1,8)                            Bug40  327
              call MessageBox( NULL, 'Loop has more than 50 secondary '         -044c2   9
     &          //'loops - ABORTING'                                            Bug40  329
     &          //char(0),'Loop Design Errors'//char(0),                        Bug40  330
     &          MB_OK + MB_ICONSTOP + MB_TASKMODAL )                            Bug40  331
              RETURN                                                            Bug40  333
            ENDIF                                                               Bug40  334
            <lp;NUM_2ND_LOOPS> = <lp;NUM_2ND_LOOPS> + 1                         READPL 661
            L2 = <lp;NUM_2ND_LOOPS>                                             READPL 662
c              store secondary loop pointer in primary list                     READPL 663
            <lp;PTR_2ND_LOOPS> = Jlp2                                           READPL 664
c              point back at secondary and store primary pointer                READPL 665
            Jlp1 = Jlp                                                          READPL 666
            Jlp  = Jlp2                                                         READPL 667
            <lp:PRIMARY> = Jlp1                                                 READPL 668
          ENDIF                                                                 READPL 669
c              default aux meter to master                                      READPL 670
          IF (<lp:AUX-METER> .GT. 0)  THEN                                      READPL 671
              <lp:AUX-METER> = Iem + (<lp:AUX-METER>-1) * Lem                   READPL 672
          ELSE                                                                  READPL 673
              <lp:AUX-METER> = <AUX-E-MP>                                       READPL 674
          ENDIF                                                                 READPL 675
c              schedule and curve pointers                                      READPL 676
          <lp:HEAT-SCH>      = JSCHED(<lp:HEAT-SCH>)                            Time    66
          <lp:COOL-SCH>      = JSCHED(<lp:COOL-SCH>)                            Time    67
          <lp:PUMP-SCH>      = JSCHED(<lp:PUMP-SCH>)                            Time    68
          <lp:HT-RESET-SCH>  = JSCHED(<lp:HT-RESET-SCH>)                        Time    69
          <lp:HT-SETPT-SCH>  = JSCHED(<lp:HT-SETPT-SCH>)                        Time    70
          <lp:CL-RESET-SCH>  = JSCHED(<lp:CL-RESET-SCH>)                        Time    71
          <lp:CL-SETPT-SCH>  = JSCHED(<lp:CL-SETPT-SCH>)                        Time    72
          <lp:TUNNEL-SCH>    = JSCHED(<lp:TUNNEL-SCH>)                          Time    73
          <lp:AUX-SCH>       = JSCHED(<lp:AUX-SCH>)                             Time    75
          <lp:DHW-INLET-SCH> = JSCHED(<lp:DHW-INLET-SCH>)                       Time    76
          IF (<lp:PUMP> .GT. 0)  THEN                                           READPL 688
            Jpm = Ipm + (<lp:PUMP>-1) * Lpm                                     READPL 689
c              store pump attachment in loop data                               READPL 690
            <lp:PUMP> = Jpm                                                     READPL 691
c              store loop attachment in pump data                               READPL 692
            <pm;ATTACH>      = Jlp                                              READPL 693
            <pm;ATTACH_TYPE> = <lp:SUBTYPE>                                     READPL 694
          ENDIF                                                                 READPL 695
          IF (<lp:COST-DATA> .GT. 0)                                            -041f   21
     &        <lp:COST-DATA> = Imc + (<lp:COST-DATA>-1)*Lmc                     -041f   22
c              EQUIP-CTRL default attachments                                   -041f   23
          IF (<lp:HT-EQUIP-CTRL> .GT. 0)  THEN                                  -041f   24
              <lp:HT-EQUIP-CTRL> = Iec + (<lp:HT-EQUIP-CTRL>-1)*Lec             -041f   25
          ELSE                                                                  -041f   26
c              Default attach if only one EQUIP-CTRL defined for loop;          -041f   27
c              otherwise no default                                             -041f   28
            DO  Nctrl=1,Nec                                                     -041f   29
              Jec = Iec + (Nctrl-1)*Lec                                         -041f   30
              IF ((<ec:TYPE> .NE. 2  .AND.  <ec:TYPE> .NE. 3)                   -041f   31
     &                                .OR.  <ec:LOOP> .NE. NL)  Cycle           -041f   32
              IF (<lp:HT-EQUIP-CTRL> .EQ. 0)  THEN                              -041f   33
                <lp:HT-EQUIP-CTRL> = Jec                                        -041f   34
              ELSE  ! multiple EQUIP-CTRLs for loop                             -041f   35
                CALL MSGSIM(-3,II,II,II,II)                                     -041f   36
                WRITE (IOUTPT, 9118) (<lp:NAME>,II=1,8)                         -041f   37
                <lp:HT-EQUIP-CTRL> = 0                                          -041f   38
                Exit                                                            -041f   39
              ENDIF                                                             -041f   40
            ENDDO                                                               -041f   41
          ENDIF                                                                 -041f   42
          IF (<lp:CL-EQUIP-CTRL> .GT. 0)  THEN                                  -041f   43
              <lp:CL-EQUIP-CTRL> = Iec + (<lp:CL-EQUIP-CTRL>-1)*Lec             -041f   44
          ELSE                                                                  -041f   45
c              Default attach if only one EQUIP-CTRL defined for loop;          -041f   46
c              otherwise no default                                             -041f   47
            DO  Nctrl=1,Nec                                                     -041f   48
              Jec = Iec + (Nctrl-1)*Lec                                         -041f   49
              IF ((<ec:TYPE> .NE. 1  .AND.  <ec:TYPE> .NE. 4)                   -041f   50
     &                                .OR.  <ec:LOOP> .NE. NL)  Cycle           -041f   51
              IF (<lp:CL-EQUIP-CTRL> .EQ. 0)  THEN                              -041f   52
                <lp:CL-EQUIP-CTRL> = Jec                                        -041f   53
              ELSE  ! multiple EQUIP-CTRLs for loop                             -041f   54
                CALL MSGSIM(-3,II,II,II,II)                                     -041f   55
                WRITE (IOUTPT, 9119) (<lp:NAME>,II=1,8)                         -041f   56
                <lp:CL-EQUIP-CTRL> = 0                                          -041f   57
                Exit                                                            -041f   58
              ENDIF                                                             -041f   59
            ENDDO                                                               -041f   60
          ENDIF                                                                 -041f   61
c              get zp1 pointers for referenced zones                            READPL 702
          IF (<lp:SNAP-ZONE> .GT. 0)  THEN                                      READPL 703
            ZP2snap = IZ + (<lp:SNAP-ZONE>-1)*NCZD                              READPL 704
            DO  NS=1,NSYS                                                       READPL 705
              NSP = IS + (NS-1)*NSS                                             READPL 706
              ISZ = <ISZONES>                                                   READPL 707
              NSZ = <NZONES>                                                    READPL 708
              DO  NZ=1,NSZ                                                      READPL 709
                ZP1 = ISZ + (NZ-1)*NZD                                          READPL 710
                ZP2 = <ZP2>                                                     READPL 711
                IF (ZP2 .EQ. ZP2snap)  THEN                                     READPL 712
                  <lp:SNAP-ZONE> = ZP1                                          READPL 713
                  GOTO 601                                                      READPL 714
                ENDIF                                                           READPL 715
              ENDDO                                                             READPL 716
            ENDDO                                                               READPL 717
          ENDIF                                                                 READPL 718
  601     CONTINUE                                                              READPL 719
c              thermal loss attachments                                         READPL 720
c              thermal loss attachments                                         Bug40  335
          IF (<lp:SUPPLY-UA> .EQ. 0.  .AND.                                     Bug40  336
     &        <lp:SLOSS-DT>  .EQ. 0.  .AND.                                     Bug40  337
     &        <lp:RETURN-UA> .EQ. 0.  .AND.                                     Bug40  338
     &        <lp:RLOSS-DT>  .EQ. 0.)  THEN                                     Bug40  339
            <lp:LOCN>      = 0                                                  Bug40  340
            <lp:LOSS-ZONE> = 0                                                  Bug40  341
          ENDIF                                                                 Bug40  342
          IF (<lp:LOCN> .GT. 0)  THEN                                           READPL 721
            ZP1 = 0                                                             READPL 722
            IF (<lp:LOCN> .EQ. INDOORS)  THEN                                   READPL 723
c              loop is located indoors - attach the zone                        READPL 724
              IF (<lp:LOSS-ZONE> .GT. 0)  THEN                                  READPL 725
                ZP2loss = IZ + (<lp:LOSS-ZONE>-1)*NCZD                          READPL 726
                DO  NS=1,NSYS                                                   READPL 727
                  NSP = IS + (NS-1)*NSS                                         READPL 728
                  ISZ = <ISZONES>                                               READPL 729
                  NSZ = <NZONES>                                                READPL 730
                  DO  NZ=1,NSZ                                                  READPL 731
                    ZP1 = ISZ + (NZ-1)*NZD                                      READPL 732
                    ZP2 = <ZP2>                                                 READPL 733
                    IF (ZP2 .EQ. ZP2loss)  THEN                                 READPL 734
                      <lp:LOSS-ZONE> = ZP1                                      READPL 735
                      GOTO 602                                                  READPL 736
                    ENDIF                                                       READPL 737
                  ENDDO                                                         READPL 738
                ENDDO                                                           READPL 739
  602           CONTINUE                                                        READPL 740
              ELSE                                                              READPL 741
c              no zone found                                                    READPL 742
                CALL MSGSIM(-1,II,II,II,II)                                     READPL 743
                WRITE (IOUTPT,9111) (<lp:NAME>,II=1,8)                          READPL 744
                call MessageBox( NULL, 'Loop has no thermal loss zone -'        READPL 745
     &            //' ABORTING'//char(0),'Loop Design Errors'//char(0),         READPL 746
     &            MB_OK + MB_ICONSTOP + MB_TASKMODAL )                          READPL 747
                RETURN                                                          READPL 749
              ENDIF                                                             READPL 750
            ENDIF                                                               READPL 751
c              create and attach the zone interface blocks for                  READPL 752
c              thermal losses - note that ZP1 = 0 if not indoors                READPL 753
            CALL Create_Loss(Jlp,ZP1, ITHREE,                                   READPL 754
     &                        ITHREE,IONE, 1.0, <lp;SupplyLossPtr>)             READPL 755
            CALL Create_Loss(Jlp,ZP1, ITHREE,                                   READPL 756
     &                        ITHREE,IONE, 1.0, <lp;ReturnLossPtr>)             READPL 757
          ENDIF                                                                 READPL 758
c              store indexes for attached primary equipment                     READPL 759
          IF (SubType .EQ. PRIMARY)  THEN                                       READPL 760
c             number of heating, cooling, and total equipment units             READPL 761
            NeqH   = 0                                                          READPL 762
            NeqC   = 0                                                          READPL 763
            NeqT   = 0                                                          READPL 764
c              number of equipment combinations for LDIST                       READPL 765
            Ncombs = 1                                                          READPL 766
c              chillers                                                         READPL 767
            DO  Neq=1,Nch                                                       READPL 768
              Jch = Ich + (Neq-1)*Lch                                           READPL 769
c              chiller evaporator loop number (not converted to                 READPL 770
c              data pointer yet)                                                READPL 771
              IF (<ch:CHW-LOOP> .EQ. NL)  THEN                                  READPL 772
                NeqC = NeqC + 1                                                 READPL 773
                NeqT = NeqT + 1                                                 READPL 774
                IQ   = NeqT                                                     READPL 775
c              store pointer to component common block                          READPL 776
                <lp;Jpe> = <ch;Jpe>                                             READPL 777
c              increment number of combinations                                 READPL 778
                Ncombs = Ncombs * 2                                             READPL 779
c              free cooling chiller                                             FreeCl 130
                IF (<ch:TYPE> .EQ. 13)  THEN                                    FreeCl 131
                  NeqC = NeqC - 1                                               FreeCl 132
                  IF (<lp;FreeCoolChlr> .EQ. 0)  THEN                           FreeCl 133
                    <lp;FreeCoolChlr> = Jch                                     FreeCl 134
                  ELSE                                                          FreeCl 135
                    CALL MSGSIM(-1,II,II,II,II)                                 FreeCl 136
                    WRITE (IOUTPT,9112) (<lp:NAME>,II=1,8)                      FreeCl 137
                   call MessageBox(NULL,'Multiple WaterSide Economizers'        FreeCl 138
     &               //' - ABORTING'//char(0),'READSP Errors'//char(0),         FreeCl 139
     &               MB_OK + MB_ICONSTOP + MB_TASKMODAL )                       FreeCl 140
                    RETURN                                                      FreeCl 142
                  ENDIF                                                         FreeCl 143
                ENDIF                                                           FreeCl 144
              ENDIF                                                             READPL 780
c              heating loop number for chillers that can heat (not              ChlrHP1056
c              converted to data pointer yet)                                   ChlrHP1057
              IF ((<ch:ALGORITHM> .EQ. Chiller_Gas1  .OR.                       ChlrHP1058
     &             <ch:ALGORITHM> .EQ. Chiller_LoopHP1)                         ChlrHP1059
     &                            .AND.  <ch:HW-LOOP> .EQ. NL)  THEN            ChlrHP1060
                NeqH = NeqH + 1                                                 ChlrHP1061
                NeqT = NeqT + 1                                                 ChlrHP1062
                IQ   = NeqT                                                     ChlrHP1063
c              store pointer to heater block                                    ChlrHP1064
                <lp;Jpe> = <ch;Jpe_HEAT>                                        ChlrHP1065
c              increment number of combinations                                 ChlrHP1066
                Ncombs = Ncombs * 2                                             ChlrHP1067
              ELSEIF (<ch:ALGORITHM> .EQ. Chiller_HP1  .AND.                    ChlrHP1068
     &                                   <ch:CHW-LOOP> .EQ. NL)  THEN           ChlrHP1069
                NeqH = NeqH + 1                                                 ChlrHP1070
              ENDIF                                                             ChlrHP1071
c                 CW side of water-side economizer                              FreeCl 145
              IF (<ch:TYPE> .EQ. 13  .AND.  <ch:CW-LOOP> .EQ. NL)  THEN         FreeCl 146
                IF (<lp;FreeCoolChlr> .EQ. 0)  THEN                             FreeCl 147
                  <lp;FreeCoolChlr> = -Jch                                      FreeCl 148
                ELSE                                                            FreeCl 149
                  CALL MSGSIM(-1,II,II,II,II)                                   FreeCl 150
                  WRITE (IOUTPT,9112) (<lp:NAME>,II=1,8)                        FreeCl 151
                  call MessageBox(NULL,'Multiple WaterSide Economizers'         FreeCl 152
     &              //' - ABORTING'//char(0),'READSP Errors'//char(0),          FreeCl 153
     &              MB_OK + MB_ICONSTOP + MB_TASKMODAL )                        FreeCl 154
                  RETURN                                                        FreeCl 156
                ENDIF                                                           FreeCl 157
              ENDIF                                                             FreeCl 158
            ENDDO                                                               READPL 793
c                                                                               FreeCl 159
            IF (<lp;FreeCoolChlr> .LT. 0)  THEN                                 FreeCl 160
c              CW loop supplying a water-side economizer - can only             FreeCl 161
c              supply one CHW loop                                              FreeCl 162
              LoopCHW = 0                                                       FreeCl 163
              DO  Neq=1,Nch                                                     FreeCl 164
                Jch = Ich + (Neq-1)*Lch                                         FreeCl 165
                IF (<ch:CW-LOOP> .EQ. NL)  THEN                                 FreeCl 166
                  IF (LoopCHW .EQ. 0  .OR.                                      FreeCl 167
     &                LoopCHW .EQ. <ch:CHW-LOOP>)  THEN                         FreeCl 168
                    LoopCHW = <ch:CHW-LOOP>                                     FreeCl 169
                  ELSE                                                          FreeCl 170
                    CALL MSGSIM(-1,II,II,II,II)                                 FreeCl 171
                    WRITE (IOUTPT,9113) (<lp:NAME>,II=1,8)                      FreeCl 172
                    call MessageBox(NULL,'WaterSide Econo Overlap -'            FreeCl 173
     &                //' ABORTING'//char(0),'READSP Errors'//char(0),          FreeCl 174
     &                MB_OK + MB_ICONSTOP + MB_TASKMODAL )                      FreeCl 175
                    RETURN                                                      FreeCl 177
                  ENDIF                                                         FreeCl 178
                ENDIF                                                           FreeCl 179
              ENDDO                                                             FreeCl 180
            ENDIF                                                               FreeCl 181
c                                                                               READPL 794
c              boilers                                                          READPL 795
            BoilerOnLoop = .False.                                              Bug40  343
            DO  Neq=1,Nbl                                                       READPL 796
              Jbl = Ibl + (Neq-1) * Lbl                                         READPL 797
c              boiler loop number (not converted to                             READPL 798
c              data pointer yet)                                                READPL 799
              IF (<bl:HW-LOOP> .EQ. NL)  THEN                                   READPL 800
                BoilerOnLoop = .True.                                           Bug40  344
                NeqH = NeqH + 1                                                 READPL 801
                NeqT = NeqT + 1                                                 READPL 802
                IQ   = NeqT                                                     READPL 803
c              store pointer to component common block                          READPL 804
                <lp;Jpe> = <bl;Jpe>                                             READPL 805
c              increment number of combinations                                 READPL 806
                Ncombs = Ncombs * 2                                             READPL 807
              ENDIF                                                             READPL 808
            ENDDO                                                               READPL 809
c                                                                               READPL 810
c              dw heaters                                                       READPL 811
            DO  Neq=1,Ndw                                                       READPL 812
              Jdw = Idw + (Neq-1) * Ldw                                         READPL 813
c              dhw loop number (not converted to data pointer yet)              READPL 814
              IF (<dw:DHW-LOOP> .EQ. NL)  THEN                                  READPL 815
                NeqH = NeqH + 1                                                 READPL 816
                NeqT = NeqT + 1                                                 READPL 817
                IQ   = NeqT                                                     READPL 818
c              store pointer to component common block                          READPL 819
                <lp;Jpe> = <dw;Jpe>                                             READPL 820
c              increment number of combinations                                 READPL 821
                Ncombs = Ncombs * 2                                             READPL 822
              ENDIF                                                             READPL 823
            ENDDO                                                               READPL 824
c                                                                               READPL 825
c              cooling towers                                                   READPL 826
            DO  Neq=1,Ntw                                                       READPL 827
              Jtw = Itw + (Neq-1) * Ltw                                         READPL 828
c              tower condenser loop number (not converted to                    READPL 829
c              data pointer yet)                                                READPL 830
              IF (<tw:CW-LOOP> .EQ. NL)  THEN                                   READPL 831
                NeqC = NeqC + 1                                                 READPL 832
                NeqT = NeqT + 1                                                 READPL 833
                IQ   = NeqT                                                     READPL 834
c              store pointer to component common block                          READPL 835
                <lp;Jpe> = <tw;Jpe>                                             READPL 836
c              increment number of combinations                                 READPL 837
                Ncombs = Ncombs * 2                                             READPL 838
              ENDIF                                                             READPL 839
            ENDDO                                                               READPL 840
c                                                                               READPL 841
c             ground-loop heat-exchangers                                       READPL 842
            DO  Neq=1,Ngl                                                       READPL 843
              Jgl = Igl + (Neq-1)*Lgl                                           READPL 844
c              attached loop number (not converted to                           READPL 845
c              data pointer yet)                                                READPL 846
              IF (<gl:LOOP> .EQ. NL)  THEN                                      READPL 847
c                    GLHX cannot coexist with boiler on same loop               Bug40  345
                IF (BoilerOnLoop)  THEN                                         Bug40  346
                  CALL MSGSIM(-1,II,II,II,II)                                   Bug40  347
                  WRITE (IOUTPT,9117) (<lp:NAME>,II=1,8)                        Bug40  348
                  call MessageBox( NULL, 'Loop has a boiler and GLHX '          Bug40  349
     &              //'- ABORTING'                                              Bug40  350
     &              //char(0),'Loop Design Errors'//char(0),                    Bug40  351
     &              MB_OK + MB_ICONSTOP + MB_TASKMODAL )                        Bug40  352
                  RETURN                                                        Bug40  354
                ENDIF                                                           Bug40  355
                NeqC = NeqC + 1                                                 READPL 848
                NeqT = NeqT + 1                                                 READPL 849
                IQ = NeqT                                                       READPL 850
c              store pointer to component common block                          READPL 851
                <lp;Jpe> = <gl;Jpe>                                             READPL 852
c              increment number of combinations                                 READPL 853
                Ncombs = Ncombs * 2                                             READPL 854
c              repeat for heating mode                                          READPL 855
                NeqH = NeqH + 1                                                 READPL 856
                NeqT = NeqT + 1                                                 READPL 857
                IQ   = NeqT                                                     READPL 858
c              store pointer to heating mode component common block             READPL 859
                <lp;Jpe> = <gl;Jpe_HEAT>                                        READPL 860
c              increment number of combinations                                 READPL 861
                Ncombs = Ncombs * 2                                             READPL 862
c              set flag to indicate GLHX attached to this loop                  READPL 863
                <lp;GLHX_Flag> = 1                                              READPL 864
              ENDIF                                                             READPL 865
            ENDDO                                                               READPL 866
c                                                                               READPL 867
c             thermal storage - after all other equipment (necessary            READPL 868
c             for default load allocation)                                      READPL 869
            NumTES = 0                                                          READPL 870
            DO  Neq=1,Ntk                                                       READPL 871
              Jtk = Itk + (Neq-1)*Ltk                                           READPL 872
c              TES discharge loop number (not converted to                      READPL 873
c              data pointer yet)                                                READPL 874
              IF (<tk:DCHRG-LOOP> .EQ. NL)  THEN                                READPL 875
                NumTES = NumTES + 1                                             READPL 876
                IQ = NeqT + NumTES                                              READPL 877
c              store pointer to component common block                          READPL 878
                <lp;Jpe> = <tk;Jpe>                                             READPL 879
                IF (<tk:TYPE> .EQ. ColdTank)  THEN                              READPL 880
                  <lp;COLD_STORAGE> = <tk;Jpe>                                  READPL 881
                ELSE                                                            READPL 882
                  <lp;HOT_STORAGE> = <tk;Jpe>                                   READPL 883
                ENDIF                                                           READPL 884
c              increment number of combinations                                 READPL 885
                Ncombs = Ncombs * 2                                             READPL 886
              ENDIF                                                             READPL 887
            ENDDO                                                               READPL 888
c                                                                               READPL 889
c              Maximum of 10 suppliers/loop                                     -042L4   1
            IF (NeqT + NumTES .gt. 10)  THEN                                    -042L4   2
              Call MSGSIM(-1,II,II,II,II)                                       -042L4   3
              Write (IOUTPT, 9121)  (<lp:NAME>,II=1,8)                          -042L4   4
              Call MessageBox( NULL,                                            -042L4   5
     &       'More than 10 primary equipment'//char(10)//char(13)//             -042L4   6
     &       ' units on one circulation loop'//char(0),                         -042L4   7
     &       'CIRCULATION-LOOP Errors'//char(0),                                -042L4   8
     &        MB_OK + MB_ICONSTOP + MB_TASKMODAL )                              -042L4   9
              Return                                                            -042L4  11
            ENDIF                                                               -042L4  12
c              store parameters for hourly load distribution calcs              READPL 890
            <lp;HT_NUM_EQUIP>  = NeqH                                           READPL 891
            <lp;CL_NUM_EQUIP>  = NeqC                                           READPL 892
            <lp;NUM_EQUIP>     = NeqT                                           READPL 893
            <lp;NUM_EQUIP&TES> = NeqT + NumTES                                  READPL 894
            <lp;NCOMB_EQUIP>   = Ncombs - 1                                     READPL 895
c                                                                               READPL 896
c             Store indexes for attached heat recovery equipment                READPL 897
c             number of heating, cooling, and total equipment units             READPL 898
            NeqH   = 0                                                          READPL 899
            NeqC   = 0                                                          READPL 900
            NeqT   = 0                                                          READPL 901
c             number of equipment combinations for LDIST                        READPL 902
            Ncombs = 1                                                          READPL 903
c                                                                               READPL 904
c              cogeneration                                                     READPL 905
            DO  Neq=1,Ngn                                                       READPL 906
              Jgn = Ign + (Neq-1) * Lgn                                         READPL 907
c              generation exhaust recovery loop                                 READPL 908
              IF (<gn:EXH-LOOP> .EQ. Jlp)  THEN                                 READPL 909
                NeqH = NeqH + 1                                                 READPL 910
                NeqT = NeqT + 1                                                 READPL 911
                IQ   = NeqT                                                     READPL 912
c              store pointer to component common block                          READPL 913
                <lp;Jpe_HtRcvr> = <gn;Jpe_Exhaust>                              READPL 914
c              increment number of combinations                                 READPL 915
                Ncombs = Ncombs * 2                                             READPL 916
              ENDIF                                                             READPL 917
              IF (<gn:JAC-LOOP> .EQ. Jlp  .AND.                                 READPL 918
     &            <gn:JAC-LOOP> .NE. <gn:EXH-LOOP>)  THEN                       READPL 919
                NeqH = NeqH + 1                                                 READPL 920
                NeqT = NeqT + 1                                                 READPL 921
                IQ   = NeqT                                                     READPL 922
                <lp;Jpe_HtRcvr> = <gn;Jpe_Jacket>                               READPL 923
                Ncombs = Ncombs * 2                                             READPL 924
              ENDIF                                                             READPL 925
            ENDDO                                                               READPL 926
c                                                                               READPL 927
            <lp;NumHtRcvr>     = NeqT                                           READPL 928
            <lp;NumHtRcvrComb> = Ncombs                                         READPL 929
c                                                                               READPL 930
c             end of attachment calcs                                           READPL 931
          ENDIF                                                                 READPL 932
c             end of loop calcs                                                 READPL 933
        ENDDO                                                                   READPL 934
      ENDIF                                                                     READPL 935
c             set the simulation order of the loops, skipping the               READPL 936
c             loop types which dont exist                                       READPL 937
      NextTypeIndex = 0                                                         READPL 938
      IF (Nloop(CHW,1) .GT. 0)  THEN                                            READPL 939
c             chilled water                                                     READPL 940
        NextTypeIndex = NextTypeIndex + 1                                       READPL 941
        NextType(NextTypeIndex) = CHW                                           READPL 942
      ENDIF                                                                     READPL 943
      IF (Nloop(PIPE2,1) .GT. 0)  THEN                                          READPL 944
c             2-pipe in cooling mode                                            READPL 945
        NextTypeIndex = NextTypeIndex + 1                                       READPL 946
        NextType(NextTypeIndex) = PIPE2                                         READPL 947
      ENDIF                                                                     READPL 948
c             save pointer to start of heat-rejection for cogeneration          READPL 949
      IF (Ngn .GT. 0)  CogenIterateIndex = NextTypeIndex                        READPL 950
      IF (Nloop(WLHP,1) .GT. 0)  THEN                                           READPL 951
c             WLHP in heat rejection mode                                       READPL 952
        NextTypeIndex = NextTypeIndex + 1                                       READPL 953
        NextType(NextTypeIndex) = WLHP                                          READPL 954
      ENDIF                                                                     READPL 955
      IF (Nloop(CW,1) .GT. 0)  THEN                                             READPL 956
c             condenser water                                                   READPL 957
        NextTypeIndex = NextTypeIndex + 1                                       READPL 958
        NextType(NextTypeIndex) = CW                                            READPL 959
      ENDIF                                                                     READPL 960
      IF (Ngn .GT. 0)  THEN                                                     READPL 961
c             cogeneration                                                      READPL 962
        NextTypeIndex = NextTypeIndex + 1                                       READPL 963
        NextType(NextTypeIndex) = COGEN                                         READPL 964
      ENDIF                                                                     READPL 965
      IF (Nloop(HW,1) .GT. 0)  THEN                                             READPL 966
c             hot water                                                         READPL 967
        NextTypeIndex = NextTypeIndex + 1                                       READPL 968
        NextType(NextTypeIndex) = HW                                            READPL 969
      ENDIF                                                                     READPL 970
      IF (Nloop(PIPE2,1) .GT. 0)  THEN                                          READPL 971
c             2-pipe in heating mode                                            READPL 972
        NextTypeIndex = NextTypeIndex + 1                                       READPL 973
        NextType(NextTypeIndex) = PIPE2h                                        READPL 974
      ENDIF                                                                     READPL 975
      IF (Nloop(WLHP,1) .GT. 0)  THEN                                           READPL 976
c             WLHP in heating mode                                              READPL 977
        NextTypeIndex = NextTypeIndex + 1                                       READPL 978
        NextType(NextTypeIndex) = WLHPh                                         READPL 979
      ENDIF                                                                     READPL 980
      IF (Nloop(DHW,1) .GT. 0)  THEN                                            READPL 981
c             domestic hot water                                                READPL 982
        NextTypeIndex = NextTypeIndex + 1                                       READPL 983
        NextType(NextTypeIndex) = DHW                                           READPL 984
      ENDIF                                                                     READPL 985
      IF (Ngn .GT. 0)  THEN                                                     READPL 986
c             2nd pass thru cogeneration                                        READPL 987
        NextTypeIndex = NextTypeIndex + 1                                       READPL 988
        NextType(NextTypeIndex) = COGEN                                         READPL 989
      ENDIF                                                                     READPL 990
c              pointers in pumps                                                READPL1007
      IF (Npm .GT. 0)  THEN                                                     READPL1008
        DO  NPMP=1,Npm                                                          READPL1009
          Jpm = Ipm + (NPMP-1)*Lpm                                              READPL1010
          IF (<pm:ELEC-METER> .GT. 0)  THEN                                     READPL1011
              <pm:ELEC-METER> = Iem + (<pm:ELEC-METER>-1)*Lem                   READPL1012
          ELSE                                                                  READPL1013
              <pm:ELEC-METER> = <AUX-E-MP>                                      READPL1014
          ENDIF                                                                 READPL1015
          <pm:HEAD-FGPM>     = Jcurve(<pm:HEAD-FGPM>)                           -045b  146
          <pm:HP-FGPM>       = Jcurve(<pm:HP-FGPM>)                             -045b  147
          <pm:VFD-LOSS-FPLR> = Jcurve(<pm:VFD-LOSS-FPLR>)                       -045b  148
          IF (<pm:COST-DATA> .GT. 0)                                            READPL1018
     &             <pm:COST-DATA> = Imc + (<pm:COST-DATA>-1)*Lmc                READPL1019
                                                                                READPL1020
        ENDDO                                                                   READPL1021
      ENDIF                                                                     READPL1022
c              set up plant interface in all systems                            READPL1023
c              and zones                                                        READPL1024
      DO  NS=1,NSYS                                                             READPL1025
        NSP   = IS + (NS-1)*NSS                                                 READPL1026
        ICODE = <SYSTEM-TYPE>                                                   READPL1027
        IF (<DHW-LOOP> .GT. 0)                                                  READPL1028
     &      <DHW-LOOP> = Ilp + (<DHW-LOOP>-1)*Llp                               READPL1029
c                                                                               READPL1030
        IF (<HW-LOOP> .GT. 0)                                                   READPL1031
     &      <HW-LOOP> = Ilp + (<HW-LOOP>-1)*Llp                                 READPL1032
c              substitute pointers to DHW loop for dhw-hydronic systems         READPL1033
        IF (<HEAT-SOURCE> .EQ. -3                                               READPL1034
     &      .OR.  <SUPP-SOURCE> .EQ. -3                                         READPL1035
     &      .OR.  <ZONE-HEAT-SOURCE> .EQ. -3)                                   READPL1036
     &    <HW-LOOP> = <DHW-LOOP>                                                READPL1037
        IF (<PHW-LOOP> .GT. 0)  THEN                                            READPL1038
            <PHW-LOOP> = Ilp + (<PHW-LOOP>-1)*Llp                               READPL1039
        ELSE                                                                    READPL1040
            <PHW-LOOP> = <HW-LOOP>                                              READPL1041
        ENDIF                                                                   READPL1042
        IF (<PREHEAT-SOURCE> .EQ. -3)  <PHW-LOOP> = <DHW-LOOP>                  READPL1043
        IF (<DESC-LOOP> .GT. 0)  THEN                                           READPL1044
            <DESC-LOOP> = Ilp + (<DESC-LOOP>-1)*Llp                             READPL1045
        ELSEIF (<DESC-HEAT-SOURCE> .EQ. -1)  THEN                               READPL1046
            <DESC-LOOP> = <HW-LOOP>                                             READPL1047
        ENDIF                                                                   READPL1048
        IF (<DESC-HEAT-SOURCE> .EQ. 6)  THEN                                    READPL1049
c              desiccant is regenerated using a chiller/heater                  READPL1050
          IF (<DESC-CHILLER> .GT. 0)  THEN                                      READPL1051
              <DESC-CHILLER> = Ich + (<DESC-CHILLER>-1)*Lch                     READPL1052
          ELSE                                                                  READPL1053
c              no chiller specified - default to first chiller/heater           READPL1054
            DO  Neq=1,Nch                                                       READPL1055
              Jch = Ich + (Neq-1)*Lch                                           READPL1056
              IF (<ch:TYPE> .EQ. GASABSOR                                       READPL1057
     &          .AND.  <DESC-CHILLER> .EQ. 0)  <DESC-CHILLER> = Jch             READPL1058
            ENDDO                                                               READPL1059
            IF (<DESC-CHILLER> .EQ. 0)  THEN                                    READPL1060
c              error if no chiller found                                        READPL1061
              CALL MSGSIM(-1,II,II,II,II)                                       READPL1062
              WRITE (IOUTPT,9109)  (<SYSTEM-NAME>,II=1,8)                       READPL1063
              call MessageBox( NULL, 'Missing desiccant chiller -'              READPL1064
     &          //' ABORTING'//char(0),'READSP Errors'//char(0), MB_OK          READPL1065
     &          + MB_ICONSTOP + MB_TASKMODAL )                                  READPL1066
              RETURN                                                            READPL1068
            ELSE                                                                READPL1069
c              say which chiller will be used                                   READPL1070
              CALL MSGSIM(-2,II,II,II,II)                                       READPL1071
              WRITE (IOUTPT,9109)  (<SYSTEM-NAME>,II=1,8),                      READPL1072
     &                             (<ch:NAME>,II=1,8)                           READPL1073
            ENDIF                                                               READPL1074
          ENDIF                                                                 READPL1075
          RegenFlag = .TRUE.                                                    READPL1076
        ELSE                                                                    READPL1077
          <DESC-CHILLER> = 0                                                    READPL1078
        ENDIF                                                                   READPL1079
        IF (<CHW-LOOP> .GT. 0)                                                  READPL1080
     &      <CHW-LOOP> = Ilp + (<CHW-LOOP>-1)*Llp                               READPL1081
        IF (<CW-LOOP> .GT. 0)                                                   READPL1082
     &      <CW-LOOP> = Ilp + (<CW-LOOP>-1)*Llp                                 READPL1083
        IF (<WSE-LOOP> .GT. 0)  THEN                                            READPL1084
            <WSE-LOOP> = Ilp + (<WSE-LOOP>-1)*Llp                               READPL1085
        ELSEIF (<WS-ECONO> .EQ. 1)  THEN                                        READPL1086
c              default water-side econo loop to same as                         READPL1087
c              water-cooled condenser                                           READPL1088
            <WSE-LOOP> = <CW-LOOP>                                              READPL1089
        ENDIF                                                                   READPL1090
        IF (<BBRD-LOOP> .GT. 0)  THEN                                           READPL1091
            <BBRD-LOOP> = Ilp + (<BBRD-LOOP>-1)*Llp                             READPL1092
        ELSE                                                                    READPL1093
            <BBRD-LOOP> = <HW-LOOP>                                             READPL1094
        ENDIF                                                                   READPL1095
        IF (<BASEBOARD-SOURCE> .EQ. -3)  <BBRD-LOOP> = <DHW-LOOP>               READPL1096
        IF (<HTREC-DW-HEATER> .GT. 0)                                           READPL1097
     &      <HTREC-DW-HEATER> = Idw + (<HTREC-DW-HEATER>-1)*Ldw                 READPL1098
        IF (<REFG-CW-LOOP> .GT. 0)                                              READPL1099
     &      <REFG-CW-LOOP> = Ilp + (<REFG-CW-LOOP>-1)*Llp                       READPL1100
c              loop thru zones                                                  READPL1101
        ISZ = <ISZONES>                                                         READPL1102
        NSZ = <NZONES>                                                          READPL1103
        DO 700  NZ=1,NSZ                                                        READPL1104
          ZP1 = ISZ + (NZ-1)*NZD                                                READPL1105
          ZP2 = <ZP2>                                                           READPL1106
c              only conditioned zones or plenums have loop attachments          READPL1107
          IF (<ZONE-TYPE> .EQ. 2)  CYCLE                                        READPL1108
c              default all zonal loops attachments to system level              READPL1109
          IF (<DHW-LOOPZ> .GT. 0)  THEN                                         READPL1110
              <DHW-LOOPZ> = Ilp + (<DHW-LOOPZ>-1)*Llp                           READPL1111
          ELSE                                                                  READPL1112
              <DHW-LOOPZ> = <DHW-LOOP>                                          READPL1113
          ENDIF                                                                 READPL1114
          IF (<HW-LOOPZ> .GT. 0)  THEN                                          READPL1115
              <HW-LOOPZ> = Ilp + (<HW-LOOPZ>-1)*Llp                             READPL1116
          ELSE                                                                  READPL1117
              <HW-LOOPZ> = <HW-LOOP>                                            READPL1118
          ENDIF                                                                 READPL1119
c              override for gas hydronic                                        READPL1120
          IF (<ZONE-HEAT-SOURCE> .EQ. -3)  <HW-LOOPZ> = <DHW-LOOPZ>             READPL1121
          IF (<BBRD-LOOPZ> .GT. 0)  THEN                                        READPL1122
              <BBRD-LOOPZ> = Ilp + (<BBRD-LOOPZ>-1)*Llp                         READPL1123
          ELSE                                                                  READPL1124
              <BBRD-LOOPZ> = <BBRD-LOOP>                                        READPL1125
          ENDIF                                                                 READPL1126
c              override for dhw hydronic                                        READPL1127
          IF (<BASEBOARD-SOURCE> .EQ. -3)  <BBRD-LOOPZ> = <DHW-LOOPZ>           READPL1128
          IF (<CHW-LOOPZ> .GT. 0)  THEN                                         READPL1129
              <CHW-LOOPZ> = Ilp + (<CHW-LOOPZ>-1)*Llp                           READPL1130
          ELSE                                                                  READPL1131
              <CHW-LOOPZ> = <CHW-LOOP>                                          READPL1132
          ENDIF                                                                 READPL1133
          IF (<CW-LOOPZ> .GT. 0)  THEN                                          READPL1134
              <CW-LOOPZ> = Ilp + (<CW-LOOPZ>-1)*Llp                             READPL1135
          ELSE                                                                  READPL1136
              <CW-LOOPZ> = <CW-LOOP>                                            READPL1137
          ENDIF                                                                 READPL1138
          IF (<WSE-LOOPZ> .GT. 0)  THEN                                         READPL1139
              <WSE-LOOPZ> = Ilp + (<WSE-LOOPZ>-1)*Llp                           READPL1140
          ELSE                                                                  READPL1141
              <WSE-LOOPZ> = <WSE-LOOP>                                          READPL1142
          ENDIF                                                                 READPL1143
c              default the zonal coil valve type and head to the system         READPL1144
c              level                                                            READPL1145
          IF (<HW-VALVE-TYPEZ> .EQ. 0)                                          READPL1146
     &        <HW-VALVE-TYPEZ> = <HW-VALVE-TYPE>                                READPL1147
          IF (<HW-COIL-HEADZ>  .EQ. 0.)                                         READPL1148
     &        <HW-COIL-HEADZ>  = <HW-COIL-HEAD>                                 READPL1149
c              default the zonal coil temp change to the system                 READPL1150
c              master, if specified; otherwise to the loop default              READPL1151
          IF (<HW-COIL-DTZ> .EQ. 0.)  THEN                                      READPL1152
            IF (<HW-COIL-DT> .NE. 0.)  THEN                                     READPL1153
                <HW-COIL-DTZ>  = -ABS(<HW-COIL-DT>)                             READPL1154
            ELSE                                                                READPL1155
              IF (<HW-LOOPZ> .GT. 0)  THEN                                      READPL1156
                Jlp = <HW-LOOPZ>                                                READPL1157
                <HW-COIL-DTZ>  = -ABS(<lp:DESIGN-DT>)                           READPL1158
              ENDIF                                                             READPL1159
            ENDIF                                                               READPL1160
          ELSE                                                                  READPL1161
              <HW-COIL-DTZ>    = -ABS(<HW-COIL-DTZ>)                            READPL1162
          ENDIF                                                                 READPL1163
          IF (<BBRD-VALVE-TYPEZ> .EQ. 0)                                        READPL1164
     &        <BBRD-VALVE-TYPEZ> = <BBRD-VALVE-TYPE>                            READPL1165
          IF (<BBRD-COIL-HEADZ>  .EQ. 0.)                                       READPL1166
     &        <BBRD-COIL-HEADZ>  = <BBRD-COIL-HEAD>                             READPL1167
          IF (<BBRD-COIL-DTZ> .EQ. 0.)  THEN                                    READPL1168
            IF (<BBRD-COIL-DT> .NE. 0.)  THEN                                   READPL1169
                <BBRD-COIL-DTZ>    = -ABS(<BBRD-COIL-DT>)                       READPL1170
            ELSE                                                                READPL1171
              IF (<BBRD-LOOPZ> .GT. 0)  THEN                                    READPL1172
                Jlp = <BBRD-LOOPZ>                                              READPL1173
                <BBRD-COIL-DTZ> = -ABS(<lp:DESIGN-DT>)                          READPL1174
              ENDIF                                                             READPL1175
            ENDIF                                                               READPL1176
          ELSE                                                                  READPL1177
              <BBRD-COIL-DTZ>   = -ABS(<BBRD-COIL-DTZ>)                         READPL1178
          ENDIF                                                                 READPL1179
          IF (<CHW-VALVE-TYPEZ> .EQ. 0)                                         READPL1180
     &        <CHW-VALVE-TYPEZ> = <CHW-VALVE-TYPE>                              READPL1181
          IF (<CHW-COIL-HEADZ>  .EQ. 0.)                                        READPL1182
     &        <CHW-COIL-HEADZ> = <CHW-COIL-HEAD>                                READPL1183
          IF (<CHW-COIL-DTZ> .EQ. 0.)  THEN                                     READPL1184
            IF (<CHW-COIL-DT> .NE. 0.)  THEN                                    READPL1185
                <CHW-COIL-DTZ> = ABS(<CHW-COIL-DT>)                             READPL1186
            ELSE                                                                READPL1187
              IF (<CHW-LOOPZ> .GT. 0)  THEN                                     READPL1188
                Jlp = <CHW-LOOPZ>                                               READPL1189
                <CHW-COIL-DTZ> = ABS(<lp:DESIGN-DT>)                            READPL1190
              ENDIF                                                             READPL1191
            ENDIF                                                               READPL1192
          ELSE                                                                  READPL1193
              <CHW-COIL-DTZ>    = ABS(<CHW-COIL-DTZ>)                           READPL1194
          ENDIF                                                                 READPL1195
          IF (<CW-VALVEZ_REAL> .EQ. UNFILD)                                     READPL1196
     &        <CW-VALVEZ> = <CW-VALVE>                                          READPL1197
          IF (<CW-COIL-HEADZ>  .EQ. 0.)                                         READPL1198
     &        <CW-COIL-HEADZ>  = <CW-COIL-HEAD>                                 READPL1199
          IF (<CW-COIL-DTZ> .EQ. 0.)  THEN                                      READPL1200
            IF (<CW-COIL-DT> .NE. 0.)  THEN                                     READPL1201
                <CW-COIL-DTZ>    = ABS(<CW-COIL-DT>)                            READPL1202
            ELSE                                                                READPL1203
              IF (<CW-LOOPZ> .GT. 0)  THEN                                      READPL1204
                Jlp = <CW-LOOPZ>                                                READPL1205
                <CW-COIL-DTZ>  = ABS(<lp:DESIGN-DT>)                            READPL1206
              ENDIF                                                             READPL1207
            ENDIF                                                               READPL1208
          ELSE                                                                  READPL1209
              <CW-COIL-DTZ>    = ABS(<CW-COIL-DTZ>)                             READPL1210
          ENDIF                                                                 READPL1211
          IF (<WSE-VALVE-TYPEZ> .EQ. 0)                                         READPL1212
     &        <WSE-VALVE-TYPEZ> = <WSE-VALVE-TYPE>                              READPL1213
          IF (<WSE-COIL-HEADZ>  .EQ. 0.)                                        READPL1214
     &        <WSE-COIL-HEADZ>  = <WSE-COIL-HEAD>                               READPL1215
          IF (<WSE-COIL-DTZ> .EQ. 0.)  THEN                                     READPL1216
            IF (<WSE-COIL-DT> .NE. 0.)  THEN                                    READPL1217
                <WSE-COIL-DTZ>    = ABS(<WSE-COIL-DT>)                          READPL1218
            ELSE                                                                READPL1219
              IF (<WSE-LOOPZ> .GT. 0)  THEN                                     READPL1220
                Jlp = <WSE-LOOPZ>                                               READPL1221
                <WSE-COIL-DTZ>  = ABS(<lp:DESIGN-DT>)                           READPL1222
              ENDIF                                                             READPL1223
            ENDIF                                                               READPL1224
          ELSE                                                                  READPL1225
              <WSE-COIL-DTZ>    = ABS(<WSE-COIL-DTZ>)                           READPL1226
          ENDIF                                                                 READPL1227
c              end of zonal loop                                                READPL1228
  700   CONTINUE                                                                READPL1229
c             make sure system level coil temp change values have the           READPL1230
c             right sign.  if not specified, default to loop level              READPL1231
        IF (<HW-COIL-DT> .EQ. 0.)  THEN                                         READPL1232
          IF (<HW-LOOP> .GT. 0)  THEN                                           READPL1233
            Jlp = <HW-LOOP>                                                     READPL1234
            <HW-COIL-DT> = -ABS(<lp:DESIGN-DT>)                                 READPL1235
          ENDIF                                                                 READPL1236
        ELSE                                                                    READPL1237
          <HW-COIL-DT>   = -ABS(<HW-COIL-DT>)                                   READPL1238
        ENDIF                                                                   READPL1239
        IF (<BBRD-COIL-DT> .EQ. 0.)  THEN                                       READPL1240
          IF (<BBRD-LOOP> .GT. 0)  THEN                                         READPL1241
            Jlp = <BBRD-LOOP>                                                   READPL1242
            <BBRD-COIL-DT> = -ABS(<lp:DESIGN-DT>)                               READPL1243
          ENDIF                                                                 READPL1244
        ELSE                                                                    READPL1245
          <BBRD-COIL-DT>   = -ABS(<BBRD-COIL-DT>)                               READPL1246
        ENDIF                                                                   READPL1247
        IF (<PHW-COIL-DT> .EQ. 0.)  THEN                                        READPL1248
          IF (<PHW-LOOP> .GT. 0)  THEN                                          READPL1249
            Jlp = <PHW-LOOP>                                                    READPL1250
            <PHW-COIL-DT> = -ABS(<lp:DESIGN-DT>)                                READPL1251
          ENDIF                                                                 READPL1252
        ELSE                                                                    READPL1253
          <PHW-COIL-DT>   = -ABS(<PHW-COIL-DT>)                                 READPL1254
        ENDIF                                                                   READPL1255
        IF (<PHW-VALVE-TYPE> .EQ. 0)                                            READPL1256
     &    <PHW-VALVE-TYPE> = <HW-VALVE-TYPE>                                    READPL1257
        IF (<PHW-COIL-HEAD> .EQ. 0)                                             READPL1258
     &    <PHW-COIL-HEAD>  = <HW-COIL-HEAD>                                     READPL1259
        IF (<DESC-COIL-DT> .EQ. 0.)  THEN                                       READPL1260
          IF (<DESC-LOOP> .GT. 0)  THEN                                         READPL1261
            Jlp = <DESC-LOOP>                                                   READPL1262
            <DESC-COIL-DT> = -ABS(<lp:DESIGN-DT>)                               READPL1263
          ENDIF                                                                 READPL1264
        ELSE                                                                    READPL1265
          <DESC-COIL-DT>   = -ABS(<DESC-COIL-DT>)                               READPL1266
        ENDIF                                                                   READPL1267
        IF (<DESC-VALVE-TYPE> .EQ. 0)                                           READPL1268
     &    <DESC-VALVE-TYPE> = <HW-VALVE-TYPE>                                   READPL1269
        IF (<DESC-COIL-HEAD> .EQ. 0)                                            READPL1270
     &    <DESC-COIL-HEAD>  = <HW-COIL-HEAD>                                    READPL1271
        IF (<CHW-COIL-DT> .EQ. 0.)  THEN                                        READPL1272
          IF (<CHW-LOOP> .GT. 0)  THEN                                          READPL1273
            Jlp = <CHW-LOOP>                                                    READPL1274
            <CHW-COIL-DT> = ABS(<lp:DESIGN-DT>)                                 READPL1275
          ENDIF                                                                 READPL1276
        ELSE                                                                    READPL1277
          <CHW-COIL-DT>   = ABS(<CHW-COIL-DT>)                                  READPL1278
        ENDIF                                                                   READPL1279
        IF (<CW-COIL-DT> .EQ. 0.)  THEN                                         READPL1280
          IF (<CW-LOOP> .GT. 0)  THEN                                           READPL1281
            Jlp = <CW-LOOP>                                                     READPL1282
            <CW-COIL-DT> = ABS(<lp:DESIGN-DT>)                                  READPL1283
          ENDIF                                                                 READPL1284
        ELSE                                                                    READPL1285
          <CW-COIL-DT>   = ABS(<CW-COIL-DT>)                                    READPL1286
        ENDIF                                                                   READPL1287
        IF (<WSE-COIL-DT> .EQ. 0.)  THEN                                        READPL1288
          IF (<WSE-LOOP> .GT. 0)  THEN                                          READPL1289
            Jlp = <WSE-LOOP>                                                    READPL1290
            <WSE-COIL-DT> = ABS(<lp:DESIGN-DT>)                                 READPL1291
          ENDIF                                                                 READPL1292
        ELSE                                                                    READPL1293
          <WSE-COIL-DT>   = ABS(<WSE-COIL-DT>)                                  READPL1294
        ENDIF                                                                   READPL1295
c              end of systems loop                                              READPL1296
      ENDDO                                                                     READPL1297
c                                                                               READPL1298
c              POINTERS IN PRIMARY EQUIPMENT                                    READPL1299
c              BOILERS                                                          READPL1300
      DO  Neq=1,Nbl                                                             READPL1301
c              pointer to this boiler's data                                    READPL1302
        Jbl = Ibl + (Neq-1)*Lbl                                                 READPL1303
        IF (<bl:ELEC-METER> .GT. 0)  THEN                                       READPL1304
            <bl:ELEC-METER> = Iem + (<bl:ELEC-METER>-1)*Lem                     READPL1305
        ELSE                                                                    READPL1306
            <bl:ELEC-METER> = <HEAT-E-MP>                                       READPL1307
        ENDIF                                                                   READPL1308
        IF (<bl:AUX-METER> .GT. 0)  THEN                                        READPL1309
            <bl:AUX-METER> = Iem + (<bl:AUX-METER>-1)*Lem                       READPL1310
        ELSE                                                                    READPL1311
            <bl:AUX-METER> = <bl:ELEC-METER>                                    READPL1312
        ENDIF                                                                   READPL1313
        IF (<bl:FUEL-METER> .GT. 0)  THEN                                       READPL1314
            <bl:FUEL-METER> = Ifm + (<bl:FUEL-METER>-1)*Lfm                     READPL1315
        ELSE                                                                    READPL1316
            <bl:FUEL-METER> = <HEAT-F-MP>                                       READPL1317
        ENDIF                                                                   READPL1318
        IF (<bl:HW-LOOP> .GT. 0)                                                READPL1319
     &      <bl:HW-LOOP> = Ilp + (<bl:HW-LOOP>-1)*Llp                           READPL1320
        IF (<bl:HW-PUMP> .GT. 0)  THEN                                          READPL1321
          Jpm = Ipm + (<bl:HW-PUMP>-1)*Lpm                                      READPL1322
          <bl:HW-PUMP>     = Jpm                                                READPL1323
          <pm;ATTACH>      = Jbl                                                READPL1324
          <pm;ATTACH_TYPE> = IFIVE                                              READPL1325
          Jlp = <bl:HW-LOOP>                                                    READPL1326
          IF (<lp:PUMP> .GT. 0)  THEN                                           READPL1327
            <pm;TYPE> = EquipmentPump                                           READPL1328
          ELSE                                                                  READPL1329
c              HW loop does not have its own pump - boiler pump also            READPL1330
c              powers the loop.  Note that a boiler is on the supply            READPL1331
c              side of the loop                                                 READPL1332
            <pm;TYPE> = <lp:SUBTYPE>                                            READPL1333
            IQ = <lp;NUM_SUP_PUMPS> + 1                                         READPL1334
            <lp;SUP_SIDE_PMPS> = Jpm                                            READPL1335
            <lp;NUM_SUP_PUMPS> = IQ                                             READPL1336
          ENDIF                                                                 READPL1337
        ENDIF                                                                   READPL1338
c              keep list of meters for end-use accounting                       READPL1339
        Jlp   = <bl:HW-LOOP>                                                    READPL1340
        Nprim = <lp;NUM_EQUIP>                                                  READPL1341
        DO IQ=1,Nprim                                                           READPL1342
          IF (<lp;Jpe> .EQ. <bl;Jpe>)  THEN                                     READPL1343
            <lp;PRIM_ELEC_MTR> = <bl:ELEC-METER>                                READPL1344
            <lp;PRIM_FUEL_MTR> = <bl:FUEL-METER>                                READPL1345
            EXIT                                                                READPL1346
          ENDIF                                                                 READPL1347
        ENDDO                                                                   READPL1348
        IF (<bl:COST-DATA> .GT. 0)                                              READPL1349
     &      <bl:COST-DATA> = Imc + (<bl:COST-DATA>-1)*Lmc                       READPL1350
        <bl:CAP-FT>   = Jcurve(<bl:CAP-FT>)                                     -045b  149
        <bl:EIR-FPLR> = Jcurve(<bl:EIR-FPLR>)                                   -045b  150
        <bl:HIR-FT>   = Jcurve(<bl:HIR-FT>)                                     -045b  151
        <bl:HIR-FPLR> = Jcurve(<bl:HIR-FPLR>)                                   -045b  152
        <bl:AUX-SCH>  = JSCHED(<bl:AUX-SCH>)                                    Time    77
        IF (<bl:LOCN> .NE. ZONE)  <bl:ZONE> = 0                                 READPL1356
        IF (<bl:ZONE> .GT. 0)  THEN                                             READPL1357
          ZP2eq = IZ + (<bl:ZONE>-1)*NCZD                                       READPL1358
          DO  NS=1,NSYS                                                         READPL1359
            NSP = IS + (NS-1)*NSS                                               READPL1360
            ISZ = <ISZONES>                                                     READPL1361
            NSZ = <NZONES>                                                      READPL1362
            DO  NZ=1,NSZ                                                        READPL1363
              ZP1 = ISZ + (NZ-1)*NZD                                            READPL1364
              ZP2 = <ZP2>                                                       READPL1365
              IF (ZP2 .EQ. ZP2eq)  THEN                                         READPL1366
                <bl:ZONE> = ZP1                                                 READPL1367
                GOTO 603                                                        READPL1368
              ENDIF                                                             READPL1369
            ENDDO                                                               READPL1370
          ENDDO                                                                 READPL1371
        ENDIF                                                                   READPL1372
  603   CONTINUE                                                                READPL1373
      ENDDO                                                                     READPL1374
c                                                                               READPL1375
c              DHW HEATERS                                                      READPL1376
      DO  Neq=1,Ndw                                                             READPL1377
c              pointer to this heater's data                                    READPL1378
        Jdw = Idw + (Neq-1)*Ldw                                                 READPL1379
        Jpe = <dw;Jpe>                                                          READPL1380
        IF (<dw:ELEC-METER> .GT. 0)  THEN                                       READPL1381
            <dw:ELEC-METER> = Iem + (<dw:ELEC-METER>-1)*Lem                     READPL1382
        ELSE                                                                    READPL1383
            <dw:ELEC-METER> = <DHW-E-MP>                                        READPL1384
        ENDIF                                                                   READPL1385
        IF (<dw:AUX-METER> .GT. 0)  THEN                                        READPL1386
            <dw:AUX-METER> = Iem + (<dw:AUX-METER>-1)*Lem                       READPL1387
        ELSE                                                                    READPL1388
            <dw:AUX-METER> = <dw:ELEC-METER>                                    READPL1389
        ENDIF                                                                   READPL1390
        IF (<dw:FUEL-METER> .GT. 0)  THEN                                       READPL1391
            <dw:FUEL-METER> = Ifm + (<dw:FUEL-METER>-1)*Lfm                     READPL1392
        ELSE                                                                    READPL1393
            <dw:FUEL-METER> = <DHW-F-MP>                                        READPL1394
        ENDIF                                                                   READPL1395
        IF (<dw:DHW-LOOP> .GT. 0)                                               READPL1396
     &                   <dw:DHW-LOOP> = Ilp + (<dw:DHW-LOOP>-1)*Llp            READPL1397
        IF (<dw:PUMP> .GT. 0)  THEN                                             READPL1398
          Jpm = Ipm + (<dw:PUMP>-1)*Lpm                                         READPL1399
          <dw:PUMP>        = Jpm                                                READPL1400
          <pm;ATTACH>      = Jdw                                                READPL1401
          <pm;ATTACH_TYPE> = IFIVE                                              READPL1402
          Jlp = <dw:DHW-LOOP>                                                   READPL1403
          IF (<lp:PUMP> .GT. 0)  THEN                                           READPL1404
            <pm;TYPE> = EquipmentPump                                           READPL1405
          ELSE                                                                  READPL1406
c              DHW loop does not have its own pump - DW pump also               READPL1407
c              powers the loop.  Note that a DW heater is on the supply         READPL1408
c              side of the loop                                                 READPL1409
            <pm;TYPE> = <lp:SUBTYPE>                                            READPL1410
            IQ = <lp;NUM_SUP_PUMPS> + 1                                         READPL1411
            <lp;SUP_SIDE_PMPS> = Jpm                                            READPL1412
            <lp;NUM_SUP_PUMPS> = IQ                                             READPL1413
          ENDIF                                                                 READPL1414
        ENDIF                                                                   READPL1415
c              keep list of meters for end-use accounting                       READPL1416
        Jlp   = <dw:DHW-LOOP>                                                   READPL1417
        Nprim = <lp;NUM_EQUIP>                                                  READPL1418
        DO IQ=1,Nprim                                                           READPL1419
          IF (<lp;Jpe> .EQ. <dw;Jpe>)  THEN                                     READPL1420
            <lp;PRIM_ELEC_MTR> = <dw:ELEC-METER>                                READPL1421
            <lp;PRIM_FUEL_MTR> = <dw:FUEL-METER>                                READPL1422
            EXIT                                                                READPL1423
          ENDIF                                                                 READPL1424
        ENDDO                                                                   READPL1425
        IF (<dw:COST-DATA> .GT. 0)                                              READPL1426
     &      <dw:COST-DATA> = Imc + (<dw:COST-DATA>-1)*Lmc                       READPL1427
        <dw:CAP-FT>   = Jcurve(<dw:CAP-FT>)                                     -045b  153
        <dw:EIR-FT>   = Jcurve(<dw:EIR-FT>)                                     -045b  154
        <dw:EIR-FPLR> = Jcurve(<dw:EIR-FPLR>)                                   -045b  155
        <dw:HIR-FT>   = Jcurve(<dw:HIR-FT>)                                     -045b  156
        <dw:HIR-FPLR> = Jcurve(<dw:HIR-FPLR>)                                   -045b  157
        <dw:AUX-SCH>  = JSCHED(<dw:AUX-SCH>)                                    Time    78
        IF (<dw:LOCN> .NE. ZONE)  <dw:ZONE> = 0                                 READPL1434
        IF (<dw:ZONE> .GT. 0)  THEN                                             READPL1435
          ZP2eq = IZ + (<dw:ZONE>-1)*NCZD                                       READPL1436
          DO  NS=1,NSYS                                                         READPL1437
            NSP = IS + (NS-1)*NSS                                               READPL1438
            ISZ = <ISZONES>                                                     READPL1439
            NSZ = <NZONES>                                                      READPL1440
            DO  NZ=1,NSZ                                                        READPL1441
              ZP1 = ISZ + (NZ-1)*NZD                                            READPL1442
              ZP2 = <ZP2>                                                       READPL1443
              IF (ZP2 .EQ. ZP2eq)  THEN                                         READPL1444
                <dw:ZONE> = ZP1                                                 READPL1445
                GOTO 604                                                        READPL1446
              ENDIF                                                             READPL1447
            ENDDO                                                               READPL1448
          ENDDO                                                                 READPL1449
        ENDIF                                                                   READPL1450
  604   CONTINUE                                                                READPL1451
      ENDDO                                                                     READPL1452
c                                                                               READPL1453
c              CHILLERS                                                         READPL1454
      DO  Neq=1,Nch                                                             READPL1455
c              pointer to this chiller's data                                   READPL1456
        Jch = Ich + (Neq-1)*Lch                                                 READPL1457
        Jpe = <ch;Jpe>                                                          READPL1458
c              default meters to master meters                                  READPL1459
        IF (<ch:ELEC-METER> .GT. 0)  THEN                                       READPL1460
            <ch:ELEC-METER> = Iem + (<ch:ELEC-METER>-1)*Lem                     READPL1461
        ELSE                                                                    READPL1462
            <ch:ELEC-METER> = <COOL-E-MP>                                       READPL1463
        ENDIF                                                                   READPL1464
                                                                                READPL1465
        IF (<ch:AUX-METER> .GT. 0)  THEN                                        READPL1466
            <ch:AUX-METER> = Iem + (<ch:AUX-METER>-1)*Lem                       READPL1467
        ELSE                                                                    READPL1468
            <ch:AUX-METER> = <ch:ELEC-METER>                                    READPL1469
        ENDIF                                                                   READPL1470
        IF (<ch:FUEL-METER> .GT. 0)  THEN                                       READPL1471
            <ch:FUEL-METER> = Ifm + (<ch:FUEL-METER>-1)*Lfm                     READPL1472
        ELSE                                                                    READPL1473
            <ch:FUEL-METER> = <COOL-F-MP>                                       READPL1474
        ENDIF                                                                   READPL1475
c              fuel meter only used for gas chillers                            READPL1476
        IF (<ch:ALGORITHM> .NE. Chiller_Gas1                                    READPL1477
     &                     .AND.  <ch:ALGORITHM> .NE. Chiller_Engine1)          READPL1478
     &    <ch:FUEL-METER> = 0                                                   READPL1479
c              loop connections                                                 READPL1480
        IF (<ch:CHW-LOOP> .GT. 0)                                               READPL1481
     &      <ch:CHW-LOOP> = Ilp + (<ch:CHW-LOOP>-1)*Llp                         READPL1482
        IF (<ch:HW-LOOP> .GT. 0)                                                READPL1483
     &      <ch:HW-LOOP> = Ilp + (<ch:HW-LOOP>-1)*Llp                           READPL1484
        IF (<ch:CW-LOOP> .GT. 0)                                                READPL1485
     &      <ch:CW-LOOP> = Ilp + (<ch:CW-LOOP>-1)*Llp                           READPL1486
        IF (<ch:HTREC-LOOP> .GT. 0)                                             READPL1487
     &      <ch:HTREC-LOOP> = Ilp + (<ch:HTREC-LOOP>-1)*Llp                     READPL1488
        IF (<ch:CHW-PUMP> .GT. 0)  THEN                                         READPL1489
          Jpm = Ipm + (<ch:CHW-PUMP>-1)*Lpm                                     READPL1490
          <ch:CHW-PUMP> = Jpm                                                   READPL1491
          <pm;ATTACH>   = Jch                                                   READPL1492
          <pm;ATTACH_TYPE> = ITHREE                                             READPL1493
          Jlp = <ch:CHW-LOOP>                                                   READPL1494
          IF (<lp:PUMP> .GT. 0)  THEN                                           READPL1495
            <pm;TYPE> = EquipmentPump                                           READPL1496
          ELSE                                                                  READPL1497
c              CHW loop does not have its own pump - chw pump also powers       READPL1498
c              the loop.  Note that an evaporator is on the supply              READPL1499
c              side of a loop                                                   READPL1500
            <pm;TYPE> = <lp:SUBTYPE>                                            READPL1501
            IQ = <lp;NUM_SUP_PUMPS> + 1                                         READPL1502
            <lp;SUP_SIDE_PMPS> = Jpm                                            READPL1503
            <lp;NUM_SUP_PUMPS> = IQ                                             READPL1504
          ENDIF                                                                 READPL1505
        ENDIF                                                                   READPL1506
        IF (<ch:HW-PUMP> .GT. 0)  THEN                                          READPL1507
          Jpm              = Ipm + (<ch:HW-PUMP>-1)*Lpm                         READPL1508
          Jlp              = <ch:HW-LOOP>                                       READPL1509
          <ch:HW-PUMP>     = Jpm                                                READPL1510
          <pm;ATTACH>      = Jch                                                READPL1511
          <pm;ATTACH_TYPE> = IFIVE                                              READPL1512
          IF (<ch:ALGORITHM> .EQ. Chiller_Absor1)  THEN                         READPL1513
            IF (<lp:PUMP> .GT. 0)  THEN                                         READPL1514
              <pm;TYPE> = EquipmentPump                                         READPL1515
            ELSE                                                                READPL1516
              CALL MSGSIM(-1,II,II,II,II)                                       READPL1517
              WRITE (IOUTPT,9103) (<ch:NAME>,II=1,8),                           READPL1518
     &                            (<pm:NAME>,II=1,8),                           READPL1519
     &                            (<lp:NAME>,II=1,8)                            READPL1520
              IFLAG = 1                                                         READPL1521
            ENDIF                                                               READPL1522
          ELSEIF (<ch:ALGORITHM> .EQ. Chiller_Gas1  .OR.                        ChlrHP1072
     &            <ch:ALGORITHM> .EQ. Chiller_LoopHP1)  THEN                    ChlrHP1073
            IF (<lp:PUMP> .GT. 0)  THEN                                         READPL1524
              <pm;TYPE> = EquipmentPump                                         READPL1525
            ELSE                                                                READPL1526
c              HW loop does not have its own pump - hw pump also powers         READPL1527
c              the loop.  Note that a heater in a chiller/heater                READPL1528
c              is on the supply side of a loop                                  READPL1529
              <pm;TYPE> = <lp:SUBTYPE>                                          READPL1530
              IQ = <lp;NUM_SUP_PUMPS> + 1                                       READPL1531
              <lp;SUP_SIDE_PMPS> = Jpm                                          READPL1532
              <lp;NUM_SUP_PUMPS> = IQ                                           READPL1533
            ENDIF                                                               READPL1534
          ENDIF                                                                 READPL1535
        ENDIF                                                                   READPL1536
        IF (<ch:CW-PUMP> .GT. 0)  THEN                                          READPL1537
          Jpm = Ipm + (<ch:CW-PUMP>-1)*Lpm                                      READPL1538
          <ch:CW-PUMP>     = Jpm                                                READPL1539
          <pm;ATTACH>      = Jch                                                READPL1540
          <pm;ATTACH_TYPE> = IFOUR                                              READPL1541
          Jlp = <ch:CW-LOOP>                                                    READPL1542
          IF (<lp:PUMP> .GT. 0)  THEN                                           READPL1543
            <pm;TYPE> = EquipmentPump                                           READPL1544
          ELSE                                                                  READPL1545
c              CW loop does not have its own pump - cw pump also powers         READPL1546
c              the loop.  Note that a condenser is on the demand side           READPL1547
c              of a CW loop                                                     READPL1548
            <pm;TYPE> = <lp:SUBTYPE>                                            READPL1549
            IQ = <lp;NUM_DEM_PUMPS> + 1                                         READPL1550
            <lp;DEM_SIDE_PMPS> = Jpm                                            READPL1551
            <lp;NUM_DEM_PUMPS> = IQ                                             READPL1552
          ENDIF                                                                 READPL1553
        ENDIF                                                                   READPL1554
        IF (<ch:HTREC-PUMP> .GT. 0)  THEN                                       READPL1555
          Jpm = Ipm + (<ch:HTREC-PUMP>-1) * Lpm                                 READPL1556
          <ch:HTREC-PUMP>  = Jpm                                                READPL1557
          <pm;ATTACH>      = Jch                                                READPL1558
          <pm;ATTACH_TYPE> = ISIX                                               READPL1559
          Jlp = <ch:HTREC-LOOP>                                                 READPL1560
          IF (<lp:PUMP> .GT. 0)  THEN                                           READPL1561
            <pm;TYPE> = EquipmentPump                                           READPL1562
          ELSE                                                                  READPL1563
            <pm;TYPE> = <lp:SUBTYPE>                                            READPL1564
          ENDIF                                                                 READPL1565
        ENDIF                                                                   READPL1566
c              keep list of meters for end-use accounting                       READPL1567
c              chilled water side                                               READPL1568
        Jlp   = <ch:CHW-LOOP>                                                   READPL1569
        Nprim = <lp;NUM_EQUIP>                                                  READPL1570
        DO IQ=1,Nprim                                                           READPL1571
          IF (<lp;Jpe> .EQ. <ch;Jpe>)  THEN                                     READPL1572
            <lp;PRIM_ELEC_MTR> = <ch:ELEC-METER>                                READPL1573
            <lp;PRIM_FUEL_MTR> = <ch:FUEL-METER>                                READPL1574
            EXIT                                                                READPL1575
          ENDIF                                                                 READPL1576
        ENDDO                                                                   READPL1577
c              hot water side                                                   READPL1578
        IF (<ch:ALGORITHM> .EQ. Chiller_Gas1  .OR.                              ChlrHP1074
     &      <ch:ALGORITHM> .EQ. Chiller_LoopHP1)  THEN                          ChlrHP1075
          Jlp   = <ch:HW-LOOP>                                                  READPL1580
          Nprim = <lp;NUM_EQUIP>                                                READPL1581
          DO IQ=1,Nprim                                                         READPL1582
c              pointer to attached equipment                                    READPL1583
            Jprim = <lp;Jpe>                                                    READPL1584
            IF (Jprim .EQ. <ch;Jpe_HEAT>)  THEN                                 READPL1585
              <lp;PRIM_ELEC_MTR> = <ch:ELEC-METER>                              READPL1586
              <lp;PRIM_FUEL_MTR> = <ch:FUEL-METER>                              READPL1587
              EXIT                                                              READPL1588
            ENDIF                                                               READPL1589
          ENDDO                                                                 READPL1590
        ENDIF                                                                   READPL1591
        IF (<ch:COST-DATA> .GT. 0)                                              READPL1592
     &      <ch:COST-DATA> = Imc + (<ch:COST-DATA>-1)*Lmc                       READPL1593
        <ch:CAP-FT>        = Jcurve(<ch:CAP-FT>)                                -045b  158
        <ch:EIR-FT>        = Jcurve(<ch:EIR-FT>)                                -045b  159
        <ch:EIR-FPLR>      = Jcurve(<ch:EIR-FPLR>)                              -045b  160
        <ch:HIR-FT>        = Jcurve(<ch:HIR-FT>)                                -045b  161
        <ch:HIR-FPLR>      = Jcurve(<ch:HIR-FPLR>)                              -045b  162
        <ch:HCAP-FPLRC>    = Jcurve(<ch:HCAP-FPLRC>)                            -045b  163
        <ch:HIR-FDESCT>    = Jcurve(<ch:HIR-FDESCT>)                            -045b  164
        <ch:QREG-FDESCT>   = Jcurve(<ch:QREG-FDESCT>)                           -045b  165
        <ch:HTREJ-FT>      = Jcurve(<ch:HTREJ-FT>)                              -045b  166
        <ch:HTREJ-FPLR>    = Jcurve(<ch:HTREJ-FPLR>)                            -045b  167
        <ch:COND-CAP-FT>   = Jcurve(<ch:COND-CAP-FT>)                           -045b  168
        <ch:AMB-FRAC-FT>   = Jcurve(<ch:AMB-FRAC-FT>)                           -045b  169
        <ch:COND-PWR-FPLR> = Jcurve(<ch:COND-PWR-FPLR>)                         -045b  170
        <ch:HEAT-CAP-FT>   = Jcurve(<ch:HEAT-CAP-FT>)                           -045b  171
        <ch:HEAT-CAP-FRST> = Jcurve(<ch:HEAT-CAP-FRST>)                         -045b  172
        <ch:HEAT-EIR-FT>   = Jcurve(<ch:HEAT-EIR-FT>)                           -045b  173
        <ch:HEAT-EIR-FRST> = Jcurve(<ch:HEAT-EIR-FRST>)                         -045b  174
        <ch:HEAT-EIR-FPLR> = Jcurve(<ch:HEAT-EIR-FPLR>)                         -045b  175
        <ch:AUX-SCH>       = JSCHED(<ch:AUX-SCH>)                               -045b  176
      ENDDO                                                                     READPL1607
c                                                                               READPL1608
c              COOLING TOWERS                                                   READPL1609
      DO  Neq=1,Ntw                                                             READPL1610
c              pointer to this tower's data                                     READPL1611
        Jtw = Itw + (Neq-1)*Ltw                                                 READPL1612
        IF (<tw:ELEC-METER> .GT. 0)  THEN                                       READPL1613
            <tw:ELEC-METER> = Iem + (<tw:ELEC-METER>-1)*Lem                     READPL1614
        ELSE                                                                    READPL1615
            <tw:ELEC-METER> = <HTREJ-E-MP>                                      READPL1616
        ENDIF                                                                   READPL1617
        IF (<tw:AUX-METER> .GT. 0)  THEN                                        READPL1618
            <tw:AUX-METER> = Iem + (<tw:AUX-METER>-1)*Lem                       READPL1619
        ELSE                                                                    READPL1620
            <tw:AUX-METER> = <tw:ELEC-METER>                                    READPL1621
        ENDIF                                                                   READPL1622
        IF (<tw:CW-LOOP> .GT. 0)                                                READPL1623
     &      <tw:CW-LOOP> = Ilp + (<tw:CW-LOOP>-1)*Llp                           READPL1624
        IF (<tw:CW-PUMP> .GT. 0)  THEN                                          READPL1625
          Jpm = Ipm + (<tw:CW-PUMP>-1)*Lpm                                      READPL1626
          <tw:CW-PUMP>     = Jpm                                                READPL1627
          <pm;ATTACH>      = Jtw                                                READPL1628
          <pm;ATTACH_TYPE> = IFOUR                                              READPL1629
          Jlp = <tw:CW-LOOP>                                                    READPL1630
          IF (<lp:PUMP> .GT. 0 .OR. <lp;NUM_DEM_PUMPS> .GT. 0) THEN             READPL1631
            <pm;TYPE> = EquipmentPump                                           READPL1632
          ELSEIF (<tw:TYPE> .NE. OpenHX)  THEN                                  READPL1633
c              CW loop does not have its own pump, nor do the chiller           READPL1634
c              condensers - tower pump also powers the loop.  Note              READPL1635
c              that a tower is on the supply side of the loop                   READPL1636
            <pm;TYPE> = <lp:SUBTYPE>                                            READPL1637
            IQ = <lp;NUM_SUP_PUMPS> + 1                                         READPL1638
            <lp;SUP_SIDE_PMPS> = Jpm                                            READPL1639
            <lp;NUM_SUP_PUMPS> = IQ                                             READPL1640
          ELSE                                                                  READPL1641
c              pump on open-twr&hx cannot power the loop                        READPL1642
            CALL MSGSIM(-1,II,II,II,II)                                         READPL1643
            WRITE (IOUTPT,9108)  (<pm:NAME>,II=1,8),                            READPL1644
     &                           (<lp:NAME>,II=1,8)                             READPL1645
          ENDIF                                                                 READPL1646
        ENDIF                                                                   READPL1647
c              pan heater loop                                                  READPL1648
        IF (<tw:PAN-HTR-LOOP> .GT. 0)                                           READPL1649
     &      <tw:PAN-HTR-LOOP> = Ilp + (<tw:PAN-HTR-LOOP>-1)*Llp                 READPL1650
        IF (<tw:PAN-HTR-DT> .EQ. 0.                                             READPL1651
     &                          .AND.  <tw:PAN-HTR-LOOP> .GT. 0)  THEN          READPL1652
          Jlp = <tw:PAN-HTR-LOOP>                                               READPL1653
          <tw:PAN-HTR-DT> = -ABS(<lp:DESIGN-DT>)                                READPL1654
        ENDIF                                                                   READPL1655
        IF (<tw:DRY-HX> .GT. 0)                                                 READPL1656
     &      <tw:DRY-HX> = Ihx + (<tw:DRY-HX>-1)*Lhx                             READPL1657
        IF (<tw:CW-HX> .GT. 0)  <tw:CW-HX> = Ihx + (<tw:CW-HX>-1)*Lhx           READPL1658
c              keep list of meters for end-use accounting                       READPL1659
        Jlp   = <tw:CW-LOOP>                                                    READPL1660
        Nprim = <lp;NUM_EQUIP>                                                  READPL1661
        DO IQ=1,Nprim                                                           READPL1662
          IF (<lp;Jpe> .EQ. <tw;Jpe>)  THEN                                     READPL1663
            <lp;PRIM_ELEC_MTR> = <tw:ELEC-METER>                                READPL1664
            EXIT                                                                READPL1665
          ENDIF                                                                 READPL1666
        ENDDO                                                                   READPL1667
        IF (<tw:COST-DATA> .GT. 0)                                              READPL1668
     &      <tw:COST-DATA> = Imc + (<tw:COST-DATA>-1)*Lmc                       READPL1669
        <tw:GPM-fAPP&WB>   = Jcurve(<tw:GPM-fAPP&WB>)                           -045b  177
        <tw:GPM-fRNG&WB>   = Jcurve(<tw:GPM-fRNG&WB>)                           -045b  178
        <tw:GPM-fAIRFLOW>  = Jcurve(<tw:GPM-fAIRFLOW>)                          -045b  179
        <tw:KW-fSPEED>     = Jcurve(<tw:KW-fSPEED>)                             -045b  180
        <tw:KW-fDAMPER>    = Jcurve(<tw:KW-fDAMPER>)                            -045b  181
        <tw:WET-COIL-SCH>  = JSCHED(<tw:WET-COIL-SCH>)                          Time    80
      ENDDO                                                                     READPL1676
c                                                                               READPL1677
c              GROUND-LOOP HEAT-EXCHANGERS                                      READPL1678
      DO  Neq=1,Ngl                                                             READPL1679
c              pointer to this component's data                                 READPL1680
        Jgl = Igl + (Neq-1)*Lgl                                                 READPL1681
        IF (<gl:LOOP> .GT. 0)                                                   READPL1682
     &      <gl:LOOP> = Ilp + (<gl:LOOP>-1)*Llp                                 READPL1683
        IF (<gl:HX-PUMP> .GT. 0)  THEN                                          READPL1684
          Jpm = Ipm + (<gl:HX-PUMP>-1)*Lpm                                      READPL1685
          <gl:HX-PUMP>     = Jpm                                                READPL1686
          <pm;ATTACH>      = Jgl                                                READPL1687
          <pm;ATTACH_TYPE> = IFIVE                                              READPL1688
          Jlp = <gl:LOOP>                                                       READPL1689
          IF (<lp:PUMP> .GT. 0)  THEN                                           READPL1690
            <pm;TYPE> = EquipmentPump                                           READPL1691
          ELSE                                                                  READPL1692
c              Circulation loop does not have its own pump - HX pump also       READPL1693
c              powers the loop.  Note that a HX is on the supply                READPL1694
c              side of the loop                                                 READPL1695
            <pm;TYPE> = <lp:SUBTYPE>                                            READPL1696
            IQ = <lp;NUM_SUP_PUMPS> + 1                                         READPL1697
            <lp;SUP_SIDE_PMPS> = Jpm                                            READPL1698
            <lp;NUM_SUP_PUMPS> = IQ                                             READPL1699
          ENDIF                                                                 READPL1700
        ENDIF                                                                   READPL1701
c              keep list of meters for end-use accounting                       READPL1702
        Jlp   = <gl:LOOP>                                                       READPL1703
        Nprim = <lp;NUM_EQUIP>                                                  READPL1704
        DO IQ=1,Nprim                                                           READPL1705
          IF (<lp;Jpe> .EQ. <gl;Jpe>)  THEN                                     READPL1706
            <lp;PRIM_ELEC_MTR> = 0                                              READPL1707
            <lp;PRIM_FUEL_MTR> = 0                                              READPL1708
            EXIT                                                                READPL1709
          ENDIF                                                                 READPL1710
        ENDDO                                                                   READPL1711
        IF (<gl:COST-DATA> .GT. 0)                                              READPL1712
     &      <gl:COST-DATA> = Imc + (<gl:COST-DATA>-1)*Lmc                       READPL1713
        IF (<gl:TYPE> .EQ. ScheduleOrWthFile)                                   READPL1714
     &    <gl:LOOP-TEMP-SCH>  = JSCHED(<gl:LOOP-TEMP-SCH>)                      Time    81
      ENDDO                                                                     READPL1716
c                                                                               READPL1717
c              THERMAL STORAGE                                                  READPL1718
      DO  Neq=1,Ntk                                                             READPL1719
c              pointer to this TES device's data                                READPL1720
        Jtk = Itk + (Neq-1)*Ltk                                                 READPL1721
        IF (<tk:AUX-METER> .GT. 0)  THEN                                        READPL1722
            <tk:AUX-METER> = Iem + (<tk:AUX-METER>-1)*Lem                       READPL1723
        ELSE                                                                    READPL1724
            <tk:AUX-METER> = <AUX-E-MP>                                         READPL1725
        ENDIF                                                                   READPL1726
        <tk:CHRG-LOOP>  = Ilp + (<tk:CHRG-LOOP>-1)*Llp                          READPL1727
        <tk:DCHRG-LOOP> = Ilp + (<tk:DCHRG-LOOP>-1)*Llp                         READPL1728
        IF (<tk:FREEZE-LOOP> .GT. 0)                                            READPL1729
     &      <tk:FREEZE-LOOP> = Ilp + (<tk:FREEZE-LOOP>-1)*Llp                   READPL1730
        IF (<tk:ZONE> .GT. 0)  THEN                                             Ver42L1 96
          ZP2loss = IZ + (<tk:ZONE>-1)*NCZD                                     Ver42L1 97
          DO  NS=1,NSYS                                                         Ver42L1 98
            NSP = IS + (NS-1)*NSS                                               Ver42L1 99
            ISZ = <ISZONES>                                                     Ver42L1100
            NSZ = <NZONES>                                                      Ver42L1101
            DO  NZ=1,NSZ                                                        Ver42L1102
              ZP1 = ISZ + (NZ-1)*NZD                                            Ver42L1103
              ZP2 = <ZP2>                                                       Ver42L1104
              IF (ZP2 .EQ. ZP2loss)  THEN                                       Ver42L1105
                <tk:ZONE> = ZP1                                                 Ver42L1106
                GoTo 702                                                        Ver42L1107
              ENDIF                                                             Ver42L1108
            ENDDO                                                               Ver42L1109
          ENDDO                                                                 Ver42L1110
  702     Continue                                                              Ver42L1111
        ENDIF                                                                   Ver42L1112
c              charging loop                                                    READPL1731
        Jlp = <tk:CHRG-LOOP>                                                    READPL1732
        IT = <lp;NUM_CHRG_TES> + 1                                              READPL1733
        <lp;NUM_CHRG_TES> = IT                                                  READPL1734
        <lp;CHRG_TES> = Jtk                                                     READPL1735
c              transfer charging equipment meter pointers                       READPL1736
c              to tank for end-use accounting                                   READPL1737
        Nprim = <lp;NUM_EQUIP>                                                  READPL1738
        <tk;NUM_PRIM_EQ> = Nprim                                                READPL1739
        DO  IQ=1,Nprim                                                          READPL1740
          ME = IQ                                                               READPL1741
          <tk;PRIM_ELEC_MTR> = <lp;PRIM_ELEC_MTR>                               READPL1742
          <tk;PRIM_FUEL_MTR> = <lp;PRIM_FUEL_MTR>                               READPL1743
        ENDDO                                                                   READPL1744
c              transfer chilled water meter pointer                             READPL1745
        <tk;CHW_METER> = <lp;CHW_METER>                                         READPL1746
c              same with steam                                                  READPL1747
        <tk;STEAM_METER> = <lp;STEAM_METER>                                     READPL1748
c              discharge loop                                                   READPL1749
        Jlp = <tk:DCHRG-LOOP>                                                   READPL1750
        IF (<tk:COST-DATA> .GT. 0)                                              READPL1751
     &      <tk:COST-DATA> = Imc + (<tk:COST-DATA>-1)*Lmc                       READPL1752
        <tk:CHRG-T-FHR>    = Jcurve(<tk:CHRG-T-FHR>)                            -045b  182
        <tk:CHRG-RATE-FHR> = Jcurve(<tk:CHRG-RATE-FHR>)                         -045b  183
        <tk:DCHRG-RAT-FHR> = Jcurve(<tk:DCHRG-RAT-FHR>)                         -045b  184
        <tk:CHRG-SCH>      = JSCHED(<tk:CHRG-SCH>)                              Time    82
        <tk:AUX-SCH>       = JSCHED(<tk:AUX-SCH>)                               Time    83
      ENDDO                                                                     READPL1758
c                                                                               READPL1759
c              set up the EQUIP-CTRL sequences                                  READPL1760
      IF (Nec .GT. 0)  CALL EquipCtrlSetup                                      READPL1761
c              set up the LOAD-MANAGEMENT sequences                             READPL1762
      IF (Nlm .GT. 0)  CALL LoadManagementSetup                                 READPL1763
c              Write header records for central plant reports                   READPL1764
      CALL PlantReports                                                         READPL1765
c                                                                               READPL1766
c                                                                               READPL1767
      IF (IREPRT(3,32) .NE. 0)  THEN                                            READPL1768
        CALL DUMPIT(20HPlant w/ Attachments ,IA(1),IAX)                         READPL1769
        WRITE(IOUTPT,9000) NZONE, NSYS,                                         -047k   89
     1                 NCZD, NZD, NSS,                                          -047k   90
     2                 IZ, IS, IATT,                                            -047k   91
     3                 NRB, NHRP, IRB, IHRP, nattch,                            -047k   92
     4                 Icv, Ncv,                                                -047k   93
     &                 Nlp, Ilp, Llp, Jlp,     Npm, Ipm, Lpm, Jpm               -047k   94
        WRITE(IOUTPT,9001)                                                      -047k   95
     &                 Nch, Ich, Lch, Jch,     Nbl, Ibl, Lbl, Jbl,              -047k   96
     &                 Ndw, Idw, Ldw, Jdw,     Ntw, Itw, Ltw, Jtw,              -047k   97
     &                 Npv, Ipv, Lpv, Jpv,     Ngn, Ign, Lgn, Jgn,              -047k   98
     &                 Ntk, Itk, Ltk, Jtk,     Nhx, Ihx, Lhx, Jhx               -047k   99
        WRITE(IOUTPT,9002)                                                      -047k  100
     &                 Nec, Iec, Lec, Jec,     Nlm, Ilm, Llm, Jlm,              -047k  101
     &                 Nem, Iem, Lem, Jem,     Nfm, Ifm, Lfm, Jfm,              -047k  102
     &                 Nsm, Ism, Lsm, Jsm,     Ncm, Icm, Lcm, Jcm,              -047k  103
     &                 Nmc, Imc, Lmc, Jmc,     imm, kpr                         -047k  104
      ENDIF                                                                     READPL1784
c                                                                               READPL1785
c              for loops that do not have their own pumps, check                READPL1786
c              to make sure that not more than 10 supply-side or                READPL1787
c              demand-side pumps are attached                                   READPL1788
      DO  NL=1,Nlp                                                              READPL1789
        Jlp = Ilp + (NL-1)*Llp                                                  READPL1790
        IF (<lp;NUM_SUP_PUMPS> .GT. 10)  THEN                                   READPL1791
          CALL MSGSIM(-1,II,II,II,II)                                           READPL1792
          WRITE (IOUTPT,9105)  (<lp:NAME>,II=1,8)                               READPL1793
          call MessageBox( NULL, 'Missing PRIMARY LOOP pumps -'                 READPL1794
     &      //' ABORTING'//char(0),'READSP Errors'//char(0), MB_OK              READPL1795
     &      + MB_ICONSTOP + MB_TASKMODAL )                                      READPL1796
          RETURN                                                                READPL1798
        ENDIF                                                                   READPL1799
        IF (<lp;NUM_DEM_PUMPS> .GT. 10)  THEN                                   READPL1800
          CALL MSGSIM(-1,II,II,II,II)                                           READPL1801
          WRITE (IOUTPT,9106)  (<lp:NAME>,II=1,8)                               READPL1802
          call MessageBox( NULL, 'Missing PRIMARY LOOP pumps -'                 READPL1803
     &      //' ABORTING'//char(0),'READSP Errors'//char(0), MB_OK              READPL1804
     &      + MB_ICONSTOP + MB_TASKMODAL )                                      READPL1805
          RETURN                                                                READPL1807
        ENDIF                                                                   READPL1808
      ENDDO                                                                     READPL1809
c                                                                               READPL1810
c              Make sure that each pump is attached                             READPL1811
      DO  Neq=1,Npm                                                             READPL1812
        Jpm = Ipm + (Neq-1)*Lpm                                                 READPL1813
        IF (<pm;ATTACH> .EQ. 0)  THEN                                           READPL1814
          CALL MSGSIM(-1,II,II,II,II)                                           READPL1815
          WRITE (IOUTPT,9107)  (<pm:NAME>,II=1,8)                               READPL1816
          call MessageBox( NULL, 'Unattached pump -'                            READPL1817
     &      //' ABORTING'//char(0),'READSP Errors'//char(0), MB_OK              READPL1818
     &      + MB_ICONSTOP + MB_TASKMODAL )                                      READPL1819
          RETURN                                                                READPL1821
        ENDIF                                                                   READPL1822
      ENDDO                                                                     READPL1823
c                                                                               READPL1824
      RETURN                                                                    READPL1825
c                                                                               READPL1826
c              Dump formats                                                     READPL1827
 9000 FORMAT( /                                                                 -047k  105
     1' NZONE  =',I5,4X, 'NSYS   =',I5 /                                        -047k  106
     2' NCZD   =',I5,4X, 'NZD    =',I5,4X, 'NSS     =',I5 /                     -047k  107
     3' IZ     =',I5,4X, 'IS     =',I5,4X, 'IATT    =',I5 /                     -047k  108
     4' NRB    =',I5,4X, 'NHRP   =',I5,4X,                                      -047k  109
     5' IRB    =',I5,4X, 'IHRP   =',I5,4X, 'NATTCH  =',I5 /                     -047k  110
     6' Icv    =',I5,4X, 'Ncv    =',I5 /                                        -047k  111
     7'     nlp,   ilp,   llp,   Jlp,       npm,   ipm,   lpm,   Jpm,'/         -047k  112
     8 1X,4I7, 4X,4I7)                                                          -047k  113
 9001 FORMAT(                                                                   -047k  114
     1'     nch,   ich,   lch,   Jch,       nbl,   ibl,   lbl,   Jbl,'/         -047k  115
     2 1X,4I7, 4X,4I7/                                                          -047k  116
     3'     ndw,   idw,   ldw,   Jdw,       ntw,   itw,   ltw,   Jtw,'/         -047k  117
     4 1X,4I7, 4X,4I7/                                                          -047k  118
     5'     npv,   ipv,   lpv,   jpv,       ngn,   ign,   lgn,   jgn,'/         -047k  119
     6 1X,4I7, 4X,4I7/                                                          -047k  120
     7'     ntk,   itk,   ltk,   jtk,       nhx,   ihx,   lhx,   jhx,'/         -047k  121
     8 1X,4I7, 4X,4I7)                                                          -047k  122
 9002 FORMAT(                                                                   -047k  123
     1'     nec,   iec,   lec,   jec,       nlm,   ilm,   llm,   jlm,'/         -047k  124
     2 1X,4I7, 4X,4I7/                                                          -047k  125
     3'     nem,   iem,   lem,   jem,       nfm,   ifm,   lfm,   jfm,'/         -047k  126
     4 1X,4I7, 4X,4I7/                                                          -047k  127
     5'     nsm,   ism,   lsm,   jsm,       ncm,   icm,   lcm,   jcm,'/         -047k  128
     6 1X,4I7, 4X,4I7/                                                          -047k  129
     7'     nmc,   imc,   lmc,   jmc,       imm,   kpr      '/                  -047k  130
     8 1X,4I7, 4X,2I7)                                                          -047k  131
c                                                                               READPL1858
c              Message formats                                                  READPL1859
 9100 FORMAT(14X,'BDL and ReadPlant do not agree on the length of the' /        READPL1860
     &       14X,'AA array after the PRIMARY read.  Please report'     /        READPL1861
     &       14X,'this message to your program supplier.'              /        READPL1862
     &       14X,'BDL LEN=',I7,' ReadPlant IAX=',I7                    )        READPL1863
 9101 FORMAT(14X,'Secondary Loop: ',8A4                                /        READPL1864
     &       14X,'is not attached to a primary loop.'                  )        READPL1865
 9102 FORMAT(14X,'Loop: ',8a4,' has no attached primary'               /        READPL1866
     &       14X,'equipment.'                                          )        READPL1867
 9103 FORMAT(14X,'Chiller: ',8A4,' hot water pump: '                   /        READPL1868
     &       14X,8A4,' is an equipment pump only, and cannot'          /        READPL1869
     &       14X,'be used to pump loop: ',8A4                          )        READPL1870
 9104 FORMAT(14X,'Chiller: ',8A4,' htrec water pump: '                 /        READPL1871
     &       14X,8A4,' is an equipment pump only, and cannot be used'  /        READPL1872
     &       14X,'to pump loop: ',8A4                                  )        READPL1873
 9105 FORMAT(14X,'Loop: ',8A4,' has more than 10 '                     /        READPL1874
     &       14X,'supply-side pumps.'                                  )        READPL1875
 9106 FORMAT(14X,'Loop: ',8A4,' has more than 10 '                     /        READPL1876
     &       14X,'demand-side pumps.'                                  )        READPL1877
 9107 FORMAT(14X,'Pump: ',8A4,' is not attached to any'                /        READPL1878
     &       14X,'equipment.'                                          )        READPL1879
 9108 FORMAT(14X,'Pump: ',8A4,' is attached to an OPEN-TWR&HX'         /        READPL1880
     &       14X,'and cannot also pump loop: ',8A4                     /        READPL1881
     &       14X,'You must also define a pump for the loop.'           )        READPL1882
 9109 FORMAT(14X,'System: ',8A4,' has a desiccant'                     /        READPL1883
     &       14X,'system with DESC-HEAT-SOURCE=GAS-CHILLER, but no gas'/        READPL1884
     &       14X,'chiller has been defined.'                           )        READPL1885
 9110 FORMAT(14X,'System: ',8A4,' has a desiccant'                     /        READPL1886
     &       14X,'system with DESC-HEAT-SOURCE=GAS-CHILLER, but no'    /        READPL1887
     &       14X,'chiller was specified.  The default chiller will'    /        READPL1888
     &       14X,'be: ',8A4                                            )        READPL1889
 9111 FORMAT(14X,'Loop: ',8a4,' has LOOP-LOCN = ZONE for'              /        READPL1890
     &       14X,'thermal loss calcs, but no LOOP-LOSS-ZONE specified.')        READPL1891
 9112 FORMAT(14X,'Loop: ',8a4,' has more than one'                     /        FreeCl 182
     &       14X,'water-side economizer.'                              )        FreeCl 183
 9113 FORMAT(14X,'Loop: ',8a4,' has a water-side'                      /        FreeCl 184
     &       14X,'economizer, but supplies more than one CHW loop.'    )        FreeCl 185
 9114 FORMAT(14X,'Secondary Loop: ',8a4,' must attach to'              /        Bug40  356
     &14X,'a primary loop.'                                            )        Bug40  357
 9115 FORMAT(14X,'Secondary Loop: ',8a4,' must attach to'              /        Bug40  358
     &14X,'a primary loop of the same type as the secondary.'          )        Bug40  359
 9116 FORMAT(14X,'Primary Loop: ',8a4,' has more than 20'              /        Bug40  360
     &14X,'secondary loops attached.'                                  )        Bug40  361
 9117 FORMAT(14X,'Loop: ',8a4,' cannot have a boiler'                  /        Bug40  362
     &14X,'together with a ground-loop HX.'                            )        Bug40  363
 9118 FORMAT(14X,'Loop: ',8a4,' has more than one'                     /        -041f   62
     &14X,'EQUIP-CTRL, but none is specified as the default via the'   /        -041f   63
     &14X,'HEAT-EQUIP-CTRL keyword. In this case, EQUIP-CTRLs will be' /        -041f   64
     &14X,'ignored unless enabled by LOAD-MANAGEMENT.'                 )        -041f   65
 9119 FORMAT(14X,'Loop: ',8a4,' has more than one'                     /        -041f   66
     &14X,'EQUIP-CTRL, but none is specified as the default via the'   /        -041f   67
     &14X,'COOL-EQUIP-CTRL keyword. In this case, EQUIP-CTRLs will be' /        -041f   68
     &14X,'ignored unless enabled by LOAD-MANAGEMENT.'                 )        -041f   69
 9120 FORMAT(14X,'Meter: ',8a4,' has more than one'                    /        -041f   70
     &14X,'EQUIP-CTRL, but none is specified as the default via the'   /        -041f   71
     &14X,'METER:EQUIP-CTRL keyword. In this case, EQUIP-CTRLs will be'/        -041f   72
     &14X,'ignored unless enabled by LOAD-MANAGEMENT.'                 )        -041f   73
 9121 FORMAT(14X,'FOR CIRCULATION-LOOP ',8a4 / 14X ,                            -042L4  13
     &'Maximum of ten attached primary equipment units was exceeded.')          -042L4  14
c                                                                               READPL1892
      END                                                                       READPL1893
      FUNCTION StartUpLoad(Jpe)                                                 -044c4 399
c                                                                               STARTQ   3
c              Calculates the start-up load as a function of the                STARTQ   4
c              time the component has been shut down                            STARTQ   5
c                                                                               STARTQ   6
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               STARTQ  10
      IF (<pe;HOURS_OFF> .GT. 0)  THEN                                          -044c4 400
        II = MIN(3, <pe;HOURS_OFF>)                                             -044c4 401
        StartUpLoad = <pe;Q_STARTUP>                                            -044c4 402
      ELSE                                                                      -044c4 403
        StartUpLoad = 0.                                                        -044c4 404
      ENDIF                                                                     -044c4 405
c                                                                               STARTQ  36
      RETURN                                                                    STARTQ  37
      END                                                                       STARTQ  38
      SUBROUTINE StartUpLoad_Design(Jpe, Capacity, StartTime)                   STARTd   2
c                                                                               STARTd   3
c              Sets up the data for StartUpLoad                                 STARTd   4
c                                                                               STARTd   5
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               STARTd   8
c              start-up load depends on how many hours the component            STARTd   9
c              has been off                                                     STARTd  10
      II = 1                                                                    STARTd  11
      <pe;Q_STARTUP> = Capacity * StartTime * .50                               STARTd  12
      II = 2                                                                    STARTd  13
      <pe;Q_STARTUP> = Capacity * StartTime * .80                               STARTd  14
      II = 3                                                                    STARTd  15
      <pe;Q_STARTUP> = Capacity * StartTime                                     STARTd  16
c              initialize number of hours component has been off                STARTd  17
      <pe;HOURS_OFF> = 3                                                        STARTd  18
c                                                                               STARTd  19
      RETURN                                                                    STARTd  20
      END                                                                       STARTd  21
      FUNCTION SurfaceFilmAdj(Tsurface, Tenvir, WindSpeed)                      SURFC    2
c                                                                               SURFC    3
c              Adjusts the portion of the surface film coefficient              SURFC    4
c              that varies as a function of temperature and windspeed           SURFC    5
c                                                                               SURFC    6
c              The loss UA based on 1993 ASHRAE Fundamentals p22.17 eqn.4       SURFC    7
c              for a pipe or flat surface.  The radiative term is ignored       SURFC    8
c              as minimual data is normally available from manufacturers.       SURFC    9
c                                                                               SURFC   10
c              Qloss = UA * SurfaceLossAdj * (Tenvir - Tsurface)                SURFC   11
c                 where a negative number means a heating load                  SURFC   12
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
c                                                                               SURFC   14
      Tave = (Tsurface + Tenvir) * 0.5                                          SURFC   15
      dT   =  Tsurface - Tenvir                                                 SURFC   16
      SurfaceFilmAdj = Tave**(-0.181) * dT**0.266                               SURFC   17
     &                                * SQRT(1.0 + 1.277*WindSpeed)             SURFC   18
c                                                                               SURFC   19
      RETURN                                                                    SURFC   20
      END                                                                       SURFC   21
      Function NewTDV(Type, Rank)                                               NewTDV   2
c                                                                               NewTDV   3
c              Creates a time-dependent valuation block, and returns            NewTDV   4
c              the block pointer Ktv                                            NewTDV   5
c                                                                               NewTDV   6
c              Type = 0  Sum of meters                                          NewTDV   7
c                     1  Electric                                               NewTDV   8
c                     2  Fuel                                                   NewTDV   9
c              Rank = 0  Submeter                                               NewTDV  10
c                     1  1st utility-level meter                                NewTDV  11
c                     2  following utility level meter                          NewTDV  12
c                                                                               NewTDV  13
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               NewTDV  16
      Integer Type, Rank                                                        NewTDV  17
                                                                                NewTDV  18
      Ktv = NewBlockPtr(<+tv~Len>)                                              NewTDV  19
                                                                                NewTDV  20
      <tv;Type> = Type                                                          NewTDV  21
      <tv;Rank> = Rank                                                          NewTDV  22
c              Initialize max/min statistics                                    NewTDV  23
      <tv.TDVminMo> = 1.E6                                                      NewTDV  24
      <tv.TDVminYr> = 1.E6                                                      NewTDV  25
                                                                                NewTDV  26
      NewTDV = Ktv                                                              NewTDV  27
      Return                                                                    NewTDV  28
      End                                                                       NewTDV  29
      Subroutine TDV(Mode, Ktv, EndUses, Prorate, TDVsrc)                       TDV      2
c                                                                               TDV      3
c              Processes data for the time-dependent valuation                  TDV      4
c              block, Ktv                                                       TDV      5
c                                                                               TDV      6
c              Mode = 11  Hourly, gross                                         TDV      7
c                     12  Hourly, net after cogen                               TDV      8
c                     13  Hourly, cogen sale                                    TDV      9
c                     14  Transfer gross to net                                 TDV     10
c                     29  Monthly                                               TDV     11
c                                                                               TDV     12
c              EndUses  Array of end use categories                             TDV     13
c              Prorate  Proration adjustment factor                             TDV     14
c              TDVsrc   Multiplier to convert site energy to TDV energy         TDV     15
c                                                                               TDV     16
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
                                                                                TDV     21
      Real EndUses(19), EndUseSum(19)                                           TDV     22
      Save EndUseSum                                                            TDV     23
                                                                                TDV     24
      SELECT CASE (Mode)                                                        TDV     25
c                                                                               TDV     26
c                                                                               TDV     27
c============= HOURLY, GROSS ================================================== TDV     28
      CASE (11)                                                                 TDV     29
                                                                                TDV     30
c              Process the meter by end-use category                            TDV     31
      TDVtot = 0.                                                               TDV     32
      DO  IE=1,19                                                               TDV     33
        SELECT CASE (<tv;Rank>)                                                 TDV     34
        CASE (0)  ! sum of meters (PS-E)                                        TDV     35
          TDVengy = EndUseSum(IE)                                               TDV     36
        CASE (1)  ! first utility meter                                         TDV     37
          TDVengy       = EndUses(IE)*<mm;IncludeTDV>*Prorate * TDVsrc          TDV     38
          EndUseSum(IE) = TDVengy                                               TDV     39
        CASE (2)  ! other utility meter                                         TDV     40
          TDVengy       = EndUses(IE)*<mm;IncludeTDV>*Prorate * TDVsrc          TDV     41
          EndUseSum(IE) = EndUseSum(IE) + TDVengy                               TDV     42
        CASE (3)  ! submeter                                                    TDV     43
          TDVengy       = EndUses(IE)*<mm;IncludeTDV>*Prorate * TDVsrc          TDV     44
        END SELECT                                                              TDV     45
        TDVtot = TDVtot + TDVengy                                               TDV     46
                                                                                TDV     47
        IF (Ktv .gt. 0)  THEN                                                   TDV     48
          <tv.EndUseMo> = <tv.EndUseMo> + TDVengy                               TDV     49
          IF (TDVengy .GT. <tv.EndUseMoM>)  THEN                                TDV     50
            <tv.EndUseMoM>  = TDVengy                                           TDV     51
            <tv.EndUseMoDy> = IDAY                                              TDV     52
            <tv.EndUseMoHr> = ISCHR                                             TDV     53
          ENDIF                                                                 TDV     54
        ENDIF                                                                   TDV     55
      ENDDO                                                                     TDV     56
                                                                                TDV     57
c              Total for all end uses                                           TDV     58
      IF (Ktv .gt. 0)  THEN                                                     TDV     59
        <tv.TotMo> = <tv.TotMo> + TDVtot                                        TDV     60
        IF (TDVtot .GT. <tv.TotMoM>)  THEN                                      TDV     61
          <tv.TotMoM>  = TDVtot                                                 TDV     62
          <tv.TotMoDy> = IDAY                                                   TDV     63
          <tv.TotMoHr> = ISCHR                                                  TDV     64
        ENDIF                                                                   TDV     65
c              transformer loss                                                 TDV     66
        IF (<tv;Type> .eq. 1)                                                   TDV     67
     &    <tv.LossMo> = <tv.LossMo>+<em;TRANSFORMER>*<em.TDVsrc>                TDV     68
c              max/min/avg statistics                                           TDV     69
        <tv.TDVmaxMo> = Max(<tv.TDVmaxMo>, TDVsrc)                              TDV     70
        <tv.TDVminMo> = Min(<tv.TDVminMo>, TDVsrc)                              TDV     71
        <tv.TDVavgMo> = <tv.TDVavgMo> + TDVsrc                                  TDV     72
        <tv.TDVhrsMo> = <tv.TDVhrsMo> + 1.                                      TDV     73
      ENDIF                                                                     TDV     74
c                                                                               TDV     75
c                                                                               TDV     76
c============= HOURLY, AFTER COGENERATION ===================================== TDV     77
      CASE (12)                                                                 TDV     78
                                                                                TDV     79
c **** NOTE: This section not tested, as cogeneration is not recognized         TDV     80
c            in the California ACM.  Included for future testing only           TDV     81
                                                                                TDV     82
c              Net hourly in the case of cogeneration                           TDV     83
      TDVtot = 0.                                                               TDV     84
      DO  IE=1,19                                                               TDV     85
        TDVengy = EndUses(IE) * <mm;IncludeTDV> * Prorate * TDVsrc              TDV     86
        <tv.NetEndUseMo> = <tv.NetEndUseMo> + TDVengy                           TDV     87
        TDVtot           = TDVtot           + TDVengy                           TDV     88
        IF (TDVengy .GT. <tv.NetEndUseMoM>)  THEN                               TDV     89
          <tv.NetEndUseMoM>  = TDVengy                                          TDV     90
          <tv.NetEndUseMoDy> = IDAY                                             TDV     91
          <tv.NetEndUseMoHr> = ISCHR                                            TDV     92
        ENDIF                                                                   TDV     93
      ENDDO                                                                     TDV     94
c              Total for all end uses                                           TDV     95
      <tv.NetTotMo> = <tv.NetTotMo> + TDVtot                                    TDV     96
      IF (TDVtot .GT. <tv.NetTotMoM>)  THEN                                     TDV     97
        <tv.NetTotMoM>  = TDVtot                                                TDV     98
        <tv.NetTotMoDy> = IDAY                                                  TDV     99
        <tv.NetTotMoHr> = ISCHR                                                 TDV    100
      ENDIF                                                                     TDV    101
c                                                                               TDV    102
c                                                                               TDV    103
c============= HOURLY, COGENERATION SALE ====================================== TDV    104
      CASE (13)                                                                 TDV    105
                                                                                TDV    106
c **** NOTE: This section not tested, as cogeneration is not recognized         TDV    107
c            in the California ACM.  Included for future testing only           TDV    108
                                                                                TDV    109
      Total      = EndUses(1) * TDVsrc                                          TDV    110
      <tv.TotMo> = <tv.TotMo> + Total                                           TDV    111
      IF (Total .GT. <tv.TotMoM>)  THEN                                         TDV    112
        <tv.TotMoM>  = Total                                                    TDV    113
        <tv.TotMoDy> = IDAY                                                     TDV    114
        <tv.TotMoHr> = ISCHR                                                    TDV    115
      ENDIF                                                                     TDV    116
c              transformer loss and net kW                                      TDV    117
      <tv.LossMo>   = Transformer_Loss(EndUses(1)) * <em.TDVsrc>                TDV    118
      AdjustedKW    = Total - <tv.LossMo>                                       TDV    119
      <tv.NetTotMo> = <tv.NetTotMo> + AdjustedKW                                TDV    120
      IF (AdjustedKW .GT. <tv.NetTotMoM>)  THEN                                 TDV    121
        <tv.NetTotMoM>  = AdjustedKW                                            TDV    122
        <tv.NetTotMoDy> = IDAY                                                  TDV    123
        <tv.NetTotMoHr> = ISCHR                                                 TDV    124
      ENDIF                                                                     TDV    125
c                                                                               TDV    126
c                                                                               TDV    127
c============= HOURLY, TRANSFER TO NET ======================================== TDV    128
      CASE (14)                                                                 TDV    129
                                                                                TDV    130
      DO  IE=1,20                                                               TDV    131
        <tv.NetEndUseMo>   = <tv.EndUseMo>                                      TDV    132
        <tv.NetEndUseMoM>  = <tv.EndUseMoM>                                     TDV    133
        <tv.NetEndUseMoDy> = <tv.EndUseMoDy>                                    TDV    134
        <tv.NetEndUseMoHr> = <tv.EndUseMoHr>                                    TDV    135
      ENDDO                                                                     TDV    136
c                                                                               TDV    137
c                                                                               TDV    138
c============= SUM MONTHLY TO YEARLY ========================================== TDV    139
      CASE (29)                                                                 TDV    140
                                                                                TDV    141
c              time-dependent valuation                                         TDV    142
      DO  IE=1,20                                                               TDV    143
        <tv.EndUseYr> = <tv.EndUseYr> + <tv.EndUseMo>                           TDV    144
        IF (<tv.EndUseMoM> .GT. <tv.EndUseYrM>)  THEN                           TDV    145
          <tv.EndUseYrM>  = <tv.EndUseMoM>                                      TDV    146
          <tv.EndUseYrMo> = IMO                                                 TDV    147
          <tv.EndUseYrDy> = <tv.EndUseMoDy>                                     TDV    148
        ENDIF                                                                   TDV    149
        <tv.NetEndUseYr> = <tv.NetEndUseYr> + <tv.NetEndUseMo>                  TDV    150
        IF (<tv.NetEndUseMoM> .GT. <tv.NetEndUseYrM>)  THEN                     TDV    151
          <tv.NetEndUseYrM>  = <tv.NetEndUseMoM>                                TDV    152
          <tv.NetEndUseYrMo> = IMO                                              TDV    153
          <tv.NetEndUseYrDy> = <tv.NetEndUseMoDy>                               TDV    154
        ENDIF                                                                   TDV    155
      ENDDO                                                                     TDV    156
                                                                                TDV    157
      <tv.LossYr>   = <tv.LossYr> + <tv.LossMo>                                 TDV    158
      <tv.TDVmaxYr> = Max(<tv.TDVmaxMo>,  <tv.TDVmaxYr>)                        TDV    159
      <tv.TDVminYr> = Min(<tv.TDVminMo>,  <tv.TDVminYr>)                        TDV    160
      <tv.TDVavgYr> = <tv.TDVavgYr> + <tv.TDVavgMo>                             TDV    161
      <tv.TDVhrsYr> = <tv.TDVhrsYr> + <tv.TDVhrsMo>                             TDV    162
                                                                                TDV    163
c             zero monthly values for reuse next month                          TDV    164
      Call ZeroAA(<#tv~MoZeroStart..>, <#tv~MoZeroEnd....>)                     TDV    165
      <tv.TDVminMo> = 1.E6                                                      TDV    166
                                                                                TDV    167
      END SELECT  ! Mode                                                        TDV    168
                                                                                TDV    169
      Return                                                                    TDV    170
      End                                                                       TDV    171
      SUBROUTINE TES_ColdTank_1(Mode)                                           TSCT1    2
c                                                                               TSCT1    3
c              Simulates a chilled water thermal energy storage tank.           TSCT1    4
c              This model is strictly a Btu bucket - whatever is                TSCT1    5
c              put in can be taken back out in an undegraded form.              TSCT1    6
c              This model does not take into account tank stratification,       TSCT1    7
c              loop supply and return temperatures, or flow.                    TSCT1    8
c                                                                               TSCT1    9
c              Mode = 1  Beginning of hour calculations                         TSCT1   10
c              Mode = 2  Get the maximum discharge rate                         TSCT1   11
c              Mode = 3  Load simulation                                        TSCT1   12
c              Mode = 4  Reconciliation at end of hour                          TSCT1   13
c                                                                               TSCT1   14
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PTRSYS/ nzone , iz    , nczd  , zp2 ,         mtw  ,             -045a    1
     $                 nsys  , is    , nss   , nsp ,  ns   , icode,             HR      11
     $                 nsz   , isz   , nzd   , zp1 ,  nz   ,                    HR      12
     $                 nspace, lpr   ,                                          HR      13
     $                 nattch, iatt  ,                                          HR      14
     $                 P2, IDAYHR, IDBWBT,                                      HR      15
     $                 IRPPLT, IRPSUM, IRPSYS, IRPZON, MR1, MR2                 HR      16
      INTEGER          ZP1, ZP2, P2                                             /PTRSYS/14
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /TESDAT/ Qcharge, Qdischarge, Qloss, Qfreeze, Qtank,              /TESDAT/ 2
     &                 CapMax, AuxkW, TtankEnv, Ttank, NumChrgHours,            /TESDAT/ 3
     &                 NumHoursToStart, ChrgHours, DChrgHours,                  /TESDAT/ 4
     &                 StoredKWh, StoredFuel                                    /TESDAT/ 5
      DIMENSION        TESSAV(15)                                               /TESDAT/ 6
      EQUIVALENCE     (TESSAV(1), Qcharge)                                      /TESDAT/ 7
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               TSCT1   24
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /TESKY / ColdTank, HotTank                                        /TESKY/  2
      INTEGER          ColdTank, HotTank                                        /TESKY/  3
c                                                                               TSCT1   28
c                                                                               TSCT1   29
       SELECT CASE (Mode)                                                       TSCT1   30
c                                                                               TSCT1   31
c============= BEGINNING OF HOUR CALCULATIONS ================================= TSCT1   32
      CASE (1)                                                                  TSCT1   33
c              zero hourly data                                                 TSCT1   34
      CALL FILLN(0., TESSAV(1), IVTLIM(2,22))                                   TSCT1   35
c              Estimate tank loss                                               TSCT1   36
c              environmental temperature                                        TSCT1   37
      IF (<tk:ZONE> .EQ. 0)  THEN                                               TSCT1   38
c              Tank is located outdoors.                                        TSCT1   39
        TtankEnv = DBT                                                          TSCT1   40
      ELSE                                                                      TSCT1   41
c              Tank is located indoors                                          TSCT1   42
        ZP1  = <tk:ZONE>                                                        TSCT1   43
        TtankEnv = <TNOW>                                                       TSCT1   44
      ENDIF                                                                     TSCT1   45
c              conductive gains/losses (from perspective of                     TSCT1   46
c              zonal extraction rate)                                           TSCT1   47
      Qloss = <tk:LOSS-COEF> * (TtankEnv-<tk;T_TANK>)                           TSCT1   48
c              Net energy in tank relative to 0 degF                            TSCT1   49
      Qtank = <tk;Q_TANK> + Qloss                                               TSCT1   50
c ??           temporarily store loss until integrated with TEMDEV              TSCT1   51
      <tk;Q_LOSS> = Qloss                                                       TSCT1   52
c              Average tank temperature                                         TSCT1   53
      Ttank = Qtank / <tk;BTU/F>                                                TSCT1   54
c                                                                               TSCT1   55
c              Check to see if tank is freezing - demand heat if so             TSCT1   56
      IF (Ttank .LT. <tk:FREEZE-T>)  THEN                                       TSCT1   57
        Qfreeze = <tk;BTU/F> * (Ttank-<tk:FREEZE-T>)                            -041N   39
        IF (<tk:FREEZE-LOOP> .GT. 0)  THEN                                      -041N   40
          Jlp     = <tk:FREEZE-LOOP>                                            -041N   41
          Qfreeze = Qfreeze * <lp;HCAP_RATIO>                                   -041N   42
          <lp;AUX_HEAT> = <lp;AUX_HEAT> + Qfreeze                               -041N   43
          <lp;PRIM_GPM> = <lp;PRIM_GPM>                                         -041N   44
     &                  + Qfreeze / (<lp;BTUH/GPM-F>*<lp:DESIGN-DT>)            -041N   45
          <tk;Q_FREEZE> = Qfreeze                                               -041N   46
        ELSEIF (<tk:AUX-METER> .gt. 0.)  THEN                                   -041N   47
          <tk;Q_FREEZE> = Qfreeze                                               -041N   48
        ENDIF                                                                   -041N   49
      ELSE                                                                      TSCT1   66
        <tk;Q_FREEZE>   = 0.                                                    TSCT1   67
      ENDIF                                                                     TSCT1   68
c              Determine if tank is charging                                    TSCT1   69
      QchrgPast   = <tk;Q_CHRG>                                                 TSCT1   70
      <tk;Q_CHRG> = 0.                                                          TSCT1   71
      IF (SchVal(<tk:CHRG-SCH>, 1.) .NE. 0.)  THEN                              Time    88
        Jlp = <tk:CHRG-LOOP>                                                    TSCT1   73
c              Tank can't charge if loop scheduled off                          TSCT1   74
        IF (<lp;CTRL_MODE> .EQ. COOLMODE)  THEN                                 TSCT1   75
          IchargeFlag = 1                                                       TSCT1   76
c              if specified, delay charging until last possible hour            TSCT1   77
          IF (<tk:DELAY-CHRG-HR> .NE. 0)  THEN                                  TSCT1   78
c              number of hours needed to charge the tank                        TSCT1   79
            NumChrgHours = INT((Qtank-<tk;Q_FULL>)                              TSCT1   80
     &                                        / <tk:MAX-CHRG-RATE>)             TSCT1   81
c              number of hours remaining to specified delay hour                TSCT1   82
            NumHoursToStart = <tk:DELAY-CHRG-HR> - ISCHR                        TSCT1   83
            IF (NumHoursToStart .LT. 0)                                         TSCT1   84
     &          NumHoursToStart = NumHoursToStart + 24                          TSCT1   85
            NumHoursToStart = MAX(0, NumHoursToStart - NumChrgHours)            TSCT1   86
            IF (NumHoursToStart .GT. 0                                          TSCT1   87
     &                      .AND.  QchrgPast .EQ. 0.)  Ichargeflag = 0          TSCT1   88
          ENDIF                                                                 TSCT1   89
c              dont let tank charge if almost full unless already charging      TSCT1   90
          IF (Qtank .LT. <tk;Q_START_CHRG>                                      TSCT1   91
     &                      .AND.  QchrgPast .EQ. 0.)  Ichargeflag = 0          TSCT1   92
c              amount required to fully charge tank                             TSCT1   93
          Qcharge = Qtank - <tk;Q_FULL>                                         TSCT1   94
          IF (Qcharge .GT. 0.  .AND.  Ichargeflag .EQ. 1)  THEN                 TSCT1   95
c              maximum charging rate as function of time                        TSCT1   96
            ChrgHours = <tk;CHRG_HRS> + 1.                                      TSCT1   97
            ChargeMax = <tk:MAX-CHRG-RATE>                                      TSCT1   98
     &                * CVAL(<tk:CHRG-RATE-FHR>,ChrgHours,ChrgHours)            TSCT1   99
c              charge load this hour (positive number)                          TSCT1  100
            Qcharge = MIN(ChargeMax, Qcharge)                                   TSCT1  101
            <lp;TES_CHRG_COOL> = <lp;TES_CHRG_COOL> + Qcharge                   TSCT1  102
c              required loop temperature for charging                           TSCT1  103
            IF (<tk:CHRG-T-FHR> .EQ. 0)  THEN                                   TSCT1  104
              ChrgT = <tk:CHRG-T>                                               TSCT1  105
            ELSE                                                                TSCT1  106
              ChrgT = CVAL(<tk:CHRG-T-FHR>,ChrgHours,ChrgHours)                 TSCT1  107
            ENDIF                                                               TSCT1  108
            IF (<lp;TES_T> .EQ. 0.)  THEN                                       TSCT1  109
c              first tank on this loop                                          TSCT1  110
              <lp;TES_T> = ChrgT                                                TSCT1  111
            ELSE                                                                TSCT1  112
c              not first tank - minimum of all so far                           TSCT1  113
              <lp;TES_T> = MIN(<lp;TES_T>, ChrgT)                               TSCT1  114
            ENDIF                                                               TSCT1  115
c              loop flow due to storage demand                                  TSCT1  116
            <lp;TES_CHRG_GPM> = <lp;TES_CHRG_GPM>                               TSCT1  117
     &                      + Qcharge / (<lp;BTUH/GPM-F>*<lp:DESIGN-DT>)        TSCT1  118
          ELSE                                                                  TSCT1  119
            Qcharge = 0.                                                        TSCT1  120
          ENDIF                                                                 TSCT1  121
          <tk;Q_CHRG>  = Qcharge                                                TSCT1  122
        ENDIF                                                                   TSCT1  123
      ENDIF                                                                     TSCT1  124
c                                                                               TSCT1  125
c ****         run function : TES_ColdTank_1-1                                  TSCT1  126
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        TSCT1  127
c                                                                               TSCT1  128
c              hourly-report variables                                          TSCT1  129
      IF (<tk;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                                TSCT1  130
     &  CALL HourRepPLT(TESSAV(1), <tk;HREP>, 22, 0)                            TSCT1  131
c                                                                               TSCT1  132
c                                                                               TSCT1  133
c============= DETERMINE MAXIMUM DISCHARGE CAPACITY =========================== TSCT1  134
      CASE (2)                                                                  TSCT1  135
c              first, adjust tank heat for losses                               TSCT1  136
      Qtank = <tk;Q_TANK> + <tk;Q_LOSS>                                         TSCT1  137
c              tank discharge is not available when charging                    TSCT1  138
      IF (<tk;Q_CHRG> .EQ. 0.)  THEN                                            TSCT1  139
c              maximum discharging rate as function of time                     TSCT1  140
        DChrgHours = <tk;DCHRG_HRS> + 1.                                        TSCT1  141
        DChargeMax = <tk:MAX-DCHRG-RAT>                                         TSCT1  142
     &             * CVAL(<tk:DCHRG-RAT-FHR>,DChrgHours,DChrgHours)             TSCT1  143
c              hourly capacities are always a positive number for load          TSCT1  144
c              allocation routines                                              TSCT1  145
        <pe;MAX_CAPACITY> = MIN(DChargeMax ,                                    TSCT1  146
     &                            MAX(0., <tk;Q_BASE>-Qtank))                   TSCT1  147
      ENDIF                                                                     TSCT1  148
c                                                                               TSCT1  149
c ****         run function : TES_ColdTank_1-2                                  TSCT1  150
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        TSCT1  151
c                                                                               TSCT1  152
                                                                                TSCT1  153
c                                                                               TSCT1  154
c============= LOAD SIMULATION ================================================ TSCT1  155
      CASE (3)                                                                  TSCT1  156
c                                                                               TSCT1  157
c                                                                               TSCT1  158
c============= END-OF-HOUR RECONCILIATION ===================================== TSCT1  159
      CASE (4)                                                                  TSCT1  160
c              zero hourly data                                                 TSCT1  161
      CALL FILLN(0., TESSAV(1), IVTLIM(2,22))                                   TSCT1  162
      Jlp = <tk:CHRG-LOOP>                                                      TSCT1  163
c              discharge load                                                   TSCT1  164
      Qdischarge = <pe;LOAD>                                                    TSCT1  165
c              charge load - amount may be less than original request           TSCT1  166
c              if loop was overloaded                                           TSCT1  167
      IF (<tk;Q_CHRG> .gt. 0.)  THEN                                            -042    70
        <tk;Q_CHRG> = <tk;Q_CHRG>*<lp;CHRG_CAP_RATI>                            -042    71
c              make Qcharge non-zero for charge hours, hourly-reports           -042    72
        Qcharge     = Max(0.000001, <tk;Q_CHRG>)                                -042    73
      ENDIF                                                                     -042    74
      <tk;Q_CHRG> = Qcharge                                                     TSCT1  169
c              anti-freeze energy                                               TSCT1  170
      Qfreeze = <tk;Q_FREEZE>                                                   TSCT1  171
      IF (Qfreeze .NE. 0.)  THEN                                                TSCT1  172
        Jlp = <tk:FREEZE-LOOP>                                                  TSCT1  173
        IF (Jlp .GT. 0)                                                         TSCT1  174
     &    Qfreeze       = <tk;Q_FREEZE>*<lp;CHRG_CAP_RATI>                      TSCT1  175
          <tk;Q_FREEZE> = Qfreeze                                               TSCT1  176
      ENDIF                                                                     TSCT1  177
c              net energy in tank                                               TSCT1  178
      Qtank = <tk;Q_TANK> + <tk;Q_LOSS> - Qcharge + Qdischarge - Qfreeze        TSCT1  179
c              average tank temperature                                         TSCT1  180
      Ttank = Qtank / <tk;BTU/F>                                                TSCT1  181
c              count hours charging and discharging                             TSCT1  182
      IF (Qcharge .NE. 0.)  THEN                                                TSCT1  183
        <tk;CHRG_HRS'> = <tk;CHRG_HRS> + 1.                                     TSCT1  184
      ELSE                                                                      TSCT1  185
        <tk;CHRG_HRS'> = 0.                                                     TSCT1  186
      ENDIF                                                                     TSCT1  187
      IF (Qdischarge .NE. 0.)  THEN                                             TSCT1  188
        <tk;DCHRG_HRS'> = <tk;DCHRG_HRS> + 1.                                   TSCT1  189
      ELSE                                                                      TSCT1  190
        <tk;DCHRG_HRS'> = 0.                                                    TSCT1  191
      ENDIF                                                                     TSCT1  192
c                                                                               TSCT1  193
c              fraction of hour the tank was active                             TSCT1  194
      IF (Qcharge+Qdischarge .NE. 0.)  THEN                                     TSCT1  195
        Frac = 1.                                                               TSCT1  196
      ELSE                                                                      TSCT1  197
        Frac = 0.                                                               TSCT1  198
      ENDIF                                                                     TSCT1  199
c                                                                               TSCT1  200
c              Auxiliary power                                                  TSCT1  201
      IF (<tk:AUX-KW> .GT. 0.)  THEN                                            TSCT1  202
c              if always on                                                     TSCT1  203
        IF (<tk:AUX-MODE> .EQ. Always)  THEN                                    TSCT1  204
          AuxkW = <tk:AUX-KW>                                                   TSCT1  205
        ELSEIF (<tk:AUX-MODE> .EQ. WhenOn)  THEN                                TSCT1  206
          AuxkW = <tk:AUX-KW> * Frac                                            TSCT1  207
        ELSEIF (<tk:AUX-MODE> .EQ. WhenOff)  THEN                               TSCT1  208
          AuxkW = <tk:AUX-KW> * (1.0 - Frac)                                    TSCT1  209
        ELSE                                                                    Time    89
          AuxkW = <tk:AUX-KW> * SchVal(<tk:AUX-SCH>, 1.)                        Time    90
        ENDIF                                                                   TSCT1  212
      ELSE                                                                      TSCT1  213
        AuxkW = 0.                                                              TSCT1  214
      ENDIF                                                                     TSCT1  215
      IF (<tk:AUX-METER> .GT. 0  .AND.  <tk:FREEZE-LOOP> .EQ. 0)                -041N   50
     &  AuxkW = AuxkW - <tk;Q_FREEZE>*kWBtu                                     -041N   51
c                                                                               TSCT1  216
c ****         run function : TES_ColdTank_1-4                                  TSCT1  217
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        TSCT1  218
c                                                                               TSCT1  219
c              report variables                                                 TSCT1  220
      <tk;AUX>     = AuxkW                                                      TSCT1  221
      <tk;Q_TANK'> = Qtank                                                      TSCT1  222
      <tk;T_TANK>  = Ttank                                                      TSCT1  223
c                                                                               TSCT1  224
c              hourly-report variables                                          TSCT1  225
      IF (<tk;HREP> .NE. 0  .AND.  IRSCH .NE. 0)  THEN                          TSCT1  226
        CapMax     = <pe;MAX_CAPACITY>                                          TSCT1  227
        Qloss      = <tk;Q_LOSS>                                                TSCT1  228
        ChrgHours  = <tk;CHRG_HRS'>                                             TSCT1  229
        DChrgHours = <tk;DCHRG_HRS'>                                            TSCT1  230
        Neq = <tk;NUM_PRIM_EQ>                                                  TSCT1  231
        DO  ME=1,Neq                                                            TSCT1  232
          StoredKWh  = StoredKWh  + <tk;ELEC_KW>                                TSCT1  233
          StoredFuel = StoredFuel + <tk;FUEL_Q>                                 TSCT1  234
        ENDDO                                                                   TSCT1  235
        CALL HourRepPLT(TESSAV(1), <tk;HREP>, 22, 1)                            TSCT1  236
      ENDIF                                                                     TSCT1  237
c                                                                               TSCT1  238
      END SELECT                                                                TSCT1  239
c                                                                               TSCT1  240
      RETURN                                                                    TSCT1  241
      END                                                                       TSCT1  242
      SUBROUTINE TES_ColdTank_1_Design                                          TSCT1d   2
c                                                                               TSCT1d   3
c              Sets up the chilled water Btu bucket storage tank                TSCT1d   4
c                                                                               TSCT1d   5
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
c                                                                               TSCT1d  11
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /TESKY / ColdTank, HotTank                                        /TESKY/  2
      INTEGER          ColdTank, HotTank                                        /TESKY/  3
c                                                                               TSCT1d  14
c              Tank can only attach to primary loop on charge and               ERV    215
c              discharge side                                                   ERV    216
      Jlp = <tk:DCHRG-LOOP>                                                     ERV    217
      IF (<lp:SUBTYPE> .EQ. 2)  THEN                                            ERV    218
        CALL MSGSIM(-1,II,II,II,II)                                             ERV    219
        WRITE (IOUTPT, 9001)  (<tk:NAME>,II=1,8)                                ERV    220
        call MessageBox( NULL, 'TES attachment error - '                        ERV    221
     &      //' ABORTING'//char(0),'OTES Errors'//char(0), MB_OK                ERV    222
     &      + MB_ICONSTOP + MB_TASKMODAL )                                      ERV    223
        RETURN                                                                  ERV    225
      ENDIF                                                                     ERV    226
      Jlp = <tk:CHRG-LOOP>                                                      ERV    227
      IF (<lp:SUBTYPE> .EQ. 2)  THEN                                            ERV    228
        CALL MSGSIM(-1,II,II,II,II)                                             ERV    229
        WRITE (IOUTPT, 9001)  (<tk:NAME>,II=1,8)                                ERV    230
        call MessageBox( NULL, 'TES attachment error - '                        ERV    231
     &      //' ABORTING'//char(0),'OTES Errors'//char(0), MB_OK                ERV    232
     &      + MB_ICONSTOP + MB_TASKMODAL )                                      ERV    233
        RETURN                                                                  ERV    235
      ENDIF                                                                     ERV    236
c                                                                               ERV    237
c              loop used for sizing parameters is the discharge loop            TSCT1d  15
      Jlp = <tk:DCHRG-LOOP>                                                     TSCT1d  16
c                                                                               TSCT1d  17
c              Tank size                                                        TSCT1d  18
      IF (<tk:CAP> .NE. 0.)  THEN                                               TSCT1d  19
          <tk:CAP> = <tk:CAP> * 1.E6                                            TSCT1d  20
      ELSE                                                                      TSCT1d  21
c              default tank size                                                TSCT1d  22
        IF (<tk:CAP-RATIO> .EQ. UNFILD)  THEN                                   TSCT1d  23
c              default to one hours load                                        TSCT1d  24
          <tk:CAP> = <lp;DES_CCAP>                                              TSCT1d  25
        ELSE                                                                    TSCT1d  26
c              default to multiple of one hours load                            TSCT1d  27
          <tk:CAP> = <lp;DES_CCAP>* <tk:CAP-RATIO>                              TSCT1d  28
        ENDIF                                                                   TSCT1d  29
      ENDIF                                                                     TSCT1d  30
c              maximum charging rate defaults to peak                           TSCT1d  31
      IF (<tk:MAX-CHRG-RATE> .NE. UNFILD)  THEN                                 TSCT1d  32
        <tk:MAX-CHRG-RATE> = <tk:MAX-CHRG-RATE>  * 1.E6                         TSCT1d  33
      ELSE                                                                      TSCT1d  34
        Jlp = <tk:CHRG-LOOP>                                                    Chlr1 2923
        <tk:MAX-CHRG-RATE> = <lp;PRIMARY_CCAP>                                  Chlr1 2924
        Jlp = <tk:DCHRG-LOOP>                                                   Chlr1 2925
      ENDIF                                                                     TSCT1d  36
c              maximum discharging rate defaults to peak                        TSCT1d  37
      IF (<tk:MAX-DCHRG-RAT> .NE. UNFILD)  THEN                                 TSCT1d  38
        <tk:MAX-DCHRG-RAT> = <tk:MAX-DCHRG-RAT>  * 1.E6                         TSCT1d  39
      ELSE                                                                      TSCT1d  40
        <tk:MAX-DCHRG-RAT> = <lp;DES_CCAP>                                      TSCT1d  41
      ENDIF                                                                     TSCT1d  42
c              temperature range from no to max storage defaults                TSCT1d  43
c              to loop dT                                                       TSCT1d  44
      IF (<tk:T-RANGE> .EQ. UNFILD)  <tk:T-RANGE> = <lp:DESIGN-DT>              TSCT1d  45
c              required loop charging temperature defaults to                   TSCT1d  46
c              design setpoint                                                  TSCT1d  47
      IF (<tk:CHRG-T> .EQ. UNFILD)  <tk:CHRG-T> = <lp:DESIGN-COOL-T>            Chlr1 2926
c              base temperature defaults to difference                          TSCT1d  49
c              of the two                                                       TSCT1d  50
      IF (<tk:BASE-T> .EQ. UNFILD)                                              TSCT1d  51
     &    <tk:BASE-T> = <tk:CHRG-T> + <tk:T-RANGE>                              TSCT1d  52
c                                                                               TSCT1d  53
c              tank heat capacity                                               TSCT1d  54
      <tk;BTU/F> = <tk:CAP> / <tk:T-RANGE>                                      TSCT1d  55
c              heat at base temperature                                         TSCT1d  56
      <tk;Q_BASE> = <tk:BASE-T> * <tk;BTU/F>                                    TSCT1d  57
c              heat at fully charged temperature                                TSCT1d  58
      <tk;Q_FULL> = (<tk:BASE-T>-<tk:T-RANGE>) * <tk;BTU/F>                     TSCT1d  59
c              hysteresis energy - tank will not fill unless already            TSCT1d  60
c              filling if the heat content of the tank is greater than          TSCT1d  61
c              this value                                                       TSCT1d  62
      <tk;Q_START_CHRG> = <tk;Q_BASE> + (<tk;Q_FULL>-<tk;Q_BASE>) * 0.9         TSCT1d  63
c              initial charge                                                   TSCT1d  64
      <tk;Q_TANK> = <tk;Q_BASE>                                                 TSCT1d  65
     &            + (<tk;Q_FULL>-<tk;Q_BASE>) * <tk:INITIAL-CHRG>               TSCT1d  66
      <tk;Q_TANK'> = <tk;Q_TANK>                                                TSCT1d  67
c              flows for load allocation routines                               TSCT1d  68
      Jpe = <tk;Jpe>                                                            TSCT1d  69
      <pe;DES_GPM> = <tk:MAX-DCHRG-RAT>                                         TSCT1d  70
     &                                / (<lp;BTUH/GPM-F>*<lp:DESIGN-DT>)        TSCT1d  71
      <pe;MAX_GPM> = <lp;DES_GPM>                                               TSCT1d  72
c              storage tank always has an isolation valve                       TSCT1d  73
      <pe:ISOLATION>  = Yes                                                     TSCT1d  74
c                                                                               TSCT1d  75
c              check if temperature at which tank is fully charged is           TSCT1d  76
c              below the freezing temperature                                   TSCT1d  77
      Tfull = <tk;Q_FULL> / <tk;BTU/F>                                          TSCT1d  78
      IF (Tfull .LT. <tk:FREEZE-T>)  THEN                                       TSCT1d  79
        CALL MSGSIM(-3,II,II,II,II)                                             TSCT1d  80
        WRITE (IOUTPT,9100)  (<tk:NAME>,II=1,8), Tfull, <tk:FREEZE-T>           TSCT1d  81
      ENDIF                                                                     TSCT1d  82
c              check if base temperature is below the freezing temp             TSCT1d  83
      IF (<tk:BASE-T> .LT. <tk:FREEZE-T>)  THEN                                 TSCT1d  84
        CALL MSGSIM(-3,II,II,II,II)                                             TSCT1d  85
        WRITE (IOUTPT,9101)  (<tk:NAME>,II=1,8),                                TSCT1d  86
     &                        <tk:BASE-T>, <tk:FREEZE-T>                        TSCT1d  87
      ENDIF                                                                     TSCT1d  88
c                                                                               TSCT1d  89
c              convert storage delay hour to integer                            TSCT1d  90
      <tk:DELAY-CHRG-HR> = INT(<tk:DELAY-CHRG-R> + 0.1)                         TSCT1d  91
c                                                                               TSCT1d  92
c              message formats                                                  TSCT1d  93
c              message formats                                                  ERV    238
 9001 FORMAT(14X,'Storage tank: ',8A4,' is attached to '               /        ERV    239
     &       14X,'a secondary loop; it must charge/discharge to a'     /        ERV    240
     $       14X,'primary loop.'                                       )        ERV    241
 9100 FORMAT(14X,'Storage tank: ',8A4,' has a base'                    /        TSCT1d  94
     &       14X,'temperature of',F5.1,' which is lower than the'      /        TSCT1d  95
     &       14X,F5.1,' freezing temperature.'                         )        TSCT1d  96
 9101 FORMAT(14X,'Storage tank: ',8A4,' has a charged'                 /        TSCT1d  97
     &       14X,'temperature of',F5.1,' which is lower than the'      /        TSCT1d  98
     &       14X,F5.1,' freezing temperature.'                         )        TSCT1d  99
c                                                                               TSCT1d 100
      RETURN                                                                    TSCT1d 101
      END                                                                       TSCT1d 102
      SUBROUTINE TES_HotTank_1(Mode)                                            TSHT1    2
c                                                                               TSHT1    3
c              Simulates a hot water thermal energy storage tank.               TSHT1    4
c              This model is strictly a Btu bucket - whatever is                TSHT1    5
c              put in can be taken back out in an undegraded form.              TSHT1    6
c              This model does not take into account tank stratification,       TSHT1    7
c              loop supply and return temperatures, or flow.                    TSHT1    8
c                                                                               TSHT1    9
c              Mode = 1  Beginning of hour calculations                         TSHT1   10
c              Mode = 2  Get the maximum discharge rate                         TSHT1   11
c              Mode = 3  Load simulation                                        TSHT1   12
c              Mode = 4  Reconcile at end of hour                               TSHT1   13
c                                                                               TSHT1   14
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PTRSYS/ nzone , iz    , nczd  , zp2 ,         mtw  ,             -045a    1
     $                 nsys  , is    , nss   , nsp ,  ns   , icode,             HR      11
     $                 nsz   , isz   , nzd   , zp1 ,  nz   ,                    HR      12
     $                 nspace, lpr   ,                                          HR      13
     $                 nattch, iatt  ,                                          HR      14
     $                 P2, IDAYHR, IDBWBT,                                      HR      15
     $                 IRPPLT, IRPSUM, IRPSYS, IRPZON, MR1, MR2                 HR      16
      INTEGER          ZP1, ZP2, P2                                             /PTRSYS/14
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /TESDAT/ Qcharge, Qdischarge, Qloss, Qfreeze, Qtank,              /TESDAT/ 2
     &                 CapMax, AuxkW, TtankEnv, Ttank, NumChrgHours,            /TESDAT/ 3
     &                 NumHoursToStart, ChrgHours, DChrgHours,                  /TESDAT/ 4
     &                 StoredKWh, StoredFuel                                    /TESDAT/ 5
      DIMENSION        TESSAV(15)                                               /TESDAT/ 6
      EQUIVALENCE     (TESSAV(1), Qcharge)                                      /TESDAT/ 7
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               TSHT1   24
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /LOOPKY/ CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/ 2
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/ 3
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/ 4
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    1
     &                 CONSTANT, VARIABLE, ModeText(4),                         /LOOPKY/ 6
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/ 7
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/ 8
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/ 9
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/10
     &                 DIRECT, HX,                                              /LOOPKY/11
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/12
      INTEGER          CHW, PIPE2, loop3, HW, loop5, STM, WLHP, DHW,            /LOOPKY/13
     &                 CW, Deleted, PIPE2h, WLHPh, COGEN, NoType,               /LOOPKY/14
     &                 FIXED, OA, SCH, LOAD,  ZONE, OUTDOOR,                    /LOOPKY/15
     &                 STANDBY, DEMAND, SNAP, SCHEDULED, SubhourDemand,         GLHX1    2
     &                 CONSTANT, VARIABLE,                                      /LOOPKY/17
     &                 OFFMODE, FLOATING, HEATMODE, COOLMODE,                   /LOOPKY/18
     &                 AtCoils, EnterLoop, AtPump,                              /LOOPKY/19
     &                 INDOORS, OUTDOORS, TUNNEL, UNDERGROUND,                  /LOOPKY/20
     &                 PRIMARY, SECONDARY,                                      /LOOPKY/21
     &                 DIRECT, HX,                                              /LOOPKY/22
     &                 WATER, ETHYLENE, PROPYLENE, BRINE                        /LOOPKY/23
      COMMON  /TESKY / ColdTank, HotTank                                        /TESKY/  2
      INTEGER          ColdTank, HotTank                                        /TESKY/  3
c                                                                               TSHT1   28
c                                                                               TSHT1   29
       SELECT CASE (Mode)                                                       TSHT1   30
c                                                                               TSHT1   31
c============= BEGINNING OF HOUR CALCULATIONS ================================= TSHT1   32
      CASE (1)                                                                  TSHT1   33
c              zero hourly data                                                 TSHT1   34
      CALL FILLN(0., TESSAV(1), IVTLIM(2,22))                                   TSHT1   35
c              Estimate tank loss                                               TSHT1   36
c              environmental temperature                                        TSHT1   37
      IF (<tk:ZONE> .EQ. 0)  THEN                                               TSHT1   38
c              Tank is located outdoors.                                        TSHT1   39
        TtankEnv = DBT                                                          TSHT1   40
      ELSE                                                                      TSHT1   41
c              Tank is located indoors                                          TSHT1   42
        ZP1  = <tk:ZONE>                                                        TSHT1   43
        TtankEnv = <TNOW>                                                       TSHT1   44
      ENDIF                                                                     TSHT1   45
c              conductive gains/losses (from perspective of                     TSHT1   46
c              zonal extraction rate)                                           TSHT1   47
      Qloss = <tk:LOSS-COEF> * (TtankEnv-<tk;T_TANK>)                           TSHT1   48
c              Net energy in tank relative to 0 degF                            TSHT1   49
      Qtank = <tk;Q_TANK> + Qloss                                               TSHT1   50
c ??           temporarily store loss until integrated with TEMDEV              TSHT1   51
      <tk;Q_LOSS> = Qloss                                                       TSHT1   52
c              Average tank temperature                                         TSHT1   53
      Ttank = Qtank / <tk;BTU/F>                                                TSHT1   54
c                                                                               TSHT1   55
c              Check to see if tank is freezing - demand heat if so             TSHT1   56
      IF (Ttank .LT. <tk:FREEZE-T>)  THEN                                       TSHT1   57
        Jlp = <tk:CHRG-LOOP>                                                    TSHT1   58
        Qfreeze = <tk;BTU/F> * (Ttank-<tk:FREEZE-T>) * <lp;HCAP_RATIO>          TSHT1   59
        <lp;AUX_HEAT> = <lp;AUX_HEAT> + Qfreeze                                 TSHT1   60
        <lp;PRIM_GPM> = <lp;PRIM_GPM>                                           TSHT1   61
     &                + Qfreeze / (<lp;BTUH/GPM-F>*<lp:DESIGN-DT>)              TSHT1   62
        <tk;Q_FREEZE> = Qfreeze                                                 TSHT1   63
      ELSE                                                                      TSHT1   64
        <tk;Q_FREEZE> = 0.                                                      TSHT1   65
      ENDIF                                                                     TSHT1   66
c              Determine if tank is charging                                    TSHT1   67
      QchrgPast   = <tk;Q_CHRG>                                                 TSHT1   68
      <tk;Q_CHRG> = 0.                                                          TSHT1   69
      IF (SchVal(<tk:CHRG-SCH>, 1.) .NE. 0.)  THEN                              Time    91
        Jlp = <tk:CHRG-LOOP>                                                    TSHT1   71
c              Tank can't charge if loop scheduled off                          TSHT1   72
        IF (<lp;CTRL_MODE> .EQ. HEATMODE)  THEN                                 TSHT1   73
          IchargeFlag = 1                                                       TSHT1   74
c              if specified, delay charging until last possible hour            TSHT1   75
          IF (<tk:DELAY-CHRG-HR> .NE. 0)  THEN                                  TSHT1   76
c              number of hours needed to charge the tank                        TSHT1   77
            NumChrgHours = INT((Qtank-<tk;Q_FULL>)                              TSHT1   78
     &                                        / <tk:MAX-CHRG-RATE>)             TSHT1   79
c              number of hours remaining to specified delay hour                TSHT1   80
            NumHoursToStart = <tk:DELAY-CHRG-HR> - ISCHR                        TSHT1   81
            IF (NumHoursToStart .LT. 0)                                         TSHT1   82
     &          NumHoursToStart = NumHoursToStart + 24                          TSHT1   83
            NumHoursToStart = MAX(0, NumHoursToStart - NumChrgHours)            TSHT1   84
            IF (NumHoursToStart .GT. 0                                          TSHT1   85
     &                      .AND.  QchrgPast .EQ. 0.)  Ichargeflag = 0          TSHT1   86
          ENDIF                                                                 TSHT1   87
c              dont let tank charge if almost full unless already charging      TSHT1   88
          IF (Qtank .GT. <tk;Q_START_CHRG>                                      TSHT1   89
     &                      .AND.  QchrgPast .EQ. 0.)  Ichargeflag = 0          TSHT1   90
c              amount required to fully charge tank                             TSHT1   91
          Qcharge = Qtank - <tk;Q_FULL>                                         TSHT1   92
          IF (Qcharge .LT. 0.  .AND.  Ichargeflag .EQ. 1)  THEN                 TSHT1   93
c              maximum charging rate as function of time                        TSHT1   94
            ChrgHours = <tk;CHRG_HRS> + 1.                                      TSHT1   95
            ChargeMax = <tk:MAX-CHRG-RATE>                                      TSHT1   96
     &                * CVAL(<tk:CHRG-RATE-FHR>,ChrgHours,ChrgHours)            TSHT1   97
c              charge load this hour (negative number)                          TSHT1   98
            Qcharge = MAX(ChargeMax, Qcharge)                                   TSHT1   99
            <lp;TES_CHRG_HEAT> = <lp;TES_CHRG_HEAT> + Qcharge                   TSHT1  100
c              required loop temperature for charging                           TSHT1  101
            IF (<tk:CHRG-T-FHR> .EQ. 0)  THEN                                   TSHT1  102
              ChrgT = <tk:CHRG-T>                                               TSHT1  103
            ELSE                                                                TSHT1  104
              ChrgT = CVAL(<tk:CHRG-T-FHR>,ChrgHours,ChrgHours)                 TSHT1  105
            ENDIF                                                               TSHT1  106
            IF (<lp;TES_T> .EQ. 0.)  THEN                                       TSHT1  107
c              first tank on this loop                                          TSHT1  108
              <lp;TES_T> = ChrgT                                                TSHT1  109
            ELSE                                                                TSHT1  110
c              not first tank - maximum of all so far                           TSHT1  111
              <lp;TES_T> = MAX(<lp;TES_T>, ChrgT)                               TSHT1  112
            ENDIF                                                               TSHT1  113
c              loop flow due to storage demand                                  TSHT1  114
            <lp;TES_CHRG_GPM> = <lp;TES_CHRG_GPM>                               TSHT1  115
     &                      + Qcharge / (<lp;BTUH/GPM-F>*<lp:DESIGN-DT>)        TSHT1  116
          ELSE                                                                  TSHT1  117
            Qcharge = 0.                                                        TSHT1  118
          ENDIF                                                                 TSHT1  119
          <tk;Q_CHRG>  = Qcharge                                                TSHT1  120
        ENDIF                                                                   TSHT1  121
      ENDIF                                                                     TSHT1  122
c                                                                               TSHT1  123
c ****         run function : TES_HotTank_1-1                                   TSHT1  124
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        TSHT1  125
c                                                                               TSHT1  126
c              hourly-report variables                                          TSHT1  127
      IF (<tk;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                                TSHT1  128
     &  CALL HourRepPLT(TESSAV(1), <tk;HREP>, 22, 0)                            TSHT1  129
c                                                                               TSHT1  130
c                                                                               TSHT1  131
c============= DETERMINE MAXIMUM DISCHARGE CAPACITY =========================== TSHT1  132
      CASE (2)                                                                  TSHT1  133
c              first, adjust tank heat for losses                               TSHT1  134
      Qtank = <tk;Q_TANK> + <tk;Q_LOSS>                                         TSHT1  135
c              tank discharge is not available when charging                    TSHT1  136
      IF (<tk;Q_CHRG> .EQ. 0.)  THEN                                            TSHT1  137
c              maximum discharging rate as function of time                     TSHT1  138
        DChrgHours = <tk;DCHRG_HRS> + 1.                                        TSHT1  139
        DChargeMax = <tk:MAX-DCHRG-RAT>                                         TSHT1  140
     &             * CVAL(<tk:DCHRG-RAT-FHR>,DChrgHours,DChrgHours)             TSHT1  141
c              hourly capacities are always a positive number for load          TSHT1  142
c              allocation routines                                              TSHT1  143
        <pe;MAX_CAPACITY> = -MAX(DChargeMax ,                                   TSHT1  144
     &                             MIN(0., <tk;Q_BASE>-Qtank))                  TSHT1  145
      ENDIF                                                                     TSHT1  146
c                                                                               TSHT1  147
c ****         run function : TES_HotTank_1-2                                   TSHT1  148
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        TSHT1  149
c                                                                               TSHT1  150
c                                                                               TSHT1  151
c============= LOAD SIMULATION ================================================ TSHT1  152
      CASE (3)                                                                  TSHT1  153
      <pe;LOAD> = -<pe;LOAD>                                                    TSHT1  154
c                                                                               TSHT1  155
c                                                                               TSHT1  156
c============= END-OF-HOUR RECONCILIATION ===================================== TSHT1  157
      CASE (4)                                                                  TSHT1  158
c              zero hourly data                                                 TSHT1  159
      CALL FILLN(0., TESSAV(1), IVTLIM(2,22))                                   TSHT1  160
      Jlp = <tk:CHRG-LOOP>                                                      TSHT1  161
c              discharge load                                                   TSHT1  162
      Qdischarge = <pe;LOAD>                                                    TSHT1  163
c              charge load - amount may be less than original request           TSHT1  164
c              if loop was overloaded                                           TSHT1  165
      IF (<tk;Q_CHRG> .lt. 0.)  THEN                                            -042    75
        <tk;Q_CHRG> = <tk;Q_CHRG>*<lp;CHRG_CAP_RATI>                            -042    76
c              make Qcharge non-zero for charge hours, hourly-reports           -042    77
        Qcharge     = Min(-0.000001, <tk;Q_CHRG>)                               -042    78
      ENDIF                                                                     -042    79
      <tk;Q_CHRG> = Qcharge                                                     TSHT1  167
c              anti-freeze energy                                               TSHT1  168
      Qfreeze       = <tk;Q_FREEZE>*<lp;CHRG_CAP_RATI>                          TSHT1  169
      <tk;Q_FREEZE> = Qfreeze                                                   TSHT1  170
c              net energy in tank                                               TSHT1  171
      Qtank = <tk;Q_TANK> + <tk;Q_LOSS> - Qcharge + Qdischarge - Qfreeze        TSHT1  172
c              average tank temperature                                         TSHT1  173
      Ttank = Qtank / <tk;BTU/F>                                                TSHT1  174
c              count hours charging and discharging                             TSHT1  175
      IF (Qcharge .NE. 0.)  THEN                                                TSHT1  176
        <tk;CHRG_HRS'> = <tk;CHRG_HRS> + 1.                                     TSHT1  177
      ELSE                                                                      TSHT1  178
        <tk;CHRG_HRS'> = 0.                                                     TSHT1  179
      ENDIF                                                                     TSHT1  180
      IF (Qdischarge .NE. 0.)  THEN                                             TSHT1  181
        <tk;DCHRG_HRS'> = <tk;DCHRG_HRS> + 1.                                   TSHT1  182
      ELSE                                                                      TSHT1  183
        <tk;DCHRG_HRS'> = 0.                                                    TSHT1  184
      ENDIF                                                                     TSHT1  185
c                                                                               TSHT1  186
c              fraction of hour the tank was active                             TSHT1  187
      IF (Qcharge+Qdischarge .NE. 0.)  THEN                                     TSHT1  188
        Frac = 1.                                                               TSHT1  189
      ELSE                                                                      TSHT1  190
        Frac = 0.                                                               TSHT1  191
      ENDIF                                                                     TSHT1  192
c                                                                               TSHT1  193
c              Auxiliary power                                                  TSHT1  194
      IF (<tk:AUX-KW> .GT. 0.)  THEN                                            TSHT1  195
c              if always on                                                     TSHT1  196
        IF (<tk:AUX-MODE> .EQ. Always)  THEN                                    TSHT1  197
          AuxkW = <tk:AUX-KW>                                                   TSHT1  198
        ELSEIF (<tk:AUX-MODE> .EQ. WhenOn)  THEN                                TSHT1  199
          AuxkW = <tk:AUX-KW> * Frac                                            TSHT1  200
        ELSEIF (<tk:AUX-MODE> .EQ. WhenOff)  THEN                               TSHT1  201
          AuxkW = <tk:AUX-KW> * (1.0 - Frac)                                    TSHT1  202
        ELSE                                                                    Time    92
          AuxkW = <tk:AUX-KW> * SchVal(<tk:AUX-SCH>, 1.)                        Time    93
        ENDIF                                                                   TSHT1  205
      ELSE                                                                      TSHT1  206
        AuxkW = 0.                                                              TSHT1  207
      ENDIF                                                                     TSHT1  208
c                                                                               TSHT1  209
c ****         run function : TES_HotTank_1-4                                   TSHT1  210
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        TSHT1  211
c                                                                               TSHT1  212
c              report variables                                                 TSHT1  213
      <tk;AUX>     = AuxkW                                                      TSHT1  214
      <tk;Q_TANK'> = Qtank                                                      TSHT1  215
      <tk;T_TANK>  = Ttank                                                      TSHT1  216
c                                                                               TSHT1  217
c              hourly-report variables                                          TSHT1  218
      IF (<tk;HREP> .NE. 0  .AND.  IRSCH .NE. 0)  THEN                          TSHT1  219
        CapMax     = <pe;MAX_CAPACITY>                                          TSHT1  220
        Qloss      = <tk;Q_LOSS>                                                TSHT1  221
        ChrgHours  = <tk;CHRG_HRS'>                                             TSHT1  222
        DChrgHours = <tk;DCHRG_HRS'>                                            TSHT1  223
        Neq = <tk;NUM_PRIM_EQ>                                                  TSHT1  224
        DO  ME=1,Neq                                                            TSHT1  225
          StoredKWh  = StoredKWh  + <tk;ELEC_KW>                                TSHT1  226
          StoredFuel = StoredFuel + <tk;FUEL_Q>                                 TSHT1  227
        ENDDO                                                                   TSHT1  228
        CALL HourRepPLT(TESSAV(1), <tk;HREP>, 22, 1)                            TSHT1  229
      ENDIF                                                                     TSHT1  230
c                                                                               TSHT1  231
      END SELECT                                                                TSHT1  232
c                                                                               TSHT1  233
      RETURN                                                                    TSHT1  234
      END                                                                       TSHT1  235
      SUBROUTINE TES_HotTank_1_Design                                           TSHT1d   2
c                                                                               TSHT1d   3
c              Sets up the hot water Btu bucket storage tank                    TSHT1d   4
c                                                                               TSHT1d   5
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON /WCTRL/  IwinReturn, Imsgflg                                       /WCTRL/  2
c              For DLLs, delete Win_MB and enable msgbox.fi                     -044c2   1
#ifndef _DLL                                                                 /* -048     1 */ 
      COMMON /WIN_MB/ MB_OK,MB_ICONSTOP,MB_ICONEXCLAMATION,MB_TASKMODAL,        -048     2
     &                MB_ICONINFORMATION                                        -048     3
#else                                                                        /* -048     4 */ 
      include 'msgbox.fi'                                                       -048     5
#endif                                                                       /* -048     6 */ 
c                                                                               TSHT1d  11
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /TESKY / ColdTank, HotTank                                        /TESKY/  2
      INTEGER          ColdTank, HotTank                                        /TESKY/  3
c                                                                               TSHT1d  14
c              Tank can only attach to primary loop on charge and               ERV    243
c              discharge side                                                   ERV    244
      Jlp = <tk:DCHRG-LOOP>                                                     ERV    245
      IF (<lp:SUBTYPE> .EQ. 2)  THEN                                            ERV    246
        CALL MSGSIM(-1,II,II,II,II)                                             ERV    247
        WRITE (IOUTPT, 9001)  (<tk:NAME>,II=1,8)                                ERV    248
        call MessageBox( NULL, 'TES attachment error - '                        ERV    249
     &      //' ABORTING'//char(0),'OTES Errors'//char(0), MB_OK                ERV    250
     &      + MB_ICONSTOP + MB_TASKMODAL )                                      ERV    251
        RETURN                                                                  ERV    253
      ENDIF                                                                     ERV    254
      Jlp = <tk:CHRG-LOOP>                                                      ERV    255
      IF (<lp:SUBTYPE> .EQ. 2)  THEN                                            ERV    256
        CALL MSGSIM(-1,II,II,II,II)                                             ERV    257
        WRITE (IOUTPT, 9001)  (<tk:NAME>,II=1,8)                                ERV    258
        call MessageBox( NULL, 'TES attachment error - '                        ERV    259
     &      //' ABORTING'//char(0),'OTES Errors'//char(0), MB_OK                ERV    260
     &      + MB_ICONSTOP + MB_TASKMODAL )                                      ERV    261
        RETURN                                                                  ERV    263
      ENDIF                                                                     ERV    264
c                                                                               ERV    265
c              loop used for sizing parameters is the discharge loop            TSHT1d  15
      Jlp = <tk:DCHRG-LOOP>                                                     TSHT1d  16
c                                                                               TSHT1d  17
c              Tank size                                                        TSHT1d  18
      IF (<tk:CAP> .NE. 0.)  THEN                                               TSHT1d  19
          <tk:CAP> = -ABS(<tk:CAP> * 1.E6)                                      TSHT1d  20
      ELSE                                                                      TSHT1d  21
c              default tank size                                                TSHT1d  22
        IF (<tk:CAP-RATIO> .EQ. UNFILD)  THEN                                   TSHT1d  23
c              default to one hours load                                        TSHT1d  24
          <tk:CAP> = <lp;DES_HCAP>                                              TSHT1d  25
        ELSE                                                                    TSHT1d  26
c              default to multiple of one hours load                            TSHT1d  27
          <tk:CAP> = <lp;DES_HCAP>* <tk:CAP-RATIO>                              TSHT1d  28
        ENDIF                                                                   TSHT1d  29
      ENDIF                                                                     TSHT1d  30
c              maximum charging rate defaults to peak                           TSHT1d  31
      IF (<tk:MAX-CHRG-RATE> .NE. UNFILD)  THEN                                 TSHT1d  32
        <tk:MAX-CHRG-RATE> = -ABS(<tk:MAX-CHRG-RATE> * 1.E6)                    TSHT1d  33
      ELSE                                                                      TSHT1d  34
        Jlp = <tk:CHRG-LOOP>                                                    Chlr1 2927
        <tk:MAX-CHRG-RATE> = <lp;PRIMARY_HCAP>                                  Chlr1 2928
        Jlp = <tk:DCHRG-LOOP>                                                   Chlr1 2929
      ENDIF                                                                     TSHT1d  36
c              maximum discharging rate defaults to peak                        TSHT1d  37
      IF (<tk:MAX-DCHRG-RAT> .NE. UNFILD)  THEN                                 TSHT1d  38
        <tk:MAX-DCHRG-RAT> = -ABS(<tk:MAX-DCHRG-RAT> * 1.E6)                    TSHT1d  39
      ELSE                                                                      TSHT1d  40
        <tk:MAX-DCHRG-RAT> = <lp;DES_HCAP>                                      TSHT1d  41
      ENDIF                                                                     TSHT1d  42
c              temperature range from no to max storage defaults                TSHT1d  43
c              to loop dT                                                       TSHT1d  44
      IF (<tk:T-RANGE> .EQ. UNFILD)  <tk:T-RANGE> = <lp:DESIGN-DT>              TSHT1d  45
c              required loop charging temperature defaults to                   TSHT1d  46
c              design setpoint                                                  TSHT1d  47
      IF (<tk:CHRG-T> .EQ. UNFILD)  <tk:CHRG-T> = <lp:DESIGN-HEAT-T>            Chlr1 2930
c              base temperature defaults to difference                          TSHT1d  49
c              of the two                                                       TSHT1d  50
      IF (<tk:BASE-T> .EQ. UNFILD)                                              TSHT1d  51
     &    <tk:BASE-T> = <tk:CHRG-T> + <tk:T-RANGE>                              TSHT1d  52
c                                                                               TSHT1d  53
c              tank heat capacity                                               TSHT1d  54
      <tk;BTU/F> = <tk:CAP> / <tk:T-RANGE>                                      TSHT1d  55
c              heat at base temperature                                         TSHT1d  56
      <tk;Q_BASE> = <tk:BASE-T> * <tk;BTU/F>                                    TSHT1d  57
c              heat at fully charged temperature                                TSHT1d  58
      <tk;Q_FULL> = (<tk:BASE-T>-<tk:T-RANGE>) * <tk;BTU/F>                     TSHT1d  59
c              hysteresis energy - tank will not fill unless already            TSHT1d  60
c              filling if the heat content of the tank is greater than          TSHT1d  61
c              this value                                                       TSHT1d  62
      <tk;Q_START_CHRG> = <tk;Q_BASE> + (<tk;Q_FULL>-<tk;Q_BASE>) * 0.9         TSHT1d  63
c              initial charge                                                   TSHT1d  64
      <tk;Q_TANK> = <tk;Q_BASE>                                                 TSHT1d  65
     &            + (<tk;Q_FULL>-<tk;Q_BASE>) * <tk:INITIAL-CHRG>               TSHT1d  66
      <tk;Q_TANK'> = <tk;Q_TANK>                                                TSHT1d  67
c              flows for load allocation routines                               TSHT1d  68
      Jpe = <tk;Jpe>                                                            TSHT1d  69
      <pe;DES_GPM> = <tk:MAX-DCHRG-RAT>                                         TSHT1d  70
     &                                / (<lp;BTUH/GPM-F>*<lp:DESIGN-DT>)        TSHT1d  71
      <pe;MAX_GPM> = <lp;DES_GPM>                                               TSHT1d  72
c              storage tank always has an isolation valve                       TSHT1d  73
      <pe:ISOLATION>  = Yes                                                     TSHT1d  74
c                                                                               TSHT1d  75
c              check if temperature at which tank is fully charged is           TSHT1d  76
c              below the freezing temperature                                   TSHT1d  77
      Tfull = <tk;Q_FULL> / <tk;BTU/F>                                          TSHT1d  78
      IF (Tfull .LT. <tk:FREEZE-T>)  THEN                                       TSHT1d  79
        CALL MSGSIM(-3,II,II,II,II)                                             TSHT1d  80
        WRITE (IOUTPT,9100)  (<tk:NAME>,II=1,8), Tfull, <tk:FREEZE-T>           TSHT1d  81
      ENDIF                                                                     TSHT1d  82
c              check if base temperature is below the freezing temp             TSHT1d  83
      IF (<tk:BASE-T> .LT. <tk:FREEZE-T>)  THEN                                 TSHT1d  84
        CALL MSGSIM(-3,II,II,II,II)                                             TSHT1d  85
        WRITE (IOUTPT,9101)  (<tk:NAME>,II=1,8),                                TSHT1d  86
     &                        <tk:BASE-T>, <tk:FREEZE-T>                        TSHT1d  87
      ENDIF                                                                     TSHT1d  88
c                                                                               TSHT1d  89
c              convert storage delay hour to integer                            TSHT1d  90
      <tk:DELAY-CHRG-HR> = INT(<tk:DELAY-CHRG-R> + 0.1)                         TSHT1d  91
c                                                                               TSHT1d  92
c              message formats                                                  TSHT1d  93
c              message formats                                                  ERV    266
 9001 FORMAT(14X,'Storage tank: ',8A4,' is attached to '               /        ERV    267
     &       14X,'a secondary loop; it must charge/discharge to a'     /        ERV    268
     $       14X,'primary loop.'                                       )        ERV    269
 9100 FORMAT(14X,'Storage tank: ',8A4,' has a base'                    /        TSHT1d  94
     &       14X,'temperature of',F5.1,' which is lower than the'      /        TSHT1d  95
     &       14X,F5.1,' freezing temperature.'                         )        TSHT1d  96
 9101 FORMAT(14X,'Storage tank: ',8A4,' has a charged'                 /        TSHT1d  97
     &       14X,'temperature of',F5.1,' which is lower than the'      /        TSHT1d  98
     &       14X,F5.1,' freezing temperature.'                         )        TSHT1d  99
c                                                                               TSHT1d 100
      RETURN                                                                    TSHT1d 101
      END                                                                       TSHT1d 102
      FUNCTION Transformer_Loss(Elec_kW)                                        TRANSL   2
c                                                                               TRANSL   3
c                                                                               TRANSL   4
c              Calculates the losses in an electric transformer                 TRANSL   5
c                                                                               TRANSL   6
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               TRANSL  10
c                                                                               TRANSL  11
c              Skip if no loss                                                  TRANSL  12
      IF (<em;DESIGN_LOSS> .EQ.  0.)  THEN                                      TRANSL  13
        Transformer_Loss = 0.                                                   TRANSL  14
      ELSE                                                                      TRANSL  15
        PLR = MIN(1., Elec_kW / <em:TRANS-SIZE>)                                TRANSL  16
        Transformer_Loss = <em;DESIGN_LOSS>                                     TRANSL  17
     &                                 * CVAL(<em:LOSS-FPLR>,PLR,PLR)           TRANSL  18
      ENDIF                                                                     TRANSL  19
c                                                                               TRANSL  20
      RETURN                                                                    TRANSL  21
      END                                                                       TRANSL  22
      FUNCTION TwrCFMr(GPMcell, Range, Approach, Wetbulb)                       TWRCFM   2
c                                                                               TWRCFM   3
c              Calculates the airflow required to provide the heat              TWRCFM   4
c              rejection of a cooling tower or fluid cooler                     TWRCFM   5
c                                                                               TWRCFM   6
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               TWRCFM  10
c              limits for performance curves                                    TWRCFM  11
      DIMENSION AIRLIM(2)                                                       TWRCFM  12
      DATA      AIRLIM   /  1., -1./                                            TWRCFM  13
c                                                                               TWRCFM  14
c              GPMcell   Flow through the tower, per cell                       TWRCFM  15
c              CFMr      Fraction of design fan airflow                         TWRCFM  16
c              Range     Temperature drop thru tower                            TWRCFM  17
c              Approach  Temperature above wetbulb                              TWRCFM  18
c              Wetbulb   Wetbulb temperature                                    TWRCFM  19
c                                                                               TWRCFM  20
c              gpm capacity                                                     TWRCFM  21
      GPMr   = CVAL(<tw:GPM-fAPP&WB>,Approach,Wetbulb)                          TWRCFM  22
     &             / CVAL(<tw:GPM-fRNG&WB>,Range,Wetbulb)                       TWRCFM  23
c              flow per cell                                                    TWRCFM  24
      GPMcap = <tw;GPM/CELL_CTI>*GPMr                                           TWRCFM  25
c              capacity ratio per cell                                          TWRCFM  26
      CellCapRatio = GPMcell / GPMcap                                           TWRCFM  27
c              pull out the CFM ratio that matches the capacity ratio           TWRCFM  28
      Jcv = <tw:GPM-fAIRFLOW>                                                   -045b  187
      CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 1,CFMr,Y,CellCapRatio,                 -045b  188
     &                                                  AIRLIM(1),IERR)         -045b  189
      TwrCFMr = CFMr                                                            TWRCFM  31
c                                                                               TWRCFM  32
      RETURN                                                                    TWRCFM  33
      END                                                                       TWRCFM  34
      FUNCTION TwrGPMCap(Range, Approach, Wetbulb)                              TWRGPM   2
c                                                                               TWRGPM   3
c              Calculates the GPM capacity per cell of a cooling tower          TWRGPM   4
c              or fluid cooler                                                  TWRGPM   5
c                                                                               TWRGPM   6
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               TWRGPM  10
c              CTIgpm    Flow at the CTI rating point (95/85/78)                TWRGPM  11
c              Range     Temperature drop thru tower                            TWRGPM  12
c              Approach  Leaving temperature minus wetbulb                      TWRGPM  13
c              Wetbulb   Wetbulb temperature                                    TWRGPM  14
c                                                                               TWRGPM  15
c              gpm ratio                                                        TWRGPM  16
      GPMratio = CVAL(<tw:GPM-fAPP&WB>,Approach,Wetbulb)                        TWRGPM  17
     &             / CVAL(<tw:GPM-fRNG&WB>,Range,Wetbulb)                       TWRGPM  18
c              gpm capacity                                                     TWRGPM  19
      TwrGPMCap = <tw;GPM/CELL_CTI> * GPMratio                                  TWRGPM  20
c                                                                               TWRGPM  21
      RETURN                                                                    TWRGPM  22
      END                                                                       TWRGPM  23
      FUNCTION TwrQrej(GPMcell, CFMr, Tenter, Wetbulb)                          TWRQ     2
c                                                                               TWRQ     3
c              Calculates the heat rejection capacity of a cooling              TWRQ     4
c              tower or fluid cooler for a given ENTERING temperature           TWRQ     5
c                                                                               TWRQ     6
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               TWRQ    10
c              limits for performance curves                                    TWRQ    11
      DIMENSION RngLim(2)                                                       TWRQ    12
      DATA      RngLim   / 60., 0./                                             TWRQ    13
c                                                                               TWRQ    14
c              GPMcell   Flow through the tower, per cell                       TWRQ    15
c              CFMr      Fraction of design fan airflow                         TWRQ    16
c              Tenter    Temperature of fluid entering the tower                TWRQ    17
c              Range     Temperature drop thru tower at balance point           TWRQ    18
c              Approach  Temperature above wetbulb at balance point             TWRQ    19
c              Wetbulb   Wetbulb temperature                                    TWRQ    20
c                                                                               TWRQ    21
c              cell capacity ratio as a function of cfm ratio                   TWRQ    22
      CellCapRatio = CVAL(<tw:GPM-fAIRFLOW>,CFMr,CFMr)                          TWRQ    23
c              required cell capacity, gpm                                      TWRQ    24
      GPMcap = GPMcell / CellCapRatio                                           TWRQ    25
c              required cell capacity ratio                                     TWRQ    26
      GPMr   = GPMcap / <tw;GPM/CELL_CTI>                                       TWRQ    27
c              minimum leaving temperature                                      TWRQ    28
c              pointer to gpm = f(rng,wb) curve                                 TWRQ    30
      Jcv = <tw:GPM-fRNG&WB>                                                    -045b  190
c              maximum and minimum value of the range function for which        TWRQ    32
c              the curve can be inverted (not necessarily accurately)           TWRQ    33
      fRngWBMax = CVAL(<tw:GPM-fRNG&WB>,<tw:MAX-RANGE>, Wetbulb)                TWRQ    34
      fRngWBMin = CVAL(<tw:GPM-fRNG&WB>,           3.0, Wetbulb)                TWRQ    35
      RngLim(1) = <tw:MAX-RANGE> + 1.0                                          TWRQ    36
c              minimum value of the approach function for which the             TWRQ    37
c              curve is accurate                                                TWRQ    38
      fAppWBMin = CVAL(<tw:GPM-fAPP&WB>,3.0,Wetbulb) / 3.0                      TWRQ    39
c                                                                               Proces 198
c              Simultaneously solve for the range and approach using            Proces 199
c              a bi-sectional search                                            Proces 200
      Qlast  = 0.                                                               Proces 201
      AppMin = 0.                                                               Proces 202
      AppMax = Tenter - Wetbulb                                                 Proces 203
      DO                                                                        Proces 204
        Approach = (AppMin+AppMax) * 0.5                                        Proces 205
c              Range corresponding to approach                                  Proces 206
        IF (Approach .GE. 3.0)  THEN                                            Proces 207
          fRngWB = CVAL(<tw:GPM-fAPP&WB>,Approach,Wetbulb) / GPMr               Proces 208
        ELSE                                                                    Proces 209
c              Interpolate below approach of 3 deg.                             Proces 210
c              Assume GPMr=0 at approach=0                                      Proces 211
          fRngWB = fAppWBMin*Approach / GPMr                                    Proces 212
        ENDIF                                                                   Proces 213
c              limit fRngWB to below value of max range to keep                 Proces 214
c              inverse from blowing out                                         Proces 215
        fRngWB = MIN(fRngWBMax, fRngWB)                                         Proces 216
c              and back out the range                                           Proces 217
        IF (fRngWB .GT. fRngWBMin )  THEN                                       Proces 218
          CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 1,Range,Wetbulb,fRngWB,            -045b  191
     &                                                  RNGLIM(1),IERR)         Proces 220
        ELSE                                                                    Proces 221
c             Interpolate below minimum range value                             Proces 222
c             Assume GPMr=infinity at range=0                                   Proces 223
          Range = 3.0 * fRngWB/fRngWBMin                                        Proces 224
        ENDIF                                                                   Proces 225
c              heat rejection                                                   Proces 226
        Qtwr = GPMcell * <lp;BTUH/GPM-F> * Range                                Proces 227
c              see if converged                                                 Proces 228
        IF (ABS(Qlast/Qtwr - 1.) .LT. 0.01  .OR.                                Proces 229
     &                               ABS(AppMax-AppMin) .LT. 0.01)  EXIT        Proces 230
        Qlast = Qtwr                                                            Proces 231
c              leaving temperature and approach                                 Proces 232
        Texit  = Tenter - Range                                                 Proces 233
        AppNew = Texit  - Wetbulb                                               Proces 234
c              update search limits                                             Proces 235
        IF (AppNew .LT. Approach)  THEN                                         Proces 236
          AppMax = Approach                                                     Proces 237
        ELSE                                                                    Proces 238
          AppMin = Approach                                                     Proces 239
        ENDIF                                                                   Proces 240
      ENDDO                                                                     Proces 241
c              convergence achieved                                             Proces 242
      TwrQrej = Qtwr                                                            Proces 243
c                                                                               TWRQ   102
      RETURN                                                                    TWRQ   103
      END                                                                       TWRQ   104
      FUNCTION TwrTexit(Qload, GPM, CellNum, CFMr, Wetbulb)                     TWRT     2
c                                                                               TWRT     3
c              Calculates the leaving tower temperature for                     TWRT     4
c              a given fan speed.                                               TWRT     5
c                                                                               TWRT     6
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
c                                                                               TWRT    11
c              limits for performance curves                                    TWRT    12
      DIMENSION APPLIM(2)                                                       TWRT    13
      DATA      APPLIM   / 90.,-10./                                            TWRT    14
c                                                                               TWRT    15
c              Qload     Heat rejection load, excluding temp swing              TWRT    16
c              GPM       Flow through the tower                                 TWRT    17
c              CFMr      Fraction of design fan airflow                         TWRT    18
c              Range     Temperature drop thru tower at balance point           TWRT    19
c              Approach  Temperature above wetbulb at balance point             TWRT    20
c              Wetbulb   Wetbulb temperature                                    TWRT    21
c                                                                               TWRT    22
c              beginning of hour loop temperature                               TWRT    23
      Tstart = <lp;SUPPLY_T>                                                    TWRT    24
c              initial heat rejection load                                      TWRT    25
      Qrej   = Qload + PMPQ                                                     TWRT    26
c              initial range                                                    TWRT    27
      Range = MAX(Qrej / (GPM * <lp;BTUH/GPM-F>), 1.0)                          TWRT    28
c              capacity ratio as function of airflow                            TWRT    29
      CellCapRatio = CVAL(<tw:GPM-fAIRFLOW>,CFMr,CFMr)                          TWRT    30
c              required gpm capacity ratio                                      TWRT    31
      GPMr = GPM / (<tw;GPM/CELL_CTI>*CellNum*CellCapRatio)                     TWRT    32
c              minimum value of the approach function for which the             TWRT    33
c              curve is accurate                                                TWRT    34
      fAppWBMin = CVAL(<tw:GPM-fAPP&WB>,3.0,Wetbulb)                            TWRT    35
      Iter = 0                                                                  TWRT    36
      Told = Tstart                                                             TWRT    37
      Jcv  = <tw:GPM-fAPP&WB>                                                   -045b  192
c                                                                               TWRT    39
c              Start of iterations                                              TWRT    40
c              Back out the value of the approach correction curve              TWRT    41
   10 fAppWB = GPMr * CVAL(<tw:GPM-fRNG&WB>,Range,Wetbulb)                      TWRT    42
c              and calculate the approach                                       TWRT    43
      IF (fAppWB .GT. fAppWBMin)  THEN                                          TWRT    44
        CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 1,Approach,Wetbulb,fAppWB,           -045b  193
     &                                                  APPLIM(1),IERR)         TWRT    46
      ELSE                                                                      TWRT    47
        Approach = 3.0 * fAppWB/fAppWBMin                                       TWRT    48
      ENDIF                                                                     TWRT    49
c              leaving tower temperature, upstream of any pump                  TWRT    50
      Texit = Wetbulb + Approach                                                TWRT    51
c              adjust Qrej and Range for new tower temperature and              TWRT    52
c              iterate until temperature converges to 0.5F                      TWRT    53
      IF (ABS(Told-Texit) .GT. 0.5  .AND.  Iter .LT. 10)  THEN                  TWRT    54
        Iter  = Iter + 1                                                        TWRT    55
        Told  = Texit                                                           TWRT    56
        Qrej  = Qload + (Tstart-Texit)*<lp;BTU/F> + PMPQ                        TWRT    57
        Range = MAX(Qrej / (GPM * <lp;BTUH/GPM-F>), 1.0)                        TWRT    58
        GOTO 10                                                                 TWRT    59
      ENDIF                                                                     TWRT    60
      TwrTexit = Texit + PMPdT                                                  TWRT    61
c                                                                               TWRT    62
      RETURN                                                                    TWRT    63
      END                                                                       TWRT    64
      FUNCTION TwrHxCFMr(CWinletT,CWgpm, Qhx, TowerGPM,CellNum,                 TWXCFM   2
     &                                                   Range,Wetbulb)         TWXCFM   3
c                                                                               TWXCFM   4
c              Calculates the airflow required to provide the specified         TWXCFM   5
c              heat rejection of a cooling tower coupled to its loop            TWXCFM   6
c              thru a heat-exchanger                                            TWXCFM   7
c                                                                               TWXCFM   8
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
c                                                                               TWXCFM  13
c              find the tower-side temperatures necessary to match              TWXCFM  14
c              the load                                                         TWXCFM  15
      CALL HeatExchanger(Jhx,5,MaxFlag, Qhx, TowerGPM,    SupTi, SupTo,         TWXCFM  16
     &                                          CWgpm, CWinletT,   xxx)         TWXCFM  17
c              flow per cell                                                    TWXCFM  18
      GPMcell   = TowerGPM / CellNum                                            TWXCFM  19
c              approach to wetbulb                                              TWXCFM  20
      Approach  = SupTi-PMPdT - Wetbulb                                         TWXCFM  21
c              and the required airflow                                         TWXCFM  22
      TwrHxCFMr = TwrCFMr(GPMcell, Range, Approach, Wetbulb)                    TWXCFM  23
c                                                                               TWXCFM  24
      RETURN                                                                    TWXCFM  25
      END                                                                       TWXCFM  26
      FUNCTION TwrHxGPMCap(HXsetpt,CWdt,  TowerGPM,CellNum,PumpQ,               TWXGPM   2
     &                                                        Wetbulb)          TWXGPM   3
c                                                                               TWXGPM   4
c              Calculates the gpm capacity of a cooling tower                   TWXGPM   5
c              coupled to its loop via a heat-exchanger                         TWXGPM   6
c                                                                               TWXGPM   7
c                                                                               TWXGPM   8
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /LOOPD / RunLoop, ModeCtrl, GPMs, GPMr, QloopNet, QcoilH,         /LOOPD/  2
     &                 QcoilC, Q2nd, Q1st, QCp, QlossS, QlossR, Tenv,           /LOOPD/  3
     &                 Tset, Tsupply, TcoilEnt, TcoilExit, Treturn,             /LOOPD/  4
     &                 dTsc, dTrc, TavgS, TavgR, TavgPast, Tfloat,              /LOOPD/  5
     &                 HDpump, Qpump, dTpump, GPM21, HEAD21f, Qover,            /LOOPD/  6
     &                 QpumpEq, GPMpumpEq, dTpumpEq, PipeHead,                  /LOOPD/  7
     &                 DesEqGPM, PLRpipe, TotalLoopCap, CapRatio,               /LOOPD/  8
     &                 GPM2, Friction, Qhtrec, Thtrec, dTover, TcoilEst,        /LOOPD/  9
     &                 Qprocess, Tinlet, QoverNew, lp48, lp49, lp50             /LOOPD/ 10
      REAL             LOOPDAT(50)                                              /LOOPD/ 11
      EQUIVALENCE     (LOOPDAT(1), RunLoop)                                     /LOOPD/ 12
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               TWXGPM  14
c              HXsetpt   Temperature setpoint on loop outlet of hx              TWXGPM  15
c              CWdt      Temperature drop on loop-side of hx                    TWXGPM  16
c              TowerGPM  Flow on tower-side of hx                               TWXGPM  17
c              CellNum   Number of tower cells that are active                  TWXGPM  18
c              PumpQ     Tower pump heat                                        TWXGPM  19
c              Wetbulb   Wetbulb temperature                                    TWXGPM  20
c                                                                               TWXGPM  21
c              CW temperature entering hx                                       TWXGPM  22
      CWinletT = HXsetpt + CWdT                                                 TWXGPM  23
c              flow per tower cell                                              TWXGPM  24
      GPMcell  = TowerGPM / CellNum                                             TWXGPM  25
c                                                                               Proces 244
c              Solve for flow capacity using a bi-sectional search              Proces 245
      TwrToutMax = HXsetpt                                                      Proces 246
      TwrToutMin = Wetbulb                                                      Proces 247
      DO                                                                        Proces 248
        TwrTout = (TwrToutMax+TwrToutMin) * 0.5                                 Proces 249
c              heat-exchanger capacity                                          Proces 250
        CALL HeatExchanger(Jhx,3,MaxFlag,Qhx, TowerGPM,  TwrTout,    xx,        Proces 251
     &                                         CWgpm, CWinletT, HXsetpt)        Proces 252
c              tower capacity                                                   Proces 253
        TwrTin = TwrTout + Qhx/(TowerGPM*<lp;BTUH/GPM-F>)                       Proces 254
        Qtwr   = TwrQrej(GPMcell, 1.0, TwrTin, Wetbulb)                         Proces 255
        Qtwr   = Qtwr*CellNum - PumpQ                                           Proces 256
c              see if converged                                                 Proces 257
        IF (ABS(Qtwr/Qhx - 1.) .LT. 0.02  .OR.                                  Proces 258
     &                       ABS(TwrToutMax-TwrToutMin) .LT. 0.01)  EXIT        Proces 259
c              update search limits                                             Proces 260
        IF (Qtwr .GT. Qhx)  THEN                                                Proces 261
          TwrToutMax = TwrTout                                                  Proces 262
        ELSE                                                                    Proces 263
          TwrToutMin = TwrTout                                                  Proces 264
        ENDIF                                                                   Proces 265
      ENDDO                                                                     Proces 266
c              convergence achieved                                             Proces 267
      TwrHxGPMCap = CWgpm                                                       Proces 268
                                                                                TWXGPM  47
      RETURN                                                                    TWXGPM  48
      END                                                                       TWXGPM  49
      FUNCTION TwrHxQrej(CWinletT,CWgpm,                                        TWXQ     2
     &                   TowerGPM,CellNum,CFMr, Wetbulb)                        TWXQ     3
c                                                                               TWXQ     4
c              Calculates the heat rejection capacity of a cooling              TWXQ     5
c              tower coupled to its loop via a heat-exchanger.                  TWXQ     6
c              The capacity assumes a given loop temperature ENTERING           TWXQ     7
c              the HX.                                                          TWXQ     8
c                                                                               TWXQ     9
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
c                                                                               TWXQ    14
c              CWinletT  Temperature ENTERING the hx (loop return T)            TWXQ    15
c              CWgpm     Flow on condenser-side of hx                           TWXQ    16
c              TowerGPM  Flow on tower-side of hx                               TWXQ    17
c              CellNum   Number of tower cells that are active                  TWXQ    18
c              CFMr      Fraction of design airflow thru tower                  TWXQ    19
c              PumpQ     Tower pump heat                                        TWXQ    20
c              Wetbulb   Wetbulb temperature                                    TWXQ    21
c                                                                               TWXQ    22
c              flow per tower cell                                              TWXQ    23
      GPMcell  = TowerGPM / CellNum                                             TWXQ    24
c              Initialize limits on the tower HX outlet T                       Proces 269
      TwrTinMin = Wetbulb                                                       Proces 270
      TwrTinMax = CWinletT                                                      Proces 271
c              Solve for heat rejection using a bi-sectional search             Proces 272
      Qlast = 0.                                                                Proces 273
      DO                                                                        Proces 274
c              tower inlet temperature, heat rejected                           -041i    1
        TwrTin  = (TwrTinMin+TwrTinMax) * 0.5                                   -041i    2
        Qtwr    = TwrQrej(GPMcell, CFMr, TwrTin, Wetbulb) * CellNum             -041i    3
c              outlet temperature, adjusted for pump heat                       -041i    4
        Qtwr    = Qtwr - PMPQ                                                   -041i    5
        TwrTout = TwrTin - Qtwr / (TowerGPM*<lp;BTUH/GPM-F>)                    -041i    6
c              Qhx and temperature leaving hx, entering tower                   Proces 282
        CALL HeatExchanger(Jhx,1,MaxFlag,Qhx, TowerGPM,  TwrTout, xxx,          -041i    7
     &                                           CWgpm, CWinletT, xxx)          -041i    8
c              see if converged                                                 Proces 285
        IF (ABS(Qtwr/Qhx - 1.) .LT. 0.02  .OR.                                  Proces 286
     &                         ABS(TwrTinMax-TwrTinMin) .LT. 0.01)  EXIT        Proces 287
c              update search limits                                             Proces 288
        IF (Qtwr .GT. Qhx)  THEN                                                Proces 289
          TwrTinMax = TwrTin                                                    Proces 290
        ELSE                                                                    Proces 291
          TwrTinMin = TwrTin                                                    Proces 292
        ENDIF                                                                   Proces 293
      ENDDO                                                                     Proces 294
c              convergence achieved                                             Proces 295
      TwrHxQrej = Qhx                                                           Proces 296
c                                                                               TWXQ    55
      RETURN                                                                    TWXQ    56
      END                                                                       TWXQ    57
      FUNCTION TwrHxTexit(CWgpm, Qload,TowerGPM,CellNum,CFMr, Wetbulb)          TWXT     2
c                                                                               TWXT     3
c              Calculates the leaving tower temperature for                     TWXT     4
c              a given fan speed when the tower is coupled to its               TWXT     5
c              loop thru a heat-exchanger.                                      TWXT     6
c                                                                               TWXT     7
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PUMPD / PMPgpm, PMPkW, PMPnum, RPMr, PMPfrac, PMPset,            /PUMPD/  2
     &                 PMPhead, PMPfric, PMPstatic, HEADr, PMPGPMr,             /PUMPD/  3
     &                 GPMmax, HPRPM, XGPMR, PMPHPR, PMPQ, PMPdT,               /PUMPD/  4
     &                 PMPVFDloss, pmp19, pmp20                                 -034     1
      REAL             PUMPDAT(20)                                              /PUMPD/  6
      EQUIVALENCE     (PUMPDAT(1), PMPgpm)                                      /PUMPD/  7
c                                                                               TWXT    12
c              limits for performance curves                                    TWXT    13
      DIMENSION APPLIM(2)                                                       TWXT    14
      DATA      APPLIM   / 90.,-10./                                            TWXT    15
c                                                                               TWXT    16
c              CWgpm     Flow on condenser-side of hx                           TWXT    17
c              Qload     Heat rejection load without pump heat or swing         TWXT    18
c              TowerGPM  Flow on tower-side of hx                               TWXT    19
c              CellNum   Number of tower cells that are active                  TWXT    20
c              CFMr      Fraction of design airflow thru tower                  TWXT    21
c              Wetbulb   Wetbulb temperature                                    TWXT    22
c                                                                               TWXT    23
c              beginning of hour loop temperature                               TWXT    24
      Tstart = <lp;SUPPLY_T>                                                    TWXT    25
c              initial heat rejection load                                      TWXT    26
      Qrej   = Qload + PMPQ                                                     TWXT    27
c              initial range                                                    TWXT    28
      Range = MAX(Qrej / (TowerGPM * <lp;BTUH/GPM-F>), 1.0)                     TWXT    29
c              capacity ratio as function of airflow                            TWXT    30
      CellCapRatio = CVAL(<tw:GPM-fAIRFLOW>,CFMr,CFMr)                          TWXT    31
c              required gpm capacity ratio                                      TWXT    32
      GPMr = TowerGPM / (<tw;GPM/CELL_CTI>*CellNum*CellCapRatio)                TWXT    33
c              minimum value of the approach function for which the             TWXT    34
c              curve is accurate                                                TWXT    35
      fAppWBMin = CVAL(<tw:GPM-fAPP&WB>,3.0,Wetbulb)                            TWXT    36
      Iter = 0                                                                  TWXT    37
      Told = Tstart                                                             TWXT    38
      Jcv  = <tw:GPM-fAPP&WB>                                                   -045b  194
c                                                                               TWXT    40
c              Start of iterations                                              TWXT    41
c              Back out the value of the approach correction curve              TWXT    42
   10 fAppWB = GPMr * CVAL(<tw:GPM-fRNG&WB>,Range,Wetbulb)                      TWXT    43
c              and calculate the approach                                       TWXT    44
      IF (fAppWB .GT. fAppWBMin)  THEN                                          TWXT    45
        CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 1,Approach,Wetbulb,fAppWB,           -045b  195
                                                                                -045b  196
     &                                                  APPLIM(1),IERR)         TWXT    47
      ELSE                                                                      TWXT    48
        Approach = 3.0 * fAppWB/fAppWBMin                                       TWXT    49
      ENDIF                                                                     TWXT    50
c              leaving tower temperature, downstream of any pump                TWXT    51
      TwrExit = Wetbulb + Approach + PMPdT                                      TWXT    52
c              get supply temperature on loop side of hx                        TWXT    53
      CALL HeatExchanger(Jhx,4,MaxFlag,Qrej, TowerGPM, TwrExit,   xxx,          TWXT    54
     &                                          CWgpm,     xxx, DemTo)          TWXT    55
c              adjust Qrej and Range for new loop supply temperature and        TWXT    56
c              iterate until temperature converges to 0.5F                      TWXT    57
      IF (ABS(Told-DemTo) .GT. 0.5  .AND.  Iter .LT. 10)  THEN                  TWXT    58
        Iter  = Iter + 1                                                        TWXT    59
        Told  = DemTo                                                           TWXT    60
        Qrej  = Qload + PMPQ + (Tstart-DemTo)*<lp;BTU/F>                        TWXT    61
        Range = MAX(Qrej / (TowerGPM * <lp;BTUH/GPM-F>), 1.0)                   TWXT    62
        GOTO 10                                                                 TWXT    63
      ENDIF                                                                     TWXT    64
      TwrHxTexit = DemTo                                                        TWXT    65
c                                                                               TWXT    66
      RETURN                                                                    TWXT    67
      END                                                                       TWXT    68
C ##############################################################################COGENi   2
C ##############################################################################COGENi   3
C ##############################################################################COGENi   4
C ##############################################################################COGENi   5
C ##########                                                          ##########COGENi   6
C ##########                  COGENERATION ROUTINES                   ##########COGENi   7
C ##########                                                          ##########COGENi   8
C ##############################################################################COGENi   9
C ##############################################################################COGENi  10
C ##############################################################################COGENi  11
C ##############################################################################COGENi  12
c                                                                               COGENi  13
c              Simulates all electric generators and calculates                 COGENi  14
c              heat recovery                                                    COGENi  15
c                                                                               COGENi  16
c    Routines:                                                                  COGENi  17
c      Cogeneration         Coordinates electric generators with                COGENi  18
c                           electric and thermal loads                          COGENi  19
c      CogenerationEquip    Selects the appropriate generator                   COGENi  20
c                           simulation algorithm                                COGENi  21
c      CogenSetThermalCap   Sets the thermal operating capacities of a          COGENi  22
c                           meter's cogeneration equipment as a function        COGENi  23
c                           of the electrical demand                            COGENi  24
c      CogenZeroThermalCap  Zeros the thermal operating capacities of a         COGENi  25
c                           meter's cogeneration equipment                      COGENi  26
c      CogenLoopHtrec       Calculates the heat that may be recovered           COGENi  27
c                           from a meter's cogeneration equipment               COGENi  28
c      EngineGen1           Simulates an engine-generator set                   COGENi  29
c      EstimateElec         Estimates the electrical loads on all meters        COGENi  30
c      GasTurbineGen1       Simulates a gas-turbine generator set               COGENi  31
c      SteamEnthalpy        Calculates the enthaply of steam.                   COGENi  32
c      SteamEntropy         Calculates the entropy of steam                     COGENi  33
c      SteamSaturationT     Calculates the saturated steam temperature          COGENi  34
c                           as a function of steam pressure                     COGENi  35
c      SteamTurbineGen1     Simulates a steam-turbine generator                 COGENi  36
c                                                                               COGENi  37
c                                                                               COGENi  38
      SUBROUTINE Cogeneration(Mode)                                             COGEN    2
c                                                                               COGEN    3
c              Coordinates electric generators with electrical and thermal      COGEN    4
c              loads                                                            COGEN    5
c                                                                               COGEN    6
c              Mode  1  After chillers and CW loops simulated first time        COGEN    7
c                       and prior to simulating heating equipment,              COGEN    8
c                       initialize the generator electric operating             COGEN    9
c                       capacities, estimate electrical loads,                  COGEN   10
c                       allocate loads to equipment, and simulate               COGEN   11
c                       in elec tracking mode.  Determine recoverable           COGEN   12
c                       heat, and set thermal operating capacities.             COGEN   13
c                    2  After heating loops simulated for first time,           COGEN   14
c                       estimate electrical loads, allocate loads to            COGEN   15
c                       equipment, simulate both elec and thermal               COGEN   16
c                       tracking, reconcile demands, calc recovered heat        COGEN   17
c                       and heat rejected.                                      COGEN   18
c                    3  Same as 1, but 2nd call after condenser loops           COGEN   19
c                       have been simulated for the second time.                COGEN   20
c                    4  Same as 2, but final call                               COGEN   21
c                                                                               COGEN   22
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /COGENn/ CogenMode, CogenIterateIndex, TrackMode,                 /COGEN/  2
     &                 QCogenWaste                                              /COGEN/  3
      INTEGER          CogenMode, CogenIterateIndex, TrackMode                  /COGEN/  4
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /ZEROP/  LpmHR,LlpHR,LchHR,LblHR,LdwHR,LtwHR,LpvHR,LgnHR,         PV       5
     &                 LtkHR,LhxHR,LecHR,LlmHR,LemHR,LfmHR,LsmHR,LcmHR,         /ZEROP/  3
     &                 LglHR,LpeHR,                                             /ZEROP/  4
     &                 LpmMO,LlpMO,LchMO,LblMO,LdwMO,LtwMO,LpvMO,LgnMO,         PV       6
     &                 LtkMO,LhxMO,LecMO,LlmMO,LemMO,LfmMO,LsmMO,LcmMO,         /ZEROP/  6
     &                 LglMO,LpeMO,                                             /ZEROP/  7
     &                 LpmYR,LlpYR,LchYR,LblYR,LdwYR,LtwYR,LpvYR,LgnYR,         PV       7
     &                 LtkYR,LhxYR,LecYR,LlmYR,LemYR,LfmYR,LsmYR,LcmYR,         /ZEROP/  9
     &                 LglYR,LpeYR                                              /ZEROP/ 10
c                                                                               COGEN   30
      REAL Load                                                                 COGEN   31
c                                                                               COGEN   32
      LastCtrl = SimCtrl                                                        COGEN   33
c                                                                               COGEN   34
c                                                                               COGEN   35
      SELECT CASE (Mode)                                                        COGEN   36
c                                                                               COGEN   37
c                                                                               COGEN   38
c============= MODE 1&3 ======================================================= COGEN   39
      CASE (1,3)                                                                COGEN   40
c              After chillers and CW loops simulated                            COGEN   41
c              and prior to simulating heating equipment,                       COGEN   42
c              initialize the generator electric operating                      COGEN   43
c              capacities, estimate electrical loads,                           COGEN   44
c              allocate loads to equipment, and simulate                        COGEN   45
c              in elec tracking mode.  Determine recoverable                    COGEN   46
c              heat, and set thermal operating capacities.                      COGEN   47
c                                                                               COGEN   48
c              Initialize the generators and calculate operating                COGEN   49
c              capacities                                                       COGEN   50
      SimCtrl = 11                                                              COGEN   51
      DO  Neq=1,Ngn                                                             COGEN   52
        Jgn = Ign + (Neq-1)*Lgn                                                 COGEN   53
        CALL FILLN(0., <=HRBJgn>, LgnHR)                                        COGEN   54
c              Initialize Jpe variables                                         COGEN   55
        IF (<gn;Jpe_Exhaust> .GT. 0)  THEN                                      COGEN   56
          Jpe = <gn;Jpe_Exhaust>                                                COGEN   57
          <pe;LOAD> = 0.                                                        COGEN   58
        ENDIF                                                                   COGEN   59
        IF (<gn;Jpe_Jacket> .GT. 0)  THEN                                       COGEN   60
          Jpe = <gn;Jpe_Jacket>                                                 COGEN   61
          <pe;LOAD> = 0.                                                        COGEN   62
        ENDIF                                                                   COGEN   63
        Jpe = <gn;Jpe>                                                          COGEN   64
        <pe;LOAD> = 0.                                                          COGEN   65
c              get operating capacities, both elec and thermal                  COGEN   66
        CALL CogenerationEquip(1)                                               COGEN   67
      ENDDO                                                                     COGEN   68
c                                                                               COGEN   69
c              Zero cogen loop variables                                        COGEN   70
      DO  NL =1,Nlp                                                             COGEN   71
        Jlp = Ilp + (NL-1)*Llp                                                  COGEN   72
        <lp;CogenHtrec>    = 0.                                                 COGEN   73
      ENDDO                                                                     COGEN   74
c              Estimate the electric load on each meter                         COGEN   75
      CALL EstimateElec                                                         COGEN   76
c                                                                               COGEN   77
c              Loop thru each meter and simulate equipment in elec              COGEN   78
c              tracking mode                                                    COGEN   79
      SimCtrl = 12                                                              COGEN   80
      DO  Nmeter=1,Nem                                                          COGEN   81
        Jem = Iem + (Nmeter-1)*Lem                                              COGEN   82
c              skip if no cogen equipment                                       COGEN   83
        IF (<em;NumCogen> .EQ. 0)  CYCLE                                        COGEN   84
        JemMeter = Jem                                                          COGEN   85
        Neq      = <em;NumCogen>                                                COGEN   86
c                                                                               COGEN   87
c              Tracking mode                                                    COGEN   88
        IF (Mode .EQ. 1)  THEN                                                  COGEN   89
          IF (<em:TRACK-SCH> .GT. 0)  THEN                                      COGEN   90
            TrackMode    = INT(SchVal(<em:TRACK-SCH>, 1.) + 0.1)                Time    94
          ELSE                                                                  COGEN   92
            TrackMode    = <em:TRACK-MODE>                                      COGEN   93
          ENDIF                                                                 COGEN   94
          <em;TrackMode> = TrackMode                                            COGEN   95
        ENDIF                                                                   COGEN   96
c                                                                               COGEN   97
        SELECT CASE (<em;TrackMode>)                                            COGEN   98
          CASE (1)  ! TrackElec                                                 COGEN   99
c              allocate estimated electrical load                               COGEN  100
            Load = <em;EstimatedKW>                                             COGEN  101
            IF (Load .GT. 0.)  THEN                                             ERV    270
              IF (<em;EQUIP_CTRL> .GT. 0)  THEN                                 ERV    271
                Jec  = <em;EQUIP_CTRL>                                          ERV    272
                CALL EquipCtrl(Load, xxx, xxx)                                  ERV    273
              ELSE                                                              ERV    274
                CALL EquipCtrlDefaultElec(Load, xxx)                            ERV    275
              ENDIF                                                             ERV    276
            ENDIF                                                               ERV    277
c              simulate equipment and calc the heat recoverable to              COGEN  108
c              each circulation loop                                            COGEN  109
            DO  IQ=1,Neq                                                        COGEN  110
              Jpe = <em;CogenJpePtrs>                                           COGEN  111
              CALL CogenerationEquip(2)                                         COGEN  112
            ENDDO                                                               COGEN  113
            CALL CogenLoopHtrec                                                 COGEN  114
c              Zero the thermal capacity of equipment under this meter          COGEN  115
c              so that they won't be used in any HW EQUIP-CTRL sequences        COGEN  116
            CALL CogenZeroThermalCap                                            COGEN  117
          CASE (2)  ! TrackThermal                                              COGEN  118
          CASE (3)  ! TrackLesser                                               COGEN  119
c              allocate estimated electrical load                               COGEN  120
            Load = <em;EstimatedKW>                                             COGEN  121
            IF (Load .GT. 0.)  THEN                                             ERV    278
              IF (<em;EQUIP_CTRL> .GT. 0)  THEN                                 ERV    279
                Jec  = <em;EQUIP_CTRL>                                          ERV    280
                CALL EquipCtrl(Load, xxx, xxx)                                  ERV    281
              ELSE                                                              ERV    282
                CALL EquipCtrlDefaultElec(Load, xxx)                            ERV    283
              ENDIF                                                             ERV    284
            ENDIF                                                               ERV    285
c              simulate equipment and calc the heat recoverable to              COGEN  128
c              each circulation loop                                            COGEN  129
            DO  IQ=1,Neq                                                        COGEN  130
              Jpe = <em;CogenJpePtrs>                                           COGEN  131
              CALL CogenerationEquip(2)                                         COGEN  132
            ENDDO                                                               COGEN  133
c              reduce the thermal capacity                                      COGEN  134
            CALL CogenSetThermalCap                                             COGEN  135
          CASE (4)  ! TrackGreater                                              COGEN  136
c              allocate estimated electrical load                               COGEN  137
            Load = <em;EstimatedKW>                                             COGEN  138
            IF (Load .GT. 0.)  THEN                                             ERV    286
              IF (<em;EQUIP_CTRL> .GT. 0)  THEN                                 ERV    287
                Jec  = <em;EQUIP_CTRL>                                          ERV    288
                CALL EquipCtrl(Load, xxx, xxx)                                  ERV    289
              ELSE                                                              ERV    290
                CALL EquipCtrlDefaultElec(Load, xxx)                            ERV    291
              ENDIF                                                             ERV    292
            ENDIF                                                               ERV    293
          CASE (5)  ! MaxOutput                                                 COGEN  145
c              set the load and simulate equipment                              COGEN  146
            DO  IQ=1,Neq                                                        COGEN  147
              Jpe = <em;CogenJpePtrs>                                           COGEN  148
              <pe;LOAD> = <pe;MAX_CAPACITY>                                     COGEN  149
              CALL CogenerationEquip(2)                                         COGEN  150
            ENDDO                                                               COGEN  151
c              calc heat recoverable to each circulation-loop                   COGEN  152
            CALL CogenLoopHtrec                                                 COGEN  153
c              Zero the thermal capacity of equipment under this meter          COGEN  154
c              so that they won't be used in any HW EQUIP-CTRL sequences        COGEN  155
            CALL CogenZeroThermalCap                                            COGEN  156
          CASE DEFAULT  ! DontRun                                               COGEN  157
c              zero thermal capacity of all equipment under this meter          COGEN  158
c              so that they won't be used in any HW EQUIP-CTRL sequences        COGEN  159
            CALL CogenZeroThermalCap                                            COGEN  160
        END SELECT                                                              COGEN  161
      ENDDO  ! Nmeter                                                           COGEN  162
c                                                                               COGEN  163
c                                                                               COGEN  164
c============= MODE 2&4 ======================================================= COGEN  165
      CASE (2,4)                                                                COGEN  166
c              After heating loops simulated, estimate electrical loads,        COGEN  167
c              allocate loads to equipment, simulate both elec and              COGEN  168
c              thermal tracking, reconcile demands, calc recovered heat         COGEN  169
c              and heat rejected.                                               COGEN  170
c                                                                               COGEN  171
c              Zero cogen loop variables                                        COGEN  172
      DO  NL =1,Nlp                                                             COGEN  173
        Jlp = Ilp + (NL-1)*Llp                                                  COGEN  174
        <lp;CogenHtrec> = 0.                                                    COGEN  175
        <lp;CogenQ>     = 0.                                                    COGEN  176
        <lp;CogenGPM>   = 0.                                                    COGEN  177
      ENDDO                                                                     COGEN  178
c              Estimate the electric load on each meter                         COGEN  179
      CALL EstimateElec                                                         COGEN  180
c                                                                               COGEN  181
c              Loop thru each meter, adjust loads on equipment that is          COGEN  182
c              electric tracking, simulate equipment that is thermal            COGEN  183
c              tracking, and reconcile elec/thermal demands                     COGEN  184
      DO  Nmeter=1,Nem                                                          COGEN  185
        Jem = Iem + (Nmeter-1)*Lem                                              COGEN  186
c              skip if no cogen equipment                                       COGEN  187
        IF (<em;NumCogen> .EQ. 0)  CYCLE                                        COGEN  188
        Neq = <em;NumCogen>                                                     COGEN  189
        <em;CogenElecCap> = 0.                                                  COGEN  190
c                                                                               COGEN  191
c              Adjust loads on equipment that is electric tracking              COGEN  192
        SELECT CASE (<em;TrackMode>)                                            COGEN  193
          CASE (0,2,5)  ! No electric tracking                                  COGEN  194
          CASE (1,3,4)  ! Electric tracking of some sort                        COGEN  195
c              Adjust elec tracking loads.  Assume same mix of euqipment        COGEN  196
c              as the last call                                                 COGEN  197
            IF (<em;EstimatedLast> .GT. 0.  .AND.                               COGEN  198
     &          <em;EstimatedLast> .NE. <em;EstimatedKW>)  THEN                 COGEN  199
              Prorate = <em;EstimatedKW> / <em;EstimatedLast>                   COGEN  200
              DO  IQ=1,Neq                                                      COGEN  201
                Jpe = <em;CogenJpePtrs>                                         COGEN  202
                <pe;LOAD> = MIN(<pe;MAX_CAPACITY>, <pe;LOAD>*Prorate)           COGEN  203
              ENDDO                                                             COGEN  204
            ENDIF                                                               COGEN  205
        END SELECT                                                              COGEN  206
c                                                                               COGEN  207
c              Get equivalent elec loads for equipment that is thermal          COGEN  208
c              tracking.  Note that thermal tracking loads were assigned        COGEN  209
c              in the circulation loop routines.                                COGEN  210
        SELECT CASE (<em;TrackMode>)                                            COGEN  211
          CASE (2,3,4)  ! Thermal tracking of some sort                         COGEN  212
            SimCtrl = 13                                                        COGEN  213
            DO  IQ=1,Neq                                                        COGEN  214
              Jpe = <em;CogenJpePtrs>                                           COGEN  215
              CALL CogenerationEquip(2)                                         COGEN  216
            ENDDO                                                               COGEN  217
          CASE (0,1,5)  ! No thermal tracking                                   COGEN  218
        END SELECT                                                              COGEN  219
c                                                                               COGEN  220
                                                                                COGEN  221
c              Reconcile electric/thermal tracking demands.                     COGEN  222
        SELECT CASE (<em;TrackMode>)                                            COGEN  223
          CASE (0)  ! DontRun                                                   COGEN  224
          CASE (1)  ! TrackElec                                                 COGEN  225
c              sum capacity                                                     COGEN  226
            DO  IQ=1,Neq                                                        COGEN  227
              Jpe = <em;CogenJpePtrs>                                           COGEN  228
              Jgn = <pe;Jparent>                                                COGEN  229
              IF (<pe;OPER_CAPACITY> .GT. 0.  .AND.                             PV     228
     &            <pe;LOAD>/<pe;OPER_CAPACITY> .GE. <gn:MIN-RATIO>) THEN        PV     229
                <em;CogenElecCap> = <em;CogenElecCap>+<pe;MAX_CAPACITY>         PV     230
              ELSE                                                              COGEN  233
                <pe;LOAD> = 0.                                                  COGEN  234
              ENDIF                                                             COGEN  235
            ENDDO                                                               COGEN  236
          CASE (2)  ! TrackThermal                                              COGEN  237
c              use electrical load corresponding to thermal                     COGEN  238
            DO  IQ=1,Neq                                                        COGEN  239
              Jpe = <em;CogenJpePtrs>                                           COGEN  240
              Jgn = <pe;Jparent>                                                COGEN  241
              SELECT CASE (<gn:RCVR-TRACK-LP>)                                  COGEN  242
                CASE (1)  ! Exhaust tracking                                    COGEN  243
                  Jpe         = <gn;Jpe_Exhaust>                                COGEN  244
                  ThermalReqt = <pe;LOAD>                                       COGEN  245
                CASE (2)  ! Jacket tracking                                     COGEN  246
                  Jpe         = <gn;Jpe_Jacket>                                 COGEN  247
                  ThermalReqt = <pe;LOAD>                                       COGEN  248
                CASE (3)  ! Track greater of exhaust or jacket                  COGEN  249
                  Jpe         = <gn;Jpe_Exhaust>                                COGEN  250
                  ThermalReqt = <pe;LOAD>                                       COGEN  251
                  Jpe         = <gn;Jpe_Jacket>                                 COGEN  252
                  ThermalReqt = MAX(ThermalReqt, <pe;LOAD>)                     COGEN  253
                CASE DEFAULT                                                    COGEN  254
                  ThermalReqt = 0.                                              COGEN  255
              END SELECT                                                        COGEN  256
              Jpe               = <em;CogenJpePtrs>                             COGEN  257
              <pe;LOAD>         = ThermalReqt                                   COGEN  258
              <em;CogenElecCap> = <em;CogenElecCap> + ThermalReqt               COGEN  259
            ENDDO                                                               COGEN  260
          CASE (3)  ! TrackLesser                                               COGEN  261
c              select smaller of elec and thermal requirements                  COGEN  262
            DO  IQ=1,Neq                                                        COGEN  263
              Jpe      = <em;CogenJpePtrs>                                      COGEN  264
              Jgn      = <pe;Jparent>                                           COGEN  265
              ElecReqt = <pe;LOAD>                                              COGEN  266
              SELECT CASE (<gn:RCVR-TRACK-LP>)                                  COGEN  267
                CASE (1)  ! Exhaust tracking                                    COGEN  268
                  Jpe         = <gn;Jpe_Exhaust>                                COGEN  269
                  ThermalReqt = <pe;LOAD>                                       COGEN  270
                CASE (2)  ! Jacket tracking                                     COGEN  271
                  Jpe         = <gn;Jpe_Jacket>                                 COGEN  272
                  ThermalReqt = <pe;LOAD>                                       COGEN  273
                CASE (3)  ! Track lesser of exhaust or jacket                   COGEN  274
                  Jpe         = <gn;Jpe_Exhaust>                                COGEN  275
                  ThermalReqt = <pe;LOAD>                                       COGEN  276
                  Jpe         = <gn;Jpe_Jacket>                                 COGEN  277
                  ThermalReqt = MIN(ThermalReqt, <pe;LOAD>)                     COGEN  278
                CASE DEFAULT                                                    COGEN  279
                  ThermalReqt = 0.                                              COGEN  280
              END SELECT                                                        COGEN  281
              Jpe       = <em;CogenJpePtrs>                                     COGEN  282
              <pe;LOAD> = MIN(ElecReqt, ThermalReqt)                            COGEN  283
              IF (<pe;OPER_CAPACITY> .GT. 0.  .AND.                             PV     231
     &            <pe;LOAD>/<pe;OPER_CAPACITY> .GE. <gn:MIN-RATIO>) THEN        PV     232
                <em;CogenElecCap> = <em;CogenElecCap> + ThermalReqt             COGEN  285
              ELSE                                                              COGEN  286
                <pe;LOAD> = 0.                                                  COGEN  287
              ENDIF                                                             COGEN  288
            ENDDO                                                               COGEN  289
          CASE (4)  ! TrackGreater                                              COGEN  290
c              select greater of elec and thermal requirements                  COGEN  291
            DO  IQ=1,Neq                                                        COGEN  292
              Jpe      = <em;CogenJpePtrs>                                      COGEN  293
              Jgn      = <pe;Jparent>                                           COGEN  294
              ElecReqt = <pe;LOAD>                                              COGEN  295
              SELECT CASE (<gn:RCVR-TRACK-LP>)                                  COGEN  296
                CASE (1)  ! Exhaust tracking                                    COGEN  297
                  Jpe         = <gn;Jpe_Exhaust>                                COGEN  298
                  ThermalReqt = <pe;LOAD>                                       COGEN  299
                CASE (2)  ! Jacket tracking                                     COGEN  300
                  Jpe         = <gn;Jpe_Jacket>                                 COGEN  301
                  ThermalReqt = <pe;LOAD>                                       COGEN  302
                CASE (3)  ! Track greater of exhaust or jacket                  COGEN  303
                  Jpe         = <gn;Jpe_Exhaust>                                COGEN  304
                  ThermalReqt = <pe;LOAD>                                       COGEN  305
                  Jpe         = <gn;Jpe_Jacket>                                 COGEN  306
                  ThermalReqt = MAX(ThermalReqt, <pe;LOAD>)                     COGEN  307
                CASE DEFAULT                                                    COGEN  308
                  ThermalReqt = 0.                                              COGEN  309
              END SELECT                                                        COGEN  310
              Jpe       = <em;CogenJpePtrs>                                     COGEN  311
              <pe;LOAD> = MAX(ElecReqt, ThermalReqt)                            COGEN  312
              IF (<pe;OPER_CAPACITY> .GT. 0.  .AND.                             PV     233
     &            <pe;LOAD>/<pe;OPER_CAPACITY> .GE. <gn:MIN-RATIO>) THEN        PV     234
                <em;CogenElecCap> =                                             COGEN  314
     &                             <em;CogenElecCap> + <pe;MAX_CAPACITY>        COGEN  315
              ELSE                                                              COGEN  316
                <pe;LOAD> = 0.                                                  COGEN  317
              ENDIF                                                             COGEN  318
            ENDDO                                                               COGEN  319
          CASE (5)  ! MaxOutput                                                 COGEN  320
            DO  IQ=1,Neq                                                        COGEN  321
              Jpe               = <em;CogenJpePtrs>                             COGEN  322
              <pe;LOAD>         = <pe;MAX_CAPACITY>                             COGEN  323
              <em;CogenElecCap> = <em;CogenElecCap> + <pe;MAX_CAPACITY>         COGEN  324
            ENDDO                                                               COGEN  325
        END SELECT  ! em;TrackMode                                              COGEN  326
      ENDDO  ! Nmeter                                                           COGEN  327
c                                                                               COGEN  328
c              Now that loads are reconciled, simulate all generators to        COGEN  329
c              get recovered heat                                               COGEN  330
      SimCtrl = 12                                                              COGEN  331
      DO  Neq=1,Ngn                                                             COGEN  332
        Jgn = Ign + (Neq-1)*Lgn                                                 COGEN  333
        CALL CogenerationEquip(1)                                               COGEN  334
c              increment exhaust heat recoverable to each loop                  COGEN  335
        Jpe = <gn;Jpe>                                                          COGEN  336
        IF (<pe;LOAD> .GT. 0.)  THEN                                            COGEN  337
          IF (<gn:EXH-LOOP> .GT. 0)  THEN                                       COGEN  338
            Jpe               = <gn;Jpe_Exhaust>                                COGEN  339
            Jlp               = <gn:EXH-LOOP>                                   COGEN  340
            <lp;CogenHtrec>   = <lp;CogenHtrec> + <pe;RECOVER_Q>                COGEN  341
          ENDIF                                                                 COGEN  342
c              same for jacket heat                                             COGEN  343
          IF (<gn:JAC-LOOP> .GT. 0  .AND.                                       COGEN  344
     &        <gn:JAC-LOOP> .NE. <gn:EXH-LOOP>)  THEN                           COGEN  345
            Jpe               = <gn;Jpe_Jacket>                                 COGEN  346
            Jlp               = <gn:JAC-LOOP>                                   COGEN  347
            <lp;CogenHtrec>   = <lp;CogenHtrec> + <pe;RECOVER_Q>                COGEN  348
          ENDIF                                                                 COGEN  349
        ENDIF                                                                   COGEN  350
      ENDDO                                                                     COGEN  351
c                                                                               COGEN  352
c              Adjust the recoverable amounts for the actual                    COGEN  353
c              amount required, and calculate the heat rejected                 COGEN  354
      SimCtrl = 14                                                              COGEN  355
      DO  Neq=1,Ngn                                                             COGEN  356
        Jgn = Ign + (Neq-1)*Lgn                                                 COGEN  357
        Jpe = <gn;Jpe>                                                          COGEN  358
        IF (<pe;LOAD> .GT. 0.)  CALL CogenerationEquip(1)                       COGEN  359
      ENDDO                                                                     COGEN  360
c                                                                               COGEN  361
c              Adjust the recovered amount in each loop, and calculate          COGEN  362
c              the waste                                                        COGEN  363
      QCogenWaste = 0.                                                          COGEN  364
      DO  NL=1,Nlp                                                              COGEN  365
        Jlp = Ilp + (NL-1)*Llp                                                  COGEN  366
        IF (<lp;CogenHtrec> .LT. 0.)  THEN                                      COGEN  367
          QLoopNet     = MIN(0., <lp;Q_NET>-<lp;Q_HTREC>)                       COGEN  368
          QwasteLoop   = MIN(0., <lp;CogenHtrec> - QLoopNet)                    COGEN  369
          QCogenWaste  = QCogenWaste  + QwasteLoop                              COGEN  370
        ENDIF                                                                   COGEN  371
      ENDDO                                                                     COGEN  372
c                                                                               COGEN  373
      END SELECT  ! Mode                                                        COGEN  374
c                                                                               COGEN  375
      SimCtrl = LastCtrl                                                        COGEN  376
c                                                                               COGEN  377
      RETURN                                                                    COGEN  378
      END                                                                       COGEN  379
        SUBROUTINE CogenerationEquip(Mode)                                      CogenEq  2
c                                                                               CogenEq  3
c              Selects the appropriate cogeneration algorithm                   CogenEq  4
c                                                                               CogenEq  5
c              Mode  1  Equipment component pointer was set                     CogenEq  6
c                    2  Jpe pointer was set                                     CogenEq  7
c                                                                               CogenEq  8
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               CogenEq 12
      IF (Mode .EQ. 1)  THEN                                                    CogenEq 13
        Jpe = <gn;Jpe>                                                          CogenEq 14
      ELSE                                                                      CogenEq 15
        Jgn = <pe;Jparent>                                                      CogenEq 16
      ENDIF                                                                     CogenEq 17
c                                                                               CogenEq 18
      SELECT CASE (<gn:ALGORITHM>)                                              CogenEq 19
        CASE (501)     ! Engine                                                 CogenEq 20
          CALL EngineGen1                                                       CogenEq 21
        CASE (502)     ! Gas turbine                                            CogenEq 22
          CALL GasTurbineGen1                                                   CogenEq 23
        CASE (503)     ! Steam turbine                                          CogenEq 24
          CALL SteamTurbineGen1                                                 CogenEq 25
        CASE (504)     ! Photovoltaic Array                                     PV     235
          CALL PV_Array                                                         PV     236
      END SELECT                                                                CogenEq 26
c                                                                               CogenEq 27
      RETURN                                                                    CogenEq 28
      END                                                                       CogenEq 29
      SUBROUTINE CogenSetThermalCap                                             GenST    2
c                                                                               GenST    3
c              Sets the thermal operating capacities of a                       GenST    4
c              meter's cogeneration equipment as a function                     GenST    5
c              of the electrical demand                                         GenST    6
c                                                                               GenST    7
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               GenST   11
c              number of cogen units serving this meter                         GenST   12
      Neq = <em;NumCogen>                                                       GenST   13
      DO  IQ=1,Neq                                                              GenST   14
        Jpe = <em;CogenJpePtrs>                                                 GenST   15
        Jgn = <pe;Jparent>                                                      GenST   16
c              capacity in exhaust gases - note that max_capacity               GenST   17
c              is a positive number for load allocation routines                GenST   18
        IF (<gn;Jpe_Exhaust> .GT. 0)  THEN                                      GenST   19
          Jpe = <gn;Jpe_Exhaust>                                                GenST   20
          <pe;MAX_CAPACITY> = -<pe;RECOVER_Q>                                   GenST   21
        ENDIF                                                                   GenST   22
c              capacity in jacket/lube heat                                     GenST   23
        IF (<gn;Jpe_Jacket> .GT. 0)  THEN                                       GenST   24
          Jpe = <gn;Jpe_Jacket>                                                 GenST   25
          <pe;MAX_CAPACITY> = -<pe;RECOVER_Q>                                   GenST   26
        ENDIF                                                                   GenST   27
      ENDDO                                                                     GenST   28
c                                                                               GenST   29
      RETURN                                                                    GenST   30
      END                                                                       GenST   31
      SUBROUTINE CogenZeroThermalCap                                            GenZT    2
c                                                                               GenZT    3
c              Zeros the thermal operating capacities of a                      GenZT    4
c              meter's cogeneration equipment                                   GenZT    5
c                                                                               GenZT    6
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               GenZT   10
c              number of cogen units serving this meter                         GenZT   11
      Neq = <em;NumCogen>                                                       GenZT   12
      DO  IQ=1,Neq                                                              GenZT   13
        Jpe = <em;CogenJpePtrs>                                                 GenZT   14
        Jgn = <pe;Jparent>                                                      GenZT   15
c              capacity in exhaust gases                                        GenZT   16
        IF (<gn;Jpe_Exhaust> .GT. 0)  THEN                                      GenZT   17
          Jpe = <gn;Jpe_Exhaust>                                                GenZT   18
          <pe;MAX_CAPACITY> = 0.                                                GenZT   19
        ENDIF                                                                   GenZT   20
c              capacity in jacket/lube heat                                     GenZT   21
        IF (<gn;Jpe_Jacket> .GT. 0)  THEN                                       GenZT   22
          Jpe = <gn;Jpe_Jacket>                                                 GenZT   23
          <pe;MAX_CAPACITY> = 0.                                                GenZT   24
        ENDIF                                                                   GenZT   25
      ENDDO                                                                     GenZT   26
c                                                                               GenZT   27
      RETURN                                                                    GenZT   28
      END                                                                       GenZT   29
      SUBROUTINE CogenLoopHtrec                                                 GenRcv   2
c                                                                               GenRcv   3
c              Calculates the heat that may be recovered from                   GenRcv   4
c              a meter's cogeneration equipment                                 GenRcv   5
c                                                                               GenRcv   6
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               GenRcv  10
c              number of cogen units serving this meter                         GenRcv  11
      Neq = <em;NumCogen>                                                       GenRcv  12
      DO  IQ=1,Neq                                                              GenRcv  13
        Jpe = <em;CogenJpePtrs>                                                 GenRcv  14
        Jgn = <pe;Jparent>                                                      GenRcv  15
c              capacity in exhaust gases                                        GenRcv  16
        IF (<gn:EXH-LOOP> .GT. 0)  THEN                                         GenRcv  17
          Jlp = <gn:EXH-LOOP>                                                   GenRcv  18
          Jpe = <gn;Jpe_Exhaust>                                                GenRcv  19
          <lp;CogenHtrec> = <lp;CogenHtrec> + <pe;RECOVER_Q>                    GenRcv  20
        ENDIF                                                                   GenRcv  21
c              capacity in jacket/lube heat                                     GenRcv  22
        IF (<gn:JAC-LOOP> .GT. 0  .AND.                                         GenRcv  23
     &      <gn:JAC-LOOP> .NE. <gn:EXH-LOOP>)  THEN                             GenRcv  24
          Jlp = <gn:JAC-LOOP>                                                   GenRcv  25
          Jpe = <gn;Jpe_Jacket>                                                 GenRcv  26
          <lp;CogenHtrec> = <lp;CogenHtrec> + <pe;RECOVER_Q>                    GenRcv  27
        ENDIF                                                                   GenRcv  28
      ENDDO                                                                     GenRcv  29
c                                                                               GenRcv  30
      RETURN                                                                    GenRcv  31
      END                                                                       GenRcv  32
      SUBROUTINE EngineGen1                                                     EngGen   2
c                                                                               EngGen   3
c              Simulates an engine-generator set                                EngGen   4
c                                                                               EngGen   5
c              SimCtrl   0  Attachment calculations                             EngGen   6
c                        1  Design calculations                                 EngGen   7
c                       11  Initialize operating capacities                     EngGen   8
c                       12  Simulate based on electric demand                   EngGen   9
c                       13  Simulate based on thermal demand,                   EngGen  10
c                             and calculate equivalent elec demand              EngGen  11
c                       14  Calculate recovered heat and heat-rejection         EngGen  12
c                                                                               EngGen  13
c              Performance characteristics developed by                         /ETO/    2
c                            Joe Eto                                            /ETO/    3
c                            Lawrence Berkeley National Laboratory              /ETO/    4
c                            University of California                           /ETO/    5
c                                                                               /ETO/    6
c              Adapted for DOE-2.2 BY                                           /ETO/    7
c                            S. D. Gates                                        /ETO/    8
c                            J. J. Hirsch                                       /ETO/    9
c                            James J. Hirsch & Associates                       /ETO/   10
c                            Camarillo, California                              /ETO/   11
c                                                                               /ETO/   12
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQUIPD/ EQload, EQrun, EQhgb, OperCap, Frac,                     /EQUIPD/ 2
     &                 PLR, EQsupplyT, Tcond,                                   Chlr1    1
     &                 EIRPLR, EIRFT, EQEIR, EQelec, EQfanKW, EQaux,            /EQUIPD/ 4
     &                 HIRPLR, HIRFT, EQHIR, EQfuel, EQcond, EQrecvr,           /EQUIPD/ 5
     &                 HWflow, HWhead, CHWflow, CHWhead, CWflow, CWhead,        /EQUIPD/ 6
     &                 HTRECflow,HTREChead, Qenvir, EQstart, EQloadH,           -041d    1
     &                 EQstartH, PLRh, FracH, EQfuelH, EQelecH                  /EQUIPD/ 8
      REAL             EQUIPDAT(36)                                             /EQUIPD/10
      EQUIVALENCE      (EQUIPDAT(1), EQload), (Tambient, Tcond)                 FreeCl   1
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PTRSYS/ nzone , iz    , nczd  , zp2 ,         mtw  ,             -045a    1
     $                 nsys  , is    , nss   , nsp ,  ns   , icode,             HR      11
     $                 nsz   , isz   , nzd   , zp1 ,  nz   ,                    HR      12
     $                 nspace, lpr   ,                                          HR      13
     $                 nattch, iatt  ,                                          HR      14
     $                 P2, IDAYHR, IDBWBT,                                      HR      15
     $                 IRPPLT, IRPSUM, IRPSYS, IRPZON, MR1, MR2                 HR      16
      INTEGER          ZP1, ZP2, P2                                             /PTRSYS/14
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               EngGen  25
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /GENKY / DontRun, TrackElec, TrackThermal, TrackLesser,           /GENKY/  2
     &                 TrackGreater, MaxOutput                                  /GENKY/  3
      INTEGER          DontRun, TrackElec, TrackThermal, TrackLesser,           /GENKY/  4
     &                 TrackGreater, MaxOutput                                  /GENKY/  5
c                                                                               EngGen  28
      REAL JacketCap, JacketMaxCap                                              EngGen  29
      DIMENSION PLRLim(2)                                                       EngGen  30
      DATA      PLRLim /1.5, 0./                                                EngGen  31
c                                                                               EngGen  32
c              zero hourly generator data                                       EngGen  33
      CALL FILLN(0., EQUIPDAT(1), IVTLIM(2,21))                                 EngGen  34
c                                                                               EngGen  35
c ****         run function : EngineGen1-1                                      EngGen  36
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        EngGen  37
c                                                                               EngGen  38
      SELECT CASE (SimCtrl)                                                     EngGen  39
c                                                                               EngGen  40
c                                                                               EngGen  41
c============= ATTACHMENTS ==================================================== EngGen  42
      CASE (0)                                                                  EngGen  43
c                                                                               EngGen  44
      CALL CreateJpe(Jgn, <gn:ALGORITHM>)                                       EngGen  45
      <gn;Jpe> = Jpe                                                            EngGen  46
c              exhaust heat recovery                                            EngGen  47
      IF (<gn:EXH-LOOP> .GT. 0)  THEN                                           EngGen  48
        CALL CreateJpe(Jgn, 0)                                                  EngGen  49
        <gn;Jpe_Exhaust> = Jpe                                                  EngGen  50
      ELSE                                                                      EngGen  51
c              loop thermal tracking flag can't be exhaust                      EngGen  52
        <gn:RCVR-TRACK-LP> = 2                                                  EngGen  53
      ENDIF                                                                     EngGen  54
c              jacket heat recovery                                             EngGen  55
      IF (<gn:JAC-LOOP> .GT. 0)  THEN                                           EngGen  56
        IF (<gn:JAC-LOOP> .NE. <gn:EXH-LOOP>)  THEN                             EngGen  57
          CALL CreateJpe(Jgn, 0)                                                EngGen  58
          <gn;Jpe_Jacket> = Jpe                                                 EngGen  59
        ENDIF                                                                   EngGen  60
      ELSE                                                                      EngGen  61
c              loop thermal tracking flag can't be jacket                       EngGen  62
        IF (<gn:EXH-LOOP> .GT. 0)  THEN                                         EngGen  63
          <gn:RCVR-TRACK-LP> = 1                                                EngGen  64
        ELSE                                                                    EngGen  65
          <gn:RCVR-TRACK-LP> = 0                                                EngGen  66
        ENDIF                                                                   EngGen  67
      ENDIF                                                                     EngGen  68
      IF (<gn:CW-LOOP> .GT. 0  .AND.  <gn;Jpe_Jacket> .EQ. 0)  THEN             EngGen  69
        CALL CreateJpe(Jgn, 0)                                                  EngGen  70
        <gn;Jpe_Jacket> = Jpe                                                   EngGen  71
      ENDIF                                                                     EngGen  72
c                                                                               EngGen  73
c              miscellaneous attachments                                        EngGen  74
      <gn:ELEC-METER>    = Jcomp(Iem, Lem, <gn:ELEC-METER>)                     EngGen  75
      <gn:SURPLUS-METER> = Jcomp(Iem, Lem, <gn:SURPLUS-METER>)                  EngGen  76
      <gn:AUX-METER>     = Jcomp(Iem, Lem, <gn:AUX-METER>)                      EngGen  77
      <gn:FUEL-METER>    = Jcomp(Ifm, Lfm, <gn:FUEL-METER>)                     EngGen  78
      <gn:EXH-LOOP>      = Jcomp(Ilp, Llp, <gn:EXH-LOOP>)                       EngGen  79
      <gn:JAC-LOOP>      = Jcomp(Ilp, Llp, <gn:JAC-LOOP>)                       EngGen  80
      <gn:CW-LOOP>       = Jcomp(Ilp, Llp, <gn:CW-LOOP>)                        EngGen  81
      <gn:COST-DATA>     = Jcomp(Imc, Lmc, <gn:COST-DATA>)                      EngGen  82
      <gn:CAP-FT>        = Jcurve(<gn:CAP-FT>)                                  -045b  197
      <gn:HIR-FT>        = Jcurve(<gn:HIR-FT>)                                  -045b  198
      <gn:HIR-FPLR>      = Jcurve(<gn:HIR-FPLR>)                                -045b  199
      <gn:EXH-RCVR-FPLR> = Jcurve(<gn:EXH-RCVR-FPLR>)                           -045b  200
      <gn:JAC-RCVR-FPLR> = Jcurve(<gn:JAC-RCVR-FPLR>)                           -045b  201
      <gn:AUX-SCH>       = JSCHED( <gn:AUX-SCH>)                                Time    95
c                                                                               EngGen 133
c                                                                               EngGen 134
c============= DESIGN CALCULATIONS ============================================ EngGen 135
      CASE (1)                                                                  EngGen 136
c                                                                               -047m    1
c              Combine the exhaust and jacket heat-recovery curves if           -047m    2
c              attached to the same loop                                        -047m    3
      IF (<gn:EXH-LOOP> .EQ. 0  .AND.  <gn:JAC-LOOP> .EQ. 0)  THEN              -047m    4
c              flag to indicate no heat recovery                                -047m    5
        <gn;RcvrMode> = 0                                                       -047m    6
      ELSEIF (<gn:EXH-LOOP> .NE. <gn:JAC-LOOP>)  THEN                           -047m    7
c              flag to indicate heat recovery to separate loops                 -047m    8
        <gn;RcvrMode> = 1                                                       -047m    9
      ELSE                                                                      -047m   10
c              heat recovery to a common loop                                   -047m   11
c              flag to indicate heat recovery to common loop                    -047m   12
        <gn;RcvrMode>      = 2                                                  -047m   13
c              force to track exhaust for use in routine Cogen                  -047m   14
        <gn:RCVR-TRACK-LP> = 1                                                  -047m   15
c              calc the pointer to the combined curve for use in CVAL           -047m   16
c              and CURINV                                                       -047m   17
        <gn;CommonRcvPtr> = NewBlockPtr(<+cv~Len>)                              -047m   18
        Jcv  = <gn;CommonRcvPtr>                                                -047m   19
        Jcv1 = <gn:EXH-RCVR-FPLR>                                               -047m   20
        Jcv2 = <gn:JAC-RCVR-FPLR>                                               -047m   21
c              set the type for the combined curve - note that the curve        -047m   22
c              can only be linear or quadratic                                  -047m   23
        <cv:TYPE> = Max(IA(Jcv1+<+cv:TYPE>),                                    -047m   24
     &                  IA(Jcv2+<+cv:TYPE>))                                    -047m   25
c              min and max                                                      -047m   26
        <cv:OUTPUT-MIN> = 0.0                                                   -047m   27
        <cv:OUTPUT-MAX> = 2.0                                                   -047m   28
c              combine coefficients                                             -047m   29
        DO  IC=1,3                                                              -047m   30
          AA(Jcv+<+cv:Coefficients>) =                                          -047m   31
     &                         AA(Jcv1+<+cv:Coefficients>)*<gn:EXH-RCVR>        -047m   32
     &                       + AA(Jcv2+<+cv:Coefficients>)*<gn:JAC-RCVR>        -047m   33
        ENDDO                                                                   -047m   34
      ENDIF                                                                     -047m   35
c                                                                               EngGen 137
c              Set up the start up loads                                        EngGen 138
      CALL StartUpLoad_Design(Jpe, <gn:CAP>, <gn:START-TIME>)                   EngGen 139
c                                                                               EngGen 140
      <pe;DES_KW>        = <gn:CAP>                                             EngGen 141
      <pe;DES_FUEL>      = <gn:CAP> * BTUKW * <gn:HIR>                          EngGen 142
      <pe;DES_RECOVER_Q> = -<pe;DES_FUEL> *(<gn:EXH-RCVR>+<gn:JAC-RCVR>)        EngGen 143
c              flow allocation not yet implemented                              EngGen 144
      <pe;DES_GPM> = 1.E6                                                       EngGen 145
      <pe;MAX_GPM> = 1.E6                                                       EngGen 146
c              condenser loop calcs                                             EngGen 147
      IF (<gn:CW-LOOP> .GT. 0)  THEN                                            EngGen 148
c              cw temp differential and flow                                    EngGen 149
        Jlp        = <gn:CW-LOOP>                                               EngGen 150
        JacketCap  = <pe;DES_FUEL> * <gn:JAC-RCVR>                              EngGen 151
        <gn:CW-DT> = ABS(<gn:CW-DT>)                                            EngGen 152
        GPM        = JacketCap / (<lp;BTUH/GPM-F>*<gn:CW-DT>)                   EngGen 153
c              pass cw load, flow, and head onto cw or wlhp loop                EngGen 154
        <lp;COIL_COOL>  = <lp;COIL_COOL> + JacketCap                            EngGen 155
        <lp;GPM>        = <lp;GPM>       + GPM                                  EngGen 156
        <gn;DES_CW_GPM> = GPM                                                   EngGen 157
c              no attached pump - primary loop must absorb head                 EngGen 158
        <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                            EngGen 159
     &                           <gn:CW-HEAD>)                                  EngGen 160
      ENDIF                                                                     EngGen 161
c                                                                               EngGen 162
c ****         run function : EngineGen1-2                                      EngGen 163
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        EngGen 164
c                                                                               EngGen 165
c                                                                               EngGen 166
c============= CALCULATE OPERATING CAPACITIES ================================= EngGen 167
      CASE (11)                                                                 EngGen 168
c                                                                               EngGen 169
c              Calculate electric capacity as a function of ambient             EngGen 170
c              temperature and wetbulb                                          EngGen 171
      OperCapElec = <gn:CAP> * CVAL(<gn:CAP-FT>,DBT,WBT)                        EngGen 172
      <pe;OPER_CAPACITY> = OperCapElec                                          EngGen 173
c              maximum output - adjust by warmup time                           EngGen 174
      <pe;MAX_CAPACITY> = OperCapElec * <gn:MAX-RATIO>                          EngGen 175
     &                  - StartUpLoad(Jpe)                                      -044c4 406
c                                                                               EngGen 177
c              Calculate exhaust capacity corresponding to electrical           EngGen 178
      IF (<gn:EXH-LOOP> .GT. 0)  THEN                                           EngGen 179
        Jpe = <gn;Jpe_Exhaust>                                                  EngGen 180
        <pe;OPER_CAPACITY> = OperCapElec *BTUKW *<gn:HIR> *<gn:EXH-RCVR>        EngGen 181
        <pe;MAX_CAPACITY>  = <pe;OPER_CAPACITY>                                 EngGen 182
     &                     * CVAL(<gn:EXH-RCVR-FPLR>,<gn:MAX-RATIO>,1.)         EngGen 183
      ENDIF                                                                     EngGen 184
c                                                                               EngGen 185
c              Calculate jacket capacity corresponding to electrical            EngGen 186
      IF (<gn:JAC-LOOP> .GT. 0)  THEN                                           EngGen 187
        JacketCap    = OperCapElec * BTUKW * <gn:HIR> * <gn:JAC-RCVR>           EngGen 188
        JacketMaxCap = JacketCap                                                EngGen 189
     &                      * CVAL(<gn:JAC-RCVR-FPLR>,<gn:MAX-RATIO>,1.)        EngGen 190
        IF (<gn:JAC-LOOP> .NE. <gn:EXH-LOOP>)  THEN                             EngGen 191
          Jpe = <gn;Jpe_Jacket>                                                 EngGen 192
          <pe;OPER_CAPACITY> = JacketCap                                        EngGen 193
          <pe;MAX_CAPACITY>  = JacketMaxCap                                     EngGen 194
        ELSE                                                                    EngGen 195
          <pe;OPER_CAPACITY> = <pe;OPER_CAPACITY> + JacketCap                   EngGen 196
          <pe;MAX_CAPACITY>  = <pe;MAX_CAPACITY>  + JacketMaxCap                EngGen 197
        ENDIF                                                                   EngGen 198
      ENDIF                                                                     EngGen 199
c                                                                               EngGen 200
c ****         run function : EngineGen1-3                                      EngGen 201
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        EngGen 202
c                                                                               EngGen 203
      RETURN                                                                    EngGen 204
c                                                                               EngGen 205
c                                                                               EngGen 206
c============= SIMULATE ELECTRIC TRACKING ===================================== EngGen 207
      CASE(12)                                                                  EngGen 208
c                                                                               EngGen 209
      JpeSave = Jpe                                                             EngGen 210
c              hourly load and operating capacity                               EngGen 211
      EQload  = <pe;LOAD>                                                       EngGen 212
      OperCap = <pe;OPER_CAPACITY>                                              EngGen 213
c                                                                               EngGen 214
c ****         run function : EngineGen1-4                                      EngGen 215
                                                                                EngGen 216
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        EngGen 217
c                                                                               EngGen 218
c              skip if no load                                                  EngGen 219
      IF (EQload .EQ. 0.)  GOTO 1000                                            EngGen 220
c              part load ratio - don't run if below min                         EngGen 221
      PLR    = EQload / OperCap                                                 EngGen 222
      IF (PLR .LT. <gn:MIN-RATIO>*.999)  THEN                                   EngGen 223
        <pe;LOAD> = 0.                                                          EngGen 224
        EQload    = 0.                                                          EngGen 225
        GOTO 1000                                                               EngGen 226
      ENDIF                                                                     EngGen 227
c                                                                               EngGen 228
c              adjust load for warm-up time and recalculate part                EngGen 229
c              load ratio                                                       EngGen 230
      EQstart = StartUpLoad(Jpe)                                                -044c4 407
      EQload  = EQload + EQstart                                                EngGen 232
      PLR     = EQload / OperCap                                                EngGen 233
c                                                                               EngGen 234
c              fraction of the hour the equipment runs                          EngGen 235
      Frac   = 1.0                                                              EngGen 236
c              fuel input ratio as a function of temperature                    EngGen 237
      HIRFT  = CVAL(<gn:HIR-FT>,EDB,EWB)                                        EngGen 238
c              fuel input ratio as a function of part load                      EngGen 239
      HIRPLR = CVAL(<gn:HIR-FPLR>,PLR,PLR)                                      EngGen 240
c              fuel input ratio                                                 EngGen 241
      EQHIR  = <gn:HIR> * HIRFT * HIRPLR                                        EngGen 242
c              fuel consumption                                                 EngGen 243
      EQfuel = OperCap * BTUKW * EQHIR                                          EngGen 244
c                                                                               EngGen 245
c              Recoverable heat at this part load ratio                         EngGen 246
c              exhaust                                                          EngGen 247
      IF (<gn:EXH-LOOP> .GT. 0)  THEN                                           EngGen 248
        EQexh   = -OperCap * BTUKW * <gn:HIR> * <gn:EXH-RCVR>                   EngGen 249
     &                             * CVAL(<gn:EXH-RCVR-FPLR>,PLR,PLR)           EngGen 250
        EQrecvr = EQexh                                                         EngGen 251
        Jpe     = <gn;Jpe_Exhaust>                                              EngGen 252
        <pe;RECOVER_Q> = EQexh                                                  EngGen 253
      ENDIF                                                                     EngGen 254
c              jacket                                                           EngGen 255
      IF (<gn:JAC-LOOP> .GT. 0  .OR.  <gn:CW-LOOP> .GT. 0)  THEN                EngGen 256
        EQjac   = -OperCap * BTUKW * <gn:HIR> * <gn:JAC-RCVR>                   EngGen 257
     &                             * CVAL(<gn:JAC-RCVR-FPLR>,PLR,PLR)           EngGen 258
        IF (<gn:JAC-LOOP> .GT. 0)  EQrecvr = EQrecvr + EQjac                    EngGen 259
        IF (<gn;RcvrMode> .NE. 2)  THEN                                         EngGen 260
c              jacket loop is separate from exhaust                             EngGen 261
          Jpe = <gn;Jpe_Jacket>                                                 EngGen 262
          <pe;RECOVER_Q> = EQjac                                                EngGen 263
        ELSE                                                                    EngGen 264
c              jacket and exhaust loops are the same                            EngGen 265
          <pe;RECOVER_Q> = EQrecvr                                              EngGen 266
        ENDIF                                                                   EngGen 267
c              store potential heat-rejection for CW calcs                      EngGen 268
        IF (<gn:CW-LOOP> .GT. 0)  THEN                                          EngGen 269
          Jpe = <gn;Jpe_Jacket>                                                 EngGen 270
          <pe;RECOVER_Q> = EQjac                                                EngGen 271
        ENDIF                                                                   EngGen 272
      ENDIF                                                                     EngGen 273
      Jpe = JpeSave                                                             EngGen 274
c                                                                               EngGen 275
c              separate out start-up load                                       EngGen 276
      EQload = EQload - EQstart                                                 EngGen 277
c                                                                               EngGen 278
c              Auxiliary power                                                  EngGen 279
 1000 IF (<gn:AUX-KW> .GT. 0.)  THEN                                            EngGen 280
c              if always on                                                     EngGen 281
        IF (<gn:AUX-MODE> .EQ. Always)  THEN                                    EngGen 282
          EQaux = <gn:AUX-KW>                                                   EngGen 283
        ELSEIF (<gn:AUX-MODE> .EQ. WhenOn)  THEN                                EngGen 284
          EQaux = <gn:AUX-KW> * Frac                                            EngGen 285
        ELSEIF (<gn:AUX-MODE> .EQ. WhenOff)  THEN                               EngGen 286
          EQaux = <gn:AUX-KW> * (1.0 - Frac)                                    EngGen 287
        ELSE                                                                    Time    96
          EQaux = <gn:AUX-KW> * SchVal(<gn:AUX-SCH>, 1.)                        Time    97
        ENDIF                                                                   EngGen 290
      ENDIF                                                                     EngGen 291
c                                                                               EngGen 292
c ****         run function : EngineGen1-5                                      EngGen 293
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        EngGen 294
c                                                                               EngGen 295
c              report variables                                                 EngGen 296
      <pe;AUX_KW>    = EQaux                                                    EngGen 297
      <pe;FUEL>      = EQfuel                                                   EngGen 298
      <pe;RECOVER_Q> = EQrecvr                                                  EngGen 299
c                                                                               EngGen 300
c              hourly-report variables                                          EngGen 301
      IF (<gn;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                                EngGen 302
     &  CALL HourRepPLT(EQUIPDAT(1), <gn;HREP>, 21, 0)                          EngGen 303
c                                                                               EngGen 304
c                                                                               EngGen 305
c============= SIMULATE THERMAL TRACKING ====================================== EngGen 306
      CASE(13)                                                                  EngGen 307
c                                                                               EngGen 308
c              electric operating capacity                                      EngGen 309
      OperCapElec = <pe;OPER_CAPACITY>                                          EngGen 310
c                                                                               EngGen 311
      SELECT CASE (<gn;RcvrMode>)                                               EngGen 312
        CASE (0)  ! no heat recovery                                            EngGen 313
          RETURN                                                                EngGen 314
        CASE (1)  ! heat recovery to separate loops                             EngGen 315
c              exhaust                                                          EngGen 316
          IF (<gn:EXH-LOOP> .GT. 0)  THEN                                       EngGen 317
            Jpe         = <gn;Jpe_Exhaust>                                      EngGen 318
            EQrecvr     = -<pe;LOAD>                                            EngGen 319
            OperCapRcvr = -<pe;OPER_CAPACITY>                                   EngGen 320
c              skip if no load                                                  EngGen 321
            IF (EQrecvr .LT. -1.)  THEN                                         EngGen 322
c              heat recoverable at minimum part load ratio                      EngGen 323
              QRecvrMin = OperCapRcvr                                           EngGen 324
     &                  * CVAL(<gn:EXH-RCVR-FPLR>,<gn:MIN-RATIO>,1.)            EngGen 325
              IF (EQrecvr .LT. QRecvrMin)  THEN                                 EngGen 326
c                 Engine can track the thermal load.  Calculate the             EngGen 327
c                 elec PLR corresponding to EQrecvr                             EngGen 328
                PLRrcvr = EQrecvr / OperCapRcvr                                 EngGen 329
c                   pointer to Recvr = f(PLR) curve                             EngGen 330
                Jcv = <gn:EXH-RCVR-FPLR>                                        -045b  219
                CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 1,PLR,Y,PLRrcvr,             -045b  220
     &                                                  PLRLim(1), IERR)        -045b  221
              ELSE                                                              EngGen 334
c                 load is less than minimum that can be tracked                 EngGen 335
                PLR = <gn:MIN-RATIO>                                            EngGen 336
              ENDIF                                                             EngGen 337
c                 Corresponding electrical load.  Note that this load           EngGen 338
c                 is stored in the exhaust Jpe block                            EngGen 339
              <pe;LOAD> = OperCapElec * PLR                                     EngGen 340
            ENDIF                                                               EngGen 341
          ENDIF  ! Exhaust                                                      EngGen 342
c              jacket                                                           EngGen 343
          IF (<gn:JAC-LOOP> .GT. 0)  THEN                                       EngGen 344
            Jpe         = <gn;Jpe_Jacket>                                       EngGen 345
            EQrecvr     = -<pe;LOAD>                                            EngGen 346
            OperCapRcvr = -<pe;OPER_CAPACITY>                                   EngGen 347
c              skip if no load                                                  EngGen 348
            IF (EQrecvr .LT. -1.)  THEN                                         EngGen 349
c              heat recoverable at minimum part load ratio                      EngGen 350
              QRecvrMin = OperCapRcvr                                           EngGen 351
     &                  * CVAL(<gn:JAC-RCVR-FPLR>,<gn:MIN-RATIO>,1.)            EngGen 352
              IF (EQrecvr .LT. QRecvrMin)  THEN                                 EngGen 353
c                 Engine can track the thermal load.  Calculate the             EngGen 354
c                 elec PLR corresponding to EQrecvr                             EngGen 355
                PLRrcvr = EQrecvr / OperCapRcvr                                 EngGen 356
c                   pointer to Recvr = f(PLR) curve                             EngGen 357
                Jcv = <gn:JAC-RCVR-FPLR>                                        -045b  222
                CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 1,PLR,Y,PLRrcvr,             -045b  223
     &                                                  PLRLim(1), IERR)        -045b  224
              ELSE                                                              EngGen 361
c                 load is less than minimum that can be tracked                 EngGen 362
                PLR = <gn:MIN-RATIO>                                            EngGen 363
              ENDIF                                                             EngGen 364
c                 Corresponding electrical load.  Note that this load           EngGen 365
c                 is stored in the jacket Jpe block                             EngGen 366
              <pe;LOAD> = OperCapElec * PLR                                     EngGen 367
            ENDIF                                                               EngGen 368
          ENDIF  ! Jacket                                                       EngGen 369
        CASE (2)  ! Exhaust and jacket heat recovery to same loop               EngGen 370
          Jpe         = <gn;Jpe_Exhaust>                                        EngGen 371
          EQrecvr     = -<pe;LOAD>                                              EngGen 372
          OperCapRcvr = -<pe;OPER_CAPACITY>                                     EngGen 373
c              skip if no load                                                  EngGen 374
          IF (EQrecvr .LT. -1.)  THEN                                           EngGen 375
c              heat recoverable at minimum part load ratio                      EngGen 376
            QRecvrMin = -OperCapElec * BTUKW * <gn:HIR>                         EngGen 377
     &                * CVAL(<gn;CommonRcvPtr>,<gn:MIN-RATIO>,1.)               EngGen 378
              IF (EQrecvr .LT. QRecvrMin)  THEN                                 EngGen 379
c                 Engine can track the thermal load.  Calculate the             EngGen 380
c                 elec PLR corresponding to EQrecvr                             EngGen 381
                PLRrcvr = EQrecvr / (-OperCapElec * BTUKW * <gn:HIR>)           EngGen 382
c                   pointer to Recvr = f(PLR) curve                             EngGen 383
                Jcv = <gn;CommonRcvPtr>                                         -045b  225
                CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 1,PLR,Y,PLRrcvr,             -045b  226
     &                                                  PLRLim(1), IERR)        -045b  227
              ELSE                                                              EngGen 387
c                 load is less than minimum that can be tracked                 EngGen 388
                PLR = <gn:MIN-RATIO>                                            EngGen 389
              ENDIF                                                             EngGen 390
c                 Corresponding electrical load.  Note that this load           EngGen 391
c                 is stored in the exhaust Jpe block                            EngGen 392
              <pe;LOAD> = OperCapElec * PLR                                     EngGen 393
            ENDIF                                                               EngGen 394
      END SELECT  ! gn;RcvrMode                                                 EngGen 395
c                                                                               EngGen 396
c ****         run function : EngineGen1-6                                      EngGen 397
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        EngGen 398
c                                                                               EngGen 399
c                                                                               EngGen 400
c============= CALCULATE RECOVERED HEAT AND HEAT REJECTION ==================== EngGen 401
      CASE(14)                                                                  EngGen 402
c                                                                               EngGen 403
      SELECT CASE (<gn;RcvrMode>)                                               EngGen 404
        CASE (0)  ! no heat recovery                                            EngGen 405
          IF (<gn:CW-LOOP> .GT. 0)  THEN                                        EngGen 406
            Jpe    = <gn;Jpe_Jacket>                                            EngGen 407
            EQcond = -<pe;RECOVER_Q>                                            EngGen 408
          ENDIF                                                                 EngGen 409
        CASE (1)  ! heat recovery to separate loops                             EngGen 410
c              recovered exhaust                                                EngGen 411
          IF (<gn;Jpe_Exhaust> .GT. 0)  THEN                                    EngGen 412
            Jpe = <gn;Jpe_Exhaust>                                              EngGen 413
            Jlp = <gn:EXH-LOOP>                                                 EngGen 414
            IF (<lp;CogenHtrec> .LT. (<lp;Q_NET>-<lp;Q_HTREC>))  THEN           EngGen 415
              Prorate        = (<lp;Q_NET>-<lp;Q_HTREC>)/<lp;CogenHtrec>        EngGen 416
              Qadjust        = <pe;RECOVER_Q> * (1.-Prorate)                    EngGen 417
              <pe;RECOVER_Q> = <pe;RECOVER_Q> - Qadjust                         EngGen 418
              Jpe            = <gn;Jpe>                                         EngGen 419
              <pe;RECOVER_Q> = <pe;RECOVER_Q> - Qadjust                         EngGen 420
              EQrecvr        = <pe;RECOVER_Q>                                   EngGen 421
            ELSE                                                                EngGen 422
              Jpe     = <gn;Jpe_Exhaust>                                        EngGen 423
              EQrecvr = <pe;RECOVER_Q>                                          EngGen 424
            ENDIF                                                               EngGen 425
          ENDIF                                                                 EngGen 426
c              recovered jacket                                                 EngGen 427
          IF (<gn;Jpe_Jacket> .GT. 0)  THEN                                     EngGen 428
            Jpe      = <gn;Jpe_Jacket>                                          EngGen 429
            Jlp      = <gn:JAC-LOOP>                                            EngGen 430
            QLoopNet = MIN(0., <lp;Q_NET>-<lp;Q_HTREC>)                         EngGen 431
            IF (<lp;CogenHtrec> .LT. (<lp;Q_NET>-<lp;Q_HTREC>))  THEN           EngGen 432
              Prorate        = (<lp;Q_NET>-<lp;Q_HTREC>)/<lp;CogenHtrec>        EngGen 433
              Qadjust        = <pe;RECOVER_Q> * (1.-Prorate)                    EngGen 434
              <pe;RECOVER_Q> = <pe;RECOVER_Q> - Qadjust                         EngGen 435
              Jpe            = <gn;Jpe>                                         EngGen 436
              <pe;RECOVER_Q> = <pe;RECOVER_Q> - Qadjust                         EngGen 437
              EQrecvr        = <pe;RECOVER_Q>                                   EngGen 438
              EQcond         = -Qadjust                                         EngGen 439
            ELSE                                                                EngGen 440
              Jpe     = <gn;Jpe_Jacket>                                         EngGen 441
              EQrecvr = EQrecvr + <pe;RECOVER_Q>                                EngGen 442
            ENDIF                                                               EngGen 443
          ENDIF                                                                 EngGen 444
        CASE (2)  ! Exhaust and jacket heat recovery to same loop               EngGen 445
          Jpe = <gn;Jpe_Exhaust>                                                EngGen 446
          Jlp = <gn:EXH-LOOP>                                                   EngGen 447
          IF (<lp;CogenHtrec> .LT. (<lp;Q_NET>-<lp;Q_HTREC>))  THEN             EngGen 448
            Prorate        = (<lp;Q_NET>-<lp;Q_HTREC>) / <lp;CogenHtrec>        EngGen 449
            Qadjust        = <pe;RECOVER_Q> * (1.-Prorate)                      EngGen 450
            <pe;RECOVER_Q> = <pe;RECOVER_Q> - Qadjust                           EngGen 451
            Jpe            = <gn;Jpe>                                           EngGen 452
            <pe;RECOVER_Q> = <pe;RECOVER_Q> - Qadjust                           EngGen 453
            IF (<gn:CW-LOOP> .GT. 0)  THEN                                      EngGen 454
c               favor use of condenser heat over exhaust heat to                EngGen 455
c               minimize condenser loop load                                    EngGen 456
              EQrecvr = <pe;RECOVER_Q>                                          EngGen 457
              Jpe     = <gn;Jpe_Jacket>                                         EngGen 458
              EQcond  = MAX(0., EQrecvr-<pe;RECOVER_Q>)                         EngGen 459
            ENDIF                                                               EngGen 460
          ENDIF                                                                 EngGen 461
      END SELECT                                                                EngGen 462
c                                                                               EngGen 463
c              heat rejected                                                    EngGen 464
      IF (<gn:CW-LOOP> .GT. 0)  THEN                                            EngGen 465
        Jlp = <gn:CW-LOOP>                                                      EngGen 466
        <lp;CogenQ> = <lp;CogenQ> + EQcond                                      EngGen 467
c              condenser flow & head                                            EngGen 468
        IF (<gn:CW-CTRL> .EQ. ConstantFlow)  THEN                               EngGen 469
c              constant flow                                                    EngGen 470
          CWflow = <gn;DES_CW_GPM>                                              EngGen 471
          CWhead = <gn:CW-HEAD>                                                 EngGen 472
        ELSE                                                                    EngGen 473
c              variable flow                                                    EngGen 474
          CWflow  = EQcond / (<lp;BTUH/GPM-F>*<gn:CW-DT>)                       EngGen 475
          PLRflow = CWflow / <gn;DES_CW_GPM>                                    EngGen 476
          CWhead  = <gn:CW-HEAD> * PLRflow**1.8                                 EngGen 477
        ENDIF                                                                   EngGen 478
c              pass condenser flow and head onto condenser loop                 EngGen 479
        <lp;CogenGPM>      = <lp;CogenGPM> + CWflow                             EngGen 480
        <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>, CWhead)                    EngGen 481
      ENDIF                                                                     EngGen 482
c                                                                               EngGen 483
c ****         run function : EngineGen1-7                                      EngGen 484
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        EngGen 485
c                                                                               EngGen 486
c              hourly-report variables                                          EngGen 487
      IF (<gn;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                                EngGen 488
     &  CALL HourRepPLT(EQUIPDAT(1), <gn;HREP>, 21, 1)                          EngGen 489
c                                                                               EngGen 490
c                                                                               EngGen 491
      END SELECT  ! SimCtrl                                                     EngGen 492
      Jpe = <gn;Jpe>                                                            EngGen 493
c                                                                               EngGen 494
      RETURN                                                                    EngGen 495
      END                                                                       EngGen 496
      SUBROUTINE EstimateElec                                                   EstElec  2
c                                                                               EstElec  3
c              Estimates the electrical loads on all meters                     EstElec  4
c              Called by Cogen                                                  EstElec  5
c                                                                               EstElec  6
c                                                                               EstElec  7
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
c                                                                               EstElec 11
      COMMON  /EMKY  / UtilityMeter, BldgMeter, SubMeter, SellMeter,            /EMKY/   2
     &                 NumElecMeterTypes(4)                                     /EMKY/   3
      INTEGER          UtilityMeter, BldgMeter, SubMeter, SellMeter             /EMKY/   4
c                                                                               EstElec 13
c              Loop thru all meters and get electric end-uses passed            EstElec 14
c              from Loads/Systems modules, and cogeneration carryover           EstElec 15
c              from previous hour                                               EstElec 16
      DO  Nmeter=1,Nem                                                          EstElec 17
        Jem = Iem + (Nmeter-1)*Lem                                              EstElec 18
        EstimatedKW = <em;CogenCarry>                                           EstElec 19
        DO  IE=1,18                                                             EstElec 20
          EstimatedKW = EstimatedKW + <em;METERS>                               EstElec 21
        ENDDO                                                                   EstElec 22
        <em;EstimatedLast> = <em;EstimatedKW>                                   EstElec 23
        <em;EstimatedKW>   = EstimatedKW                                        EstElec 24
      ENDDO                                                                     EstElec 25
c                                                                               EstElec 26
c              Get electric loads from plant equipment not yet summed           EstElec 27
c              into end-use categories                                          EstElec 28
c              Circulation-loops                                                EstElec 29
      DO  Neq=1,Nlp                                                             EstElec 30
        Jlp = Ilp + (Neq-1)*Llp                                                 EstElec 31
        IF (<lp:AUX-METER> .GT. 0)  THEN                                        EstElec 32
          Jem = <lp:AUX-METER>                                                  EstElec 33
          <em;EstimatedKW> = <em;EstimatedKW> + <lp;AUX_KW>                     EstElec 34
        ENDIF                                                                   EstElec 35
      ENDDO                                                                     EstElec 36
c              pumps                                                            EstElec 37
      DO  Neq=1,Npm                                                             EstElec 38
        Jpm = Ipm + (Neq-1)*Lpm                                                 EstElec 39
        IF (<pm:ELEC-METER> .GT. 0)  THEN                                       EstElec 40
          Jem = <pm:ELEC-METER>                                                 EstElec 41
          <em;EstimatedKW> = <em;EstimatedKW> + <pm;KW>                         EstElec 42
        ENDIF                                                                   EstElec 43
      ENDDO                                                                     EstElec 44
c              boilers                                                          EstElec 45
      DO  Neq=1,Nbl                                                             EstElec 46
        Jbl = Ibl + (Neq-1)*Lbl                                                 EstElec 47
        Jpe = <bl;Jpe>                                                          EstElec 48
        IF (<bl:ELEC-METER> .GT. 0)  THEN                                       EstElec 49
          Jem = <bl:ELEC-METER>                                                 EstElec 50
          <em;EstimatedKW> = <em;EstimatedKW> + <pe;KW>                         EstElec 51
        ENDIF                                                                   EstElec 52
        IF (<bl:AUX-METER>  .GT. 0)  THEN                                       EstElec 53
          Jem = <bl:AUX-METER>                                                  EstElec 54
          <em;EstimatedKW> = <em;EstimatedKW> + <pe;AUX_KW>                     EstElec 55
        ENDIF                                                                   EstElec 56
      ENDDO                                                                     EstElec 57
c              chillers                                                         EstElec 58
      DO  Neq=1,Nch                                                             EstElec 59
        Jch = Ich + (Neq-1)*Lch                                                 EstElec 60
        IF (<ch:ELEC-METER> .GT. 0)  THEN                                       EstElec 61
          Jem = <ch:ELEC-METER>                                                 EstElec 62
          <em;EstimatedKW> = <em;EstimatedKW> + <ch;KW>                         EstElec 63
        ENDIF                                                                   EstElec 64
        IF (<ch:AUX-METER>  .GT. 0)  THEN                                       EstElec 65
          Jem = <ch:AUX-METER>                                                  EstElec 66
          <em;EstimatedKW> = <em;EstimatedKW> + <ch;AUX>                        EstElec 67
        ENDIF                                                                   EstElec 68
      ENDDO                                                                     EstElec 69
c              dw heaters                                                       EstElec 70
      DO  Neq=1,Ndw                                                             EstElec 71
        Jdw = Idw + (Neq-1)*Ldw                                                 EstElec 72
        IF (<dw:ELEC-METER> .GT. 0)  THEN                                       EstElec 73
          Jem = <dw:ELEC-METER>                                                 EstElec 74
          <em;EstimatedKW> = <em;EstimatedKW> + <dw;KW>                         EstElec 75
        ENDIF                                                                   EstElec 76
        IF (<dw:AUX-METER>  .GT. 0)  THEN                                       EstElec 77
          Jem = <dw:AUX-METER>                                                  EstElec 78
          <em;EstimatedKW> = <em;EstimatedKW> + <dw;AUX>                        EstElec 79
        ENDIF                                                                   EstElec 80
      ENDDO                                                                     EstElec 81
c              heat rejection                                                   EstElec 82
      DO  Neq=1,Ntw                                                             EstElec 83
        Jtw = Itw + (Neq-1)*Ltw                                                 EstElec 84
        IF (<tw:ELEC-METER> .GT. 0)  THEN                                       EstElec 85
          Jem = <tw:ELEC-METER>                                                 EstElec 86
          <em;EstimatedKW> = <em;EstimatedKW> + <tw;KW>                         EstElec 87
        ENDIF                                                                   EstElec 88
        IF (<tw:AUX-METER>  .GT. 0)  THEN                                       EstElec 89
          Jem = <tw:AUX-METER>                                                  EstElec 90
          <em;EstimatedKW> = <em;EstimatedKW> + <tw;AUX>                        EstElec 91
        ENDIF                                                                   EstElec 92
      ENDDO                                                                     EstElec 93
c              generators                                                       EstElec 94
      DO  Neq=1,Ngn                                                             EstElec 95
        Jgn = Ign + (Neq-1)*Lgn                                                 EstElec 96
        Jpe = <gn;Jpe>                                                          EstElec 97
        IF (<gn:AUX-METER>  .GT. 0)  THEN                                       EstElec 98
          Jem = <gn:AUX-METER>                                                  EstElec 99
          <em;EstimatedKW> = <em;EstimatedKW> + <pe;AUX_KW>                     EstElec100
        ENDIF                                                                   EstElec101
      ENDDO                                                                     EstElec102
c              thermal storage                                                  EstElec103
      DO  Neq=1,Ntk                                                             EstElec104
        Jtk = Itk + (Neq-1)*Ltk                                                 EstElec105
        IF (<tk:AUX-METER>  .GT. 0)  THEN                                       EstElec106
          Jem = <tk:AUX-METER>                                                  EstElec107
          <em;EstimatedKW> = <em;EstimatedKW> + <tk;AUX>                        EstElec108
        ENDIF                                                                   EstElec109
      ENDDO                                                                     EstElec110
c                                                                               EstElec111
c              Get transformer losses, and include building/submeters           EstElec112
c              in their parent                                                  EstElec113
      DO  MeterType=3,1,-1                                                      EstElec114
        IF (NumElecMeterTypes(MeterType) .GT. 0)  THEN                          EstElec115
          DO  Nmeter=1,Nem                                                      EstElec116
            Jem = Iem + (Nmeter-1)*Lem                                          EstElec117
            IF (<em:TYPE> .EQ. MeterType)  THEN                                 EstElec118
              EstimatedKW = <em;EstimatedKW>                                    EstElec119
              EstimatedKW = EstimatedKW + Transformer_Loss(EstimatedKW)         EstElec120
              <em;EstimatedKW> = EstimatedKW                                    EstElec121
              IF (<em;PARENT> .NE. 0)  THEN                                     EstElec122
                Jem = <em;PARENT>                                               EstElec123
                <em;EstimatedKW> = <em;EstimatedKW> + EstimatedKW               EstElec124
              ENDIF                                                             EstElec125
            ENDIF                                                               EstElec126
          ENDDO                                                                 EstElec127
        ENDIF                                                                   EstElec128
      ENDDO                                                                     EstElec129
c                                                                               EstElec130
      RETURN                                                                    EstElec131
      END                                                                       EstElec132
      SUBROUTINE GasTurbineGen1                                                 GasTur   2
c                                                                               GasTur   3
c              Simulates a gas-turbine generator set                            GasTur   4
c                                                                               GasTur   5
c              SimCtrl   0  Attachment calculations                             GasTur   6
c                        1  Design calculations                                 GasTur   7
c                       11  Initialize operating capacities                     GasTur   8
c                       12  Simulate based on electric demand                   GasTur   9
c                       13  Simulate based on thermal demand,                   GasTur  10
c                             and calculate equivalent elec demand              GasTur  11
c                       14  Calculate recovered heat                            GasTur  12
c                                                                               GasTur  13
c              Performance characteristics developed by                         /ETO/    2
c                            Joe Eto                                            /ETO/    3
c                            Lawrence Berkeley National Laboratory              /ETO/    4
c                            University of California                           /ETO/    5
c                                                                               /ETO/    6
c              Adapted for DOE-2.2 BY                                           /ETO/    7
c                            S. D. Gates                                        /ETO/    8
c                            J. J. Hirsch                                       /ETO/    9
c                            James J. Hirsch & Associates                       /ETO/   10
c                            Camarillo, California                              /ETO/   11
c                                                                               /ETO/   12
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQUIPD/ EQload, EQrun, EQhgb, OperCap, Frac,                     /EQUIPD/ 2
     &                 PLR, EQsupplyT, Tcond,                                   Chlr1    1
     &                 EIRPLR, EIRFT, EQEIR, EQelec, EQfanKW, EQaux,            /EQUIPD/ 4
     &                 HIRPLR, HIRFT, EQHIR, EQfuel, EQcond, EQrecvr,           /EQUIPD/ 5
     &                 HWflow, HWhead, CHWflow, CHWhead, CWflow, CWhead,        /EQUIPD/ 6
     &                 HTRECflow,HTREChead, Qenvir, EQstart, EQloadH,           -041d    1
     &                 EQstartH, PLRh, FracH, EQfuelH, EQelecH                  /EQUIPD/ 8
      REAL             EQUIPDAT(36)                                             /EQUIPD/10
      EQUIVALENCE      (EQUIPDAT(1), EQload), (Tambient, Tcond)                 FreeCl   1
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PTRSYS/ nzone , iz    , nczd  , zp2 ,         mtw  ,             -045a    1
     $                 nsys  , is    , nss   , nsp ,  ns   , icode,             HR      11
     $                 nsz   , isz   , nzd   , zp1 ,  nz   ,                    HR      12
     $                 nspace, lpr   ,                                          HR      13
     $                 nattch, iatt  ,                                          HR      14
     $                 P2, IDAYHR, IDBWBT,                                      HR      15
     $                 IRPPLT, IRPSUM, IRPSYS, IRPZON, MR1, MR2                 HR      16
      INTEGER          ZP1, ZP2, P2                                             /PTRSYS/14
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               GasTur  25
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /GENKY / DontRun, TrackElec, TrackThermal, TrackLesser,           /GENKY/  2
     &                 TrackGreater, MaxOutput                                  /GENKY/  3
      INTEGER          DontRun, TrackElec, TrackThermal, TrackLesser,           /GENKY/  4
     &                 TrackGreater, MaxOutput                                  /GENKY/  5
c                                                                               GasTur  28
      DIMENSION PLRLim(2)                                                       GasTur  29
      DATA      PLRLim /1.5, 0./                                                GasTur  30
c                                                                               GasTur  31
c              zero hourly generator data                                       GasTur  32
      CALL FILLN(0., EQUIPDAT(1), IVTLIM(2,21))                                 GasTur  33
c                                                                               GasTur  34
c ****         run function : GasTurbineGen1-1                                  GasTur  35
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        GasTur  36
c                                                                               GasTur  37
      SELECT CASE (SimCtrl)                                                     GasTur  38
c                                                                               GasTur  39
c                                                                               GasTur  40
c============= ATTACHMENTS ==================================================== GasTur  41
      CASE (0)                                                                  GasTur  42
c                                                                               GasTur  43
      CALL CreateJpe(Jgn, <gn:ALGORITHM>)                                       GasTur  44
      <gn;Jpe> = Jpe                                                            GasTur  45
c              exhaust heat recovery                                            GasTur  46
      IF (<gn:EXH-LOOP> .GT. 0)  THEN                                           GasTur  47
        CALL CreateJpe(Jgn, 0)                                                  GasTur  48
        <gn;Jpe_Exhaust> = Jpe                                                  GasTur  49
c              Force gas turbine to always track exhaust when                   GasTur  50
c              thermal tracking, as there is no jacket heat                     GasTur  51
        <gn:RCVR-TRACK-LP> = 1                                                  GasTur  52
      ELSE                                                                      GasTur  53
        <gn:RCVR-TRACK-LP> = 0                                                  GasTur  54
      ENDIF                                                                     GasTur  55
c                                                                               GasTur  56
c              miscellaneous attachments                                        GasTur  57
      <gn:ELEC-METER>    = Jcomp(Iem, Lem, <gn:ELEC-METER>)                     GasTur  58
      <gn:SURPLUS-METER> = Jcomp(Iem, Lem, <gn:SURPLUS-METER>)                  GasTur  59
      <gn:AUX-METER>     = Jcomp(Iem, Lem, <gn:AUX-METER>)                      GasTur  60
      <gn:FUEL-METER>    = Jcomp(Ifm, Lfm, <gn:FUEL-METER>)                     GasTur  61
      <gn:EXH-LOOP>      = Jcomp(Ilp, Llp, <gn:EXH-LOOP>)                       GasTur  62
      <gn:COST-DATA>     = Jcomp(Imc, Lmc, <gn:COST-DATA>)                      GasTur  63
      <gn:CAP-FT>        = Jcurve(<gn:CAP-FT>)                                  -045b  228
      <gn:HIR-FT>        = Jcurve(<gn:HIR-FT>)                                  -045b  229
      <gn:HIR-FPLR>      = Jcurve(<gn:HIR-FPLR>)                                -045b  230
      <gn:EXH-RCVR-FPLR> = Jcurve(<gn:EXH-RCVR-FPLR>)                           -045b  231
      <gn:AUX-SCH>       = JSCHED( <gn:AUX-SCH>)                                Time    98
c                                                                               GasTur  69
c                                                                               GasTur  70
c============= DESIGN CALCULATIONS ============================================ GasTur  71
      CASE (1)                                                                  GasTur  72
c                                                                               GasTur  73
c              Set up the start up loads                                        GasTur  74
      CALL StartUpLoad_Design(Jpe, <gn:CAP>, <gn:START-TIME>)                   GasTur  75
c                                                                               GasTur  76
      <pe;DES_KW>        = <gn:CAP>                                             GasTur  77
      <pe;DES_FUEL>      = <gn:CAP> * BTUKW * <gn:HIR>                          GasTur  78
      <pe;DES_RECOVER_Q> = -<pe;DES_FUEL> * <gn:EXH-RCVR>                       GasTur  79
c              flow allocation not yet implemented                              GasTur  80
      <pe;DES_GPM> = 1.E6                                                       GasTur  81
      <pe;MAX_GPM> = 1.E6                                                       GasTur  82
c                                                                               GasTur  83
c ****         run function : GasTurbineGen1-2                                  GasTur  84
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        GasTur  85
c                                                                               GasTur  86
c                                                                               GasTur  87
c============= CALCULATE OPERATING CAPACITIES ================================= GasTur  88
      CASE (11)                                                                 GasTur  89
c                                                                               GasTur  90
c              Calculate electric capacity as a function of ambient             GasTur  91
c              temperature and wetbulb                                          GasTur  92
      OperCap = <gn:CAP> * CVAL(<gn:CAP-FT>,DBT,WBT)                            GasTur  93
      <pe;OPER_CAPACITY> = OperCap                                              GasTur  94
c              maximum output - adjust by warmup time                           GasTur  95
      <pe;MAX_CAPACITY> = OperCap * <gn:MAX-RATIO> - StartUpLoad(Jpe)           -044c4 408
c                                                                               GasTur  97
c              Calculate thermal capacity corresponding to electrical           GasTur  98
      IF (<gn:EXH-LOOP> .GT. 0  .AND.  <pe;OPER_CAPACITY> .GT. 0.)  THEN        GasTur  99
        Jpe = <gn;Jpe_Exhaust>                                                  GasTur 100
        <pe;OPER_CAPACITY> = OperCap * BTUKW * <gn:HIR> * <gn:EXH-RCVR>         GasTur 101
        <pe;MAX_CAPACITY>  = <pe;OPER_CAPACITY>                                 GasTur 102
     &                     * CVAL(<gn:EXH-RCVR-FPLR>,<gn:MAX-RATIO>,1.)         GasTur 103
      ENDIF                                                                     GasTur 104
c                                                                               GasTur 105
c ****         run function : GasTurbineGen1-3                                  GasTur 106
c       IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                      GasTur 107
c                                                                               GasTur 108
      RETURN                                                                    GasTur 109
c                                                                               GasTur 110
c                                                                               GasTur 111
c============= SIMULATE ELECTRIC TRACKING ===================================== GasTur 112
      CASE(12)                                                                  GasTur 113
c                                                                               GasTur 114
c              hourly load and operating capacity                               GasTur 115
      EQload  = <pe;LOAD>                                                       GasTur 116
      OperCap = <pe;OPER_CAPACITY>                                              GasTur 117
c                                                                               GasTur 118
c ****         run function : GasTurbineGen1-4                                  GasTur 119
                                                                                GasTur 120
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        GasTur 121
c                                                                               GasTur 122
c              skip if no load                                                  GasTur 123
      IF (EQload .EQ. 0.)  GOTO 1000                                            GasTur 124
c              part load ratio - don't run if below min                         GasTur 125
      PLR    = EQload / OperCap                                                 GasTur 126
      IF (PLR .LT. <gn:MIN-RATIO>*.999)  THEN                                   GasTur 127
        <pe;LOAD> = 0.                                                          GasTur 128
        EQload    = 0.                                                          GasTur 129
        GOTO 1000                                                               GasTur 130
      ENDIF                                                                     GasTur 131
c                                                                               GasTur 132
c              adjust load for warm-up time and recalculate part                GasTur 133
c              load ratio                                                       GasTur 134
      EQstart = StartUpLoad(Jpe)                                                -044c4 409
      EQload  = EQload + EQstart                                                GasTur 136
      PLR     = EQload / OperCap                                                GasTur 137
c                                                                               GasTur 138
c              fraction of the hour the equipment runs                          GasTur 139
      Frac   = 1.0                                                              GasTur 140
c              fuel input ratio as a function of temperature                    GasTur 141
      HIRFT  = CVAL(<gn:HIR-FT>,EDB,EWB)                                        GasTur 142
c              fuel input ratio as a function of part load                      GasTur 143
      HIRPLR = CVAL(<gn:HIR-FPLR>,PLR,PLR)                                      GasTur 144
c              fuel input ratio                                                 GasTur 145
      EQHIR  = <gn:HIR> * HIRFT * HIRPLR                                        GasTur 146
c              fuel consumption                                                 GasTur 147
      EQfuel = OperCap * BTUKW * EQHIR                                          GasTur 148
c                                                                               GasTur 149
c              recoverable heat at this part load ratio                         GasTur 150
      IF (<gn:EXH-LOOP> .GT. 0)  THEN                                           GasTur 151
        EQrecvr = -OperCap * BTUKW * <gn:HIR> * <gn:EXH-RCVR>                   GasTur 152
     &                             * CVAL(<gn:EXH-RCVR-FPLR>,PLR,PLR)           GasTur 153
      ENDIF                                                                     GasTur 154
c                                                                               GasTur 155
c              separate out start-up load                                       GasTur 156
      EQload = EQload - EQstart                                                 GasTur 157
c                                                                               GasTur 158
c              Auxiliary power                                                  GasTur 159
 1000 IF (<gn:AUX-KW> .GT. 0.)  THEN                                            GasTur 160
c              if always on                                                     GasTur 161
        IF (<gn:AUX-MODE> .EQ. Always)  THEN                                    GasTur 162
          EQaux = <gn:AUX-KW>                                                   GasTur 163
        ELSEIF (<gn:AUX-MODE> .EQ. WhenOn)  THEN                                GasTur 164
          EQaux = <gn:AUX-KW> * Frac                                            GasTur 165
        ELSEIF (<gn:AUX-MODE> .EQ. WhenOff)  THEN                               GasTur 166
          EQaux = <gn:AUX-KW> * (1.0 - Frac)                                    GasTur 167
        ELSE                                                                    Time    99
          EQaux = <gn:AUX-KW> * SchVal(<gn:AUX-SCH>, 1.)                        Time   100
        ENDIF                                                                   GasTur 170
      ENDIF                                                                     GasTur 171
c                                                                               GasTur 172
c ****         run function : GasTurbineGen1-5                                  GasTur 173
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        GasTur 174
c                                                                               GasTur 175
c              report variables                                                 GasTur 176
      <pe;AUX_KW>    = EQaux                                                    GasTur 177
      <pe;FUEL>      = EQfuel                                                   GasTur 178
      JpeSave        = Jpe                                                      GasTur 179
      <pe;RECOVER_Q> = EQrecvr                                                  GasTur 180
      Jpe            = <gn;Jpe_Exhaust>                                         GasTur 181
      <pe;RECOVER_Q> = EQrecvr                                                  GasTur 182
      Jpe            = JpeSave                                                  GasTur 183
c                                                                               GasTur 184
c              hourly-report variables                                          GasTur 185
      IF (<gn;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                                GasTur 186
     &  CALL HourRepPLT(EQUIPDAT(1), <gn;HREP>, 21, 0)                          GasTur 187
c                                                                               GasTur 188
c                                                                               GasTur 189
c============= SIMULATE THERMAL TRACKING ====================================== GasTur 190
      CASE(13)                                                                  GasTur 191
c                                                                               GasTur 192
      IF (<gn;Jpe_Exhaust> .EQ. 0)  RETURN                                      GasTur 193
      OperCap     = <pe;OPER_CAPACITY>                                          GasTur 194
      Jpe         = <gn;Jpe_Exhaust>                                            GasTur 195
      EQrecvr     = -<pe;LOAD>                                                  GasTur 196
      OperCapRcvr = -<pe;OPER_CAPACITY>                                         GasTur 197
c              skip if no load                                                  GasTur 198
      IF (EQrecvr .GT. -1.)  RETURN                                             GasTur 199
c                                                                               GasTur 200
c              heat recoverable at minimum part load ratio                      GasTur 201
      QRecvrMin = OperCapRcvr                                                   GasTur 202
     &          * CVAL(<gn:EXH-RCVR-FPLR>,<gn:MIN-RATIO>,1.)                    GasTur 203
      IF (EQrecvr .LT. QRecvrMin)  THEN                                         GasTur 204
c              Turbine can track the thermal load.  Calculate the               GasTur 205
c              elec PLR corresponding to EQrecvr                                GasTur 206
        PLRexh = EQrecvr / OperCapRcvr                                          GasTur 207
c              pointer to Recvr = f(PLR) curve                                  GasTur 208
        Jcv = <gn:EXH-RCVR-FPLR>                                                -045b  232
        CALL CURINV(<cv:COEF-1>,<cv:TYPE>, 1,PLR,Y,PLRexh,                      -045b  233
     &                                             PLRLim(1),IERR)              -045b  234
      ELSE                                                                      GasTur 211
c              load is less than minimum that can be tracked                    GasTur 212
        PLR = <gn:MIN-RATIO>                                                    GasTur 213
      ENDIF                                                                     GasTur 214
c              Corresponding electrical load.  Note that this load              GasTur 215
c              is stored in the exhaust Jpe block                               GasTur 216
      <pe;LOAD> = OperCap * PLR                                                 GasTur 217
c                                                                               GasTur 218
c ****         run function : GasTurbineGen1-6                                  GasTur 219
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        GasTur 220
c                                                                               GasTur 221
c                                                                               GasTur 222
c============= CALCULATE RECOVERED HEAT ======================================= GasTur 223
      CASE(14)                                                                  GasTur 224
c                                                                               GasTur 225
      IF (<gn;Jpe_Exhaust> .GT. 0)  THEN                                        GasTur 226
        Jpe = <gn;Jpe_Exhaust>                                                  GasTur 227
        Jlp = <gn:EXH-LOOP>                                                     GasTur 228
        IF (<lp;CogenHtrec> .LT. (<lp;Q_NET>-<lp;Q_HTREC>))  THEN               GasTur 229
          Prorate        = (<lp;Q_NET>-<lp;Q_HTREC>) / <lp;CogenHtrec>          GasTur 230
          Qadjust        = <pe;RECOVER_Q> * (1.-Prorate)                        GasTur 231
          <pe;RECOVER_Q> = <pe;RECOVER_Q> - Qadjust                             GasTur 232
          Jpe            = <gn;Jpe>                                             GasTur 233
          <pe;RECOVER_Q> = <pe;RECOVER_Q> - Qadjust                             GasTur 234
          EQrecvr        = <pe;RECOVER_Q>                                       GasTur 235
        ENDIF                                                                   GasTur 236
      ENDIF                                                                     GasTur 237
c                                                                               GasTur 238
c                                                                               GasTur 239
c ****         run function : GasTurbineGen1-7                                  GasTur 240
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        GasTur 241
c                                                                               GasTur 242
c              hourly-report variables                                          GasTur 243
      IF (<gn;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                                GasTur 244
     &  CALL HourRepPLT(EQUIPDAT(1), <gn;HREP>, 21, 1)                          GasTur 245
c                                                                               GasTur 246
c                                                                               GasTur 247
      END SELECT  ! SimCtrl                                                     GasTur 248
      Jpe = <gn;Jpe>                                                            GasTur 249
c                                                                               GasTur 250
      RETURN                                                                    GasTur 251
      END                                                                       GasTur 252
      SUBROUTINE PV_Array                                                       PVInv    2
c                                                                               PVInv    3
c              Simulates a photovoltaic array consisting of PV modules          PVInv    4
c              and an inverter                                                  PVInv    5
c                                                                               PVInv    6
c              SimCtrl   0  Attachment calculations                             PVInv    7
c                        1  Design calculations                                 PVInv    8
c                       11  Initialize operating capacities                     PVInv    9
c                       12  Simulate based on electric demand                   PVInv   10
c                       13  Simulate based on thermal demand,                   PVInv   11
c                             and calculate equivalent elec demand              PVInv   12
c                       14  Calculate recovered heat                            PVInv   13
c                                                                               PVInv   14
c                                                                               PVInv   15
c              DEVELOPED BY                                                     PVInv   16
c                            R. Merriam, ThermoSoft                             PVInv   17
c                            July, 1999                                         PVInv   18
c                                                                               PVInv   19
c              IMPLEMENTATION BY                                                PVInv   20
c                            S. D. Gates                                        PVInv   21
c                            J. J. Hirsch                                       PVInv   22
c                            James J. Hirsch & Associates                       PVInv   23
c                            Camarillo, California                              PVInv   24
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQUIPD/ EQload, EQrun, EQhgb, OperCap, Frac,                     /EQUIPD/ 2
     &                 PLR, EQsupplyT, Tcond,                                   Chlr1    1
     &                 EIRPLR, EIRFT, EQEIR, EQelec, EQfanKW, EQaux,            /EQUIPD/ 4
     &                 HIRPLR, HIRFT, EQHIR, EQfuel, EQcond, EQrecvr,           /EQUIPD/ 5
     &                 HWflow, HWhead, CHWflow, CHWhead, CWflow, CWhead,        /EQUIPD/ 6
     &                 HTRECflow,HTREChead, Qenvir, EQstart, EQloadH,           -041d    1
     &                 EQstartH, PLRh, FracH, EQfuelH, EQelecH                  /EQUIPD/ 8
      REAL             EQUIPDAT(36)                                             /EQUIPD/10
      EQUIVALENCE      (EQUIPDAT(1), EQload), (Tambient, Tcond)                 FreeCl   1
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PTRSYS/ nzone , iz    , nczd  , zp2 ,         mtw  ,             -045a    1
     $                 nsys  , is    , nss   , nsp ,  ns   , icode,             HR      11
     $                 nsz   , isz   , nzd   , zp1 ,  nz   ,                    HR      12
     $                 nspace, lpr   ,                                          HR      13
     $                 nattch, iatt  ,                                          HR      14
     $                 P2, IDAYHR, IDBWBT,                                      HR      15
     $                 IRPPLT, IRPSUM, IRPSYS, IRPZON, MR1, MR2                 HR      16
      INTEGER          ZP1, ZP2, P2                                             /PTRSYS/14
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               PVInv   36
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /GENKY / DontRun, TrackElec, TrackThermal, TrackLesser,           /GENKY/  2
     &                 TrackGreater, MaxOutput                                  /GENKY/  3
      INTEGER          DontRun, TrackElec, TrackThermal, TrackLesser,           /GENKY/  4
     &                 TrackGreater, MaxOutput                                  /GENKY/  5
c                                                                               PVInv   39
      REAL Idc, kWdc, kWac                                                      PVInv   40
c                                                                               PVInv   41
c              zero hourly generator data                                       PVInv   42
      CALL FILLN(0., EQUIPDAT(1), IVTLIM(2,21))                                 PVInv   43
c                                                                               PVInv   44
      SELECT CASE (SimCtrl)                                                     PVInv   45
c                                                                               PVInv   46
c                                                                               PVInv   47
c============= ATTACHMENTS ==================================================== PVInv   48
      CASE (0)                                                                  PVInv   49
c                                                                               PVInv   50
      CALL CreateJpe(Jgn, <gn:ALGORITHM>)                                       PVInv   51
      <gn;Jpe> = Jpe                                                            PVInv   52
c                                                                               PVInv   53
c              Miscellaneous attachments                                        PVInv   54
      <gn:PV-MODULE>     = Jcomp(Ipv, Lpv, <gn:PV-MODULE>)                      PVInv   55
      <gn:ELEC-METER>    = Jcomp(Iem, Lem, <gn:ELEC-METER>)                     PVInv   56
      <gn:SURPLUS-METER> = Jcomp(Iem, Lem, <gn:SURPLUS-METER>)                  PVInv   57
      <gn:AUX-METER>     = Jcomp(Iem, Lem, <gn:AUX-METER>)                      PVInv   58
      <gn:COST-DATA>     = Jcomp(Imc, Lmc, <gn:COST-DATA>)                      PVInv   59
      <gn:EIR-FPLR>      = Jcurve(<gn:EIR-FPLR>)                                -045b  235
      <gn:AUX-SCH>       = Jsched(<gn:AUX-SCH>)                                 PVInv   61
c                                                                               PVInv   62
c                                                                               PVInv   63
c============= DESIGN CALCULATIONS ============================================ PVInv   64
      CASE (1)                                                                  PVInv   65
c                                                                               PVInv   66
c              Get design output of PV modules                                  PVInv   67
      Jpv = <gn:PV-MODULE>                                                      PVInv   68
      CALL PV_MODULE(Vdc, Idc)                                                  PVInv   69
      Jpe = <gn;Jpe>                                                            PVInv   70
      Vdc  = Vdc * <gn:MOD-SERIES>                                              PVInv   71
      Idc  = Idc * <gn:MOD-PARALLEL>                                            PVInv   72
      kWdc = Vdc * Idc * 0.001                                                  PVInv   73
      kWac = kWdc / <gn:EIR>                                                    PVInv   74
c                                                                               PVInv   75
      IF (<gn:CAP>*<gn:NUM-INVERTERS> .LT. kWac*0.95)  THEN                     PVInv   76
c              Inverters are smaller than the PV array                          PVInv   77
        CALL MSGSIM(-3,II,II,II,II)                                             PVInv   78
        WRITE (IOUTPT,9001)  (<gn:NAME>,II=1,8),                                ERV    294
     &                       <gn:CAP>*<gn:NUM-INVERTERS>, kWac                  PVInv   80
      ELSEIF (<gn:CAP>*<gn:NUM-INVERTERS>*0.5 .GT. kWac)  THEN                  PVInv   81
c              Inverters are much bigger than the PV array                      PVInv   82
        CALL MSGSIM(-2,II,II,II,II)                                             PVInv   83
        WRITE (IOUTPT,9002)  (<gn:NAME>,II=1,8),                                ERV    295
     &                       <gn:CAP>*<gn:NUM-INVERTERS>, kWac                  PVInv   85
      ENDIF                                                                     PVInv   86
      IF (Vdc .GT. <gn:MAX-TRACK-V>)  THEN                                      PVInv   87
        CALL MSGSIM(-3,II,II,II,II)                                             PVInv   88
        WRITE (IOUTPT, 9003)  (<gn:NAME>,II=1,8), <gn:MAX-TRACK-V>, Vdc         ERV    296
      ELSEIF (Vdc .LT. <gn:MIN-TRACK-V>)  THEN                                  PVInv   90
        CALL MSGSIM(-2,II,II,II,II)                                             PVInv   91
        WRITE (IOUTPT, 9004)  (<gn:NAME>,II=1,8), <gn:MIN-TRACK-V>, Vdc         ERV    297
      ENDIF                                                                     PVInv   93
c                                                                               PVInv   94
      <pe;DES_INPUT_KW>  = <gn:CAP> * <gn:NUM-INVERTERS> * <gn:EIR>             PVInv   96
      <pe;OPER_CAPACITY> = <gn:CAP> * <gn:NUM-INVERTERS>                        PVInv   97
      <gn;CapDC>    = <gn:CAP> * <gn:NUM-INVERTERS> * <gn:EIR>                  ERV    298
      <gn;CapDCmin> = <gn;CapDC> * CVAL(<gn:EIR-FPLR>,<gn:MIN-RATIO>,xx)        ERV    299
      <gn;CapDCmax> = <gn;CapDC> * CVAL(<gn:EIR-FPLR>,<gn:MAX-RATIO>,xx)        ERV    300
c                                                                               PVInv   98
c              Set up curve inversion terms for DC to AC relationship           PVInv   99
      Jcv                = <gn:EIR-FPLR>                                        -045b  236
      <gn;DCtoAC-Coef1>  = <cv:COEF-1> * <gn:EIR> * <gn:CAP>                    -045b  237
      <gn;DCtoAC-Coef2>  = <cv:COEF-2> * <gn:EIR>                               -045b  238
      <gn;DCtoAC-Coef3>  = <cv:COEF-3> * <gn:EIR> / <gn:CAP>                    -045b  239
      <gn;DCtoAC-Coef1'> = <gn;DCtoAC-Coef1> * <gn:NUM-INVERTERS>               PVInv  104
      <gn;DCtoAC-Coef2'> = <gn;DCtoAC-Coef2>                                    PVInv  105
      <gn;DCtoAC-Coef3'> = <gn;DCtoAC-Coef3> / <gn:NUM-INVERTERS>               PVInv  106
      <gn;DCtoAC-Max>    = <gn;CapDC>        * <gn:NUM-INVERTERS>               -045o    3
     &                                       * <gn:MAX-RATIO> * 1.01            -045o    4
      <gn;NumInverters>  = <gn:NUM-INVERTERS>                                   PVInv  108
c                                                                               PVInv  109
c                                                                               PVInv  110
c============= CALCULATE OPERATING CAPACITIES ================================= PVInv  111
      CASE (11)                                                                 PVInv  112
c                                                                               PVInv  113
c              Get dirct current output of PV module(s) at maximum              PVInv  114
c              power point                                                      PVInv  115
      Jpv = <gn:PV-MODULE>                                                      PVInv  116
      CALL PV_Module(Vdc, Idc)                                                  PVInv  117
      Jpe = <gn;Jpe>                                                            PVInv  118
c                                                                               PVInv  119
c              Adjust for configuration of multiple modules                     PVInv  120
      Vdc = Vdc * <gn:MOD-SERIES>                                               PVInv  121
      Idc = Idc * <gn:MOD-PARALLEL>                                             PVInv  122
      IF (Vdc .le. 0.  .or.  Idc .le. 0.)  THEN                                 -041N   52
        <pe;INPUT_KW>     = 0.                                                  -041N   53
        <pe;MAX_CAPACITY> = 0.                                                  -041N   54
      ELSE                                                                      -041N   55
c              Simulate inverter to convert direct current to alternating       -041N   56
        <pe;INPUT_KW> = Vdc * Idc * 0.001                                       -041N   57
c              First, adjust by inverter limits                                 PVInv  128
        IF (Vdc .GT. <gn:MAX-TRACK-V>) THEN                                     PVInv  129
          Vdc = <gn:MAX-TRACK-V>                                                PVInv  130
          Wdc = Idc * Vdc                                                       PVInv  131
        ELSEIF (Vdc .LT. <gn:MIN-TRACK-V>) THEN                                 PVInv  132
          Wdc = Wdc * Vdc / <gn:MIN-TRACK-V>                                    PVInv  133
        ELSE                                                                    PVInv  134
          Wdc = Vdc * Idc                                                       PVInv  135
        ENDIF                                                                   PVInv  136
        kWdc = Wdc*0.001                                                        ERV    301
        IF (kWdc .LT. <gn;CapDCmin>)  THEN                                      ERV    302
          <pe;MAX_CAPACITY>  = 0.                                               ERV    303
        ELSE                                                                    ERV    304
          kWdc = MIN(kWdc, <gn;CapDCmax>)                                       ERV    305
c              Number of inverters running and curve coefficients               ERV    306
          IF (<gn:INVERTER-CTRL> .EQ. 2)  THEN                                  ERV    307
c              Run only the number of inverters needed                          ERV    308
            <gn;NumInverters>  = MAX(1, INT(kWdc/<gn;CapDC> + 0.999999))        ERV    309
            <gn;DCtoAC-Coef1'> = <gn;DCtoAC-Coef1> * <gn;NumInverters>          ERV    310
            <gn;DCtoAC-Coef3'> = <gn;DCtoAC-Coef3> / <gn;NumInverters>          ERV    311
            <gn;DCtoAC-Max>    = <gn;CapDC> * 1.01 * <gn;NumInverters>          ERV    312
          ENDIF                                                                 ERV    313
c              Back AC current out of curve                                     ERV    314
          Jcv = <gn:EIR-FPLR>                                                   -045b  240
          CALL CURINV(<gn;DCtoAC-Coef1'>,<cv:TYPE>, 1,kWac,Y,kWdc,              -045b  241
     &                                             <gn;DCtoAC-Max>,IERR)        ERV    317
c                                                                               ERV    318
c              output capacity to calling routine                               ERV    319
          <pe;MAX_CAPACITY>  = kWac                                             ERV    320
        ENDIF                                                                   ERV    321
      ENDIF                                                                     ERV    322
c                                                                               PVInv  154
c                                                                               PVInv  155
c============= SIMULATE ELECTRIC TRACKING ===================================== PVInv  156
      CASE(12)                                                                  PVInv  157
c                                                                               PVInv  158
c              Auxiliary power                                                  PVInv  159
 1000 IF (<gn:AUX-KW> .GT. 0.)  THEN                                            PVInv  160
c              if always on                                                     PVInv  161
        IF (<gn:AUX-MODE> .EQ. Always)  THEN                                    PVInv  162
          EQaux = <gn:AUX-KW> * <gn:NUM-INVERTERS>                              PVInv  163
        ELSEIF (<gn:AUX-MODE> .EQ. WhenOn)  THEN                                PVInv  164
          IF (<pe;LOAD> .GT. 0.)  THEN                                          PVInv  165
            EQaux = <gn:AUX-KW> * <gn;NumInverters>                             PVInv  166
          ELSE                                                                  PVInv  167
            EQaux = 0.                                                          PVInv  168
          ENDIF                                                                 PVInv  169
        ELSEIF (<gn:AUX-MODE> .EQ. WhenOff)  THEN                               PVInv  170
          IF (<pe;LOAD> .EQ. 0.)  THEN                                          PVInv  171
            EQaux = <gn:AUX-KW> * <gn:NUM-INVERTERS>                            PVInv  172
          ELSE                                                                  PVInv  173
            EQaux = <gn:AUX-KW> * (<gn:NUM-INVERTERS>-<gn;NumInverters>)        PVInv  174
          ENDIF                                                                 PVInv  175
        ELSE                                                                    PVInv  176
          EQaux = <gn:AUX-KW> * <gn:NUM-INVERTERS>                              PVInv  177
     &                        * SchVal(<gn:AUX-SCH>, 1.)                        PVInv  178
        ENDIF                                                                   PVInv  179
      ENDIF                                                                     PVInv  180
c                                                                               PVInv  181
c              report variables                                                 PVInv  182
      <pe;AUX_KW>   = EQaux                                                     PVInv  183
c                                                                               PVInv  184
c              hourly-report variables                                          PVInv  185
      IF (<gn;HREP> .NE. 0  .AND.  IRSCH .NE. 0)  THEN                          PVInv  186
        EQload  = <pe;LOAD>                                                     PVInv  187
        OperCap = <pe;OPER_CAPACITY>                                            PVInv  188
        PLR     = EQload / (<gn:CAP> * <gn;NumInverters>)                       PVInv  189
        EIRPLR  = CVAL(<gn:EIR-FPLR>,PLR,PLR)                                   PVInv  190
        EQEIR   = <gn:EIR> * EIRPLR                                             PVInv  191
        EQelec  = <gn:CAP> * EQEIR * <gn;NumInverters>                          PVInv  192
        CALL HourRepPLT(EQUIPDAT(1), <gn;HREP>, 21, 0)                          PVInv  193
      ENDIF                                                                     PVInv  194
c                                                                               PVInv  195
c                                                                               PVInv  196
      END SELECT  ! SimCtrl                                                     PVInv  197
c                                                                               PVInv  198
      RETURN                                                                    PVInv  199
c                                                                               PVInv  200
 9001 FORMAT(14x,'Inverter: ',8A4,' has a nominal capacity'            /        PVInv  201
     &       14x,'smaller than the nominal PV array capacity.'         /        PVInv  202
     &       14x,'Inverter/PV Array kW:',2F10.3                        )        PVInv  203
 9002 FORMAT(14x,'Inverter: ',8A4,' has a nominal capacity'            /        PVInv  204
     &       14x,'much larger than the nominal PV array capacity.'     /        PVInv  205
     &       14x,'Inverter/PV Array kW:',2F10.3                        )        PVInv  206
 9003 FORMAT(14x,'Inverter: ',8A4,' has a maximum tracking'            /        PVInv  207
     &       14x,'voltage lower than the nominal PV array output.'     /        PVInv  208
     &       14x,'Inverter/Array volts:',2F10.3                        )        PVInv  209
 9004 FORMAT(14x,'Inverter: ',8A4,' has a minimum tracking'            /        PVInv  210
     &       14x,'voltage higher than the nominal PV array output.'    /        PVInv  211
     &       14x,'Inverter/Array volts:',2F10.3                        )        PVInv  212
      END                                                                       PVInv  213
      SUBROUTINE PV_Module(Vmp, Imp)                                            PVAray   2
c                                                                               PVAray   3
c              Simulates a photovoltaic module using either the                 PVAray   4
c              modified-standard method or the Sandia/King method               PVAray   5
c                                                                               PVAray   6
c              SimCtrl   0  Attachment calculations                             PVAray   7
c                        1  Design calculations                                 PVAray   8
c                       11  Initialize operating capacities                     PVAray   9
c                       12  Simulate based on electric demand                   PVAray  10
c                       13  Simulate based on thermal demand,                   PVAray  11
c                             and calculate equivalent elec demand              PVAray  12
c                       14  Calculate recovered heat                            PVAray  13
c                                                                               PVAray  14
c                                                                               PVAray  15
c              DEVELOPED BY                                                     PVAray  16
c                            R. Merriam, ThermoSoft                             PVAray  17
c                            July, 1999                                         PVAray  18
c                                                                               PVAray  19
c              IMPLEMENTATION BY                                                PVAray  20
c                            S. D. Gates                                        PVAray  21
c                            J. J. Hirsch                                       PVAray  22
c                            James J. Hirsch & Associates                       PVAray  23
c                            Camarillo, California                              PVAray  24
c                                                                               PVAray  25
c                                                                               -042h    1
c              Revised Aug 2003 to use Sandia/King of 9/5/2000                  -042h    2
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQUIPD/ EQload, EQrun, EQhgb, OperCap, Frac,                     /EQUIPD/ 2
     &                 PLR, EQsupplyT, Tcond,                                   Chlr1    1
     &                 EIRPLR, EIRFT, EQEIR, EQelec, EQfanKW, EQaux,            /EQUIPD/ 4
     &                 HIRPLR, HIRFT, EQHIR, EQfuel, EQcond, EQrecvr,           /EQUIPD/ 5
     &                 HWflow, HWhead, CHWflow, CHWhead, CWflow, CWhead,        /EQUIPD/ 6
     &                 HTRECflow,HTREChead, Qenvir, EQstart, EQloadH,           -041d    1
     &                 EQstartH, PLRh, FracH, EQfuelH, EQelecH                  /EQUIPD/ 8
      REAL             EQUIPDAT(36)                                             /EQUIPD/10
      EQUIVALENCE      (EQUIPDAT(1), EQload), (Tambient, Tcond)                 FreeCl   1
      COMMON  /FILES / ISTNDF,ICTRL,IWEATH,ITDV,IDSNFL,ILDSO,ISYSO,             -044     1
     1                 IREPFL,IHDFIL,IHRHDF,IOUTPT,IOVRL,                       /FILES/  3
     2                 IPLTO, IPPFIL, ICECHR, ICECDT, ICECPR,                   /FILES/  4
     3                 IHRREP(3), IHRPAS(2)                                     /FILES/  5
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PTRSYS/ nzone , iz    , nczd  , zp2 ,         mtw  ,             -045a    1
     $                 nsys  , is    , nss   , nsp ,  ns   , icode,             HR      11
     $                 nsz   , isz   , nzd   , zp1 ,  nz   ,                    HR      12
     $                 nspace, lpr   ,                                          HR      13
     $                 nattch, iatt  ,                                          HR      14
     $                 P2, IDAYHR, IDBWBT,                                      HR      15
     $                 IRPPLT, IRPSUM, IRPSYS, IRPZON, MR1, MR2                 HR      16
      INTEGER          ZP1, ZP2, P2                                             /PTRSYS/14
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /SUND/   ISUNUP, GUNDOG, HORANG, TDECLN, EQTIME, SOLCON,          /SUND/   2
     1                 ATMEXT, SKYDFF, RAYCOS(3), RDN,                          /SUND/   3
     2                 BSUN, DECLN, CD, SD, FSUNUP                              /SUND/   4
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON /UNITT/   VKONV(300), DUMLOG(4), JUNITT(4,300,2)                   /UNITT/  2
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
c                                                                               PVAray  38
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /GENKY / DontRun, TrackElec, TrackThermal, TrackLesser,           /GENKY/  2
     &                 TrackGreater, MaxOutput                                  /GENKY/  3
      INTEGER          DontRun, TrackElec, TrackThermal, TrackLesser,           /GENKY/  4
     &                 TrackGreater, MaxOutput                                  /GENKY/  5
c                                                                               PVAray  41
      DIMENSION RBbuf(20)                                                       PVAray  42
      EQUIVALENCE (RBbuf( 5), Edirect),    (RBbuf( 6), Ediffuse),               PVAray  43
     &            (RBbuf( 7), Eground),    (RBbuf( 8), AOI),                    PVAray  44
     &            (RBbuf( 9), fAOI),       (RBbuf(10), AirMass),                PVAray  45
     &            (RBbuf(11), fAirMass),   (RBbuf(12), Epoa),                   PVAray  46
     &            (RBbuf(13), Eeffective), (RBbuf(14), Tcell)                   PVAray  47
      REAL Imp, LnEe                                                            -042h    4
      DATA Rradian / 0.01745329 /                                               PVAray  49
c                                                                               PVAray  50
      Jpe = <pv;Jpe>                                                            PVAray  51
c                                                                               PVAray  52
      SELECT CASE (SimCtrl)                                                     PVAray  53
c                                                                               PVAray  54
c                                                                               PVAray  55
c============= ATTACHMENTS ==================================================== PVAray  56
      CASE (0)                                                                  PVAray  57
c                                                                               PVAray  58
      CALL CreateJpe(Jpv, <pv:ALGORITHM>)                                       PVAray  59
      <pv;Jpe> = Jpe                                                            PVAray  60
c                                                                               PVAray  61
      <pv:COST-DATA>     = Jcomp(Imc, Lmc, <pv:COST-DATA>)                      PVAray  62
      <pv:IRRAD-FAM>     = Jcurve(<pv:IRRAD-FAM>)                               -045b  242
      <pv:IRRAD-FAOI>    = Jcurve(<pv:IRRAD-FAOI>)                              -045b  243
c                                                                               PVAray  65
c                                                                               PVAray  66
c============= DESIGN CALCULATIONS ============================================ PVAray  67
      CASE (1)                                                                  PVAray  68
c                                                                               PVAray  69
c              Rated volts and current at max power point                       PVAray  70
      Vmp = <pv:VOLTS-MAX-PWR>                                                  PVAray  71
      Imp = <pv:AMPS-MAX-PWR>                                                   PVAray  72
c                                                                               PVAray  73
c              Module geometric coefficients - note that DOE-2 uses the         PVAray  74
c              convention that a 0 degree azimuth points north                  PVAray  75
      Raz     = Rradian * <gn:MOUNT-AZIMUTH>                                    PVAray  76
      Rtilt   = Rradian * <gn:MOUNT-TILT>                                       PVAray  77
      <pv;Az> = COS(Rtilt)                                                      PVAray  78
      <pv;Ax> = SIN(Raz) * SIN(Rtilt)                                           PVAray  79
      <pv;Ay> = COS(Raz) * SIN(Rtilt)                                           PVAray  80
c              Precalculated term for module tilt                               PVAray  81
      <pv;Sn(Tilt/2)**3> = sin(Rtilt / 2.0)**3.                                 PVAray  82
c                                                                               PVAray  83
c              Check if cell efficiency reasonable                              PVAray  84
      IF (<pv:EFFICIENCY> .LT. 0.05 .OR. <pv:EFFICIENCY> .GT. 0.15) THEN        PVAray  85
        CALL MSGSIM(-2,II,II,II,II)                                             PVAray  86
        WRITE (IOUTPT, 9001)  (<pv:NAME>,II=1,8), <pv:EFFICIENCY>               PVAray  87
      ENDIF                                                                     PVAray  88
c              Additional checks                                                PVAray  89
      Ratio = <pv:VOLTS-MAX-PWR> / <pv:VOLTS-OPEN-CK>                           PVAray  90
      IF (Ratio .LT. 0.7  .OR.  Ratio .GT. 0.86)  THEN                          PVAray  91
        CALL MSGSIM(-2,II,II,II,II)                                             PVAray  92
        WRITE (IOUTPT, 9002)  (<pv:NAME>,II=1,8), Ratio                         PVAray  93
      ENDIF                                                                     PVAray  94
      Ratio = <pv:VOLTS/T-OPEN> / <pv:VOLTS-OPEN-CK>                            PVAray 100
      IF (Ratio .LT. -0.0060  .OR.  Ratio .GT. -0.0020)  THEN                   PVAray 101
        CALL MSGSIM(-2,II,II,II,II)                                             PVAray 102
        WRITE (IOUTPT, 9004)  (<pv:NAME>,II=1,8), Ratio                         PVAray 103
      ENDIF                                                                     PVAray 104
      FillFactor = <pv:AMPS-MAX-PWR>*<pv:VOLTS-MAX-PWR>                         PVAray 105
     &                    / (<pv:AMPS-SHORT-CK>*<pv:VOLTS-OPEN-CK>)             PVAray 106
      IF (FillFactor .LT. 0.6  .OR.  FillFactor .GT. 0.90)  THEN                PVAray 107
        CALL MSGSIM(-2,II,II,II,II)                                             PVAray 108
        WRITE (IOUTPT, 9005)  (<pv:NAME>,II=1,8), FillFactor                    PVAray 109
      ENDIF                                                                     PVAray 110
c                                                                               PVAray 111
      <pe;OPER_CAPACITY> = Vmp * Imp * 0.001                                    PVAray 112
      <pe;DES_INPUT_KW>  = <pv:AREA> * VKONV(9)  ! m2                           -042h    5
     &                   * 1.                    ! 1000W/m2                     -042h    6
c                                                                               PVAray 114
c                                                                               PVAray 115
c============= CALCULATE OPERATING CAPACITIES ================================= PVAray 116
      CASE (11,12)                                                              PVAray 117
c                                                                               PVAray 118
c              Calculate electric capacity as a function of direct and          PVAray 119
c              diffuse solar temperature, angle of incidence, air mass,         PVAray 120
c              and ambient temperature                                          PVAray 121
c                                                                               PVAray 122
      CALL FILLN(0., RBbuf, 20)                                                 PVAray 123
      Vmp = 0.                                                                  PVAray 124
      Imp = 0.                                                                  PVAray 125
c                                                                               PVAray 126
c              Horizontal, beam, and diffuse radiation (W/m2)                   -042h    7
      Ehoriz   = SOLRAD                     * VKONV(17)                         -042h    8
      Ebeam    = Max(0., RDNCC * RAYCOS(3)) * VKONV(17)                         -042h    9
      Ediffuse = Ehoriz - Ebeam                                                 -042h   10
c              check if sun is up and shining                                   -042h   11
      IF (ISUNUP .EQ. 0.  .OR.  Ehoriz .LE. 0.)  GOTO 1199                      -042h   12
c                                                                               -042h   13
c              Air mass and spectral correction                                 -042h   14
      Za       = ACOS(RAYCOS(3)) * 57.29                                        -042h   15
      Cosz     = COS(Rradian * Za)                                              -042h   16
      AirMass  = 1.0 / (RAYCOS(3) + 0.5057 / (96.08-Za)**1.634)                 -042h   17
      AirMass  = AirMass * PATM/29.921                                          -042h   18
      IF (<pv:A0-A4> .eq. 0.)  THEN  ! use curve-fit                            -042h   19
        AirMass  = Min(6.5, AirMass)                                            -042h   20
        fAirMass = Cval(<pv:IRRAD-FAM>, AirMass, AirMass)                       -042h   21
      ELSE  ! use Sandia 4th order                                              -042h   22
        AirMass  = Min(16., AirMass)                                            -042h   23
        fAirMass = (((AA(<#pv:A0-A4>+4)  * AirMass                              -042h   24
     &           +    AA(<#pv:A0-A4>+3)) * AirMass                              -042h   25
     &           +    AA(<#pv:A0-A4>+2)) * AirMass                              -042h   26
     &           +    AA(<#pv:A0-A4>+1)) * AirMass                              -042h   27
     &           +    AA(<#pv:A0-A4>+0)                                         -042h   28
      ENDIF                                                                     -042h   29
      fAirMass = Min(1., fAirMass)                                              -042h   30
c                                                                               -042h   31
c              Angle of incidence and optical effect                            -042h   32
      dCos = <pv;Ax>*RAYCOS(1) + <pv;Ay>*RAYCOS(2) + <pv;Az>*RAYCOS(3)          -042h   33
      dCos = Max(0., Min(1., dCos))                                             -042h   34
      AOI  = ACOS(dCos) * 57.29                                                 -042h   35
      IF (<pv:B0-B5> .eq. 0.)  THEN  ! use curve-fit                            -042h   36
c              no optical effect unless AOI > 40 degrees from normal            -042h   37
        IF (AOI .lt. 40.)  THEN                                                 -042h   38
          fAOI = 1.                                                             -042h   39
        ELSE                                                                    -042h   40
          fAOI = Cval(<pv:IRRAD-FAOI>, AOI, AOI)                                -042h   41
        ENDIF                                                                   -042h   42
      ELSE  ! use Sandia 5th order                                              -042h   43
        fAOI = ((((AA(<#pv:B0-B5>+5)  * AOI                                     -042h   44
     &       +     AA(<#pv:B0-B5>+4)) * AOI                                     -042h   45
     &       +     AA(<#pv:B0-B5>+3)) * AOI                                     -042h   46
     &       +     AA(<#pv:B0-B5>+2)) * AOI                                     -042h   47
     &       +     AA(<#pv:B0-B5>+1)) * AOI                                     -042h   48
     &       +     AA(<#pv:B0-B5>+0)                                            -042h   49
      ENDIF                                                                     -042h   50
      fAOI = Min(1., fAOI)                                                      -042h   51
c                                                                               -042h   52
c              Calculate plane-of-array irradiation for anisotropic sky         -042h   53
c              based on HDKR algorithms.                                        -042h   54
c              First, extraterrestrial radiation and correlations               -042h   55
      Eext = 433.6 * (1.0 + 0.033 * COS(0.017214 * IDOY))  ! Btuh/ft2           -042h   56
      Ai   = DIRSOL / Eext                                 ! ratio              -042h   57
c              net direct component on the module (W/m2)                        -042h   58
      Rbeam   = dCos / RAYCOS(3)                                                -042h   59
      Edirect = (Ebeam + Ediffuse*Ai) * Rbeam                                   -042h   60
c              diffuse component                                                -042h   61
      f        = SQRT(Ebeam / Ehoriz)                                           -042h   62
      Ediffuse = Ediffuse * (1.0-Ai) * (1.0+<pv;Az>) / 2.0                      -042h   63
     &                    * (1.0 + f * <pv;Sn(Tilt/2)**3>)                      -042h   64
c              ground reflectance component                                     -042h   65
      Eground  = Ehoriz * <gn:GND-REFLECTAN> * (1.0-<pv;Az>)*0.5                -042h   66
c              net plane of array radiation (W/m2)                              -042h   67
      Epoa     = Edirect*fAOI*fAirMass + Ediffuse + Eground                     -042h   68
c                                                                               -042h   69
c              skip if irradiance negligible                                    -042h   70
      IF (Epoa .LT. 10.)  GOTO 1199                                             -042h   71
c              Effective irradiance (suns)                                      -042h   72
      Eeffective = Epoa / 1000.                                                 -042h   73
c                                                                               -042h   74
c              Back surface module temperature (C)                              -042h   75
      WindCoef = <gn:WIND-COEF-A>                  ! C/(W/m2)                   -042h   76
     &         + <gn:WIND-COEF-B> * WNDSPD*VKONV(13)                            -042h   77
      dTback   = Epoa * Exp(WindCoef)                                           -042h   78
      Tback    = (DBT-32.)*VKONV(74) + dTback                                   -042h   79
c              interior cell temperature (C)                                    -042h   80
      Tcell    = Tback + Eeffective * <pv:CELL-BACK-DT>                         -042h   81
c              delta from reference temperature                                 -042h   82
      dTref    = Tcell - 25.                                                    -042h   83
c                                                                               -042h   84
c              Electric output per module                                       -042h   85
      SELECT CASE (<pv:ALGORITHM>)                                              -042h   86
        CASE (1)  ! Modified-standard model                                     -042h   87
c              Voltage and current at maximum power point                       -042h   88
          Vmp = <pv:VOLTS-MAX-PWR> + <pv:VOLTS/T-OPEN>*dTref                    -042h   89
          Imp = <pv:AMPS-MAX-PWR> * Eeffective                                  -042h   90
c                                                                               -042h   91
        CASE (2)  ! Sandia (David King) model                                   -042h   92
c              Current at maximum power point                                   -042h   93
          Imp  = <pv:AMPS-MAX-PWR>                                              -042h   94
     &         * (<pv:C0> + <pv:C1>*Eeffective)*Eeffective                      -042h   95
     &         * (1. + <pv:AMPS/T-MAX-PW>*dTref)                                -042h   96
c              'thermal voltage' per cell                                       -042h   97
          dTc  = 0.000086173 * <pv:FDIODE> * (Tcell+273.15)                     -042h   98
c              voltage temperature coefficient                                  -042h   99
          bVmp = <pv:VOLTS/T-MAX-P>                                             -042h  100
     &         + <pv:VOLTS/E-MAX-P>*(1.-Eeffective)                             -042h  101
c              Voltage at maximum power point                                   -042h  102
          LnEe = Log(Eeffective)                                                -042h  103
          Vmp  = <pv:VOLTS-MAX-PWR>                                             -042h  104
     &         + (<pv:C2> + <pv:C3>*dTc*LnEe) * dTc*LnEe                        -042h  105
     &                                        * <pv:CELLS-SERIES>               -048f    1
     &         + bVmp*dTref                                                     -042h  107
      END SELECT                                                                -042h  108
c                                                                               -042h  109
c              Check for bad result                                             -042h  110
      IF (Vmp .lt. 0.  .and.  Eeffective .gt. 0.05                              -042h  111
     &                 .and.  <pv.NegativeVmp> .eq. 0)  THEN                    -042h  112
        <pv.NegativeVmp> = 1                                                    -042h  113
        CALL MSGSIM(-2,II,II,II,II)                                             -042h  114
        WRITE (IOUTPT, 9101) (<pv:NAME>,II=1,8), IMO, IDAY, IHR                 -042h  115
      ENDIF                                                                     -042h  116
      IF (Imp .lt. 0.  .and.  <pv.NegativeImp> .eq. 0)  THEN                    -042h  117
        <pv.NegativeImp> = 1                                                    -042h  118
        CALL MSGSIM(-2,II,II,II,II)                                             -042h  119
        WRITE (IOUTPT, 9102) (<pv:NAME>,II=1,8), IMO, IDAY, IHR                 -042h  120
      ENDIF                                                                     -042h  121
c                                                                               -042h  122
c              Report variables                                                 -042h  123
 1199 <pe;LOAD>     = Vmp * Imp * 0.001                                         -042h  124
      <pe;FUEL>     = (Edirect + Ediffuse + Eground) / VKONV(17)                -042h  125
     &                                               * <pv:AREA>                -042h  126
      <pe;INPUT_KW> = <pe;FUEL> * KWBTU                                         -042h  127
c                                                                               PVAray 205
c              hourly-report variables                                          PVAray 206
      IF (<pv;HREP> .NE. 0  .AND.  IRSCH .NE. 0)  THEN                          PVAray 207
        RBbuf( 1) = Vmp * Imp * 0.001                                           PVAray 208
        RBbuf( 2) = Vmp                                                         PVAray 209
        RBbuf( 3) = Imp                                                         PVAray 210
        RBbuf( 4) = SOLRAD                                                      PVAray 211
        CALL HourRepPLT(RBbuf(1), <pv;HREP>, 20, 0)                             PVAray 212
      ENDIF                                                                     PVAray 213
c                                                                               PVAray 214
      END SELECT  ! SimCtrl                                                     PVAray 215
c                                                                               PVAray 216
      RETURN                                                                    PVAray 217
c                                                                               PVAray 218
 9001 FORMAT(14x,'Component: ',8A4,' has a computed photocell'         /        PVAray 219
     &       14x,'efficiency of:',F6.3,' Normal range is 0.05 to 0.15' )        -047k  132
 9002 FORMAT(14x,'Component: ',8A4,' has ratio of maximum'             /        PVAray 221
     &       14x,'power point voltage to open circuit voltage =',F10.3 /        PVAray 222
     &       14x,'Normal range is 0.7 to 0.86'                         )        PVAray 223
 9003 FORMAT(14x,'Component: ',8A4,' has ratio of AMPS/T to '          /        PVAray 224
     &       14x,'AMPS-SHORT-CKT ='F7.4,' Normal range is 0.0002 to',           -047k  133
     &           ' 0.002'                                              )        PVAray 226
 9004 FORMAT(14x,'Component: ',8A4,' has ratio of VOLTS/T to '         /        PVAray 227
     &       14x,'VOLTS-OPEN-CKT ='F7.4,' Normal range is -.006 to',            PVAray 228
     &           ' -.002'                                              )        PVAray 229
 9005 FORMAT(14x,'Component: ',8A4,' has a fill factor =',F6.3         /        -047k  134
     &       14x,'Normal range is 0.6 to 0.9'                          )        PVAray 231
 9101 FORMAT(14x,'Component: ',8A4,' is generating a'                  /        -041N   69
     &14x,'negative voltage, and will be zeroed this hour.  Check'     /        -041N   70
     &14x,'temperature vs. irradiance coefficients for consistency.'   /        -041N   71
     &14x,'First occurrence: ',I2,'/',I2,'/',I2                        )        -041N   72
 9102 FORMAT(14x,'Component: ',8A4,' is generating a'                  /        -041N   73
     &14x,'negative current, and will be zeroed this hour.  Check'     /        -041N   74
     &14x,'temperature vs. irradiance coefficients for consistency.'   /        -041N   75
     &14x,'First occurrence: ',I2,'/',I2,'/',I2                        )        -041N   76
c                                                                               -041N   77
      END                                                                       PVAray 232
      FUNCTION SteamEnthalpy(Pressure, Superheat)                               SteamH   2
c                                                                               SteamH   3
c              Calculates the enthaply of steam.  Applies to pressures          SteamH   4
c              up to 1000 psig.                                                 SteamH   5
c                                                                               SteamH   6
c              Reference:  CERL Interim Report E-81                             SteamH   7
c                                                                               SteamH   8
c              Pressure   Steam Pressure, psig                                  SteamH   9
c              Superheat  Steam superheat, F                                   SteamH  10
c                                                                               SteamH  11
c                                                                               SteamH  12
c              Steam temperature                                                SteamH  13
      Temperature = SteamSaturationT(Pressure) + Superheat                      SteamH  14
c              Absolute pressure                                                SteamH  15
      Psia = Pressure + 14.7                                                    SteamH  16
c                                                                               SteamH  17
      A = 1068. - .485*Psia                                                     SteamH  18
      B = .432 + .000953*Psia                                                   SteamH  19
      C = .000036 - .000000496*Psia                                             SteamH  20
      SteamEnthalpy = A + B*Temperature + C*Temperature*Temperature             SteamH  21
c                                                                               SteamH  22
      RETURN                                                                    SteamH  23
      END                                                                       SteamH  24
      FUNCTION SteamEntropy(Pressure, Superheat)                                SteamS   2
c                                                                               SteamS   3
c              Calculates the entropy of steam                                  SteamS   4
c                                                                               SteamS   5
c              Reference:  CERL Interim Report E-81                             SteamS   6
c              Pressure   Steam Pressure, psig                                  SteamS   7
c              Superheat  Steam superheat, F                                   SteamS   8
c                                                                               SteamS   9
c                                                                               SteamS  10
c              Steam temperature                                                SteamS  11
      SaturatedT  = SteamSaturationT(Pressure)                                  SteamS  12
      SteamT      = SaturatedT + Superheat                                      SteamS  13
c                                                                               SteamS  14
      A = 1068.   - .485000000 * Pressure                                       SteamS  15
      B = .432    + .000953000 * Pressure                                       SteamS  16
      C = .000036 - .000000496 * Pressure                                       SteamS  17
c                                                                               SteamS  18
      SteamEntropy = 2.385                                                      SteamS  19
     &             - .004398*SaturatedT                                         SteamS  20
     &             + .000008146*SaturatedT*SaturatedT                           SteamS  21
     &             - .626E-08*SaturatedT*SaturatedT*SaturatedT                  SteamS  22
     &             + 2.*C*(SteamT-SaturatedT)                                   SteamS  23
     &             + (B-920.*C) * ALOG((SteamT+460.)/(SaturatedT+460.))         SteamS  24
      RETURN                                                                    SteamS  25
      END                                                                       SteamS  26
      FUNCTION SteamSaturationT(Pressure)                                       SteamT   2
c                                                                               SteamT   3
c              Calculates the saturated steam temperature as a function         SteamT   4
c              of steam pressure (psig).                                        SteamT   5
c              Applies for temperatures 200-700F.                               SteamT   6
c                                                                               SteamT   7
c              Reference:  CERL Interim Report E-81                             SteamT   8
c                                                                               SteamT   9
      SteamSaturationT = 1. / (.0017887-.00011429*ALOG(Pressure+14.7))          SteamT  10
     &                                                            - 460.        SteamT  11
c                                                                               SteamT  12
      RETURN                                                                    SteamT  13
      END                                                                       SteamT  14
      SUBROUTINE SteamTurbineGen1                                               StmTur   2
c                                                                               StmTur   3
c              Simulates a steam-turbine generator                              StmTur   4
c                                                                               StmTur   5
c              SimCtrl   0  Attachment calculations                             StmTur   6
c                        1  Design calculations                                 StmTur   7
c                       11  Initialize hourly operating capacities              StmTur   8
c                       12  Simulate based on hourly electric demand            StmTur   9
c                       13  Simulate based on hourly thermal demand,            StmTur  10
c                             and calculate equivalent elec demand              StmTur  11
c                       14  Calculate recovered heat and heat-rejection         StmTur  12
c                                                                               StmTur  13
c              Performance characteristics developed by                         /ETO/    2
c                            Joe Eto                                            /ETO/    3
c                            Lawrence Berkeley National Laboratory              /ETO/    4
c                            University of California                           /ETO/    5
c                                                                               /ETO/    6
c              Adapted for DOE-2.2 BY                                           /ETO/    7
c                            S. D. Gates                                        /ETO/    8
c                            J. J. Hirsch                                       /ETO/    9
c                            James J. Hirsch & Associates                       /ETO/   10
c                            Camarillo, California                              /ETO/   11
c                                                                               /ETO/   12
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /EQUIPD/ EQload, EQrun, EQhgb, OperCap, Frac,                     /EQUIPD/ 2
     &                 PLR, EQsupplyT, Tcond,                                   Chlr1    1
     &                 EIRPLR, EIRFT, EQEIR, EQelec, EQfanKW, EQaux,            /EQUIPD/ 4
     &                 HIRPLR, HIRFT, EQHIR, EQfuel, EQcond, EQrecvr,           /EQUIPD/ 5
     &                 HWflow, HWhead, CHWflow, CHWhead, CWflow, CWhead,        /EQUIPD/ 6
     &                 HTRECflow,HTREChead, Qenvir, EQstart, EQloadH,           -041d    1
     &                 EQstartH, PLRh, FracH, EQfuelH, EQelecH                  /EQUIPD/ 8
      REAL             EQUIPDAT(36)                                             /EQUIPD/10
      EQUIVALENCE      (EQUIPDAT(1), EQload), (Tambient, Tcond)                 FreeCl   1
      COMMON  /FNSYS/  ISKIPS, MSYSF(120)                                       /FNSYS/  2
      COMMON  /HRREP / Irb, Ihrp, Lrb, Lhrp, Nrb, Nhrp, IVTLIM(3,50),           HR       4
     &                 IGRPtr, IBRPtr, IRSch, IRSchT(5),                        HR       5
     &                 NHRTyp(3), ITBUF(3), ITBUFB(3), ITBUFE(3),               HR       6
     &                 IHREOF, ICDFLG                                           HR       7
      COMMON  /MISCD / TEMPS(4,9999),CONS(5),TEMPSL(9999),                      -048a    8
     1                 BLDGQH,BLDGQC,BLDGQL,BLDGP,BPMULT,                       /MISCD/  3
     2                 DBTMIN,DBTMAX,WMIN,WMAX,NSPZ(9999),                      -048a    9
     3                 DQ, DTP, DTR, DTS, FPI, PLRCC , POM, TC2, TDM,           /MISCD/  5
     4                 TRA,WCOL,WCOLM,WMM,YPI,KWBTU,BTUKW,UNFILD,Unusedm        /MISCD/  6
      REAL             KWBTU                                                    /MISCD/  7
      COMMON  /PTRPLT/ Ipm,Ilp,Ich,Ibl,Idw,Itw,Ipv,Ign,Itk,Ihx,                 PV       1
     &                 Iec,Ilm,Iem,Ifm,Ism,Icm,Imm,Imc,Igl,Isp2,                /PTRPLT/ 3
     &                 Ispare(5),  Ipe,                                         /PTRPLT/ 4
     &                 Npm,Nlp,Nch,Nbl,Ndw,Ntw,Npv,Ngn,Ntk,Nhx,                 PV       2
     &                 Nec,Nlm,Nem,Nfm,Nsm,Ncm,Nmm,Nmc,Ngl,Nsp2,                /PTRPLT/ 6
     &                 Nspare(5),  Npe,                                         /PTRPLT/ 7
     &                 Lpm,Llp,Lch,Lbl,Ldw,Ltw,Lpv,Lgn,Ltk,Lhx,                 PV       3
     &                 Lec,Llm,Lem,Lfm,Lsm,Lcm,Lmm,Lmc,Lgl,Lsp2,                /PTRPLT/ 9
     &                 Lspare(5),  Lpe,                                         /PTRPLT/10
     &                 Jpm,Jlp,Jch,Jbl,Jdw,Jtw,Jpv,Jgn,Jtk,Jhx,                 PV       4
     &                 Jec,Jlm,Jem,Jfm,Jsm,Jcm,    Jmc,Jgl,                     /PTRPLT/12
     &                 Jpe, kpr, NumMeters, NumIntHX                            /PTRPLT/13
      COMMON  /PTRSYS/ nzone , iz    , nczd  , zp2 ,         mtw  ,             -045a    1
     $                 nsys  , is    , nss   , nsp ,  ns   , icode,             HR      11
     $                 nsz   , isz   , nzd   , zp1 ,  nz   ,                    HR      12
     $                 nspace, lpr   ,                                          HR      13
     $                 nattch, iatt  ,                                          HR      14
     $                 P2, IDAYHR, IDBWBT,                                      HR      15
     $                 IRPPLT, IRPSUM, IRPSYS, IRPZON, MR1, MR2                 HR      16
      INTEGER          ZP1, ZP2, P2                                             /PTRSYS/14
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
c                                                                               StmTur  24
      COMMON  /EQKY  / Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   2
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   3
      INTEGER          Always, WhenOn, WhenOff, AuxSched,                       /EQKY/   4
     &                 ConstantFlow, VariableFlow, Yes, No                      /EQKY/   5
      COMMON  /GENKY / DontRun, TrackElec, TrackThermal, TrackLesser,           /GENKY/  2
     &                 TrackGreater, MaxOutput                                  /GENKY/  3
      INTEGER          DontRun, TrackElec, TrackThermal, TrackLesser,           /GENKY/  4
     &                 TrackGreater, MaxOutput                                  /GENKY/  5
c                                                                               StmTur  27
      REAL LbsPerKWH                                                            StmTur  28
      DIMENSION PLRLim(2), Curve(3)                                             StmTur  29
      DATA      PLRLim /1.5, 0./                                                StmTur  30
c                                                                               StmTur  31
c              zero hourly generator data                                       StmTur  32
      CALL FILLN(0., EQUIPDAT(1), IVTLIM(2,21))                                 StmTur  33
c                                                                               StmTur  34
c ****         run function : SteamTurbineGen1-1                                StmTur  35
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        StmTur  36
c                                                                               StmTur  37
      SELECT CASE (SimCtrl)                                                     StmTur  38
c                                                                               StmTur  39
c                                                                               StmTur  40
c============= ATTACHMENTS ==================================================== StmTur  41
      CASE (0)                                                                  StmTur  42
c                                                                               StmTur  43
      CALL CreateJpe(Jgn, <gn:ALGORITHM>)                                       StmTur  44
      <gn;Jpe> = Jpe                                                            StmTur  45
c              exhaust heat recovery                                            StmTur  46
      IF (<gn:EXH-LOOP> .GT. 0  .OR.  <gn:CW-LOOP> .GT. 0)  THEN                StmTur  47
        CALL CreateJpe(Jgn, 0)                                                  StmTur  48
        <gn;Jpe_Exhaust> = Jpe                                                  StmTur  49
c              Force gas turbine to always track exhaust when                   StmTur  50
c              thermal tracking, as there is no jacket heat                     StmTur  51
        IF (<gn:EXH-LOOP> .GT. 0)  THEN                                         StmTur  52
          <gn:RCVR-TRACK-LP> = 1                                                StmTur  53
        ELSE                                                                    StmTur  54
          <gn:RCVR-TRACK-LP> = 0                                                StmTur  55
        ENDIF                                                                   StmTur  56
      ENDIF                                                                     StmTur  57
c                                                                               StmTur  58
c              miscellaneous attachments                                        StmTur  59
      <gn:ELEC-METER>    = Jcomp(Iem, Lem, <gn:ELEC-METER>)                     StmTur  60
      <gn:SURPLUS-METER> = Jcomp(Iem, Lem, <gn:SURPLUS-METER>)                  StmTur  61
      <gn:AUX-METER>     = Jcomp(Iem, Lem, <gn:AUX-METER>)                      StmTur  62
      <gn:STEAM-LOOP>    = Jcomp(Ilp, Llp, <gn:STEAM-LOOP>)                     StmTur  63
      <gn:EXH-LOOP>      = Jcomp(Ilp, Llp, <gn:EXH-LOOP>)                       StmTur  64
      <gn:CW-LOOP>       = Jcomp(Ilp, Llp, <gn:CW-LOOP>)                        StmTur  65
      <gn:COST-DATA>     = Jcomp(Imc, Lmc, <gn:COST-DATA>)                      StmTur  66
      <gn:HIR-FPLR>      = Jcurve(<gn:HIR-FPLR>)                                -045b  244
      <gn:STEAM-ENTH-FP> = Jcurve(<gn:STEAM-ENTH-FP>)                           -045b  245
      <gn:AUX-SCH>       = JSCHED( <gn:AUX-SCH>)                                Time   101
c                                                                               StmTur  70
c                                                                               StmTur  71
c============= DESIGN CALCULATIONS ============================================ StmTur  72
      CASE (1)                                                                  StmTur  73
c                                                                               StmTur  74
c              Set up the start up loads                                        StmTur  75
      CALL StartUpLoad_Design(Jpe, <gn:CAP>, <gn:START-TIME>)                   StmTur  76
c                                                                               StmTur  77
c              Theoretical steam rate (lbs/kWh) assuming an isentropic          StmTur  78
c              expansion (Keenan and Keyes, 1937)                               StmTur  79
      LbsPerKWH = CVAL(<gn:STEAM-ENTH-FP>, <gn:STEAM-ENT-P>,                    StmTur  80
     &                                     <gn:STEAM-EXH-P>)                    StmTur  81
c              adjust theoretical steam rate for mechanical efficiency          StmTur  82
      LbsPerKWH = LbsPerKWH / <gn:MECH-EFF>                                     StmTur  83
c                                                                               StmTur  84
c              entering steam enthalpy                                          StmTur  85
      <gn;SteamH> = SteamEnthalpy(<gn:STEAM-ENT-P>, <gn:STEAM-SUPER-T>)         StmTur  86
c              condensate enthalpy                                              StmTur  87
      <gn;CondensateH> = SteamSaturationT(<gn:STEAM-EXH-P>) - 32.               StmTur  88
c                                                                               StmTur  89
c              design capacity, steam consumption (Btuh), recoverable           StmTur  90
      <pe;DES_KW>        = <gn:CAP>                                             StmTur  91
      <pe;DES_FUEL>      = <gn:CAP> * LbsPerKWH                                 StmTur  92
     &                   * (<gn;CondensateH>*<gn:STEAM-COND>                    StmTur  93
     &                                                    - <gn;SteamH>)        StmTur  94
      <pe;DES_RECOVER_Q> = (<pe;DES_FUEL> + <gn:CAP>*BTUKW)                     StmTur  95
     &                                            * <gn:STEAM-COND>             StmTur  96
c              steam flow, gpm                                                  StmTur  97
      <pe;DES_GPM> = <pe;DES_FUEL>                                              StmTur  98
     &    / ((<gn;CondensateH>*<gn:STEAM-COND> - <gn;SteamH>)*8.34*60.)         StmTur  99
c              pass hw load and flow onto hw loop                               StmTur 100
      Jlp                = <gn:STEAM-LOOP>                                      StmTur 101
      <lp;COIL_HEAT>     = <lp;COIL_HEAT> + <pe;DES_FUEL>                       StmTur 102
      <lp;GPM>           = <lp;GPM>       + <pe;DES_GPM>                        StmTur 103
      <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                              StmTur 104
     &                         <gn:STEAM-ENT-P>*2.3)                            StmTur 105
c                                                                               StmTur 106
c              Condenser loop calcs                                             StmTur 107
      IF (<gn:CW-LOOP> .GT. 0)  THEN                                            StmTur 108
c              cw temp differential and flow                                    StmTur 109
        Jlp        = <gn:CW-LOOP>                                               StmTur 110
        <gn:CW-DT> = ABS(<gn:CW-DT>)                                            StmTur 111
        CWflow  = -<pe;DES_RECOVER_Q> / (<lp;BTUH/GPM-F>*<gn:CW-DT>)            StmTur 112
c              pass cw load, flow, and head onto cw or wlhp loop                StmTur 113
        <lp;COIL_COOL>  = <lp;COIL_COOL> - <pe;DES_RECOVER_Q>                   StmTur 114
        <lp;GPM>        = <lp;GPM>       + CWflow                               StmTur 115
        <gn;DES_CW_GPM> = CWflow                                                StmTur 116
c              no attached pump - primary loop must absorb head                 StmTur 117
        <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>,                            StmTur 118
     &                           <gn:CW-HEAD>)                                  StmTur 119
      ENDIF                                                                     StmTur 120
c                                                                               StmTur 121
c ****         run function : SteamTurbineGen1-2                                StmTur 122
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        StmTur 123
c                                                                               StmTur 124
c                                                                               StmTur 125
c============= CALCULATE OPERATING CAPACITIES ================================= StmTur 126
      CASE (11)                                                                 StmTur 127
c                                                                               StmTur 128
c              Calculate electric capacity as a function of ambient             StmTur 129
c              temperature and wetbulb                                          StmTur 130
      OperCapElec = <gn:CAP>                                                    StmTur 131
      <pe;OPER_CAPACITY> = OperCapElec                                          StmTur 132
c              maximum output - adjust by warmup time                           StmTur 133
      CapElecMax = OperCapElec * <gn:MAX-RATIO> - StartUpLoad(Jpe)              -044c4 410
      <pe;MAX_CAPACITY> = CapElecMax                                            StmTur 135
c                                                                               StmTur 136
c              Calculate exhaust capacity corresponding to electrical           StmTur 137
      IF (<gn:EXH-LOOP> .GT. 0)  THEN                                           StmTur 138
        EQfuel  = <pe;DES_FUEL>                                                 StmTur 139
        EQrecvr = <pe;DES_RECOVER_Q>                                            StmTur 140
        Jpe     = <gn;Jpe_Exhaust>                                              StmTur 141
        <pe;OPER_CAPACITY> = -EQrecvr                                           StmTur 142
        <pe;MAX_CAPACITY>  =                                                    StmTur 143
     &     -(EQfuel * CVAL(<gn:HIR-FPLR>,<gn:MAX-RATIO>,1.)                     StmTur 144
     &             + CapElecMax*BTUKW) * <gn:STEAM-COND>                        StmTur 145
      ENDIF                                                                     StmTur 146
c                                                                               StmTur 147
c ****         run function : SteamTurbineGen1-3                                StmTur 148
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        StmTur 149
c                                                                               StmTur 150
      RETURN                                                                    StmTur 151
c                                                                               StmTur 152
c                                                                               StmTur 153
c============= SIMULATE ELECTRIC TRACKING ===================================== StmTur 154
      CASE(12)                                                                  StmTur 155
c                                                                               StmTur 156
      JpeSave = Jpe                                                             StmTur 157
c              hourly load and operating capacity                               StmTur 158
      EQload  = <pe;LOAD>                                                       StmTur 159
      OperCap = <pe;OPER_CAPACITY>                                              StmTur 160
c                                                                               StmTur 161
c ****         run function : SteamTurbineGen1-4                                StmTur 162
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        StmTur 163
c                                                                               StmTur 164
c              skip if no load                                                  StmTur 165
      IF (EQload .EQ. 0.)  GOTO 1000                                            StmTur 166
c              part load ratio - don't run if below min                         StmTur 167
      PLR    = EQload / OperCap                                                 StmTur 168
      IF (PLR .LT. <gn:MIN-RATIO>*.999)  THEN                                   StmTur 169
        <pe;LOAD> = 0.                                                          StmTur 170
        EQload    = 0.                                                          StmTur 171
        GOTO 1000                                                               StmTur 172
      ENDIF                                                                     StmTur 173
c                                                                               StmTur 174
c              adjust load for warm-up time and recalculate part                StmTur 175
c              load ratio                                                       StmTur 176
      EQstart = StartUpLoad(Jpe)                                                -044c4 411
      EQload  = EQload + EQstart                                                StmTur 178
      PLR     = EQload / OperCap                                                StmTur 179
c                                                                               StmTur 180
c              fraction of the hour the equipment runs                          StmTur 181
      Frac   = 1.0                                                              StmTur 182
c              steam input ratio as a function of part load                     StmTur 183
      HIRPLR = CVAL(<gn:HIR-FPLR>,PLR,PLR)                                      StmTur 184
c              steam consumption, Btu/hr                                        StmTur 185
      EQfuel = <pe;DES_FUEL> * HIRPLR                                           StmTur 186
c              steam flow, gpm                                                  StmTur 187
      HWflow = EQfuel / ((<gn;CondensateH>*<gn:STEAM-COND>                      StmTur 188
     &                                          - <gn;SteamH>)*8.34*60.)        StmTur 189
c              steam head                                                       StmTur 190
      HWhead = <gn:STEAM-ENT-P> * 2.3                                           StmTur 191
c              pass steam load onto loop                                        StmTur 192
      Jlp                = <gn:STEAM-LOOP>                                      StmTur 193
      <lp;CogenQ>        = <lp;CogenQ>           + EQfuel                       StmTur 194
      <lp;CogenGPM>      = <lp;CogenGPM>         + HWflow                       StmTur 195
      <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>, HWhead)                      StmTur 196
c                                                                               StmTur 197
c              Recoverable heat at this part load ratio                         StmTur 198
c              exhaust                                                          StmTur 199
      IF (<gn;Jpe_Exhaust> .GT. 0)  THEN                                        StmTur 200
        Jpe   = <gn;Jpe_Exhaust>                                                StmTur 201
        EQrecvr = (EQfuel + EQload*BTUKW) * <gn:STEAM-COND>                     StmTur 202
      ENDIF                                                                     StmTur 203
      Jpe = JpeSave                                                             StmTur 204
c                                                                               StmTur 205
c              separate out start-up load                                       StmTur 206
      EQload = EQload - EQstart                                                 StmTur 207
c                                                                               StmTur 208
c              Auxiliary power                                                  StmTur 209
 1000 IF (<gn:AUX-KW> .GT. 0.)  THEN                                            StmTur 210
c              if always on                                                     StmTur 211
        IF (<gn:AUX-MODE> .EQ. Always)  THEN                                    StmTur 212
          EQaux = <gn:AUX-KW>                                                   StmTur 213
        ELSEIF (<gn:AUX-MODE> .EQ. WhenOn)  THEN                                StmTur 214
          EQaux = <gn:AUX-KW> * Frac                                            StmTur 215
        ELSEIF (<gn:AUX-MODE> .EQ. WhenOff)  THEN                               StmTur 216
          EQaux = <gn:AUX-KW> * (1.0 - Frac)                                    StmTur 217
        ELSE                                                                    Time   102
          EQaux = <gn:AUX-KW> * SchVal(<gn:AUX-SCH>, 1.)                        Time   103
        ENDIF                                                                   StmTur 220
      ENDIF                                                                     StmTur 221
c                                                                               StmTur 222
c ****         run function : SteamTurbineGen1-5                                StmTur 223
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        StmTur 224
c                                                                               StmTur 225
c              report variables                                                 StmTur 226
      <pe;AUX_KW>    = EQaux                                                    StmTur 227
      <pe;FUEL>      = EQfuel                                                   StmTur 228
      JpeSave        = Jpe                                                      StmTur 229
      <pe;RECOVER_Q> = EQrecvr                                                  StmTur 230
      Jpe            = <gn;Jpe_Exhaust>                                         StmTur 231
      <pe;RECOVER_Q> = EQrecvr                                                  StmTur 232
      Jpe            = JpeSave                                                  StmTur 233
c                                                                               StmTur 234
c              hourly-report variables                                          StmTur 235
      IF (<gn;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                                StmTur 236
     &  CALL HourRepPLT(EQUIPDAT(1), <gn;HREP>, 21, 0)                          StmTur 237
c                                                                               StmTur 238
c                                                                               StmTur 239
c============= SIMULATE THERMAL TRACKING ====================================== StmTur 240
      CASE(13)                                                                  StmTur 241
c                                                                               StmTur 242
      IF (<gn:EXH-LOOP> .EQ. 0)  RETURN                                         StmTur 243
      OperCapElec = <pe;OPER_CAPACITY>                                          StmTur 244
      DesSteam    = <pe;DES_FUEL>                                               StmTur 245
      Jpe         = <gn;Jpe_Exhaust>                                            StmTur 246
      EQrecvr     = -<pe;LOAD>                                                  StmTur 247
      OperCapRcvr = -<pe;OPER_CAPACITY>                                         StmTur 248
c              skip if no load                                                  StmTur 249
      IF (EQrecvr .GT. -1.)  RETURN                                             StmTur 250
c                                                                               StmTur 251
c              heat recoverable at minimum part load ratio                      StmTur 252
      QRecvrMin = (DesSteam * CVAL(<gn:HIR-FPLR>,<gn:MIN-RATIO>,1.)             StmTur 253
     &        + OperCapElec*BTUKW*<gn:MIN-RATIO>) * <gn:STEAM-COND>             StmTur 254
      IF (EQrecvr .LT. QRecvrMin)  THEN                                         StmTur 255
c              Turbine can track the thermal load.                              StmTur 256
c              constant, linear and quadratic terms                             StmTur 258
        Jcv = <gn:HIR-FPLR>                                                     -045b  246
        Curve(1) = DesSteam*<cv:COEF-1> - EQrecvr/<gn:STEAM-COND>               -045b  247
        Curve(2) = DesSteam*<cv:COEF-2> + OperCapElec*BTUKW                     -045b  248
        Curve(3) = DesSteam*<cv:COEF-3>                                         -045b  249
        CALL CURINV(Curve(1), 3, 1, PLR, PLR, 0.0, PLRLim(1), IERR)             StmTur 262
      ELSE                                                                      StmTur 263
c              load is less than minimum that can be tracked                    StmTur 264
        PLR = <gn:MIN-RATIO>                                                    StmTur 265
      ENDIF                                                                     StmTur 266
c              Corresponding electrical load.  Note that this load              StmTur 267
c              is stored in the exhaust Jpe block                               StmTur 268
      <pe;LOAD> = OperCapElec * PLR                                             StmTur 269
c                                                                               StmTur 270
c ****         run function : SteamTurbineGen1-6                                StmTur 271
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        StmTur 272
c                                                                               StmTur 273
c                                                                               StmTur 274
c============= CALCULATE RECOVERED HEAT AND HEAT REJECTION ==================== StmTur 275
      CASE(14)                                                                  StmTur 276
c                                                                               StmTur 277
c              recovered exhaust                                                StmTur 278
      IF (<gn:EXH-LOOP> .GT. 0)  THEN                                           StmTur 279
        Jpe      = <gn;Jpe_Exhaust>                                             StmTur 280
        Jlp      = <gn:EXH-LOOP>                                                StmTur 281
        QLoopNet = MIN(0., <lp;Q_NET>-<lp;Q_HTREC>)                             StmTur 282
        IF (<lp;CogenHtrec> .LT. (<lp;Q_NET>-<lp;Q_HTREC>))  THEN               StmTur 283
          Prorate        = (<lp;Q_NET>-<lp;Q_HTREC>) / <lp;CogenHtrec>          StmTur 284
          Qadjust        = <pe;RECOVER_Q> * (1.-Prorate)                        StmTur 285
          <pe;RECOVER_Q> = <pe;RECOVER_Q> - Qadjust                             StmTur 286
          Jpe            = <gn;Jpe>                                             StmTur 287
          <pe;RECOVER_Q> = <pe;RECOVER_Q> - Qadjust                             StmTur 288
          EQrecvr        = <pe;RECOVER_Q>                                       StmTur 289
          EQcond         = -Qadjust                                             StmTur 290
        ENDIF                                                                   StmTur 291
      ENDIF                                                                     StmTur 292
c                                                                               StmTur 293
c              heat rejected                                                    StmTur 294
      IF (<gn:CW-LOOP> .GT. 0)  THEN                                            StmTur 295
        IF (<gn:EXH-LOOP> .EQ. 0)  THEN                                         StmTur 296
c              condenser load                                                   StmTur 297
          Jpe = <gn;Jpe_Exhaust>                                                StmTur 298
          EQcond = -<pe;RECOVER_Q>                                              StmTur 299
        ENDIF                                                                   StmTur 300
        Jlp = <gn:CW-LOOP>                                                      StmTur 301
        <lp;CogenQ> = <lp;CogenQ> + EQcond                                      StmTur 302
c              condenser flow & head                                            StmTur 303
        IF (<gn:CW-CTRL> .EQ. ConstantFlow)  THEN                               StmTur 304
c              constant flow                                                    StmTur 305
          CWflow = <gn;DES_CW_GPM>                                              StmTur 306
          CWhead = <gn:CW-HEAD>                                                 StmTur 307
        ELSE                                                                    StmTur 308
c              variable flow                                                    StmTur 309
          CWflow  = EQcond / (<lp;BTUH/GPM-F>*<gn:CW-DT>)                       StmTur 310
          PLRflow = CWflow / <gn;DES_CW_GPM>                                    StmTur 311
          CWhead  = <gn:CW-HEAD> * PLRflow**1.8                                 StmTur 312
        ENDIF                                                                   StmTur 313
c              pass condenser flow and head onto condenser loop                 StmTur 314
        <lp;CogenGPM> = <lp;CogenGPM> + CWflow                                  StmTur 315
        <lp;DEM-SIDE_HEAD> = MAX(<lp;DEM-SIDE_HEAD>, CWhead)                    StmTur 316
      ENDIF                                                                     StmTur 317
c                                                                               StmTur 318
c ****         run function : SteamTurbineGen1-7                                StmTur 319
c     IF( MSYSF(?) .NE. 0 )   CALL FINTS( MSYSF(?), 1. )                        StmTur 320
c                                                                               StmTur 321
c              hourly-report variables                                          StmTur 322
      IF (<gn;HREP> .NE. 0  .AND.  IRSCH .NE. 0)                                StmTur 323
     &  CALL HourRepPLT(EQUIPDAT(1), <gn;HREP>, 21, 1)                          StmTur 324
c                                                                               StmTur 325
c                                                                               StmTur 326
      END SELECT  ! SimCtrl                                                     StmTur 327
      Jpe = <gn;Jpe>                                                            StmTur 328
c                                                                               StmTur 329
      RETURN                                                                    StmTur 330
      END                                                                       StmTur 331
      SUBROUTINE Create_Loss(ComponentPtr, ZonePtr,                             CLoss    2
     &                       SubType,                                           CLoss    3
     &                       Size, Initialize, Multiplier, Jxf)                 CLoss    4
c                                                                               CLoss    5
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /XPtrs / Ixf, Nxf, Lxf, LxfHr, Lxf1, Lxf2, Iwf,                   IcRink   1
     &                 XPtrsEnd                                                 /XPtrs/  3
      COMMON  /XNames/ NameXface(3)                                             /XNames/ 2
      INTEGER          Xfc1, Xfc2, Xfc                                          /XNames/ 3
      EQUIVALENCE      (Xfc1, NameXface(1)), (Xfc2, NameXface(2)),              /XNames/ 4
     &                 (Xfc , NameXface(3))                                     /XNames/ 5
c                                                                               CLoss   10
      INTEGER ComponentPtr, ZonePtr,                                            CLoss   11
     &        SubType, Size                                                     CLoss   12
      REAL Multiplier                                                           CLoss   13
c                                                                               CLoss   14
      Nxf = Nxf  + 1                                                            CLoss   15
      SELECT CASE (Size)                                                        CLoss   16
        CASE (1)                                                                CLoss   17
          Jxf           = NewBlockPtr(Lxf1)                                     CLoss   18
          <xf;Ident>    = Xfc1                                                  CLoss   19
        CASE (2)                                                                CLoss   20
          Jxf           = NewBlockPtr(Lxf2)                                     CLoss   21
          <xf;Ident>    = Xfc2                                                  CLoss   22
        CASE (3)                                                                CLoss   23
          Jxf           = NewBlockPtr(Lxf)                                      CLoss   24
          <xf;Ident>    = Xfc                                                   CLoss   25
      END SELECT                                                                CLoss   26
      <xf;NextPtr> = Ixf                                                        CLoss   27
      Ixf          = Jxf                                                        CLoss   28
      <xf;SubType>       = SubType                                              CLoss   29
      <xf;Initialize>    = Initialize                                           CLoss   30
      <xf;ComponentPtr>  = ComponentPtr                                         CLoss   31
      <xf;ZonePtr>       = ZonePtr                                              CLoss   32
      <xf;Multiplier>    = Multiplier                                           CLoss   33
c                                                                               CLoss   34
c                                                                               CLoss   35
      RETURN                                                                    CLoss   36
      END                                                                       CLoss   37
      SUBROUTINE GetVars1(Jxf, Var1)                                            GetV1    2
c                                                                               GetV1    3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               GetV1    6
      Var1 = <xf;CurrentVar1>                                                   GetV1    7
c                                                                               GetV1    8
      RETURN                                                                    GetV1    9
      END                                                                       GetV1   10
      SUBROUTINE GetVars2(Jxf, Var1, Var2)                                      GetV2    2
c                                                                               GetV2    3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               GetV2    6
      Var1 = <xf;CurrentVar1>                                                   GetV2    7
      Var2 = <xf;CurrentVar2>                                                   GetV2    8
c                                                                               GetV2    9
      RETURN                                                                    GetV2   10
      END                                                                       GetV2   11
      SUBROUTINE GetVars3(Jxf, Var1, Var2, Var3)                                GetV3    2
c                                                                               GetV3    3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               GetV3    6
      Var1 = <xf;CurrentVar1>                                                   GetV3    7
      Var2 = <xf;CurrentVar2>                                                   GetV3    8
      Var3 = <xf;CurrentVar3>                                                   GetV3    9
c                                                                               GetV3   10
      RETURN                                                                    GetV3   11
      END                                                                       GetV3   12
      SUBROUTINE GetVars4(Jxf, Var1, Var2, Var3, Var4)                          GetV4    2
c                                                                               GetV4    3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               GetV4    6
      Var1 = <xf;CurrentVar1>                                                   GetV4    7
      Var2 = <xf;CurrentVar2>                                                   GetV4    8
      Var3 = <xf;CurrentVar3>                                                   GetV4    9
      Var4 = <xf;CurrentVar4>                                                   GetV4   10
c                                                                               GetV4   11
      RETURN                                                                    GetV4   12
      END                                                                       GetV4   13
      SUBROUTINE GetVars5(Jxf, Var1, Var2, Var3, Var4, Var5)                    GetV5    2
c                                                                               GetV5    3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               GetV5    6
      Var1 = <xf;CurrentVar1>                                                   GetV5    7
      Var2 = <xf;CurrentVar2>                                                   GetV5    8
      Var3 = <xf;CurrentVar3>                                                   GetV5    9
      Var4 = <xf;CurrentVar4>                                                   GetV5   10
      Var5 = <xf;CurrentVar5>                                                   GetV5   11
c                                                                               GetV5   12
      RETURN                                                                    GetV5   13
      END                                                                       GetV5   14
      SUBROUTINE GetDesignVars1(Jxf, Var1)                                      GetDV1   2
c                                                                               GetDV1   3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               GetDV1   6
      Var1 = <xf;DesignVar1>                                                    GetDV1   7
c                                                                               GetDV1   8
      RETURN                                                                    GetDV1   9
      END                                                                       GetDV1  10
      SUBROUTINE GetDesignVars2(Jxf, Var1, Var2)                                GetDV2   2
c                                                                               GetDV2   3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               GetDV2   6
      Var1 = <xf;DesignVar1>                                                    GetDV2   7
      Var2 = <xf;DesignVar2>                                                    GetDV2   8
c                                                                               GetDV2   9
      RETURN                                                                    GetDV2  10
      END                                                                       GetDV2  11
      SUBROUTINE GetDesignVars3(Jxf, Var1, Var2, Var3)                          GetDV3   2
c                                                                               GetDV3   3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               GetDV3   6
      Var1 = <xf;DesignVar1>                                                    GetDV3   7
      Var2 = <xf;DesignVar2>                                                    GetDV3   8
      Var3 = <xf;DesignVar3>                                                    GetDV3   9
c                                                                               GetDV3  10
      RETURN                                                                    GetDV3  11
      END                                                                       GetDV3  12
      SUBROUTINE GetDesignVars4(Jxf, Var1, Var2, Var3, Var4)                    GetDV4   2
c                                                                               GetDV4   3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               GetDV4   6
      Var1 = <xf;DesignVar1>                                                    GetDV4   7
      Var2 = <xf;DesignVar2>                                                    GetDV4   8
      Var3 = <xf;DesignVar3>                                                    GetDV4   9
      Var4 = <xf;DesignVar4>                                                    GetDV4  10
c                                                                               GetDV4  11
      RETURN                                                                    GetDV4  12
      END                                                                       GetDV4  13
      SUBROUTINE GetDesignVars5(Jxf, Var1, Var2, Var3, Var4, Var5)              GetDV5   2
c                                                                               GetDV5   3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               GetDV5   6
      Var1 = <xf;DesignVar1>                                                    GetDV5   7
      Var2 = <xf;DesignVar2>                                                    GetDV5   8
      Var3 = <xf;DesignVar3>                                                    GetDV5   9
      Var4 = <xf;DesignVar4>                                                    GetDV5  10
      Var5 = <xf;DesignVar5>                                                    GetDV5  11
c                                                                               GetDV5  12
      RETURN                                                                    GetDV5  13
      END                                                                       GetDV5  14
      SUBROUTINE GetPastVars1(Jxf, Var1)                                        GetPV1   2
c                                                                               GetPV1   3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               GetPV1   6
      Var1 = <xf;PastVar1>                                                      GetPV1   7
c                                                                               GetPV1   8
      RETURN                                                                    GetPV1   9
      END                                                                       GetPV1  10
      SUBROUTINE GetPastVars2(Jxf, Var1, Var2)                                  GetPV2   2
c                                                                               GetPV2   3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               GetPV2   6
      Var1 = <xf;PastVar1>                                                      GetPV2   7
      Var2 = <xf;PastVar2>                                                      GetPV2   8
c                                                                               GetPV2   9
      RETURN                                                                    GetPV2  10
      END                                                                       GetPV2  11
      SUBROUTINE GetPastVars3(Jxf, Var1, Var2, Var3)                            GetPV3   2
c                                                                               GetPV3   3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               GetPV3   6
      Var1 = <xf;PastVar1>                                                      GetPV3   7
      Var2 = <xf;PastVar2>                                                      GetPV3   8
      Var3 = <xf;PastVar3>                                                      GetPV3   9
c                                                                               GetPV3  10
      RETURN                                                                    GetPV3  11
      END                                                                       GetPV3  12
      SUBROUTINE GetPastVars4(Jxf, Var1, Var2, Var3, Var4)                      GetPV4   2
c                                                                               GetPV4   3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               GetPV4   6
      Var1 = <xf;PastVar1>                                                      GetPV4   7
      Var2 = <xf;PastVar2>                                                      GetPV4   8
      Var3 = <xf;PastVar3>                                                      GetPV4   9
      Var4 = <xf;PastVar4>                                                      GetPV4  10
c                                                                               GetPV4  11
      RETURN                                                                    GetPV4  12
      END                                                                       GetPV4  13
      SUBROUTINE GetPastVars5(Jxf, Var1, Var2, Var3, Var4, Var5)                GetPV5   2
c                                                                               GetPV5   3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               GetPV5   6
      Var1 = <xf;PastVar1>                                                      GetPV5   7
      Var2 = <xf;PastVar2>                                                      GetPV5   8
      Var3 = <xf;PastVar3>                                                      GetPV5   9
      Var4 = <xf;PastVar4>                                                      GetPV5  10
      Var5 = <xf;PastVar5>                                                      GetPV5  11
c                                                                               GetPV5  12
      RETURN                                                                    GetPV5  13
      END                                                                       GetPV5  14
      SUBROUTINE PutVars1(Jxf, Var1)                                            PutV1    2
c                                                                               PutV1    3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               PutV1    6
      <xf;CurrentVar1> = Var1                                                   PutV1    7
c                                                                               PutV1    8
      RETURN                                                                    PutV1    9
      END                                                                       PutV1   10
      SUBROUTINE PutVars2(Jxf, Var1, Var2)                                      PutV2    2
c                                                                               PutV2    3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               PutV2    6
      <xf;CurrentVar1> = Var1                                                   PutV2    7
      <xf;CurrentVar2> = Var2                                                   PutV2    8
c                                                                               PutV2    9
      RETURN                                                                    PutV2   10
      END                                                                       PutV2   11
      SUBROUTINE PutVars2c(Jxf, Var1, Var2)                                     PutV2c   2
c                                                                               PutV2c   3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               PutV2c   6
      DATA SoWhat /-77777./                                                     PutV2c   7
c                                                                               PutV2c   8
      IF (Var1 .NE. SoWhat)  <xf;CurrentVar1> = Var1                            PutV2c   9
      IF (Var2 .NE. SoWhat)  <xf;CurrentVar2> = Var2                            PutV2c  10
c                                                                               PutV2c  11
      RETURN                                                                    PutV2c  12
      END                                                                       PutV2c  13
      SUBROUTINE PutVars3(Jxf, Var1, Var2, Var3)                                PutV3    2
c                                                                               PutV3    3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               PutV3    6
      <xf;CurrentVar1> = Var1                                                   PutV3    7
      <xf;CurrentVar2> = Var2                                                   PutV3    8
      <xf;CurrentVar3> = Var3                                                   PutV3    9
c                                                                               PutV3   10
      RETURN                                                                    PutV3   11
      END                                                                       PutV3   12
      SUBROUTINE PutVars3c(Jxf, Var1, Var2, Var3)                               PutV3c   2
c                                                                               PutV3c   3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               PutV3c   6
      DATA SoWhat /-77777./                                                     PutV3c   7
c                                                                               PutV3c   8
      IF (Var1 .NE. SoWhat)  <xf;CurrentVar1> = Var1                            PutV3c   9
      IF (Var2 .NE. SoWhat)  <xf;CurrentVar2> = Var2                            PutV3c  10
      IF (Var3 .NE. SoWhat)  <xf;CurrentVar3> = Var3                            PutV3c  11
c                                                                               PutV3c  12
      RETURN                                                                    PutV3c  13
      END                                                                       PutV3c  14
      SUBROUTINE PutVars4(Jxf, Var1, Var2, Var3, Var4)                          PutV4    2
c                                                                               PutV4    3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               PutV4    6
      <xf;CurrentVar1> = Var1                                                   PutV4    7
      <xf;CurrentVar2> = Var2                                                   PutV4    8
      <xf;CurrentVar3> = Var3                                                   PutV4    9
      <xf;CurrentVar4> = Var4                                                   PutV4   10
c                                                                               PutV4   11
      RETURN                                                                    PutV4   12
      END                                                                       PutV4   13
      SUBROUTINE PutVars4c(Jxf, Var1, Var2, Var3, Var4)                         PutV4c   2
c                                                                               PutV4c   3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               PutV4c   6
      DATA SoWhat /-77777./                                                     PutV4c   7
c                                                                               PutV4c   8
      IF (Var1 .NE. SoWhat)  <xf;CurrentVar1> = Var1                            PutV4c   9
      IF (Var2 .NE. SoWhat)  <xf;CurrentVar2> = Var2                            PutV4c  10
      IF (Var3 .NE. SoWhat)  <xf;CurrentVar3> = Var3                            PutV4c  11
      IF (Var4 .NE. SoWhat)  <xf;CurrentVar4> = Var4                            PutV4c  12
c                                                                               PutV4c  13
      RETURN                                                                    PutV4c  14
      END                                                                       PutV4c  15
      SUBROUTINE PutVars5(Jxf, Var1, Var2, Var3, Var4, Var5)                    PutV5    2
c                                                                               PutV5    3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               PutV5    6
      <xf;CurrentVar1> = Var1                                                   PutV5    7
      <xf;CurrentVar2> = Var2                                                   PutV5    8
      <xf;CurrentVar3> = Var3                                                   PutV5    9
      <xf;CurrentVar4> = Var4                                                   PutV5   10
      <xf;CurrentVar5> = Var5                                                   PutV5   11
c                                                                               PutV5   12
      RETURN                                                                    PutV5   13
      END                                                                       PutV5   14
      SUBROUTINE PutVars5c(Jxf, Var1, Var2, Var3, Var4, Var5)                   PutV5c   2
c                                                                               PutV5c   3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               PutV5c   6
      DATA SoWhat /-77777./                                                     PutV5c   7
      IF (Var1 .NE. SoWhat)  <xf;CurrentVar1> = Var1                            PutV5c   8
      IF (Var2 .NE. SoWhat)  <xf;CurrentVar2> = Var2                            PutV5c   9
      IF (Var3 .NE. SoWhat)  <xf;CurrentVar3> = Var3                            PutV5c  10
      IF (Var4 .NE. SoWhat)  <xf;CurrentVar4> = Var4                            PutV5c  11
      IF (Var5 .NE. SoWhat)  <xf;CurrentVar5> = Var5                            PutV5c  12
c                                                                               PutV5c  13
      RETURN                                                                    PutV5c  14
      END                                                                       PutV5c  15
      SUBROUTINE PutDesignVars1(Jxf, Var1)                                      PutDV1   2
c                                                                               PutDV1   3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               PutDV1   6
      <xf;DesignVar1> = Var1                                                    PutDV1   7
c                                                                               PutDV1   8
      RETURN                                                                    PutDV1   9
      END                                                                       PutDV1  10
      SUBROUTINE PutDesignVars2(Jxf, Var1, Var2)                                PutDV2   2
c                                                                               PutDV2   3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               PutDV2   6
      <xf;DesignVar1> = Var1                                                    PutDV2   7
      <xf;DesignVar2> = Var2                                                    PutDV2   8
c                                                                               PutDV2   9
      RETURN                                                                    PutDV2  10
      END                                                                       PutDV2  11
      SUBROUTINE PutDesignVars2c(Jxf, Var1, Var2)                               PutDV2c  2
c                                                                               PutDV2c  3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               PutDV2c  6
      DATA SoWhat /-77777./                                                     PutDV2c  7
      IF (Var1 .NE. SoWhat)  <xf;DesignVar1> = Var1                             PutDV2c  8
      IF (Var2 .NE. SoWhat)  <xf;DesignVar2> = Var2                             PutDV2c  9
c                                                                               PutDV2c 10
      RETURN                                                                    PutDV2c 11
      END                                                                       PutDV2c 12
      SUBROUTINE PutDesignVars3(Jxf, Var1, Var2, Var3)                          PutDV3   2
c                                                                               PutDV3   3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               PutDV3   6
      <xf;DesignVar1> = Var1                                                    PutDV3   7
      <xf;DesignVar2> = Var2                                                    PutDV3   8
      <xf;DesignVar3> = Var3                                                    PutDV3   9
c                                                                               PutDV3  10
      RETURN                                                                    PutDV3  11
      END                                                                       PutDV3  12
      SUBROUTINE PutDesignVars3c(Jxf, Var1, Var2, Var3)                         PutDV3c  2
c                                                                               PutDV3c  3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               PutDV3c  6
      DATA SoWhat /-77777./                                                     PutDV3c  7
      IF (Var1 .NE. SoWhat)  <xf;DesignVar1> = Var1                             PutDV3c  8
      IF (Var2 .NE. SoWhat)  <xf;DesignVar2> = Var2                             PutDV3c  9
      IF (Var3 .NE. SoWhat)  <xf;DesignVar3> = Var3                             PutDV3c 10
c                                                                               PutDV3c 11
      RETURN                                                                    PutDV3c 12
      END                                                                       PutDV3c 13
      SUBROUTINE PutDesignVars4(Jxf, Var1, Var2, Var3, Var4)                    PutDV4   2
c                                                                               PutDV4   3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               PutDV4   6
      <xf;DesignVar1> = Var1                                                    PutDV4   7
      <xf;DesignVar2> = Var2                                                    PutDV4   8
      <xf;DesignVar3> = Var3                                                    PutDV4   9
      <xf;DesignVar4> = Var4                                                    PutDV4  10
c                                                                               PutDV4  11
      RETURN                                                                    PutDV4  12
      END                                                                       PutDV4  13
      SUBROUTINE PutDesignVars4c(Jxf, Var1, Var2, Var3, Var4)                   PutDV4c  2
c                                                                               PutDV4c  3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               PutDV4c  6
      DATA SoWhat /-77777./                                                     PutDV4c  7
      IF (Var1 .NE. SoWhat)  <xf;DesignVar1> = Var1                             PutDV4c  8
      IF (Var2 .NE. SoWhat)  <xf;DesignVar2> = Var2                             PutDV4c  9
      IF (Var3 .NE. SoWhat)  <xf;DesignVar3> = Var3                             PutDV4c 10
      IF (Var4 .NE. SoWhat)  <xf;DesignVar4> = Var4                             PutDV4c 11
c                                                                               PutDV4c 12
      RETURN                                                                    PutDV4c 13
      END                                                                       PutDV4c 14
      SUBROUTINE PutDesignVars5(Jxf, Var1, Var2, Var3, Var4, Var5)              PutDV5   2
c                                                                               PutDV5   3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               PutDV5   6
      <xf;DesignVar1> = Var1                                                    PutDV5   7
      <xf;DesignVar2> = Var2                                                    PutDV5   8
      <xf;DesignVar3> = Var3                                                    PutDV5   9
      <xf;DesignVar4> = Var4                                                    PutDV5  10
      <xf;DesignVar5> = Var5                                                    PutDV5  11
c                                                                               PutDV5  12
      RETURN                                                                    PutDV5  13
      END                                                                       PutDV5  14
      SUBROUTINE PutDesignVars5c(Jxf, Var1, Var2, Var3, Var4, Var5)             PutDV5c  2
c                                                                               PutDV5c  3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               PutDV5c  6
      DATA SoWhat /-77777./                                                     PutDV5c  7
      IF (Var1 .NE. SoWhat)  <xf;DesignVar1> = Var1                             PutDV5c  8
      IF (Var2 .NE. SoWhat)  <xf;DesignVar2> = Var2                             PutDV5c  9
      IF (Var3 .NE. SoWhat)  <xf;DesignVar3> = Var3                             PutDV5c 10
      IF (Var4 .NE. SoWhat)  <xf;DesignVar4> = Var4                             PutDV5c 11
      IF (Var5 .NE. SoWhat)  <xf;DesignVar5> = Var5                             PutDV5c 12
c                                                                               PutDV5c 13
      RETURN                                                                    PutDV5c 14
      END                                                                       PutDV5c 15
      SUBROUTINE PutPastVars(Jxf, Var1, Var2, Var3, Var4, Var5)                 PutPV    2
c                                                                               PutPV    3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               PutPV    6
      IF (Var1 .NE. 0.)  <xf;PastVar1> = Var1                                   PutPV    7
      IF (Var2 .NE. 0.)  <xf;PastVar2> = Var2                                   PutPV    8
      IF (Var3 .NE. 0.)  <xf;PastVar3> = Var3                                   PutPV    9
      IF (Var4 .NE. 0.)  <xf;PastVar4> = Var4                                   PutPV   10
      IF (Var5 .NE. 0.)  <xf;PastVar5> = Var5                                   PutPV   11
c                                                                               PutPV   12
      RETURN                                                                    PutPV   13
      END                                                                       PutPV   14
      SUBROUTINE CheckLoss(ZonePtr, Jxl)                                        ChkLoss  2
c                                                                               ChkLoss  3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /XNames/ NameXface(3)                                             /XNames/ 2
      INTEGER          Xfc1, Xfc2, Xfc                                          /XNames/ 3
      EQUIVALENCE      (Xfc1, NameXface(1)), (Xfc2, NameXface(2)),              /XNames/ 4
     &                 (Xfc , NameXface(3))                                     /XNames/ 5
      COMMON  /XPtrs / Ixf, Nxf, Lxf, LxfHr, Lxf1, Lxf2, Iwf,                   IcRink   1
     &                 XPtrsEnd                                                 /XPtrs/  3
c                                                                               ChkLoss  8
      INTEGER ZonePtr                                                           ChkLoss  9
      Jxl = 0                                                                   ChkLoss 10
      Jxf = Ixf                                                                 ChkLoss 11
      DO WHILE (Jxf .GT. 0)                                                     ChkLoss 12
        IF (ZonePtr .EQ. <xf;ZonePtr>)  THEN                                    ChkLoss 13
          Jxl = Ixf                                                             ChkLoss 14
          EXIT                                                                  ChkLoss 15
        ENDIF                                                                   ChkLoss 16
        Jxf = <xf;NextPtr>                                                      ChkLoss 17
      ENDDO                                                                     ChkLoss 18
c                                                                               ChkLoss 19
c                                                                               ChkLoss 20
      RETURN                                                                    ChkLoss 21
      END                                                                       ChkLoss 22
      SUBROUTINE Xface_Statistics                                               XStat    2
c                                                                               XStat    3
c                                                                               XStat    4
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /SimCtl/ SimCtrl                                                  /SimCtl/ 2
      INTEGER          SimCtrl                                                  /SimCtl/ 3
      COMMON  /TIME  / IDOY, IYR, IMO, IDAY, IHR,                               Time     2
     &                 ISCMO, ISCDAY, ISCHR, IDOW, ISCDOW, iDSdates(6),         -044e5   1
     &                 iTimeFlg, iDSFlg, iDDFlg, InitialFlg, LeapYr,            Time     4
     &                 CLOCK(10), MONDSC(13), MONLEN(12), MONSDA(12)            HR      17
      COMMON  /WEATH / IWDID(5),LRECX,WLAT,WLONG,LTIMZ,IFX,IWSIZ,               /WEATH/  2
     1                 CLRNES,TGNDR,WBT,DBT,PATM,CLDAMT,ISNOW,IRAIN,            /WEATH/  3
     2                 IWNDDR,HUMRAT,DENSTY,ENTHAL,DIFSOL,DIRSOL,SOLRAD,        /WEATH/  4
     3                 ICLDTY,WNDSPD,IDUMMY,DPT,WNDDRR,CLDCOV,RDNCC,            /WEATH/  5
     4                 BSCC,SKYA,DBTR,GTEMP(12),CLR(12),ESKY,EGND,IWINTR        /WEATH/  6
      COMMON  /XNames/ NameXface(3)                                             /XNames/ 2
      INTEGER          Xfc1, Xfc2, Xfc                                          /XNames/ 3
      EQUIVALENCE      (Xfc1, NameXface(1)), (Xfc2, NameXface(2)),              /XNames/ 4
     &                 (Xfc , NameXface(3))                                     /XNames/ 5
      COMMON  /XPtrs / Ixf, Nxf, Lxf, LxfHr, Lxf1, Lxf2, Iwf,                   IcRink   1
     &                 XPtrsEnd                                                 /XPtrs/  3
c                                                                               XStat   12
c                                                                               XStat   13
      SELECT CASE (SimCtrl)                                                     XStat   14
c                                                                               XStat   15
      CASE (10)                                                                 XStat   16
      Jxf = Ixf                                                                 XStat   17
      DO WHILE (Jxf .GT. 0)                                                     XStat   18
        IF (<xf;Ident> .NE. Xfc1)  THEN                                         XStat   19
          DO  IV=1,LxfHr                                                        XStat   20
            <xf;PastVars> = <xf;CurrentVars>                                    XStat   21
            IF (<xf;Initialize> .EQ. 1)  <xf;CurrentVars> = 0.                  XStat   22
          ENDDO                                                                 XStat   23
        ELSE                                                                    XStat   24
          IF (<xf;Initialize> .EQ. 1)  THEN                                     XStat   25
            DO  IV=1,LxfHr                                                      XStat   26
              <xf;CurrentVars> = 0.                                             XStat   27
            ENDDO                                                               XStat   28
          ENDIF                                                                 XStat   29
        ENDIF                                                                   XStat   30
        Jxf = <xf;NextPtr>                                                      XStat   31
      ENDDO                                                                     XStat   32
c                                                                               XStat   33
      END SELECT                                                                XStat   34
      RETURN                                                                    XStat   35
      END                                                                       XStat   36
      BLOCK DATA Loss_Data                                                      LData    2
c                                                                               LData    3
c              Sets values for various symbols                                  LData    4
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
      COMMON  /MtrNam/ MeterType(4,4), FuelType(4,7)                            /MtrNam/ 2
      INTEGER          FuelType                                                 /MtrNam/ 3
      COMMON  /XNames/ NameXface(3)                                             /XNames/ 2
      INTEGER          Xfc1, Xfc2, Xfc                                          /XNames/ 3
      EQUIVALENCE      (Xfc1, NameXface(1)), (Xfc2, NameXface(2)),              /XNames/ 4
     &                 (Xfc , NameXface(3))                                     /XNames/ 5
c                                                                               LData    8
c              /MtrNam/                                                         LData    9
      DATA MeterType                                                            LData   10
     &    / 4HELEC,4HTRIC,4HITY ,4H    ,  4HFUEL,4H    ,4H    ,4H    ,          LData   11
     &      4HSTEA,4HM   ,4H    ,4H    ,  4HCHIL,4HLED-,4HWATE,4HR   /          LData   12
      DATA FuelType                                                             LData   13
     &    / 4HNATU,4HRAL-,4HGAS ,4H    ,  4HLPG ,4H    ,4H    ,4H    ,          LData   14
     &      4HFUEL,4H-OIL,4H    ,4H    ,  4HDIES,4HEL-O,4HIL  ,4H    ,          LData   15
     &      4HCOAL,4H    ,4H    ,4H    ,  4HMETH,4HANOL,4H    ,4H    ,          LData   16
     &      4HOTHE,4HR-FU,4HEL  ,4H    /                                        LData   17
c                                                                               LData   18
c              /XNames/                                                         LData   19
      DATA NameXface                                                            LData   20
     &                 /4HXfc1, 4HXfc2, 4HXfc /                                 LData   21
c                                                                               LData   22
      END                                                                       LData   23
      Subroutine InitialXface                                                   InitX    2
c                                                                               InitX    3
c              Initializes some common block variables to zero                  InitX    4
c                                                                               InitX    5
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /XPtrs / Ixf, Nxf, Lxf, LxfHr, Lxf1, Lxf2, Iwf,                   IcRink   1
     &                 XPtrsEnd                                                 /XPtrs/  3
c                                                                               InitX    9
c                                                                               InitX   10
c              /IXX/                                                            InitX   11
c     CALL FILLN(0, LastXX, 1)                                                  InitX   12
c              /XPtrs/                                                          InitX   13
      CALL ZeroBlock(Ixf, XPtrsEnd)                                             PV2     24
c                                                                               InitX   15
      CALL Loss_Setup                                                           InitX   16
c                                                                               InitX   17
      RETURN                                                                    InitX   18
      END                                                                       InitX   19
      FUNCTION Weight(Kwf, Load)                                                Weight   2
c                                                                               Weight   3
c              Weights a load using a set of response factors                   Weight   4
c                                                                               Weight   5
c              Kwf    Pointer to weighting factor block                         Weight   6
c              Load   Unweighted load                                           Weight   7
c                                                                               Weight   8
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               Weight  11
      REAL    Load                                                              Weight  12
      INTEGER WtFac                                                             Weight  13
c                                                                               Weight  14
c              Pointer to weighting factors                                     Weight  15
      WtFac  = <wf;WtFactors>                                                   Weight  16
c                                                                               Weight  17
c              Weight the load                                                  Weight  18
      Weight = AA(WtFac)   * Load                                               Weight  19
     &       + AA(WtFac+1) * <wf;Load1>                                         Weight  20
     &       + AA(WtFac+2) * <wf;Load2>                                         Weight  21
     &       + AA(WtFac+3) * <wf;LoadWt1>                                       Weight  22
     &       + AA(WtFac+4) * <wf;LoadWt2>                                       Weight  23
c                                                                               Weight  24
      <wf;Load>   = Load                                                        Weight  25
      <wf;LoadWt> = Weight                                                      Weight  26
c                                                                               Weight  27
      RETURN                                                                    Weight  28
      END                                                                       Weight  29
      FUNCTION NewWeight(Jcomp, IWtFac)                                         NewWt    2
c                                                                               NewWt    3
c              Creates a weighting factor block                                 NewWt    4
c                                                                               NewWt    5
c              Jcomp    Pointer to parent component                             NewWt    6
c              IWtFac   Pointer to weighting factors                            NewWt    7
c                                                                               NewWt    8
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /XPtrs / Ixf, Nxf, Lxf, LxfHr, Lxf1, Lxf2, Iwf,                   IcRink   1
     &                 XPtrsEnd                                                 /XPtrs/  3
c                                                                               NewWt   12
      DATA NameBlock   /4H$WtF/                                                 NewWt   13
c                                                                               NewWt   14
c              create the block                                                 NewWt   15
      Kwf = NewBlockPtr(<+wf;Len>)                                              NewWt   16
c              link this block to the previous block                            NewWt   17
      <wf;Next> = Iwf                                                           NewWt   18
      Iwf       = Kwf                                                           NewWt   19
c                                                                               NewWt   20
c              transfer parameters                                              NewWt   21
      <wf;Ident>     = NameBlock                                                NewWt   22
      <wf;Parent>    = Jcomp                                                    NewWt   23
      <wf;WtFactors> = IWtFac                                                   NewWt   24
c                                                                               NewWt   25
      NewWeight = Kwf                                                           NewWt   26
c                                                                               NewWt   27
      RETURN                                                                    NewWt   28
      END                                                                       NewWt   29
      SUBROUTINE WeightHsty                                                     UpWt     2
c                                                                               UpWt     3
c              Updates the history of all weighting factor blocks at            UpWt     4
c              the end of the hour                                              UpWt     5
c                                                                               UpWt     6
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /XPtrs / Ixf, Nxf, Lxf, LxfHr, Lxf1, Lxf2, Iwf,                   IcRink   1
     &                 XPtrsEnd                                                 /XPtrs/  3
c                                                                               UpWt    10
      Kwf = Iwf                                                                 UpWt    11
      DO WHILE (Kwf .GT. 0)                                                     UpWt    12
        <wf;Load2>   = <wf;Load1>                                               UpWt    13
        <wf;Load1>   = <wf;Load>                                                UpWt    14
        <wf;LoadWt2> = <wf;LoadWt1>                                             UpWt    15
        <wf;LoadWt1> = <wf;LoadWt>                                              UpWt    16
        Kwf = <wf;Next>                                                         UpWt    17
      ENDDO                                                                     UpWt    18
c                                                                               UpWt    19
      RETURN                                                                    UpWt    20
      END                                                                       UpWt    21
      SUBROUTINE Loss_Setup                                                     LSetUp   2
c                                                                               LSetUp   3
c                                                                               LSetUp   4
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
      COMMON  /IAX   / IAX, IADIM, IADIMV, IAXMAX, KORE, IAXlds, IAXsys         HR       8
      COMMON  /XPtrs / Ixf, Nxf, Lxf, LxfHr, Lxf1, Lxf2, Iwf,                   IcRink   1
     &                 XPtrsEnd                                                 /XPtrs/  3
c                                                                               LSetUp   9
      DATA LengthDummy /1000/                                                   LSetUp  10
c                                                                               LSetUp  11
c              Create some dummy working space                                  LSetUp  12
      Jdum   = NewBlockPtr(LengthDummy)                                         LSetUp  13
c     LastXX = LastXX - LengthDummy                                             LSetUp  14
      IAX    = IAX - LengthDummy                                                LSetUp  15
c                                                                               LSetUp  16
c              Interface block                                                  LSetUp  17
      Jxf   = Jdum                                                              LSetUp  18
      Lxf1  = IndexPosition(<xf;Ident>, <Lxf1>  , 2)                            -034    92
      Lxf2  = IndexPosition(<xf;Ident>, <Lxf2>  , 2)                            -034    93
      Lxf   = IndexPosition(<xf;Ident>, <Lxf>   , 2)                            -034    94
      LxfHr = IndexPosition(<=HRBJxf> , <=HREJxf>, 2)                           LSetUp  22
c                                                                               LSetUp  23
c                                                                               LSetUp  24
      RETURN                                                                    LSetUp  25
      END                                                                       LSetUp  26
      SUBROUTINE Xface_Reports                                                  XReps    2
c                                                                               XReps    3
c                                                                               XReps    4
      DUMMY = 0.                                                                XReps    5
      RETURN                                                                    XReps    6
      END                                                                       XReps    7
      FUNCTION JComponentPtr(Jxf)                                               JPar     2
c                                                                               JPar     3
c                                                                               /JJHSDG/ 2
c              DEVELOPED BY                                                     /JJHSDG/ 3
c                            S. D. Gates                                        /JJHSDG/ 4
c                            J. J. Hirsch                                       /JJHSDG/ 5
c                            James J. Hirsch & Associates                       /JJHSDG/ 6
c                            Camarillo, California                              /JJHSDG/ 7
c                                                                               /JJHSDG/ 8
Copyright (c) 1997 by James J. Hirsch.  All Rights Reserved. Unpublished        /JJHSDG/ 9
c rights reserved under the Copyright Laws of the United States.                /JJHSDG/10
c RESTRICTED RIGHTS NOTICE: Government use, reproduction or disclosure          /JJHSDG/11
c is subject to restrictions as set forth in Rights in Data (g)(3) in           /JJHSDG/12
c UC/LBNL purchase order 4607010 with J.J. Hirsch & Associates.                 /JJHSDG/13
c                                                                               /JJHSDG/14
#ifdef _DLL                                                                  /* -048a    1 */ 
      COMMON        // AA( 75 000 000)                                          -048a    2
      INTEGER          IA( 75 000 000)                                          -048a    3
#else                                                                        /* -048a    4 */ 
      COMMON        // AA( 75 000 000)                                          -048a    5
      INTEGER          IA( 75 000 000)                                          -048a    6
#endif                                                                       /* -048a    7 */ 
      EQUIVALENCE      (AA(1), IA(1))                                           HR       3
c                                                                               JPar     6
      JComponentPtr = <xf;ComponentPtr>                                         JPar     7
c                                                                               JPar     8
      RETURN                                                                    JPar     9
      END                                                                       JPar    10
c ####################### SPLIT PLT INTO PLT1&2 HERE ###########################Split2   2
